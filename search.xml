<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>【步骤零】实验环境准备</title>
    <url>/posts/62103/</url>
    <content><![CDATA[<h1 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h1><p>简介：本文章基于厦门大学提供的<a href="https://dblab.xmu.edu.cn/post/7499/">大数据课程实验案例：网站用户行为分析</a>，通过使用 CentOS 操作编写而来。具体介绍请打开链接进行阅读。</p>
<p><font color="red">这里介绍几点值得特别注意的事项：</font></p>
<p>1、对于案例所涉及的系统及软件此文档使用的是以下版本，其他软件版本随意：</p>
<ul>
<li>Linux系统（CentOS7）</li>
<li>MySQL（5.7）</li>
<li>Hadoop（3.1.3）</li>
<li>HBase（2.2.2，HBase版本需要和Hadoop版本兼容）</li>
<li>Hive（3.1.2，Hive需要和Hadoop版本兼容）</li>
<li>Sqoop（1.4.7）</li>
<li>R（3.6.0）</li>
<li>IDEA（ 2023.3.6 社区版）</li>
</ul>
<p><font color="red"><strong>PS：Hadoop 与 HBase、Hive 版本一定要兼容！！！版本一定要兼容！！！这很重要！！！</strong></font>😃😃😃其他软件随意。</p>
<p>2、本文章所有<strong>下载</strong>的所有软件均在 <code>/</code> 目录下。所有<strong>安装</strong>的所有软件均在 <code>/usr/local/</code> 目录下以 <code>软件名-版本号</code> 方式命名。在进行每个软件的安装操作之前请先<strong>整体阅读</strong>整个软件安装流程的文章有个整体思路，<strong>了解到安装此软件需要做哪些设置再进行操作</strong>，这样可以避免很多不必要的麻烦。</p>
<p>3、<font color="red"><strong>此案例分为五个步骤，请按照步骤顺序进行阅读！！</strong>🙂🙂</font></p>
<h1 id="1-安装-Linux-系统"><a href="#1-安装-Linux-系统" class="headerlink" title="1. 安装 Linux 系统"></a>1. 安装 Linux 系统</h1><h2 id="1-1-Linux-的选择"><a href="#1-1-Linux-的选择" class="headerlink" title="1.1 Linux 的选择"></a>1.1 Linux 的选择</h2><p>在 Linux 系统各个发行版中，CentOS 系统和 Ubuntu 系统在服务端和桌面端使用占比最高，选择 Ubuntu 还是 CentOS 主要取决于你的具体需求和使用场景。</p>
<p><strong>适用场景</strong>：</p>
<ul>
<li>CentOS 更适合用于企业级服务器环境，特别是那些需要长时间运行和大量数据处理的场景。它属于Red Hat Enterprise Linux(RHEL)的社区版本，核心思想是企业级稳定性和可靠性。</li>
<li>Ubuntu 则更注重用户友好和易用性，因此更适合个人电脑和桌面应用。它也常用于学习和探索 Linux 的初学者。</li>
</ul>
<p><strong>稳定性</strong>：</p>
<ul>
<li>CentOS 以其稳定性著称。它经过长时间的测试，只有经过验证的稳定版本才会被发布，因此更加安全稳定。</li>
<li>Ubuntu 的 LTS(长期支持)版本也非常稳定，提供长达五年的维护和支持。然而，其升级包有时可能会造成系统的不稳定和不安全。</li>
</ul>
<p><strong>使用难度和界面</strong>：</p>
<ul>
<li>Ubuntu 对新手更为友好，它拥有大量的帮助文档和教程，用户界面也更加友好，适合不熟悉 Linux 的用户。</li>
<li>CentOS 则相对较难上手，特别是对新用户来说。它的界面设计更加简洁，侧重于稳定性和安全性。</li>
</ul>
<p><strong>软件包和兼容性</strong>：</p>
<ul>
<li>CentOS 拥有庞大的软件包库，提供了大量的开源软件。</li>
<li>Ubuntu 则与 Canonical 公司以及其他软件供应商有良好的兼容性，对于一些商业软件的支持也更好。</li>
</ul>
<p><strong>社区支持</strong>：</p>
<ul>
<li>Ubuntu 由于其商业支持者和更大的社区，可能在某些情况下能提供更多的帮助。</li>
<li>CentOS 虽然也有社区支持，但可能不如 Ubuntu 的社区那么活跃和广泛。</li>
</ul>
<p>综上所述，如果你需要一个稳定且适用于企业级服务器环境的系统，CentOS 可能是更好的选择。而如果你<font color="red">更注重易用性和友好的用户界面</font>，或者你是一个 Linux 初学者，那么 Ubuntu 可能更适合你。这只是一个大致的指导，具体选择还需要根据你的具体需求和使用场景进行权衡。</p>
<p><font color="red"><strong>PS：本教程选择的是 CentOS7 版本！！！</strong></font>😀下面我们就开始安装 CentOS7 吧！</p>
<h2 id="1-2-CentOS7-下载地址"><a href="#1-2-CentOS7-下载地址" class="headerlink" title="1.2 CentOS7 下载地址"></a>1.2 CentOS7 下载地址</h2><p><a href="https://vault.centos.org/7.6.1810/isos/x86_64/">官网下载</a></p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/CentOS%E5%AE%98%E7%BD%91%E4%B8%8B%E8%BD%BD(1).png" style="zoom: 33%;">

<p>点进去之后依次点击 <code>isos/</code> –&gt; <code>x86_64/</code> ，找到下面文件进行下载</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/CentOS%E5%AE%98%E7%BD%91%E4%B8%8B%E8%BD%BD(2).png" style="zoom: 33%;">

<p><a href="https://mirrors.aliyun.com/centos/7/isos/x86_64/?spm=a2c6h.25603864.0.0.62464511sV8QoX">阿里镜像站</a>：与上面版本有些小差异，不过问题不大。都是CentOS7😉)</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/CentOS%E9%98%BF%E9%87%8C%E4%BA%91%E9%95%9C%E5%83%8F%E4%B8%8B%E8%BD%BD.png" style="zoom: 50%;">

<p>打开网站后下载对应的 <code>ios</code> 文件就可以了。</p>
<h2 id="1-3-CentOS7-系统安装"><a href="#1-3-CentOS7-系统安装" class="headerlink" title="1.3 CentOS7 系统安装"></a>1.3 CentOS7 系统安装</h2><p>Linux 系统的安装主要有两种方式：虚拟机安装和双系统安装。</p>
<p>虚拟机安装和使用 Linux 的硬件配置比较高，<del>建议</del><font color="red">要求</font>电脑至少有<strong>8G</strong>运行内存且剩余的存储容量<strong>足够大</strong>。电脑较旧或运行内存小于等于 4G 的电脑强烈建议选择双系统安装。否则，在配置较低的电脑上运行 Linux 虚拟机，<del>系统运行速度会非常慢</del><font color="red">电脑会卡死</font>😓。</p>
<p>什么是运行内存和存储容量？</p>
<p>通俗的说，运行内存决定了同时运行的程序多少，存储空间决定了能装文件的多少。口语中习惯上用运行内存＋存储空间简单描述设备主要指标。</p>
<p>如何查看电脑运行内存和存储容量？</p>
<ul>
<li><p>运行内存：</p>
<p>双击 <code>此电脑</code> 打开如下界面，然后在空白处右键，点击 <code>属性</code>。</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/%E6%9F%A5%E7%9C%8B%E7%94%B5%E8%84%91%E8%BF%90%E8%A1%8C%E5%86%85%E5%AD%98.png" style="zoom: 67%;">

<p>然后会出现这个界面，这里显示的 <code>RAM</code> 就是电脑的运行内存了。</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/%E7%94%B5%E8%84%91%E8%BF%90%E8%A1%8C%E5%86%85%E5%AD%98.png" style="zoom: 67%;">
</li>
<li><p>存储容量：</p>
<p>简单的来说就是你电脑所有盘符的大小，双击 <code>此电脑</code> 就可以看到自己电脑所有盘符的信息。</p>
</li>
</ul>
<p>由于我的电脑是<strong>16G + 512G</strong> ，所以我这里使用<strong>虚拟机安装</strong>。</p>
<blockquote>
<p>虚拟机 VMware 安装</p>
</blockquote>
<p><a href="https://www.vmware.com/products/workstation-pro/workstation-pro-evaluation.html">官网下载</a></p>
<p>点开后鼠标向下滑，点击 <code>VMware Workstation 17 Pro</code> 栏下的 <code>DOWNLOAD NOW</code> 之后开始下载 VMware。</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/VMware%E5%AE%98%E7%BD%91%E4%B8%8B%E8%BD%BD.png" style="zoom: 50%;">

<p>安装时使用 <font color="red">“傻瓜式”</font> 安装，无脑下一步即可。<font color="red">PS：注意按自己需求修改安装路径！</font>😏</p>
<p>安装完后需要产品许可证激活软件，大家可以在网上自行搜索。</p>
<p>安装成功后，<code>Win + i</code> 打开 <code>Windows</code> 设置找到 <code>网络和 Internet</code>，点击 <code>高级网络设置</code> 里的 <code>更改设配器选项</code>，出现了下面两个<strong>网络适配器</strong>则说明安装成功了。如果没有出现就说明网络适配器没有安装成功，那可能就要重装 VMware 咯😣。<font color="red">PS：重装之前记得将以前安装的 VMware 删除干净 ！！！！！</font>😂</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/%E7%BD%91%E7%BB%9C%E9%80%82%E9%85%8D%E5%99%A8.png" style="zoom: 67%;">

<blockquote>
<p>在 Windows 使用 VMware 安装 CentOS7</p>
</blockquote>
<p>1、打开 VMware 点击 创建新的虚拟机 。</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/%E5%AE%89%E8%A3%85CentOS7(1).png" style="zoom: 50%;">

<p>2、选择 自定义(高级)，点击下一步。</p>
<p>典型安装：VMware 会将主流的配置应用在虚拟机的操作系统上，对于新手来很友好。</p>
<p>自定义安装：自定义安装可以针对性的把一些资源加强，把不需要的资源移除。避免资源的浪费。</p>
<p>这里我选择<strong>自定义安装</strong>。</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/%E5%AE%89%E8%A3%85CentOS7(2).png" style="zoom: 67%;">

<p>3、连续点击下一步来到这个界面，找到择 <code>iso</code> 文件，然后点击下一步。</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/%E5%AE%89%E8%A3%85CentOS7(3).png" style="zoom:67%;">

<p>4、设置 Linux 名称、用户名、密码，设置完成点击下一步。</p>
<p>密码建议尽量简单一些，我这里设置的是 <code>123456</code> 。</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/%E5%AE%89%E8%A3%85CentOS7(4).png" style="zoom: 67%;">

<p>5、设置虚拟机名称和位置，然后点击下一步。</p>
<p>虚拟机安装完成后所在的目录，建议放在 C 盘以外的盘符。</p>
<p>我这里设置成 C 盘仅仅是教学需要，因为我电脑其他盘符已经 <font color="red">红</font> 了。😭😭😭</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/%E5%AE%89%E8%A3%85CentOS7(5).png" style="zoom:67%;">

<p>6、选择处理器数量以及每个处理器的内核数量(两者乘积不能超过本机的CPU内核数)，我这里都设置成 <code>2</code> ，大家随意，然后点击下一步。</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/%E5%AE%89%E8%A3%85CentOS7(6).png" style="zoom:67%;">

<p>7、选择内存大小(根据本机内存大小适当选择，建议不要选择超过本机一半的内存，例如我的是 16G，所以我选择 4G 内存)，然后点击下一步。</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/%E5%AE%89%E8%A3%85CentOS7(7).png" style="zoom: 67%;">

<p>8、连续点击下一步来到这个界面，选择磁盘大小(根据本机大小自己定，建议本机磁盘充裕的情况下越大越好，我这里选择 40G )，将虚拟机磁盘拆分成多个文件，然后点击下一步。</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/%E5%AE%89%E8%A3%85CentOS7(8).png" style="zoom:67%;">

<p>9、连续点击下一步来到这个界面，核对信息无误后点击 完成 即可。</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/%E5%AE%89%E8%A3%85CentOS7(9).png" style="zoom:67%;">

<p>至此 CentOS7 的安装就结束啦！现在只需要等待虚拟机开机即可。<strong>PS：虚拟机第一次开机较久，大家需要耐心等待哦。</strong>😊</p>
<p>加载完成后会出现以下界面：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/%E8%99%9A%E6%8B%9F%E6%9C%BA%E5%BC%80%E6%9C%BA%E7%95%8C%E9%9D%A2.png" style="zoom: 50%;">

<p>只需要点击一下用户然后输入密码，再点击 <code>Sign In</code> 即可进入虚拟机主界面(第一次开机系统会弹出提示，直接点击右上角 “X” 掉即可)，这就成功进入虚拟机了。</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/%E8%99%9A%E6%8B%9F%E6%9C%BA%E4%B8%BB%E7%95%8C%E9%9D%A2.png" style="zoom: 50%;">

<p>至此 Linux 系统已经成功安装好啦！！！！！！！！！！</p>
<p><strong>如何查看自己虚拟机的 ip 地址？</strong></p>
<p>桌面空白处右键点击 <code>Open Terminal</code> 打开 Terminal ，输入 <code>ifconfig</code> 后在 ens33 下看到的这个就是虚拟机的 ip 地址。</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/%E8%99%9A%E6%8B%9F%E6%9C%BAip%E5%9C%B0%E5%9D%80.png" style="zoom:50%;">

<h1 id="远程连接工具"><a href="#远程连接工具" class="headerlink" title="远程连接工具"></a>远程连接工具</h1><p>我们使用 VMware 可以得到 Linux 虚拟机，但是在 VMware 中操作 Linux 的命令行页面不太方便，主要是：<del>和Linux系统的各类交互，跨越 VMware 不方便</del>界面不好看。😐</p>
<p>这里介绍的是 FinalShell ，我为什么选择 FinalShell 呢？主要是 FinalShell <del>是国产SSH工具(纯中文)</del>我用习惯了而已😁，当然市面上也有很多其他的远程连接工具，你可以自行选择。🤔</p>
<h2 id="FinalShell-下载安装"><a href="#FinalShell-下载安装" class="headerlink" title="FinalShell 下载安装"></a>FinalShell 下载安装</h2><p><a href="https://www.hostbuf.com/t/988.html">下载官网</a>，点进去选择相应的版本即可。</p>
<p>安装：安装？安装时使用 <font color="red">“傻瓜式”</font> 安装，无脑下一步即可。<font color="red">PS：注意按自己需求修改安装路径！</font>😏</p>
<h2 id="FinalShell-使用"><a href="#FinalShell-使用" class="headerlink" title="FinalShell 使用"></a>FinalShell 使用</h2><blockquote>
<p>FinalShell 新建连接</p>
</blockquote>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/FinalShell%E6%96%B0%E5%BB%BA%E8%BF%9E%E6%8E%A5(1).png" style="zoom: 67%;">

<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/FinalShell%E6%96%B0%E5%BB%BA%E8%BF%9E%E6%8E%A5(2).png" style="zoom: 50%;">

<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/FinalShell%E6%96%B0%E5%BB%BA%E8%BF%9E%E6%8E%A5(3).png" style="zoom: 50%;">

<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/FinalShell%E6%96%B0%E5%BB%BA%E8%BF%9E%E6%8E%A5(4).png" style="zoom: 50%;">

<blockquote>
<p>FinalShell 文件上传</p>
</blockquote>
<p>在安装各种软件的时候为了方便，我们通常都是将软件在本机下载好然后再上传到 Linux 系统进行安装，那么怎样将本机下载的软件上传到 Linux 呢？</p>
<p>两种方式：</p>
<ul>
<li>命令上传(需要 <code>sudo yum -y install lrzsz</code> 安装)</li>
<li>直接拖动文件(需要切换 root 用户连接 Linux)</li>
</ul>
<p><strong>第一种：命令上传</strong></p>
<p><font color="red">PS：在上传文件之前请前用 <code>cd</code> 命令切换到文件要上传的目录。</font>😊</p>
<p>执行 <code>sudo rz</code> 命令后会弹出以下界面(第一次使用需要 <code>sudo yum -y install lrzsz</code> 安装一下)，选择下载的文件后点击确定(或者直接双击文件)</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/FinalShell%E5%91%BD%E4%BB%A4%E4%B8%8A%E4%BC%A0%E6%96%87%E4%BB%B6(1).png" style="zoom:67%;">

<p>等待上传进度 100% 即可</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/FinalShell%E5%91%BD%E4%BB%A4%E4%B8%8A%E4%BC%A0%E6%96%87%E4%BB%B6(2).png" style="zoom: 50%;">

<p>上传完成后可以通过 <code>ll</code> 命令查看，在目录下出现了对应安装包，则上传成功</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/%E5%AE%89%E8%A3%85%E5%8C%85%E4%B8%8A%E4%BC%A0%E6%88%90%E5%8A%9F.png" style="zoom: 50%;">

<p><strong>第二种：直接拖动文件</strong></p>
<p><font color="red">PS：使用这种方式一定要用 root 用户连接Linux，普通用户会上传失败</font>😊</p>
<p>怎么切换用户？</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/FinalShell%E5%88%87%E6%8D%A2%E7%94%A8%E6%88%B7.png" style="zoom: 50%;">

<p>切换用户后点击 FinalShell 右下角箭头</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/FinalShell%E6%8B%96%E5%8A%A8%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0(1).png" style="zoom:50%;">

<p>然后点击选择文件要上传到的目录，在 Windows 中直接将文件拖到此目录即可</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/FinalShell%E6%8B%96%E5%8A%A8%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0(2).png" style="zoom:50%;">

<p>之后就可以通过图形化界面在目录中看到刚刚上传的文件了</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/FinalShell%E6%8B%96%E5%8A%A8%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0(3).png" style="zoom:50%;">

<p><font color="red">PS：上传完之后记得切换回普通用户，避免误操带来系统损坏。</font>😊</p>
<p><strong>在后面涉及到文件上传的内容均采用以上两种方式(按需自选其一即可)，所以后面不再过多赘述。</strong></p>
<h1 id="2-Hadoop"><a href="#2-Hadoop" class="headerlink" title="2. Hadoop"></a>2. Hadoop</h1><p>Hadoop 是一个由 Apache 基金会开发的分布式系统框架，它利用集群的强大计算能力进行大数据的存储和处理，通过 HDFS 实现分布式存储，并通过 MapReduce 实现分布式计算，为企业提供了高效、可靠、可扩展的大数据处理能力。</p>
<h2 id="2-1-Hadoop-安装准备"><a href="#2-1-Hadoop-安装准备" class="headerlink" title="2.1 Hadoop 安装准备"></a>2.1 Hadoop 安装准备</h2><blockquote>
<p>配置操作权限</p>
</blockquote>
<p>安装之前我们要先了解到：我们刚才在安装 CentOS 的时候设置的用户名只是普通用户，而普通用户在许多地方的权限是受限的。那要怎么解决普通用户在 Linux 系统下权限受限的问题呢？</p>
<p>两个方案(<font color="red">推荐使用第二种，不建议长期使用 root 用户，避免带来系统损坏</font>)：</p>
<ul>
<li>使用 root 用户进行操作( root 用户拥有最大的系统操作权限)。</li>
<li>为普通用户配置 sudo 认证(为普通用户增加管理员权限)。(<font color="red">推荐</font>)</li>
</ul>
<p><strong>第一种：使用 root 用户进行操作</strong></p>
<p>直接使用命令然后输入密码即可切换到 root 用户。(输入密码时可能不会显示，输入密码后直接 <code>Enter</code> 确认就行)。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 切换到 root 用户</span></span><br><span class="line">su - root</span><br></pre></td></tr></table></figure>

<p>切换用户后，可以通过 <code>exit</code> 命令退回上一个用户，也可以使用快捷键：<code>ctrl + d</code> 。</p>
<p>使用普通用户，切换到其它用户需要输入密码，如切换到 root 用户。</p>
<p>使用 root 用户切换到其它用户，无需密码，可以直接切换。</p>
<p><strong>第二种：为普通用户配置 sudo 认证</strong></p>
<p>为普通用户配置 sudo 认证后，在执行其它命令之前，带上 sudo ，即可为这一条命令临时赋予 root 授权。</p>
<p>1、切换到 root 用户，使用命令然后输入密码</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 切换到 root 用户</span></span><br><span class="line">su - root</span><br></pre></td></tr></table></figure>

<p>2、执行以下命令，会自动通过 vi 编辑器打开：&#x2F;etc&#x2F;sudoers</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">visudo	<span class="comment">#或者执行 vi /etc/sudoers</span></span><br></pre></td></tr></table></figure>

<p>3、先按一下键盘上的 <code>ESC</code> 键，再输入<code>:set nu</code> 显示行号，找到 <code>root ALL=(ALL) ALL</code> 这行，然后输入 <code>:101</code> (跳到第101行 )，然后在这行增加一行内容：<code>muyoukule ALL=(ALL)	NOPASSWD:ALL</code> (其中 <code>muyoukule</code> 是需要配置 <code>sudo</code> 认证的普通用户，<code>NOPASSWD:ALL</code> 表示使用 sudo 命令时无需输入密码，中间的间隔为 <code>tab</code> )，如下图所示：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/sudo%E8%AE%A4%E8%AF%81.png"></p>
<p>4、添加上一行内容后，先按一下键盘上的 <code>ESC</code> 键，然后输入 <code>:wq</code> 再按回车键保存退出就可以了。</p>
<p>5、最后使用 <code>ctrl + d</code> 注销当前 root 用户，回到刚才自己创建的用户，至此为普通用户配置 <code>sudo</code> 认证成功。</p>
<blockquote>
<p>检查网络</p>
</blockquote>
<p>使用 <code>muyoukule</code> 用户登录后，还需要安装几个软件才能安装 Hadoop。</p>
<p>CentOS 使用 yum 来安装软件，需要联网环境，首先应检查一下是否连上了网络。</p>
<p>提供两种方式：</p>
<ul>
<li><p>如下图所示，桌面右上角的网络图标若显示 <font color="green">绿</font> 点，则表明还联网。</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/%E6%A3%80%E6%9F%A5%E7%BD%91%E7%BB%9C%E9%85%8D%E7%BD%AE.png" style="zoom: 50%;">
</li>
<li><p>使用 <code>ping www.baidu.com</code>，ping 得通说明可以联网。</p>
</li>
</ul>
<blockquote>
<p>安装 SSH、配置 SSH 无密码登陆</p>
</blockquote>
<p>集群、单节点模式都需要用到 SSH 登陆(类似于远程登陆，你可以登录某台 Linux 主机，并且在上面运行命令)，一般情况下，CentOS 默认已安装了 SSH client、SSH server，打开终端执行如下命令进行检验：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 检验是否安装了 SSH client、SSH server</span></span><br><span class="line">rpm -qa | grep ssh</span><br></pre></td></tr></table></figure>

<p>如果返回的结果如下图所示，包含了 SSH client 跟 SSH server，则不需要再安装。</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/%E6%A3%80%E6%9F%A5SSH.png"></p>
<p>若需要安装，则可以通过 yum 进行安装：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo yum -y install openssh-clients</span><br><span class="line">sudo yum -y install openssh-server</span><br></pre></td></tr></table></figure>

<p>接着执行如下命令测试一下 SSH 是否可用：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ssh localhost</span><br></pre></td></tr></table></figure>

<p>此时会有如下提示(SSH首次登陆提示)，输入 yes 。然后按提示输入密码 <code>123456</code> (输入你自己安装虚拟机的时候输入的密码)，这样就登陆到本机了。</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/%E6%B5%8B%E8%AF%95SSH%20.png"></p>
<p>但这样登陆是需要每次输入密码的，我们需要配置成 SSH 无密码登陆比较方便。</p>
<p>首先输入 <code>exit</code> 退出刚才的 ssh，就回到了我们原先的终端窗口，然后利用 ssh-keygen 生成密钥，并将密钥加入到授权中：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 退出刚才的 ssh localhost</span></span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 若没有该目录，请先执行一次ssh localhost</span></span><br><span class="line"><span class="built_in">cd</span> ~/.ssh/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 会有提示，都按回车就可以</span></span><br><span class="line">ssh-keygen -t rsa</span><br><span class="line"></span><br><span class="line"><span class="comment"># 加入授权</span></span><br><span class="line"><span class="built_in">cat</span> id_rsa.pub &gt;&gt; authorized_keys</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改文件权限</span></span><br><span class="line"><span class="built_in">chmod</span> 600 ./authorized_keys</span><br></pre></td></tr></table></figure>

<p>此时再用 <code>ssh localhost</code> 命令，无需输入密码就可以直接登陆了，如下图所示：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/SSH%E6%97%A0%E5%AF%86%E7%99%BB%E5%85%A5.png"></p>
<blockquote>
<p>准备 Java 环境</p>
</blockquote>
<p>准备 Java 环境之前我们要知道两件事：</p>
<ul>
<li>软件安装的那些事：<a href="https://www.php.cn/faq/502305.html">Linux软件安装在哪个目录？</a> <font color="red">很重要！！！！一定要仔细阅读！！！避免后续自己找不到安装的软件！！！</font>😅</li>
<li><strong>JRE 和 JDK 的主要区别：</strong>JRE ( Java 运行环境)仅用于运行已 <font color="red">编译</font> 的 Java 程序，而  JDK ( Java 开发工具包)则包含了 <font color="red">编译、调试、运行</font> Java 程序所需的所有工具，用于 Java 程序的开发。简单来说，JRE 是运行 Java 的，而 JDK 是开发 Java 的。</li>
</ul>
<p>在Linux系统中，Java 环境的选择和配置对于运行 Hadoop 等 Java 应用至关重要，因为 Hadoop 是基于 Java 开发的。我们可以选择以下两种方式安装 Java 环境(<font color="red">推荐第二种方式</font>)：</p>
<ul>
<li>安装 OpenJDK 。</li>
<li>安装 Oracle 的 JDK 。(<font color="red">推荐</font>)</li>
</ul>
<p>Linux 系统通过 yum 安装 OpenJDK 更为简便且开源免费，而安装 Oracle JDK 则需手动下载并可能涉及商业授权，但享有 Oracle 的专业技术支持，两者在版本更新和稳定性上也有所不同，选择取决于具体需求和偏好。</p>
<p><strong>第一种：安装 OpenJDK</strong></p>
<p>OpenJDK 是开源的，并且被广大社区所支持，因此在许多 Linux 发行版中，包括CentOS ，OpenJDK 被作为默认的 Java 环境安装。以 CentOS7 为例，它默认安装了 OpenJDK 1.8 的 Java 运行环境(JRE)。可以使用 <code>java -version</code> 查看到：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/%E9%BB%98%E8%AE%A4OpenJDK.png"></p>
<p>但是<strong>不能</strong>在系统环境变量中查看到 <code>JAVA_HOME</code> ，由于 Hadoop 需要这个环境变量，所以后面需要<strong>进行 Java 的相关环境变量配置</strong>。</p>
<p>然而，对于 Hadoop 等 Java 应用的开发和运行，通常需要完整的 Java 开发工具包(JDK)，而不仅仅是 JRE 。因此，为了开发方便和确保 Hadoop 等应用的正常运行，用户需要安装 JDK 。</p>
<p>在 CentOS 中，可以通过 <code>yum</code> 包管理器来安装 JDK。具体过程请参考：<a href="https://blog.csdn.net/qq_43699958/article/details/134532819">使用 yum 安装 jdk 并配置环境变量</a></p>
<p><strong>第二种：安装 Oracle 的 JDK</strong></p>
<p><a href="https://www.oracle.com/java/technologies/javase/javase8-archive-downloads.html">JDK 下载官网</a></p>
<p>打开后下拉找到相应的版本下载即可，点击下载后在弹出的页面中输入 Oracle 的账户密码即可下载(如无账户，请自行注册，注册是免费的)。<font color="red">PS：一定要下载以 <code>.tar.gz</code> 结尾的文件，不要下载错了哦！！</font>😊</p>
<p>下载好之后就可以开始安装了：</p>
<p>1、执行以下命令，选择文件上传到 Linux 的 &#x2F; 目录(具体请参考上文 <strong>FinalShell 文件上传</strong>)</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> /</span><br><span class="line"></span><br><span class="line">sudo rz</span><br></pre></td></tr></table></figure>

<p>2、解压缩 JDK 安装文件到 &#x2F;usr&#x2F;local 目录，解压完成后可以进入到 &#x2F;usr&#x2F;local 目录查看是否多了以下文件夹：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 解压缩 JDK 安装文件到 /usr/local 目录</span></span><br><span class="line">sudo tar -zxvf jdk-8u162-linux-x64.tar.gz -C /usr/local</span><br><span class="line"></span><br><span class="line"><span class="comment"># 进入到 /usr/local 目录</span></span><br><span class="line"><span class="built_in">cd</span> /usr/local</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看文件</span></span><br><span class="line">ll</span><br></pre></td></tr></table></figure>

<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/%E6%9F%A5%E7%9C%8B%E8%A7%A3%E5%8E%8B%E6%98%AF%E5%90%A6%E6%88%90%E5%8A%9F.png"></p>
<p>3、配置环境变量，使用 vim 编辑器修改 &#x2F;etc&#x2F;profile 文件，在文件最后添加环境变量。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 修改 /etc/profile 文件</span></span><br><span class="line">sudo vim /etc/profile</span><br><span class="line"></span><br><span class="line"><span class="comment"># Java环境变量</span></span><br><span class="line"><span class="built_in">export</span> JAVA_HOME=/usr/local/jdk1.8.0_162</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$&#123;JAVA_HOME&#125;</span>/bin:<span class="variable">$PATH</span></span><br></pre></td></tr></table></figure>

<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/%E9%85%8D%E7%BD%AEJava%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F.png" style="zoom: 67%;">

<p>4、重启环境变量配置</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">source</span> /etc/profile</span><br></pre></td></tr></table></figure>

<p>5、检查安装结果，如果设置正确的话，<code>$JAVA_HOME/bin/java -version</code> 会输出 java 的版本信息，且和 <code>java -version</code> 的输出结果一样：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="variable">$JAVA_HOME</span>/bin/java -version</span><br><span class="line">java -version</span><br></pre></td></tr></table></figure>

<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/%E6%A3%80%E6%9F%A5Java%E5%AE%89%E8%A3%85%E7%BB%93%E6%9E%9C.png"></p>
<p>这样，Hadoop 所需的 Java 运行环境就安装好了。</p>
<h2 id="2-2-Hadoop下载安装"><a href="#2-2-Hadoop下载安装" class="headerlink" title="2.2 Hadoop下载安装"></a>2.2 Hadoop下载安装</h2><p><a href="https://archive.apache.org/dist/hadoop/common/">官网下载</a></p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/hadoop%E5%AE%98%E7%BD%91%E4%B8%8B%E8%BD%BD(1).png" style="zoom: 67%;">

<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/hadoop%E5%AE%98%E7%BD%91%E4%B8%8B%E8%BD%BD(2).png" style="zoom:50%;">

<p>打不开官网？试试<a href="https://mirrors.tuna.tsinghua.edu.cn/apache/hadoop/common/">清华大学开源软件镜像站下载</a>，不过好像只有新版。🤔</p>
<p>下载好之后就可以开始安装了：</p>
<p>1、执行以下命令，选择文件上传到 Linux 的 &#x2F; 目录(具体请参考上文 <strong>FinalShell 文件上传</strong>)</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> /</span><br><span class="line"></span><br><span class="line">sudo rz</span><br></pre></td></tr></table></figure>

<p>2、解压缩 Hadoop 安装文件到 &#x2F;usr&#x2F;local 目录，解压完成后可以进入到 &#x2F;usr&#x2F;local 目录查看是否成功。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 解压缩安装文件到 /usr/local 目录</span></span><br><span class="line">sudo tar -zxvf hadoop-3.1.3.tar.gz -C /usr/local</span><br><span class="line"></span><br><span class="line"><span class="comment"># 进入到 /usr/local 目录</span></span><br><span class="line"><span class="built_in">cd</span> /usr/local</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将 hadoop-3.1.3 下的所有文件的所有者改为 muyoukule，</span></span><br><span class="line"><span class="comment"># hadoop-3.1.3 是 hadoop-3.1.3.tar.gz 解压后得到的文件夹</span></span><br><span class="line"><span class="comment"># muyoukule 是当前用户的用户名</span></span><br><span class="line">sudo <span class="built_in">chown</span> -R muyoukule:muyoukule ./hadoop-3.1.3</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看文件</span></span><br><span class="line">ll</span><br></pre></td></tr></table></figure>

<p>3、配置环境变量，使用 vim 编辑器修改 &#x2F;etc&#x2F;profile 文件，在文件最后添加环境变量。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 修改 /etc/profile 文件</span></span><br><span class="line">sudo vim /etc/profile</span><br><span class="line"></span><br><span class="line"><span class="comment"># Hadoop 环境变量</span></span><br><span class="line"><span class="built_in">export</span> HADOOP_HOME=/usr/local/hadoop-3.1.3</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:<span class="variable">$HADOOP_HOME</span>/bin:<span class="variable">$HADOOP_HOME</span>/sbin</span><br></pre></td></tr></table></figure>

<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/%E9%85%8D%E7%BD%AEHadoop%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F.png" style="zoom:67%;">

<p>4、重启环境变量配置</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">source</span> /etc/profile</span><br></pre></td></tr></table></figure>

<p>5、检查安装结果，出现下面信息代表安装成功</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看 Hadoop 版本信息</span></span><br><span class="line">hadoop version</span><br></pre></td></tr></table></figure>

<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/%E6%A3%80%E6%9F%A5Hadoop%E5%AE%89%E8%A3%85%E7%BB%93%E6%9E%9C.png">

<p>这样，Hadoop 就安装好了。</p>
<h2 id="2-3-Hadoop-单机配置"><a href="#2-3-Hadoop-单机配置" class="headerlink" title="2.3 Hadoop 单机配置"></a>2.3 Hadoop 单机配置</h2><p>Hadoop 默认模式为非分布式模式，无需进行其他配置即可运行。非分布式即单 Java 进程，方便进行调试。</p>
<p>现在我们可以执行例子来感受下 Hadoop 的运行。Hadoop 附带了丰富的例子，包括 wordcount、terasort、join、grep 等。</p>
<ul>
<li>WordCount 是一个基础示例程序，用于计算文本中每个单词的出现次数，通过MapReduce模型实现数据的分布式处理。</li>
<li>Terasort 是 Hadoop 中的一个排序算法，能够处理大规模数据集的排序问题，通过分布式计算和 trie 树的性质提高排序效率。</li>
<li>Join 操作在 Hadoop 中虽然不直接支持，但可以通过编程实现类似的功能，包括 Reduce side join 和 Map side join，用于整合不同数据源中的数据。</li>
<li>Grep 则是一种文本搜索工具，在 Hadoop 中可以用于搜索存储在 HDFS 中的大规模文本文件，通过编写自定义的 Mapper 程序实现特定正则表达式的匹配。</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 改变当前工作目录到 /usr/local/hadoop-3.1.3</span></span><br><span class="line"><span class="built_in">cd</span> /usr/local/hadoop-3.1.3</span><br><span class="line"></span><br><span class="line"><span class="comment"># 可以看到所有例子</span></span><br><span class="line">hadoop jar ./share/hadoop/mapreduce/hadoop-mapreduce-examples-3.1.3.jar</span><br></pre></td></tr></table></figure>

<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/Hadoop%E4%BE%8B%E5%AD%90.png" style="zoom:67%;">

<p>在此我们选择运行 grep 例子，我们将 input 文件夹中的所有文件作为输入，筛选当中符合正则表达式  <code>dfs[a-z.]+</code>  的单词并统计出现的次数，最后输出结果到 output 文件夹中。需要注意：如果 output 目录已经存在，Hadoop 会报错，<strong>因为输出目录必须是空的</strong>。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 改变当前工作目录到 /usr/local/hadoop-3.1.3</span></span><br><span class="line"><span class="built_in">cd</span> /usr/local/hadoop-3.1.3</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在当前的目录创建一个名为 input 的目录</span></span><br><span class="line"><span class="built_in">mkdir</span> ./input</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将 ./etc/hadoop/ 目录下的所有 .xml 文件复制到刚刚创建的 input 目录中</span></span><br><span class="line"><span class="built_in">cp</span> ./etc/hadoop/*.xml ./input</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在 input 目录中搜索所有符合正则表达式模式 dfs[a-z.]+ 的字符串，并将搜索结果输出到 output 目录</span></span><br><span class="line">hadoop jar ./share/hadoop/mapreduce/hadoop-mapreduce-examples-*.jar grep ./input ./output <span class="string">&#x27;dfs[a-z.]+&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 output 目录下的所有文件内容，即 grep 任务的输出结果</span></span><br><span class="line"><span class="built_in">cat</span> ./output/*</span><br></pre></td></tr></table></figure>

<p>执行完后可以看到如下内容：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/grep%E4%BE%8B%E5%AD%90.png" style="zoom: 67%;">

<h2 id="2-4-Hadoop-伪分布式配置"><a href="#2-4-Hadoop-伪分布式配置" class="headerlink" title="2.4 Hadoop 伪分布式配置"></a>2.4 Hadoop 伪分布式配置</h2><p>Hadoop 的伪分布式配置允许 Hadoop 在单节点上以分布式的方式运行，尽管所有的 Hadoop 进程都运行在同一台机器上。在这种配置中，Hadoop 进程以分离的 Java 进程来运行，节点既作为 NameNode 也作为 DataNode，同时读取的是 HDFS(Hadoop Distributed File System)中的文件。</p>
<p><code>cd</code> 进入 Hadoop 安装包内，通过 <code>ll</code> 命令查看文件夹内部结构：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/Hadoop%E6%96%87%E4%BB%B6%E5%A4%B9%E5%86%85%E9%83%A8%E7%BB%93%E6%9E%84.png"></p>
<p>各个文件夹含义如下：</p>
<ul>
<li>bin，存放Hadoop的各类程序(命令)</li>
<li>etc，存放Hadoop的配置文件</li>
<li>include，C语言的一些头文件</li>
<li>lib，存放Linux系统的动态链接库(.so文件)</li>
<li>libexec，存放配置Hadoop系统的脚本文件(.sh和.cmd)</li>
<li>sbin，管理员程序(super bin)</li>
<li>share，存放二进制源码(Java jar包)</li>
</ul>
<p>配置 Hadoop 伪分布式，我们主要涉及到如下文件的修改：</p>
<ul>
<li>core-site.xml： Hadoop 核心配置文件</li>
<li>hdfs-site.xml： HDFS 核心配置文件</li>
</ul>
<p>这些文件均存在与 <code>$HADOOP_HOME/etc/hadoop</code> 文件夹中，用于设置 Hadoop 集群的各种参数，如 HDFS 的端口号、NameNode 的地址等。Hadoop 的配置文件是 xml 格式，每个配置以声明 property 的 name 和 value 的方式来实现。</p>
<p><strong>PS：$HADOOP_HOME是设置的环境变量，其指代 Hadoop 安装文件夹即 &#x2F;usr&#x2F;local&#x2F;hadoop-3.1.3</strong></p>
<p>1、修改配置文件 core-site.xml </p>
<p><strong>hadoop.tmp.dir</strong></p>
<p><code>hadoop.tmp.dir</code> 是 Hadoop 框架中的关键配置参数，用于指定临时数据和关键元数据的存储位置。它对于 Hadoop 的稳定运行和数据安全至关重要，特别是在处理大规模数据集时。合理配置这个目录，可以确保中间文件和关键信息得到妥善保存，避免因系统重启或临时目录被清空而导致的数据丢失。因此，在部署和配置 Hadoop 时，建议根据实际需求调整 <code>hadoop.tmp.dir</code> 的路径，并确保其指向持久化的存储位置。这里我们给它设置为 Hadoop 安装目录下的 <code>tmp</code> 文件夹，对于我的安装目录来说，具体路径在 <code>/usr/local/hadoop-3.1.3/tmp</code>，大家可以根据自己的安装目录进行一定的调整。</p>
<p><strong>fs.defaultFS</strong></p>
<p><code>fs.defaultFS</code> 是 Hadoop 框架中一个重要的配置参数，它用于指定集群中默认的文件系统路径。这个路径通常是 HDFS(Hadoop Distributed FileSystem)的 URI，但也可以是其他支持的文件系统，如本地文件系统、Amazon S3 等。通过配置 <code>fs.defaultFS</code>，Hadoop 应用程序可以无缝地访问和操作存储在这些文件系统中的数据。</p>
<p>这次我们选择用 gedit 而不是 vim 来编辑。gedit 是文本编辑器，类似于 Windows 中的记事本，会比较方便。保存后记得关掉整个 gedit 程序，否则会占用终端。</p>
<p><font color="red">PS：使用 gedit 需要直接操作虚拟机，不能在远程连接工具操作，否则可能会打不开图形化编辑器。</font>😅</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 改变当前工作目录到 /usr/local/hadoop-3.1.3</span></span><br><span class="line"><span class="built_in">cd</span> /usr/local/hadoop-3.1.3</span><br><span class="line"></span><br><span class="line"><span class="comment"># 第一次使用先进行安装</span></span><br><span class="line">sudo yum -y install gedit</span><br><span class="line"></span><br><span class="line"><span class="comment"># 打开 core-site.xml 文件</span></span><br><span class="line">gedit ./etc/hadoop/core-site.xml</span><br></pre></td></tr></table></figure>

<p>将当中的</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>修改为下面配置：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 配置 Hadoop 数据根目录为 /usr/local/hadoop-3.1.3/tmp 目录 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>hadoop.tmp.dir<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>file:/usr/local/hadoop-3.1.3/tmp<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">description</span>&gt;</span>Abase for other temporary directories.<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>fs.defaultFS<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>hdfs://localhost:9000<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/gedit%E7%BC%96%E8%BE%91core-site.xml.png" style="zoom:50%;">

<p>2、同理修改配置文件 hdfs-site.xml</p>
<p><strong>dfs.replication</strong></p>
<p><code>dfs.replication</code>  是 Hadoop 分布式文件系统(HDFS)中的关键参数，用于指定每个数据块在HDFS中存储的副本数。合理配置该参数可以平衡数据可靠性、存储资源消耗和性能需求，确保HDFS在高可用性和容错性方面表现出色。</p>
<p><strong>dfs.namenode.name.dir 和 dfs.datanode.data.dir</strong></p>
<p><code>dfs.namenode.name.dir</code> 用于指定保存 HDFS 元数据的目录，包括文件系统的命名空间、属性及块位置等信息，确保元数据的安全存储和可靠访问。</p>
<p><code>dfs.datanode.data.dir</code> 则用于指定存放 HDFS 数据块文件的目录，是数据节点存储实际数据的本地路径，确保数据的分布式存储和高效访问。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 打开 hdfs-site.xml 文件</span></span><br><span class="line">gedit ./etc/hadoop/hdfs-site.xml</span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.replication<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>1<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 配置目录为 /usr/local/hadoop-3.1.3/tmp/dfs/name 目录 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.namenode.name.dir<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>file:/usr/local/hadoop-3.1.3/tmp/dfs/name<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 配置目录为 /usr/local/hadoop-3.1.3/tmp/dfs/data 目录 --&gt;</span>    </span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.datanode.data.dir<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>file:/usr/local/hadoop-3.1.3/tmp/dfs/data<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>3、配置完成后，执行以下命令格式化 NameNode ，成功的话会看到 <code>successfully formatted</code>。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 格式化 NameNode</span></span><br><span class="line">hdfs namenode -format</span><br></pre></td></tr></table></figure>

<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/NameNode%E7%9A%84%E6%A0%BC%E5%BC%8F%E5%8C%96.png"></p>
<p>4、接着执行一下命令，开启 NameNode 和 DataNode 守护进程</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># start-dfs.sh 是个完整的可执行文件，中间没有空格</span></span><br><span class="line">start-dfs.sh</span><br></pre></td></tr></table></figure>

<p>若出现 SSH 的提示 <code>Are you sure you want to continue connecting</code>，输入 <code>yes</code> 即可。最终出现如下画面：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/%E5%BC%80%E5%90%AF%E5%AE%88%E6%8A%A4%E8%BF%9B%E7%A8%8B%E6%88%90%E5%8A%9F.png"></p>
<p>假如出现以下异常请参考：<a href="https://www.bilibili.com/read/cv16023845/">解决Hadoop伪分布式中localhost: ERROR: JAVA_HOME is not set and could not be found)</a></p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/JavaHome%E6%89%BE%E4%B8%8D%E5%88%B0.png"></p>
<p>启动完成后，可以通过命令 <code>jps</code> 来判断是否成功启动，若成功启动则会列出如下进程： “NameNode”、”DataNode”和SecondaryNameNode(如果 SecondaryNameNode 没有启动，请运行 <code>stop-dfs.sh</code> 关闭进程，然后再次尝试启动尝试)。如果没有 NameNode 或 DataNode ，那就是配置不成功，请仔细检查之前步骤，或通过查看启动日志排查原因。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 判断是否成功启动</span></span><br><span class="line">jps</span><br></pre></td></tr></table></figure>

<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/Hadoop%E4%BC%AA%E5%88%86%E5%B8%83%E5%BC%8F%E9%85%8D%E7%BD%AE%E6%88%90%E5%8A%9F.png"></p>
<p>成功启动后，可以访问 Web 界面查看 HDFS 的 NameNode 状态，可以在线查看 HDFS 中的文件。</p>
<p><font color="red">PS：访问 WEB 界面时，hadoop 3.x 以下版本的端口为 <code>50070</code>，hadoop 3.x 以上版本的端口为 <code>9870</code>。一定要使用相应的版本访问相应的端口，不然访问不成功！！！！</font>😱😱😱</p>
<p>其实在最开始的时候我也不知道 hadoop 3.x 以上版本的端口号发生了变化😭，而我自己安装的 hadoop 版本为 3.1.3，这就导致了我访问 50070 端口时肯定是失败的😫。在网上进行查阅，发现网上描述出现这个情况的原因无非以下几点：防火墙没关闭；端口被占用；$HADOOP_HOME&#x2F;etc&#x2F;hadoop 下的 core-site.xml 和 hdfs-site.xml 没有配置好。我也根据这些问题一一进行排查，尽管没有出现以上问题结果还是访问不了，于是我百思不得其解，跑去 Hadoop 官网查看默认配置项才发现端口号已经发生了改变：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/NameNode%20Web%20UI%E7%9B%91%E5%90%AC%E7%9A%84%E5%9C%B0%E5%9D%80%E5%92%8C%E5%9F%BA%E7%AB%AF%E5%8F%A3.png"></p>
<p>在Hadoop中，<code>dfs.namenode.http-address</code> 是配置参数，用于指定 NameNode Web UI 监听的地址和基端口。这个 Web UI 提供了关于 HDFS 集群状态、配置、以及文件浏览等信息的可视化界面。</p>
<p>发现端口发生改变后我去网上查阅，最后才知道 hadoop 3.x 以下版本的端口为 <code>50070</code>，hadoop 3.x 以上版本的端口变化为了 <code>9870</code>。</p>
<p>最后将Hadoop 官网查看默认配置项链接放在这儿：<a href="https://hadoop.apache.org/docs/current/hadoop-mapreduce-client/hadoop-mapreduce-client-core/MapReduceTutorial.html">Apache Hadoop 3.4.0 – MapReduce Tutorial</a> 。大家打开后下拉在左下角找到 <code>Configuration</code> 然后点击 <code>hdfs-site.xml</code> 进入页面在 <code>dfs.namenode.http-address</code> 配置参数就可以查看到端口。</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/Hadoop%E7%9A%84Configurationp.png"></p>
<p>两种访问方式：</p>
<ul>
<li>虚拟机访问</li>
<li>本机访问</li>
</ul>
<p><strong>第一种：虚拟机访问</strong></p>
<p><font color="red">PS：需要直接操作虚拟机，不能在远程连接工具操作，否则会报错。</font>😅</p>
<p>CentOS 自带有 Firefox 浏览器，不过一般比较旧，有很多兼容性问题，可以先卸载掉再安装新版的 Firefox ，安装成功后再查看版本。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 卸载 Firefox</span></span><br><span class="line">sudo yum -y remove firefox</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装 Firefox</span></span><br><span class="line">sudo yum -y install firefox</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看版本</span></span><br><span class="line">firefox -version</span><br></pre></td></tr></table></figure>

<p>查看 Firefox 版本：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/%E6%9F%A5%E7%9C%8BFirefox%E7%89%88%E6%9C%AC.png"></p>
<p>输入命令直接打开 Firefox 浏览器：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 打开 Firefox 浏览器</span></span><br><span class="line">firefox</span><br></pre></td></tr></table></figure>

<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/%E6%88%90%E5%8A%9F%E6%89%93%E5%BC%80Firefox.png" style="zoom:50%;">

<p>浏览器输入 <a href="http://localhost:9870/">http://localhost:9870</a> 成功访问到 Web 界面。</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/CentOS%E6%9F%A5%E7%9C%8BHDFS.png" style="zoom:50%;">

<p><strong>第二种：本机访问</strong></p>
<p><font color="red">PS：本机访问需要关闭虚拟机防火墙，不然访问不了。</font>(自己虚拟机的防火墙无所谓随便关闭，真实的环境中<del>不建议</del><font color="red">绝对不能</font>这样做，真实的环境一般是开放指定端口)😶</p>
<p>首先查看防火墙状态。出现绿色 <code>Active：active (running)</code> 表示开启，出现白色 <code>Active：inactive (dead)</code> 表示关闭。然后自行对其进行设置。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看防火墙状态</span></span><br><span class="line">systemctl status firewalld</span><br><span class="line"></span><br><span class="line"><span class="comment"># 开启防火墙 </span></span><br><span class="line">sudo systemctl start firewalld</span><br><span class="line"></span><br><span class="line"><span class="comment"># 关闭防火墙 </span></span><br><span class="line">sudo systemctl stop firewalld</span><br></pre></td></tr></table></figure>

<p>直接打开本机浏览器输入 <a href="http://192.168.88.131:9870/">http://192.168.88.131:9870/</a> 成功访问到 Web 界面。<font color="red">PS：这里的 192.168.88.131 是虚拟机 ip 地址。</font></p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/%E6%9C%AC%E6%9C%BA%E6%9F%A5%E7%9C%8BHDFS.png" style="zoom: 50%;">

<p><strong>PS：在启动 Hadoop 的时候如果已有 Hadoop 节点在运行，要先关闭所有 Hadoop 服务再启动。</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 关闭 Hadoop</span></span><br><span class="line">stop-dfs.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启 Hadoop</span></span><br><span class="line">start-dfs.sh</span><br><span class="line"></span><br><span class="line"><span class="comment">#上面两句操纵也是关闭和开启hadoop操作</span></span><br></pre></td></tr></table></figure>

<h2 id="2-5-运行-Hadoop-伪分布式实例"><a href="#2-5-运行-Hadoop-伪分布式实例" class="headerlink" title="2.5 运行 Hadoop 伪分布式实例"></a>2.5 运行 Hadoop 伪分布式实例</h2><p>上面的单机模式，grep 例子读取的是本地数据，伪分布式读取的则是 HDFS 上的数据。要使用 HDFS，首先需要在 HDFS 中创建用户目录(用户名目录名可以随意输入，我这里输入的是 muyoukule )：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 改变当前工作目录到 /usr/local/hadoop-3.1.3</span></span><br><span class="line"><span class="built_in">cd</span> /usr/local/hadoop-3.1.3</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在 HDFS 上创建一个名为 muyoukule 的目录，并将其放置在 /user 目录下</span></span><br><span class="line">hdfs dfs -<span class="built_in">mkdir</span> -p /user/muyoukule</span><br><span class="line"></span><br><span class="line"><span class="comment"># 列出 HDFS 上 /user 目录下的所有文件和目录</span></span><br><span class="line">hdfs dfs -<span class="built_in">ls</span> /user</span><br><span class="line"></span><br><span class="line"><span class="comment"># 列出 HDFS 上 /user/muyoukule 目录下的所有文件和目录</span></span><br><span class="line">hdfs dfs -<span class="built_in">ls</span> /user/muyoukule</span><br></pre></td></tr></table></figure>

<p>创建成功后可以在 &#x2F;user 目录下查看到用户目录，查看用户目录应该为空，因为目录下没有内容。</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/HDFS%E4%B8%AD%E5%88%9B%E5%BB%BA%E7%94%A8%E6%88%B7%E7%9B%AE%E5%BD%95.png"></p>
<p>接着将 <code>./etc/hadoop</code> 中的 xml 文件作为输入文件复制到分布式文件系统中，即将 <code>/usr/local/hadoop-3.1.3/etc/hadoop</code> 复制到分布式文件系统中的 <code>/user/muyoukule/input</code> 中。我使用的是 muyoukule用户，并且已创建相应的用户目录 <code>/user/muyoukule</code>，因此在命令中就可以使用相对路径如 input，其对应的绝对路径就是 <code>/user/muyoukule/input</code>：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 在 HDFS 上创建一个名为 input 的目录</span></span><br><span class="line">hdfs dfs -<span class="built_in">mkdir</span> input</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将本地文件系统上 ./etc/hadoop/ 目录下所有的 .xml 文件上传到 HDFS 的 input 目录中</span></span><br><span class="line">hdfs dfs -put ./etc/hadoop/*.xml input</span><br></pre></td></tr></table></figure>

<p>复制完成后，可以通过如下命令查看文件列表：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">hdfs dfs -<span class="built_in">ls</span> input</span><br></pre></td></tr></table></figure>

<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/HDFS%E4%B8%8Binput%E6%96%87%E4%BB%B6%E5%88%97%E8%A1%A8.png"></p>
<p>伪分布式运行 MapReduce 作业的方式跟单机模式相同，区别在于伪分布式读取的是 HDFS 中的文件(可以将单机步骤中创建的本地 input 文件夹，输出结果 output 文件夹都删掉来验证这一点)。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 执行一个 MapReduce 作业，该作业使用 Hadoop 自带的 grep 示例程序来搜索 input 目录中匹配给定模式的行，并将结果写入 output 目录</span></span><br><span class="line">hadoop jar ./share/hadoop/mapreduce/hadoop-mapreduce-examples-*.jar grep input output <span class="string">&#x27;dfs[a-z.]+&#x27;</span></span><br></pre></td></tr></table></figure>

<p>查看运行结果的命令(查看的是位于 HDFS 中的输出结果)：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">hdfs dfs -<span class="built_in">cat</span> output/*</span><br></pre></td></tr></table></figure>

<p>如果出现：<code>INFO sasl.SaslDataTransferClient: SASL encryption trust check: localHostTrusted = false, remoteHostTrusted = false</code> 表示SASL数据传输客户端在进行加密信任检查时，发现本地主机(localHost)和远程主机(remoteHost)都没有被信任。可以不用管它。</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/HDFS%E8%BE%93%E5%87%BA%E7%BB%93%E6%9E%9C.png"></p>
<p>将运行结果取回到本地：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 删除本地文件系统中的 output 目录及其所有内容(如果存在)</span></span><br><span class="line"><span class="built_in">rm</span> -r ./output</span><br><span class="line"></span><br><span class="line"><span class="comment"># 从 HDFS 上的 output 目录复制文件到本地文件系统的 output 目录</span></span><br><span class="line">hdfs dfs -get output ./output</span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示本地 output 目录中所有文件的内容</span></span><br><span class="line"><span class="built_in">cat</span> ./output/*</span><br></pre></td></tr></table></figure>

<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/HDFS%E7%BB%93%E6%9E%9C%E5%8F%96%E5%9B%9E%E5%88%B0%E6%9C%AC%E5%9C%B0.png"></p>
<p>Hadoop 运行程序时，输出目录不能存在，否则会提示错误，因此若要再次执行，需要执行如下命令删除 output 文件夹：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 删除 HDFS 上的 output 目录及其所有内容</span></span><br><span class="line">hdfs dfs -<span class="built_in">rm</span> -r output</span><br></pre></td></tr></table></figure>

<p>若要关闭 Hadoop，则运行：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">stop-dfs.sh</span><br></pre></td></tr></table></figure>

<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/%E5%85%B3%E9%97%ADHadoop.png"></p>
<p>注意：下次启动 Hadoop 时，无需进行 NameNode 的初始化，只需要运行 <code>start-dfs.sh</code> 就可以！</p>
<h2 id="2-6-启动-YARN"><a href="#2-6-启动-YARN" class="headerlink" title="2.6 启动 YARN"></a>2.6 启动 YARN</h2><p><strong>PS：伪分布式不启动 YARN 也可以，一般不会影响程序执行。</strong></p>
<p>YARN 是从 MapReduce 中分离出来的，负责资源管理与任务调度。YARN 运行于 MapReduce 之上，提供了高可用性、高扩展性，YARN 的更多介绍在此不展开，有兴趣的可查阅相关资料。</p>
<p>上述通过 <code>start-dfs.sh</code> 启动 Hadoop，仅仅是启动了 MapReduce 环境，我们可以启动 YARN ，让 YARN 来负责资源管理与任务调度。</p>
<p>1、修改 yarn-site.xml 文件，同样使用 gedit 编辑会比较方便些。( gedit 编辑器使用方法请参照上文 <strong>Hadoop 伪分布式配置</strong>)</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 改变当前工作目录到 /usr/local/hadoop-3.1.3</span></span><br><span class="line"><span class="built_in">cd</span> /usr/local/hadoop-3.1.3</span><br><span class="line"></span><br><span class="line"><span class="comment"># 打开 yarn-site.xml 文件</span></span><br><span class="line">gedit ./etc/hadoop/yarn-site.xml</span><br></pre></td></tr></table></figure>

<p>修改为如下配置：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.nodemanager.aux-services<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>mapreduce_shuffle<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.resourcemanager.hostname<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>localhost<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.nodemanager.vmem-check-enabled<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>false<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>2、修改 mapred-site.xml 文件，如果没有这个文件，需要从 mapred-site.xml.template 复制一份。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 打开 mapred-site.xml 文件</span></span><br><span class="line">gedit ./etc/hadoop/mapred-site.xml</span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>mapreduce.framework.name<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>yarn<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>3、启动YARN服务，(需要先执行过 <code>start-dfs.sh</code>)：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 启动YARN</span></span><br><span class="line">start-yarn.sh</span><br></pre></td></tr></table></figure>

<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/%E5%90%AF%E5%8A%A8YARN%E6%9C%8D%E5%8A%A1.png"></p>
<p>4、验证是否启动成功</p>
<p>方式一：执行 <code>jps</code> 命令查看 NodeManager 和 ResourceManager 服务是否已经启动：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/%E5%90%AF%E5%8A%A8YARN%E6%9C%8D%E5%8A%A1%E6%88%90%E5%8A%9F.png"></p>
<p>方式二：虚拟机浏览器输入 <a href="http://localhost:8088/">http://localhost:8088</a> 成功访问到 Web 界面。</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/CentOS%E6%9F%A5%E7%9C%8BYARN.png" style="zoom:50%;">

<p>但 YARN 主要是为集群提供更好的资源管理与任务调度，然而这在单机上体现不出价值，反而会使程序跑得稍慢些。因此在单机上是否开启 YARN 就看实际情况了。</p>
<blockquote>
<p>不启动 YARN 需重命名 mapred-site.xml</p>
</blockquote>
<p>如果不想启动 YARN，务必把配置文件 <strong>mapred-site.xml</strong> 重命名，改成 mapred-site.xml.template，需要用时改回来就行。否则在该配置文件存在，而未开启 YARN 的情况下，运行程序会提示 “Retrying connect to server: 0.0.0.0&#x2F;0.0.0.0:8032” 的错误。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 重命名</span></span><br><span class="line"><span class="built_in">mv</span> ./etc/hadoop/mapred-site.xml ./etc/hadoop/mapred-site.xml.template</span><br></pre></td></tr></table></figure>

<p>同样的，关闭 YARN 的脚本如下：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 关闭 YARN</span></span><br><span class="line">stop-yarn.sh</span><br></pre></td></tr></table></figure>

<p>至此，你已经掌握 Hadoop 的配置和基本使用了。</p>
<h2 id="2-7-Hadoop-集群配置"><a href="#2-7-Hadoop-集群配置" class="headerlink" title="2.7 Hadoop 集群配置"></a>2.7 Hadoop 集群配置</h2><p>伪分布式配置主要用于开发和测试环境，因为它将 NameNode 和 DataNode 放在同一台机器上，可能无法充分利用多节点的并行处理能力。在生产环境中，通常会使用完全分布式配置，以利用集群中多台机器的计算和存储能力。</p>
<p>配置安装集群化软件，首要条件就是要有多台Linux服务器可用。我们可以使用 VMware 提供的克隆功能，基于一台虚拟机去克隆创建多台虚拟机，所以这对电脑配置要求很高(至少有 <strong>8G</strong> 运行内存和 <strong>512G</strong> 存储容量)。但是由于我的电脑剩余存储空间容量有限……😭😭😭且在此实验案例教程后续还涉及很多软件的安装，所以我的电脑已经不再支持我配置安装集群化软件。但是如果你<del>对Hadoop 集群配置感兴趣</del>电脑运行内存和剩余存储容量足够大，不妨可以自己在网上找找教程动手试试。😄</p>
<h1 id="3-MySQL"><a href="#3-MySQL" class="headerlink" title="3. MySQL"></a>3. MySQL</h1><p>MySQL 是一个开源的关系型数据库管理系统，它使用结构化查询语言(SQL)进行数据库管理。MySQL 具有高可靠性、高性能、易用性和灵活性等特点，能够处理大量数据，并支持多种存储引擎以满足不同应用需求。它广泛应用于各类网站、应用及企业级系统中，是众多开发者和企业的首选数据库解决方案。通过 MySQL，用户可以轻松地创建、查询、更新和删除数据库中的数据，实现高效的数据管理。</p>
<h2 id="3-1-MySQL-下载与安装"><a href="#3-1-MySQL-下载与安装" class="headerlink" title="3.1 MySQL 下载与安装"></a>3.1 MySQL 下载与安装</h2><p>关于安装 MySQL的方式有很多这里只示例其中一种：<strong>使用 yum 安装。</strong></p>
<p>yum 安装方式自动处理依赖、简化安装过程、提供版本管理，并且易于管理和维护，适合大多数用户。完全可以满足本案例需求。</p>
<p>1、首先打开 <a href="https://dev.mysql.com/downloads/repo/yum/">MySQL Yum Repository</a> </p>
<p>打开后根据你服务器的配置选择，我服务器是 CentOS7 所以选择 <code>Red Hat Enterprise Linux 7 / Oracle Linux 7 (Architecture Independent), RPM Package</code> ，然后点击 <code>Download</code> 下载进入下载页面，进入页面后鼠标光标定位到 <code>No thanks, just start my download.</code> 右键点击 <code>复制链接</code> (<a href="https://dev.mysql.com/get/mysql80-community-release-el7-11.noarch.rpm)%E3%80%82">https://dev.mysql.com/get/mysql80-community-release-el7-11.noarch.rpm)。</a></p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/yum%E5%AE%89%E8%A3%85MySQL(1).png" style="zoom:50%;">

<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/yum%E5%AE%89%E8%A3%85MySQL(2).png" style="zoom: 50%;">

<p>2、安装前需要对系统进行检查：</p>
<p>RPM(Red-Hat Package Manager)是软件包管理器，是红帽 Linux 用于管理和安装软件的工具。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 如果当前系统已经安装过 Mysql 数据库安装将失败。CentOS 自带 mariadb，与 Mysql 数据库冲突。</span></span><br><span class="line"><span class="comment"># 检查是否安装了MySQL</span></span><br><span class="line">sudo rpm -qa | grep mysql</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查是否安装了mariadb</span></span><br><span class="line">sudo rpm -qa | grep mariadb</span><br><span class="line"></span><br><span class="line"><span class="comment">#如果有，将其卸载</span></span><br><span class="line">sudo rpm -e --nodeps &lt;软件包名&gt;</span><br></pre></td></tr></table></figure>

<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/MySQL%E5%AE%89%E8%A3%85%E5%89%8D%E6%A3%80%E6%9F%A5.png"></p>
<p>3、开始安装：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 更新密钥</span></span><br><span class="line">sudo rpm --import https://repo.mysql.com/RPM-GPG-KEY-mysql-2022</span><br><span class="line"></span><br><span class="line"><span class="comment">#安装 MySQL yum 库 链接是刚刚在Yum Repository复制的</span></span><br><span class="line">sudo rpm -Uvh https://dev.mysql.com/get/mysql80-community-release-el7-11.noarch.rpm</span><br></pre></td></tr></table></figure>

<p>4、选择要安装的 MySQL 版本：</p>
<p>添加完 yum 源之后，如果什么都不做直接安装的话，会默认安装最新的 MySQL 版本，也就是 mysql8.0 的最新发行版。大家可以自行进行选择。我这里选择的是 <code>mysql5.7</code> ，所以要改一下配置(<strong>想直接装最新版本的可以跳过这一步</strong>)：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 当前 mysql yum 源下哪些子源可用(不同的 mysql 版本使用不同的子仓库</span></span><br><span class="line">yum repolist all | grep mysql</span><br></pre></td></tr></table></figure>

<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/mysql%20yum%E6%BA%90.png" style="zoom:67%;">

<p>可以看到默认开启的是 mysql8.0 的仓库。</p>
<p>开启 5.7，禁用 8.0 有两种方法，一个是用命令修改 <code>/etc/yum.repos.d/mysql-community.repo</code> 文件。另一个是像下面这样使用命令直接修改这个文件。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 禁用名为 mysql80-community 的软件仓库</span></span><br><span class="line">sudo yum-config-manager --<span class="built_in">disable</span> mysql80-community</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启用名为 mysql57-community 的软件仓库</span></span><br><span class="line">sudo yum-config-manager --<span class="built_in">enable</span> mysql57-community</span><br></pre></td></tr></table></figure>

<p>然后再执行查看语句，可以看到 mysql 5.7 已经启用了，8.0 已经禁用了。</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/mysql%205.7%E5%90%AF%E7%94%A8.png" style="zoom:67%;">

<p>5、安装 MySQL</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># yum 安装 mysql-community-server 这个包</span></span><br><span class="line">sudo yum -y install mysql-community-server</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动 MySQL</span></span><br><span class="line">sudo systemctl start mysqld   </span><br><span class="line"><span class="comment"># 设置开机启动(可不设置)</span></span><br><span class="line">sudo systemctl <span class="built_in">enable</span> mysqld</span><br><span class="line"></span><br><span class="line"><span class="comment">#检查 MySQL 服务状态</span></span><br><span class="line">systemctl status mysqld</span><br></pre></td></tr></table></figure>

<p>出现 <code>Active：active(running)</code> 代表 MySQL 启动成功。</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/MySQL%E5%90%AF%E5%8A%A8%E6%88%90%E5%8A%9F.png"></p>
<p>6、登录 MySQL</p>
<p>查看默认密码：第一次启动 MySQL 会在日志文件 <code>/var/log/mysqld.log</code> 中生成 root 用户的一个随机密码。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看密码</span></span><br><span class="line">sudo <span class="built_in">cat</span> /var/log/mysqld.log | grep password</span><br></pre></td></tr></table></figure>

<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/MySQL%E9%BB%98%E8%AE%A4%E5%AF%86%E7%A0%81.png"></p>
<p><strong>PS：没有前面的空格，比如我密码的是 <code>fcIVZvOBk9)r</code> 。</strong></p>
<p>然后执行命令登录 MySQL 数据库服务器，会提示输入密码，输入密码时密码不会显示，输入完直接 <code>Enter</code> 就行。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 登录到 MySQL 数据库服务器</span><br><span class="line">mysql -uroot -p</span><br></pre></td></tr></table></figure>

<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/%E7%99%BB%E5%BD%95MySQL.png"></p>
<p>登录到 MySQL 后可以执行以下 SQL 语句查看数据库，与下面一致说明安装成功。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 列出服务器上的所有数据库</span><br><span class="line">show databases;</span><br></pre></td></tr></table></figure>

<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/%E6%9F%A5%E7%9C%8BMySQL%E6%95%B0%E6%8D%AE%E5%BA%93.png"></p>
<p>退出MySQL：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">exit	# 或者快捷键 Ctrl + d</span><br></pre></td></tr></table></figure>

<h2 id="3-2-关于-MySQL-的补充"><a href="#3-2-关于-MySQL-的补充" class="headerlink" title="3.2 关于 MySQL 的补充"></a>3.2 关于 MySQL 的补充</h2><h3 id="3-2-1-修改-root-用户密码"><a href="#3-2-1-修改-root-用户密码" class="headerlink" title="3.2.1 修改 root 用户密码"></a>3.2.1 修改 root 用户密码</h3><p>如果你觉得 MySQL 自动生成的密码太难记忆的话，可以连接 MySQL 之后进行修改密码。在 Linux 上安装 MySQL 时会自动安装一个校验密码的插件，默认密码检查策略要求密码必须包含：大小写字母、数字和特殊符号，并且长度不能少于8位。修改密码时新密码是否符合当前的策略，不满足则会提示ERROR。</p>
<p>如果你想设置简单密码，需要降低 MySQL 的密码安全级别。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#设置密码安全级别低</span><br><span class="line">set global validate_password_policy = 0;</span><br><span class="line">#密码长度最低4位即可</span><br><span class="line">set global validate_password_length = 4;</span><br><span class="line"></span><br><span class="line">#设置简单密码(这里使用简单密码是为了方便，真实环境中不要这样)</span><br><span class="line">ALTER USER &#x27;root &#x27;@&#x27;locaLhost&#x27; IDENTIFIED BY &#x27;root&#x27;;	#前面的 root 为用户名，后面的 root 是密码</span><br></pre></td></tr></table></figure>

<p><font color="red">PS：若在执行 <code>set global validate_password_policy = 0;</code> 时提示 <code>You must reset your password using ALTER USER statement before executing this statement.</code> 你可以<strong>先</strong>设置一个满足默认策略的密码如：<code>@Root123456</code> ，替换掉默认生成的密码，之后<strong>再</strong>进行密码安全级别的降低，就可以成功了。</font></p>
<p><font color="red"><strong>另外：因 mysql 的版本不同调整密码策略的方法也不同，关于更多的密码检查策略请参考<a href="https://dev.mysql.com/doc/refman/8.3/en/">官方文档</a>。</strong></font></p>
<p>在文档中先选择对应版本再搜索：<code>validate_password</code></p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/%E5%AF%86%E7%A0%81%E6%A0%A1%E9%AA%8C%E8%A7%84%E5%88%99(1).png" style="zoom: 50%;">

<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/%E5%AF%86%E7%A0%81%E6%A0%A1%E9%AA%8C%E8%A7%84%E5%88%99(2).png" style="zoom: 50%;">

<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/%E5%AF%86%E7%A0%81%E6%A0%A1%E9%AA%8C%E8%A7%84%E5%88%99(3).png" style="zoom: 50%;">

<p>上面这个就是密码检查策略了。</p>
<h3 id="3-2-2-创建用户与权限分配"><a href="#3-2-2-创建用户与权限分配" class="headerlink" title="3.2.2 创建用户与权限分配"></a>3.2.2 创建用户与权限分配</h3><p>默认的 root 用户只能当前节点 localhost 访问，是无法远程访问的。</p>
<p>我们还需要创建一个新的账户，用于远程访问，或者直接给 root 用户添加权限。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 授予来自任何主机的 root 用户对所有数据库和所有表的所有权限，并允许其将这些权限授予其他用户。</span><br><span class="line">grant all privileges on *.* to &#x27;root&#x27;@&#x27;%&#x27; with grant option;</span><br><span class="line"></span><br><span class="line"># 刷新 MySQL 的权限，使新设置的权限立即生效</span><br><span class="line">flush privileges;</span><br></pre></td></tr></table></figure>

<p>授权后就可以使用在本机使用图形化工具远程访问虚拟机的 MySQL 。(这里使用的是 <code>Navicat</code> )</p>
<p>首先检查防火墙状态，关闭防火墙：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看防火墙状态</span></span><br><span class="line">systemctl status firewalld</span><br><span class="line"></span><br><span class="line"><span class="comment"># 开启防火墙 </span></span><br><span class="line">sudo systemctl start firewalld</span><br><span class="line"></span><br><span class="line"><span class="comment"># 关闭防火墙 </span></span><br><span class="line">sudo systemctl stop firewalld</span><br></pre></td></tr></table></figure>

<p>打开 Navicat 进行操作：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/%E8%BF%9C%E7%A8%8B%E8%AE%BF%E9%97%AE%E8%99%9A%E6%8B%9F%E6%9C%BAMySQL(1).png" style="zoom: 50%;">

<p>在 Navicat 上看到的数据库与虚拟机一致，远程连接成功。</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/%E8%BF%9C%E7%A8%8B%E8%AE%BF%E9%97%AE%E8%99%9A%E6%8B%9F%E6%9C%BAMySQL(2).png" style="zoom:50%;">

<h1 id="4-HBase"><a href="#4-HBase" class="headerlink" title="4. HBase"></a>4. HBase</h1><p>HBase 是一个分布式、面向列的开源数据库，基于 Hadoop 构建，以 BigTable 为设计蓝本，具有高可靠性、高扩展性和高性能，适用于存储和处理海量非结构化及半结构化数据，广泛应用于大数据场景下的数据存储和实时分析。</p>
<p>开启 HBase 需要先开启 Hadoop，而关闭 Hadoop 必须先关闭 HBase，所以总的流程顺序就是：</p>
<p><font color="red"><strong>开启 Hadoop –&gt; 开启 HBase –&gt; 关闭 HBase –&gt; 关闭 Hadoop</strong></font>😀</p>
<p><font color="red">请一定严格按照顺序进行，否则可能会出现错误，如果不确定是否有开启其中的某个服务，可以使用 <code>jps</code> 命令进行查看进程 <code>id</code>。</font></p>
<h2 id="4-1-HBase-下载与安装"><a href="#4-1-HBase-下载与安装" class="headerlink" title="4.1 HBase 下载与安装"></a>4.1 HBase 下载与安装</h2><p><a href="https://archive.apache.org/dist/hbase/">官网下载</a></p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/HBase%E4%B8%8B%E8%BD%BD(1).png"></p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/HBase%E4%B8%8B%E8%BD%BD(2).png" style="zoom: 67%;">

<p>打不开官网？试试<a href="https://mirrors.tuna.tsinghua.edu.cn/apache/hbase/">清华大学开源软件镜像站下载</a>。不过好像只有新版🤔</p>
<p>下载好之后就可以开始安装了：</p>
<p>1、执行以下命令，选择文件上传到 Linux 的 &#x2F; 目录(具体请参考上文 <strong>FinalShell 文件上传</strong>)</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> /</span><br><span class="line"></span><br><span class="line">sudo rz</span><br></pre></td></tr></table></figure>

<p>2、解压缩 Hadoop 安装文件到  &#x2F;usr&#x2F;local 目录，解压完成后可以进入到 &#x2F;usr&#x2F;local 目录查看是否成功。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 解压缩安装文件到 /usr/local 目录</span></span><br><span class="line">sudo tar -zxvf hbase-2.2.2-bin.tar.gz -C /usr/local</span><br><span class="line"></span><br><span class="line"><span class="comment"># 进入到 /usr/local 目录</span></span><br><span class="line"><span class="built_in">cd</span> /usr/local</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看文件</span></span><br><span class="line">ll</span><br></pre></td></tr></table></figure>

<p>3、配置环境变量，使用 vim 编辑器修改 &#x2F;etc&#x2F;profile 文件，在文件最后添加环境变量。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 修改 /etc/profile 文件</span></span><br><span class="line">sudo vim /etc/profile</span><br><span class="line"></span><br><span class="line"><span class="comment"># HBase 环境变量</span></span><br><span class="line"><span class="built_in">export</span> HBASE_HOME=/usr/local/hbase-2.2.2</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:<span class="variable">$HBASE_HOME</span>/bin</span><br></pre></td></tr></table></figure>

<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/%E9%85%8D%E7%BD%AEHBase%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F.png" style="zoom: 67%;">

<p>4、重启环境变量配置</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">source</span> /etc/profile</span><br></pre></td></tr></table></figure>

<p>5、添加 HBase 权限</p>
<p>输入下面命令，把 hbase 目录权限赋予给 muyoukule 用户：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 进入 /usr/local 目录</span></span><br><span class="line"><span class="built_in">cd</span> /usr/local</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将 hbase-2.2.2 下的所有文件的所有者改为 muyoukule，muyoukule 是当前用户的用户名</span></span><br><span class="line">sudo <span class="built_in">chown</span> -R muyoukule ./hbase-2.2.2</span><br></pre></td></tr></table></figure>

<p>6、检查安装结果，出现下面信息代表安装成功</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看 hbase 版本信息</span></span><br><span class="line">hbase version</span><br></pre></td></tr></table></figure>

<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/%E6%A3%80%E6%9F%A5HBase%E5%AE%89%E8%A3%85%E7%BB%93%E6%9E%9C.png"></p>
<p>假如出现 <code>找不到或无法加载主类 org.apache.hadoop.hbase.util.GetJavaProperty</code> 的错误，解决方法：</p>
<p>修改 &#x2F;usr&#x2F;local&#x2F;hbase&#x2F;conf&#x2F;hbase-env.sh 配置文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vim /usr/local/hbase-2.2.2/conf/hbase-env.sh</span><br></pre></td></tr></table></figure>

<p>到配置文件底部，将 <code># export HBASE_DISABLE_HADOOP_CLASSPATH_LOOKUP=&quot;true&quot;</code>  前的注释( <code>#</code> 号)删除即可，删除后保存并退出即可。</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/hbase-env.sh.png" style="zoom: 67%;">

<p>这样，HBase 就安装好了。</p>
<h2 id="4-2-HBase-单机模式配置"><a href="#4-2-HBase-单机模式配置" class="headerlink" title="4.2 HBase 单机模式配置"></a>4.2 HBase 单机模式配置</h2><p>HBase单机模式配置时涉及的两个主要配置文件是 <code>hbase-env.sh</code> 和 <code>hbase-site.xml</code> 。这两个文件分别用于设置 HBase 的运行环境和定义 HBase 的核心配置参数。</p>
<p><strong>hbase-env.sh</strong></p>
<p><code>hbase-env.sh</code> 是一个 shell 脚本文件，它包含了 HBase 启动和运行所需的环境变量设置。在单机模式下配置 HBase 时，需要检查并可能修改以下几个关键的配置项：</p>
<ul>
<li><code>JAVA_HOME</code>：这个变量需要指向你安装的 JDK 的目录。确保 HBase 可以找到并使用正确的 Java 版本。</li>
<li><code>HBASE_MANAGES_ZK</code>：这个变量控制 HBase 是否应该管理其自己的 ZooKeeper 实例。在单机模式下，通常将其设置为 <code>true</code>，这样 HBase 就会启动它自己的 ZooKeeper 实例。</li>
<li>其他环境变量：根据具体的系统配置和需求，可能还需要设置其他环境变量。</li>
</ul>
<p><strong>hbase-site.xml</strong></p>
<p><code>hbase-site.xml</code>是 HBase 的核心配置文件，其中包含了 HBase 集群的各种参数设置。在单机模式下配置 HBase 时，你需要修改或添加以下关键配置项：</p>
<ul>
<li><code>hbase.rootdir</code>：这个参数定义了 HBase 数据的存储位置。在单机模式下，通常将其设置为本地文件系统的某个路径，例如<code>file:///tmp/hbase</code>。这意味着所有的 HBase 数据都将存储在这个指定的本地目录中。</li>
<li><code>hbase.zookeeper.property.dataDir</code>：这个参数指定了 ZooKeeper 使用的数据目录。由于在单机模式下 HBase 通常会管理自己的 ZooKeeper 实例，因此需要设置这个参数来指定 ZooKeeper 数据的存储位置。</li>
<li><code>hbase.cluster.distributed</code>：这个参数控制 HBase 是否以分布式模式运行。在单机模式下，通常将其设置为<code>false</code>。</li>
</ul>
<p>需要注意的是，对于配置文件的修改，需要手动重启相应的 HBase 服务。更改配置文件后，请运行 <code>stop-hbase.sh</code> 以停止 HBase 服务，配置完成后再运行<code>start-hbase.sh</code> 以启动服务。</p>
<blockquote>
<p>配置 hbase-env.sh</p>
</blockquote>
<p>在启动HBase前，需设置  JAVA_HOME 环境变量。为方便用户，HBase 允许在 <code>conf/hbase-env.sh</code> 文件中直接设置。用户需找到 Java 安装位置后编辑 <code>conf/hbase-env.sh</code>，取消对 <code>#export JAVA_HOME=</code> 行的注释，并设置为 Java 安装路径。</p>
<p>先查找 Java 安装位置(如果你知道可以忽略)</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查找 Java 安装位置</span></span><br><span class="line">whereis java</span><br></pre></td></tr></table></figure>

<p>这里我们找到了不止一个路径，我们需要自行进行判断，我的是 <code>/usr/local/jdk1.8.0_162</code></p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/%E6%9F%A5%E6%89%BEJava%E5%AE%89%E8%A3%85%E4%BD%8D%E7%BD%AE.png"></p>
<p>1、使用 vim 编辑器打开 hbase-env.sh 文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vim /usr/local/hbase-2.2.2/conf/hbase-env.sh</span><br></pre></td></tr></table></figure>

<p>2、配置 Java 的环境变量</p>
<p>具体作用是告诉 HBase 使用哪一个 jdk，我这里 Java 的安装目录是 <code>/usr/local/jdk1.8.0_162</code>，还需要配置令 ZooKeeper 由 HBase 自己管理，不需要单独的 ZooKeeper，具体需要添加的内容如下：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 配置 Java 的环境变量</span></span><br><span class="line"><span class="built_in">export</span> JAVA_HOME=/usr/local/jdk1.8.0_162</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置 ZooKeeper 的管理者</span></span><br><span class="line"><span class="built_in">export</span> HBASE_MANAGES_ZK=<span class="literal">true</span> </span><br></pre></td></tr></table></figure>

<p>因为在 <code>hbase-env.sh</code> 文件中已经存在有 <code>JAVA_HOME</code>、<code>HBASE_MANAGES_ZK</code> 这两个变量，但只是被注释掉了，也就是前面带了 <code>#</code> 号，所以大家可以直接寻找到对应的变量，将前面起注释作用的 <code>#</code> 号删去，然后修改后面的值即可。</p>
<p><strong>PS：vim 编辑器怎样搜索字符串？</strong></p>
<ul>
<li>普通模式下，按下 <code>/</code> 键，然后输入你想要搜索的字符串，按下 <code>Enter</code> 键开始搜索。</li>
<li>要查找下一个匹配的字符串，按 <code>n</code>。</li>
<li>要查找上一个匹配的字符串，按 <code>N</code>。</li>
</ul>
<p>但是我很懒不想去找🙄，所以我就直接写在文件顶部了，这个是不影响运行操作的，具体图示如下：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/%E9%85%8D%E7%BD%AEhbase-env.sh.png" style="zoom:67%;">

<blockquote>
<p>配置 hbase-site.xml</p>
</blockquote>
<p>这里我们需要修改文件中的 <code>hbase.rootdir</code> 、<code>hbase.unsafe.stream.capability.enforce</code> 两个参数：</p>
<p><code>hbase.rootdir</code> 是 HBase 配置中的一个关键参数，用于指定 HBase 数据和元数据的根存储目录。该目录是 HBase 用来存放所有表数据、索引、日志文件以及其他相关信息的核心位置。通过正确配置 <code>hbase.rootdir</code>，可以确保 HBase 数据被存储在一个持久化、可靠且可扩展的存储系统中，从而保障 HBase 的稳定运行和数据的安全性。这里我们给它设置为 HBase 安装目录下的 <code>hbase-tmp</code> 文件夹，对于我的安装目录来说，具体路径在 <code>/usr/local/hbase-2.2.2/hbase-tmp</code>，大家可以根据自己的安装目录进行一定的调整。</p>
<p><code>hbase.unsafe.stream.capability.enforce</code>：这个配置项用于启用或禁用 <code>TFramedTransport</code>或者<code>TLowDelayTransport</code>的帧大小检查，在默认情况下会启用帧大小检查，用于保证网络连接和数据传输的稳定性，也就是把他的值设置为 <code>true</code>，因为我们现在是伪分布模式，所以不需要保证稳定性，可以选择禁用帧大小检查，从而提升数据传输性能，就是将它的值设置为 <code>flase</code>。当然，也可以不管这个配置项，主要是看个人需求。</p>
<p>1、使用 <code>gedit</code> 编辑器修改其文件内容，具体命令如下</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">gedit /usr/local/hbase-2.2.2/conf/hbase-site.xml</span><br></pre></td></tr></table></figure>

<p>将当中的</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>修改为下面配置：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 配置 HBase 数据根目录为本地文件系统中的 hbase-tmp 目录 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.rootdir<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>file:///usr/local/hbase-2.2.2/hbase-tmp<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.unsafe.stream.capability.enforce<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>false<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>2、测试运行</p>
<p>启动 HBase，并且打开 <code>shell</code> 命令行模式，成功打开后，用户就可以通过输入 <code>shell</code> 命令来使用操作 HBase 数据库了。具体命令如下：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 启动 HBase</span></span><br><span class="line">start-hbase.sh</span><br><span class="line"></span><br><span class="line"><span class="comment">#打开 shell 命令行模式</span></span><br><span class="line">hbase shell </span><br></pre></td></tr></table></figure>

<p>出现下面图示的样子，就说明 <code>shell</code> 命令行被成功打开了，可以看到，还有 <code>hbase(main)</code> 的字样：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/shell%E5%91%BD%E4%BB%A4%E6%88%90%E5%8A%9F%E6%89%93%E5%BC%80.png"></p>
<p>输入 <code>help</code>，可以获取帮助信息，帮助你更好的熟悉使用方法，还可以看见当前 HBase 的版本，如下图所示：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/HBase-help.png"></p>
<p>3、输入 <code>exit</code>或者 <code>Ctrl + d</code> 就可以退出该模式，返回终端控制台。</p>
<p>4、停止 HBase 运行，在终端输入下面命令：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 停止 HBase 运行</span></span><br><span class="line">stop-hbase.sh</span><br></pre></td></tr></table></figure>

<p><strong>PS：如果在操作 HBase 的过程中发生错误，可以通过 {HBASE_HOME}目录(&#x2F;usr&#x2F;local&#x2F;hbase-2.2.2)下的 logs 子目录中的日志文件查看错误原因。</strong></p>
<h2 id="4-3-HBase-伪分布式模式配置"><a href="#4-3-HBase-伪分布式模式配置" class="headerlink" title="4.3 HBase 伪分布式模式配置"></a>4.3 HBase 伪分布式模式配置</h2><p>HBase伪分布式模式配置时涉及的两个主要配置文件是 <code>hbase-env.sh</code> 和 <code>hbase-site.xml</code> 。这两个文件分别用于设置 HBase 的运行环境和定义 HBase 的核心配置参数。</p>
<p><strong>hbase-env.sh</strong></p>
<p><code>hbase-env.sh</code> 是一个 shell 脚本文件，它包含了 HBase 启动和运行所需的环境变量设置。在单机模式下配置 HBase 时，需要检查并可能修改以下几个关键的配置项：</p>
<ul>
<li><code>JAVA_HOME</code>：这个变量需要指向你安装的 JDK 的目录。确保 HBase 可以找到并使用正确的 Java 版本。</li>
<li><code>HBASE_MANAGES_ZK</code>：这个变量控制 HBase 是否应该管理其自己的 ZooKeeper 实例。在单机模式下，通常将其设置为<code>true</code>，这样 HBase 就会启动它自己的 ZooKeeper 实例。</li>
<li>其他环境变量：根据具体的系统配置和需求，可能还需要设置其他环境变量。</li>
</ul>
<p><strong>hbase-site.xml</strong></p>
<p><code>hbase-site.xml</code>是 HBase 的核心配置文件，其中包含了 HBase 集群的各种参数设置。在单机模式下配置 HBase 时，你需要修改或添加以下关键配置项：</p>
<ul>
<li><code>hbase.rootdir</code>：这个参数定义了 HBase 数据的存储位置。在单机模式下，通常将其设置为本地文件系统的某个路径，例如<code>file:///tmp/hbase</code>。这意味着所有的 HBase 数据都将存储在这个指定的本地目录中。</li>
<li><code>hbase.zookeeper.property.dataDir</code>：这个参数指定了 ZooKeeper 使用的数据目录。由于在单机模式下 HBase 通常会管理自己的 ZooKeeper 实例，因此需要设置这个参数来指定 ZooKeeper 数据的存储位置。</li>
<li><code>hbase.cluster.distributed</code>：这个参数控制 HBase 是否以分布式模式运行。在单机模式下，通常将其设置为<code>false</code>。</li>
</ul>
<p>需要注意的是，对于配置文件的修改，需要手动重启相应的 HBase 服务。更改配置文件后，请运行 <code>stop-hbase.sh</code> 以停止 HBase 服务，配置完成后再运行<code>start-hbase.sh</code> 以启动服务。</p>
<blockquote>
<p>配置 hbase-env.sh</p>
</blockquote>
<p>在启动HBase前，需设置  JAVA_HOME 环境变量。为方便用户，HBase 允许在 <code>conf/hbase-env.sh</code> 文件中直接设置。用户需找到 Java 安装位置后编辑 <code>conf/hbase-env.sh</code>，取消对 <code>#export JAVA_HOME=</code> 行的注释，并设置为Java安装路径。</p>
<p>先查找 Java 安装位置(如果你知道可以忽略)</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查找 Java 安装位置</span></span><br><span class="line">whereis java</span><br></pre></td></tr></table></figure>

<p>这里我们找到了不止一个路径，我们需要自行进行判断，我的是 <code>/usr/local/jdk1.8.0_162</code></p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/%E6%9F%A5%E6%89%BEJava%E5%AE%89%E8%A3%85%E4%BD%8D%E7%BD%AE.png"></p>
<p>1、使用 vim 编辑器打开 hbase-env.sh 文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vim /usr/local/hbase-2.2.2/conf/hbase-env.sh</span><br></pre></td></tr></table></figure>

<p>2、配置 <code>JAVA_HOME</code>，具体作用是告诉 HBase 使用哪一个 jdk，我这里 Java 的安装目录是 <code>/usr/local/jdk1.8.0_162</code>；<code>HBASE_MANAGES_ZK</code> 配置令 ZooKeeper 由 HBase 自己管理，不需要单独的 ZooKeeper。<code>HBASE_CLASSPATH</code> 变量可用于确定运行自定义 HBase 操作所需的其他 JAR 文件和目录的优先级。最后是具体需要添加的内容如下：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 配置 Java 的环境变量</span></span><br><span class="line"><span class="built_in">export</span> JAVA_HOME=/usr/local/jdk1.8.0_162</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置 ZooKeeper 的管理者</span></span><br><span class="line"><span class="built_in">export</span> HBASE_MANAGES_ZK=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置为本机 HBase 安装目录下的 conf 目录</span></span><br><span class="line"><span class="built_in">export</span> HBASE_CLASSPATH=/usr/local/hbase-2.2.2/conf</span><br></pre></td></tr></table></figure>

<p>因为在 <code>hbase-env.sh</code> 文件中已经存在有 <code>JAVA_HOME</code>、<code>HBASE_MANAGES_ZK</code>、<code>HBASE_CLASSPATH</code> 这三个变量，只是被注释掉了，也就是前面带了 <code>#</code> 号，所以大家可以直接寻找到对应的变量，将前面起注释作用的 <code>#</code> 号删去，然后修改后面的值即可。</p>
<p><strong>PS：vim 编辑器怎样搜索字符串？</strong></p>
<ul>
<li>普通模式下，按下 <code>/</code> 键，然后输入你想要搜索的字符串，按下 <code>Enter</code> 键开始搜索。</li>
<li>要查找下一个匹配的字符串，按 <code>n</code>。</li>
<li>要查找上一个匹配的字符串，按 <code>N</code>。</li>
</ul>
<p>但是我很懒不想去找🙄，所以我就直接写在文件顶部了，这个是不影响运行操作的，具体图示如下：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/%E4%BC%AA%E5%88%86%E5%B8%83%E5%BC%8F%E9%85%8D%E7%BD%AEhbase-env.sh.png"></p>
<blockquote>
<p>配置 hbase-site.xml</p>
</blockquote>
<p>这里我们需要修改文件中的 <code>hbase.rootdir</code>、<code>hbase.cluster.distributed</code>、<code>hbase.unsafe.stream.capability.enforce</code> 三个参数。</p>
<p><code>hbase.rootdir</code>：举个例子，如果要指定 HDFS 实例的 Namenode 在 <code>nameenode.example.org</code> 上运行的 HDFS 目录 <code>/hbase-2.2.2</code>，端口为 <code>9000</code>，则需要将此值设置为：<code>hdfs://namenode.example.org:9000/hbase-2.2.2</code>，因为我们做的是伪分布，所以这里我们就将它设置在本机的 <code>9000</code> 端口号上。</p>
<p><code>hbase.cluster.distributed</code>：这个参数用于设置群集将处于的模式。对于分布式模式，值设置为 <code>true</code>，因为我们做的是伪分布模式，所以我们将其值设置为 <code>true</code>。</p>
<p><code>hbase.unsafe.stream.capability.enforce</code>：这个配置项用于启用或禁用 <code>TFramedTransport</code>或者<code>TLowDelayTransport</code>的帧大小检查，在默认情况下会启用帧大小检查，用于保证网络连接和数据传输的稳定性，也就是把他的值设置为 <code>true</code>，因为我们现在是伪分布模式，所以不需要保证稳定性，可以选择禁用帧大小检查，从而提升数据传输性能，就是将它的值设置为 <code>flase</code>，另外，此属性可能会减少故障切换选项，所以在启用的时候需要谨慎，所以我们这里禁用它也有这一层原因。</p>
<p>1、使用 <code>gedit</code> 编辑器修改其文件内容，具体命令如下</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">gedit /usr/local/hbase-2.2.2/conf/hbase-site.xml</span><br></pre></td></tr></table></figure>

<p>将当中的</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>修改为下面配置：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.rootdir<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>hdfs://localhost:9000/hbase-2.2.2<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.cluster.distributed<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>true<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.unsafe.stream.capability.enforce<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>false<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>2、接下来测试运行 HBase</p>
<p>第一步：首先登陆 ssh，之前设置了无密码登陆，因此这里不需要密码；再启动 Hadoop(如果已经启动 Hadoop请跳过此步骤)，</p>
<p>命令如下：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 登陆 ssh</span></span><br><span class="line">ssh localhost</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动 Hadoop</span></span><br><span class="line">start-dfs.sh</span><br></pre></td></tr></table></figure>

<p>输入命令 <code>jps</code>，能看到 NameNode,DataNode 和 SecondaryNameNode 都已经成功启动，表示 hadoop 启动成功：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/hbase%E4%BC%AA%E5%88%86%E5%B8%83%E5%BC%8F%E5%90%AF%E5%8A%A8%E6%88%90%E5%8A%9F.png"></p>
<p>第二步：再启动 HBase 命令如下：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 启动 HBase </span></span><br><span class="line">start-hbase.sh</span><br></pre></td></tr></table></figure>

<p>启动成功，输入 <code>jps</code> 后就可以看见有 <code>HQuorumPeer</code>、<code>HRegionServer</code>、<code>HMaster</code>，说明都已经成功启动。</p>
<ul>
<li><strong>HQuorumPeer</strong>：ZooKeeper 中的同步和选主线程，确保集群节点同步并处理领导选举。</li>
<li><strong>HRegionServer</strong>：HBase 中负责处理用户 I&#x2F;O 请求、管理HRegion和存储数据的节点。</li>
<li><strong>HMaster</strong>：HBase 集群的主服务器，监控 RegionServer、管理元数据更改和负责表的增删改查操作。</li>
</ul>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/hbase%E5%90%AF%E5%8A%A8%E6%88%90%E5%8A%9F.png"></p>
<p>第三步：进入 shell 界面：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">hbase shell</span><br></pre></td></tr></table></figure>

<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/hbase%E4%BC%AA%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9Fshell%E5%91%BD%E4%BB%A4%E6%88%90%E5%8A%9F%E6%89%93%E5%BC%80.png"></p>
<p>输入 <code>exit</code>或者 <code>Ctrl + d</code> 就可以退出该模式，返回终端控制台。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">exit   # 或者 Ctrl + d</span><br></pre></td></tr></table></figure>

<p>3、停止 HBase 运行，在终端输入下面命令：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 停止 HBase 运行</span></span><br><span class="line">stop-hbase.sh</span><br></pre></td></tr></table></figure>

<p><strong>PS：如果在操作HBase的过程中发生错误，可以通过{HBASE_HOME}目录(&#x2F;usr&#x2F;local&#x2F;hbase-2.2.2)下的logs子目录中的日志文件查看错误原因。</strong></p>
<h2 id="4-4-编程实践"><a href="#4-4-编程实践" class="headerlink" title="4.4 编程实践"></a>4.4 编程实践</h2><h3 id="4-4-1-利用Shell命令"><a href="#4-4-1-利用Shell命令" class="headerlink" title="4.4.1 利用Shell命令"></a>4.4.1 利用Shell命令</h3><p>先启动 Hadoop 再启动 HBase ，再输入 <code>jps</code> 进行查看。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 启动 Hadoop 分布式文件系统(HDFS)的守护进程</span></span><br><span class="line">start-dfs.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动 HBase 的所有必要守护进程</span></span><br><span class="line">start-hbase.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 验证是否已经成功启动了相应的守护进程</span></span><br><span class="line">jps</span><br></pre></td></tr></table></figure>

<p>出现以下信息说明启动成功：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">HMaster</span><br><span class="line">DataNode</span><br><span class="line">Jps</span><br><span class="line">SecondaryNameNode</span><br><span class="line">HRegionServer</span><br><span class="line">HQuorumPeer</span><br><span class="line">NameNode</span><br></pre></td></tr></table></figure>

<p>然后进入 shell 界面</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">hbase shell</span><br></pre></td></tr></table></figure>

<blockquote>
<p>HBase中创建表</p>
</blockquote>
<p>HBase 中用 <code>create</code> 命令创建表，具体如下：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">create &#x27;student&#x27;,&#x27;Sname&#x27;,&#x27;Ssex&#x27;,&#x27;Sage&#x27;,&#x27;Sdept&#x27;,&#x27;course&#x27;</span><br></pre></td></tr></table></figure>

<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/HBase%E7%94%A8create%E5%91%BD%E4%BB%A4%E5%88%9B%E5%BB%BA%E8%A1%A8.png"></p>
<p>此时，即创建了一个 student 表，属性有：Sname，Ssex，Sage，Sdept，course。因为 HBase 的表中会有一个系统默认的属性作为行键，无需自行创建，默认为 <code>put</code> 命令操作中表名后第一个数据。创建完 student 表后，可通过 <code>describe</code> 命令查看 student 表的基本信息。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看 “student” 表的基本信息</span></span><br><span class="line">describe &#x27;student&#x27;</span><br></pre></td></tr></table></figure>

<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/student%E8%A1%A8%E5%9F%BA%E6%9C%AC%E4%BF%A1%E6%81%AF.png" style="zoom:67%;">

<blockquote>
<p>HBase数据库基本操作</p>
</blockquote>
<p>本小节主要介绍 HBase 的增、删、改、查操作。在添加数据时，HBase 会自动为添加的数据添加一个时间戳，故在需要修改数据时，只需直接添加数据，HBase 即会生成一个新的版本，从而完成 “改” 操作，旧的版本依旧保留，系统会定时回收垃圾数据，只留下最新的几个版本，保存的版本数可以在创建表的时候指定。</p>
<p><strong>添加数据</strong></p>
<p>HBase 中用 <code>put</code> 命令添加数据。</p>
<p><font color="red">PS：一次只能为一个表的一行数据的一个列，也就是一个单元格添加一个数据，所以直接用 shell 命令插入数据效率很低，在实际应用中，一般都是利用编程操作数据。</font></p>
<p>向 student 表中添加数据：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">为 student 表添加了学号为 95001，名字为 LiYing 的一行数据，其行键为 95001</span></span><br><span class="line">put &#x27;student&#x27;,&#x27;95001&#x27;,&#x27;Sname&#x27;,&#x27;LiYing&#x27;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">为 95001 行下的 course:math 列添加一个数据</span></span><br><span class="line">put &#x27;student&#x27;,&#x27;95001&#x27;,&#x27;course:math&#x27;,&#x27;80&#x27;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">为 95001 行下的 Ssex 列添加一个数据</span></span><br><span class="line">put &#x27;student&#x27;,&#x27;95001&#x27;,&#x27;Ssex&#x27;,&#x27;Male&#x27;</span><br></pre></td></tr></table></figure>

<p>每条命令执行后如添加成功，均返回以下内容：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Took 0.0548 seconds</span><br></pre></td></tr></table></figure>

<p>添加后执行使用如下命令可以看到刚才添加的 3 条数据：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">检索 student 表中键为 95001 的行的所有数据</span></span><br><span class="line">get &#x27;student&#x27;,&#x27;95001&#x27;</span><br></pre></td></tr></table></figure>

<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/%E6%B7%BB%E5%8A%A0%E7%9A%843%E6%9D%A1%E6%95%B0%E6%8D%AE.png"></p>
<p><strong>查看数据</strong></p>
<p>HBase 中有两个用于查看数据的命令：</p>
<ul>
<li><code>get</code> 命令，用于查看表的某一行数据。</li>
<li><code>scan</code> 命令用于查看某个表的全部数据。</li>
</ul>
<p><code>get</code> 命令</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 检索 student 表中键为 95001 的行的所有数据</span></span><br><span class="line">get <span class="string">&#x27;student&#x27;</span>,<span class="string">&#x27;95001&#x27;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/%E6%B7%BB%E5%8A%A0%E7%9A%843%E6%9D%A1%E6%95%B0%E6%8D%AE.png"></p>
<p><code>scan</code> 命令</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">检索 student 表中所有数据</span></span><br><span class="line">scan &#x27;student&#x27;</span><br></pre></td></tr></table></figure>

<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/%E6%A3%80%E7%B4%A2student%E8%A1%A8%E4%B8%AD%E6%89%80%E6%9C%89%E6%95%B0%E6%8D%AE.png"></p>
<p><strong>删除数据</strong></p>
<p>在 HBase中 用 <code>delete</code> 以及 <code>deleteall</code> 命令进行删除数据操作，它们的区别是：</p>
<ul>
<li><code>delete</code> 用于删除一个数据，是 <code>put</code> 的反向操作；</li>
<li><code>deleteall</code> 操作用于删除一行数据。</li>
</ul>
<p><code>delete</code> 命令</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除 student 表中行键为 95001 的行的 Ssex 列的数据。</span></span><br><span class="line">delete &#x27;student&#x27;,&#x27;95001&#x27;,&#x27;Ssex&#x27;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Took 0.0091 seconds</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">检索 student 表中键为 95001 的行的所有数据</span></span><br><span class="line">get &#x27;student&#x27;,&#x27;95001&#x27;</span><br></pre></td></tr></table></figure>

<p>可以看到 Ssex 列的不见了，删除了 student 表中 95001 行下的 Ssex 列的所有数据。</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/%E5%88%A0%E9%99%A4Ssex%E5%88%97%E7%9A%84%E6%89%80%E6%9C%89%E6%95%B0%E6%8D%AE.png"></p>
<p><code>deleteall</code> 命令</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除 student 表中的 95001 行的全部数据。</span></span><br><span class="line">deleteall &#x27;student&#x27;,&#x27;95001&#x27;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Took 0.0052 seconds</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">检索 student 表中键为 95001 的行的所有数据</span></span><br><span class="line">get &#x27;student&#x27;,&#x27;95001&#x27;</span><br></pre></td></tr></table></figure>

<p>可以看到所有列不见了，即删除了 student 表中的 95001 行的全部数据。</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/%E5%88%A0%E9%99%A495001%E8%A1%8C%E7%9A%84%E5%85%A8%E9%83%A8%E6%95%B0%E6%8D%AE%E3%80%82.png"></p>
<p><strong>删除表</strong></p>
<p>删除表有两步：</p>
<ol>
<li>先让该表不可用。</li>
<li>删除表。</li>
</ol>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">让该表不可用</span></span><br><span class="line">disable &#x27;student&#x27;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除表</span></span><br><span class="line">drop &#x27;student&#x27;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">列出所有的表</span></span><br><span class="line">list</span><br></pre></td></tr></table></figure>

<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/hbase%E5%88%97%E5%87%BA%E6%89%80%E6%9C%89%E7%9A%84%E8%A1%A8.png"></p>
<blockquote>
<p>查询表历史数据</p>
</blockquote>
<p>查询表的历史版本，需要两步：</p>
<ol>
<li>创建表并插入&#x2F;更新数据。</li>
<li>查询指定版本的数据。</li>
</ol>
<p>1、创建表指定保存的版本数(假设指定为5)</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">create &#x27;teacher&#x27;,&#123;NAME=&gt;&#x27;username&#x27;,VERSIONS=&gt;5&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Created table teacher</span><br><span class="line">Took 0.7303 seconds                                                                                                 </span><br><span class="line">=&gt; Hbase::Table - teacher</span><br></pre></td></tr></table></figure>

<p>2、插入数据然后更新数据，使其产生历史版本数据。<strong>PS：这里插入数据和更新数据都是用 <code>put</code> 命令</strong></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">put &#x27;teacher&#x27;,&#x27;91001&#x27;,&#x27;username&#x27;,&#x27;Mary&#x27;</span><br><span class="line">put &#x27;teacher&#x27;,&#x27;91001&#x27;,&#x27;username&#x27;,&#x27;Mary1&#x27;</span><br><span class="line">put &#x27;teacher&#x27;,&#x27;91001&#x27;,&#x27;username&#x27;,&#x27;Mary2&#x27;</span><br><span class="line">put &#x27;teacher&#x27;,&#x27;91001&#x27;,&#x27;username&#x27;,&#x27;Mary3&#x27;</span><br><span class="line">put &#x27;teacher&#x27;,&#x27;91001&#x27;,&#x27;username&#x27;,&#x27;Mary4&#x27;  </span><br><span class="line">put &#x27;teacher&#x27;,&#x27;91001&#x27;,&#x27;username&#x27;,&#x27;Mary5&#x27;</span><br></pre></td></tr></table></figure>

<p>3、查询时，指定查询的历史版本数。默认会查询出最新的数据。(有效取值为1到5)</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">get &#x27;teacher&#x27;,&#x27;91001&#x27;,&#123;COLUMN=&gt;&#x27;username&#x27;,VERSIONS=&gt;5&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/%E6%9F%A5%E8%AF%A2%E8%A1%A8%E6%8C%87%E5%AE%9A%E7%89%88%E6%9C%AC%E7%9A%84%E6%95%B0%E6%8D%AE.png"></p>
<blockquote>
<p>退出HBase数据库表操作</p>
</blockquote>
<p>最后退出数据库操作，输入 <code>exit</code> 命令即可退出。</p>
<p><strong>PS：这里退出 HBase 数据库是退出对数据库表的操作，而不是停止启动 HBase 数据库后台运行。</strong></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">exit   # 或者 Ctrl + d</span><br></pre></td></tr></table></figure>

<h3 id="4-4-2-Java-API-编程实践"><a href="#4-4-2-Java-API-编程实践" class="headerlink" title="4.4.2 Java API 编程实践"></a>4.4.2 Java API 编程实践</h3><p>本实例采用 IDEA 开发工具。版本：2023.3.6</p>
<p>关于在 Linux 安装使用 IDEA 可以参考下文 <strong>Linux 安装使用 IDEA</strong>。</p>
<p>关于在 IDEA 中使用 Maven 可以参考下文 <strong>IDEA 中使用 Maven</strong>。</p>
<p><font color="red">PS：在开始运行程序之前，需要启动 HDFS 和 HBase 。这很重要！！千万不要忘记了。</font>😓</p>
<p>1、创建一个 Maven 项目，项目名为 HBaseExample</p>
<p>修改 <code>pom.xml</code> 文件，导入 HBase 的 Java API 的依赖包。<strong>PS：记得刷新依赖</strong>。😄</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.hbase<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hbase-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.4.13<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/%E5%AF%BC%E5%85%A5HBase%E4%BE%9D%E8%B5%96%E5%8C%85.png" style="zoom: 50%;">

<p>2、操作之前请确保没有 student 表：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#打开 shell 命令行模式</span></span><br><span class="line">hbase shell </span><br><span class="line"></span><br><span class="line"><span class="comment"># 列出所有的表，查看是否已经有 student 表</span></span><br><span class="line">list</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果有请先删除 student 表</span></span><br><span class="line"><span class="comment"># 让该表不可用</span></span><br><span class="line"><span class="built_in">disable</span> <span class="string">&#x27;student&#x27;</span></span><br><span class="line"><span class="comment"># 删除表</span></span><br><span class="line">drop <span class="string">&#x27;student&#x27;</span></span><br></pre></td></tr></table></figure>

<p>3、编写 <code>ExampleForHBase.java</code> </p>
<p><font color="red">PS：注意修改一下 <code>configuration.set(&quot;hbase.rootdir&quot;, &quot;hdfs://localhost:9000/hbase-2.2.2&quot;)</code> 与 Hbase 配置文件的内容一致。</font>😀</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.muyoukule;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.conf.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.HBaseConfiguration;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.TableName;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.client.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.util.Bytes;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ExampleForHBase</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Configuration configuration;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Connection connection;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Admin admin;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        init();</span><br><span class="line">        createTable(<span class="string">&quot;student&quot;</span>, <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;score&quot;</span>&#125;);</span><br><span class="line">        insertData(<span class="string">&quot;student&quot;</span>, <span class="string">&quot;zhangsan&quot;</span>, <span class="string">&quot;score&quot;</span>, <span class="string">&quot;English&quot;</span>, <span class="string">&quot;69&quot;</span>);</span><br><span class="line">        insertData(<span class="string">&quot;student&quot;</span>, <span class="string">&quot;zhangsan&quot;</span>, <span class="string">&quot;score&quot;</span>, <span class="string">&quot;Math&quot;</span>, <span class="string">&quot;86&quot;</span>);</span><br><span class="line">        insertData(<span class="string">&quot;student&quot;</span>, <span class="string">&quot;zhangsan&quot;</span>, <span class="string">&quot;score&quot;</span>, <span class="string">&quot;Computer&quot;</span>, <span class="string">&quot;77&quot;</span>);</span><br><span class="line">        getData(<span class="string">&quot;student&quot;</span>, <span class="string">&quot;zhangsan&quot;</span>, <span class="string">&quot;score&quot;</span>, <span class="string">&quot;English&quot;</span>);</span><br><span class="line">        close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">        configuration = HBaseConfiguration.create();</span><br><span class="line">        <span class="comment">//注意修改这里，需要与 Hbase 配置文件保持一致</span></span><br><span class="line">        configuration.set(<span class="string">&quot;hbase.rootdir&quot;</span>, <span class="string">&quot;hdfs://localhost:9000/hbase-2.2.2&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            connection = ConnectionFactory.createConnection(configuration);</span><br><span class="line">            admin = connection.getAdmin();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">close</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (admin != <span class="literal">null</span>) &#123;</span><br><span class="line">                admin.close();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> != connection) &#123;</span><br><span class="line">                connection.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">createTable</span><span class="params">(String myTableName, String[] colFamily)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">TableName</span> <span class="variable">tableName</span> <span class="operator">=</span> TableName.valueOf(myTableName);</span><br><span class="line">        <span class="keyword">if</span> (admin.tableExists(tableName)) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;talbe is exists!&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">TableDescriptorBuilder</span> <span class="variable">tableDescriptor</span> <span class="operator">=</span> TableDescriptorBuilder.newBuilder(tableName);</span><br><span class="line">            <span class="keyword">for</span> (String str : colFamily) &#123;</span><br><span class="line">                <span class="type">ColumnFamilyDescriptor</span> <span class="variable">family</span> <span class="operator">=</span></span><br><span class="line">                        ColumnFamilyDescriptorBuilder.newBuilder(Bytes.toBytes(str)).build();</span><br><span class="line">                tableDescriptor.setColumnFamily(family);</span><br><span class="line">            &#125;</span><br><span class="line">            admin.createTable(tableDescriptor.build());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">insertData</span><span class="params">(String tableName, String rowKey, String colFamily, String col, String val)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">Table</span> <span class="variable">table</span> <span class="operator">=</span> connection.getTable(TableName.valueOf(tableName));</span><br><span class="line">        <span class="type">Put</span> <span class="variable">put</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Put</span>(rowKey.getBytes());</span><br><span class="line">        put.addColumn(colFamily.getBytes(), col.getBytes(), val.getBytes());</span><br><span class="line">        table.put(put);</span><br><span class="line">        table.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">getData</span><span class="params">(String tableName, String rowKey, String colFamily, String col)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">Table</span> <span class="variable">table</span> <span class="operator">=</span> connection.getTable(TableName.valueOf(tableName));</span><br><span class="line">        <span class="type">Get</span> <span class="variable">get</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Get</span>(rowKey.getBytes());</span><br><span class="line">        get.addColumn(colFamily.getBytes(), col.getBytes());</span><br><span class="line">        <span class="type">Result</span> <span class="variable">result</span> <span class="operator">=</span> table.get(get);</span><br><span class="line">        System.out.println(<span class="keyword">new</span> <span class="title class_">String</span>(result.getValue(colFamily.getBytes(), col == <span class="literal">null</span> ? <span class="literal">null</span> : col.getBytes())));</span><br><span class="line">        table.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最终编写好的项目结构和代码如下：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/%E7%BC%96%E5%86%99%E4%BB%A3%E7%A0%81(1).png" style="zoom: 67%;">

<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/%E7%BC%96%E5%86%99%E4%BB%A3%E7%A0%81(2).png" style="zoom: 67%;">

<p>项目空白处右键 <code>Run</code> 开始运行程序，程序运行成功以后，会在运行结果中出现  <code>69</code>：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/%E8%BF%90%E8%A1%8C%E7%BB%93%E6%9E%9C69.png" style="zoom: 67%;">

<p>打印出来的 <code>69</code> 上面是日志的警告信息，可以忽略。</p>
<p>这时，可以到 HBase Shell 交互式环境中，使用如下命令查看 student 表是否创建成功：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">列出所有的表</span></span><br><span class="line">list</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看 student 表的全部数据</span></span><br><span class="line">scan &#x27;student&#x27;</span><br></pre></td></tr></table></figure>

<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/%E6%9F%A5%E7%9C%8Bjava%E5%88%9B%E5%BB%BAstudent%E8%A1%A8%E7%BB%93%E6%9E%9C.png"></p>
<p>至此使用 Java 代码操作 HBase 成功！！！！</p>
<h1 id="5-Hive"><a href="#5-Hive" class="headerlink" title="5. Hive"></a>5. Hive</h1><p>官方介绍：Apache Hive is a distributed, fault-tolerant data warehouse system that enables analytics at a massive scale. Hive Metastore(HMS) provides a central repository of metadata that can easily be analyzed to make informed, data driven decisions, and therefore it is a critical component of many data lake architectures. Hive is built on top of Apache Hadoop and supports storage on S3, adls, gs etc though hdfs. Hive allows users to read, write, and manage petabytes of data using SQL.</p>
<h2 id="5-1-Hive-下载与安装"><a href="#5-1-Hive-下载与安装" class="headerlink" title="5.1 Hive 下载与安装"></a>5.1 Hive 下载与安装</h2><p><a href="https://downloads.apache.org/hive/">官网下载</a></p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/Hive%E5%AE%98%E7%BD%91%E4%B8%8B%E8%BD%BD(1).png" style="zoom: 67%;">

<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/Hive%E5%AE%98%E7%BD%91%E4%B8%8B%E8%BD%BD(2).png" style="zoom: 80%;">

<p>打不开官网？试试清<a href="https://mirrors.tuna.tsinghua.edu.cn/apache/hive/">华大学开源软件镜像站下载</a>😀</p>
<p>下载好之后就可以开始安装了：</p>
<p>1、执行以下命令，选择文件上传到 Linux 的 &#x2F; 目录(具体请参考上文 <strong>FinalShell 文件上传</strong>)</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> /</span><br><span class="line"></span><br><span class="line">sudo rz</span><br></pre></td></tr></table></figure>

<p>2、解压缩 Hive 安装文件到 &#x2F;usr&#x2F;local 目录，并对解压缩之后的文件进行重命名，授权</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 解压缩 Hive  安装文件到 /usr/local 目录</span></span><br><span class="line">sudo tar -zxvf apache-hive-3.1.2-bin.tar.gz -C /usr/local</span><br><span class="line"></span><br><span class="line"><span class="comment"># 进入到 /usr/local 目录</span></span><br><span class="line"><span class="built_in">cd</span> /usr/local</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重命名文件</span></span><br><span class="line">sudo <span class="built_in">mv</span> ./apache-hive-3.1.2-bin ./hive-3.1.2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改文件权限</span></span><br><span class="line"><span class="comment"># muyoukule:muyoukule 是用户组和用户名，记得换成当前登录用户的用户名</span></span><br><span class="line">sudo <span class="built_in">chown</span> -R muyoukule:muyoukule hive-3.1.2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看文件</span></span><br><span class="line">ll</span><br></pre></td></tr></table></figure>

<p>3、配置环境变量，使用 vim 编辑器修改 &#x2F;etc&#x2F;profile 文件，在文件最后添加环境变量。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 修改 /etc/profile 文件</span></span><br><span class="line">sudo vim /etc/profile</span><br><span class="line"></span><br><span class="line"><span class="comment"># Hive 环境变量</span></span><br><span class="line"><span class="built_in">export</span> HIVE_HOME=/usr/local/hive-3.1.2</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:<span class="variable">$HIVE_HOME</span>/bin</span><br></pre></td></tr></table></figure>

<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/%E9%85%8D%E7%BD%AEHive%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F.png" style="zoom:67%;">

<p>4、重启环境变量配置</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">source</span> /etc/profile</span><br></pre></td></tr></table></figure>

<p>5、修改<code>/usr/local/hive-3.1.2/conf</code>下的 hive-site.xml(<strong>注意自己的路径</strong>)</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/local/hive-3.1.2/conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将 hive-default.xml.template 重命名为 hive-default.xml</span></span><br><span class="line"><span class="built_in">mv</span> hive-default.xml.template hive-default.xml</span><br></pre></td></tr></table></figure>

<p>6、使用 gedit 编辑器新建一个配置文件 <code>hive-site.xml</code></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 直接操作虚拟机使用 gedit 修改配置文件</span></span><br><span class="line">sudo gedit /usr/local/hive-3.1.2/conf/hive-site.xml</span><br></pre></td></tr></table></figure>

<p>7、在 <code>hive-site.xml</code> 中添加如下配置信息：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> standalone=<span class="string">&quot;no&quot;</span>?&gt;</span></span><br><span class="line"><span class="meta">&lt;?xml-stylesheet type=<span class="string">&quot;text/xsl&quot;</span> href=<span class="string">&quot;configuration.xsl&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- jdbc 连接的 URL：hive 是数据库名称，名称随意但要与后面创建的数据库名称相对应--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>javax.jdo.option.ConnectionURL<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>jdbc:mysql://localhost:3306/hive?createDatabaseIfNotExist=true<span class="symbol">&amp;amp;</span>useSSL=false<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>JDBC connect string for a JDBC metastore<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- jdbc 连接的 Driver：根据自己MySQL 的版本选择对应的Driver，--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>javax.jdo.option.ConnectionDriverName<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>com.mysql.jdbc.Driver<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>Driver class name for a JDBC metastore<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- jdbc 连接的 username--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>javax.jdo.option.ConnectionUserName<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>root<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>username to use against metastore database<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- jdbc 连接的 password--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>javax.jdo.option.ConnectionPassword<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>root<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>password to use against metastore database<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>添加后保存并退出即可。</p>
<h2 id="5-2-配置-MySQL"><a href="#5-2-配置-MySQL" class="headerlink" title="5.2 配置 MySQL"></a>5.2 配置 MySQL</h2><p>这里我们采用 MySQL 数据库保存 Hive 的元数据，而不是采用 Hive 自带的 derby 来存储元数据。</p>
<p><strong>下载 mysql jdbc 包</strong></p>
<p><a href="https://dev.mysql.com/downloads/connector/j/">官网下载</a></p>
<p>打开默认是最新版，也可以点击 <code>Archives</code> 选择历史版本。</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/mysql%20jdbc%E5%AE%98%E7%BD%91%E4%B8%8B%E8%BD%BD.png" style="zoom: 50%;">

<p>选择历史版本后点击 <code>Download</code> 进行下载：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/mysql%20jdbc%E5%8E%86%E5%8F%B2%E7%89%88%E6%9C%AC%E4%B8%8B%E8%BD%BD.png" style="zoom: 50%;">

<p>1、执行以下命令，选择文件上传到 Linux 的 &#x2F; 目录(具体请参考上文 <strong>FinalShell 文件上传</strong>)</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> /</span><br><span class="line"></span><br><span class="line">sudo rz</span><br></pre></td></tr></table></figure>

<p>2、解压缩文件到 &#x2F;usr&#x2F;local 目录，并对将 <code>mysql-connector-java-5.1.40-bin.jar</code> 拷贝到 hive 的 lib 目录下</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 解压缩文件到 /usr/local 目录</span></span><br><span class="line">sudo tar -zxvf mysql-connector-java-5.1.48.tar.gz -C /usr/local</span><br><span class="line"></span><br><span class="line"><span class="comment"># 进入到 /usr/local 目录</span></span><br><span class="line"><span class="built_in">cd</span> /usr/local</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将 mysql-connector-java-5.1.48-bin.jar 拷贝到 /usr/local/hive-3.1.2/lib 目录下</span></span><br><span class="line"><span class="built_in">cp</span> mysql-connector-java-5.1.48/mysql-connector-java-5.1.48-bin.jar  /usr/local/hive-3.1.2/lib </span><br><span class="line"></span><br><span class="line"><span class="comment"># 拷贝后可以查看是否拷贝成功</span></span><br><span class="line">find ./hive-3.1.2/lib -<span class="built_in">type</span> f -name <span class="string">&quot;mysql-connector-java-5.1.48-bin.jar&quot;</span></span><br></pre></td></tr></table></figure>

<p>3、启动并登陆 mysql shell</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 启动mysql服务</span></span><br><span class="line">sudo systemctl start mysqld</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 登陆 shell 界面</span></span><br><span class="line">mysql -u root -p</span><br></pre></td></tr></table></figure>

<p>4、新建 Hive 数据库</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 这个hive数据库与hive-site.xml中localhost:3306/hive的hive对应，用来保存hive元数据</span><br><span class="line">create database hive;    </span><br></pre></td></tr></table></figure>

<p>5、配置 MySQL 允许 Hive 接入</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 将所有数据库的所有表的所有权限赋给hive用户，后面的 root 是配置hive-site.xml中配置的连接密码</span><br><span class="line">grant all on *.* to root@localhost identified by &#x27;root&#x27;;</span><br><span class="line"></span><br><span class="line"># 刷新 mysql 系统权限关系表</span><br><span class="line">flush privileges;</span><br></pre></td></tr></table></figure>

<p>6、启动 Hive(启动 Hive 之前，请先启动 Hadoop )</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#启动Hadoop</span></span><br><span class="line">start-all.sh</span><br><span class="line"></span><br><span class="line"><span class="comment">#启动Hive</span></span><br><span class="line">hive</span><br></pre></td></tr></table></figure>

<p>假如在启动时报错：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">org.datanucleus.store.rdbms.exceptions.MissingTableException: Required table missing : &quot;`VERSION`&quot; in Catalog &quot;&quot; Schema &quot;&quot;. DataNucleus requires this table to perform its persistence operations. Either your MetaData is incorrect, or you need to enable &quot;datanucleus.schema.autoCreateTables&quot;</span><br></pre></td></tr></table></figure>

<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/Hive%E5%90%AF%E5%8A%A8%E6%8A%A5%E9%94%99.png"></p>
<p>解决方法：</p>
<p>先退出 Hive，再执行命令：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 退出 Hive</span></span><br><span class="line"><span class="built_in">exit</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化 Hive 的元数据存储的 schema</span></span><br><span class="line">schematool -dbType mysql -initSchema</span><br></pre></td></tr></table></figure>

<p>看到如下内容即代表初始化完毕：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/%E6%88%90%E5%8A%9F%E5%88%9D%E5%A7%8B%E5%8C%96%E5%85%83%E6%95%B0%E6%8D%AE%E5%BA%93.png"></p>
<p>初始化后再次使用 <code>hive</code> 启动 Hive，可以看到成功启动：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/%E6%88%90%E5%8A%9F%E5%90%AF%E5%8A%A8Hive.png"></p>
<p>启动进入 Hive 的交互式执行环境以后，会出现如下命令提示符：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">hive&gt;</span><br></pre></td></tr></table></figure>

<p>可以在里面输入 SQL 语句，如果要退出 Hive 交互式执行环境，可以输入如下命令：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">exit;	# 或者 Ctrl <span class="operator">+</span> d</span><br></pre></td></tr></table></figure>

<h1 id="6-Sqoop"><a href="#6-Sqoop" class="headerlink" title="6. Sqoop"></a>6. Sqoop</h1><p>Sqoop 是一款开源工具，专注于在 Hadoop(Hive)与传统数据库(如 MySQL、PostgreSQL 等)之间高效传输大批量数据。它可以将关系型数据库中的数据导入到 Hadoop 的 HDFS、Hive、HBase 等数据存储系统中，也可以从 Hadoop 的文件系统中导出数据到关系型数据库中。Sqoop 的核心设计思想是利用MapReduce加快数据传输速度，实现批处理方式进行数据传输。</p>
<h2 id="6-1-Sqoop下载与安装"><a href="#6-1-Sqoop下载与安装" class="headerlink" title="6.1 Sqoop下载与安装"></a>6.1 Sqoop下载与安装</h2><p><a href="https://archive.apache.org/dist/sqoop/">官网下载</a></p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/sqoop%E5%AE%98%E7%BD%91%E4%B8%8B%E8%BD%BD1.png" style="zoom: 67%;">

<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/sqoop%E5%AE%98%E7%BD%91%E4%B8%8B%E8%BD%BD2.png" style="zoom:67%;">

<p>下载好之后就可以开始安装了：</p>
<p>1、执行以下命令，选择文件上传到 Linux 的 &#x2F; 目录(具体请参考上文 <strong>FinalShell 文件上传</strong>)</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> /</span><br><span class="line"></span><br><span class="line">sudo rz</span><br></pre></td></tr></table></figure>

<p>2、解压缩 Sqoop 安装文件到 &#x2F;usr&#x2F;local 目录，并对解压缩之后的文件进行重命名，授权</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 解压缩 Sqoop 安装文件到 /usr/local 目录</span></span><br><span class="line">sudo tar -zxvf sqoop-1.4.7.bin__hadoop-2.6.0.tar.gz -C /usr/local</span><br><span class="line"></span><br><span class="line"><span class="comment"># 进入到 /usr/local 目录</span></span><br><span class="line"><span class="built_in">cd</span> /usr/local</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重命名文件</span></span><br><span class="line">sudo <span class="built_in">mv</span> ./sqoop-1.4.7.bin__hadoop-2.6.0 ./sqoop-1.4.7</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改文件权限</span></span><br><span class="line"><span class="comment"># muyoukule:muyoukule 是用户组和用户名，记得换成当前登录用户的用户名</span></span><br><span class="line">sudo <span class="built_in">chown</span> -R muyoukule:muyoukule sqoop-1.4.7</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看文件</span></span><br><span class="line">ll</span><br></pre></td></tr></table></figure>

<p>3、修改配置文件 <code>sqoop-env.sh</code></p>
<p>进入到 conf 文件夹，找到 <code>sqoop-env-template.sh</code>，修改其名称为 <code>sqoop-env.sh</code> 。然后编辑 <code>sqoop-env.sh</code> 文件，设置<code>HADOOP_COMMON_HOME</code>，<code>HADOOP_MAPRED_HOME</code>，<code>HIVE_HOME</code> 等环境变量。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 将 sqoop-env-template.sh 复制一份并命名为 sqoop-env.sh</span></span><br><span class="line"><span class="built_in">cp</span> ./sqoop-1.4.7/conf/sqoop-env-template.sh ./sqoop-1.4.7/conf/sqoop-env.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编辑 sqoop-env.sh</span></span><br><span class="line">vim ./sqoop-1.4.7/conf/sqoop-env.sh</span><br></pre></td></tr></table></figure>

<p>修改 <code>sqoop-env.sh</code> 的如下信息</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 配置 Hadoop 的环境变量</span></span><br><span class="line"><span class="built_in">export</span> HADOOP_COMMON_HOME=/usr/local/hadoop-3.1.3</span><br><span class="line"><span class="built_in">export</span> HADOOP_MAPRED_HOME=/usr/local/hadoop-3.1.3</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置 HBase 的环境变量</span></span><br><span class="line"><span class="built_in">export</span> HBASE_HOME=/usr/local/hbase-2.2.2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置 Hive 的环境变量</span></span><br><span class="line"><span class="built_in">export</span> HIVE_HOME=/usr/local/hive-3.1.2</span><br><span class="line"></span><br><span class="line"><span class="comment">#如果配置了 ZooKeeper,也需要在此配置 ZooKeeper 的路径</span></span><br><span class="line"><span class="comment">#export ZOOCFGDIR= </span></span><br></pre></td></tr></table></figure>

<p>因为在 <code>sqoop-env.sh</code> 文件中已经存在有如上这几个变量，只是被注释掉了，也就是前面带了 <code>#</code> 号，所以大家可以直接寻找到对应的变量，将前面起注释作用的 <code>#</code> 号删去，然后修改后面的值即可。</p>
<p><strong>PS：vim 编辑器怎样搜索字符串？</strong></p>
<ul>
<li>普通模式下，按下 <code>/</code> 键，然后输入你想要搜索的字符串，按下 <code>Enter</code> 键开始搜索。</li>
<li>要查找下一个匹配的字符串，按 <code>n</code>。</li>
<li>要查找上一个匹配的字符串，按 <code>N</code>。</li>
</ul>
<p>但是我很懒不想去找🙄，所以我就直接写在文件顶部了，这个是不影响运行操作的，具体图示如下：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/sqoop-env.sh.png" style="zoom: 67%;">

<p>4、配置环境变量，使用 vim 编辑器修改 &#x2F;etc&#x2F;profile 文件，在文件最后添加环境变量。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 修改 /etc/profile 文件</span></span><br><span class="line">sudo vim /etc/profile</span><br><span class="line"></span><br><span class="line"><span class="comment"># Sqoop 环境变量</span></span><br><span class="line"><span class="built_in">export</span> SQOOP_HOME=/usr/local/sqoop-1.4.7</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:<span class="variable">$SQOOP_HOME</span>/bin</span><br></pre></td></tr></table></figure>

<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/%E9%85%8D%E7%BD%AESqoop%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F.png" style="zoom:67%;">

<p>5、重启环境变量配置</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">source</span> /etc/profile</span><br></pre></td></tr></table></figure>

<p>6、检查安装结果，出现下面信息代表安装成功</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看 Sqoop 版本信息</span></span><br><span class="line">sqoop version</span><br></pre></td></tr></table></figure>

<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/%E6%A3%80%E6%9F%A5Sqoop%E5%AE%89%E8%A3%85%E7%BB%93%E6%9E%9C.png"></p>
<p>上面的警告是因为一些组件(HCatalog、Accumulo和Zookeeper)导致的，我们后续不会用到这些组件所以不用管它。</p>
<p>这样，Sqoop 就安装好了。</p>
<h2 id="6-2-配置-MySQL"><a href="#6-2-配置-MySQL" class="headerlink" title="6.2 配置 MySQL"></a>6.2 配置 MySQL</h2><p>1、添加 MySQL 驱动</p>
<p>将 MySQL 的 JDBC 驱动包(例如 <code>mysql-connector-java-5.1.40-bin.jar</code> )添加到 Sqoop 的 lib 目录下。<strong>PS：你的 MySQL 驱动要和你的数据库版本兼容。</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 进入到 /usr/local 目录</span></span><br><span class="line"><span class="built_in">cd</span> /usr/local</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将 mysql-connector-java-5.1.48-bin.jar 拷贝到 /usr/local/sqoop-1.4.7/lib 目录下</span></span><br><span class="line"><span class="built_in">cp</span> ./mysql-connector-java-5.1.48/mysql-connector-java-5.1.48-bin.jar /usr/local/sqoop-1.4.7/lib</span><br><span class="line"></span><br><span class="line"><span class="comment"># 拷贝后可以查看是否拷贝成功</span></span><br><span class="line">find ./sqoop-1.4.7/lib -<span class="built_in">type</span> f -name <span class="string">&quot;mysql-connector-java-5.1.48-bin.jar&quot;</span></span><br></pre></td></tr></table></figure>

<p>2、测试与 MySQL 的连接</p>
<p>首先请确保 MySQL 服务已经启动了，如果没有启动，请执行下面命令启动：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#检查 MySQL 服务状态</span></span><br><span class="line">systemctl status mysqld</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动 MySQL</span></span><br><span class="line">sudo systemctl start mysqld   </span><br></pre></td></tr></table></figure>

<p>3、然后就可以测试 Sqoop 与 MySQL 之间的连接是否成功：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sqoop list-databases --connect jdbc:mysql://127.0.0.1:3306/ --username root -P</span><br></pre></td></tr></table></figure>

<p>如果出现错误：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">WARN: Establishing SSL connection without server&#x27;s identity verification is not recommended. According to MySQL 5.5.45+, 5.6.26+ and 5.7.6+ requirements SSL connection must be established by default if explicit option isn&#x27;t set. For compliance with existing applications not using SSL the verifyServerCertificate property is set to &#x27;false&#x27;. You need either to explicitly disable SSL by setting useSSL=false, or set useSSL=true and provide truststore for server certificate verification.</span><br><span class="line">2024-03-23 21:20:32,889 ERROR manager.CatalogQueryManager: Failed to list databases</span><br></pre></td></tr></table></figure>

<p>首先检查在配置 jdbc 连接的 URL是是否加了 <code>useSSL=false</code> 参数。如果没加，将它加上后再次测试；如果加了也报这个错误则依次：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">登入数据库</span></span><br><span class="line">mysql -uroot -p</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看是否开启SSL</span></span><br><span class="line">SHOW VARIABLES LIKE &#x27;%ssl%&#x27;;</span><br></pre></td></tr></table></figure>

<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/%E6%9F%A5%E7%9C%8B%E6%98%AF%E5%90%A6%E5%BC%80%E5%90%AFSSL.png" style="zoom: 80%;">

<p>看到 <code>have_ssl</code> 的值为 <code>YES</code>，表示已开启 SSL。( <code>have_openssl</code>  表示是否支持SSL)。需要将 SSL 关闭：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 修改 MySQL 配置文件，目录根据安装时自行查找</span></span><br><span class="line">sudo vim /etc/my.cnf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在配置文件中添加 disable_ssl 和 skip_ssl 参数</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加完后重启 MySQL 服务</span></span><br><span class="line">sudo systemctl restart mysqld</span><br></pre></td></tr></table></figure>

<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/%E4%BF%AE%E6%94%B9MySQL%E9%85%8D%E7%BD%AE.png" style="zoom: 67%;">

<p>重启后再次测试 ，MySQL 的数据库列表显示在屏幕上表示连接成功：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sqoop list-databases --connect jdbc:mysql://127.0.0.1:3306/ --username root -P</span><br></pre></td></tr></table></figure>

<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/MySQL%E6%95%B0%E6%8D%AE%E5%BA%93%E5%88%97%E8%A1%A8.png"></p>
<h1 id="Linux-安装使用-IDEA"><a href="#Linux-安装使用-IDEA" class="headerlink" title="Linux 安装使用 IDEA"></a>Linux 安装使用 IDEA</h1><p>我这里使用的是 <strong>IDEA 2023.3.6 版本和 CentOS7 系统</strong>	其他版本和系统仅作参考。</p>
<p><font color="red">PS：Linux 中安装使用 IDEA 必须直接操作虚拟机，不能在远程连接工具操作，否则会打不开 IDEA。</font>😅</p>
<p>我这里下载的是<del>免费</del>社区版，社区版功能少虽然少，但是在这里够用。但是如果你有特定需求，需要更多的高级功能和定制选项，建议选择<del>收费</del>企业版😐，当然破解码网上都可以找到，安装步骤是一样的，大家有需求可以自行去网上查找相关教程。</p>
<h2 id="IDEA-的下载"><a href="#IDEA-的下载" class="headerlink" title="IDEA 的下载"></a>IDEA 的下载</h2><p>我这里是在本机上下载安装包然后上传到虚拟机，当然你也可以直接在 Linux 中打开 Firefox 浏览器进行下载。</p>
<p><a href="https://www.jetbrains.com/zh-cn/idea/download/other.html">下载官网</a></p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/%E5%AE%98%E7%BD%91%E4%B8%8B%E8%BD%BDidea.png">

<h2 id="IDEA-的安装"><a href="#IDEA-的安装" class="headerlink" title="IDEA 的安装"></a>IDEA 的安装</h2><p>1、执行以下命令，选择文件上传到 Linux 的 &#x2F; 目录(具体请参考上文 <strong>FinalShell 文件上传</strong>)</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> /</span><br><span class="line"></span><br><span class="line">sudo rz</span><br></pre></td></tr></table></figure>

<p>2、解压缩 IDEA 安装文件到 &#x2F;usr&#x2F;local 目录，并对解压缩之后的文件进行重命名</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 解压缩 IDEA 安装文件到 /usr/local 目录</span></span><br><span class="line">sudo tar -zxvf ideaIC-2023.3.6.tar.gz -C /usr/local</span><br><span class="line"></span><br><span class="line"><span class="comment"># 进入到 /usr/local 目录</span></span><br><span class="line"><span class="built_in">cd</span> /usr/local</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重命名文件</span></span><br><span class="line">sudo <span class="built_in">mv</span> ./idea-IC-233.15026.9 ./idea-2023.3.6</span><br><span class="line"></span><br><span class="line"><span class="comment"># 进入文件 idea-2023.3.6 的 bin 目录</span></span><br><span class="line"><span class="built_in">cd</span> idea-2023.3.6/bin</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看文件</span></span><br><span class="line">ll</span><br></pre></td></tr></table></figure>

<p>可以看到 bin 目录下有个 idea.sh 文件：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/%E6%9F%A5%E7%9C%8Bidea%E7%9A%84bin%E7%9B%AE%E5%BD%95.png"></p>
<p>3、运行 idea.sh 文件进行安装：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">./idea.sh</span><br></pre></td></tr></table></figure>

<p>假如你觉得每次通过 <code>./idea.sh</code> 指令启动 IDEA 要进入到 IDEA 的环境目录很麻烦，你也可以为 IDEA 配置环境变量(不觉得麻烦的可以跳过此步骤😄)：</p>
<p>1、使用 vim 编辑器修改 &#x2F;etc&#x2F;profile 文件，在文件最后添加环境变量。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 修改 /etc/profile 文件</span></span><br><span class="line">sudo vim /etc/profile</span><br><span class="line"></span><br><span class="line"><span class="comment"># IDEA 环境变量</span></span><br><span class="line"><span class="built_in">export</span> IDEA_HOME=/usr/local/idea-2023.3.6</span><br><span class="line"><span class="built_in">export</span> PATH=:<span class="variable">$PATH</span>:<span class="variable">$&#123;IDEA_HOME&#125;</span>/bin</span><br></pre></td></tr></table></figure>

<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/%E9%85%8D%E7%BD%AEIDEA%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F.png" style="zoom: 67%;">

<p>2、重启环境变量配置</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">source</span> /etc/profile</span><br></pre></td></tr></table></figure>

<p>3、之后我们就可以在任意目录下输入 <code>idea.sh</code> 启动 IDEA 图形化界面了</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 启动 IDEA 图形化界面</span></span><br><span class="line">idea.sh</span><br></pre></td></tr></table></figure>

<p>第一次启动 IDEA 图形化界面后会依次弹出以下界面，按照如下步骤操作即可：</p>
<p>1、打钩并点击 <code>Continue</code> </p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/IDEA%E5%90%AF%E5%8A%A8(1).png" style="zoom: 67%;">

<p>2、出现 “Date Sharing”  窗口，点击 <code>Don&#39;t Send</code> </p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/IDEA%E5%90%AF%E5%8A%A8(2).png" style="zoom:67%;">

<p>3、前面步骤操作完后，会出现 IDEA 界面</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/IDEA%E5%90%AF%E5%8A%A8(3).png" style="zoom: 50%;">

<p>至此 IDEA 安装完成！！是不是超级简单！！!😀</p>
<h2 id="IDEA-的使用"><a href="#IDEA-的使用" class="headerlink" title="IDEA 的使用"></a>IDEA 的使用</h2><p>1、点击 <code>New Project</code> 新建项目</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/IDEA%E7%9A%84%E4%BD%BF%E7%94%A8(1).png" style="zoom:50%;">

<p>2、修改项目名称，选择 JDK( IDEA 会识别到系统下安装过的 JDK 作为默认项)，如果没有 JDK，需要点击 <code>Download JDK</code> 进行下载</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/IDEA%E7%9A%84%E4%BD%BF%E7%94%A8(2).png" style="zoom:50%;">

<p>2、IDEA 提示 Untrusted Server’s certificate ，证书不可用( Server’s certificate is not trusted )，不用管，点击  <code>Accept</code></p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/IDEA%E7%9A%84%E4%BD%BF%E7%94%A8(3).png" style="zoom:50%;">

<p>4、IDEA 默认会创建一个示例项目，等待右下角 JDK 加载完成后在项目空白处右键点击 <code>Run</code></p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/IDEA%E7%9A%84%E4%BD%BF%E7%94%A8(4).png" style="zoom:50%;">

<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/IDEA%E7%9A%84%E4%BD%BF%E7%94%A8(5).png" style="zoom:50%;">

<p>5、之后看见控制台成功输出结果，成功！！！</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/IDEA%E7%9A%84%E4%BD%BF%E7%94%A8(6).png" style="zoom:50%;">

<p> 至此，IDEA 新建项目成功！就可以进行 Java 代码的编写了！！！</p>
<h1 id="Maven"><a href="#Maven" class="headerlink" title="Maven"></a>Maven</h1><p>Maven是一个强大的项目管理工具，主要服务于Java项目。它通过对项目构建过程的标准化和自动化，实现了依赖管理的简化，从而极大地提升了开发效率，并确保了项目的高质量输出。Maven的核心功能包括项目构建、依赖管理和项目信息管理，为开发者提供了一个统一、高效的平台来管理复杂的Java项目。如果你想了解更多关于 Maven 的知识请上网查阅，这里只做简单介绍。</p>
<p>这里我们主要使用到了依赖管理功能：采用 <code>pom.xml</code> 来导入依赖，可以自动下载 jar，以及其所依赖 jar，无需手动下载，拷贝 jar 到项目中。简单理解就是找 jar 包太麻烦了，我懒得自己找，让 Maven 帮我找。😏</p>
<h2 id="Maven-下载"><a href="#Maven-下载" class="headerlink" title="Maven 下载"></a>Maven 下载</h2><p><a href="https://maven.apache.org/download.cgi">下载官网</a></p>
<p>直接点击下载最新版或者下载以前的版本</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/Maven%E4%B8%8B%E8%BD%BD%E5%AE%98%E7%BD%91%20.png"></p>
<p>点击 <code>legacy archives</code> 进入页面自行选择相应版本即可。</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/maven%E5%8E%86%E5%8F%B2%E7%89%88%E6%9C%AC.png" style="zoom: 67%;">

<p>打不开官网？试试<a href="https://mirrors.tuna.tsinghua.edu.cn/apache/maven/">清华大学开源软件镜像站下载</a>。</p>
<h2 id="Maven-安装"><a href="#Maven-安装" class="headerlink" title="Maven 安装"></a>Maven 安装</h2><p>1、执行以下命令，选择文件上传到 Linux 的 &#x2F; 目录(具体请参考上文 <strong>FinalShell 文件上传</strong>)</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> /</span><br><span class="line"></span><br><span class="line">sudo rz</span><br></pre></td></tr></table></figure>

<p>2、解压缩 Maven 安装文件到 &#x2F;usr&#x2F;local 目录，并对解压缩之后的文件进行重命名</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 解压缩 Maven 安装文件到 /usr/local 目录</span></span><br><span class="line">sudo tar -zxvf apache-maven-3.9.6-bin.tar.gz -C /usr/local</span><br><span class="line"></span><br><span class="line"><span class="comment"># 进入到 /usr/local 目录</span></span><br><span class="line"><span class="built_in">cd</span> /usr/local</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重命名文件</span></span><br><span class="line">sudo <span class="built_in">mv</span> ./apache-maven-3.9.6 ./maven-3.9.6</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看文件</span></span><br><span class="line">ll</span><br></pre></td></tr></table></figure>

<p>3、配置环境变量，使用 vim 编辑器修改 &#x2F;etc&#x2F;profile 文件，在文件最后添加环境变量。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 修改 /etc/profile 文件</span></span><br><span class="line">sudo vim /etc/profile</span><br><span class="line"></span><br><span class="line"><span class="comment"># Maven 环境变量</span></span><br><span class="line"><span class="built_in">export</span> MAVEN_HOME=/usr/local/maven-3.9.6</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$MAVEN_HOME</span>/bin:<span class="variable">$PATH</span></span><br></pre></td></tr></table></figure>

<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/%E9%85%8D%E7%BD%AEMaven%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F.png" style="zoom:67%;">

<p>4、重启环境变量配置</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">source</span> /etc/profile</span><br></pre></td></tr></table></figure>

<p>5、检查安装结果，出现下面信息代表安装成功</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看 Maven 版本信息</span></span><br><span class="line">mvn -version</span><br></pre></td></tr></table></figure>

<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/%E6%9F%A5%E7%9C%8BMaven%E7%89%88%E6%9C%AC%E4%BF%A1%E6%81%AF.png"></p>
<p>这样，Maven 就安装好了。</p>
<h2 id="Maven-仓库配置"><a href="#Maven-仓库配置" class="headerlink" title="Maven 仓库配置"></a>Maven 仓库配置</h2><blockquote>
<p>怎么理解 Maven 仓库？</p>
</blockquote>
<p>Maven 仓库主要用于管理项目的依赖和插件。它是 Maven 的核心概念之一，对于 Maven 项目的构建和管理起着至关重要的作用。</p>
<p>具体来说，Maven 仓库可以分为本地仓库、中央仓库和远程仓库。本地仓库位于用户的本地机器上，用于存储项目所需的依赖(jar包)和插件。当 Maven 构建项目时，它首先会在本地仓库中查找所需的依赖和插件。如果本地仓库中没有，Maven 会尝试从中央仓库或远程仓库中下载。</p>
<p>中央仓库是 Maven 的官方仓库，其中包含了大量开源的 Java 库和插件。它位于 Maven 的服务器上，是 Maven 社区共享资源的地方。通过中央仓库，Maven用户可以方便地获取到各种开源项目的依赖和插件。</p>
<p>除了中央仓库外，还有一些其他的远程仓库，它们可能由第三方提供，用于存储特定的依赖和插件。这些远程仓库可以作为中央仓库的补充，使得Maven用户可以获取到更多的资源。</p>
<blockquote>
<p>配置本地仓库</p>
</blockquote>
<p>1、新建存放仓库的文件夹(本地仓库)</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 在 /usr/local/ 下创建 名为 maven_repo 的本地仓库</span></span><br><span class="line">sudo <span class="built_in">mkdir</span> /usr/local/maven_repo</span><br><span class="line"></span><br><span class="line"><span class="comment"># 把 Maven 本地仓库目录权限赋予给 muyoukule 用户(当前登陆用户)</span></span><br><span class="line">sudo <span class="built_in">chown</span> -R muyoukule /usr/local/maven_repo</span><br></pre></td></tr></table></figure>

<p>2、打开 <code>setting.xml</code> 文件(<strong>注意自己存放的路径</strong>)</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 直接操作虚拟机使用 gedit 修改 maven 配置文件</span></span><br><span class="line">sudo gedit /usr/local/maven-3.9.6/conf/settings.xml</span><br></pre></td></tr></table></figure>

<p>3、添加路径(<strong>注意自己存放的路径</strong>)</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">localRepository</span>&gt;</span>/usr/local/maven_repo<span class="tag">&lt;/<span class="name">localRepository</span>&gt;</span></span><br></pre></td></tr></table></figure>

<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/Maven%E9%85%8D%E7%BD%AE%E6%9C%AC%E5%9C%B0%E4%BB%93%E5%BA%93.png" style="zoom: 80%;">

<blockquote>
<p>配置远程仓库</p>
</blockquote>
<p>也可以不配置，但是下载依赖速度就会很慢。😂</p>
<p>在 <code>settings.xml</code> 中添加阿里云的镜像资源。(注意添加的位置)</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mirror</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">id</span>&gt;</span>nexus-aliyun<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>central<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>Nexus aliyun<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://maven.aliyun.com/nexus/content/groups/public/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br></pre></td></tr></table></figure>

<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/Maven%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%A4%AE%E4%BB%93%E5%BA%93.png" style="zoom: 50%;">

<h2 id="Maven-命令"><a href="#Maven-命令" class="headerlink" title="Maven 命令"></a>Maven 命令</h2><p>以下是 Maven 的常用命令：</p>
<ul>
<li><code>mvn clean</code>：清理构建产生的文件。</li>
<li><code>mvn compile</code>：编译项目的源代码。</li>
<li><code>mvn test</code>：运行项目的单元测试。</li>
<li><code>mvn package</code>：打包项目，生成 JAR 或 WAR 文件。</li>
<li><code>mvn install</code>：将项目安装到本地 Maven 仓库。</li>
<li><code>mvn deploy</code>：将项目发布到远程仓库。</li>
<li><code>mvn site</code>：生成项目文档和报告。</li>
<li><code>mvn archetype:generate</code> 或 <code>mvn archetype:create</code>：基于原型创建新的 Maven 项目。</li>
<li><code>mvn version</code> 或 <code>mvn -v</code>：显示 Maven 版本信息和环境配置。</li>
</ul>
<h2 id="IDEA-中使用-Maven"><a href="#IDEA-中使用-Maven" class="headerlink" title="IDEA 中使用 Maven"></a>IDEA 中使用 Maven</h2><p><strong>PS：IDEA 中自带 Maven，如果你没有下载Apache Maven，直接创建 Maven 项目也行。</strong></p>
<blockquote>
<p>IDEA 中自带的 Maven</p>
</blockquote>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/IDEA%E8%87%AA%E5%B8%A6%E7%9A%84Maven.png" style="zoom:50%;">

<blockquote>
<p>配置自己下载的 Maven</p>
</blockquote>
<p><font color="red"><strong>PS：配置 Maven 之前一定要做的设置！！这很重要！这很重要！这很重要 * 3 ！！！！否则 Maven 下载依赖会失败，会爆红！！！！</strong></font> 😣😣😣</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 把 Maven 本地仓库目录权限赋予给 muyoukule 用户</span></span><br><span class="line">sudo <span class="built_in">chown</span> -R muyoukule /usr/local/maven_repo</span><br></pre></td></tr></table></figure>

<p>如果你打开有项目先将它关闭，在 <code>Customize</code> 下点击 <code>All settings</code></p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/All%20settings.png" style="zoom: 50%;">

<p>在左上角搜索 <code>maven</code>，找到如下界面进行配置</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/IDEA%E4%B8%AD%E8%AE%BE%E7%BD%AEMaven.png" style="zoom: 50%;">

<p>配置好了就可以创建 Maven 项目了。</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/IDEA%E5%88%9B%E5%BB%BAMaven%E9%A1%B9%E7%9B%AE.png" style="zoom:50%;">

<p>第一次创建 Maven 项目需要耐心等待，因为第一次创建 Maven 项目本地仓库为空，所有依赖都要去远程仓库下载。</p>
<p><font color="red"><strong>PS：每次创建完项目后记得要再次检查一下 Maven 配置是否成功！！！！</strong></font>😫😫😫</p>
<p>IDEA 左上角点击 <code>File</code> –&gt; <code>Settings</code> 进行检查。因为有些 IDEA 版本<del>很垃圾</del>有 BUG，在 <code>Customize</code> 点击 <code>All settings</code> 下配置 Maven 时失效。<font color="red"><strong>所以每次创建完项目一定要对 Maven 配置进行检查！！</strong></font></p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/Maven%E9%A1%B9%E7%9B%AE%E5%8A%A0%E8%BD%BD%E4%BE%9D%E8%B5%96.png" style="zoom: 50%;">

<p>出现 <code>BUILE SUCCESS</code> 表示依赖加载成功，默认打开的 <code>pom.xml</code> 就是管理 jar 包的地方，以后项目所有的依赖都写在这里面，无需手动导入。</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/Maven%E9%A1%B9%E7%9B%AE%E5%8A%A0%E8%BD%BD%E4%BE%9D%E8%B5%96%E6%88%90%E5%8A%9F.png" style="zoom: 50%;">

<p>创建的 Maven 项目在右侧会出现 Maven 按钮，点开后会看到有 <code>Lifecycle</code>(生命周期)、<code>Plugins</code>(插件)和 <code>Dependencies</code>(依赖)。其中在 <code>Dependencies</code> 里看到已经有一个 <code>junit</code> 依赖，这是创建项目时自动添加，用来做单元测试的，其中不难发现它与 <code>pom.xml</code> 文件里 <code>&lt;dependencies&gt;&lt;/dependencies&gt;</code> 下的：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.8.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>相对应，这是 Maven 引入外部依赖的方式，后续我们使用到的其他依赖也是使用这种形式引入项目。</p>
<p>需要注意的是引入依赖后需要点击以下刷新按钮，在 <code>Dependencies</code> 中看到了相应的依赖才可以进行使用。</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/%E6%9F%A5%E7%9C%8B%E4%BE%9D%E8%B5%96.png" style="zoom: 80%;">

<p> 至此，IDEA 新建 Maven 项目成功！就可以进行代码的编写了！！！</p>
]]></content>
      <categories>
        <category>BigData</category>
      </categories>
      <tags>
        <tag>Hadoop</tag>
        <tag>Hive</tag>
        <tag>MySQL</tag>
        <tag>HBase</tag>
        <tag>Sqoop</tag>
        <tag>IDEA</tag>
        <tag>Maven</tag>
      </tags>
  </entry>
  <entry>
    <title>Java生成二维码</title>
    <url>/posts/62439/</url>
    <content><![CDATA[<h1 id="0-前言"><a href="#0-前言" class="headerlink" title="0. 前言"></a>0. 前言</h1><p>五一假期闲来无事，在翻看b站收藏夹的时候无意间发现了<a href="https://www.bilibili.com/video/BV1Kw41197kh/">Java生成二维码教程</a>这条视频，仔细一看，时长两小时？那不得赶紧学一个？</p>
<h1 id="1-技术栈"><a href="#1-技术栈" class="headerlink" title="1. 技术栈"></a>1. 技术栈</h1><ul>
<li>SpringBoot</li>
<li>谷歌的：<a href="https://github.com/zxing/zxing">zxing</a><ul>
<li>生成普通的黑白二维码。</li>
<li>在二维码中间添加一个小图标。</li>
</ul>
</li>
<li>github开源项目：<a href="https://github.com/liuyueyi/quick-media?tab=readme-ov-file">qrcode</a><ul>
<li>qrcode开源项目的内部是基于zxing实现的，可以让二维码更加酷炫。</li>
</ul>
</li>
</ul>
<h1 id="2-环境搭建"><a href="#2-环境搭建" class="headerlink" title="2. 环境搭建"></a>2. 环境搭建</h1><p>1、新建一个 SpringBoot 项目，创建的时候勾选 SpringBoot Web 依赖。</p>
<p>2、添加依赖：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 勾选 SpringBoot Web 自动引入 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- Thymeleaf --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-thymeleaf<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>3、编写Controller：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebController</span> &#123;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">index</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;index&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="3-使用zxing"><a href="#3-使用zxing" class="headerlink" title="3. 使用zxing"></a>3. 使用zxing</h1><h2 id="3-1-zxing相关依赖"><a href="#3-1-zxing相关依赖" class="headerlink" title="3.1 zxing相关依赖"></a>3.1 zxing相关依赖</h2><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--zxing依赖--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.google.zxing<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javase<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--commons-lang依赖--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-lang<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-lang<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="3-2-zxing常用API"><a href="#3-2-zxing常用API" class="headerlink" title="3.2 zxing常用API"></a>3.2 zxing常用API</h2><h3 id="3-2-1-EncodeHintType（编码提示类型）"><a href="#3-2-1-EncodeHintType（编码提示类型）" class="headerlink" title="3.2.1 EncodeHintType（编码提示类型）"></a>3.2.1 EncodeHintType（编码提示类型）</h3><p>EncodeHintType是用来设置二维码编码时的一些额外参数的枚举类型，常用枚举值如下：</p>
<ul>
<li><code>ERROR_CORRECTION</code>：<ul>
<li>误差校正级别。对于黑白二维码，可选值为<code>L</code>(7%)、<code>M</code>(15%)、<code>Q</code>(25%)、<code>H</code>(30%)，表示二维码允许破损的最大容错率。在二维码出现破损时，根据设置的容错率级别，可以尝试修复二维码中的一些数据。</li>
<li>二维码在生成过程中，可能会出现一些损坏或者缺失的情况，例如打印时墨水耗尽、图像压缩、摄像头拍摄角度不对等。这些问题可能导致二维码无法完全识别，或者识别出来的数据不准确，而误差校正码就是为了解决这些问题而产生的。</li>
<li>例如，选择L级别的容错率，相当于允许在二维码的整体颜色区域中，最多可有约7%的坏像素点；而选择H级别的容错率时，最多可有约30%的坏像素点。</li>
<li><strong>注意：误差校正级别的具体值需要通过ErrorCorrectionLevel的枚举值来获取。</strong></li>
</ul>
</li>
<li><code>CHARACTER_SET</code>：<ul>
<li>编码字符集。可以设置使用的字符编码，例如utf-8、gb2312等等。</li>
</ul>
</li>
<li><code>MARGIN</code>：<ul>
<li>二维码的空白区域大小。可以设置二维码周围的留白大小，以便于在不同的嵌入场景中使用二维码。</li>
</ul>
</li>
</ul>
<h3 id="3-2-2-MultiFormatWriter（多格式写入程序）"><a href="#3-2-2-MultiFormatWriter（多格式写入程序）" class="headerlink" title="3.2.2 MultiFormatWriter（多格式写入程序）"></a>3.2.2 MultiFormatWriter（多格式写入程序）</h3><p><code>MultiFormatWriter</code> 是一个便捷的二维码生成类，可以根据传入的 <code>BarcodeFormat</code> 参数，生成对应类型的二维码。</p>
<p><code>MultiFormatWriter</code> 封装了一系列的二维码生成方法，可以生成多种格式的二维码，包括QR Code、Aztec Code、PDF417、Data Matrix等。</p>
<h3 id="3-2-3-BarcodeFormat（码格式）"><a href="#3-2-3-BarcodeFormat（码格式）" class="headerlink" title="3.2.3 BarcodeFormat（码格式）"></a>3.2.3 BarcodeFormat（码格式）</h3><p>BarcodeFormat是枚举类，通过它来制定二维码格式：</p>
<ul>
<li>QR Code ：QR Code是最常见的二维码格式之一，广泛应用于商品包装、票务、扫码支付等领域。QR Code矩阵有黑白两种颜色，其中黑色部分表示信息的编码，白色部分则用于衬托和辨识。</li>
<li>Aztec Code：Aztec Code是一种高密度、可靠性很高的二维码格式。相比于其他二维码格式，它具有更低的容错率、更小的尺寸和更高的解码效率。因此，它适合用于储存一些核心信息，例如个人信息、证件信息、账户密码等。</li>
<li>PDF417：是一种可以储存大量信息的二维码格式，它具有数据密度高、可靠性强等优点，可以应用于许多场景，例如航空机票，运输和配送标签，法律文件等。</li>
<li>Data Matrix：是一种小巧的二维码格式，它的编码方式类似于QR Code，但是其可靠性、识别率、扫描速度和牢固度都比QR Code更优秀。由于尺寸较小、可靠性较高，因此Data Matrix适合嵌入简单的产品标签、医疗图像、检测数据等领域。</li>
</ul>
<h3 id="3-2-4-BitMatrix（位矩阵）"><a href="#3-2-4-BitMatrix（位矩阵）" class="headerlink" title="3.2.4 BitMatrix（位矩阵）"></a>3.2.4 BitMatrix（位矩阵）</h3><p><code>BitMatrix</code> 是zxing库中表示二维码矩阵的数据结构，它是由0和1构成的二维数组，用于存储二维码的编码信息。在二维码生成过程中，我们通过对 <code>BitMatrix</code> 对象的构建和操作，最终生成一个可被扫描解码的二维码图像。</p>
<p><code>BitMatrix</code> 实际上是一个<strong>紧凑型的布尔型二维数组</strong>，往往只需要占用一个字节即可表示8位二进制。在使用 <code>BitMatrix</code> 时，我们可以通过其不同的方法，例如 <code>get()</code>、<code>set() </code>等，来获取、设置矩阵中每个位置的值。</p>
<p>在zxing中，<code>BitMatrix </code>常用于将编码后的信息转化为矩阵形式，并进行图像的生成和输出。在使用zxing生成二维码时，我们首先需要使用 <code>MultiFormatWriter.encode() </code>方法来生成一个 <code>BitMatrix</code>；然后，在对 <code>BitMatrix</code> 进行各种处理和操作后，就可以在UI中显示和输出二维码。</p>
<p>总的来说，<code>BitMatrix </code>是zxing库中非常重要的数据结构之一，它负责存储和处理生成二维码图像所需的二进制信息，是实现二维码生成功能的关键。</p>
<p>BitMatrix常用API：</p>
<ul>
<li>getHeight()：获取矩阵高度</li>
<li>getWidth()：获取矩阵宽度</li>
<li>get(x, y)：根据x，y的坐标获取矩阵中该坐标的值。结果是true（黑色）或者false（白色）。</li>
</ul>
<h2 id="3-3-生成普通黑白二维码"><a href="#3-3-生成普通黑白二维码" class="headerlink" title="3.3 生成普通黑白二维码"></a>3.3 生成普通黑白二维码</h2><p>前端代码：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>生成普通黑白二维码<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  url：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">id</span>=<span class="string">&quot;url&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span> <span class="attr">onclick</span>=<span class="string">&quot;generateQRcode()&quot;</span>&gt;</span>生成二维码<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">img</span> <span class="attr">id</span>=<span class="string">&quot;image&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">function</span> <span class="title function_">generateQRcode</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">          <span class="keyword">let</span> url = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;url&quot;</span>).<span class="property">value</span>;</span></span><br><span class="line"><span class="language-javascript">          <span class="keyword">let</span> i = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;image&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">          i.<span class="property">src</span> = <span class="string">&quot;/qrcode/create?url=&quot;</span> + url;</span></span><br><span class="line"><span class="language-javascript">      &#125;</span></span><br><span class="line"><span class="language-javascript">  </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>后端代码：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CreateQrcodeController</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/create&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">create</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 准备一个Map集合，用来存储二维码图片的相关属性</span></span><br><span class="line">            Map&lt;EncodeHintType, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">            <span class="comment">// 设置误差校验级别</span></span><br><span class="line">            map.put(EncodeHintType.ERROR_CORRECTION, ErrorCorrectionLevel.H);</span><br><span class="line">            <span class="comment">// 设置字符编码（因为文本内容要转换成二维码，需要指定转换时采用的字符集）</span></span><br><span class="line">            map.put(EncodeHintType.CHARACTER_SET, <span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line">            <span class="comment">// 设置二维码的外边距</span></span><br><span class="line">            map.put(EncodeHintType.MARGIN, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 获取要生成二维码的文本内容</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;url&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 创建MultiFormatWriter对象</span></span><br><span class="line">            <span class="type">MultiFormatWriter</span> <span class="variable">writer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MultiFormatWriter</span>();</span><br><span class="line">            <span class="comment">// 传入：内容、码的格式、宽度、高度、二维码参数。返回位矩阵对象。</span></span><br><span class="line">            <span class="type">BitMatrix</span> <span class="variable">bitMatrix</span> <span class="operator">=</span> writer.encode(url, BarcodeFormat.QR_CODE, <span class="number">300</span>, <span class="number">300</span>, map);</span><br><span class="line">            <span class="comment">// 获取位矩阵的宽度和高度</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">width</span> <span class="operator">=</span> bitMatrix.getWidth();</span><br><span class="line">            <span class="type">int</span> <span class="variable">height</span> <span class="operator">=</span> bitMatrix.getHeight();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 创建BufferedImage对象</span></span><br><span class="line">            <span class="type">BufferedImage</span> <span class="variable">image</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedImage</span>(width, height, BufferedImage.TYPE_INT_RGB);</span><br><span class="line">            <span class="comment">// 遍历位矩阵</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">x</span> <span class="operator">=</span> <span class="number">0</span>; x &lt; width; x++) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">y</span> <span class="operator">=</span> <span class="number">0</span>; y &lt; height; y++) &#123;</span><br><span class="line">                    <span class="comment">// 0xFF000000 黑色</span></span><br><span class="line">                    <span class="comment">// 0xFFFFFFFF 白色</span></span><br><span class="line">                    image.setRGB(x, y, bitMatrix.get(x, y) ? <span class="number">0xFF000000</span> : <span class="number">0xFFFFFFFF</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 响应</span></span><br><span class="line">            <span class="type">ServletOutputStream</span> <span class="variable">out</span> <span class="operator">=</span> response.getOutputStream();</span><br><span class="line">            ImageIO.write(image, <span class="string">&quot;png&quot;</span>, out);</span><br><span class="line">            out.flush();</span><br><span class="line">            out.close();</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-4-生成一个带logo的黑白二维码"><a href="#3-4-生成一个带logo的黑白二维码" class="headerlink" title="3.4 生成一个带logo的黑白二维码"></a>3.4 生成一个带logo的黑白二维码</h2><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>生成带有logo的黑白二维码<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;/generateWithLogo&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span> <span class="attr">enctype</span>=<span class="string">&quot;multipart/form-data&quot;</span>&gt;</span></span><br><span class="line">    请输入文本内容：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;url&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    请选择图片：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">name</span>=<span class="string">&quot;logo&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;生成带有logo的二维码&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@MultipartConfig(fileSizeThreshold = 1024 * 1024 * 2, maxFileSize = 1024 * 1024 * 10, maxRequestSize = 1024 * 1024 * 100)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GenerateQrCodeWithLogoController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/generateWithLogo&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">create</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 准备一个Map集合，用来存放二维码的属性</span></span><br><span class="line">            Map&lt;EncodeHintType, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">            map.put(EncodeHintType.ERROR_CORRECTION, ErrorCorrectionLevel.H);</span><br><span class="line">            map.put(EncodeHintType.CHARACTER_SET, <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">            map.put(EncodeHintType.MARGIN, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 获取文本内容</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;url&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 创建zxing核心对象</span></span><br><span class="line">            <span class="type">MultiFormatWriter</span> <span class="variable">writer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MultiFormatWriter</span>();</span><br><span class="line">            <span class="type">BitMatrix</span> <span class="variable">bitMatrix</span> <span class="operator">=</span> writer.encode(url, BarcodeFormat.QR_CODE, <span class="number">300</span>, <span class="number">300</span>, map);</span><br><span class="line">            <span class="type">int</span> <span class="variable">width</span> <span class="operator">=</span> bitMatrix.getWidth();</span><br><span class="line">            <span class="type">int</span> <span class="variable">height</span> <span class="operator">=</span> bitMatrix.getHeight();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 生成二维码</span></span><br><span class="line">            <span class="type">BufferedImage</span> <span class="variable">bufferedImage</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedImage</span>(width, height, BufferedImage.TYPE_INT_RGB);</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">x</span> <span class="operator">=</span> <span class="number">0</span>; x &lt; width; x++) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">y</span> <span class="operator">=</span> <span class="number">0</span>; y &lt; height; y++) &#123;</span><br><span class="line">                    bufferedImage.setRGB(x, y, bitMatrix.get(x, y) ? <span class="number">0xFF000000</span> : <span class="number">0xFFFFFFFF</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 给二维码添加logo</span></span><br><span class="line">            <span class="comment">// 第一部分：将logo缩放。</span></span><br><span class="line">            <span class="comment">// 获取上传的logo Part对象</span></span><br><span class="line">            <span class="type">Part</span> <span class="variable">logo</span> <span class="operator">=</span> request.getPart(<span class="string">&quot;logo&quot;</span>);</span><br><span class="line">            <span class="comment">// 通过Part对象获取输入流</span></span><br><span class="line">            <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> logo.getInputStream();</span><br><span class="line">            <span class="comment">// 通过ImageIO的read方法，从输入流中读取，从而获得logo图片</span></span><br><span class="line">            <span class="type">Image</span> <span class="variable">logoImage</span> <span class="operator">=</span> ImageIO.read(inputStream);</span><br><span class="line">            <span class="comment">// 获取logo图片的宽度</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">logoWidth</span> <span class="operator">=</span> logoImage.getWidth(<span class="literal">null</span>);</span><br><span class="line">            <span class="comment">// 获取logo图片的高度</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">logoHeight</span> <span class="operator">=</span> logoImage.getHeight(<span class="literal">null</span>);</span><br><span class="line">            <span class="comment">// 如果logo的宽度或者高度大于100，则重新赋值100</span></span><br><span class="line">            <span class="keyword">if</span> (logoWidth &gt; <span class="number">60</span>) &#123;</span><br><span class="line">                logoWidth = <span class="number">60</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (logoHeight &gt; <span class="number">60</span>) &#123;</span><br><span class="line">                logoHeight = <span class="number">60</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 使用平滑缩放算法对原logo图像进行缩放得到一个全新的图像。</span></span><br><span class="line">            <span class="type">Image</span> <span class="variable">scaledLogo</span> <span class="operator">=</span> logoImage.getScaledInstance(logoWidth, logoHeight, Image.SCALE_SMOOTH);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 第二部分：将缩放后的logo画到黑白二维码上</span></span><br><span class="line">            <span class="comment">// 获取2D画笔</span></span><br><span class="line">            <span class="type">Graphics2D</span> <span class="variable">graphics2D</span> <span class="operator">=</span> bufferedImage.createGraphics();</span><br><span class="line">            <span class="comment">// 开始画的x和y坐标</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">x</span> <span class="operator">=</span> (<span class="number">300</span> - logoWidth) / <span class="number">2</span>;</span><br><span class="line">            <span class="type">int</span> <span class="variable">y</span> <span class="operator">=</span> (<span class="number">300</span> - logoHeight) / <span class="number">2</span>;</span><br><span class="line">            <span class="comment">// 将缩放后的logo画上去</span></span><br><span class="line">            graphics2D.drawImage(scaledLogo, x, y, <span class="literal">null</span>);</span><br><span class="line">            <span class="comment">// 创建一个具有指定位置、宽度、高度和圆角半径的圆角矩形。这个圆角矩形是用来绘制边框的。</span></span><br><span class="line">            <span class="type">Shape</span> <span class="variable">shape</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RoundRectangle2D</span>.Float(x, y, logoWidth, logoHeight, <span class="number">10</span>, <span class="number">10</span>);</span><br><span class="line">            <span class="comment">// 使用一个宽度为4像素的基本笔触</span></span><br><span class="line">            graphics2D.setStroke(<span class="keyword">new</span> <span class="title class_">BasicStroke</span>(<span class="number">4f</span>));</span><br><span class="line">            <span class="comment">// 给logo画圆角矩形</span></span><br><span class="line">            graphics2D.draw(shape);</span><br><span class="line">            <span class="comment">// 释放画笔</span></span><br><span class="line">            graphics2D.dispose();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 响应</span></span><br><span class="line">            ImageIO.write(bufferedImage, <span class="string">&quot;png&quot;</span>, response.getOutputStream());</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="4-使用qrcode"><a href="#4-使用qrcode" class="headerlink" title="4. 使用qrcode"></a>4. 使用qrcode</h1><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.liuyueyi.media<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>qrcode-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="4-1-生成黑白二维码"><a href="#4-1-生成黑白二维码" class="headerlink" title="4.1 生成黑白二维码"></a>4.1 生成黑白二维码</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@MultipartConfig(fileSizeThreshold = 1024 * 1024 * 2, maxFileSize = 1024 * 1024 * 10, maxRequestSize = 1024 * 1024 * 100)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GenerateWithQrCodeController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/generateWithQrCode&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">create</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;url&quot;</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="type">BufferedImage</span> <span class="variable">image</span> <span class="operator">=</span> QrCodeGenWrapper.of(url).asBufferedImage();</span><br><span class="line">            </span><br><span class="line">            ImageIO.write(image, <span class="string">&quot;png&quot;</span>, response.getOutputStream());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-2-生成带有logo的二维码"><a href="#4-2-生成带有logo的二维码" class="headerlink" title="4.2 生成带有logo的二维码"></a>4.2 生成带有logo的二维码</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;url&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">BufferedImage</span> <span class="variable">image</span> <span class="operator">=</span> QrCodeGenWrapper.of(url)</span><br><span class="line">        .setLogo(request.getPart(<span class="string">&quot;logo&quot;</span>).getInputStream())</span><br><span class="line">        .setLogoRate(<span class="number">7</span>) <span class="comment">// 设置 logo 图片与二维码之间的比例。在这个例子中，它设置为 7，表示 logo 的宽度等于二维码的 1/7。</span></span><br><span class="line">        .setLogoStyle(QrCodeOptions.LogoStyle.ROUND) <span class="comment">// 设置 logo 图片的样式。设置为 ROUND，表示将 logo 的边框形状设置为圆形。</span></span><br><span class="line">        .asBufferedImage();</span><br><span class="line"></span><br><span class="line">ImageIO.write(image, <span class="string">&quot;png&quot;</span>, response.getOutputStream());</span><br></pre></td></tr></table></figure>

<h2 id="4-3-生成彩色二维码"><a href="#4-3-生成彩色二维码" class="headerlink" title="4.3 生成彩色二维码"></a>4.3 生成彩色二维码</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;url&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">BufferedImage</span> <span class="variable">image</span> <span class="operator">=</span> QrCodeGenWrapper.of(url)</span><br><span class="line">        .setDrawPreColor(Color.BLUE)</span><br><span class="line">        .asBufferedImage();</span><br><span class="line"></span><br><span class="line">ImageIO.write(image, <span class="string">&quot;png&quot;</span>, response.getOutputStream());</span><br></pre></td></tr></table></figure>

<h2 id="4-4-生成背景图二维码"><a href="#4-4-生成背景图二维码" class="headerlink" title="4.4 生成背景图二维码"></a>4.4 生成背景图二维码</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;url&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">BufferedImage</span> <span class="variable">image</span> <span class="operator">=</span> QrCodeGenWrapper.of(url)</span><br><span class="line">        .setBgImg(request.getPart(<span class="string">&quot;logo&quot;</span>).getInputStream())</span><br><span class="line">        .setBgOpacity(<span class="number">0.7F</span>)</span><br><span class="line">        .asBufferedImage();</span><br><span class="line"></span><br><span class="line">ImageIO.write(image, <span class="string">&quot;png&quot;</span>, response.getOutputStream());</span><br></pre></td></tr></table></figure>

<h2 id="4-5-特殊形状二维码"><a href="#4-5-特殊形状二维码" class="headerlink" title="4.5 特殊形状二维码"></a>4.5 特殊形状二维码</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;url&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">BufferedImage</span> <span class="variable">image</span> <span class="operator">=</span> QrCodeGenWrapper.of(url)</span><br><span class="line">        .setDrawEnableScale(<span class="literal">true</span>) <span class="comment">// 启用二维码绘制时的缩放功能</span></span><br><span class="line">        .setDrawStyle(QrCodeOptions.DrawStyle.DIAMOND) <span class="comment">// 指定绘制样式</span></span><br><span class="line">        .asBufferedImage();</span><br><span class="line"></span><br><span class="line">ImageIO.write(image, <span class="string">&quot;png&quot;</span>, response.getOutputStream());</span><br></pre></td></tr></table></figure>

<h2 id="4-6-图片填充二维码"><a href="#4-6-图片填充二维码" class="headerlink" title="4.6 图片填充二维码"></a>4.6 图片填充二维码</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;url&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">BufferedImage</span> <span class="variable">image</span> <span class="operator">=</span> QrCodeGenWrapper.of(url)</span><br><span class="line">        .setErrorCorrection(ErrorCorrectionLevel.H) <span class="comment">// 设置二维码的错误纠正级别</span></span><br><span class="line">        .setDrawStyle(QrCodeOptions.DrawStyle.IMAGE) <span class="comment">// 绘制样式采用图片填充</span></span><br><span class="line">        .addImg(<span class="number">1</span>, <span class="number">1</span>, request.getPart(<span class="string">&quot;logo&quot;</span>).getInputStream()) <span class="comment">// 添加图片</span></span><br><span class="line">        .asBufferedImage();</span><br><span class="line"></span><br><span class="line">ImageIO.write(image, <span class="string">&quot;png&quot;</span>, response.getOutputStream());</span><br></pre></td></tr></table></figure>

<h2 id="4-7-生成gif动图二维码"><a href="#4-7-生成gif动图二维码" class="headerlink" title="4.7 生成gif动图二维码"></a>4.7 生成gif动图二维码</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;url&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">BufferedImage</span> <span class="variable">image</span> <span class="operator">=</span> QrCodeGenWrapper.of(url)</span><br><span class="line">        .setW(<span class="number">500</span>)</span><br><span class="line">        .setH(<span class="number">500</span>)</span><br><span class="line">        .setBgImg(request.getPart(<span class="string">&quot;logo&quot;</span>).getInputStream())</span><br><span class="line">        .setBgOpacity(<span class="number">0.6f</span>)</span><br><span class="line">        .setPicType(<span class="string">&quot;gif&quot;</span>)</span><br><span class="line">        .asBufferedImage();</span><br><span class="line"></span><br><span class="line">ImageIO.write(image, <span class="string">&quot;gif&quot;</span>, response.getOutputStream());</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>Tools</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>Axios备忘录</title>
    <url>/posts/50631/</url>
    <content><![CDATA[<h1 id="0-前言"><a href="#0-前言" class="headerlink" title="0. 前言"></a>0. 前言</h1><p>尽管 <a href="https://www.axios-http.cn/">Axios官网 </a>对其的介绍非常详细，但是为了方便，还是决定将一些地方以自己便于理解的方式简要记录下来。</p>
<p>PS：一般自己学习Axios直接通过使用CDN引入即可（如果速度较慢可以将 js 文件下载到本地引入），而在项目中才使用npm方式安装。</p>
<h1 id="1-Axios-是什么"><a href="#1-Axios-是什么" class="headerlink" title="1. Axios 是什么?"></a>1. Axios 是什么?</h1><p>Axios 是一个基于Promise的HTTP客户端，用于浏览器和node.js环境。它是一个开源库，提供了一种简单、优雅的方式来处理HTTP请求。Axios的主要特性包括：</p>
<ul>
<li>支持浏览器和node.js环境。</li>
<li>支持Promise API。</li>
<li>能够拦截请求和响应。</li>
<li>自动转换JSON数据。</li>
<li>客户端支持保护安全免受XSRF攻击。</li>
</ul>
<p>Axios的常见用途包括：</p>
<ul>
<li>发送HTTP请求，如GET、POST、PUT、DELETE等。</li>
<li>处理请求和响应的拦截器。</li>
<li>客户端保护，防止XSRF攻击。</li>
<li>取消请求。</li>
<li>自动转换JSON数据。</li>
</ul>
<h1 id="2-JSON-Server"><a href="#2-JSON-Server" class="headerlink" title="2. JSON Server"></a>2. JSON Server</h1><p>在前端开发过程中，我们需要实时与后端进行数据交互。然而大多数时候，前端开发都是在没有后端数据提供的情况下进行的，这时我们就需要用到假 API 模拟。而 JSON Server 就可以为我们提供假 API。</p>
<h2 id="2-1-JSON-Server是什么？"><a href="#2-1-JSON-Server是什么？" class="headerlink" title="2.1 JSON Server是什么？"></a>2.1 JSON Server是什么？</h2><p><a href="https://github.com/typicode/json-server">JSON Server 官方</a>介绍：</p>
<p>Get a full fake REST API with <strong>zero coding</strong> in <strong>less than 30 seconds</strong> (seriously)</p>
<p>Created with &lt;3 for front-end developers who need a quick back-end for prototyping and mocking.</p>
<p>翻译过来的大致意思就是：</p>
<p>在<strong>不到 30 秒</strong>的时间内获得一个完整的假 REST API，<strong>零编码</strong>（认真的）</p>
<p>使用 &lt;3 创建，适用于需要快速后端进行原型设计和模拟的前端开发人员。</p>
<h2 id="2-2-JSON-Server使用"><a href="#2-2-JSON-Server使用" class="headerlink" title="2.2 JSON Server使用"></a>2.2 JSON Server使用</h2><p>仅需简单的三步：</p>
<p>1、安装</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">npm install json-server</span><br></pre></td></tr></table></figure>

<p>2、创建一个 <code>db.json</code> 文件：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;posts&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span> <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;a title&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;views&quot;</span><span class="punctuation">:</span> <span class="number">100</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span> <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;another title&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;views&quot;</span><span class="punctuation">:</span> <span class="number">200</span> <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;comments&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span> <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;text&quot;</span><span class="punctuation">:</span> <span class="string">&quot;a comment about post 1&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;postId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span> <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;text&quot;</span><span class="punctuation">:</span> <span class="string">&quot;another comment about post 1&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;postId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1&quot;</span> <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;profile&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;typicode&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>3、启动服务，将其传递给 JSON 服务器 CLI</p>
<p><strong>PS：服务启动时一定要确保当前工作目录定位在 <code>db.json</code> 所在文件夹下</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">npx json-server db.json</span><br></pre></td></tr></table></figure>

<p>启动服务后就可以通过REST API风格访问 <code>http://localhost:3000/</code> 拿到对应数据了。</p>
<p>PS：不知道 REST API 风格的小伙伴可以参考这篇文章的 <strong>RESTFul 编程风格</strong> 介绍部分：<a href="https://zz.muyoukule.cn/posts/26179/">【第6章】 RESTFul编程风格</a></p>
<h1 id="3-Axios-的使用"><a href="#3-Axios-的使用" class="headerlink" title="3. Axios 的使用"></a>3. Axios 的使用</h1><p>1、安装</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">npm install axios</span><br></pre></td></tr></table></figure>

<p>2、在需要使用的组件引入</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> axios <span class="keyword">from</span> <span class="string">&#x27;axios&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="3-1-Axios-API"><a href="#3-1-Axios-API" class="headerlink" title="3.1 Axios API"></a>3.1 Axios API</h3><p>格式：</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="title function_">axios</span>(&#123;</span><br><span class="line">  <span class="comment">//请求方法，GET/POST/...</span></span><br><span class="line">  <span class="attr">method</span>: <span class="string">&#x27;post&#x27;</span>,</span><br><span class="line">  <span class="comment">//请求路径</span></span><br><span class="line">  <span class="attr">url</span>: <span class="string">&#x27;http://localhost:3000/posts&#x27;</span>,</span><br><span class="line">  <span class="comment">//请求数据</span></span><br><span class="line">  <span class="attr">data</span>: &#123;</span><br><span class="line">    <span class="string">&quot;id&quot;</span>: <span class="number">3</span>,</span><br><span class="line">    <span class="string">&quot;title&quot;</span>: <span class="string">&quot;今天天气不错&quot;</span>,</span><br><span class="line">    <span class="string">&quot;views&quot;</span>: <span class="number">300</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="function"><span class="params">response</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">//成功的回调</span></span><br><span class="line">  <span class="comment">//response代表服务器响应的所有的数据,包含了响应头,响应体. response.data 代表的是接口响应的核心数据</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(response.<span class="property">data</span>);</span><br><span class="line">&#125;).<span class="title function_">catch</span>(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">//失败的回调</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(err);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>示例：</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 发起一个get请求</span></span><br><span class="line"><span class="title function_">axios</span>(&#123;</span><br><span class="line">  <span class="attr">method</span>: <span class="string">&#x27;get&#x27;</span>,</span><br><span class="line">  <span class="attr">url</span>: <span class="string">&#x27;http://localhost:3000/posts/1&#x27;</span></span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="function"><span class="params">response</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(response.<span class="property">data</span>);</span><br><span class="line">&#125;).<span class="title function_">catch</span>(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(err);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 发起一个post请求</span></span><br><span class="line"><span class="title function_">axios</span>(&#123;</span><br><span class="line">  <span class="attr">method</span>: <span class="string">&#x27;post&#x27;</span>,</span><br><span class="line">  <span class="attr">url</span>: <span class="string">&#x27;http://localhost:3000/posts&#x27;</span>,</span><br><span class="line">  <span class="comment">//设置请求体</span></span><br><span class="line">  <span class="attr">data</span>: &#123;</span><br><span class="line">    <span class="string">&quot;id&quot;</span>: <span class="number">3</span>,</span><br><span class="line">    <span class="string">&quot;title&quot;</span>: <span class="string">&quot;今天天气不错&quot;</span>,</span><br><span class="line">    <span class="string">&quot;views&quot;</span>: <span class="number">300</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line">  .<span class="title function_">then</span>(<span class="function"><span class="params">response</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(response.<span class="property">data</span>);</span><br><span class="line">  &#125;).<span class="title function_">catch</span>(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(err);</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>

<h3 id="3-2-请求式别名"><a href="#3-2-请求式别名" class="headerlink" title="3.2 请求式别名"></a>3.2 请求式别名</h3><p>为了方便起见，Axios 已经为所有支持的请求方法提供了别名。</p>
<p>格式：<code>axios.请求方式(url[, data[, config]])</code></p>
<p>示例：</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 发起一个get请求</span></span><br><span class="line">axios.<span class="title function_">get</span>(<span class="string">&#x27;http://localhost:3000/posts/1&#x27;</span>)</span><br><span class="line">  .<span class="title function_">then</span>(<span class="function"><span class="params">response</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(response.<span class="property">data</span>);</span><br><span class="line">  &#125;).<span class="title function_">catch</span>(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(err);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 发起一个post请求</span></span><br><span class="line"><span class="keyword">let</span> post = &#123;</span><br><span class="line">  <span class="string">&quot;id&quot;</span>: <span class="number">4</span>,</span><br><span class="line">  <span class="string">&quot;title&quot;</span>: <span class="string">&quot;今天心情不错&quot;</span>,</span><br><span class="line">  <span class="string">&quot;views&quot;</span>: <span class="number">400</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">axios.<span class="title function_">post</span>(<span class="string">&#x27;http://localhost:3000/posts&#x27;</span>, post)</span><br><span class="line">  .<span class="title function_">then</span>(<span class="function"><span class="params">response</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(response.<span class="property">data</span>);</span><br><span class="line">  &#125;).<span class="title function_">catch</span>(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(err);</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>

<h1 id="4-默认配置"><a href="#4-默认配置" class="headerlink" title="4. 默认配置"></a>4. 默认配置</h1><p><a href="https://www.axios-http.cn/docs/req_config">请求配置</a> 里的配置选项都是可以设置默认配置的。</p>
<p>示例：</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="comment">//设置默认的请求类型为 POST</span></span><br><span class="line">axios.<span class="property">defaults</span>.<span class="property">method</span> = <span class="string">&#x27;post&#x27;</span>;</span><br><span class="line"><span class="comment">//设置默认基础 URL</span></span><br><span class="line">axios.<span class="property">defaults</span>.<span class="property">baseURL</span> = <span class="string">&#x27;http://localhost:3000&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 发起一个post请求</span></span><br><span class="line"><span class="title function_">axios</span>(&#123;</span><br><span class="line">  <span class="attr">url</span>: <span class="string">&#x27;/posts&#x27;</span>,</span><br><span class="line">  <span class="attr">data</span>: &#123;</span><br><span class="line">    <span class="string">&quot;id&quot;</span>: <span class="number">5</span>,</span><br><span class="line">    <span class="string">&quot;title&quot;</span>: <span class="string">&quot;今天心情一般般&quot;</span>,</span><br><span class="line">    <span class="string">&quot;views&quot;</span>: <span class="number">500</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">).<span class="title function_">then</span>(<span class="function"><span class="params">response</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(response.<span class="property">data</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>由于上方设置了默认的请求类型为 POST 和基础 URL，在下面发起请求时没有显式指定请求方法，Axios 将默认使用 POST 方法。<code>url: &#39;/posts&#39;,</code> 这里的 <code>url</code> 字段指定了请求的路径。但是没有提供完整 URL，Axios 会将这个基础 URL 添加到请求的路径前面。所以实际请求的 URL 将是 <code>http://localhost:3000/posts</code></p>
<h1 id="5-拦截器"><a href="#5-拦截器" class="headerlink" title="5. 拦截器"></a>5. 拦截器</h1><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 添加请求拦截器</span></span><br><span class="line">axios.<span class="property">interceptors</span>.<span class="property">request</span>.<span class="title function_">use</span>(</span><br><span class="line">  <span class="function"><span class="params">config</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 在发送请求之前做些什么</span></span><br><span class="line">    <span class="keyword">return</span> config;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 对请求错误做些什么</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">reject</span>(error);</span><br><span class="line">  &#125;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加响应拦截器</span></span><br><span class="line">axios.<span class="property">interceptors</span>.<span class="property">response</span>.<span class="title function_">use</span>(</span><br><span class="line">  <span class="function"><span class="params">response</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 2xx 范围内的状态码都会触发该函数。</span></span><br><span class="line">    <span class="comment">// 对响应数据做点什么</span></span><br><span class="line">    <span class="keyword">return</span> response;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 超出 2xx 范围的状态码都会触发该函数。</span></span><br><span class="line">    <span class="comment">// 对响应错误做点什么</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">reject</span>(error);</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>

<p>可以给自定义的 axios 实例添加拦截器：</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Axios实例(下面会进行介绍)</span></span><br><span class="line"><span class="keyword">const</span> instance = axios.<span class="title function_">create</span>(&#123;</span><br><span class="line">    <span class="comment">/*...*/</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加请求拦截器</span></span><br><span class="line">instance.<span class="property">interceptors</span>.<span class="property">request</span>.<span class="title function_">use</span>(<span class="comment">/*...*/</span>);</span><br><span class="line"><span class="comment">// 添加响应拦截器</span></span><br><span class="line">instance.<span class="property">interceptors</span>.<span class="property">response</span>.<span class="title function_">use</span>(<span class="comment">/*...*/</span>);</span><br></pre></td></tr></table></figure>

<h1 id="6-Axios-实例"><a href="#6-Axios-实例" class="headerlink" title="6. Axios 实例"></a>6. Axios 实例</h1><p>Axios 实例是使用 Axios 库创建的一个定制化的 HTTP 客户端对象。这个实例是基于 Axios 的核心功能，但是可以拥有自己的配置，比如基础 URL、默认的请求头、超时时间等。通过创建 Axios 实例，你可以为不同的 API 或服务配置不同的设置，而不必每次发送请求时都重复设置这些参数。</p>
<p>格式：<code>axios.create([config])</code></p>
<blockquote>
<p>使用示例</p>
</blockquote>
<p><strong>创建实例</strong></p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> instance = axios.<span class="title function_">create</span>(&#123;</span><br><span class="line">  <span class="attr">baseURL</span>: <span class="string">&#x27;https://api.example.com&#x27;</span>,</span><br><span class="line">  <span class="attr">timeout</span>: <span class="number">1000</span>,</span><br><span class="line">  <span class="attr">headers</span>: &#123;<span class="string">&#x27;X-Custom-Header&#x27;</span>: <span class="string">&#x27;foobar&#x27;</span>&#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>这里，<code>axios.create()</code> 方法接受一个配置对象，用于创建一个新的 Axios 实例。这个实例会继承 Axios 的所有方法和属性，但是会使用你提供的配置作为默认值。</p>
<p><strong>使用实例发送请求</strong></p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line">instance.<span class="title function_">get</span>(<span class="string">&#x27;/user&#x27;</span>)</span><br><span class="line">  .<span class="title function_">then</span>(<span class="function"><span class="params">response</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(response.<span class="property">data</span>);</span><br><span class="line">  &#125;)</span><br><span class="line">  .<span class="title function_">catch</span>(<span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(error);</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>

<p>使用创建的 Axios 实例发送请求时，它会使用你在创建实例时提供的配置。在这个例子中，<code>instance</code> 会使用<code>https://api.example.com/user</code> 作为请求的 URL。</p>
<p><strong>默认配置</strong></p>
<p>创建 Axios 实例时设置的配置会成为该实例的默认配置。这意味着如果你在发送请求时没有提供特定的配置，Axios 实例会使用默认配置。</p>
<p><strong>拦截器</strong></p>
<p>Axios 实例允许你添加请求和响应拦截器，这些拦截器可以在请求发送之前或响应到达之前进行处理。</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line">instance.<span class="property">interceptors</span>.<span class="property">request</span>.<span class="title function_">use</span>(<span class="function"><span class="params">config</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 在发送请求之前做些什么</span></span><br><span class="line">  <span class="keyword">return</span> config;</span><br><span class="line">&#125;, <span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 对请求错误做些什么</span></span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">reject</span>(error);</span><br><span class="line">&#125;);</span><br><span class="line">instance.<span class="property">interceptors</span>.<span class="property">response</span>.<span class="title function_">use</span>(<span class="function"><span class="params">response</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 对响应数据做点什么</span></span><br><span class="line">  <span class="keyword">return</span> response;</span><br><span class="line">&#125;, <span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 对响应错误做点什么</span></span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">reject</span>(error);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>拦截器可以用来修改请求配置、处理错误、添加日志、显示加载指示器等。</p>
<blockquote>
<p>总结</p>
</blockquote>
<p>通过创建 Axios 实例，你可以为不同的 API 请求创建不同的配置，这样可以提高代码的可维护性和可复用性。例如，如果你正在开发一个前端应用，并且需要与多个后端服务进行通信，为每个服务创建一个 Axios 实例并配置好相应的默认参数，可以让你的代码更加清晰和模块化。</p>
<h1 id="7-网络请求跨域解决方案"><a href="#7-网络请求跨域解决方案" class="headerlink" title="7. 网络请求跨域解决方案"></a>7. 网络请求跨域解决方案</h1><p>网络请求跨域，通常指的是当一个网页或脚本尝试访问或请求另一个不同源(<strong>不同协议、不同域名、不同端口</strong>)的网页或资源时，由于浏览器的同源策略（Same-Origin Policy）限制，这种请求会被阻止。</p>
<blockquote>
<p>跨域错误提示信息</p>
</blockquote>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/Front-EndIMG/%E8%B7%A8%E5%9F%9F%E9%94%99%E8%AF%AF%E6%8F%90%E7%A4%BA%E4%BF%A1%E6%81%AF.png" alt="跨域错误提示信息"></p>
<blockquote>
<p>解决方案</p>
</blockquote>
<p>非常简单，直接在 <code>vite.config.ts</code> 中配置即可：</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="attr">server</span>: &#123;</span><br><span class="line">  <span class="attr">proxy</span>: &#123;</span><br><span class="line">    <span class="string">&#x27;/api&#x27;</span>: &#123;</span><br><span class="line">      <span class="attr">target</span>: <span class="string">&#x27;&lt;url&gt;&#x27;</span>,</span><br><span class="line">      <span class="attr">changeOrigin</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">rewrite</span>: <span class="function">(<span class="params">path</span>) =&gt;</span> path.<span class="title function_">replace</span>(<span class="regexp">/^\/api/</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>配置详解：</p>
<ul>
<li><code>server</code>：开发服务器的配置对象。</li>
<li><code>proxy</code>：在这个对象中，您可以定义代理规则，告诉开发服务器如何处理特定的API请求。</li>
<li><code>&#39;/api&#39;</code>：这是一个匹配请求路径的正则表达式。当请求的路径以 <code>/api</code> 开头时，这个代理规则会被应用。</li>
<li><code>target</code>：这是目标服务器的URL，您的API请求将会被代理到这个地址。</li>
<li><code>changeOrigin</code>：设置为 <code>true</code> 时，代理服务器会修改请求头中的 <code>Origin</code> 字段，使得请求看起来像是来自于目标服务器，从而绕过某些基于<code>Origin</code>的跨域限制。</li>
<li><code>rewrite</code>：重写请求路径函数。在这个例子中，<code>rewrite</code>函数会去除请求路径中的<code>/api</code>前缀。例如，如果请求<code>/api/userinfo</code>，代理服务器会将请求转发到 <code>http://localhost:8080/userinfo</code>。</li>
</ul>
<div class="note info flat"><p>解决完跨域配置后，记得要重启服务器才行哦！</p>
</div>

<h1 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h1><blockquote>
<p>requrst.js</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">//定制请求的实例</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//导入axios  npm install axios</span></span><br><span class="line"><span class="keyword">import</span> axios <span class="keyword">from</span> <span class="string">&#x27;axios&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ElMessage</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;element-plus&#x27;</span></span><br><span class="line"><span class="comment">//定义一个变量,记录公共的前缀  ,  baseURL</span></span><br><span class="line"><span class="comment">//const baseURL = &#x27;http://localhost:8080&#x27;;</span></span><br><span class="line"><span class="keyword">const</span> baseURL = <span class="string">&#x27;/api&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> instance = axios.<span class="title function_">create</span>(&#123; baseURL &#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123;useTokenStore&#125; <span class="keyword">from</span> <span class="string">&#x27;@/stores/token.js&#x27;</span></span><br><span class="line"><span class="comment">//添加请求拦截器</span></span><br><span class="line">instance.<span class="property">interceptors</span>.<span class="property">request</span>.<span class="title function_">use</span>(</span><br><span class="line">    <span class="function">(<span class="params">config</span>)=&gt;</span>&#123;</span><br><span class="line">        <span class="comment">//请求前的回调</span></span><br><span class="line">        <span class="comment">//添加token</span></span><br><span class="line">        <span class="keyword">const</span> tokenStore = <span class="title function_">useTokenStore</span>();</span><br><span class="line">        <span class="comment">//判断有没有token</span></span><br><span class="line">        <span class="keyword">if</span>(tokenStore.<span class="property">token</span>)&#123;</span><br><span class="line">            config.<span class="property">headers</span>.<span class="property">Authorization</span> = tokenStore.<span class="property">token</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> config;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function">(<span class="params">err</span>)=&gt;</span>&#123;</span><br><span class="line">        <span class="comment">//请求错误的回调</span></span><br><span class="line">        <span class="title class_">Promise</span>.<span class="title function_">reject</span>(err)</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">/* import &#123;useRouter&#125; from &#x27;vue-router&#x27;</span></span><br><span class="line"><span class="comment">const router = useRouter(); */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> router <span class="keyword">from</span> <span class="string">&#x27;@/router&#x27;</span></span><br><span class="line"><span class="comment">//添加响应拦截器</span></span><br><span class="line">instance.<span class="property">interceptors</span>.<span class="property">response</span>.<span class="title function_">use</span>(</span><br><span class="line">    <span class="function"><span class="params">result</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">//判断业务状态码</span></span><br><span class="line">        <span class="keyword">if</span>(result.<span class="property">data</span>.<span class="property">code</span>===<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> result.<span class="property">data</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//操作失败</span></span><br><span class="line">        <span class="comment">//alert(result.data.msg?result.data.msg:&#x27;服务异常&#x27;)</span></span><br><span class="line">        <span class="title class_">ElMessage</span>.<span class="title function_">error</span>(result.<span class="property">data</span>.<span class="property">msg</span>?result.<span class="property">data</span>.<span class="property">msg</span>:<span class="string">&#x27;服务异常&#x27;</span>)</span><br><span class="line">        <span class="comment">//异步操作的状态转换为失败</span></span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">reject</span>(result.<span class="property">data</span>)</span><br><span class="line">        </span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">//判断响应状态码,如果为401,则证明未登录,提示请登录,并跳转到登录页面</span></span><br><span class="line">        <span class="keyword">if</span>(err.<span class="property">response</span>.<span class="property">status</span>===<span class="number">401</span>)&#123;</span><br><span class="line">            <span class="title class_">ElMessage</span>.<span class="title function_">error</span>(<span class="string">&#x27;请先登录&#x27;</span>)</span><br><span class="line">            router.<span class="title function_">push</span>(<span class="string">&#x27;/login&#x27;</span>)</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="title class_">ElMessage</span>.<span class="title function_">error</span>(<span class="string">&#x27;服务异常&#x27;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">       </span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">reject</span>(err);<span class="comment">//异步的状态转化成失败的状态</span></span><br><span class="line">    &#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> instance;</span><br></pre></td></tr></table></figure>







]]></content>
      <categories>
        <category>Front-End</category>
        <category>Axios</category>
      </categories>
      <tags>
        <tag>Axios</tag>
      </tags>
  </entry>
  <entry>
    <title>Redis基础篇</title>
    <url>/posts/55591/</url>
    <content><![CDATA[<h1 id="1-初识Redis"><a href="#1-初识Redis" class="headerlink" title="1. 初识Redis"></a>1. 初识Redis</h1><p>redis是一种键值型的NoSql数据库，这里有两个关键字：</p>
<ul>
<li><p>键值型</p>
</li>
<li><p>NoSql</p>
</li>
</ul>
<p>其中<strong>键值型</strong>，是指redis中存储的数据都是以key、value对的形式存储，而value的形式多种多样，可以是字符串、数值、甚至json：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/Redis/redis%E4%B8%AD%E5%AD%98%E5%82%A8%E7%9A%84%E6%95%B0%E6%8D%AE%E5%BD%A2%E5%BC%8F.png" alt="redis中存储的数据形式"></p>
<p>而<strong>NoSql</strong>则是相对于传统关系型数据库而言，有很大差异的一种数据库。</p>
<h2 id="1-1-认识NoSQL"><a href="#1-1-认识NoSQL" class="headerlink" title="1.1 认识NoSQL"></a>1.1 认识NoSQL</h2><p><strong>NoSql</strong>可以翻译做Not Only Sql（不仅仅是SQL），或者是No Sql（非Sql的）数据库。是相对于传统关系型数据库而言，有很大差异的一种特殊的数据库，因此也称之为<strong>非关系型数据库</strong>。</p>
<h3 id="1-1-1-结构化与非结构化"><a href="#1-1-1-结构化与非结构化" class="headerlink" title="1.1.1 结构化与非结构化"></a>1.1.1 结构化与非结构化</h3><p>传统关系型数据库是结构化数据，每一张表都有严格的约束信息：字段名、字段数据类型、字段约束等等信息，插入的数据必须遵守这些约束：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/Redis/%E7%BB%93%E6%9E%84%E5%8C%96%E6%95%B0%E6%8D%AE.png" alt="结构化数据"></p>
<p>而NoSql则对数据库格式没有严格约束，往往形式松散，自由。</p>
<p>可以是键值型：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/Redis/%E9%94%AE%E5%80%BC%E5%9E%8B.png" alt="键值型"></p>
<p>也可以是文档型：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/Redis/%E6%96%87%E6%A1%A3%E5%9E%8B.png" alt="文档型"></p>
<p>甚至可以是图格式：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/Redis/%E5%9B%BE%E6%A0%BC%E5%BC%8F.png" alt="图格式" style="zoom:80%;">



<h3 id="1-1-2-关联和非关联"><a href="#1-1-2-关联和非关联" class="headerlink" title="1.1.2 关联和非关联"></a>1.1.2 关联和非关联</h3><p>传统数据库的表与表之间往往存在关联，例如外键：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/Redis/%E5%A4%96%E9%94%AE.png" alt="外键" style="zoom:67%;">

<p>而非关系型数据库不存在关联关系，要维护关系要么靠代码中的业务逻辑，要么靠数据之间的耦合：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    id<span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    name<span class="punctuation">:</span> <span class="string">&quot;张三&quot;</span><span class="punctuation">,</span></span><br><span class="line">    orders<span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">         id<span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">         item<span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">       id<span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span> title<span class="punctuation">:</span> <span class="string">&quot;荣耀6&quot;</span><span class="punctuation">,</span> price<span class="punctuation">:</span> <span class="number">4999</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">         id<span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">         item<span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">       id<span class="punctuation">:</span> <span class="number">20</span><span class="punctuation">,</span> title<span class="punctuation">:</span> <span class="string">&quot;小米11&quot;</span><span class="punctuation">,</span> price<span class="punctuation">:</span> <span class="number">3999</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>此处要维护 ‘张三’ 的订单与商品 ‘荣耀’ 和 ‘小米11’ 的关系，不得不冗余的将这两个商品保存在张三的订单文档中，不够优雅。还是建议用业务来维护关联关系。</p>
<h3 id="1-1-3-查询方式"><a href="#1-1-3-查询方式" class="headerlink" title="1.1.3 查询方式"></a>1.1.3 查询方式</h3><p>传统关系型数据库会基于Sql语句做查询，语法有统一标准；而不同的非关系数据库查询语法差异极大，五花八门各种各样。</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/Redis/%E6%9F%A5%E8%AF%A2%E6%96%B9%E5%BC%8F.png" alt="查询方式"></p>
<h3 id="1-1-4-事务"><a href="#1-1-4-事务" class="headerlink" title="1.1.4 事务"></a>1.1.4 事务</h3><ul>
<li><p>传统关系型数据库能满足事务ACID的原则。</p>
</li>
<li><p>而非关系型数据库往往不支持事务，或者不能严格保证ACID的特性，只能实现基本的一致性。</p>
</li>
</ul>
<h3 id="1-1-5-总结"><a href="#1-1-5-总结" class="headerlink" title="1.1.5 总结"></a>1.1.5 总结</h3><p>除了上述四点以外，在存储方式、扩展性、查询性能上关系型与非关系型也都有着显著差异，总结如下：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/Redis/SQL%E4%B8%8ENoSQL%E6%80%BB%E7%BB%93.png" alt="SQL与NoSQL总结"></p>
<ul>
<li>存储方式<ul>
<li>关系型数据库基于磁盘进行存储，会有大量的磁盘IO，对性能有一定影响。</li>
<li>非关系型数据库，他们的操作更多的是依赖于内存来操作，内存的读写速度会非常快，性能自然会好一些。</li>
</ul>
</li>
</ul>
<ul>
<li>扩展性<ul>
<li>关系型数据库集群模式一般是主从，主从数据一致，起到数据备份的作用，称为垂直扩展。</li>
<li>非关系型数据库可以将数据拆分，存储在不同机器上，可以保存海量数据，解决内存大小有限的问题。称为水平扩展。</li>
<li>关系型数据库因为表之间存在关联关系，如果做水平扩展会给数据查询带来很多麻烦。</li>
</ul>
</li>
</ul>
<h2 id="1-2-认识Redis"><a href="#1-2-认识Redis" class="headerlink" title="1.2 认识Redis"></a>1.2 认识Redis</h2><p>redis诞生于2009年全称是 <strong>Re</strong>mote  <strong>D</strong>ictionary <strong>S</strong>erver 远程词典服务器，是一个基于内存的键值型NoSQL数据库。</p>
<p>redis的官方网站地址：<a href="https://redis.io/">https://redis.io/</a></p>
<p><strong>特征</strong>：</p>
<ul>
<li>键值（key-value）型，value支持多种不同数据结构，功能丰富。</li>
<li>单线程，每个命令具备原子性。</li>
<li>低延迟，速度快（基于内存、IO多路复用、良好的编码）。</li>
<li>支持数据持久化。</li>
<li>支持主从集群、分片集群。</li>
<li>支持多语言客户端。</li>
</ul>
<p><strong>作者</strong>：Salvatore Sanfilippo（网名：Antirez）</p>
<p>PS：redis的作者Antirez由于部分原因早在2020年就宣布退隐不在维护redis了。<a href="https://blog.csdn.net/yellowzf3/article/details/119814114">再见了，Redis之父！</a>，不过他是一个挺有趣的人，有兴趣的话可以在网上查看一下关于他的其他信息。</p>
<h1 id="2-Redis常见命令"><a href="#2-Redis常见命令" class="headerlink" title="2. Redis常见命令"></a>2. Redis常见命令</h1><p>redis是典型的 <code>key-value</code> 数据库，key一般是字符串，而value包含很多不同的数据类型：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/Redis/value%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B.png" alt="value数据类型"></p>
<p>redis为了方便我们学习，将操作不同数据类型的命令也做了分组，在<a href="https://redis.io/commands">官网</a>可以查看到不同的命令：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/Redis/%E5%AE%98%E7%BD%91%E6%9F%A5%E7%9C%8Bredis%E5%91%BD%E4%BB%A4.png" alt="官网查看redis命令"></p>
<p>PS：英语不好的小伙伴也可以参考redis中文网的<a href="https://www.redis.net.cn/order/">redis命令手册</a>😀。</p>
<p>不同类型的命令称为一个<code>group</code>，我们也可以通过 <code>help</code> 命令来查看各种不同group的命令：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/Redis/%E6%9F%A5%E7%9C%8B%E5%90%84%E7%A7%8D%E4%B8%8D%E5%90%8Cgroup%E7%9A%84%E5%91%BD%E4%BB%A4.png" alt="查看各种不同group的命令"></p>
<p>接下来，我们就学习常见的五种基本数据类型的相关命令。</p>
<h2 id="2-1-Redis通用命令"><a href="#2-1-Redis通用命令" class="headerlink" title="2.1 Redis通用命令"></a>2.1 Redis通用命令</h2><p>通用指令是部分数据类型的，都可以使用的指令，常见的有：</p>
<ul>
<li>KEYS：查看符合模板的所有key</li>
<li>DEL：删除一个指定的key</li>
<li>EXISTS：判断key是否存在</li>
<li>EXPIRE：给一个key设置有效期，有效期到期时该key会被自动删除</li>
<li>TTL：查看一个KEY的剩余有效期</li>
</ul>
<p>通过 <code>help [command]</code> 可以查看一个命令的具体用法，例如：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看keys命令的帮助信息：</span></span><br><span class="line">127.0.0.1:6379&gt; help keys</span><br><span class="line"></span><br><span class="line">KEYS pattern</span><br><span class="line">summary: Find all keys matching the given pattern</span><br><span class="line">since: 1.0.0</span><br><span class="line">group: generic</span><br></pre></td></tr></table></figure>

<h2 id="2-2-String类型"><a href="#2-2-String类型" class="headerlink" title="2.2 String类型"></a>2.2 String类型</h2><p>String类型，也就是字符串类型，是redis中最简单的存储类型。</p>
<p>其value是字符串，不过根据字符串的格式不同，又可以分为3类：</p>
<ul>
<li><code>string</code>：普通字符串</li>
<li><code>int</code>：整数类型，可以做自增、自减操作</li>
<li><code>float</code>：浮点类型，可以做自增、自减操作</li>
</ul>
<p>不管是哪种格式，底层都是字节数组形式存储，只不过是编码方式不同。字符串类型的最大空间不能超过512m.</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/Redis/String%E7%B1%BB%E5%9E%8B%E5%AD%98%E5%82%A8.png" alt="String类型存储"></p>
<h3 id="2-2-1-String的常见命令"><a href="#2-2-1-String的常见命令" class="headerlink" title="2.2.1 String的常见命令"></a>2.2.1 String的常见命令</h3><p>String的常见命令：</p>
<table>
<thead>
<tr>
<th align="center">命令</th>
<th align="center">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><strong>SET</strong> key value</td>
<td align="center">添加或者修改已经存在的一个String类型的键值对</td>
</tr>
<tr>
<td align="center"><strong>GET</strong> key</td>
<td align="center">根据key获取String类型的value，如果key不存在，返回 <code>nil</code> 。如果key储存的值不是字符串类型，返回一个错误。</td>
</tr>
<tr>
<td align="center"><strong>MSET</strong> key1 value1 key2 value2 .. keyN valueN</td>
<td align="center">批量添加多个String类型的键值对</td>
</tr>
<tr>
<td align="center"><strong>MGET</strong> key1 key2 .. keyN</td>
<td align="center">根据多个key获取多个String类型的value</td>
</tr>
<tr>
<td align="center"><strong>INCR</strong> key</td>
<td align="center">让一个整型的key自增1</td>
</tr>
<tr>
<td align="center"><strong>INCRBY</strong> key incr_amount</td>
<td align="center">让一个整型的key自增并指定步长，例如：incrby num 2 让num值自增2</td>
</tr>
<tr>
<td align="center"><strong>INCRBYFLOAT</strong> key incr_amount</td>
<td align="center">让一个浮点类型的数字自增并指定步长</td>
</tr>
<tr>
<td align="center"><strong>SETNX</strong> key value</td>
<td align="center">添加一个String类型的键值对，前提是这个key不存在，否则不执行</td>
</tr>
<tr>
<td align="center"><strong>SETEX</strong> key timeout value</td>
<td align="center">添加一个String类型的键值对，并且指定有效期</td>
</tr>
</tbody></table>
<h3 id="2-2-2-Key结构"><a href="#2-2-2-Key结构" class="headerlink" title="2.2.2 Key结构"></a>2.2.2 Key结构</h3><p>redis没有类似MySQL中的Table的概念，我们该如何区分不同类型的key呢？</p>
<p>例如，需要存储用户、商品信息到redis，有一个用户id是1，有一个商品id恰好也是1，此时如果使用id作为key，那就会冲突了，该怎么办？</p>
<p>我们可以通过给key添加前缀加以区分，不过这个前缀不是随便加的，有一定的规范：</p>
<p>redis的key允许有多个单词形成层级结构，多个单词之间用 <code>:</code> 隔开，格式如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">项目名:业务名:类型:id</span><br></pre></td></tr></table></figure>

<p>这个格式并非固定，也可以根据自己的需求来删除或添加词条。这样以来，我们就可以把不同类型的数据区分开了。从而避免了key的冲突问题。</p>
<p>例如我们的项目名称叫 heima，有user和product两种不同类型的数据，我们可以这样定义key：</p>
<ul>
<li><p>user相关的key：<strong>heima:user:1</strong></p>
</li>
<li><p>product相关的key：<strong>heima:product:1</strong></p>
</li>
</ul>
<p>如果Value是一个Java对象，例如一个User对象，则可以将对象序列化为JSON字符串后存储：</p>
<table>
<thead>
<tr>
<th align="center"><strong>KEY</strong></th>
<th align="center"><strong>VALUE</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="center">heima:user:1</td>
<td align="center">{“id”:1,  “name”: “Jack”, “age”: 21}</td>
</tr>
<tr>
<td align="center">heima:product:1</td>
<td align="center">{“id”:1,  “name”: “小米11”, “price”: 4999}</td>
</tr>
</tbody></table>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">set heima:user:1 &#x27;&#123;&quot;id&quot;:1,  &quot;name&quot;: &quot;Jack&quot;, &quot;age&quot;: 21&#125;&#x27;</span><br><span class="line">set heima:product:1 &#x27;&#123;&quot;id&quot;:1,  &quot;name&quot;: &quot;小米11&quot;, &quot;price&quot;: 4999&#125;&#x27;</span><br></pre></td></tr></table></figure>

<p>PS：注意JSON字符串外面包裹一个<code>&#39; &#39;</code></p>
<p>并且，在redis的桌面客户端中，还会以相同前缀作为层级结构，让数据看起来层次分明，关系清晰：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/Redis/redis%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%9B%B8%E5%90%8C%E5%89%8D%E7%BC%80%E4%BD%9C%E4%B8%BA%E5%B1%82%E7%BA%A7%E7%BB%93%E6%9E%84.png" alt="redis客户端相同前缀作为层级结构"></p>
<h2 id="2-3-Hash类型"><a href="#2-3-Hash类型" class="headerlink" title="2.3 Hash类型"></a>2.3 Hash类型</h2><p>Hash类型，也叫散列，其value是一个无序字典，类似于Java中的HashMap结构。</p>
<p>String结构是将对象序列化为JSON字符串后存储，当需要修改对象某个字段时很不方便：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/Redis/%E5%AF%B9%E8%B1%A1%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%BAJSON%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%90%8E%E5%AD%98%E5%82%A8.png" alt="对象序列化为JSON字符串后存储"></p>
<p>Hash结构可以将对象中的每个字段独立存储，可以针对单个字段做CRUD：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/Redis/%E5%AF%B9%E8%B1%A1%E4%B8%AD%E6%AF%8F%E4%B8%AA%E5%AD%97%E6%AE%B5%E7%8B%AC%E7%AB%8B%E5%AD%98%E5%82%A8.png" alt="对象中每个字段独立存储"></p>
<p>Hash的常见命令有：</p>
<table>
<thead>
<tr>
<th align="center">命令</th>
<th align="center">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><strong>HSET</strong> key field value</td>
<td align="center">添加或者修改hash类型key的field的值</td>
</tr>
<tr>
<td align="center"><strong>HGET</strong> key field</td>
<td align="center">获取一个hash类型key的field的值</td>
</tr>
<tr>
<td align="center"><strong>HMSET</strong> key fifld1 value1 …fifldN valueN</td>
<td align="center">批量添加多个hash类型key的field的值</td>
</tr>
<tr>
<td align="center"><strong>HMGET</strong> key fifld1…fifldN</td>
<td align="center">批量获取多个hash类型key的field的值</td>
</tr>
<tr>
<td align="center"><strong>HGETALL</strong> key</td>
<td align="center">获取一个hash类型的key中的所有的field和value</td>
</tr>
<tr>
<td align="center"><strong>HKEYS</strong> key fifld incr_by_number</td>
<td align="center">获取一个hash类型的key中的所有的field</td>
</tr>
<tr>
<td align="center"><strong>HINCRBY</strong> key fifld incr_by_number</td>
<td align="center">让一个hash类型key的字段值自增并指定步长</td>
</tr>
<tr>
<td align="center"><strong>HSETNX</strong> key fifld value</td>
<td align="center">添加一个hash类型的key的field值，前提是这个field不存在，否则不执行</td>
</tr>
</tbody></table>
<h2 id="2-4-List类型"><a href="#2-4-List类型" class="headerlink" title="2.4 List类型"></a>2.4 List类型</h2><p>redis中的List类型与Java中的LinkedList类似，可以看做是一个双向链表结构。既可以支持正向检索和也可以支持反向检索。</p>
<p>特征也与LinkedList类似：</p>
<ul>
<li>有序</li>
<li>元素可以重复</li>
<li>插入和删除快</li>
<li>查询速度一般</li>
</ul>
<p>常用来存储一个有序数据，例如：朋友圈点赞列表，评论列表等。</p>
<p>List的常见命令：</p>
<table>
<thead>
<tr>
<th align="center">命令</th>
<th align="center">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><strong>LPUSH</strong> key value1.. valueN</td>
<td align="center">向列表左侧插入一个或多个元素</td>
</tr>
<tr>
<td align="center"><strong>LPOP</strong> key</td>
<td align="center">移除并返回列表左侧的第一个元素，没有则返回 <code>nil</code></td>
</tr>
<tr>
<td align="center"><strong>LPUSH</strong> key value1.. valueN</td>
<td align="center">向列表右侧插入一个或多个元素</td>
</tr>
<tr>
<td align="center"><strong>RPOP</strong> key</td>
<td align="center">移除并返回列表右侧的第一个元素</td>
</tr>
<tr>
<td align="center"><strong>LRANGE</strong> key star end</td>
<td align="center">返回一段角标范围内的所有元素</td>
</tr>
<tr>
<td align="center"><strong>BLPOP&#x2F;BRPOP</strong> list1 list2 .. listN timeout</td>
<td align="center">与LPOP和RPOP类似，只不过在没有元素时等待指定时间，而不是直接返回 <code>nil</code></td>
</tr>
</tbody></table>
<h2 id="2-5-Set类型"><a href="#2-5-Set类型" class="headerlink" title="2.5 Set类型"></a>2.5 Set类型</h2><p>redis的Set结构与Java中的HashSet类似，可以看做是一个value为null的HashMap。因为也是一个hash表，因此具备与HashSet类似的特征：</p>
<ul>
<li><p>无序</p>
</li>
<li><p>元素不可重复</p>
</li>
<li><p>查找快</p>
</li>
<li><p>支持交集、并集、差集等功能</p>
</li>
</ul>
<p>Set的常见命令：</p>
<table>
<thead>
<tr>
<th align="center">命令</th>
<th align="center">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><strong>SADD</strong> key value1 .. valueN</td>
<td align="center">向set中添加一个或多个元素</td>
</tr>
<tr>
<td align="center"><strong>SREM</strong> key member1 .. memberN</td>
<td align="center">移除set中的指定元素</td>
</tr>
<tr>
<td align="center"><strong>SCARD</strong> key</td>
<td align="center">返回set中元素的个数</td>
</tr>
<tr>
<td align="center"><strong>SISMEMBER</strong> key value</td>
<td align="center">判断一个元素是否存在于set中</td>
</tr>
<tr>
<td align="center"><strong>SMEMBERS</strong> key value</td>
<td align="center">获取set中的所有元素</td>
</tr>
<tr>
<td align="center"><strong>SINTER</strong> key key1 .. keyN</td>
<td align="center">求key1与key2的交集</td>
</tr>
</tbody></table>
<p>例如两个集合：s1和s2</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/Redis/%E4%B8%A4%E4%B8%AA%E9%9B%86%E5%90%88s1%E5%92%8Cs2.png" alt="两个集合s1和s2"></p>
<p>求交集：<code>SINTER s1 s2</code>，求s1与s2的不同：<code>SDIFF s1 s2</code> ：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/Redis/s1%E5%92%8Cs2%E5%85%B3%E7%B3%BB.png" alt="s1和s2关系"></p>
<h2 id="2-6-SortedSet类型"><a href="#2-6-SortedSet类型" class="headerlink" title="2.6 SortedSet类型"></a>2.6 SortedSet类型</h2><p>redis的SortedSet是一个可排序的set集合，与Java中的TreeSet有些类似，但底层数据结构却差别很大。SortedSet中的每一个元素都带有一个score属性，可以基于score属性对元素排序，底层的实现是一个跳表（SkipList）加 hash表。</p>
<p>SortedSet具备下列特性：</p>
<ul>
<li>可排序</li>
<li>元素不重复</li>
<li>查询速度快</li>
</ul>
<p>因为SortedSet的可排序特性，所以经常被用来实现排行榜这样的功能。</p>
<p>SortedSet的常见命令有：</p>
<table>
<thead>
<tr>
<th align="center">命令</th>
<th align="center">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><strong>ZADD</strong> key score1 value1 .. scoreN  valueN</td>
<td align="center">添加一个或多个元素到sorted set ，如果已经存在则更新其score值</td>
</tr>
<tr>
<td align="center"><strong>ZREM</strong> key member</td>
<td align="center">删除sorted set中的一个指定元素</td>
</tr>
<tr>
<td align="center"><strong>ZSCORE</strong> key member</td>
<td align="center">获取sorted set中的指定元素的score值</td>
</tr>
<tr>
<td align="center"><strong>ZRANK</strong> key member</td>
<td align="center">获取sorted set 中的指定元素的排名</td>
</tr>
<tr>
<td align="center"><strong>ZCARD</strong> key</td>
<td align="center">获取sorted set中的元素个数</td>
</tr>
<tr>
<td align="center"><strong>ZCOUNT</strong> key min max</td>
<td align="center">统计score值在给定范围内的所有元素的个数</td>
</tr>
<tr>
<td align="center"><strong>ZINCRBY</strong> key increment member</td>
<td align="center">让sorted set中的指定元素自增，步长为指定的increment值</td>
</tr>
<tr>
<td align="center"><strong>ZRANGE</strong> key start stop</td>
<td align="center">按照score排序后，获取指定排名范围内的元素</td>
</tr>
<tr>
<td align="center"><strong>ZRANGEBYSCORE</strong> key min max</td>
<td align="center">按照score排序后，获取指定score范围内的元素</td>
</tr>
<tr>
<td align="center"><strong>ZDIFF</strong>、<strong>ZINTER</strong>、<strong>ZUNION</strong></td>
<td align="center">求差集、交集、并集</td>
</tr>
</tbody></table>
<p>PS：所有的排名默认都是升序，如果要降序则在命令的Z后面添加 <code>REV</code> 即可，例如：</p>
<ul>
<li><p><strong>升序</strong>获取sorted set 中的指定元素的排名：<code>ZRANK key member</code></p>
</li>
<li><p><strong>降序</strong>获取sorted set 中的指定元素的排名：<code>ZREVRANK key memeber</code></p>
</li>
</ul>
<h1 id="3-Redis的Java客户端"><a href="#3-Redis的Java客户端" class="headerlink" title="3. Redis的Java客户端"></a>3. Redis的Java客户端</h1><p>前面我们讲解了redis的常用命令，这些命令是我们操作redis的基础，那么我们在java程序中应该如何操作redis呢？这就需要使用redis的Java客户端，就如同我们使用JDBC操作MySQL数据库一样。在redis官网中提供了各种语言的客户端，地址：<a href="https://redis.io/docs/clients/">https://redis.io/docs/clients/</a></p>
<p>对于Java客户端而言，目前<a href="https://redis.io/docs/latest/develop/connect/clients/java/">官方推荐</a>两种方式：</p>
<ul>
<li>Jedis, for synchronous applications.</li>
<li>Lettuce, for asynchronous and reactive applications.</li>
</ul>
<p>Jedis和Lettuce这两个主要是提供了redis命令对应的API，方便我们操作redis，而SpringDataRedis又对这两种做了抽象和封装，因此我们后期会直接以SpringDataRedis来学习。</p>
<h2 id="3-1-Jedis客户端"><a href="#3-1-Jedis客户端" class="headerlink" title="3.1 Jedis客户端"></a>3.1 Jedis客户端</h2><p>Jedis的官网地址： <a href="https://github.com/redis/jedis">https://github.com/redis/jedis</a></p>
<h3 id="3-1-1-快速入门"><a href="#3-1-1-快速入门" class="headerlink" title="3.1.1 快速入门"></a>3.1.1 快速入门</h3><p>1、引入依赖：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--jedis--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>redis.clients<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jedis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 单元测试 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.junit.jupiter<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit-jupiter-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.10.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>2、建立连接</p>
<p>新建一个单元测试类，内容如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> Jedis jedis;</span><br><span class="line"></span><br><span class="line"><span class="meta">@BeforeEach</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">setUp</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 1.建立连接</span></span><br><span class="line">    jedis = <span class="keyword">new</span> <span class="title class_">Jedis</span>(<span class="string">&quot;192.168.88.132&quot;</span>, <span class="number">6379</span>);</span><br><span class="line">    <span class="comment">//jedis = JedisConnectionFactory.getJedis();</span></span><br><span class="line">    <span class="comment">// 2.设置密码</span></span><br><span class="line">    jedis.auth(<span class="string">&quot;123456&quot;</span>);</span><br><span class="line">    <span class="comment">// 3.选择库，默认0</span></span><br><span class="line">    jedis.select(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3、测试：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testString</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 存入数据</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> jedis.set(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;木又枯了&quot;</span>);</span><br><span class="line">    System.out.println(<span class="string">&quot;result = &quot;</span> + result);	<span class="comment">// result = OK</span></span><br><span class="line">    <span class="comment">// 获取数据</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> jedis.get(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">    System.out.println(<span class="string">&quot;name = &quot;</span> + name);	<span class="comment">// name = 木又枯了</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testHash</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 插入hash数据</span></span><br><span class="line">    jedis.hset(<span class="string">&quot;user:1&quot;</span>, <span class="string">&quot;name&quot;</span>, <span class="string">&quot;Jack&quot;</span>);</span><br><span class="line">    jedis.hset(<span class="string">&quot;user:1&quot;</span>, <span class="string">&quot;age&quot;</span>, <span class="string">&quot;21&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取</span></span><br><span class="line">    Map&lt;String, String&gt; map = jedis.hgetAll(<span class="string">&quot;user:1&quot;</span>);</span><br><span class="line">    System.out.println(map);	<span class="comment">// &#123;name=Jack, age=21&#125;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>4、释放资源</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@AfterEach</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">tearDown</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (jedis != <span class="literal">null</span>) &#123;</span><br><span class="line">        jedis.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-1-2-连接池"><a href="#3-1-2-连接池" class="headerlink" title="3.1.2 连接池"></a>3.1.2 连接池</h3><p>Jedis本身是线程不安全的，并且频繁的创建和销毁连接会有性能损耗，因此我们推荐大家使用Jedis连接池代替Jedis的直连方式。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JedisConnectionFactory</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> JedisPool jedisPool;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="comment">// 配置连接池</span></span><br><span class="line">        <span class="type">JedisPoolConfig</span> <span class="variable">poolConfig</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JedisPoolConfig</span>();</span><br><span class="line">        poolConfig.setMaxTotal(<span class="number">8</span>);</span><br><span class="line">        poolConfig.setMaxIdle(<span class="number">8</span>);</span><br><span class="line">        poolConfig.setMinIdle(<span class="number">0</span>);</span><br><span class="line">        poolConfig.setMaxWaitMillis(<span class="number">1000</span>);</span><br><span class="line">        <span class="comment">// 创建连接池对象，参数：连接池配置、服务端ip、服务端端口、超时时间、密码</span></span><br><span class="line">        jedisPool = <span class="keyword">new</span> <span class="title class_">JedisPool</span>(poolConfig, <span class="string">&quot;192.168.88.132&quot;</span>, <span class="number">6379</span>, <span class="number">1000</span>, <span class="string">&quot;123456&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Jedis <span class="title function_">getJedis</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> jedisPool.getResource();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-2-SpringDataRedis客户端"><a href="#3-2-SpringDataRedis客户端" class="headerlink" title="3.2 SpringDataRedis客户端"></a>3.2 SpringDataRedis客户端</h2><p>SpringData是Spring中数据操作的模块，包含对各种数据库的集成，其中对redis的集成模块就叫做SpringDataRedis，官网地址：<a href="https://spring.io/projects/spring-data-redis">https://spring.io/projects/spring-data-redis</a></p>
<ul>
<li>提供了对不同redis客户端的整合（Lettuce和Jedis）</li>
<li>提供了RedisTemplate统一API来操作redis</li>
<li>支持redis的发布订阅模型</li>
<li>支持redis哨兵和redis集群</li>
<li>支持基于Lettuce的响应式编程</li>
<li>支持基于JDK、JSON、字符串、Spring对象的数据序列化及反序列化</li>
<li>支持基于redis的JDKCollection实现</li>
</ul>
<p>SpringDataRedis中提供了RedisTemplate工具类，其中封装了各种对redis的操作。并且将不同数据类型的操作API封装到了不同的类型中：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/Redis/RedisTemplate%E5%B0%81%E8%A3%85%E7%9A%84%E6%93%8D%E4%BD%9C.png" alt="RedisTemplate封装的操作"></p>
<h3 id="3-2-1-快速入门"><a href="#3-2-1-快速入门" class="headerlink" title="3.2.1 快速入门"></a>3.2.1 快速入门</h3><p>SpringBoot已经提供了对SpringDataRedis的支持，使用非常简单。PS：这里使用的是SpringBoot的3.2.5版本。</p>
<p>首先，新建一个SpringBoot项目，勾选Spring Data Redis(Access + Driver)和 Lambook依赖，然后按照下面步骤执行：</p>
<p>1、引入依赖</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--redis依赖--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--勾选Spring Data Redis(Access + Driver)自动引入--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--common-pool连接池--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-pool2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>2、配置redis</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">data:</span></span><br><span class="line">    <span class="attr">redis:</span></span><br><span class="line">      <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.88</span><span class="number">.132</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">6379</span></span><br><span class="line">      <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">      <span class="attr">lettuce:</span></span><br><span class="line">        <span class="attr">pool:</span></span><br><span class="line">          <span class="attr">max-active:</span> <span class="number">8</span></span><br><span class="line">          <span class="attr">max-idle:</span> <span class="number">8</span></span><br><span class="line">          <span class="attr">min-idle:</span> <span class="number">0</span></span><br><span class="line">          <span class="attr">max-wait:</span> <span class="string">100ms</span></span><br></pre></td></tr></table></figure>

<p>PS：SpringDataRedis默认引入的是 <code>lettuce</code>，必须要手动配置lettuce的 <code>pool</code> 连接池才会生效。</p>
<p>3、注入RedisTemplate</p>
<p>因为有了SpringBoot的自动装配，我们可以拿来就用：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RedisStringTests</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>4、编写测试</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testString</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 写入一条String数据</span></span><br><span class="line">    redisTemplate.opsForValue().set(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;木又枯了&quot;</span>);</span><br><span class="line">    <span class="comment">// 获取string数据</span></span><br><span class="line">    <span class="type">Object</span> <span class="variable">name</span> <span class="operator">=</span> redisTemplate.opsForValue().get(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">    System.out.println(<span class="string">&quot;name = &quot;</span> + name);	<span class="comment">// name = 木又枯了</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testSaveUser</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 写入数据</span></span><br><span class="line">    redisTemplate.opsForValue().set(<span class="string">&quot;user:100&quot;</span>, <span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;木又枯了&quot;</span>, <span class="number">18</span>));</span><br><span class="line">    <span class="comment">//获取数据</span></span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> (User) redisTemplate.opsForValue().get(<span class="string">&quot;user:100&quot;</span>);</span><br><span class="line">    System.out.println(<span class="string">&quot;user = &quot;</span> + user);	<span class="comment">// user = User(name=木又枯了, age=18)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-2-2-自定义序列化"><a href="#3-2-2-自定义序列化" class="headerlink" title="3.2.2 自定义序列化"></a>3.2.2 自定义序列化</h3><p>RedisTemplate可以接收任意Object作为值写入redis：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/Redis/%E6%8E%A5%E6%94%B6%E4%BB%BB%E6%84%8FObject%E4%BD%9C%E4%B8%BA%E5%80%BC.png" alt="接收任意Object作为值"></p>
<p>只不过写入前会把Object序列化为字节形式，默认是采用JDK序列化工具<code>ObjectOutputStream</code>，得到的结果是这样的：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/Redis/Object%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%BA%E5%AD%97%E8%8A%82%E5%BD%A2%E5%BC%8F.png" alt="Object序列化为字节形式"></p>
<p>缺点：</p>
<ul>
<li>可读性差</li>
<li>内存占用较大</li>
</ul>
<p>我们可以 <code>自定义RedisTemplate</code> 的序列化方式：</p>
<p>1、引入依赖：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--Jackson依赖--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-databind<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>2、编写RedisConfig：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RedisTemplate&lt;String, Object&gt; <span class="title function_">redisTemplate</span><span class="params">(RedisConnectionFactory connectionFactory)</span> &#123;</span><br><span class="line">        <span class="comment">// 创建RedisTemplate对象</span></span><br><span class="line">        RedisTemplate&lt;String, Object&gt; template = <span class="keyword">new</span> <span class="title class_">RedisTemplate</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">// 设置连接工厂</span></span><br><span class="line">        template.setConnectionFactory(connectionFactory);</span><br><span class="line">        <span class="comment">// 设置Key的序列化</span></span><br><span class="line">        template.setKeySerializer(RedisSerializer.string());</span><br><span class="line">        template.setHashKeySerializer(RedisSerializer.string());</span><br><span class="line">        <span class="comment">// 设置Value的序列化</span></span><br><span class="line">        template.setValueSerializer(<span class="keyword">new</span> <span class="title class_">GenericJackson2JsonRedisSerializer</span>());</span><br><span class="line">        template.setHashValueSerializer(<span class="keyword">new</span> <span class="title class_">GenericJackson2JsonRedisSerializer</span>());</span><br><span class="line">        <span class="comment">// 返回</span></span><br><span class="line">        <span class="keyword">return</span> template;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里采用了JSON序列化来代替默认的JDK序列化方式。</p>
<p>3、运行测试</p>
<p>写入name，最终结果如图：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/Redis/JSON%E5%BA%8F%E5%88%97%E5%8C%96name.png" alt="JSON序列化name"></p>
<p>写入一个对象，最终结果如图：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/Redis/JSON%E5%BA%8F%E5%88%97%E5%8C%96%E5%AF%B9%E8%B1%A1.png" alt="JSON序列化对象"></p>
<p>整体可读性有了很大提升，并且能将Java对象自动的序列化为JSON字符串，并且查询时能自动把JSON反序列化为Java对象。不过，其中记录了序列化时对应的class名称，目的是为了查询时实现自动反序列化。这会带来额外的内存开销。</p>
<h3 id="3-2-3-StringRedisTemplate"><a href="#3-2-3-StringRedisTemplate" class="headerlink" title="3.2.3 StringRedisTemplate"></a>3.2.3 StringRedisTemplate</h3><p>为了节省内存空间，我们可以不使用JSON序列化器来处理value，而是统一使用String序列化器，要求只能存储String类型的key和value。当需要存储Java对象时，手动完成对象的序列化和反序列化。</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/Redis/%E6%89%8B%E5%8A%A8%E5%AE%8C%E6%88%90%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8C%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96.png" alt="手动完成对象的序列化和反序列化"></p>
<p>因为存入和读取时的序列化及反序列化都是我们自己实现的，SpringDataRedis就不会将class信息写入Redis了。</p>
<p>这种用法比较普遍，因此SpringDataRedis就提供了RedisTemplate的子类：<code>StringRedisTemplate</code>，它的key和value的序列化方式默认就是 <code>String</code> 方式，源码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StringRedisTemplate</span> <span class="keyword">extends</span> <span class="title class_">RedisTemplate</span>&lt;String, String&gt; &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>这种方式省去了我们自定义 RedisTemplate 的序列化方式的步骤，而是直接使用：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RedisStringTests</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// JSON序列化工具</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ObjectMapper</span> <span class="variable">mapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testSaveUser</span><span class="params">()</span> <span class="keyword">throws</span> JsonProcessingException &#123;</span><br><span class="line">        <span class="comment">// 创建对象</span></span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;木又枯了&quot;</span>, <span class="number">18</span>);</span><br><span class="line">        <span class="comment">// 手动序列化</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> mapper.writeValueAsString(user);</span><br><span class="line">        <span class="comment">// 写入数据</span></span><br><span class="line">        stringRedisTemplate.opsForValue().set(<span class="string">&quot;user:200&quot;</span>, json);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取数据</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">jsonUser</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(<span class="string">&quot;user:200&quot;</span>);</span><br><span class="line">        <span class="comment">// 手动反序列化</span></span><br><span class="line">        <span class="type">User</span> <span class="variable">user1</span> <span class="operator">=</span> mapper.readValue(jsonUser, User.class);</span><br><span class="line">        System.out.println(<span class="string">&quot;user1 = &quot;</span> + user1);     <span class="comment">// user1 = User(name=木又枯了, age=18)</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>写入一个对象，最终结果如图：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/Redis/%E8%87%AA%E5%AE%9A%E4%B9%89RedisTemplate%E5%BA%8F%E5%88%97%E5%8C%96%E7%BB%93%E6%9E%9C.png" alt="自定义RedisTemplate序列化结果"></p>
<blockquote>
<p>使用fastjson2实现序列化与反序列化</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- fastjson2 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.fastjson2<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.49<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testSaveUser</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 创建对象</span></span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;木又枯了&quot;</span>, <span class="number">18</span>);</span><br><span class="line">    <span class="comment">// 手动序列化</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> JSON.toJSONString(user);</span><br><span class="line">    <span class="comment">// 写入数据</span></span><br><span class="line">    stringRedisTemplate.opsForValue().set(<span class="string">&quot;user:200&quot;</span>, json);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取数据</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">jsonUser</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(<span class="string">&quot;user:200&quot;</span>);</span><br><span class="line">    <span class="comment">// 手动反序列化</span></span><br><span class="line">    <span class="type">User</span> <span class="variable">user1</span> <span class="operator">=</span> JSON.parseObject(jsonUser, User.class);</span><br><span class="line">    System.out.println(<span class="string">&quot;user1 = &quot;</span> + user1);     <span class="comment">// user1 = User(name=木又枯了, age=18)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>DB</category>
      </categories>
      <tags>
        <tag>Redis</tag>
      </tags>
  </entry>
  <entry>
    <title>Redis安装</title>
    <url>/posts/34539/</url>
    <content><![CDATA[<h1 id="0-前言"><a href="#0-前言" class="headerlink" title="0. 前言"></a>0. 前言</h1><p>大多数企业都是基于Linux服务器来部署项目，并且redis官方也没有提供Windows版本的安装包。因此我们基于Linux系统来安装redis。</p>
<p>PS：此处选择的Linux版本为CentOS7。</p>
<h1 id="1-Redis下载"><a href="#1-Redis下载" class="headerlink" title="1. Redis下载"></a>1. Redis下载</h1><p>官方Linux版本下载官网：<a href="https://download.redis.io/releases">https://download.redis.io/releases</a></p>
<p>进去后下载自己喜欢的版本就行了😄，我这里下载的是 <code>redis-7.0.15</code> 版本。</p>
<p>但是如果你非得要在Window上安装个redis玩玩，那肯定也有办法咯😎：</p>
<ul>
<li>微软官方维护的支持Windows平台的<a href="https://github.com/microsoftarchive/redis/releases">redis安装包</a>。不过早就不更新了，跟redis官网相差了好几个大版本。</li>
<li>GitHub的tporadowski大佬也提供了支持Windows平台的<a href="https://github.com/tporadowski/redis/releases">redis安装包</a>。目前仍在维护，最新版本是5.0.14，更新速度跟redis官网也相差好几个大版本。</li>
</ul>
<p>PS：尽管Windows版本与Linux版本相差好几个大版本，但是下载到Window电脑上自己玩玩也够用😶。自行按需选择吧。</p>
<h1 id="2-单机安装Redis"><a href="#2-单机安装Redis" class="headerlink" title="2. 单机安装Redis"></a>2. 单机安装Redis</h1><h2 id="2-1-安装Redis依赖"><a href="#2-1-安装Redis依赖" class="headerlink" title="2.1 安装Redis依赖"></a>2.1 安装Redis依赖</h2><p>redis是基于C语言编写的，因此首先需要安装redis所需要的gcc依赖：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">yum install -y gcc tcl</span><br></pre></td></tr></table></figure>

<h2 id="2-2-上传安装包并解压"><a href="#2-2-上传安装包并解压" class="headerlink" title="2.2 上传安装包并解压"></a>2.2 上传安装包并解压</h2><p>1、将redis安装包上传到虚拟机的任意目录。我这里放到了 <code>/</code> 目录：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/Redis/redis%E5%AE%89%E8%A3%85%E5%8C%85.png" alt="redis安装包">

<p>2、解压到 <code>/usr/local/</code> 目录：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">解压缩安装文件到 /usr/local 目录</span></span><br><span class="line">tar -zxvf redis-7.0.15.tar.gz -C /usr/local</span><br></pre></td></tr></table></figure>

<p>解压后：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/Redis/%E8%A7%A3%E5%8E%8B%E5%BE%97%E5%88%B0%E7%9A%84redis%E6%96%87%E4%BB%B6%E5%A4%B9.png" alt="解压得到的redis文件夹">

<p>3、进入redis目录：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cd redis-7.0.15</span><br></pre></td></tr></table></figure>

<p>4、运行编译命令：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure>

<p>执行命令后需要等待的时间可能较长，需要耐心等待，如果没有出错，应该就安装成功了。</p>
<p>默认的安装路径是在 <code>/usr/local/bin</code> 目录下：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/Redis/redis%E5%AE%89%E8%A3%85%E8%B7%AF%E5%BE%84.png" alt="redis安装路径">

<p><font color="red"><strong>PS：该目录默认已经配置到环境变量，因此可以在任意目录下运行这些命令。</strong></font>其中：</p>
<ul>
<li><code>redis-cli</code>：是redis提供的命令行客户端。</li>
<li><code>redis-server</code>：是redis的服务端启动脚本。</li>
<li><code>redis-sentinel</code>：是redis的哨兵启动脚本。</li>
</ul>
<h2 id="2-3-启动"><a href="#2-3-启动" class="headerlink" title="2.3 启动"></a>2.3 启动</h2><p>redis的启动方式有很多种，例如：</p>
<ul>
<li>默认启动</li>
<li>指定配置启动</li>
<li>开机自启</li>
</ul>
<h3 id="2-3-1-默认启动"><a href="#2-3-1-默认启动" class="headerlink" title="2.3.1 默认启动"></a>2.3.1 默认启动</h3><p>安装完成后，在任意目录输入redis-server命令即可启动redis：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">redis-server</span><br></pre></td></tr></table></figure>

<p>如图：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/Redis/redis%E9%BB%98%E8%AE%A4%E5%89%8D%E5%8F%B0%E5%90%AF%E5%8A%A8.png" alt="redis默认前台启动">

<p>这种启动属于 <code>前台启动</code>，会阻塞整个会话窗口，<code>窗口关闭</code> 或 <code>Ctrl + C</code> 则redis停止。不推荐使用。</p>
<h3 id="2-3-2-指定配置启动"><a href="#2-3-2-指定配置启动" class="headerlink" title="2.3.2 指定配置启动"></a>2.3.2 指定配置启动</h3><p>如果要让redis以 <code>后台 </code> 方式启动，则必须修改解压的redis安装包 <code>/usr/local/redis-7.0.15</code> 路径下的 <code>redis.conf</code> 配置文件：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/Redis/redis%E6%8C%87%E5%AE%9A%E9%85%8D%E7%BD%AE%E5%90%8E%E5%8F%B0%E5%90%AF%E5%8A%A8.png" alt="redis指定配置后台启动">

<p>1、我们先将这个配置文件备份一份：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cp redis.conf redis.conf.bck</span><br></pre></td></tr></table></figure>

<p>2、然后修改 <code>redis.conf</code> 文件中的一些配置：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">vim redis.conf</span><br></pre></td></tr></table></figure>

<p>修改的配置如下：</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 允许访问的地址，默认是127.0.0.1，会导致只能在本地访问。修改为0.0.0.0则可以在任意IP访问，生产环境不要设置为0.0.0.0</span></span><br><span class="line"><span class="attr">bind</span> <span class="string">0.0.0.0</span></span><br><span class="line"><span class="comment"># 守护进程，修改为yes后即可后台运行</span></span><br><span class="line"><span class="attr">daemonize</span> <span class="string">yes</span></span><br><span class="line"><span class="comment"># 密码，设置后访问redis必须输入密码</span></span><br><span class="line"><span class="attr">requirepass</span> <span class="string">123456</span></span><br></pre></td></tr></table></figure>

<p>redis的其它常见配置：</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 监听的端口</span></span><br><span class="line"><span class="attr">port</span> <span class="string">6379</span></span><br><span class="line"><span class="comment"># 工作目录，默认是当前目录，也就是运行redis-server时的命令，日志、持久化等文件会保存在这个目录</span></span><br><span class="line"><span class="attr">dir</span> <span class="string">.</span></span><br><span class="line"><span class="comment"># 数据库数量，设置为1，代表只使用1个库，默认有16个库，编号0~15</span></span><br><span class="line"><span class="attr">databases</span> <span class="string">1</span></span><br><span class="line"><span class="comment"># 设置redis能够使用的最大内存</span></span><br><span class="line"><span class="attr">maxmemory</span> <span class="string">512mb</span></span><br><span class="line"><span class="comment"># 日志文件，默认为空，不记录日志，可以指定日志文件名</span></span><br><span class="line"><span class="attr">logfile</span> <span class="string">&quot;redis.log&quot;</span></span><br></pre></td></tr></table></figure>

<p>3、启动redis：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">进入redis安装目录</span> </span><br><span class="line">cd /usr/local/redis-7.0.15</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动</span></span><br><span class="line">redis-server redis.conf</span><br></pre></td></tr></table></figure>

<p>4、查看redis进程是否运行：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ps -ef | grep redis</span><br></pre></td></tr></table></figure>

<p>查看到的信息如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">root       8606      1  0 01:36 ?        00:00:00 redis-server 0.0.0.0:6379</span><br><span class="line">root       8620   3397  0 01:37 pts/0    00:00:00 grep --color=auto redis</span><br></pre></td></tr></table></figure>

<p>5、停止服务：</p>
<p>第一种：使用杀死进程的方式停止redis进程</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">kill -9 8606</span><br></pre></td></tr></table></figure>

<p>第二种：利用 <code>redis-cli</code> 来执行 <code>shutdown</code> 命令停止redis服务</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">因为之前配置了密码，因此需要通过 -a 来指定密码</span></span><br><span class="line">redis-cli -a 123456 shutdown</span><br></pre></td></tr></table></figure>

<h3 id="2-3-3-开机自启"><a href="#2-3-3-开机自启" class="headerlink" title="2.3.3 开机自启"></a>2.3.3 开机自启</h3><p>为了方便，我们也可以通过配置来实现开机自启。</p>
<p>1、新建一个系统服务文件：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">vim /etc/systemd/system/redis.service</span><br></pre></td></tr></table></figure>

<p>内容如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=redis-server</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=forking</span><br><span class="line">ExecStart=/usr/local/bin/redis-server /usr/local/redis-7.0.15/redis.conf</span><br><span class="line">PrivateTmp=true</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>

<p>2、重载系统服务：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">systemctl daemon-reload</span><br></pre></td></tr></table></figure>

<p>3、现在，我们可以用下面这组命令来操作redis了：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动</span></span><br><span class="line">systemctl start redis</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">停止</span></span><br><span class="line">systemctl stop redis</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">重启</span></span><br><span class="line">systemctl restart redis</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看状态</span></span><br><span class="line">systemctl status redis</span><br></pre></td></tr></table></figure>

<p>4、执行下面的命令，可以让redis开机自启：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">systemctl enable redis</span><br></pre></td></tr></table></figure>

<h1 id="3-Redis客户端"><a href="#3-Redis客户端" class="headerlink" title="3. Redis客户端"></a>3. Redis客户端</h1><p>安装完成redis，我们就可以操作redis，实现数据的CRUD了。这需要用到redis客户端，包括：</p>
<ul>
<li>命令行客户端</li>
<li>图形化桌面客户端</li>
<li>编程客户端</li>
</ul>
<h2 id="3-1-Redis命令行客户端"><a href="#3-1-Redis命令行客户端" class="headerlink" title="3.1 Redis命令行客户端"></a>3.1 Redis命令行客户端</h2><p>redis安装完成后就自带了命令行客户端：<code>redis-cli</code>，使用方式如下：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">redis-cli [options] [commonds]</span><br></pre></td></tr></table></figure>

<p>其中常见的options有：</p>
<ul>
<li><code>-h 127.0.0.1</code>：指定要连接的redis节点的IP地址，默认是127.0.0.1</li>
<li><code>-p 6379</code>：指定要连接的redis节点的端口，默认是6379</li>
<li><code>-a 123456</code>：指定redis的访问密码</li>
</ul>
<p>其中的commonds就是redis的操作命令，例如：</p>
<ul>
<li><code>ping</code>：与redis服务端做心跳测试，服务端正常会返回 <code>PONG</code></li>
</ul>
<p>不指定commond时，会进入<code>redis-cli</code> 的交互控制台。</p>
<p>PS：设置了密码但在进入控制台之前未使用 <code>-a</code> 指定密码，进入控制台之后操作命令行客户端会失败，可以使用 <code>auth</code> 命令指定密码：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">auth 123456</span><br></pre></td></tr></table></figure>

<p>之后就可以正常使用redis的命令了：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/Redis/auth%E6%8C%87%E5%AE%9A%E5%AF%86%E7%A0%81%E8%BF%9B%E5%85%A5%E6%8E%A7%E5%88%B6%E5%8F%B0.png" alt="auth指定密码进入控制台"></p>
<h2 id="3-2-图形化桌面客户端"><a href="#3-2-图形化桌面客户端" class="headerlink" title="3.2 图形化桌面客户端"></a>3.2 图形化桌面客户端</h2><p>redis官方并未提供redis的图形化桌面客户端😅，但是没关系，GitHub上的RedisInsight大神编写了redis的图形化桌面客户端。下载地址：<a href="https://github.com/uglide/RedisDesktopManager">https://github.com/uglide/RedisDesktopManager</a></p>
<p>可惜很遗憾，该仓库提供的是RedisDesktopManager的源码，并未提供windows安装包😭。如果你想使用还得自己构建，太麻烦了。</p>
<p>不过好在GitHub的lework大神就解决了这个麻烦，将源码构建成了安装包并且开源了出来供大家免费使用😎！在这个仓库可以找到安装包啦：<a href="https://github.com/lework/RedisDesktopManager-Windows/releases">https://github.com/lework/RedisDesktopManager-Windows/releases</a></p>
<p>下载下面这个zip包就行啦：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/Redis/resp%E5%AE%89%E8%A3%85%E5%8C%85.png" alt="resp安装包" style="zoom: 67%;">

<h3 id="3-2-1-安装"><a href="#3-2-1-安装" class="headerlink" title="3.2.1 安装"></a>3.2.1 安装</h3><p>下载后直接解压运行即可开始安装，安装时使用 <font color="red">“傻瓜式”</font> 安装，无脑下一步即可。<font color="red">PS：注意按自己需求修改安装路径！</font>😏</p>
<h3 id="3-2-2-建立连接"><a href="#3-2-2-建立连接" class="headerlink" title="3.2.2 建立连接"></a>3.2.2 建立连接</h3><p><font color="red"><strong>PS：建立连接之前需要关闭 Linux 系统防火墙或者开放 6379 端口！！！</strong></font></p>
<p>点击左上角的 <code>连接到Redis服务器</code> 按钮：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/Redis/redis%E5%9B%BE%E5%BD%A2%E5%8C%96%E7%95%8C%E9%9D%A2%E5%BB%BA%E7%AB%8B%E8%BF%9E%E6%8E%A5(1).png" alt="redis图形化界面建立连接(1)" style="zoom: 50%;">

<p>在弹出的窗口中选择 <code>连接设置</code> 填写redis服务信息后点击 <code>测试连接</code>：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/Redis/redis%E5%9B%BE%E5%BD%A2%E5%8C%96%E7%95%8C%E9%9D%A2%E5%BB%BA%E7%AB%8B%E8%BF%9E%E6%8E%A5(2).png" alt="redis图形化界面建立连接(2)" style="zoom: 50%;">

<p>弹出连接成功提示框，成功连接：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/Redis/redis%E5%9B%BE%E5%BD%A2%E5%8C%96%E7%95%8C%E9%9D%A2%E5%BB%BA%E7%AB%8B%E8%BF%9E%E6%8E%A5(3).png" alt="redis图形化界面建立连接(3)" style="zoom: 50%;">

<p>点击确定后，在左侧菜单会出现这个链接：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/Redis/redis%E5%9B%BE%E5%BD%A2%E5%8C%96%E7%95%8C%E9%9D%A2%E5%BB%BA%E7%AB%8B%E8%BF%9E%E6%8E%A5(4).png" alt="redis图形化界面建立连接(4)"></p>
<p>点击即可建立连接了：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/Redis/redis%E5%9B%BE%E5%BD%A2%E5%8C%96%E7%95%8C%E9%9D%A2%E5%BB%BA%E7%AB%8B%E8%BF%9E%E6%8E%A5(5).png" alt="redis图形化界面建立连接(5)" style="zoom:50%;">

<p>redis默认有16个仓库，编号从0至15.  通过配置文件可以设置仓库数量，但是不超过16，并且不能自定义仓库名称。</p>
<p>如果是基于 <code>redis-cli</code> 连接redis服务，可以通过select命令来选择数据库：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">选择0号库</span></span><br><span class="line">select 0</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>DB</category>
      </categories>
      <tags>
        <tag>Redis</tag>
      </tags>
  </entry>
  <entry>
    <title>TypeScript极速梳理</title>
    <url>/posts/36186/</url>
    <content><![CDATA[<h1 id="0-前言"><a href="#0-前言" class="headerlink" title="0. 前言"></a>0. 前言</h1><p>我们在学习 Vue 的时候会发现，现在很多的 Vue 开发都是采用 <code>Vue</code> + <code>TypeScript</code> 的方式，对于没接触过 TypeScript  的小伙伴来说脑瓜子肯定懵懵的😵‍💫，可能就要问了：啥是 TypeScript 啊？哥们儿都会 JavaScript 了🤔，为什么还要使用 TypeScript 啊？</p>
<p>下面就来回答一下上面这两个问题吧：</p>
<blockquote>
<p>什么是 TypeScript ？</p>
</blockquote>
<p>TypeScript 是一种由微软开发的自由和开源的编程语言，它是 JavaScript 的一个超集，并添加了静态类型、类、接口和泛型等特性。这意味着你可以在 TypeScript 中编写代码，然后将其编译为纯 JavaScript 代码，以便在任何支持 JavaScript 的环境中运行。</p>
<blockquote>
<p>为什么使用 TypeScript ？</p>
</blockquote>
<p>对于搭配 TypeScript 使用 Vue，<a href="https://cn.vuejs.org/guide/typescript/overview.html">Vue 官方</a>这样介绍：</p>
<p>像 TypeScript 这样的类型系统可以在编译时通过静态分析检测出很多常见错误。这减少了生产环境中的运行时错误，也让我们在重构大型项目的时候更有信心。通过 IDE 中基于类型的自动补全，TypeScript 还改善了开发体验和效率。</p>
<p>Vue 本身就是用 TypeScript 编写的，并对 TypeScript 提供了一等公民的支持。所有的 Vue 官方库都自带了类型声明文件，开箱即用。</p>
<h1 id="1-类型声明"><a href="#1-类型声明" class="headerlink" title="1. 类型声明"></a>1. 类型声明</h1><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="attr">a</span>: <span class="built_in">string</span> <span class="comment">//变量a只能存储字符串</span></span><br><span class="line"><span class="keyword">let</span> <span class="attr">b</span>: <span class="built_in">number</span> <span class="comment">//变量a只能存储数值</span></span><br><span class="line"><span class="keyword">let</span> <span class="attr">c</span>: <span class="built_in">boolean</span> <span class="comment">//变量a只能存储布尔值</span></span><br><span class="line">a = <span class="string">&#x27;hello&#x27;</span></span><br><span class="line">a = <span class="number">100</span> <span class="comment">//警告：不能将类型“number”分配给类型“string”</span></span><br><span class="line">b = <span class="number">666</span></span><br><span class="line">b = <span class="string">&#x27;你好&#x27;</span><span class="comment">//警告：不能将类型“string”分配给类型“number”</span></span><br><span class="line">c = <span class="literal">true</span></span><br><span class="line">c = <span class="number">666</span> <span class="comment">//警告：不能将类型“number”分配给类型“boolean”</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 参数x必须是数字，参数y也必须是数字，函数返回值也必须是数字</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">demo</span>(<span class="params">x: <span class="built_in">number</span>, y: <span class="built_in">number</span></span>): <span class="built_in">number</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> x + y</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">demo</span>(<span class="number">100</span>, <span class="number">200</span>)</span><br><span class="line"><span class="title function_">demo</span>(<span class="number">100</span>, <span class="string">&#x27;200&#x27;</span>) <span class="comment">//警告：类型“string”的参数不能赋给类型“number”的参数</span></span><br><span class="line"><span class="title function_">demo</span>(<span class="number">100</span>, <span class="number">200</span>, <span class="number">300</span>) <span class="comment">//警告：应有 2 个参数，但获得 3 个</span></span><br><span class="line"><span class="title function_">demo</span>(<span class="number">100</span>) <span class="comment">//警告：应有 2 个参数，但获得 1 个</span></span><br></pre></td></tr></table></figure>

<h1 id="2-类型推断"><a href="#2-类型推断" class="headerlink" title="2. 类型推断"></a>2. 类型推断</h1><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> d = -<span class="number">99</span> <span class="comment">//TypeScript会推断出变量d的类型是数字</span></span><br><span class="line">d = <span class="literal">false</span> <span class="comment">//警告：不能将类型“boolean”分配给类型“number”</span></span><br></pre></td></tr></table></figure>

<h1 id="3-类型总览"><a href="#3-类型总览" class="headerlink" title="3. 类型总览"></a>3. 类型总览</h1><blockquote>
<p><code>JavaScript</code> 中的数据类型</p>
</blockquote>
<p><code>string</code> 、<code>number</code> 、<code>boolean</code> 、<code>null</code> 、<code>undefined</code> 、<code>bigint</code> 、<code>symbol</code> 、<code>object</code></p>
<p>PS：其中 <code>object</code> 包含： <code>Array</code> 、<code>Function</code> 、<code>Date</code> 、…</p>
<blockquote>
<p><code>TypeScript</code> 中的数据类型：</p>
</blockquote>
<ul>
<li>以上 JS 所有</li>
<li>四个新类型： <code>void</code> 、<code>never</code> 、<code>unknown</code> 、<code>any</code> 、<code>enum</code> 、<code>tuple</code></li>
<li>自定义类型： <code>type</code> 、<code>interface</code></li>
</ul>
<p>PS： JS 中的这三个构造函数： <code>Number</code> 、<code>String</code> 、<code>Boolean</code>，他们只用于包装对象，正常开发时，很少去使用他们，在 TS 中也是同理。</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> n = <span class="number">56</span></span><br><span class="line">n.<span class="title function_">toFixed</span>(<span class="number">2</span>)</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">当执行n.toFixed(2) ，底层做了这几件事：</span></span><br><span class="line"><span class="comment"> 1.let temp = new Number(42)</span></span><br><span class="line"><span class="comment"> 2.value = temp.toFixed(2)</span></span><br><span class="line"><span class="comment"> 3.删除value</span></span><br><span class="line"><span class="comment"> 4.返回value</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>类型总览</p>
</blockquote>
<table>
<thead>
<tr>
<th align="center">类型</th>
<th align="center">描述</th>
<th align="center">举例</th>
</tr>
</thead>
<tbody><tr>
<td align="center">number</td>
<td align="center">任意数字</td>
<td align="center">1，-33，2.5</td>
</tr>
<tr>
<td align="center">string</td>
<td align="center">任意字符串</td>
<td align="center">‘hello’，’ok’，’你好’</td>
</tr>
<tr>
<td align="center">boolean</td>
<td align="center">布尔值 <code>true</code> 或 <code>false</code></td>
<td align="center">true、false</td>
</tr>
<tr>
<td align="center">字⾯量</td>
<td align="center">值只能是字⾯量值</td>
<td align="center">值本身</td>
</tr>
<tr>
<td align="center">any</td>
<td align="center">任意类型</td>
<td align="center">1、’hello’、true …</td>
</tr>
<tr>
<td align="center">unknown</td>
<td align="center">类型安全的 <code>any</code></td>
<td align="center">1、’hello’ 、true …</td>
</tr>
<tr>
<td align="center">never</td>
<td align="center">不能是任何值</td>
<td align="center">无值</td>
</tr>
<tr>
<td align="center">void</td>
<td align="center">空 或 <code>undefined</code></td>
<td align="center">空 或 <code>undefined</code></td>
</tr>
<tr>
<td align="center">object</td>
<td align="center">任意的 <code>JS</code> 对象</td>
<td align="center">{name:’张三’}</td>
</tr>
<tr>
<td align="center">tuple</td>
<td align="center">元素， <code>TS</code> 新增类型，固定⻓度数组</td>
<td align="center">[4,5]</td>
</tr>
<tr>
<td align="center">enum</td>
<td align="center">枚举， <code>TS</code> 中新增类型</td>
<td align="center">enum{A, B}</td>
</tr>
</tbody></table>
<h1 id="4-常用类型"><a href="#4-常用类型" class="headerlink" title="4. 常用类型"></a>4. 常用类型</h1><h2 id="4-1-字面量"><a href="#4-1-字面量" class="headerlink" title="4.1 字面量"></a>4.1 字面量</h2><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="attr">a</span>: <span class="string">&#x27;你好&#x27;</span> <span class="comment">//a的值只能为字符串“你好”</span></span><br><span class="line"><span class="keyword">let</span> <span class="attr">b</span>: <span class="number">100</span> <span class="comment">//b的值只能为数字100</span></span><br><span class="line">a = <span class="string">&#x27;欢迎&#x27;</span><span class="comment">//警告：不能将类型“&quot;欢迎&quot;”分配给类型“&quot;你好&quot;”</span></span><br><span class="line">b = <span class="number">200</span> <span class="comment">//警告：不能将类型“200”分配给类型“100”</span></span><br><span class="line"><span class="keyword">let</span> <span class="attr">gender</span>: <span class="string">&#x27;男&#x27;</span> | <span class="string">&#x27;女&#x27;</span> <span class="comment">//定义一个gender变量，值只能为字符串“男”或“女”</span></span><br><span class="line">gender = <span class="string">&#x27;男&#x27;</span></span><br><span class="line">gender = <span class="string">&#x27;未知&#x27;</span> <span class="comment">//不能将类型“&quot;未知&quot;”分配给类型“&quot;男&quot; | &quot;女&quot;”</span></span><br></pre></td></tr></table></figure>

<h2 id="4-2-any"><a href="#4-2-any" class="headerlink" title="4.2 any"></a>4.2 any</h2><p><code>any</code> 的含义是：任意类型，一旦将变量类型限制为 <code>any</code> ，那就意味着放弃了对该变量的类型检查。</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="comment">//明确的表示a的类型是any —— 显式的any</span></span><br><span class="line"><span class="keyword">let</span> <span class="attr">a</span>: <span class="built_in">any</span></span><br><span class="line"><span class="comment">//以下对a的赋值，均无警告</span></span><br><span class="line">a = <span class="number">100</span></span><br><span class="line">a = <span class="string">&#x27;你好&#x27;</span></span><br><span class="line">a = <span class="literal">false</span></span><br><span class="line"><span class="comment">//没有明确的表示b的类型是any，但TS主动推断了出来 —— 隐式的any</span></span><br><span class="line"><span class="keyword">let</span> b</span><br><span class="line"><span class="comment">//以下对b的赋值，均无警告</span></span><br><span class="line">b = <span class="number">100</span></span><br><span class="line">b = <span class="string">&#x27;你好&#x27;</span></span><br><span class="line">b = <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<p>PS： <code>any</code> 类型的变量，可以赋值给任意类型的变量。</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* 注意点：any类型的变量，可以赋值给任意类型的变量 */</span></span><br><span class="line"><span class="keyword">let</span> a</span><br><span class="line"><span class="keyword">let</span> <span class="attr">x</span>: <span class="built_in">string</span></span><br><span class="line">x = a <span class="comment">// 无警告</span></span><br></pre></td></tr></table></figure>

<h2 id="4-3-unknown"><a href="#4-3-unknown" class="headerlink" title="4.3 unknown"></a>4.3 unknown</h2><p><code>unknown</code> 的含义是：未知类型。</p>
<p>注意：</p>
<ul>
<li><code>unknown</code> 可以理解为一个类型安全的 <code>any</code>。</li>
<li><code>unknown</code> 适用于：开始不知道数据的具体类型，后期才能确定数据的类型。</li>
</ul>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 设置a的类型为unknown</span></span><br><span class="line"><span class="keyword">let</span> <span class="attr">a</span>: <span class="built_in">unknown</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 以下对a的赋值，均正常</span></span><br><span class="line">a = <span class="number">100</span></span><br><span class="line">a = <span class="literal">false</span></span><br><span class="line">a = <span class="string">&#x27;你好&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置x的数据类型为string</span></span><br><span class="line"><span class="keyword">let</span> <span class="attr">x</span>: <span class="built_in">string</span></span><br><span class="line">x = a <span class="comment">//警告：不能将类型“unknown”分配给类型“string”</span></span><br></pre></td></tr></table></figure>

<p>若就是想把 <code>a</code> 赋值给 <code>x</code> ，可以用以下三种写法：</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 设置a的类型为unknown</span></span><br><span class="line"><span class="keyword">let</span> <span class="attr">a</span>: <span class="built_in">unknown</span></span><br><span class="line">a = <span class="string">&#x27;hello&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//第一种方式：加类型判断</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">typeof</span> a === <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line">    x = a</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//第二种方式：加断言</span></span><br><span class="line">x = a <span class="keyword">as</span> <span class="built_in">string</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//第三种方式：加断言</span></span><br><span class="line">x = &lt;<span class="built_in">string</span>&gt;a</span><br></pre></td></tr></table></figure>

<p><code>any</code> 后 <code>.</code> 任何的东西都不会报错，而 <code>unknown</code> 正好与之相反。</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="attr">str1</span>: <span class="built_in">string</span> = <span class="string">&#x27;hello&#x27;</span></span><br><span class="line">str1.<span class="title function_">toUpperCase</span>() <span class="comment">//无警告</span></span><br><span class="line"><span class="keyword">let</span> <span class="attr">str2</span>: <span class="built_in">any</span> = <span class="string">&#x27;hello&#x27;</span></span><br><span class="line">str2.<span class="title function_">toUpperCase</span>() <span class="comment">//无警告</span></span><br><span class="line"><span class="keyword">let</span> <span class="attr">str3</span>: <span class="built_in">unknown</span> = <span class="string">&#x27;hello&#x27;</span>;</span><br><span class="line">str3.<span class="title function_">toUpperCase</span>() <span class="comment">//警告：“str3”的类型为“未知”</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用断言强制指定str3的类型为string</span></span><br><span class="line">(str3 <span class="keyword">as</span> <span class="built_in">string</span>).<span class="title function_">toUpperCase</span>() <span class="comment">//无警告</span></span><br></pre></td></tr></table></figure>

<h2 id="4-4-never"><a href="#4-4-never" class="headerlink" title="4.4 never"></a>4.4 never</h2><p><code>never</code> 的含义是：任何值都不是，简言之就是不能有值， <code>undefined</code> 、 <code>null</code> 、 <code>&#39;&#39;</code> 、 <code>0</code> 都不行！</p>
<ol>
<li><p>几乎不用 <code>never</code> 去直接限制变量，因为没有意义，例如：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/* 指定a的类型为never，那就意味着a以后不能存任何的数据了 */</span><br><span class="line">let a: never</span><br><span class="line">// 以下对a的所有赋值都会有警告</span><br><span class="line">a = 1</span><br><span class="line">a = true</span><br><span class="line">a = undefined</span><br><span class="line">a = null</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>never</code> 一般是 TypeScript 主动推断出来的，例如：</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 指定a的类型为string</span></span><br><span class="line"><span class="keyword">let</span> <span class="attr">a</span>: <span class="built_in">string</span></span><br><span class="line"><span class="comment">// 给a设置一个值</span></span><br><span class="line">a = <span class="string">&#x27;hello&#x27;</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">typeof</span> a === <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line">    a.<span class="title function_">toUpperCase</span>()</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(a) <span class="comment">// TypeScript会推断出此处的a是never，因为没有任何一个值符合此处的逻辑</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>never</code> 也可用于限制函数的返回值。</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 限制demo函数不需要有任何返回值，任何值都不行，像undeifned、null都不行</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">demo</span>(<span class="params"></span>): <span class="built_in">never</span> &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;程序异常退出&#x27;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="4-5-void"><a href="#4-5-void" class="headerlink" title="4.5 void"></a>4.5 void</h2><p><code>void</code> 的含义是： <code>空</code> 或 <code>undefined</code> ，严格模式下不能将 <code>null</code> 赋值给 <code>void</code> 类型。</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="attr">a</span>: <span class="built_in">void</span> = <span class="literal">undefined</span></span><br><span class="line"><span class="comment">//严格模式下，该行会有警告：不能将类型“null”分配给类型“void”</span></span><br><span class="line"><span class="keyword">let</span> <span class="attr">b</span>: <span class="built_in">void</span> = <span class="literal">null</span></span><br></pre></td></tr></table></figure>

<p><code>void</code> 常用于限制函数返回值：</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 无警告</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">demo1</span>(<span class="params"></span>): <span class="built_in">void</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 无警告</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">demo2</span>(<span class="params"></span>): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 无警告</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">demo3</span>(<span class="params"></span>): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">undefined</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 有警告：不能将类型“number”分配给类型“void”</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">demo4</span>(<span class="params"></span>): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">666</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-6-object"><a href="#4-6-object" class="headerlink" title="4.6 object"></a>4.6 object</h2><p>关于 <code>Object</code> 与 <code>object</code> ，直接说结论：在类型限制时， <code>Object</code> 几乎不用，因为范围太大了，无意义。</p>
<ol>
<li><p><code>object</code> 的含义：任何【非原始值类型】，包括：对象、函数、数组等，限制的范围比较宽泛，用得少。</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="attr">a</span>: <span class="built_in">object</span> <span class="comment">//a的值可以是任何【非原始值类型】，包括：对象、函数、数组等</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 以下代码，是将【非原始类型】赋给a，所以均无警告</span></span><br><span class="line">a = &#123;&#125;</span><br><span class="line">a = &#123; <span class="attr">name</span>: <span class="string">&#x27;张三&#x27;</span> &#125;</span><br><span class="line">a = [<span class="number">1</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">7</span>, <span class="number">9</span>]</span><br><span class="line">a = <span class="keyword">function</span> (<span class="params"></span>) &#123; &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 以下代码，是将【原始类型】赋给a，有警告</span></span><br><span class="line">a = <span class="literal">null</span> <span class="comment">// 警告：不能将类型“null”分配给类型“object”</span></span><br><span class="line">a = <span class="literal">undefined</span> <span class="comment">// 警告：不能将类型“undefined”分配给类型“object”</span></span><br><span class="line">a = <span class="number">1</span> <span class="comment">// 警告：不能将类型“number”分配给类型“object”</span></span><br><span class="line">a = <span class="literal">true</span> <span class="comment">// 警告：不能将类型“boolean”分配给类型“object”</span></span><br><span class="line">a = <span class="string">&#x27;你好&#x27;</span> <span class="comment">// 警告：不能将类型“string”分配给类型“object”</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><code>Object</code> 的含义： <code>Object</code> 的实例对象，限制的范围太大了，几乎不用。</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="attr">a</span>: <span class="title class_">Object</span> <span class="comment">//a的值必须是Object的实例对象</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 以下代码，均无警告，因为给a赋的值，都是Object的实例对象</span></span><br><span class="line">a = &#123;&#125;</span><br><span class="line">a = &#123; <span class="attr">name</span>: <span class="string">&#x27;张三&#x27;</span> &#125;</span><br><span class="line">a = [<span class="number">1</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">7</span>, <span class="number">9</span>]</span><br><span class="line">a = <span class="keyword">function</span> (<span class="params"></span>) &#123; &#125;</span><br><span class="line">a = <span class="number">1</span> <span class="comment">// 1不是Object的实例对象，但其包装对象是Object的实例</span></span><br><span class="line">a = <span class="literal">true</span> <span class="comment">// true不是Object的实例对象，但其包装对象是Object的实例</span></span><br><span class="line">a = <span class="string">&#x27;你好&#x27;</span> <span class="comment">// “你好”不是Object的实例对象，但其包装对象是Object的实例</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 以下代码均有警告</span></span><br><span class="line">a = <span class="literal">null</span> <span class="comment">// 警告：不能将类型“null”分配给类型“Object”</span></span><br><span class="line">a = <span class="literal">undefined</span> <span class="comment">// 警告：不能将类型“undefined”分配给类型“Object”</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>实际开发中，限制一般对象，通常使用以下形式：</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 限制person对象的具体内容，使用【,】分隔，【?】代表可选属性</span></span><br><span class="line"><span class="keyword">let</span> <span class="attr">person</span>: &#123; <span class="attr">name</span>: <span class="built_in">string</span>, age?: <span class="built_in">number</span> &#125;</span><br><span class="line"><span class="comment">// 限制car对象的具体内容，使用【;】分隔，必须有price和color属性，其他属性不去限制，有没有都行</span></span><br><span class="line"><span class="keyword">let</span> <span class="attr">car</span>: &#123; <span class="attr">price</span>: <span class="built_in">number</span>; <span class="attr">color</span>: <span class="built_in">string</span>;[<span class="attr">k</span>: <span class="built_in">string</span>]: <span class="built_in">any</span> &#125;</span><br><span class="line"><span class="comment">// 限制student对象的具体内容，使用【回车】分隔</span></span><br><span class="line"><span class="keyword">let</span> <span class="attr">student</span>: &#123;</span><br><span class="line">    <span class="attr">id</span>: <span class="built_in">string</span></span><br><span class="line">    <span class="attr">grade</span>: <span class="built_in">number</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 以下代码均无警告</span></span><br><span class="line">person = &#123; <span class="attr">name</span>: <span class="string">&#x27;张三&#x27;</span>, <span class="attr">age</span>: <span class="number">18</span> &#125;</span><br><span class="line">person = &#123; <span class="attr">name</span>: <span class="string">&#x27;李四&#x27;</span> &#125;</span><br><span class="line">car = &#123; <span class="attr">price</span>: <span class="number">100</span>, <span class="attr">color</span>: <span class="string">&#x27;红色&#x27;</span> &#125;</span><br><span class="line">student = &#123; <span class="attr">id</span>: <span class="string">&#x27;tetqw76te01&#x27;</span>, <span class="attr">grade</span>: <span class="number">3</span> &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>限制函数的参数、返回值，使用以下形式：</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="attr">demo</span>: <span class="function">(<span class="params">a: <span class="built_in">number</span>, b: <span class="built_in">number</span></span>) =&gt;</span> <span class="built_in">number</span></span><br><span class="line">demo = <span class="keyword">function</span> (<span class="params">x, y</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> x + y</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>限制数组，使用以下形式：</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="attr">arr1</span>: <span class="built_in">string</span>[] <span class="comment">// 该行代码等价于： let arr1: Array&lt;string&gt;</span></span><br><span class="line"><span class="keyword">let</span> <span class="attr">arr2</span>: <span class="built_in">number</span>[] <span class="comment">// 该行代码等价于： let arr2: Array&lt;number&gt;</span></span><br><span class="line">arr1 = [<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>]</span><br><span class="line">arr2 = [<span class="number">1</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">7</span>, <span class="number">9</span>]</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="4-7-tuple"><a href="#4-7-tuple" class="headerlink" title="4.7 tuple"></a>4.7 tuple</h2><p><code>tuple</code> 就是一个长度固定的数组。</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="attr">t</span>: [<span class="built_in">string</span>, <span class="built_in">number</span>]</span><br><span class="line">t = [<span class="string">&#x27;hello&#x27;</span>, <span class="number">123</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">// 警告:不能将类型“[string, number, boolean]”分配给类型“[string, number]”。源具有 3 个元素，但目标仅允许 2 个。</span></span><br><span class="line">t = [<span class="string">&#x27;hello&#x27;</span>, <span class="number">123</span>, <span class="literal">false</span>]</span><br></pre></td></tr></table></figure>

<h2 id="4-8-enum"><a href="#4-8-enum" class="headerlink" title="4.8 enum"></a>4.8 enum</h2><p><code>enum</code> 是枚举。</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 定义一个枚举</span></span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">Color</span> &#123;</span><br><span class="line">    <span class="title class_">Red</span>,</span><br><span class="line">    <span class="title class_">Blue</span>,</span><br><span class="line">    <span class="title class_">Black</span>,</span><br><span class="line">    <span class="title class_">Gold</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 定义一个枚举，并指定其初识数值</span></span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">Color2</span> &#123;</span><br><span class="line">    <span class="title class_">Red</span> = <span class="number">6</span>,</span><br><span class="line">    <span class="title class_">Blue</span>,</span><br><span class="line">    <span class="title class_">Black</span>,</span><br><span class="line">    <span class="title class_">Gold</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Color</span>)</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> &#123;</span></span><br><span class="line"><span class="comment"> 0: &#x27;Red&#x27;,</span></span><br><span class="line"><span class="comment"> 1: &#x27;Blue&#x27;,</span></span><br><span class="line"><span class="comment"> 2: &#x27;Black&#x27;,</span></span><br><span class="line"><span class="comment"> 3: &#x27;Gold&#x27;,</span></span><br><span class="line"><span class="comment"> Red: 0,</span></span><br><span class="line"><span class="comment"> Blue: 1,</span></span><br><span class="line"><span class="comment"> Black: 2,</span></span><br><span class="line"><span class="comment"> Gold: 3</span></span><br><span class="line"><span class="comment"> &#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Color2</span>)</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> &#123;</span></span><br><span class="line"><span class="comment"> 6: &#x27;Red&#x27;,</span></span><br><span class="line"><span class="comment"> 7: &#x27;Blue&#x27;,</span></span><br><span class="line"><span class="comment"> 8: &#x27;Black&#x27;,</span></span><br><span class="line"><span class="comment"> 9: &#x27;Gold&#x27;,</span></span><br><span class="line"><span class="comment"> Red: 6,</span></span><br><span class="line"><span class="comment"> Blue: 7,</span></span><br><span class="line"><span class="comment"> Black: 8,</span></span><br><span class="line"><span class="comment"> Gold: 9</span></span><br><span class="line"><span class="comment"> &#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">// 定义一个phone变量，并设置对齐进行限制</span></span><br><span class="line"><span class="keyword">let</span> <span class="attr">phone</span>: &#123; <span class="attr">name</span>: <span class="built_in">string</span>, <span class="attr">price</span>: <span class="built_in">number</span>, <span class="attr">color</span>: <span class="title class_">Color</span> &#125;</span><br><span class="line">phone = &#123; <span class="attr">name</span>: <span class="string">&#x27;华为Mate60&#x27;</span>, <span class="attr">price</span>: <span class="number">6500</span>, <span class="attr">color</span>: <span class="title class_">Color</span>.<span class="property">Red</span> &#125;</span><br><span class="line"></span><br><span class="line">phone = &#123; <span class="attr">name</span>: <span class="string">&#x27;iPhone15Pro&#x27;</span>, <span class="attr">price</span>: <span class="number">7999</span>, <span class="attr">color</span>: <span class="title class_">Color</span>.<span class="property">Blue</span> &#125;</span><br><span class="line"><span class="keyword">if</span> (phone.<span class="property">color</span> === <span class="title class_">Color</span>.<span class="property">Red</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;⼿机是红色的&#x27;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="5-自定义类型"><a href="#5-自定义类型" class="headerlink" title="5. 自定义类型"></a>5. 自定义类型</h1><p>自定义类型，可以更灵活的限制类型。</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 性别的枚举</span></span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">Gender</span> &#123;</span><br><span class="line">    <span class="title class_">Male</span>,</span><br><span class="line">    <span class="title class_">Female</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 自定义一个年级类型（高一、高二、高三）</span></span><br><span class="line"><span class="keyword">type</span> <span class="title class_">Grade</span> = <span class="number">1</span> | <span class="number">2</span> | <span class="number">3</span></span><br><span class="line"><span class="comment">// 自定义一个学生类型</span></span><br><span class="line"><span class="keyword">type</span> <span class="title class_">Student</span> = &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="built_in">string</span>,</span><br><span class="line">    <span class="attr">age</span>: <span class="built_in">number</span>,</span><br><span class="line">    <span class="attr">gender</span>: <span class="title class_">Gender</span>,</span><br><span class="line">    <span class="attr">grade</span>: <span class="title class_">Grade</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 定义两个学生变量：s1、s2</span></span><br><span class="line"><span class="keyword">let</span> <span class="attr">s1</span>: <span class="title class_">Student</span></span><br><span class="line"><span class="keyword">let</span> <span class="attr">s2</span>: <span class="title class_">Student</span></span><br><span class="line">s1 = &#123; <span class="attr">name</span>: <span class="string">&#x27;张三&#x27;</span>, <span class="attr">age</span>: <span class="number">18</span>, <span class="attr">gender</span>: <span class="title class_">Gender</span>.<span class="property">Male</span>, <span class="attr">grade</span>: <span class="number">1</span> &#125;</span><br><span class="line">s2 = &#123; <span class="attr">name</span>: <span class="string">&#x27;李四&#x27;</span>, <span class="attr">age</span>: <span class="number">18</span>, <span class="attr">gender</span>: <span class="title class_">Gender</span>.<span class="property">Female</span>, <span class="attr">grade</span>: <span class="number">2</span> &#125;</span><br></pre></td></tr></table></figure>

<h1 id="6-抽象类"><a href="#6-抽象类" class="headerlink" title="6. 抽象类"></a>6. 抽象类</h1><p>常规类：</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="built_in">string</span></span><br><span class="line">    <span class="attr">age</span>: <span class="built_in">number</span></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">name: <span class="built_in">string</span>, age: <span class="built_in">number</span></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">name</span> = name</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">age</span> = age</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> p1 = <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&#x27;张三&#x27;</span>, <span class="number">18</span>)</span><br><span class="line"><span class="keyword">const</span> p2 = <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&#x27;李四&#x27;</span>, <span class="number">19</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(p1)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(p2)</span><br></pre></td></tr></table></figure>

<p>继承：</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Person类</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span> &#123; ... &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Teacher类继承Person</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Teacher</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Person</span> &#123; ... &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Student类继承Person</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Student</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Person</span> &#123; ... &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Person实例</span></span><br><span class="line"><span class="keyword">const</span> p1 = <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&#x27;周杰伦&#x27;</span>, <span class="number">38</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Student实例</span></span><br><span class="line"><span class="keyword">const</span> s1 = <span class="keyword">new</span> <span class="title class_">Student</span>(<span class="string">&#x27;张同学&#x27;</span>, <span class="number">18</span>)</span><br><span class="line"><span class="keyword">const</span> s2 = <span class="keyword">new</span> <span class="title class_">Student</span>(<span class="string">&#x27;李同学&#x27;</span>, <span class="number">20</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Teacher实例</span></span><br><span class="line"><span class="keyword">const</span> t1 = <span class="keyword">new</span> <span class="title class_">Teacher</span>(<span class="string">&#x27;刘老师&#x27;</span>, <span class="number">40</span>)</span><br><span class="line"><span class="keyword">const</span> t2 = <span class="keyword">new</span> <span class="title class_">Teacher</span>(<span class="string">&#x27;孙老师&#x27;</span>, <span class="number">50</span>)</span><br></pre></td></tr></table></figure>

<p>抽象类：不能去实例化，但可以被别人继承，抽象类里有抽象方法。</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Person（抽象类）</span></span><br><span class="line"><span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">Person</span> &#123; ... &#125;</span><br><span class="line"><span class="comment">// Teacher类继承Person</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Teacher</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Person</span> &#123;</span><br><span class="line">    <span class="comment">// 构造器</span></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">name: <span class="built_in">string</span>, age: <span class="built_in">number</span></span>) &#123;</span><br><span class="line">        <span class="variable language_">super</span>(name, age)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 方法</span></span><br><span class="line">    <span class="title function_">speak</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;你好！我是老师:&#x27;</span>, <span class="variable language_">this</span>.<span class="property">name</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Student类继承Person</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Student</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Person</span> &#123; ... &#125;</span><br><span class="line"><span class="comment">// Person实例</span></span><br><span class="line"><span class="comment">// const p1 = new Person(&#x27;周杰伦&#x27;,38) // 由于Person是抽象类，所以此处不可以new Person的实例对象</span></span><br></pre></td></tr></table></figure>

<h1 id="7-接口"><a href="#7-接口" class="headerlink" title="7. 接口"></a>7. 接口</h1><ol>
<li><p>接口用于限制一个类中包含哪些属性和方法：</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Person接口</span></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="comment">// 属性声明</span></span><br><span class="line">    <span class="attr">name</span>: <span class="built_in">string</span></span><br><span class="line">    <span class="attr">age</span>: <span class="built_in">number</span></span><br><span class="line">    <span class="comment">// 方法声明</span></span><br><span class="line">    <span class="title function_">speak</span>(): <span class="built_in">void</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Teacher实现Person接口</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Teacher</span> <span class="keyword">implements</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="built_in">string</span></span><br><span class="line">    <span class="attr">age</span>: <span class="built_in">number</span></span><br><span class="line">    <span class="comment">// 构造器</span></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">name: <span class="built_in">string</span>, age: <span class="built_in">number</span></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">name</span> = name</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">age</span> = age</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 方法</span></span><br><span class="line">    <span class="title function_">speak</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;你好！我是老师:&#x27;</span>, <span class="variable language_">this</span>.<span class="property">name</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>接口是可以重复声明的：</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Person接口</span></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">PersonInter</span> &#123;</span><br><span class="line">    <span class="comment">// 属性声明</span></span><br><span class="line">    <span class="attr">name</span>: <span class="built_in">string</span></span><br><span class="line">    <span class="attr">age</span>: <span class="built_in">number</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Person接口</span></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">PersonInter</span> &#123;</span><br><span class="line">    <span class="comment">// 方法声明</span></span><br><span class="line">    <span class="title function_">speak</span>(): <span class="built_in">void</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Person类继承PersonInter</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span> <span class="keyword">implements</span> <span class="title class_">PersonInter</span> &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="built_in">string</span></span><br><span class="line">    <span class="attr">age</span>: <span class="built_in">number</span></span><br><span class="line">    <span class="comment">// 构造器</span></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">name: <span class="built_in">string</span>, age: <span class="built_in">number</span></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">name</span> = name</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">age</span> = age</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 方法</span></span><br><span class="line">    <span class="title function_">speak</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;你好！我是老师:&#x27;</span>, <span class="variable language_">this</span>.<span class="property">name</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>【接口】与【自定义类型】的区别：</p>
<p>接口可以：</p>
<ul>
<li>当自定义类型去使用。</li>
<li>可以限制类的结构。</li>
</ul>
<p>自定义类型：</p>
<ul>
<li>仅仅就是自定义类型。</li>
</ul>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Perosn接口</span></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">Perosn</span> &#123;</span><br><span class="line">    <span class="comment">// 应该具有的属性</span></span><br><span class="line">    <span class="attr">name</span>: <span class="built_in">string</span></span><br><span class="line">    <span class="attr">age</span>: <span class="built_in">number</span></span><br><span class="line">    <span class="comment">// 应该具有的方法</span></span><br><span class="line">    <span class="title function_">speak</span>(): <span class="built_in">void</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Person类型</span></span><br><span class="line"><span class="comment">/* type Perosn = &#123;</span></span><br><span class="line"><span class="comment">    // 应该具有的属性</span></span><br><span class="line"><span class="comment">    name: string</span></span><br><span class="line"><span class="comment">    age: number</span></span><br><span class="line"><span class="comment">    // 应该具有的方法</span></span><br><span class="line"><span class="comment">    speak(): void</span></span><br><span class="line"><span class="comment">&#125; */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 接口当成自定义类型去使用</span></span><br><span class="line"><span class="keyword">let</span> <span class="attr">person</span>: <span class="title class_">Perosn</span> = &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;张三&#x27;</span>,</span><br><span class="line">    <span class="attr">age</span>: <span class="number">18</span>,</span><br><span class="line">    <span class="title function_">speak</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;你好！&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>【 接口 】与【 抽 象 类 】 的 区 别：</p>
<p>抽象类：</p>
<ul>
<li>可以有普通方法，也可以有抽象方法。</li>
<li>使用 <code>extends</code> 关键字去继承抽象类 。</li>
</ul>
<p>接口中：</p>
<ul>
<li>只能有抽象方法。</li>
<li>使用 <code>implements</code> 关键字去实现接口。</li>
</ul>
</li>
</ol>
<p>抽象类举例：</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 抽象类 —— Person</span></span><br><span class="line"><span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="comment">// 属性</span></span><br><span class="line">    <span class="attr">name</span>: <span class="built_in">string</span></span><br><span class="line">    <span class="attr">age</span>: <span class="built_in">number</span></span><br><span class="line">    <span class="comment">// 构造器</span></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">name: <span class="built_in">string</span>, age: <span class="built_in">number</span></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">name</span> = name</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">age</span> = age</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 抽象方法</span></span><br><span class="line">    <span class="keyword">abstract</span> <span class="title function_">speak</span>(): <span class="built_in">void</span></span><br><span class="line">    <span class="comment">// 普通方法</span></span><br><span class="line">    <span class="title function_">walk</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;我在行走中....&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Teacher类继承抽象类Person</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Teacher</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Person</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">name: <span class="built_in">string</span>, age: <span class="built_in">number</span></span>) &#123;</span><br><span class="line">        <span class="variable language_">super</span>(name, age)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">speak</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`我是老师，我的名字是<span class="subst">$&#123;<span class="variable language_">this</span>.name&#125;</span>`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接口举例：</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 接口 —— Person，只能包含抽象方法</span></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="comment">// 属性，不写具体值</span></span><br><span class="line">    <span class="attr">name</span>: <span class="built_in">string</span></span><br><span class="line">    <span class="attr">age</span>: <span class="built_in">number</span></span><br><span class="line">    <span class="comment">// 方法，不写具体实现</span></span><br><span class="line">    <span class="title function_">speak</span>(): <span class="built_in">void</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 创建Teacher类实现Person接口</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Teacher</span> <span class="keyword">implements</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="built_in">string</span></span><br><span class="line">    <span class="attr">age</span>: <span class="built_in">number</span></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">name: <span class="built_in">string</span>, age: <span class="built_in">number</span></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">name</span> = name</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">age</span> = age</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">speak</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;我在飞快的行走中......&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="8-属性修饰符"><a href="#8-属性修饰符" class="headerlink" title="8. 属性修饰符"></a>8. 属性修饰符</h1><table>
<thead>
<tr>
<th align="center">属性修饰符</th>
<th align="center">属性权限</th>
<th align="center">备注</th>
</tr>
</thead>
<tbody><tr>
<td align="center">readonly</td>
<td align="center">只读属性</td>
<td align="center">属性无法修改</td>
</tr>
<tr>
<td align="center">public</td>
<td align="center">公开的</td>
<td align="center">可以在类、子类和对象中修改</td>
</tr>
<tr>
<td align="center">protected</td>
<td align="center">受保护的</td>
<td align="center">可以在类、子类中修改</td>
</tr>
<tr>
<td align="center">private</td>
<td align="center">私有的</td>
<td align="center">可以在类中修改</td>
</tr>
</tbody></table>
<h1 id="9-泛型"><a href="#9-泛型" class="headerlink" title="9. 泛型"></a>9. 泛型</h1><div class="note info flat"><p>如果你想了解更多关于泛型的知识，此处可以类比<a href="https://zz.muyoukule.cn/posts/42613/">Java泛型</a> 这篇文章进行学习哦🎈</p>
</div>

<p>定义一个函数或类时，有些情况下无法确定其中要使用的具体类型（返回值、参数、属性的类型不能确 定），此时就需要泛型了。</p>
<p>举例：<code>&lt;T&gt;</code> 就是泛型，（不一定非得叫 <code>T</code>），设置泛型后即可在函数中使用 <code>T</code> 来表示该类型：</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> test&lt;T&gt;(<span class="attr">arg</span>: T): T &#123;</span><br><span class="line">    <span class="keyword">return</span> arg;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 不指定类名，TS会自动推断出来</span></span><br><span class="line"><span class="title function_">test</span>(<span class="number">10</span>)</span><br><span class="line"><span class="comment">// 指名具体的类型</span></span><br><span class="line">test&lt;<span class="built_in">number</span>&gt;(<span class="number">10</span>)</span><br></pre></td></tr></table></figure>

<p>泛型可以写多个：</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> test&lt;T, K&gt;(<span class="attr">a</span>: T, <span class="attr">b</span>: K): K &#123;</span><br><span class="line">    <span class="keyword">return</span> b;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 为多个泛型指定具体值</span></span><br><span class="line">test&lt;<span class="built_in">number</span>, <span class="built_in">string</span>&gt;(<span class="number">10</span>, <span class="string">&quot;hello&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>类中同样可以使用泛型：</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyClass</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="attr">prop</span>: T;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">prop: T</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">prop</span> = prop;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>也可以对泛型的范围进行约束：</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">Demo</span> &#123;</span><br><span class="line">    <span class="attr">length</span>: <span class="built_in">number</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 泛型T必须是MyInter的⼦类，即：必须拥有length属性</span></span><br><span class="line"><span class="keyword">function</span> test&lt;T <span class="keyword">extends</span> <span class="title class_">Demo</span>&gt;(<span class="attr">arg</span>: T): <span class="built_in">number</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> arg.<span class="property">length</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">test</span>(<span class="number">10</span>) <span class="comment">// 类型“number”的参数不能赋给类型“Demo”的参数</span></span><br><span class="line"><span class="title function_">test</span>(&#123; <span class="attr">name</span>: <span class="string">&#x27;张三&#x27;</span> &#125;) <span class="comment">// 类型“&#123; name: string; &#125;”的参数不能赋给类型“Demo”的参数</span></span><br><span class="line"><span class="title function_">test</span>(<span class="string">&#x27;123&#x27;</span>)</span><br><span class="line"><span class="title function_">test</span>(&#123; <span class="attr">name</span>: <span class="string">&#x27;张三&#x27;</span>, <span class="attr">length</span>: <span class="number">10</span> &#125;)</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Front-End</category>
        <category>TypeScript</category>
      </categories>
      <tags>
        <tag>TypeScript</tag>
      </tags>
  </entry>
  <entry>
    <title>Vue3快速入门</title>
    <url>/posts/3127/</url>
    <content><![CDATA[<h1 id="1-Vue3简介"><a href="#1-Vue3简介" class="headerlink" title="1. Vue3简介"></a>1. Vue3简介</h1><h2 id="1-1-什么是Vue？"><a href="#1-1-什么是Vue？" class="headerlink" title="1.1 什么是Vue？"></a>1.1 什么是Vue？</h2><p><a href="https://cn.vuejs.org/guide/introduction.html#what-is-vue">官方介绍</a>：Vue (发音为 &#x2F;vjuː&#x2F;，类似 <strong>view</strong>) 是一款用于构建用户界面的 JavaScript 框架。它基于标准 HTML、CSS 和 JavaScript 构建，并提供了一套声明式的、组件化的编程模型，帮助你高效地开发用户界面。无论是简单还是复杂的界面，Vue 都可以胜任。</p>
<h2 id="1-2-什么是Vue3？"><a href="#1-2-什么是Vue3？" class="headerlink" title="1.2 什么是Vue3？"></a>1.2 什么是Vue3？</h2><p>Vue3是Vue.js框架的第三个主要版本，它带来了一系列引人注目的新特性和改进，旨在提升开发者的效率和代码的可维护性。以下是对Vue3的简要介绍：</p>
<ol>
<li><strong>性能提升</strong>：Vue3相较于Vue2在性能上有显著的提升，处理大量数据和复杂组件时效果尤为明显。这主要得益于其更高效的渲染机制，包括异步渲染和编译优化等措施。</li>
<li><strong>Composition API</strong>：Vue3引入了Composition API，这是一种基于函数的API，它让组件代码更加简洁和可复用。通过Composition API，开发者可以更加灵活和自由地编写组件，实现代码的逻辑复用和更好的组织。</li>
<li><strong>TypeScript支持</strong>：Vue3对TypeScript的支持更加严格，提供了更加完整、准确的类型检查和错误提示。这使得开发者在编写代码时更加安心，减少错误的发生。</li>
<li><strong>可维护性和拓展性</strong>：通过组件化和模块化的方式，Vue3极大地增加了代码的可维护性和拓展性。这使得开发者在项目开发过程中更加容易进行代码管理和扩展。</li>
<li><strong>新特性</strong>：Vue3还引入了一些新的特性，如Fragment（允许组件返回多个根节点）、Suspense（用于异步组件加载时的等待状态管理）和Teleport（允许将组件的子节点渲染到DOM中的任意位置）。这些特性为开发者提供了更多的灵活性和选择。</li>
<li><strong>生态系统</strong>：Vue3拥有丰富的生态系统，包括官方支持的库和社区开发的插件。这使得开发者能够快速地构建复杂的应用程序，并与其他开发者共享和重用代码。</li>
</ol>
<h1 id="2-创建Vue3工程"><a href="#2-创建Vue3工程" class="headerlink" title="2. 创建Vue3工程"></a>2. 创建Vue3工程</h1><h2 id="2-1-基于-vue-cli-创建"><a href="#2-1-基于-vue-cli-创建" class="headerlink" title="2.1 基于 vue-cli 创建"></a>2.1 基于 vue-cli 创建</h2><p>点击查看<a href="https://cli.vuejs.org/zh/guide/creating-a-project.html#vue-create">官方文档</a></p>
<div class="note warning flat"><p>Vue CLI 现已处于维护模式!</p>
</div>

<div class="note info flat"><p>现在官方推荐使用 <a href="https://github.com/vuejs/create-vue"><code>create-vue</code></a> 来创建基于 <a href="https://cn.vitejs.dev/">Vite</a> 的新项目。 另外请参考 <a href="https://cn.vuejs.org/guide/scaling-up/tooling.html">Vue3 工具链指南</a> 以了解最新的工具推荐。</p>
</div>

<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1.安装或者升级你的@vue/cli </span></span><br><span class="line">npm install <span class="literal">-g</span> @vue/<span class="built_in">cli</span></span><br><span class="line">npm update <span class="literal">-g</span> @vue/<span class="built_in">cli</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.查看@vue/cli版本，确保@vue/cli版本在4.5.0以上</span></span><br><span class="line">vue <span class="literal">--version</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.执行创建命令</span></span><br><span class="line">vue create vue_test</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4.随后选择 Vue3(默认)</span></span><br><span class="line"><span class="comment"># ? Please pick a preset: (Use arrow keys)</span></span><br><span class="line"><span class="comment"># &gt; Default ([Vue3] babel, eslint)</span></span><br><span class="line"><span class="comment">#   Default ([Vue 2] babel, eslint)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 5.启动</span></span><br><span class="line"><span class="built_in">cd</span> vue_test</span><br><span class="line">npm run serve</span><br></pre></td></tr></table></figure>

<h2 id="2-2-基于-vite-创建-推荐"><a href="#2-2-基于-vite-创建-推荐" class="headerlink" title="2.2 基于 vite 创建(推荐)"></a>2.2 基于 vite 创建(推荐)</h2><p><code>vite</code> 是新一代前端构建工具，官网地址：<a href="https://vitejs.cn/">https://vitejs.cn</a>，<code>vite</code>的优势如下：</p>
<ul>
<li>轻量快速的热重载（<code>HMR</code>），能实现极速的服务启动。</li>
<li>对 <code>TypeScript</code>、<code>JSX</code>、<code>CSS</code> 等支持开箱即用。</li>
<li>真正的按需编译，不再等待整个应用编译完成。</li>
<li><code>webpack</code>构建 与 <code>vite</code>构建对比图如下：<br><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/Front-EndIMG/webpack%E6%9E%84%E5%BB%BA.png" alt="webpack构建" title="webpack构建" style="zoom:20%;box-shadow:0 0 10px black">	<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/Front-EndIMG/vite%E6%9E%84%E5%BB%BA.png" alt="vite构建" title="vite构建" style="zoom: 20%;box-shadow:0 0 10px black"></li>
</ul>
<ul>
<li>具体操作如下（点击查看<a href="https://cn.vuejs.org/guide/quick-start.html#creating-a-vue-application">官方文档</a>）</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1.创建命令</span></span><br><span class="line">npm create vue@latest</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.具体配置</span></span><br><span class="line"><span class="comment"># 配置项目名称</span></span><br><span class="line">√ Project name: vue3_test</span><br><span class="line"><span class="comment"># 是否添加TypeScript支持</span></span><br><span class="line">√ Add TypeScript?  Yes</span><br><span class="line"><span class="comment"># 是否添加JSX支持</span></span><br><span class="line">√ Add JSX Support?  No</span><br><span class="line"><span class="comment"># 是否添加路由环境</span></span><br><span class="line">√ Add Vue Router <span class="keyword">for</span> Single Page Application development?  No</span><br><span class="line"><span class="comment"># 是否添加pinia环境</span></span><br><span class="line">√ Add Pinia <span class="keyword">for</span> state management?  No<span class="comment">## 是否添加单元测试</span></span><br><span class="line">√ Add Vitest <span class="keyword">for</span> Unit Testing?  No</span><br><span class="line"><span class="comment"># 是否添加端到端测试方案</span></span><br><span class="line">√ Add an <span class="keyword">End</span><span class="literal">-to-End</span> Testing Solution? » No</span><br><span class="line"><span class="comment"># 是否添加ESLint语法检查</span></span><br><span class="line">√ Add ESLint <span class="keyword">for</span> code quality?  Yes</span><br><span class="line"><span class="comment"># 是否添加Prettiert代码格式化</span></span><br><span class="line">√ Add Prettier <span class="keyword">for</span> code formatting?  No</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.安装依赖并启动开发服务器</span></span><br><span class="line"><span class="built_in">cd</span> vue3_test</span><br><span class="line">npm install</span><br><span class="line">npm run dev</span><br></pre></td></tr></table></figure>

<p><strong>PS：</strong>生成的项目中的示例组件使用的是 <a href="https://cn.vuejs.org/guide/introduction.html#composition-api">组合式 API</a> 和 <code>&lt;script setup&gt;</code>，而非 <a href="https://cn.vuejs.org/guide/introduction.html#options-api">选项式 API</a>。官方推荐的 IDE 配置是 <a href="https://code.visualstudio.com/">Visual Studio Code</a> + <a href="https://marketplace.visualstudio.com/items?itemName=Vue.volar">Vue - Official 扩展</a>。</p>
<h2 id="2-3-Vue项目目录结构"><a href="#2-3-Vue项目目录结构" class="headerlink" title="2.3 Vue项目目录结构"></a>2.3 Vue项目目录结构</h2><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/Front-EndIMG/Vue%E9%A1%B9%E7%9B%AE%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84.png" alt="Vue项目目录结构" style="zoom:67%;">

<h2 id="2-4-Vue项目开发流程"><a href="#2-4-Vue项目开发流程" class="headerlink" title="2.4 Vue项目开发流程"></a>2.4 Vue项目开发流程</h2><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/Front-EndIMG/Vue%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%B5%81%E7%A8%8B.png" alt="Vue项目开发流程" style="zoom:67%;">

<h2 id="2-5-Vue项目简要介绍"><a href="#2-5-Vue项目简要介绍" class="headerlink" title="2.5 Vue项目简要介绍"></a>2.5 Vue项目简要介绍</h2><h3 id="2-5-1-main-ts组件"><a href="#2-5-1-main-ts组件" class="headerlink" title="2.5.1 main.ts组件"></a>2.5.1 main.ts组件</h3><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 引入 createApp 用于创建应用</span></span><br><span class="line"><span class="keyword">import</span> &#123; createApp &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"><span class="comment">// 引入 App 根组件</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">App</span> <span class="keyword">from</span> <span class="string">&#x27;./App.vue&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建应用</span></span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">createApp</span>(<span class="title class_">App</span>)</span><br><span class="line"><span class="comment">// 挂载应用</span></span><br><span class="line">app.<span class="title function_">mount</span>(<span class="string">&#x27;#app&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="2-5-2-App-vue"><a href="#2-5-2-App-vue" class="headerlink" title="2.5.2 App.vue"></a>2.5.2 App.vue</h3><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- html --&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- 模板部分,由它生成HTML --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">setup</span> <span class="attr">lang</span>=<span class="string">&quot;ts&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">   <span class="comment">/* JS或TS */</span></span></span><br><span class="line"><span class="language-javascript">   <span class="comment">/* 控制模板的数据及行为 */</span></span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">  <span class="comment">/* 当前组件的CSS样式 */</span></span></span><br><span class="line"><span class="language-css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>PS：设置 <code>lang=&quot;ts&quot;</code>，但是里面也可以写JS代码</strong>。<code>.vue</code>是Vue项目中的组件文件，在Vue项目中也称为单文件组件（<a href="https://cn.vuejs.org/guide/scaling-up/sfc.html">SFC</a>，Single-File Components）。Vue 的单文件组件会将一个组件的逻辑 (JS)，模板 (HTML) 和样式 (CSS) 封装在同一个文件里（*.vue）。</p>
<h3 id="2-5-3-setup"><a href="#2-5-3-setup" class="headerlink" title="2.5.3 setup"></a>2.5.3 setup</h3><p><code>setup</code>是<code>Vue3</code>中一个新的配置项，后面会介绍。</p>
<h3 id="2-5-4-scoped"><a href="#2-5-4-scoped" class="headerlink" title="2.5.4 scoped"></a>2.5.4 scoped</h3><p>在 Vue 中，<code>scoped</code> 是一个特殊的属性，主要用于 <code>&lt;style&gt;</code> 标签内，以确保其中的样式只应用于当前组件，而不是全局的。这使得组件的样式封装更加简洁和可控，减少了样式冲突的可能性。</p>
<p>具体来说，当你在一个 Vue 组件中使用 <code>&lt;style scoped&gt;</code> 时，Vue 会自动为组件的根元素添加一个唯一的属性（例如 <code>data-v-f3f3eg9</code>），并在 <code>&lt;style scoped&gt;</code> 中的选择器后自动添加这个属性。这样，这些样式就只会应用于带有这个唯一属性的元素，即当前组件的实例。</p>
<p>例如：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;my-component&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 组件内容 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>hello<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">scoped</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css"><span class="selector-class">.my-component</span> &#123;</span></span><br><span class="line"><span class="language-css">  <span class="attribute">color</span>: red;</span></span><br><span class="line"><span class="language-css">&#125;</span></span><br><span class="line"><span class="language-css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>渲染到浏览器后效果：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">data-v-4cadc14e</span> <span class="attr">class</span>=<span class="string">&quot;my-component&quot;</span>&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- 组件内容 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">h1</span> <span class="attr">data-v-4cadc14e</span>&gt;</span>hello<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在上面的例子中，<code>.my-component</code> 的样式只会应用于当前组件的 <code>&lt;div class=&quot;my-component&quot;&gt;</code>，而不会影响到其他组件或全局的 <code>.my-component</code> 类。</p>
<p>需要注意的是，<code>scoped</code> 样式有一些限制和注意事项：</p>
<ul>
<li><strong>子组件的穿透</strong>：默认情况下，<code>scoped</code> 样式不会影响到子组件。但有时你可能需要穿透这个限制，对子组件进行样式调整。这时，你可以使用 <code>::v-deep</code> 伪元素来实现。</li>
<li><strong>性能考虑</strong>：由于 Vue 需要为每个组件实例添加唯一的属性，并修改选择器，所以使用 <code>scoped</code> 样式可能会增加一些性能开销。在大型应用中，如果可能的话，尽量使用模块化的 CSS 或 CSS-in-JS 方案来替代。</li>
<li><strong>第三方库和全局样式</strong>：<code>scoped</code> 样式不会影响到通过 <code>&lt;link&gt;</code> 标签引入的第三方库或全局样式。这些样式仍然会全局生效。</li>
</ul>
<p>总的来说，<code>scoped</code> 属性是 Vue 提供的一个非常有用的工具，用于实现组件样式的封装和隔离。但在使用时也需要注意其限制和性能影响。</p>
<h3 id="2-5-5-编写App组件"><a href="#2-5-5-编写App组件" class="headerlink" title="2.5.5 编写App组件"></a>2.5.5 编写App组件</h3><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;app&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>你好啊！<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">lang</span>=<span class="string">&quot;ts&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">name</span>:<span class="string">&#x27;App&#x27;</span> <span class="comment">//组件名，可以省略</span></span></span><br><span class="line"><span class="language-javascript">  &#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">  <span class="selector-class">.app</span> &#123;</span></span><br><span class="line"><span class="language-css">    <span class="attribute">background-color</span>: <span class="number">#ddd</span>;</span></span><br><span class="line"><span class="language-css">    <span class="attribute">box-shadow</span>: <span class="number">0</span> <span class="number">0</span> <span class="number">10px</span>;</span></span><br><span class="line"><span class="language-css">    <span class="attribute">border-radius</span>: <span class="number">10px</span>;</span></span><br><span class="line"><span class="language-css">    <span class="attribute">padding</span>: <span class="number">20px</span>;</span></span><br><span class="line"><span class="language-css">  &#125;</span></span><br><span class="line"><span class="language-css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>总结：</p>
<ul>
<li><code>Vite</code> 项目中，<code>index.html</code> 是项目的入口文件，在项目最外层。</li>
<li>加载 <code>index.html</code> 后，<code>Vite</code> 解析 <code>&lt;script type=&quot;module&quot; src=&quot;xxx&quot;&gt;</code> 指向的 <code>JavaScript</code>。</li>
<li><code>Vue3</code> 中是通过 <code>createApp</code> 函数创建一个应用实例。</li>
</ul>
<h3 id="2-5-6-简单的效果（Vue2语法）"><a href="#2-5-6-简单的效果（Vue2语法）" class="headerlink" title="2.5.6 简单的效果（Vue2语法）"></a>2.5.6 简单的效果（<code>Vue2</code>语法）</h3><p><code>Vue3</code>向下兼容<code>Vue2</code>语法，且<code>Vue3</code>中的模板中可以没有根标签。</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h2</span>&gt;</span>姓名：&#123;&#123; name &#125;&#125;<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h2</span>&gt;</span>年龄：&#123;&#123; age &#125;&#125;<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;changeName&quot;</span>&gt;</span>修改名字<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;changeAge&quot;</span>&gt;</span>年龄+1<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;showTel&quot;</span>&gt;</span>点我查看联系方式<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">lang</span>=<span class="string">&quot;ts&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">name</span>: <span class="string">&#x27;App&#x27;</span>,	<span class="comment">//组件名，可以省略</span></span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">data</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">name</span>: <span class="string">&#x27;张三&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">age</span>: <span class="number">18</span>,</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">tel</span>: <span class="string">&#x27;13888888888&#x27;</span></span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">    &#125;,</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">methods</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">changeName</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">this</span>.<span class="property">name</span> = <span class="string">&#x27;zhang-san&#x27;</span></span></span><br><span class="line"><span class="language-javascript">        &#125;,</span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">changeAge</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">this</span>.<span class="property">age</span> += <span class="number">1</span></span></span><br><span class="line"><span class="language-javascript">        &#125;,</span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">showTel</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="title function_">alert</span>(<span class="variable language_">this</span>.<span class="property">tel</span>)</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">    &#125;,</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="3-常用指令"><a href="#3-常用指令" class="headerlink" title="3. 常用指令"></a>3. 常用指令</h1><p>指令：HTML标签上带有 <code>v-</code> 前缀的特殊属性，不同的指令具有不同的含义，可以实现不同的功能。</p>
<p>常用指令：</p>
<table>
<thead>
<tr>
<th align="center"><strong>指令</strong></th>
<th align="center"><strong>作用</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="center">v-for</td>
<td align="center">列表渲染，遍历容器的元素或者对象的属性</td>
</tr>
<tr>
<td align="center">v-bind</td>
<td align="center">为HTML标签绑定属性值，如设置 href , css样式等</td>
</tr>
<tr>
<td align="center">v-if&#x2F;v-else-if&#x2F;v-else</td>
<td align="center">条件性的渲染某元素，判定为true时渲染,否则不渲染</td>
</tr>
<tr>
<td align="center">v-show</td>
<td align="center">根据条件展示某元素，区别在于切换的是display属性的值</td>
</tr>
<tr>
<td align="center">v-model</td>
<td align="center">在表单元素上创建双向数据绑定</td>
</tr>
<tr>
<td align="center">v-on</td>
<td align="center">为HTML标签绑定事件</td>
</tr>
</tbody></table>
<h2 id="3-1-v-for"><a href="#3-1-v-for" class="headerlink" title="3.1 v-for"></a>3.1 v-for</h2><p><strong>作用：</strong>列表渲染，遍历容器的元素或者对象的属性。</p>
<p>语法：<code>v-for = &quot;(item,index) in items&quot;</code></p>
<p>参数说明：</p>
<ul>
<li>items 为遍历的数组</li>
<li>item 为遍历出来的元素</li>
<li>index 为索引&#x2F;下标，从0开始 ；可以省略，省略index语法： v-for &#x3D; “item in items”</li>
</ul>
<p>使用 v-for 时建议提供一个唯一标识 <code>key</code> ，语法：<code>v-for=&quot;item in items&quot; :key=&quot;item.id&quot;</code> 详见官网：<a href="https://cn.vuejs.org/guide/essentials/list.html#maintaining-state-with-key">通过 key 管理状态</a></p>
<p><strong>PS：遍历的数组，必须在data中定义； 要想让哪个标签循环展示多次，就在哪个标签上使用 v-for 指令。</strong></p>
<h2 id="3-2-v-bind"><a href="#3-2-v-bind" class="headerlink" title="3.2 v-bind"></a>3.2 v-bind</h2><p>作用：动态为HTML标签绑定属性值，如设置href，src，style样式等。</p>
<p>语法：<code>v-bind:属性名=&quot;属性值&quot;</code></p>
<p>简化：<code>:属性名=&quot;属性值&quot;</code></p>
<h2 id="3-3-v-if-v-show"><a href="#3-3-v-if-v-show" class="headerlink" title="3.3 v-if &amp; v-show"></a>3.3 v-if &amp; v-show</h2><p>作用：这两类指令，都是用来控制元素的显示与隐藏的。</p>
<blockquote>
<p>v-if</p>
</blockquote>
<p>语法：<code>v-if=&quot;表达式&quot;</code>，表达式值为 true，显示；false，隐藏。</p>
<p>其它：可以配合 <code>v-else-if</code> &#x2F; <code>v-else</code> 进行链式调用条件判断。</p>
<p>原理：基于条件判断，来控制创建或移除元素节点（条件渲染）。</p>
<p>场景：要么显示，要么不显示，不频繁切换的场景。</p>
<blockquote>
<p>v-show</p>
</blockquote>
<p>语法：<code>v-show=&quot;表达式&quot;</code>，表达式值为 true，显示；false，隐藏。</p>
<p>原理：基于CSS样式display来控制显示与隐藏。</p>
<p>场景：频繁切换显示隐藏的场景。</p>
<h2 id="3-4-v-on"><a href="#3-4-v-on" class="headerlink" title="3.4 v-on"></a>3.4 v-on</h2><p>作用：为html标签绑定事件。</p>
<p>语法：<code>v-on:事件名=&quot;函数名&quot;</code></p>
<p>简化：<code>@事件名=&quot;函数名&quot;</code></p>
<h2 id="3-5-v-model"><a href="#3-5-v-model" class="headerlink" title="3.5 v-model"></a>3.5 v-model</h2><p>作用：在表单元素上使用，双向数据绑定。可以方便的 获取 或 设置 表单项数据 。</p>
<p>语法：<code>v-model=&quot;变量名&quot;</code></p>
<p><strong>PS：v-model 中绑定的变量，必须在data中定义。</strong></p>
<h1 id="4-组件基础"><a href="#4-组件基础" class="headerlink" title="4. 组件基础"></a>4. 组件基础</h1><p>组件允许我们将 UI 划分为独立的、可重用的部分，并且可以对每个部分进行单独的思考。在实际应用中，组件常常被组织成层层嵌套的树状结构：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/Front-EndIMG/components%E7%BB%93%E6%9E%84.png" alt="components结构">

<p>这和我们嵌套 HTML 元素的方式类似，Vue 实现了自己的组件模型，使我们可以在每个组件内封装自定义内容与逻辑。Vue 同样也能很好地配合原生 Web Component。如果你想知道 Vue 组件与原生 Web Components 之间的关系，可以<a href="https://cn.vuejs.org/guide/extras/web-components.html">阅读此章节</a>。</p>
<p><strong>使用步骤：</strong></p>
<ol>
<li>第一步：引入组件。</li>
<li>第二步：注入组件。</li>
<li>第三步：显示组件。</li>
</ol>
<p><code>src</code>目录下新建 <code>components</code> 文件夹用于存放组件。定义一个组件<code>MyComponents.vue</code>：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>我是一个组件<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">setup</span> <span class="attr">lang</span>=<span class="string">&quot;ts&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;我是一个组件&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在App.vue引入组件（组件可以被重用任意多次）：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 第三步：显示组件 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">MyComponents</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">MyComponents</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">MyComponents</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">MyComponents</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">lang</span>=<span class="string">&quot;ts&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// 第一步：引入组件</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">import</span> <span class="title class_">MyComponents</span> <span class="keyword">from</span> <span class="string">&#x27;./components/MyComponents.vue&#x27;</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// 第二步：注入组件</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">name</span>: <span class="string">&#x27;App&#x27;</span>, <span class="comment">//组件名</span></span></span><br><span class="line"><span class="language-javascript">    <span class="attr">components</span>: &#123; <span class="title class_">MyComponents</span> &#125;</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>通过 <code>&lt;script setup&gt;</code>，导入的组件都在模板中直接可用，可以省略<code>第二步：注入组件</code>（组合式 API）</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 第三步：显示组件 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">MyComponents</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">MyComponents</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">MyComponents</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">MyComponents</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">setup</span> <span class="attr">lang</span>=<span class="string">&quot;ts&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// 第一步：引入组件</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">import</span> <span class="title class_">MyComponents</span> <span class="keyword">from</span> <span class="string">&#x27;./components/MyComponents.vue&#x27;</span></span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="5-Vue3核心语法"><a href="#5-Vue3核心语法" class="headerlink" title="5. Vue3核心语法"></a>5. Vue3核心语法</h1><h2 id="5-1-OptionsAPI-与-CompositionAPI"><a href="#5-1-OptionsAPI-与-CompositionAPI" class="headerlink" title="5.1 OptionsAPI 与 CompositionAPI"></a>5.1 OptionsAPI 与 CompositionAPI</h2><ul>
<li><code>Vue2</code>的<code>API</code>设计是<code>Options</code>（配置）风格的。选项式 API (Options API)</li>
<li><code>Vue3</code>的<code>API</code>设计是<code>Composition</code>（组合）风格的。组合式 API (Composition API)</li>
</ul>
<h3 id="5-1-1-Options-API-的弊端"><a href="#5-1-1-Options-API-的弊端" class="headerlink" title="5.1.1 Options API 的弊端"></a>5.1.1 Options API 的弊端</h3><p><code>Options</code>类型的 <code>API</code>，数据、方法、计算属性等，是分散在：<code>data</code>、<code>methods</code>、<code>computed</code>中的，若想新增或者修改一个需求，就需要分别修改：<code>data</code>、<code>methods</code>、<code>computed</code>，不便于维护和复用。</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/Front-EndIMG/%E9%80%89%E9%A1%B9%E5%BC%8FAPI(1).gif" alt="选项式API(1)" style="zoom:60%;border-radius:20px"><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/Front-EndIMG/%E9%80%89%E9%A1%B9%E5%BC%8FAPI(2).gif" alt="选项式API(2)" style="zoom:60%;border-radius:20px"></p>
<h3 id="5-1-2-Composition-API-的优势"><a href="#5-1-2-Composition-API-的优势" class="headerlink" title="5.1.2 Composition API 的优势"></a>5.1.2 Composition API 的优势</h3><p>可以用函数的方式，更加优雅的组织代码，让相关功能的代码更加有序的组织在一起。</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/Front-EndIMG/%E7%BB%84%E5%90%88%E5%BC%8FAPI(1).gif" alt="组合式API(1)" style="height:240px;border-radius:10px"><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/Front-EndIMG/%E7%BB%84%E5%90%88%E5%BC%8FAPI(2).gif" alt="组合式API(2)" style="height:240px;border-radius:10px"></p>
<p>说明：以上四张动图原创作者为大帅老猿。</p>
<h2 id="5-2-拉开序幕的-setup"><a href="#5-2-拉开序幕的-setup" class="headerlink" title="5.2 拉开序幕的 setup"></a>5.2 拉开序幕的 setup</h2><h3 id="5-2-1-setup-概述"><a href="#5-2-1-setup-概述" class="headerlink" title="5.2.1 setup 概述"></a>5.2.1 setup 概述</h3><p><code>setup</code>是<code>Vue3</code>中一个新的配置项，值是一个函数，它是 <code>Composition API</code> <strong>“表演的舞台”</strong>，组件中所用到的：数据、方法、计算属性、监视……等等，均配置在<code>setup</code>中。</p>
<p>特点如下：</p>
<ul>
<li><code>setup</code>函数返回的对象中的内容，可直接在模板中使用。</li>
<li><code>setup</code>中访问<code>this</code>是<code>undefined</code>。</li>
<li><code>setup</code>函数会在<code>beforeCreate</code>之前调用，它是“领先”所有钩子执行的。</li>
</ul>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h2</span>&gt;</span>姓名：&#123;&#123; name &#125;&#125;<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h2</span>&gt;</span>年龄：&#123;&#123; age &#125;&#125;<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;changeName&quot;</span>&gt;</span>修改名字<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;changeAge&quot;</span>&gt;</span>年龄+1<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;showTel&quot;</span>&gt;</span>点我查看联系方式<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">lang</span>=<span class="string">&quot;ts&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">name</span>: <span class="string">&#x27;App&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">setup</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 数据，原来写在data中（注意：此时的name、age、tel数据都不是响应式数据）</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> name = <span class="string">&#x27;张三&#x27;</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> age = <span class="number">18</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> tel = <span class="string">&#x27;13888888888&#x27;</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 方法，原来写在methods中</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">function</span> <span class="title function_">changeName</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            name = <span class="string">&#x27;zhang-san&#x27;</span> <span class="comment">//注意：此时这么修改name页面是不变化的</span></span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">console</span>.<span class="title function_">log</span>(name)</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">function</span> <span class="title function_">changeAge</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            age += <span class="number">1</span> <span class="comment">//注意：此时这么修改age页面是不变化的</span></span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">console</span>.<span class="title function_">log</span>(age)</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">function</span> <span class="title function_">showTel</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="title function_">alert</span>(tel)</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 返回一个对象，对象中的内容，模板中可以直接使用</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">return</span> &#123; name, age, tel, changeName, changeAge, showTel &#125;</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="5-2-2-setup-的返回值"><a href="#5-2-2-setup-的返回值" class="headerlink" title="5.2.2 setup 的返回值"></a>5.2.2 setup 的返回值</h3><ul>
<li>若返回一个<strong>对象</strong>：则对象中的：属性、方法等，在模板中均可以直接使用<strong>（重点关注）。</strong></li>
<li>若返回一个<strong>函数</strong>：则可以自定义渲染内容，代码如下：</li>
</ul>
<figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line"><span class="title function_">setup</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function">()=&gt;</span> <span class="string">&#x27;你好啊！&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-2-3-setup-与-Options-API-的关系"><a href="#5-2-3-setup-与-Options-API-的关系" class="headerlink" title="5.2.3 setup 与 Options API 的关系"></a>5.2.3 setup 与 Options API 的关系</h3><ul>
<li><code>Vue2</code> 的配置（<code>data</code>、<code>methos</code>……）中<strong>可以访问到</strong> <code>setup</code>中的属性、方法。</li>
<li>但在<code>setup</code>中<strong>不能访问到</strong><code>Vue2</code>的配置（<code>data</code>、<code>methos</code>……）。</li>
<li>如果与<code>Vue2</code>冲突，则<code>setup</code>优先。</li>
</ul>
<h3 id="5-2-4-setup-语法糖"><a href="#5-2-4-setup-语法糖" class="headerlink" title="5.2.4 setup 语法糖"></a>5.2.4 setup 语法糖</h3><p><code>setup</code>函数有一个语法糖，这个语法糖，可以让我们把<code>setup</code>独立出去，代码如下：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h2</span>&gt;</span>姓名：&#123;&#123; name &#125;&#125;<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h2</span>&gt;</span>年龄：&#123;&#123; age &#125;&#125;<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;changName&quot;</span>&gt;</span>修改名字<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;changAge&quot;</span>&gt;</span>年龄+1<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;showTel&quot;</span>&gt;</span>点我查看联系方式<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 单独使用 script 标签声明组件名，可以省略 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">lang</span>=<span class="string">&quot;ts&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">name</span>: <span class="string">&#x27;App&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 下面的写法是setup语法糖 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">setup</span> <span class="attr">lang</span>=<span class="string">&quot;ts&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>) <span class="comment">//undefined</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// 数据（注意：此时的name、age、tel都不是响应式数据）</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">let</span> name = <span class="string">&#x27;张三&#x27;</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">let</span> age = <span class="number">18</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">let</span> tel = <span class="string">&#x27;13888888888&#x27;</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// 方法</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">function</span> <span class="title function_">changName</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    name = <span class="string">&#x27;李四&#x27;</span><span class="comment">//注意：此时这么修改name页面是不变化的</span></span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"><span class="keyword">function</span> <span class="title function_">changAge</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">console</span>.<span class="title function_">log</span>(age)</span></span><br><span class="line"><span class="language-javascript">    age += <span class="number">1</span> <span class="comment">//注意：此时这么修改age页面是不变化的</span></span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"><span class="keyword">function</span> <span class="title function_">showTel</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">alert</span>(tel)</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="5-3-ref-创建：基本类型的响应式数据"><a href="#5-3-ref-创建：基本类型的响应式数据" class="headerlink" title="5.3 ref 创建：基本类型的响应式数据"></a>5.3 ref 创建：基本类型的响应式数据</h2><p>作用：定义响应式变量。</p>
<p>语法：<code>let 响应式对象 = ref(初始值)</code></p>
<p>返回值：一个 <code>RefImpl</code> 的实例对象，简称 <code>ref对象 </code>或 <code>ref</code>，<code>ref </code>对象的 <code>value</code> <strong>属性是响应式的</strong>。</p>
<p><strong>注意点：</strong></p>
<ul>
<li>使用前需要导入：<code>import &#123; ref &#125; from &#39;vue&#39;</code></li>
<li><font color="red"><code>JS</code>中操作数据需要<code>xxx.value</code>，但模板中不需要 <code>.value</code>，直接使用即可。</font></li>
<li>对于<code>let name = ref(&#39;张三&#39;)</code>来说，<code>name</code>不是响应式的，<code>name.value</code>是响应式的。</li>
</ul>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h2</span>&gt;</span>姓名：&#123;&#123; name &#125;&#125;<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h2</span>&gt;</span>年龄：&#123;&#123; age &#125;&#125;<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;changeName&quot;</span>&gt;</span>修改名字<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;changeAge&quot;</span>&gt;</span>年龄+1<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;showTel&quot;</span>&gt;</span>点我查看联系方式<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">setup</span> <span class="attr">lang</span>=<span class="string">&quot;ts&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">import</span> &#123; ref &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// name和age是一个RefImpl的实例对象，简称ref对象，它们的value属性是响应式的。</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">let</span> name = <span class="title function_">ref</span>(<span class="string">&#x27;张三&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript"><span class="keyword">let</span> age = <span class="title function_">ref</span>(<span class="number">18</span>)</span></span><br><span class="line"><span class="language-javascript"><span class="comment">// tel就是一个普通的字符串，不是响应式的</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">let</span> tel = <span class="string">&#x27;13888888888&#x27;</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">function</span> <span class="title function_">changeName</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// JS中操作ref对象时候需要.value</span></span></span><br><span class="line"><span class="language-javascript">    name.<span class="property">value</span> = <span class="string">&#x27;李四&#x27;</span></span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">console</span>.<span class="title function_">log</span>(name.<span class="property">value</span>)</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 注意：name不是响应式的，name.value是响应式的，所以如下代码并不会引起页面的更新。</span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// name = ref(&#x27;zhang-san&#x27;)</span></span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"><span class="keyword">function</span> <span class="title function_">changeAge</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// JS中操作ref对象时候需要.value</span></span></span><br><span class="line"><span class="language-javascript">    age.<span class="property">value</span> += <span class="number">1</span></span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">console</span>.<span class="title function_">log</span>(age.<span class="property">value</span>)</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"><span class="keyword">function</span> <span class="title function_">showTel</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">alert</span>(tel)</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="5-4-reactive-创建：对象类型的响应式数据"><a href="#5-4-reactive-创建：对象类型的响应式数据" class="headerlink" title="5.4 reactive 创建：对象类型的响应式数据"></a>5.4 reactive 创建：对象类型的响应式数据</h2><p>作用：定义一个<strong>响应式对象</strong>。（基本类型不要用它，要用<code>ref</code>，否则报错）</p>
<p>语法：<code>let 响应式对象 = reactive(源对象)</code></p>
<p>返回值：一个<code>Proxy</code>的实例对象，简称：响应式对象。</p>
<p><strong>注意点：</strong></p>
<ul>
<li>使用前需要导入：<code>import &#123; reactive &#125; from &#39;vue&#39;</code></li>
<li><code>reactive</code>定义的响应式数据是“深层次”的。</li>
</ul>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h2</span>&gt;</span>汽车信息：一台&#123;&#123; car.brand &#125;&#125;汽车，价值&#123;&#123; car.price &#125;&#125;万<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h2</span>&gt;</span>游戏列表：<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span> <span class="attr">v-for</span>=<span class="string">&quot;g in games&quot;</span> <span class="attr">:key</span>=<span class="string">&quot;g.id&quot;</span>&gt;</span>&#123;&#123; g.name &#125;&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h2</span>&gt;</span>测试：&#123;&#123; obj.a.b.c.d &#125;&#125;<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;changeCarPrice&quot;</span>&gt;</span>修改汽车价格<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;changeFirstGame&quot;</span>&gt;</span>修改第一游戏<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;test&quot;</span>&gt;</span>测试<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">setup</span> <span class="attr">lang</span>=<span class="string">&quot;ts&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">import</span> &#123; reactive &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// 数据</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">let</span> car = <span class="title function_">reactive</span>(&#123; <span class="attr">brand</span>: <span class="string">&#x27;奔驰&#x27;</span>, <span class="attr">price</span>: <span class="number">100</span> &#125;)</span></span><br><span class="line"><span class="language-javascript"><span class="keyword">let</span> games = <span class="title function_">reactive</span>([</span></span><br><span class="line"><span class="language-javascript">    &#123; <span class="attr">id</span>: <span class="string">&#x27;ahsgdyfa01&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;英雄联盟&#x27;</span> &#125;,</span></span><br><span class="line"><span class="language-javascript">    &#123; <span class="attr">id</span>: <span class="string">&#x27;ahsgdyfa02&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;王者荣耀&#x27;</span> &#125;,</span></span><br><span class="line"><span class="language-javascript">    &#123; <span class="attr">id</span>: <span class="string">&#x27;ahsgdyfa03&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;原神&#x27;</span> &#125;</span></span><br><span class="line"><span class="language-javascript">])</span></span><br><span class="line"><span class="language-javascript"><span class="keyword">let</span> obj = <span class="title function_">reactive</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">a</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">b</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">c</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">d</span>: <span class="number">666</span></span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">&#125;)</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">function</span> <span class="title function_">changeCarPrice</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    car.<span class="property">price</span> += <span class="number">10</span></span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"><span class="keyword">function</span> <span class="title function_">changeFirstGame</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    games[<span class="number">0</span>].<span class="property">name</span> = <span class="string">&#x27;流星蝴蝶剑&#x27;</span></span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"><span class="keyword">function</span> <span class="title function_">test</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    obj.<span class="property">a</span>.<span class="property">b</span>.<span class="property">c</span>.<span class="property">d</span> = <span class="number">999</span></span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="5-5-ref-创建：对象类型的响应式数据"><a href="#5-5-ref-创建：对象类型的响应式数据" class="headerlink" title="5.5 ref 创建：对象类型的响应式数据"></a>5.5 ref 创建：对象类型的响应式数据</h2><p>其实<code>ref</code>接收的数据可以是：<strong>基本类型</strong>、<strong>对象类型</strong>。若<code>ref</code>接收的是对象类型，内部其实也是调用了<code>reactive</code>函数。区别在于操作数据是否需要加：<code>.value</code>。</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h2</span>&gt;</span>汽车信息：一台&#123;&#123; car.brand &#125;&#125;汽车，价值&#123;&#123; car.price &#125;&#125;万<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h2</span>&gt;</span>游戏列表：<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span> <span class="attr">v-for</span>=<span class="string">&quot;g in games&quot;</span> <span class="attr">:key</span>=<span class="string">&quot;g.id&quot;</span>&gt;</span>&#123;&#123; g.name &#125;&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h2</span>&gt;</span>测试：&#123;&#123; obj.a.b.c.d &#125;&#125;<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;changeCarPrice&quot;</span>&gt;</span>修改汽车价格<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;changeFirstGame&quot;</span>&gt;</span>修改第一游戏<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;test&quot;</span>&gt;</span>测试<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">setup</span> <span class="attr">lang</span>=<span class="string">&quot;ts&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">import</span> &#123; ref &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// 数据</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">let</span> car = <span class="title function_">ref</span>(&#123; <span class="attr">brand</span>: <span class="string">&#x27;奔驰&#x27;</span>, <span class="attr">price</span>: <span class="number">100</span> &#125;)</span></span><br><span class="line"><span class="language-javascript"><span class="keyword">let</span> games = <span class="title function_">ref</span>([</span></span><br><span class="line"><span class="language-javascript">    &#123; <span class="attr">id</span>: <span class="string">&#x27;ahsgdyfa01&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;英雄联盟&#x27;</span> &#125;,</span></span><br><span class="line"><span class="language-javascript">    &#123; <span class="attr">id</span>: <span class="string">&#x27;ahsgdyfa02&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;王者荣耀&#x27;</span> &#125;,</span></span><br><span class="line"><span class="language-javascript">    &#123; <span class="attr">id</span>: <span class="string">&#x27;ahsgdyfa03&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;原神&#x27;</span> &#125;</span></span><br><span class="line"><span class="language-javascript">])</span></span><br><span class="line"><span class="language-javascript"><span class="keyword">let</span> obj = <span class="title function_">ref</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">a</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">b</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">c</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">d</span>: <span class="number">666</span></span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">&#125;)</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">function</span> <span class="title function_">changeCarPrice</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    car.<span class="property">value</span>.<span class="property">price</span> += <span class="number">10</span></span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">console</span>.<span class="title function_">log</span>(car.<span class="property">value</span>.<span class="property">price</span>)</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"><span class="keyword">function</span> <span class="title function_">changeFirstGame</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    games.<span class="property">value</span>[<span class="number">0</span>].<span class="property">name</span> = <span class="string">&#x27;流星蝴蝶剑&#x27;</span></span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"><span class="keyword">function</span> <span class="title function_">test</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    obj.<span class="property">value</span>.<span class="property">a</span>.<span class="property">b</span>.<span class="property">c</span>.<span class="property">d</span> = <span class="number">999</span></span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="5-6-ref-对比-reactive"><a href="#5-6-ref-对比-reactive" class="headerlink" title="5.6 ref 对比 reactive"></a>5.6 ref 对比 reactive</h2><p>宏观角度看：</p>
<ul>
<li><p><code>ref</code>用来定义：<strong>基本类型数据</strong>、<strong>对象类型数据</strong>。</p>
</li>
<li><p><code>reactive</code>用来定义：<strong>对象类型数据</strong>。</p>
</li>
</ul>
<p>区别：</p>
<ul>
<li><p><code>ref</code>创建的变量必须使用<code>.value</code>（可以使用<code>volar</code>插件自动添加<code>.value</code>）</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/Front-EndIMG/%E8%87%AA%E5%8A%A8%E8%A1%A5%E5%85%85value.png" alt="自动补充value" style="zoom:50%;border-radius:20px"> 
</li>
<li><p><code>reactive</code>重新分配一个新对象，会<strong>失去</strong>响应式（可以使用<code>Object.assign</code>去整体替换）。</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h2</span>&gt;</span>汽车信息：一台&#123;&#123; car.brand &#125;&#125;汽车，价值&#123;&#123; car.price &#125;&#125;万<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;changeCar&quot;</span>&gt;</span>修改汽车<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">setup</span> <span class="attr">lang</span>=<span class="string">&quot;ts&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">import</span> &#123; reactive, ref &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// let car = reactive(&#123; brand: &#x27;奔驰&#x27;, price: 100 &#125;)</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">let</span> car = <span class="title function_">ref</span>(&#123; <span class="attr">brand</span>: <span class="string">&#x27;奔驰&#x27;</span>, <span class="attr">price</span>: <span class="number">100</span> &#125;)</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">function</span> <span class="title function_">changeCar</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// car = &#123;brand:&#x27;奥拓&#x27;,price:1&#125; //这么写页面不更新的</span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// car = reactive(&#123;brand:&#x27;奥拓&#x27;,price:1&#125;) //这么写页面不更新的</span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// Object.assign(car, &#123; brand: &#x27;奥拓&#x27;, price: 1 &#125;) // 这个写法页面可以更新</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 使用 ref 这样写，页面可以更新</span></span></span><br><span class="line"><span class="language-javascript">    car.<span class="property">value</span> = &#123; <span class="attr">brand</span>: <span class="string">&#x27;奥拓&#x27;</span>, <span class="attr">price</span>: <span class="number">1</span> &#125;</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p>使用原则：</p>
<ul>
<li>若需要一个基本类型的响应式数据，必须使用<code>ref</code>。</li>
<li>若需要一个响应式对象，层级不深，<code>ref</code>、<code>reactive</code>都可以。</li>
<li>若需要一个响应式对象，且层级较深，推荐使用<code>reactive</code>。</li>
</ul>
<h2 id="5-7-toRefs-与-toRef"><a href="#5-7-toRefs-与-toRef" class="headerlink" title="5.7 toRefs 与 toRef"></a>5.7 toRefs 与 toRef</h2><p>作用：将一个响应式对象中的每一个属性，转换为<code>ref</code>对象。</p>
<p>注意点：</p>
<ul>
<li>使用前需要导入：<code>import &#123; toRefs, toRef &#125; from &#39;vue&#39;</code></li>
<li><code>toRefs</code>与<code>toRef</code>功能一致，但<code>toRefs</code>可以批量转换。</li>
</ul>
<p>语法如下：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h2</span>&gt;</span>姓名：&#123;&#123; person.name &#125;&#125;<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h2</span>&gt;</span>年龄：&#123;&#123; person.age &#125;&#125;<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h2</span>&gt;</span>性别：&#123;&#123; person.gender &#125;&#125;<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;changeName&quot;</span>&gt;</span>修改名字<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;changeAge&quot;</span>&gt;</span>修改年龄<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;changeGender&quot;</span>&gt;</span>修改性别<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">setup</span> <span class="attr">lang</span>=<span class="string">&quot;ts&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">import</span> &#123; reactive, toRefs, toRef &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// 数据</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">let</span> person = <span class="title function_">reactive</span>(&#123; <span class="attr">name</span>: <span class="string">&#x27;张三&#x27;</span>, <span class="attr">age</span>: <span class="number">18</span>, <span class="attr">gender</span>: <span class="string">&#x27;男&#x27;</span> &#125;)</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// 通过toRefs将person对象中的n个属性批量取出，且依然保持响应式的能力</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">let</span> &#123; name, gender &#125; = <span class="title function_">toRefs</span>(person)</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// 通过toRef将person对象中的gender属性取出，且依然保持响应式的能力</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">let</span> age = <span class="title function_">toRef</span>(person, <span class="string">&#x27;age&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// 方法</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">function</span> <span class="title function_">changeName</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    name.<span class="property">value</span> += <span class="string">&#x27;~&#x27;</span></span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"><span class="keyword">function</span> <span class="title function_">changeAge</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    age.<span class="property">value</span> += <span class="number">1</span></span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"><span class="keyword">function</span> <span class="title function_">changeGender</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    gender.<span class="property">value</span> = <span class="string">&#x27;女&#x27;</span></span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="5-8-computed"><a href="#5-8-computed" class="headerlink" title="5.8 computed"></a>5.8 computed</h2><p>作用：根据已有数据计算出新数据（和<code>Vue2</code>中的<code>computed</code>作用一致）。</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/Front-EndIMG/computed.gif" alt="computed" style="zoom:25%;">

<p>注意点：</p>
<ul>
<li>使用前需要导入：<code>import &#123; computed &#125; from &#39;vue&#39;</code></li>
</ul>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">        姓：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">v-model</span>=<span class="string">&quot;firstName&quot;</span>&gt;</span> <span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">        名：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">v-model</span>=<span class="string">&quot;lastName&quot;</span>&gt;</span> <span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">        全名：<span class="tag">&lt;<span class="name">span</span>&gt;</span>&#123;&#123; fullName &#125;&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span> <span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;changeFullName&quot;</span>&gt;</span>全名改为：li-si<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">setup</span> <span class="attr">lang</span>=<span class="string">&quot;ts&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">import</span> &#123; ref, computed &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">let</span> firstName = <span class="title function_">ref</span>(<span class="string">&#x27;zhang&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript"><span class="keyword">let</span> lastName = <span class="title function_">ref</span>(<span class="string">&#x27;san&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// 计算属性——只读取，不修改</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">/* let fullName = computed(()=&gt;&#123;</span></span></span><br><span class="line"><span class="comment"><span class="language-javascript">  return firstName.value + &#x27;-&#x27; + lastName.value</span></span></span><br><span class="line"><span class="comment"><span class="language-javascript">&#125;) */</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// 计算属性——既读取又修改</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">let</span> fullName = <span class="title function_">computed</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 读取</span></span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">get</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">return</span> firstName.<span class="property">value</span> + <span class="string">&#x27;-&#x27;</span> + lastName.<span class="property">value</span></span></span><br><span class="line"><span class="language-javascript">    &#125;,</span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 修改</span></span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">set</span>(<span class="params">val</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;有人修改了fullName&#x27;</span>, val)</span></span><br><span class="line"><span class="language-javascript">        firstName.<span class="property">value</span> = val.<span class="title function_">split</span>(<span class="string">&#x27;-&#x27;</span>)[<span class="number">0</span>]</span></span><br><span class="line"><span class="language-javascript">        lastName.<span class="property">value</span> = val.<span class="title function_">split</span>(<span class="string">&#x27;-&#x27;</span>)[<span class="number">1</span>]</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">&#125;)</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">function</span> <span class="title function_">changeFullName</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    fullName.<span class="property">value</span> = <span class="string">&#x27;li-si&#x27;</span></span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="5-9-watch"><a href="#5-9-watch" class="headerlink" title="5.9 watch"></a>5.9 watch</h2><p>作用：监视数据的变化（和<code>Vue2</code>中的<code>watch</code>作用一致）</p>
<p>特点：<code>Vue3</code>中的<code>watch</code>只能监视以下<strong>四种数据</strong>：</p>
<ul>
<li><code>ref</code> 定义的数据。</li>
<li><code>reactive </code>定义的数据。</li>
<li>函数返回一个值（<code>getter</code>函数）。</li>
<li>一个包含上述内容的数组。</li>
</ul>
<p>注意点：</p>
<ul>
<li>使用前需要导入：<code>import &#123; watch &#125; from &#39;vue&#39;</code></li>
</ul>
<p>我们在<code>Vue3</code>中使用<code>watch</code>的时候，通常会遇到以下几种情况：</p>
<blockquote>
<p>情况一</p>
</blockquote>
<p>监视<code>ref</code>定义的【基本类型】数据：直接写数据名即可，监视的是其<code>value</code>值的改变。</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h1</span>&gt;</span>情况一：监视【ref】定义的【基本类型】数据<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h2</span>&gt;</span>当前求和为：&#123;&#123; sum &#125;&#125;<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;changeSum&quot;</span>&gt;</span>点我sum+1<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">setup</span> <span class="attr">lang</span>=<span class="string">&quot;ts&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">import</span> &#123; ref, watch &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// 数据</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">let</span> sum = <span class="title function_">ref</span>(<span class="number">0</span>)</span></span><br><span class="line"><span class="language-javascript"><span class="comment">// 方法</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">function</span> <span class="title function_">changeSum</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    sum.<span class="property">value</span> += <span class="number">1</span></span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"><span class="comment">// 监视，情况一：监视【ref】定义的【基本类型】数据</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">const</span> stopWatch = <span class="title function_">watch</span>(sum, <span class="function">(<span class="params">newValue, oldValue</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;sum变化了&#x27;</span>, newValue, oldValue)</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">if</span> (newValue &gt;= <span class="number">10</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">stopWatch</span>()</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">&#125;)</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>情况二</p>
</blockquote>
<p>监视<code>ref</code>定义的【对象类型】数据：直接写数据名，监视的是对象的【地址值】，若想监视对象内部的数据，要手动开启深度监视。</p>
<p><font color="red"><strong>注意：</strong></font></p>
<ul>
<li><p>若修改的是 <code>ref</code> 定义的对象中的属性，<code>newValue</code> 和 <code>oldValue</code> 都是新值，因为它们是同一个对象。</p>
</li>
<li><p>若修改整个 <code>ref</code> 定义的对象，<code>newValue</code> 是新值， <code>oldValue</code> 是旧值，因为不是同一个对象了。</p>
</li>
</ul>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>情况二：监视【ref】定义的【对象类型】数据<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h2</span>&gt;</span>姓名：&#123;&#123; person.name &#125;&#125;<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h2</span>&gt;</span>年龄：&#123;&#123; person.age &#125;&#125;<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;changeName&quot;</span>&gt;</span>修改名字<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;changeAge&quot;</span>&gt;</span>修改年龄<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;changePerson&quot;</span>&gt;</span>修改整个人<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">setup</span> <span class="attr">lang</span>=<span class="string">&quot;ts&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">import</span> &#123;ref,watch&#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span></span><br><span class="line"><span class="language-javascript">  <span class="comment">// 数据</span></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">let</span> person = <span class="title function_">ref</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">name</span>:<span class="string">&#x27;张三&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">age</span>:<span class="number">18</span></span></span><br><span class="line"><span class="language-javascript">  &#125;)</span></span><br><span class="line"><span class="language-javascript">  <span class="comment">// 方法</span></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">function</span> <span class="title function_">changeName</span>(<span class="params"></span>)&#123;</span></span><br><span class="line"><span class="language-javascript">    person.<span class="property">value</span>.<span class="property">name</span> += <span class="string">&#x27;~&#x27;</span></span></span><br><span class="line"><span class="language-javascript">  &#125;</span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">function</span> <span class="title function_">changeAge</span>(<span class="params"></span>)&#123;</span></span><br><span class="line"><span class="language-javascript">    person.<span class="property">value</span>.<span class="property">age</span> += <span class="number">1</span></span></span><br><span class="line"><span class="language-javascript">  &#125;</span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">function</span> <span class="title function_">changePerson</span>(<span class="params"></span>)&#123;</span></span><br><span class="line"><span class="language-javascript">    person.<span class="property">value</span> = &#123;<span class="attr">name</span>:<span class="string">&#x27;李四&#x27;</span>,<span class="attr">age</span>:<span class="number">90</span>&#125;</span></span><br><span class="line"><span class="language-javascript">  &#125;</span></span><br><span class="line"><span class="language-javascript">  <span class="comment">/* </span></span></span><br><span class="line"><span class="comment"><span class="language-javascript">    监视，情况一：监视【ref】定义的【对象类型】数据，监视的是对象的地址值，若想监视对象内部属性的变化，需要手动开启深度监视</span></span></span><br><span class="line"><span class="comment"><span class="language-javascript">    watch的第一个参数是：被监视的数据</span></span></span><br><span class="line"><span class="comment"><span class="language-javascript">    watch的第二个参数是：监视的回调</span></span></span><br><span class="line"><span class="comment"><span class="language-javascript">    watch的第三个参数是：配置对象（deep、immediate等等.....） </span></span></span><br><span class="line"><span class="comment"><span class="language-javascript">  */</span></span></span><br><span class="line"><span class="language-javascript">  <span class="title function_">watch</span>(person,<span class="function">(<span class="params">newValue,oldValue</span>)=&gt;</span>&#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;person变化了&#x27;</span>,newValue,oldValue)</span></span><br><span class="line"><span class="language-javascript">  &#125;,&#123;<span class="attr">deep</span>:<span class="literal">true</span>&#125;)</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>情况三</p>
</blockquote>
<p>监视 <code>reactive</code> 定义的【对象类型】数据，且默认开启了深度监视，不能关闭。</p>
<p><font color="red"><strong>注意：</strong></font></p>
<ul>
<li>直接给 <code>watch()</code> 传入一个响应式对象，会隐式地创建一个深层侦听器——该回调函数在所有嵌套的变更时都会被触发。</li>
<li>若修改的是 <code>reactive</code> 定义的对象或者对象属性，<code>newValue</code> 和 <code>oldValue</code> 都是新值，因为它们是同一个对象。</li>
</ul>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h1</span>&gt;</span>情况三：监视【reactive】定义的【对象类型】数据<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h2</span>&gt;</span>姓名：&#123;&#123; person.name &#125;&#125;<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h2</span>&gt;</span>年龄：&#123;&#123; person.age &#125;&#125;<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;changeName&quot;</span>&gt;</span>修改名字<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;changeAge&quot;</span>&gt;</span>修改年龄<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;changePerson&quot;</span>&gt;</span>修改整个人<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">hr</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h2</span>&gt;</span>测试：&#123;&#123; obj.a.b.c &#125;&#125;<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;test&quot;</span>&gt;</span>修改obj.a.b.c<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">setup</span> <span class="attr">lang</span>=<span class="string">&quot;ts&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">import</span> &#123; reactive, watch &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// 数据</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">let</span> person = <span class="title function_">reactive</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">name</span>: <span class="string">&#x27;张三&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">age</span>: <span class="number">18</span></span></span><br><span class="line"><span class="language-javascript">&#125;)</span></span><br><span class="line"><span class="language-javascript"><span class="keyword">let</span> obj = <span class="title function_">reactive</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">a</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">b</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">c</span>: <span class="number">666</span></span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">&#125;)</span></span><br><span class="line"><span class="language-javascript"><span class="comment">// 方法</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">function</span> <span class="title function_">changeName</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    person.<span class="property">name</span> += <span class="string">&#x27;~&#x27;</span></span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"><span class="keyword">function</span> <span class="title function_">changeAge</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    person.<span class="property">age</span> += <span class="number">1</span></span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"><span class="keyword">function</span> <span class="title function_">changePerson</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="title class_">Object</span>.<span class="title function_">assign</span>(person, &#123; <span class="attr">name</span>: <span class="string">&#x27;李四&#x27;</span>, <span class="attr">age</span>: <span class="number">80</span> &#125;)</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"><span class="keyword">function</span> <span class="title function_">test</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    obj.<span class="property">a</span>.<span class="property">b</span>.<span class="property">c</span> = <span class="number">888</span></span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// 监视，情况三：监视【reactive】定义的【对象类型】数据，且默认是开启深度监视的，不能关闭</span></span></span><br><span class="line"><span class="language-javascript"><span class="title function_">watch</span>(person, <span class="function">(<span class="params">newValue, oldValue</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;person变化了&#x27;</span>, newValue, oldValue)</span></span><br><span class="line"><span class="language-javascript">&#125;)</span></span><br><span class="line"><span class="language-javascript"><span class="title function_">watch</span>(obj, <span class="function">(<span class="params">newValue, oldValue</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Obj变化了&#x27;</span>, newValue, oldValue)</span></span><br><span class="line"><span class="language-javascript">&#125;)</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>情况四</p>
</blockquote>
<p>监视 <code>ref</code> 或 <code>reactive</code> 定义的【对象类型】数据中的<strong>某个属性</strong>。</p>
<p><font color="red"><strong>注意：</strong></font></p>
<ul>
<li>若该属性值<strong>不是</strong>【对象类型】，需要写成函数形式。</li>
<li>若该属性值是<strong>依然</strong>是【对象类型】，可直接编，也可写成函数，建议写成函数。</li>
</ul>
<p>结论：监视的要是对象里的属性，那么最好写函数式。<font color="red"><strong>注意点：</strong></font>若是对象监视的是地址值，需要关注对象内部，需要手动开启深度监视。</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h1</span>&gt;</span>情况四：监视【ref】或【reactive】定义的【对象类型】数据中的某个属性<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h2</span>&gt;</span>姓名：&#123;&#123; person.name &#125;&#125;<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h2</span>&gt;</span>年龄：&#123;&#123; person.age &#125;&#125;<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h2</span>&gt;</span>汽车：&#123;&#123; person.car.c1 &#125;&#125;、&#123;&#123; person.car.c2 &#125;&#125;<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;changeName&quot;</span>&gt;</span>修改名字<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;changeAge&quot;</span>&gt;</span>修改年龄<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;changeC1&quot;</span>&gt;</span>修改第一台车<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;changeC2&quot;</span>&gt;</span>修改第二台车<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;changeCar&quot;</span>&gt;</span>修改整个车<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">setup</span> <span class="attr">lang</span>=<span class="string">&quot;ts&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">import</span> &#123; reactive, watch &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// 数据</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">let</span> person = <span class="title function_">reactive</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">name</span>: <span class="string">&#x27;张三&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">age</span>: <span class="number">18</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">car</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">c1</span>: <span class="string">&#x27;奔驰&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">c2</span>: <span class="string">&#x27;宝马&#x27;</span></span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">&#125;)</span></span><br><span class="line"><span class="language-javascript"><span class="comment">// 方法</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">function</span> <span class="title function_">changeName</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    person.<span class="property">name</span> += <span class="string">&#x27;~&#x27;</span></span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"><span class="keyword">function</span> <span class="title function_">changeAge</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    person.<span class="property">age</span> += <span class="number">1</span></span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"><span class="keyword">function</span> <span class="title function_">changeC1</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    person.<span class="property">car</span>.<span class="property">c1</span> = <span class="string">&#x27;奥迪&#x27;</span></span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"><span class="keyword">function</span> <span class="title function_">changeC2</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    person.<span class="property">car</span>.<span class="property">c2</span> = <span class="string">&#x27;大众&#x27;</span></span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"><span class="keyword">function</span> <span class="title function_">changeCar</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    person.<span class="property">car</span> = &#123; <span class="attr">c1</span>: <span class="string">&#x27;雅迪&#x27;</span>, <span class="attr">c2</span>: <span class="string">&#x27;爱玛&#x27;</span> &#125;</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// 监视，情况四：监视响应式对象中的某个属性，且该属性是基本类型的，要写成函数式</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">/* watch(()=&gt; person.name,(newValue,oldValue)=&gt;&#123;</span></span></span><br><span class="line"><span class="comment"><span class="language-javascript">  console.log(&#x27;person.name变化了&#x27;,newValue,oldValue)</span></span></span><br><span class="line"><span class="comment"><span class="language-javascript">&#125;) */</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// 监视，情况四：监视响应式对象中的某个属性，且该属性是对象类型的，可以直接写，也能写函数，更推荐写函数</span></span></span><br><span class="line"><span class="language-javascript"><span class="title function_">watch</span>(<span class="function">() =&gt;</span> person.<span class="property">car</span>, <span class="function">(<span class="params">newValue, oldValue</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;person.car变化了&#x27;</span>, newValue, oldValue)</span></span><br><span class="line"><span class="language-javascript">&#125;, &#123; <span class="attr">deep</span>: <span class="literal">true</span> &#125;)</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>情况五</p>
</blockquote>
<p>监视上述的多个数据</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h1</span>&gt;</span>情况五：监视上述的多个数据<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h2</span>&gt;</span>姓名：&#123;&#123; person.name &#125;&#125;<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h2</span>&gt;</span>年龄：&#123;&#123; person.age &#125;&#125;<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h2</span>&gt;</span>汽车：&#123;&#123; person.car.c1 &#125;&#125;、&#123;&#123; person.car.c2 &#125;&#125;<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;changeName&quot;</span>&gt;</span>修改名字<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;changeAge&quot;</span>&gt;</span>修改年龄<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;changeC1&quot;</span>&gt;</span>修改第一台车<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;changeC2&quot;</span>&gt;</span>修改第二台车<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;changeCar&quot;</span>&gt;</span>修改整个车<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">setup</span> <span class="attr">lang</span>=<span class="string">&quot;ts&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">import</span> &#123; reactive, watch &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// 数据</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">let</span> person = <span class="title function_">reactive</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">name</span>: <span class="string">&#x27;张三&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">age</span>: <span class="number">18</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">car</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">c1</span>: <span class="string">&#x27;奔驰&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">c2</span>: <span class="string">&#x27;宝马&#x27;</span></span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">&#125;)</span></span><br><span class="line"><span class="language-javascript"><span class="comment">// 方法</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">function</span> <span class="title function_">changeName</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    person.<span class="property">name</span> += <span class="string">&#x27;~&#x27;</span></span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"><span class="keyword">function</span> <span class="title function_">changeAge</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    person.<span class="property">age</span> += <span class="number">1</span></span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"><span class="keyword">function</span> <span class="title function_">changeC1</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    person.<span class="property">car</span>.<span class="property">c1</span> = <span class="string">&#x27;奥迪&#x27;</span></span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"><span class="keyword">function</span> <span class="title function_">changeC2</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    person.<span class="property">car</span>.<span class="property">c2</span> = <span class="string">&#x27;大众&#x27;</span></span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"><span class="keyword">function</span> <span class="title function_">changeCar</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    person.<span class="property">car</span> = &#123; <span class="attr">c1</span>: <span class="string">&#x27;雅迪&#x27;</span>, <span class="attr">c2</span>: <span class="string">&#x27;爱玛&#x27;</span> &#125;</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// 监视，情况五：监视上述的多个数据</span></span></span><br><span class="line"><span class="language-javascript"><span class="title function_">watch</span>([<span class="function">() =&gt;</span> person.<span class="property">name</span>, person.<span class="property">car</span>], <span class="function">(<span class="params">newValue, oldValue</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;person.car变化了&#x27;</span>, newValue, oldValue)</span></span><br><span class="line"><span class="language-javascript">&#125;, &#123; <span class="attr">deep</span>: <span class="literal">true</span> &#125;)</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="5-10-watchEffect"><a href="#5-10-watchEffect" class="headerlink" title="5.10 watchEffect"></a>5.10 watchEffect</h2><p>官网：立即运行一个函数，同时响应式地追踪其依赖，并在依赖更改时重新执行该函数。</p>
<p><code>watch</code> 对比 <code>watchEffect</code> ：</p>
<ul>
<li><p>都能监听响应式数据的变化，不同的是监听数据变化的方式不同</p>
</li>
<li><p><code>watch</code>：要明确指出监视的数据</p>
</li>
<li><p><code>watchEffect</code>：不用明确指出监视的数据（函数中用到哪些属性，那就监视哪些属性）。</p>
</li>
</ul>
<p>注意点：</p>
<ul>
<li>使用前需要导入：<code>import &#123; watchEffect &#125; from &#39;vue&#39;</code></li>
</ul>
<p>示例代码：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h1</span>&gt;</span>需求：水温达到50℃，或水位达到20cm，则联系服务器<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h2</span> <span class="attr">id</span>=<span class="string">&quot;demo&quot;</span>&gt;</span>水温：&#123;&#123; temp &#125;&#125;℃<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h2</span>&gt;</span>水位：&#123;&#123; height &#125;&#125;cm<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;changePrice&quot;</span>&gt;</span>水温+10<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;changeSum&quot;</span>&gt;</span>水位+10<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">setup</span> <span class="attr">lang</span>=<span class="string">&quot;ts&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">import</span> &#123; ref, watch, watchEffect &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// 数据</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">let</span> temp = <span class="title function_">ref</span>(<span class="number">0</span>)</span></span><br><span class="line"><span class="language-javascript"><span class="keyword">let</span> height = <span class="title function_">ref</span>(<span class="number">0</span>)</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// 方法</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">function</span> <span class="title function_">changePrice</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    temp.<span class="property">value</span> += <span class="number">10</span></span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"><span class="keyword">function</span> <span class="title function_">changeSum</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    height.<span class="property">value</span> += <span class="number">10</span></span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// 用watch实现，需要明确的指出要监视：temp、height</span></span></span><br><span class="line"><span class="language-javascript"><span class="title function_">watch</span>([temp, height], <span class="function">(<span class="params">value</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 从value中获取最新的temp值、height值</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">const</span> [newTemp, newHeight] = value</span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 室温达到50℃，或水位达到20cm，立刻联系服务器</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">if</span> (newTemp &gt;= <span class="number">50</span> || newHeight &gt;= <span class="number">20</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;联系服务器&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">&#125;)</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// 用watchEffect实现，不用</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">const</span> stopWtach = <span class="title function_">watchEffect</span>(<span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 水温达到50℃，或水位达到20cm，立刻联系服务器</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">if</span> (temp.<span class="property">value</span> &gt;= <span class="number">50</span> || height.<span class="property">value</span> &gt;= <span class="number">20</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;联系服务器&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 水温达到100℃，或水位达到50cm，取消监视</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">if</span> (temp.<span class="property">value</span> === <span class="number">100</span> || height.<span class="property">value</span> === <span class="number">50</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;清理了&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">stopWtach</span>()</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">&#125;)</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="5-11-标签的-ref-属性"><a href="#5-11-标签的-ref-属性" class="headerlink" title="5.11 标签的 ref 属性"></a>5.11 标签的 ref 属性</h2><p>作用：用于注册模板引用。</p>
<ul>
<li><p>用在普通<code>DOM</code>标签上，获取的是<code>DOM</code>节点。</p>
</li>
<li><p>用在组件标签上，获取的是组件实例对象。</p>
</li>
</ul>
<p>注意点：</p>
<ul>
<li>使用前需要导入：<code>import &#123; ref &#125; from &#39;vue&#39;</code></li>
</ul>
<p>用在普通<code>DOM</code>标签上：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h1</span> <span class="attr">id</span>=<span class="string">&quot;title1&quot;</span>&gt;</span>你好<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h1</span> <span class="attr">ref</span>=<span class="string">&quot;title1&quot;</span>&gt;</span>你好<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;showLog&quot;</span>&gt;</span>点我打印内容<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">setup</span> <span class="attr">lang</span>=<span class="string">&quot;ts&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">import</span> &#123; ref &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">let</span> title1 = <span class="title function_">ref</span>()</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">function</span> <span class="title function_">showLog</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 通过id获取元素</span></span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;title1&#x27;</span>)) <span class="comment">//&lt;h1 id=&quot;title1&quot;&gt;你好&lt;/h1&gt;</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 通过ref获取元素</span></span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">console</span>.<span class="title function_">log</span>(title1.<span class="property">value</span>) <span class="comment">//&lt;h1&gt;你好&lt;/h1&gt;</span></span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>用在组件标签上：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 父组件App.vue --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Person</span> <span class="attr">ref</span>=<span class="string">&quot;ren&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;test&quot;</span>&gt;</span>测试<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">setup</span> <span class="attr">lang</span>=<span class="string">&quot;ts&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">import</span> <span class="title class_">Person</span> <span class="keyword">from</span> <span class="string">&#x27;./components/Person.vue&#x27;</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">import</span> &#123; ref &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">let</span> ren = <span class="title function_">ref</span>()</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">function</span> <span class="title function_">test</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">console</span>.<span class="title function_">log</span>(ren.<span class="property">value</span>) <span class="comment">//拿到组件实例</span></span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>可以拿到组件实例对象，但是看不到里面的任何东西，这是一种保护机制。</p>
<p>如果要看子组件内容，子组件 <code>&lt;script&gt;</code> 标签中要使用 <code>defineExpose</code> 暴露内容：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 数据</span></span><br><span class="line"><span class="keyword">let</span> name = <span class="title function_">ref</span>(<span class="string">&#x27;张三&#x27;</span>)</span><br><span class="line"><span class="keyword">let</span> age = <span class="title function_">ref</span>(<span class="number">18</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用 defineExpose 将组件中的数据交给外部</span></span><br><span class="line"><span class="title function_">defineExpose</span>(&#123; name, age &#125;)</span><br></pre></td></tr></table></figure>

<h2 id="5-12-props"><a href="#5-12-props" class="headerlink" title="5.12 props"></a>5.12 props</h2><p><code>src</code> 目录下新建 <code>types  </code>文件夹，新建 <code>index.ts</code>：</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 定义一个接口，限制每个Person对象的格式</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">PersonInter</span> &#123;</span><br><span class="line">    <span class="attr">id</span>: <span class="built_in">string</span>,	<span class="comment">//小写string</span></span><br><span class="line">    <span class="attr">name</span>: <span class="built_in">string</span>,</span><br><span class="line">    <span class="attr">age</span>: <span class="built_in">number</span>,</span><br><span class="line">    <span class="comment">// x?: number,	//可选属性，不传也不报错</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义一个自定义类型Persons</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> <span class="title class_">Persons</span> = <span class="title class_">Array</span>&lt;<span class="title class_">PersonInter</span>&gt;</span><br></pre></td></tr></table></figure>

<p><code>App.vue</code>中代码：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">Person</span> <span class="attr">:list</span>=<span class="string">&quot;persons&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">setup</span> <span class="attr">lang</span>=<span class="string">&quot;ts&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">import</span> <span class="title class_">Person</span> <span class="keyword">from</span> <span class="string">&#x27;./components/Person.vue&#x27;</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">import</span> &#123;reactive&#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">import</span> &#123;type <span class="title class_">Persons</span>&#125; <span class="keyword">from</span> <span class="string">&#x27;./types&#x27;</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">let</span> persons = reactive&lt;<span class="title class_">Persons</span>&gt;([</span></span><br><span class="line"><span class="language-javascript">&#123;<span class="attr">id</span>:<span class="string">&#x27;e98219e12&#x27;</span>,<span class="attr">name</span>:<span class="string">&#x27;张三&#x27;</span>,<span class="attr">age</span>:<span class="number">18</span>&#125;,</span></span><br><span class="line"><span class="language-javascript">&#123;<span class="attr">id</span>:<span class="string">&#x27;e98219e13&#x27;</span>,<span class="attr">name</span>:<span class="string">&#x27;李四&#x27;</span>,<span class="attr">age</span>:<span class="number">19</span>&#125;,</span></span><br><span class="line"><span class="language-javascript">&#123;<span class="attr">id</span>:<span class="string">&#x27;e98219e14&#x27;</span>,<span class="attr">name</span>:<span class="string">&#x27;王五&#x27;</span>,<span class="attr">age</span>:<span class="number">20</span>&#125;</span></span><br><span class="line"><span class="language-javascript">])</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>Person.vue</code>中代码：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">        &lt;ul&gt;</span><br><span class="line">            &lt;li v-for=&quot;item in list&quot; :key=&quot;item.id&quot;&gt;</span><br><span class="line">                &#123;&#123; item.name &#125;&#125;--&#123;&#123; item.age &#125;&#125;</span><br><span class="line">            &lt;/li&gt;</span><br><span class="line">        &lt;/ul&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import &#123; type Persons &#125; from &#x27;@/types&#x27;</span><br><span class="line"></span><br><span class="line">// 第一种写法：仅接收</span><br><span class="line">// const props = defineProps([&#x27;list&#x27;])</span><br><span class="line"></span><br><span class="line">// 第二种写法：接收 + 限制类型</span><br><span class="line">// defineProps&lt;&#123; list: Persons &#125;&gt;()</span><br><span class="line"></span><br><span class="line">// 第三种写法：接收 + 限制类型 + 指定默认值 + 限制必要性</span><br><span class="line">let props = withDefaults(defineProps&lt;&#123; list?: Persons &#125;&gt;(), &#123;</span><br><span class="line">    list: () =&gt; [&#123; id: &#x27;asdasg01&#x27;, name: &#x27;小猪佩奇&#x27;, age: 18 &#125;]</span><br><span class="line">&#125;)</span><br><span class="line">console.log(props)</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<h2 id="5-13-生命周期"><a href="#5-13-生命周期" class="headerlink" title="5.13 生命周期"></a>5.13 生命周期</h2><p>概念：<code>Vue</code> 组件实例在创建时要经历一系列的初始化步骤，在此过程中 <code>Vue</code> 会在合适的时机，调用特定的函数，从而让开发者有机会在特定阶段运行自己的代码，这些特定的函数统称为：生命周期钩子</p>
<p>规律：生命周期整体分为四个阶段，分别是：<strong>创建、挂载、更新、销毁</strong>，每个阶段都有两个钩子，一前一后。</p>
<p><code>Vue2</code> 的生命周期：</p>
<ul>
<li><p>创建阶段：<code>beforeCreate</code>、<code>created</code></p>
</li>
<li><p>挂载阶段：<code>beforeMount</code>、<code>mounted</code></p>
</li>
<li><p>更新阶段：<code>beforeUpdate</code>、<code>updated</code></p>
</li>
<li><p>销毁阶段：<code>beforeDestroy</code>、<code>destroyed</code></p>
</li>
</ul>
<p><code>Vue3</code> 的生命周期：</p>
<ul>
<li><p>创建阶段：<code>setup</code></p>
</li>
<li><p>挂载阶段：<code>onBeforeMount</code>、<code>onMounted</code></p>
</li>
<li><p>更新阶段：<code>onBeforeUpdate</code>、<code>onUpdated</code></p>
</li>
<li><p>卸载阶段：<code>onBeforeUnmount</code>、<code>onUnmounted</code></p>
</li>
</ul>
<p>常用的钩子：<code>onMounted</code>(挂载完毕)、<code>onUpdated</code>(更新完毕)、<code>onBeforeUnmount</code>(卸载之前)</p>
<p>示例代码：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h2</span>&gt;</span>当前求和为：&#123;&#123; sum &#125;&#125;<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;changeSum&quot;</span>&gt;</span>点我sum+1<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- vue3写法 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">setup</span> <span class="attr">lang</span>=<span class="string">&quot;ts&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">import</span> &#123;</span></span><br><span class="line"><span class="language-javascript">    ref,</span></span><br><span class="line"><span class="language-javascript">    onBeforeMount,</span></span><br><span class="line"><span class="language-javascript">    onMounted,</span></span><br><span class="line"><span class="language-javascript">    onBeforeUpdate,</span></span><br><span class="line"><span class="language-javascript">    onUpdated,</span></span><br><span class="line"><span class="language-javascript">    onBeforeUnmount,</span></span><br><span class="line"><span class="language-javascript">    onUnmounted</span></span><br><span class="line"><span class="language-javascript">&#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// 数据</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">let</span> sum = <span class="title function_">ref</span>(<span class="number">0</span>)</span></span><br><span class="line"><span class="language-javascript"><span class="comment">// 方法</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">function</span> <span class="title function_">changeSum</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    sum.<span class="property">value</span> += <span class="number">1</span></span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;setup&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript"><span class="comment">// 生命周期钩子</span></span></span><br><span class="line"><span class="language-javascript"><span class="title function_">onBeforeMount</span>(<span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;挂载之前&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript">&#125;)</span></span><br><span class="line"><span class="language-javascript"><span class="title function_">onMounted</span>(<span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;挂载完毕&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript">&#125;)</span></span><br><span class="line"><span class="language-javascript"><span class="title function_">onBeforeUpdate</span>(<span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;更新之前&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript">&#125;)</span></span><br><span class="line"><span class="language-javascript"><span class="title function_">onUpdated</span>(<span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;更新完毕&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript">&#125;)</span></span><br><span class="line"><span class="language-javascript"><span class="title function_">onBeforeUnmount</span>(<span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;卸载之前&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript">&#125;)</span></span><br><span class="line"><span class="language-javascript"><span class="title function_">onUnmounted</span>(<span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;卸载完毕&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript">&#125;)</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="5-14-自定义hook"><a href="#5-14-自定义hook" class="headerlink" title="5.14 自定义hook"></a>5.14 自定义hook</h2><p>什么是 <code>hook</code> ？—— 本质是一个函数，把<code>setup</code>函数中使用的 <code>Composition API</code> 进行了封装，类似于 <code>vue2.x</code> 中的 <code>mixin</code>。</p>
<p>自定义 <code>hook</code> 的优势：复用代码, 让 <code>setup</code> 中的逻辑更清楚易懂。</p>
<p>PS：自定义 <code>hook</code> 的命名一般为 <code>useXXX.ts</code></p>
<blockquote>
<p>示例代码</p>
</blockquote>
<p><code>src</code> 目录下新建 <code>hooks</code> 文件夹，<code>useSum.ts</code>中内容如下：</p>
 <figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; ref, onMounted &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> sum = <span class="title function_">ref</span>(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">increment</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">        sum.<span class="property">value</span> += <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">decrement</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">        sum.<span class="property">value</span> -= <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">onMounted</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="title function_">increment</span>()</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//向外部暴露数据</span></span><br><span class="line">    <span class="keyword">return</span> &#123; sum, increment, decrement &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>useDog.ts</code> 中内容如下：</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; reactive, onMounted &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> axios, &#123; <span class="title class_">AxiosError</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;axios&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> dogList = reactive&lt;<span class="built_in">string</span>[]&gt;([])</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 方法</span></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getDog</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 发请求</span></span><br><span class="line">            <span class="keyword">let</span> &#123; data &#125; = <span class="keyword">await</span> axios.<span class="title function_">get</span>(<span class="string">&#x27;https://dog.ceo/api/breed/pembroke/images/random&#x27;</span>)</span><br><span class="line">            <span class="comment">// 维护数据</span></span><br><span class="line">            dogList.<span class="title function_">push</span>(data.<span class="property">message</span>)</span><br><span class="line">        &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">            <span class="comment">// 处理错误</span></span><br><span class="line">            <span class="keyword">const</span> err = &lt;<span class="title class_">AxiosError</span>&gt;error</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(err.<span class="property">message</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 挂载钩子</span></span><br><span class="line">    <span class="title function_">onMounted</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="title function_">getDog</span>()</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//向外部暴露数据</span></span><br><span class="line">    <span class="keyword">return</span> &#123; dogList, getDog &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>组件中具体使用：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h2</span>&gt;</span>当前求和为：&#123;&#123; sum &#125;&#125;<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;increment&quot;</span>&gt;</span>点我+1<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;decrement&quot;</span>&gt;</span>点我-1<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">hr</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">img</span> <span class="attr">v-for</span>=<span class="string">&quot;(dog, index) in dogList&quot;</span> <span class="attr">:key</span>=<span class="string">&quot;index&quot;</span> <span class="attr">:src</span>=<span class="string">&quot;(dog as string)&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;getDog&quot;</span>&gt;</span>再来一只狗<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">setup</span> <span class="attr">lang</span>=<span class="string">&quot;ts&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// 导入hook</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">import</span> useSum <span class="keyword">from</span> <span class="string">&#x27;@/hooks/useSum&#x27;</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">import</span> useDog <span class="keyword">from</span> <span class="string">&#x27;@/hooks/useDog&#x27;</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">const</span> &#123; sum, increment, decrement &#125; = <span class="title function_">useSum</span>()</span></span><br><span class="line"><span class="language-javascript"><span class="keyword">const</span> &#123; dogList, getDog &#125; = <span class="title function_">useDog</span>()</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="6-路由"><a href="#6-路由" class="headerlink" title="6. 路由"></a>6. 路由</h1><h2 id="6-1-路由介绍"><a href="#6-1-路由介绍" class="headerlink" title="6.1 路由介绍"></a>6.1 路由介绍</h2><p>在Vue.js中，路由（Routing）是构建单页面应用（SPA）的重要组成部分，它允许你根据URL的不同来展示不同的内容或组件，而无需重新加载整个页面。<a href="https://router.vuejs.org/zh/">Vue Router</a> 是Vue.js官方的路由管理器插件，它和Vue.js深度集成，使得构建单页面应用变得简单而直观。</p>
<h2 id="6-2-使用步骤"><a href="#6-2-使用步骤" class="headerlink" title="6.2 使用步骤"></a>6.2 使用步骤</h2><ol>
<li>第一步：安装 <code>vue-route</code></li>
<li>第二步：在 <code>src/router/index.ts</code> 中创建路由器，并导出</li>
<li>第三步：在vue应用实例 <code>main.ts</code> 中使用 <code>vue-router</code></li>
<li>第四步：声明 <code>router-view</code> 标签，展示组件内容</li>
</ol>
<p>示例：</p>
<p>1、安装vue-route</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">npm install vue-router@4</span><br></pre></td></tr></table></figure>

<p>2、在<code>src/router/index.ts</code>中创建路由器，并导出</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 第一步：引入createRouter</span></span><br><span class="line"><span class="keyword">import</span> &#123; createRouter, createWebHistory &#125; <span class="keyword">from</span> <span class="string">&#x27;vue-router&#x27;</span></span><br><span class="line"><span class="comment">// 引入要呈现的组件</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Home</span> <span class="keyword">from</span> <span class="string">&#x27;@/views/Home.vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">News</span> <span class="keyword">from</span> <span class="string">&#x27;@/views/News.vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">About</span> <span class="keyword">from</span> <span class="string">&#x27;@/views/About.vue&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 第二步：创建路由器</span></span><br><span class="line"><span class="keyword">const</span> router = <span class="title function_">createRouter</span>(&#123;</span><br><span class="line">    <span class="attr">history</span>: <span class="title function_">createWebHistory</span>(),    <span class="comment">//路由器的工作模式（后面会介绍）</span></span><br><span class="line">    <span class="attr">routes</span>: [   <span class="comment">//路由规则</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">path</span>: <span class="string">&#x27;/home&#x27;</span>,</span><br><span class="line">            <span class="attr">component</span>: <span class="title class_">Home</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">path</span>: <span class="string">&#x27;/news&#x27;</span>,</span><br><span class="line">            <span class="attr">component</span>: <span class="title class_">News</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">path</span>: <span class="string">&#x27;/about&#x27;</span>,</span><br><span class="line">            <span class="attr">component</span>: <span class="title class_">About</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 第三步：暴露路由器</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> router</span><br></pre></td></tr></table></figure>

<p>3、在vue应用实例 <code>main.ts</code> 中使用 <code>vue-router</code></p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 引入router，默认导入index.ts</span></span><br><span class="line"><span class="keyword">import</span> router <span class="keyword">from</span> <span class="string">&#x27;./router&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用路由器</span></span><br><span class="line">app.<span class="title function_">use</span>(router)</span><br></pre></td></tr></table></figure>

<p>4、声明 <code>router-view</code> 标签，展示组件内容，</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- App.vue组件 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h2</span> <span class="attr">class</span>=<span class="string">&quot;title&quot;</span>&gt;</span>Vue路由测试<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 使用 router-link 组件进行导航 --&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 通过传递 to 来指定链接 --&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- &lt;router-link&gt; 将呈现一个带有正确 href 属性的 &lt;a&gt; 标签 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">router-link</span> <span class="attr">to</span>=<span class="string">&quot;/home&quot;</span>&gt;</span>首页<span class="tag">&lt;/<span class="name">router-link</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">router-link</span> <span class="attr">to</span>=<span class="string">&quot;/news&quot;</span> <span class="attr">class</span>=<span class="string">&quot;active&quot;</span>&gt;</span>新闻<span class="tag">&lt;/<span class="name">router-link</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">router-link</span> <span class="attr">to</span>=<span class="string">&quot;/about&quot;</span>&gt;</span>关于<span class="tag">&lt;/<span class="name">router-link</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 路由出口 --&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 路由匹配到的组件将渲染在这里 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">router-view</span>&gt;</span><span class="tag">&lt;/<span class="name">router-view</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">setup</span> <span class="attr">lang</span>=<span class="string">&quot;ts&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p><strong><code>router-link</code></strong> ：请注意，我们没有使用常规的 <code>a</code> 标签，而是使用一个自定义组件 <code>router-link</code> 来创建链接。这使得 Vue Router 可以在不重新加载页面的情况下更改 URL，处理 URL 的生成以及编码。我们将在后面看到如何从这些功能中获益。</p>
</li>
<li><p><strong><code>router-view</code></strong> ：<code>router-view</code> 将显示与 URL 对应的组件。你可以把它放在任何地方，以适应你的布局。</p>
</li>
</ul>
<p><strong>两个注意点：</strong></p>
<ul>
<li><p>路由组件通常存放在 <code>pages</code> 或 <code>views</code> 文件夹，一般组件通常存放在<code>components</code>文件夹。</p>
</li>
<li><p>通过点击导航，视觉效果上“消失” 了的路由组件，默认是被<strong>卸载</strong>掉的，需要的时候再去<strong>挂载</strong>。</p>
</li>
</ul>
<h2 id="6-3-路由器工作模式"><a href="#6-3-路由器工作模式" class="headerlink" title="6.3 路由器工作模式"></a>6.3 路由器工作模式</h2><h3 id="6-3-1-history模式"><a href="#6-3-1-history模式" class="headerlink" title="6.3.1 history模式"></a>6.3.1 <strong>history模式</strong></h3><p> 优点：<code>URL</code> 更加美观，不带有 <code>#</code>，更接近传统的网站 <code>URL</code>。</p>
<p> 缺点：后期项目上线，需要服务端配合处理路径问题，否则刷新会有<code>404</code>错误。</p>
 <figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> router = <span class="title function_">createRouter</span>(&#123;</span><br><span class="line">	<span class="attr">history</span>:<span class="title function_">createWebHistory</span>(), <span class="comment">//history模式</span></span><br><span class="line">	<span class="comment">/******/</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="6-3-2-hash模式"><a href="#6-3-2-hash模式" class="headerlink" title="6.3.2 hash模式"></a>6.3.2 <strong>hash模式</strong></h3><p> 优点：兼容性更好，因为不需要服务器端处理路径。</p>
<p> 缺点：<code>URL</code> 带有 <code>#</code> 不太美观，且在 <code>SEO</code> 优化方面相对较差。</p>
 <figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> router = <span class="title function_">createRouter</span>(&#123;</span><br><span class="line">	<span class="attr">history</span>:<span class="title function_">createWebHashHistory</span>(), <span class="comment">//hash模式</span></span><br><span class="line">	<span class="comment">/******/</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="6-4-to的两种写法"><a href="#6-4-to的两种写法" class="headerlink" title="6.4 to的两种写法"></a>6.4 to的两种写法</h2><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 第一种：to的字符串写法 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">router-link</span> <span class="attr">to</span>=<span class="string">&quot;/home&quot;</span>&gt;</span>主页<span class="tag">&lt;/<span class="name">router-link</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 第二种：to的对象写法 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">router-link</span> <span class="attr">:to</span>=<span class="string">&quot;&#123;path:&#x27;/home&#x27;&#125;&quot;</span>&gt;</span>Home<span class="tag">&lt;/<span class="name">router-link</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="6-5-命名路由"><a href="#6-5-命名路由" class="headerlink" title="6.5 命名路由"></a>6.5 命名路由</h2><p>作用：可以简化路由跳转及传参。（后面会讲）</p>
<p>给路由规则命名：</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="attr">routes</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&#x27;zhuye&#x27;</span>,</span><br><span class="line">        <span class="attr">path</span>: <span class="string">&#x27;/home&#x27;</span>,</span><br><span class="line">        <span class="attr">component</span>: <span class="title class_">Home</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&#x27;xinwen&#x27;</span>,</span><br><span class="line">        <span class="attr">path</span>: <span class="string">&#x27;/news&#x27;</span>,</span><br><span class="line">        <span class="attr">component</span>: <span class="title class_">News</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&#x27;guanyu&#x27;</span>,</span><br><span class="line">        <span class="attr">path</span>: <span class="string">&#x27;/about&#x27;</span>,</span><br><span class="line">        <span class="attr">component</span>: <span class="title class_">About</span></span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>跳转路由：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--简化前：需要写完整的路径（to的字符串写法） --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">router-link</span> <span class="attr">to</span>=<span class="string">&quot;/news/detail&quot;</span>&gt;</span>跳转<span class="tag">&lt;/<span class="name">router-link</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--简化后：直接通过名字跳转（to的对象写法配合name属性） --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">router-link</span> <span class="attr">:to</span>=<span class="string">&quot;&#123;name:&#x27;guanyu&#x27;&#125;&quot;</span>&gt;</span>跳转<span class="tag">&lt;/<span class="name">router-link</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="6-6-嵌套路由"><a href="#6-6-嵌套路由" class="headerlink" title="6.6 嵌套路由"></a>6.6 嵌套路由</h2><blockquote>
<p>示例</p>
</blockquote>
<p>1、编写 <code>News</code> 的子路由：<code>Detail.vue</code></p>
<p>2、配置路由规则，使用 <code>children</code> 配置项：</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 第一步：引入createRouter</span></span><br><span class="line"><span class="keyword">import</span> &#123; createRouter, createWebHistory &#125; <span class="keyword">from</span> <span class="string">&#x27;vue-router&#x27;</span></span><br><span class="line"><span class="comment">// 引入要呈现的组件</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Home</span> <span class="keyword">from</span> <span class="string">&#x27;@/views/Home.vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">News</span> <span class="keyword">from</span> <span class="string">&#x27;@/views/News.vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">About</span> <span class="keyword">from</span> <span class="string">&#x27;@/views/About.vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Detail</span> <span class="keyword">from</span> <span class="string">&#x27;@/views/Detail.vue&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 第二步：创建路由器</span></span><br><span class="line"><span class="keyword">const</span> router = <span class="title function_">createRouter</span>(&#123;</span><br><span class="line">    <span class="attr">history</span>: <span class="title function_">createWebHistory</span>(),    <span class="comment">//路由器的工作模式</span></span><br><span class="line">    <span class="attr">routes</span>: [   <span class="comment">//路由规则</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">path</span>: <span class="string">&#x27;/home&#x27;</span>,</span><br><span class="line">            <span class="attr">component</span>: <span class="title class_">Home</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">path</span>: <span class="string">&#x27;/news&#x27;</span>,</span><br><span class="line">            <span class="attr">component</span>: <span class="title class_">News</span>,</span><br><span class="line">            <span class="attr">children</span>: [&#123;</span><br><span class="line">                <span class="attr">path</span>: <span class="string">&#x27;detail&#x27;</span>,   <span class="comment">//子路由前面不用写 &quot;/&quot;</span></span><br><span class="line">                <span class="attr">component</span>: <span class="title class_">Detail</span></span><br><span class="line">            &#125;]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">path</span>: <span class="string">&#x27;/about&#x27;</span>,</span><br><span class="line">            <span class="attr">component</span>: <span class="title class_">About</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 第三步：暴露路由器</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> router</span><br></pre></td></tr></table></figure>

<p>3、跳转路由（记得要加完整路径）：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">router-link</span> <span class="attr">to</span>=<span class="string">&quot;/news/detail&quot;</span>&gt;</span>xxxx<span class="tag">&lt;/<span class="name">router-link</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 或 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">router-link</span> <span class="attr">:to</span>=<span class="string">&quot;&#123;path:&#x27;/news/detail&#x27;&#125;&quot;</span>&gt;</span>xxxx<span class="tag">&lt;/<span class="name">router-link</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>4、去 <code>News</code> 组件中预留一个 <code>&lt;router-view&gt;</code></p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;news&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">li</span> <span class="attr">v-for</span>=<span class="string">&quot;news in newsList&quot;</span> <span class="attr">:key</span>=<span class="string">&quot;news.id&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">router-link</span> <span class="attr">to</span>=<span class="string">&quot;/news/detail&quot;</span>&gt;</span>&#123;&#123; news.title &#125;&#125;<span class="tag">&lt;/<span class="name">router-link</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;news-content&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">router-view</span>&gt;</span><span class="tag">&lt;/<span class="name">router-view</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="6-7-路由传参"><a href="#6-7-路由传参" class="headerlink" title="6.7 路由传参"></a>6.7 路由传参</h2><h3 id="6-7-1-query参数"><a href="#6-7-1-query参数" class="headerlink" title="6.7.1 query参数"></a>6.7.1 query参数</h3><p>1、传递参数</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 跳转并携带query参数（to的字符串写法） --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">router-link</span> <span class="attr">:to</span>=<span class="string">&quot;`/news/detail?id=$&#123;news.id&#125;&amp;title=$&#123;news.title&#125;&amp;content=$&#123;news.content&#125;`&quot;</span>&gt;</span></span><br><span class="line">  &#123;&#123; news.title &#125;&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">router-link</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 跳转并携带query参数（to的对象写法） --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">router-link</span> <span class="attr">:to</span>=<span class="string">&quot;&#123;</span></span></span><br><span class="line"><span class="string"><span class="tag">  //name:&#x27;detail&#x27;, //用name也可以跳转</span></span></span><br><span class="line"><span class="string"><span class="tag">  path: &#x27;/news/detail&#x27;,</span></span></span><br><span class="line"><span class="string"><span class="tag">  query: &#123;</span></span></span><br><span class="line"><span class="string"><span class="tag">    id: news.id,</span></span></span><br><span class="line"><span class="string"><span class="tag">    title: news.title,</span></span></span><br><span class="line"><span class="string"><span class="tag">    content: news.content</span></span></span><br><span class="line"><span class="string"><span class="tag">  &#125;</span></span></span><br><span class="line"><span class="string"><span class="tag">&#125;&quot;</span>&gt;</span></span><br><span class="line">  &#123;&#123; news.title &#125;&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">router-link</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>2、接收参数：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;useRoute&#125; <span class="keyword">from</span> <span class="string">&#x27;vue-router&#x27;</span></span><br><span class="line"><span class="keyword">const</span> route = <span class="title function_">useRoute</span>()</span><br><span class="line"><span class="comment">// 打印query参数</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(route.<span class="property">query</span>)</span><br></pre></td></tr></table></figure>


<h3 id="6-7-2-params参数"><a href="#6-7-2-params参数" class="headerlink" title="6.7.2 params参数"></a>6.7.2 params参数</h3><p>1、传递参数（<font color="red"><strong>需要占位</strong></font>）</p>
<p>index.ts：</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> router = <span class="title function_">createRouter</span>(&#123;</span><br><span class="line">    <span class="attr">history</span>: <span class="title function_">createWebHistory</span>(),</span><br><span class="line">    <span class="attr">routes</span>: [   <span class="comment">//路由规则</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">path</span>: <span class="string">&#x27;/home&#x27;</span>,</span><br><span class="line">            <span class="attr">component</span>: <span class="title class_">Home</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">path</span>: <span class="string">&#x27;/news&#x27;</span>,</span><br><span class="line">            <span class="attr">component</span>: <span class="title class_">News</span>,</span><br><span class="line">            <span class="attr">children</span>: [&#123;</span><br><span class="line">                <span class="attr">name</span>:<span class="string">&#x27;detail&#x27;</span>, <span class="comment">//用 name 跳转</span></span><br><span class="line">                <span class="attr">path</span>: <span class="string">&#x27;detail/:id/:title/:content&#x27;</span>,</span><br><span class="line">                <span class="attr">component</span>: <span class="title class_">Detail</span></span><br><span class="line">            &#125;]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">path</span>: <span class="string">&#x27;/about&#x27;</span>,</span><br><span class="line">            <span class="attr">component</span>: <span class="title class_">About</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>News.vue：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 跳转并携带params参数（to的字符串写法） --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">RouterLink</span> <span class="attr">:to</span>=<span class="string">&quot;`/news/detail/$&#123;news.id&#125;/$&#123;news.title&#125;/$&#123;news.content&#125;`&quot;</span>&gt;</span></span><br><span class="line">  &#123;&#123; news.title &#125;&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">RouterLink</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 跳转并携带params参数（to的对象写法） --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">router-link</span> <span class="attr">:to</span>=<span class="string">&quot;&#123;</span></span></span><br><span class="line"><span class="string"><span class="tag">  name: &#x27;detail&#x27;, //用name跳转</span></span></span><br><span class="line"><span class="string"><span class="tag">  params: &#123;</span></span></span><br><span class="line"><span class="string"><span class="tag">    id: news.id,</span></span></span><br><span class="line"><span class="string"><span class="tag">    title: news.title,</span></span></span><br><span class="line"><span class="string"><span class="tag">    content: news.content</span></span></span><br><span class="line"><span class="string"><span class="tag">  &#125;</span></span></span><br><span class="line"><span class="string"><span class="tag">&#125;&quot;</span>&gt;</span></span><br><span class="line">  &#123;&#123; news.title &#125;&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">router-link</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>2、接收参数：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;useRoute&#125; <span class="keyword">from</span> <span class="string">&#x27;vue-router&#x27;</span></span><br><span class="line"><span class="keyword">const</span> route = <span class="title function_">useRoute</span>()</span><br><span class="line"><span class="comment">// 打印params参数</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(route.<span class="property">params</span>)</span><br></pre></td></tr></table></figure>

<p><font color="red"><strong>注意：</strong></font></p>
<ul>
<li>传递 <code>params</code> 参数时，若使用 <code>to</code> 的对象写法，<strong>必须</strong>使用 <code>name</code> 配置项，不能用 <code>path</code>。</li>
<li>传递 <code>params</code> 参数时，需要提前在规则中占位。</li>
</ul>
<h2 id="6-8-路由的props配置"><a href="#6-8-路由的props配置" class="headerlink" title="6.8 路由的props配置"></a>6.8 路由的props配置</h2><p>作用：让路由组件更方便的收到参数（可以将路由参数作为 <code>props</code> 传给组件）</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;detail&#x27;</span>,</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;detail/:id/:title/:content&#x27;</span>,</span><br><span class="line">    <span class="attr">component</span>: <span class="title class_">Detail</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// props的对象写法，作用：把对象中的每一组key-value作为props传给Detail组件</span></span><br><span class="line">    <span class="comment">// props:&#123;a:1,b:2,c:3&#125;, </span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// props的布尔值写法，作用：把收到了每一组params参数，作为props传给Detail组件</span></span><br><span class="line">    <span class="comment">// props:true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// props的函数写法，作用：把返回的对象中每一组key-value作为props传给Detail组件</span></span><br><span class="line">    <span class="title function_">props</span>(<span class="params">route</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> route.<span class="property">query</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用 <code>路由的 props 配置</code>，这样接收参数：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">setup</span> <span class="attr">lang</span>=<span class="string">&quot;ts&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="title function_">defineProps</span>([<span class="string">&#x27;id&#x27;</span>, <span class="string">&#x27;title&#x27;</span>, <span class="string">&#x27;content&#x27;</span>])</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="6-9-replace属性"><a href="#6-9-replace属性" class="headerlink" title="6.9 replace属性"></a>6.9 replace属性</h2><p>作用：控制路由跳转时操作浏览器历史记录的模式。</p>
<p>浏览器的历史记录有 <code>push</code> 和 <code>replace</code> 两种写入方式：</p>
<ul>
<li><code>push</code> 是追加历史记录（默认值）。</li>
<li><code>replace</code> 是替换当前记录。</li>
</ul>
<p>开启 <code>replace</code> 模式：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">router-link</span> <span class="attr">replace</span>&gt;</span>News<span class="tag">&lt;/<span class="name">router-link</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="6-10-编程式导航"><a href="#6-10-编程式导航" class="headerlink" title="6.10 编程式导航"></a>6.10 编程式导航</h2><p>路由组件的两个重要的属性：<code>$route</code> 和 <code>$router</code> 变成了两个 <code>hooks</code> 。</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; useRoute, useRouter &#125; <span class="keyword">from</span> <span class="string">&#x27;vue-router&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> route = <span class="title function_">useRoute</span>()</span><br><span class="line"><span class="keyword">const</span> router = <span class="title function_">useRouter</span>()</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(route.<span class="property">query</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(route.<span class="property">parmas</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(router.<span class="property">push</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(router.<span class="property">replace</span>)</span><br></pre></td></tr></table></figure>

<p><code>&lt;router-link&gt; </code> 渲染到页面会转换为 <code>&lt;a&gt;</code> 标签，如果只用 <code>&lt;router-link&gt;</code> 去跳转那就意味着所有导航区只能是<code>&lt;a&gt;</code>标签，假如想要实现使用 <code>&lt;button&gt;</code> 标签实现跳转，就要用到 <code>useRouter</code> 实现编程式导航。</p>
<blockquote>
<p>案例：点击按钮也可以查看新闻</p>
</blockquote>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;news&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 导航区 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">li</span> <span class="attr">v-for</span>=<span class="string">&quot;news in newsList&quot;</span> <span class="attr">:key</span>=<span class="string">&quot;news.id&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 新增一个查看新闻按钮 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;showNewsDetail(news)&quot;</span>&gt;</span>查看新闻<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">router-link</span> <span class="attr">:to</span>=<span class="string">&quot;&#123;</span></span></span><br><span class="line"><span class="string"><span class="tag">          name: &#x27;detail&#x27;, //用name跳转</span></span></span><br><span class="line"><span class="string"><span class="tag">          query: &#123;	// query参数</span></span></span><br><span class="line"><span class="string"><span class="tag">            id: news.id,</span></span></span><br><span class="line"><span class="string"><span class="tag">            title: news.title,</span></span></span><br><span class="line"><span class="string"><span class="tag">            content: news.content</span></span></span><br><span class="line"><span class="string"><span class="tag">          &#125;</span></span></span><br><span class="line"><span class="string"><span class="tag">        &#125;&quot;</span>&gt;</span></span><br><span class="line">          &#123;&#123; news.title &#125;&#125;</span><br><span class="line">        <span class="tag">&lt;/<span class="name">router-link</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 展示区 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;news-content&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">router-view</span>&gt;</span><span class="tag">&lt;/<span class="name">router-view</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">setup</span> <span class="attr">lang</span>=<span class="string">&quot;ts&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">import</span> &#123; reactive &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">const</span> newsList = <span class="title function_">reactive</span>([</span></span><br><span class="line"><span class="language-javascript">  &#123; <span class="attr">id</span>: <span class="string">&#x27;asfdtrfay01&#x27;</span>, <span class="attr">title</span>: <span class="string">&#x27;很好的抗癌食物&#x27;</span>, <span class="attr">content</span>: <span class="string">&#x27;西蓝花&#x27;</span> &#125;,</span></span><br><span class="line"><span class="language-javascript">  &#123; <span class="attr">id</span>: <span class="string">&#x27;asfdtrfay02&#x27;</span>, <span class="attr">title</span>: <span class="string">&#x27;如何一夜暴富&#x27;</span>, <span class="attr">content</span>: <span class="string">&#x27;学IT&#x27;</span> &#125;,</span></span><br><span class="line"><span class="language-javascript">  &#123; <span class="attr">id</span>: <span class="string">&#x27;asfdtrfay03&#x27;</span>, <span class="attr">title</span>: <span class="string">&#x27;震惊，万万没想到&#x27;</span>, <span class="attr">content</span>: <span class="string">&#x27;明天是周一&#x27;</span> &#125;,</span></span><br><span class="line"><span class="language-javascript">  &#123; <span class="attr">id</span>: <span class="string">&#x27;asfdtrfay04&#x27;</span>, <span class="attr">title</span>: <span class="string">&#x27;好消息！好消息！&#x27;</span>, <span class="attr">content</span>: <span class="string">&#x27;快过年了&#x27;</span> &#125;</span></span><br><span class="line"><span class="language-javascript">])</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// 引入 useRouter</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">import</span> &#123; useRouter &#125; <span class="keyword">from</span> <span class="string">&#x27;vue-router&#x27;</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">const</span> router = <span class="title function_">useRouter</span>()</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">interface <span class="title class_">NewsInter</span> &#123;</span></span><br><span class="line"><span class="language-javascript">  <span class="attr">id</span>: string,</span></span><br><span class="line"><span class="language-javascript">  <span class="attr">title</span>: string,</span></span><br><span class="line"><span class="language-javascript">  <span class="attr">content</span>: string</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">function</span> <span class="title function_">showNewsDetail</span>(<span class="params">news: NewsInter</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">  router.<span class="title function_">push</span>(&#123;		<span class="comment">// 使用replace属性 router.replace()</span></span></span><br><span class="line"><span class="language-javascript">    <span class="attr">name</span>: <span class="string">&#x27;detail&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">query</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="attr">id</span>: news.<span class="property">id</span>,</span></span><br><span class="line"><span class="language-javascript">      <span class="attr">title</span>: news.<span class="property">title</span>,</span></span><br><span class="line"><span class="language-javascript">      <span class="attr">content</span>: news.<span class="property">content</span></span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">  &#125;)</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="6-11-重定向"><a href="#6-11-重定向" class="headerlink" title="6.11 重定向"></a>6.11 重定向</h2><p>作用：将特定的路径，重新定向到已有路由。</p>
<p>具体编码：</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;/&#x27;</span>,</span><br><span class="line">    <span class="attr">redirect</span>: <span class="string">&#x27;/home&#x27;</span></span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<h1 id="7-pinia"><a href="#7-pinia" class="headerlink" title="7. pinia"></a>7. pinia</h1><p><a href="https://pinia.vuejs.org/zh/">Pinia</a> 是 Vue 的专属状态管理库，它允许你跨组件或页面共享状态。</p>
<h2 id="7-1-准备一个效果"><a href="#7-1-准备一个效果" class="headerlink" title="7.1 准备一个效果"></a>7.1 准备一个效果</h2> <img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/Front-EndIMG/pinia_example.gif" alt="pinia_example" style="zoom:33%;">

<h2 id="7-2-搭建-pinia-环境"><a href="#7-2-搭建-pinia-环境" class="headerlink" title="7.2 搭建 pinia 环境"></a>7.2 搭建 pinia 环境</h2><p>1、安装 <code>pinia</code></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">npm install pinia</span><br></pre></td></tr></table></figure>

<p>2、 在 vue 应用实例 <code>src/main.ts</code> 中使用 <code>pinia</code></p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 引入createPinia，用于创建pinia</span></span><br><span class="line"><span class="keyword">import</span> &#123; createPinia &#125; <span class="keyword">from</span> <span class="string">&#x27;pinia&#x27;</span></span><br><span class="line"><span class="comment">// 创建pinia</span></span><br><span class="line"><span class="keyword">const</span> pinia = <span class="title function_">createPinia</span>()</span><br><span class="line"><span class="comment">// 使用插件</span></span><br><span class="line">app.<span class="title function_">use</span>(pinia)</span><br></pre></td></tr></table></figure>

<p>此时开发者工具中已经有了 <code>pinia</code> 选项：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/Front-EndIMG/%E5%BC%80%E5%8F%91%E8%80%85%E5%B7%A5%E5%85%B7pinia%E9%80%89%E9%A1%B9.png" alt="开发者工具pinia选项"></p>
<h2 id="7-3-存储-读取数据"><a href="#7-3-存储-读取数据" class="headerlink" title="7.3 存储+读取数据"></a>7.3 存储+读取数据</h2><p><code>Store</code> 是一个保存：<strong>状态</strong>、<strong>业务逻辑</strong>的实体，每个组件都可以<strong>读取</strong>、<strong>写入</strong>它。</p>
<p>它有三个概念：<code>state</code>、<code>getter</code>、<code>action</code>，相当于组件中的： <code>data</code>、 <code>computed</code> 和 <code>methods</code>。</p>
<blockquote>
<p>具体编码</p>
</blockquote>
<p>1、<code>src/store/count.ts</code></p>
<p>PS：暴露的store一般命名为：<code>useXxxxxStore</code></p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 引入defineStore用于创建store</span></span><br><span class="line"><span class="keyword">import</span> &#123; defineStore &#125; <span class="keyword">from</span> <span class="string">&#x27;pinia&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义并暴露一个store</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> useCountStore = <span class="title function_">defineStore</span>(<span class="string">&#x27;count&#x27;</span>, &#123;</span><br><span class="line">  <span class="comment">// 动作</span></span><br><span class="line">  <span class="attr">actions</span>: &#123;&#125;,</span><br><span class="line">  <span class="comment">// 状态</span></span><br><span class="line">  <span class="title function_">state</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">sum</span>: <span class="number">6</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// 计算</span></span><br><span class="line">  <span class="attr">getters</span>: &#123;&#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>2、<code>src/store/loveTalk.ts</code></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 引入defineStore用于创建store</span></span><br><span class="line"><span class="keyword">import</span> &#123; defineStore &#125; <span class="keyword">from</span> <span class="string">&#x27;pinia&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义并暴露一个store</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> useTalkStore = <span class="title function_">defineStore</span>(<span class="string">&#x27;talk&#x27;</span>, &#123;</span><br><span class="line">  <span class="comment">// 动作</span></span><br><span class="line">  <span class="attr">actions</span>: &#123;&#125;,</span><br><span class="line">  <span class="comment">// 状态</span></span><br><span class="line">  <span class="title function_">state</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">talkList</span>: [</span><br><span class="line">        &#123; <span class="attr">id</span>: <span class="string">&#x27;yuysada01&#x27;</span>, <span class="attr">content</span>: <span class="string">&#x27;你今天有点怪，哪里怪？怪好看的！&#x27;</span> &#125;,</span><br><span class="line">        &#123; <span class="attr">id</span>: <span class="string">&#x27;yuysada02&#x27;</span>, <span class="attr">content</span>: <span class="string">&#x27;草莓、蓝莓、蔓越莓，你想我了没？&#x27;</span> &#125;,</span><br><span class="line">        &#123; <span class="attr">id</span>: <span class="string">&#x27;yuysada03&#x27;</span>, <span class="attr">content</span>: <span class="string">&#x27;心里给你留了一块地，我的死心塌地&#x27;</span> &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// 计算</span></span><br><span class="line">  <span class="attr">getters</span>: &#123;&#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>3、组件中使用 <code>state</code> 中的数据</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">h2</span>&gt;</span>当前求和为：&#123;&#123; countStore.sum &#125;&#125;<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">setup</span> <span class="attr">lang</span>=<span class="string">&quot;ts&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// 引入对应的useXxxxxStore	</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">import</span> &#123; useCountStore &#125; <span class="keyword">from</span> <span class="string">&#x27;@/store/count&#x27;</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// 调用useXxxxxStore得到对应的store</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">const</span> countStore = <span class="title function_">useCountStore</span>()</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span> <span class="attr">v-for</span>=<span class="string">&quot;talk in talkStore.talkList&quot;</span> <span class="attr">:key</span>=<span class="string">&quot;talk.id&quot;</span>&gt;</span></span><br><span class="line">      &#123;&#123; talk.content &#125;&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">setup</span> <span class="attr">lang</span>=<span class="string">&quot;ts&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">import</span> &#123; useTalkStore &#125; <span class="keyword">from</span> <span class="string">&#x27;@/store/loveTalk&#x27;</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">const</span> talkStore = <span class="title function_">useTalkStore</span>()</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>开发者工具中 <code>pinia</code> 选项里也可以看到对应数据：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/Front-EndIMG/%E5%BC%80%E5%8F%91%E8%80%85%E5%B7%A5%E5%85%B7pinia%E9%87%8C%E7%9A%84%E6%95%B0%E6%8D%AE.png" alt="开发者工具pinia里的数据">

<h2 id="7-4-修改数据-三种方式"><a href="#7-4-修改数据-三种方式" class="headerlink" title="7.4 修改数据(三种方式)"></a>7.4 修改数据(三种方式)</h2><p>第一种方式：直接修改</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line">countStore.<span class="property">sum</span> = <span class="number">666</span></span><br></pre></td></tr></table></figure>

<p>第二种方式：批量修改</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line">countStore.$patch(&#123;</span><br><span class="line">  <span class="attr">sum</span>:<span class="number">999</span>,</span><br><span class="line">  <span class="attr">name</span>:<span class="string">&#x27;muyoukule&#x27;</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>第三种方式：借助 <code>action</code> 修改（<code>action</code>中可以编写一些业务逻辑）</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; defineStore &#125; <span class="keyword">from</span> <span class="string">&#x27;pinia&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> useCountStore = <span class="title function_">defineStore</span>(<span class="string">&#x27;count&#x27;</span>, &#123;</span><br><span class="line">  <span class="attr">actions</span>: &#123;</span><br><span class="line">    <span class="comment">//加</span></span><br><span class="line">    <span class="title function_">increment</span>(<span class="params">value: number</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">sum</span> &lt; <span class="number">10</span>) &#123;</span><br><span class="line">        <span class="comment">//操作countStore中的sum</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">sum</span> += value</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">//减</span></span><br><span class="line">    <span class="title function_">decrement</span>(<span class="params">value: number</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">sum</span> &gt; <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">sum</span> -= value</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//	--skip--</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>组件中调用 <code>action</code> 即可：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 使用countStore</span></span><br><span class="line"><span class="keyword">const</span> countStore = <span class="title function_">useCountStore</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 调用对应action</span></span><br><span class="line">countStore.<span class="title function_">increment</span>(n.<span class="property">value</span>)	<span class="comment">// n代表数据</span></span><br></pre></td></tr></table></figure>


<h2 id="7-5-storeToRefs"><a href="#7-5-storeToRefs" class="headerlink" title="7.5 storeToRefs"></a>7.5 storeToRefs</h2><p>借助 <code>storeToRefs</code> 将 <code>store</code> 中的数据转为 <code>ref</code> 对象，方便在模板中使用。</p>
<p>PS：<code>pinia</code> 提供的 <code>storeToRefs</code> 只会将数据做转换，而 <code>Vue</code> 的 <code>toRefs </code> 会转换 <code>store</code> 中所有数据。</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;count&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h2</span>&gt;</span>当前求和为：&#123;&#123; sum &#125;&#125;<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">setup</span> <span class="attr">lang</span>=<span class="string">&quot;ts&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">import</span> &#123; useCountStore &#125; <span class="keyword">from</span> <span class="string">&#x27;@/store/count&#x27;</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">/* 引入storeToRefs */</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">import</span> &#123; storeToRefs &#125; <span class="keyword">from</span> <span class="string">&#x27;pinia&#x27;</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">/* 得到countStore */</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">const</span> countStore = <span class="title function_">useCountStore</span>()</span></span><br><span class="line"><span class="language-javascript"><span class="comment">/* 使用storeToRefs转换countStore，随后解构 */</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">const</span> &#123; sum &#125; = <span class="title function_">storeToRefs</span>(countStore)</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="7-6-getters"><a href="#7-6-getters" class="headerlink" title="7.6 getters"></a>7.6 getters</h2><p>概念：当 <code>state </code>中的数据，需要经过处理后再使用时，可以使用 <code>getters</code> 配置。</p>
<p>追加 <code>getters</code>配置：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 引入defineStore用于创建store</span></span><br><span class="line"><span class="keyword">import</span> &#123; defineStore &#125; <span class="keyword">from</span> <span class="string">&#x27;pinia&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义并暴露一个store</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> useCountStore = <span class="title function_">defineStore</span>(<span class="string">&#x27;count&#x27;</span>, &#123;</span><br><span class="line">  <span class="comment">// 动作</span></span><br><span class="line">  <span class="attr">actions</span>: &#123;</span><br><span class="line">    <span class="comment">//	--skip--</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// 状态</span></span><br><span class="line">  <span class="title function_">state</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">sum</span>: <span class="number">1</span>,</span><br><span class="line">      <span class="attr">name</span>: <span class="string">&#x27;muyoukule&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// 计算</span></span><br><span class="line">  <span class="attr">getters</span>: &#123;</span><br><span class="line">    <span class="attr">bigSum</span>: (state): <span class="function"><span class="params">number</span> =&gt;</span> state.<span class="property">sum</span> * <span class="number">10</span>,</span><br><span class="line">    <span class="title function_">upperName</span>(): string &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">name</span>.<span class="title function_">toUpperCase</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>组件中读取数据：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; increment, decrement &#125; = countStore</span><br><span class="line"><span class="keyword">let</span> &#123; sum, name, bigSum, upperName &#125; = <span class="title function_">storeToRefs</span>(countStore)</span><br></pre></td></tr></table></figure>

<h2 id="7-7-subscribe"><a href="#7-7-subscribe" class="headerlink" title="7.7 $subscribe"></a>7.7 $subscribe</h2><p>通过 store 的 <code>$subscribe()</code> 方法侦听 <code>state</code> 及其变化。</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line">talkStore.$subscribe(<span class="function">(<span class="params">mutate, state</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;LoveTalk&#x27;</span>, mutate, state)</span><br><span class="line">  <span class="variable language_">localStorage</span>.<span class="title function_">setItem</span>(<span class="string">&#x27;talk&#x27;</span>, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(talkList.<span class="property">value</span>))</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="7-8-store组合式写法"><a href="#7-8-store组合式写法" class="headerlink" title="7.8 store组合式写法"></a>7.8 store组合式写法</h2><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; defineStore &#125; <span class="keyword">from</span> <span class="string">&#x27;pinia&#x27;</span></span><br><span class="line"><span class="keyword">import</span> axios <span class="keyword">from</span> <span class="string">&#x27;axios&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; nanoid &#125; <span class="keyword">from</span> <span class="string">&#x27;nanoid&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; reactive &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> useTalkStore = <span class="title function_">defineStore</span>(<span class="string">&#x27;talk&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// talkList就是state</span></span><br><span class="line">  <span class="keyword">const</span> talkList = <span class="title function_">reactive</span>(</span><br><span class="line">    <span class="title class_">JSON</span>.<span class="title function_">parse</span>(<span class="variable language_">localStorage</span>.<span class="title function_">getItem</span>(<span class="string">&#x27;talkList&#x27;</span>) <span class="keyword">as</span> <span class="built_in">string</span>) || []</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  <span class="comment">// getATalk函数相当于action</span></span><br><span class="line">  <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getATalk</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 发请求，下面这行的写法是：连续解构赋值+重命名</span></span><br><span class="line">    <span class="keyword">let</span> &#123; <span class="attr">data</span>: &#123; <span class="attr">content</span>: title &#125; &#125; = <span class="keyword">await</span> axios.<span class="title function_">get</span>(<span class="string">&#x27;https://api.uomg.com/api/rand.qinghua?format=json&#x27;</span>)</span><br><span class="line">    <span class="comment">// 把请求回来的字符串，包装成一个对象</span></span><br><span class="line">    <span class="keyword">let</span> obj = &#123; <span class="attr">id</span>: <span class="title function_">nanoid</span>(), title &#125;</span><br><span class="line">    <span class="comment">// 放到数组中</span></span><br><span class="line">    talkList.<span class="title function_">unshift</span>(obj)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> &#123; talkList, getATalk &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h1 id="8-组件通信"><a href="#8-组件通信" class="headerlink" title="8. 组件通信"></a>8. 组件通信</h1><p><strong><code>Vue3</code>组件通信和<code>Vue2</code>的区别：</strong></p>
<ul>
<li>移出事件总线，使用<code>mitt</code>代替。</li>
</ul>
<ul>
<li><code>vuex</code>换成了<code>pinia</code>。</li>
<li>把<code>.sync</code>优化到了<code>v-model</code>里面了。</li>
<li>把<code>$listeners</code>所有的东西，合并到<code>$attrs</code>中了。</li>
<li><code>$children</code>被砍掉了。</li>
</ul>
<p><strong>常见搭配形式：</strong></p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/Front-EndIMG/%E7%BB%84%E4%BB%B6%E9%80%9A%E4%BF%A1%E5%B8%B8%E8%A7%81%E6%90%AD%E9%85%8D%E5%BD%A2%E5%BC%8F.png" alt="组件通信常见搭配形式" style="zoom: 67%;">

<h2 id="8-1-props"><a href="#8-1-props" class="headerlink" title="8.1 props"></a>8.1 props</h2><p>概述：<code>props</code> 是使用频率最高的一种通信方式，常用于 ：<strong>父 &lt;&#x3D;&#x3D;&#x3D;&gt; 子</strong>。</p>
<ul>
<li>若 <strong>父传子</strong>：属性值是<strong>非函数</strong>。</li>
<li>若 <strong>子传父</strong>：属性值是<strong>函数</strong>。</li>
</ul>
<p>父组件：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;father&quot;</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">h3</span>&gt;</span>父组件<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">h4</span>&gt;</span>汽车：&#123;&#123; car &#125;&#125;<span class="tag">&lt;/<span class="name">h4</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">h4</span> <span class="attr">v-show</span>=<span class="string">&quot;toy&quot;</span>&gt;</span>子给的玩具：&#123;&#123; toy &#125;&#125;<span class="tag">&lt;/<span class="name">h4</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">Child</span> <span class="attr">:car</span>=<span class="string">&quot;car&quot;</span> <span class="attr">:sendToy</span>=<span class="string">&quot;getToy&quot;</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">setup</span> <span class="attr">lang</span>=<span class="string">&quot;ts&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">import</span> <span class="title class_">Child</span> <span class="keyword">from</span> <span class="string">&#x27;./Child.vue&#x27;</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">import</span> &#123; ref &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// 数据</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">let</span> car = <span class="title function_">ref</span>(<span class="string">&#x27;奔驰&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript"><span class="keyword">let</span> toy = <span class="title function_">ref</span>(<span class="string">&#x27;&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript"><span class="comment">// 方法</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">function</span> <span class="title function_">getToy</span>(<span class="params">value: string</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">	toy.<span class="property">value</span> = value</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>子组件：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;child&quot;</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">h3</span>&gt;</span>子组件<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">h4</span>&gt;</span>玩具：&#123;&#123; toy &#125;&#125;<span class="tag">&lt;/<span class="name">h4</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">h4</span>&gt;</span>父给的车：&#123;&#123; car &#125;&#125;<span class="tag">&lt;/<span class="name">h4</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;sendToy(toy)&quot;</span>&gt;</span>把玩具给父亲<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">setup</span> <span class="attr">lang</span>=<span class="string">&quot;ts&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">import</span> &#123; ref &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// 数据</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">let</span> toy = <span class="title function_">ref</span>(<span class="string">&#x27;奥特曼&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript"><span class="comment">// 声明接收props</span></span></span><br><span class="line"><span class="language-javascript"><span class="title function_">defineProps</span>([<span class="string">&#x27;car&#x27;</span>, <span class="string">&#x27;sendToy&#x27;</span>])</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="8-2-自定义事件"><a href="#8-2-自定义事件" class="headerlink" title="8.2 自定义事件"></a>8.2 自定义事件</h2><p>概述：自定义事件常用于：<strong>子 &#x3D;&#x3D;&#x3D;&gt; 父。</strong></p>
<p>注意区分：原生事件、自定义事件。</p>
<ul>
<li>原生事件：<ul>
<li>事件名是特定的（<code>click</code>、<code>mosueenter</code>等等）	</li>
<li>事件对象<code>$event</code>: 是包含事件相关信息的对象（<code>pageX</code>、<code>pageY</code>、<code>target</code>、<code>keyCode</code>）</li>
</ul>
</li>
<li>自定义事件：<ul>
<li>事件名是任意名称</li>
<li><strong style="color:red">事件对象<code>$event</code>: 是调用<code>emit</code>时所提供的数据，可以是任意类型！！！</strong></li>
</ul>
</li>
</ul>
<p>示例：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--在父组件中，给子组件绑定自定义事件：--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Child</span> @<span class="attr">send-toy</span>=<span class="string">&quot;toy = $event&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--注意区分原生事件与自定义事件中的$event--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;toy = $event&quot;</span>&gt;</span>测试<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">//子组件中，触发事件：</span></span><br><span class="line"><span class="variable language_">this</span>.$emit(<span class="string">&#x27;send-toy&#x27;</span>, 具体数据)</span><br></pre></td></tr></table></figure>

<h2 id="8-3-mitt"><a href="#8-3-mitt" class="headerlink" title="8.3 mitt"></a>8.3 mitt</h2><p>概述：与消息订阅与发布（<code>pubsub</code>）功能类似，可以实现任意组件间通信。</p>
<p>1、安装<code>mitt</code></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">npm i mitt</span><br></pre></td></tr></table></figure>

<p>2、新建文件：<code>src\utils\emitter.ts</code></p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 引入mitt</span></span><br><span class="line"><span class="keyword">import</span> mitt <span class="keyword">from</span> <span class="string">&#x27;mitt&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 调用mitt得到emitter，emitter能：绑定事件、触发事件</span></span><br><span class="line"><span class="keyword">const</span> emitter = <span class="title function_">mitt</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">/* // 绑定事件</span></span><br><span class="line"><span class="comment">emitter.on(&#x27;test1&#x27;,()=&gt;&#123;</span></span><br><span class="line"><span class="comment">  console.log(&#x27;test1被调用了&#x27;)</span></span><br><span class="line"><span class="comment">&#125;)</span></span><br><span class="line"><span class="comment">emitter.on(&#x27;test2&#x27;,()=&gt;&#123;</span></span><br><span class="line"><span class="comment">  console.log(&#x27;test2被调用了&#x27;)</span></span><br><span class="line"><span class="comment">&#125;)</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">// 触发事件</span></span><br><span class="line"><span class="comment">setInterval(() =&gt; &#123;</span></span><br><span class="line"><span class="comment">  emitter.emit(&#x27;test1&#x27;)</span></span><br><span class="line"><span class="comment">  emitter.emit(&#x27;test2&#x27;)</span></span><br><span class="line"><span class="comment">&#125;, 1000);</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">// 解绑事件</span></span><br><span class="line"><span class="comment">setTimeout(() =&gt; &#123;</span></span><br><span class="line"><span class="comment">  // emitter.off(&#x27;test1&#x27;)</span></span><br><span class="line"><span class="comment">  // emitter.off(&#x27;test2&#x27;)</span></span><br><span class="line"><span class="comment">  emitter.all.clear()</span></span><br><span class="line"><span class="comment">&#125;, 3000); */</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 暴露emitter</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> emitter</span><br></pre></td></tr></table></figure>

<p>3、接收数据的组件中：绑定事件、同时在销毁前解绑事件：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> emitter <span class="keyword">from</span> <span class="string">&quot;@/utils/emitter&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; onUnmounted &#125; <span class="keyword">from</span> <span class="string">&quot;vue&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 绑定事件</span></span><br><span class="line">emitter.<span class="title function_">on</span>(<span class="string">&#x27;send-toy&#x27;</span>, <span class="function">(<span class="params">value</span>) =&gt;</span> &#123;</span><br><span class="line">	<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;send-toy事件被触发&#x27;</span>, value)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="title function_">onUnmounted</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">	<span class="comment">// 解绑事件</span></span><br><span class="line">	emitter.<span class="title function_">off</span>(<span class="string">&#x27;send-toy&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>4、提供数据的组件，在合适的时候触发事件：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> emitter <span class="keyword">from</span> <span class="string">&quot;@/utils/emitter&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">sendToy</span>(<span class="params"></span>) &#123;</span><br><span class="line">	<span class="comment">// 触发事件</span></span><br><span class="line">	emitter.<span class="title function_">emit</span>(<span class="string">&#x27;send-toy&#x27;</span>, toy.<span class="property">value</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注意这个重要的内置关系，总线依赖着这个内置关系</strong></p>
<h2 id="8-4-v-model"><a href="#8-4-v-model" class="headerlink" title="8.4 v-model"></a>8.4 v-model</h2><p>概述：实现 <strong>父 &lt;&#x3D;&#x3D;&#x3D;&gt; 子</strong> 之间相互通信。</p>
<p>前序知识 —— <code>v-model</code>的本质：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 使用v-model指令 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">v-model</span>=<span class="string">&quot;userName&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- v-model的本质是下面这行代码 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> </span></span><br><span class="line"><span class="tag">  <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> </span></span><br><span class="line"><span class="tag">  <span class="attr">:value</span>=<span class="string">&quot;userName&quot;</span> </span></span><br><span class="line"><span class="tag">  @<span class="attr">input</span>=<span class="string">&quot;userName =(&lt;HTMLInputElement&gt;$event.target).value&quot;</span></span></span><br><span class="line"><span class="tag">&gt;</span></span><br></pre></td></tr></table></figure>

<p>组件标签上的<code>v-model</code>的本质：<code>:moldeValue</code> ＋ <code>update:modelValue</code>事件。</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 组件标签上使用v-model指令 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">CustomInput</span> <span class="attr">v-model</span>=<span class="string">&quot;userName&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 组件标签上v-model的本质 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">CustomInput</span> <span class="attr">:modelValue</span>=<span class="string">&quot;userName&quot;</span> @<span class="attr">update:model-value</span>=<span class="string">&quot;userName = $event&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>CustomInput</code>组件中：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--将接收的value值赋给input元素的value属性，目的是：为了呈现数据 --&gt;</span></span><br><span class="line">	<span class="comment">&lt;!--给input元素绑定原生input事件，触发input事件时，进而触发update:model-value事件--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> </span></span><br><span class="line"><span class="tag">       <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> </span></span><br><span class="line"><span class="tag">       <span class="attr">:value</span>=<span class="string">&quot;modelValue&quot;</span> </span></span><br><span class="line"><span class="tag">       @<span class="attr">input</span>=<span class="string">&quot;emit(&#x27;update:model-value&#x27;,$event.target.value)&quot;</span></span></span><br><span class="line"><span class="tag">    &gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">setup</span> <span class="attr">lang</span>=<span class="string">&quot;ts&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="comment">// 接收props</span></span></span><br><span class="line"><span class="language-javascript">  <span class="title function_">defineProps</span>([<span class="string">&#x27;modelValue&#x27;</span>])</span></span><br><span class="line"><span class="language-javascript">  <span class="comment">// 声明事件</span></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">const</span> emit = <span class="title function_">defineEmits</span>([<span class="string">&#x27;update:model-value&#x27;</span>])</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>也可以更换<code>value</code>，例如改成<code>abc</code>：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 也可以更换value，例如改成abc--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">CustomInput</span> <span class="attr">v-model:abc</span>=<span class="string">&quot;userName&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 上面代码的本质如下 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">CustomInput</span> <span class="attr">:abc</span>=<span class="string">&quot;userName&quot;</span> @<span class="attr">update:abc</span>=<span class="string">&quot;userName = $event&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>CustomInput</code>组件中：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> </span></span><br><span class="line"><span class="tag">       <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> </span></span><br><span class="line"><span class="tag">       <span class="attr">:value</span>=<span class="string">&quot;abc&quot;</span> </span></span><br><span class="line"><span class="tag">       @<span class="attr">input</span>=<span class="string">&quot;emit(&#x27;update:abc&#x27;,$event.target.value)&quot;</span></span></span><br><span class="line"><span class="tag">    &gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">setup</span> <span class="attr">lang</span>=<span class="string">&quot;ts&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="comment">// 接收props</span></span></span><br><span class="line"><span class="language-javascript">  <span class="title function_">defineProps</span>([<span class="string">&#x27;abc&#x27;</span>])</span></span><br><span class="line"><span class="language-javascript">  <span class="comment">// 声明事件</span></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">const</span> emit = <span class="title function_">defineEmits</span>([<span class="string">&#x27;update:abc&#x27;</span>])</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>如果<code>value</code>可以更换，那么就可以在组件标签上多次使用<code>v-model</code>：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">CustomInput</span> <span class="attr">v-model:abc</span>=<span class="string">&quot;userName&quot;</span> <span class="attr">v-model:xyz</span>=<span class="string">&quot;password&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>


<h2 id="8-5-attrs"><a href="#8-5-attrs" class="headerlink" title="8.5 $attrs"></a>8.5 $attrs</h2><p>概述：<code>$attrs</code>用于实现<strong>当前组件的父组件</strong>，向<strong>当前组件的子组件</strong>通信（<strong>祖 &#x3D;&#x3D;&#x3D;&gt; 孙</strong>）。</p>
<p>具体说明：<code>$attrs</code>是一个对象，包含所有父组件传入的标签属性。</p>
<p>PS：<code>$attrs</code>会自动排除<code>props</code>中声明的属性(可以认为声明过的 <code>props</code> 被子组件自己“消费”了)</p>
<p>父组件：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;father&quot;</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">h3</span>&gt;</span>父组件<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">h4</span>&gt;</span>a：&#123;&#123; a &#125;&#125;<span class="tag">&lt;/<span class="name">h4</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">h4</span>&gt;</span>b：&#123;&#123; b &#125;&#125;<span class="tag">&lt;/<span class="name">h4</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">h4</span>&gt;</span>c：&#123;&#123; c &#125;&#125;<span class="tag">&lt;/<span class="name">h4</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">h4</span>&gt;</span>d：&#123;&#123; d &#125;&#125;<span class="tag">&lt;/<span class="name">h4</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">Child</span> <span class="attr">:a</span>=<span class="string">&quot;a&quot;</span> <span class="attr">:b</span>=<span class="string">&quot;b&quot;</span> <span class="attr">:c</span>=<span class="string">&quot;c&quot;</span> <span class="attr">:d</span>=<span class="string">&quot;d&quot;</span> <span class="attr">v-bind</span>=<span class="string">&quot;&#123; x: 100, y: 200 &#125;&quot;</span> <span class="attr">:updateA</span>=<span class="string">&quot;updateA&quot;</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">setup</span> <span class="attr">lang</span>=<span class="string">&quot;ts&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">import</span> <span class="title class_">Child</span> <span class="keyword">from</span> <span class="string">&#x27;./Child.vue&#x27;</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">import</span> &#123; ref &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">let</span> a = <span class="title function_">ref</span>(<span class="number">1</span>)</span></span><br><span class="line"><span class="language-javascript"><span class="keyword">let</span> b = <span class="title function_">ref</span>(<span class="number">2</span>)</span></span><br><span class="line"><span class="language-javascript"><span class="keyword">let</span> c = <span class="title function_">ref</span>(<span class="number">3</span>)</span></span><br><span class="line"><span class="language-javascript"><span class="keyword">let</span> d = <span class="title function_">ref</span>(<span class="number">4</span>)</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">function</span> <span class="title function_">updateA</span>(<span class="params">value: number</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">	a.<span class="property">value</span> += value</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>子组件：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;child&quot;</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">h3</span>&gt;</span>子组件<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">GrandChild</span> <span class="attr">v-bind</span>=<span class="string">&quot;$attrs&quot;</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">setup</span> <span class="attr">lang</span>=<span class="string">&quot;ts&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">import</span> <span class="title class_">GrandChild</span> <span class="keyword">from</span> <span class="string">&#x27;./GrandChild.vue&#x27;</span></span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>孙组件：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;grand-child&quot;</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">h3</span>&gt;</span>孙组件<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">h4</span>&gt;</span>a：&#123;&#123; a &#125;&#125;<span class="tag">&lt;/<span class="name">h4</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">h4</span>&gt;</span>b：&#123;&#123; b &#125;&#125;<span class="tag">&lt;/<span class="name">h4</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">h4</span>&gt;</span>c：&#123;&#123; c &#125;&#125;<span class="tag">&lt;/<span class="name">h4</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">h4</span>&gt;</span>d：&#123;&#123; d &#125;&#125;<span class="tag">&lt;/<span class="name">h4</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">h4</span>&gt;</span>x：&#123;&#123; x &#125;&#125;<span class="tag">&lt;/<span class="name">h4</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">h4</span>&gt;</span>y：&#123;&#123; y &#125;&#125;<span class="tag">&lt;/<span class="name">h4</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;updateA(6)&quot;</span>&gt;</span>点我将爷爷那的a更新<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">setup</span> <span class="attr">lang</span>=<span class="string">&quot;ts&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="title function_">defineProps</span>([<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;d&#x27;</span>, <span class="string">&#x27;x&#x27;</span>, <span class="string">&#x27;y&#x27;</span>, <span class="string">&#x27;updateA&#x27;</span>])</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="8-6-refs、-parent"><a href="#8-6-refs、-parent" class="headerlink" title="8.6 $refs、$parent"></a>8.6 $refs、$parent</h2><p>概述：</p>
<ul>
<li><code>$refs</code>用于 ：<strong>父 &#x3D;&#x3D;&#x3D;&gt; 子。</strong></li>
<li><code>$parent</code>用于：<strong>子 &#x3D;&#x3D;&#x3D;&gt; 父。</strong></li>
</ul>
<p>原理如下：</p>
<table>
<thead>
<tr>
<th align="center">属性</th>
<th align="center">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><code>$refs</code></td>
<td align="center">值为对象，包含所有被<code>ref</code>属性标识的<code>DOM</code>元素或组件实例。</td>
</tr>
<tr>
<td align="center"><code>$parent</code></td>
<td align="center">值为对象，当前组件的父组件实例对象。</td>
</tr>
</tbody></table>
<h2 id="8-7-provide、inject"><a href="#8-7-provide、inject" class="headerlink" title="8.7 provide、inject"></a>8.7 provide、inject</h2><p>概述：实现<strong>祖孙组件</strong>直接通信。</p>
<p>具体使用：</p>
<ul>
<li>在祖先组件中通过<code>provide</code>配置向后代组件提供数据。</li>
<li>在后代组件中通过<code>inject</code>配置来声明接收数据。</li>
</ul>
<p>具体编码：</p>
<p>1、父组件中，使用<code>provide</code>提供数据</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;father&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h3</span>&gt;</span>父组件<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h4</span>&gt;</span>银子：&#123;&#123; money &#125;&#125;万元<span class="tag">&lt;/<span class="name">h4</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h4</span>&gt;</span>车子：一辆&#123;&#123; car.brand &#125;&#125;车，价值&#123;&#123; car.price &#125;&#125;万元<span class="tag">&lt;/<span class="name">h4</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Child</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">setup</span> <span class="attr">lang</span>=<span class="string">&quot;ts&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">import</span> <span class="title class_">Child</span> <span class="keyword">from</span> <span class="string">&#x27;./Child.vue&#x27;</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">import</span> &#123; ref, reactive, provide &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// 数据</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">let</span> money = <span class="title function_">ref</span>(<span class="number">100</span>)</span></span><br><span class="line"><span class="language-javascript"><span class="keyword">let</span> car = <span class="title function_">reactive</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">  <span class="attr">brand</span>: <span class="string">&#x27;奔驰&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">  <span class="attr">price</span>: <span class="number">100</span></span></span><br><span class="line"><span class="language-javascript">&#125;)</span></span><br><span class="line"><span class="language-javascript"><span class="comment">// 用于更新money的方法</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">function</span> <span class="title function_">updateMoney</span>(<span class="params">value: number</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">  money.<span class="property">value</span> -= value</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"><span class="comment">// 向后代提供数据</span></span></span><br><span class="line"><span class="language-javascript"><span class="title function_">provide</span>(<span class="string">&#x27;moneyContext&#x27;</span>, &#123; money, updateMoney &#125;)</span></span><br><span class="line"><span class="language-javascript"><span class="title function_">provide</span>(<span class="string">&#x27;car&#x27;</span>, car)</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>PS：子组件中不用编写任何东西，是不受到任何打扰的。</strong></p>
<p>2、孙组件中使用<code>inject</code>配置项接受数据</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;grand-child&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h3</span>&gt;</span>我是孙组件<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h4</span>&gt;</span>银子：&#123;&#123; money &#125;&#125;<span class="tag">&lt;/<span class="name">h4</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h4</span>&gt;</span>车子：一辆&#123;&#123; car.brand &#125;&#125;车，价值&#123;&#123; car.price &#125;&#125;万元<span class="tag">&lt;/<span class="name">h4</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;updateMoney(6)&quot;</span>&gt;</span>花爷爷的钱<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">setup</span> <span class="attr">lang</span>=<span class="string">&quot;ts&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">import</span> &#123; inject &#125; <span class="keyword">from</span> <span class="string">&quot;vue&quot;</span>;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">let</span> &#123; money, updateMoney &#125; = <span class="title function_">inject</span>(<span class="string">&#x27;moneyContext&#x27;</span>, &#123; <span class="attr">money</span>: <span class="number">0</span>, <span class="attr">updateMoney</span>: <span class="function">(<span class="params">param: number</span>) =&gt;</span> &#123; &#125; &#125;)</span></span><br><span class="line"><span class="language-javascript"><span class="keyword">let</span> car = <span class="title function_">inject</span>(<span class="string">&#x27;car&#x27;</span>, &#123; <span class="attr">brand</span>: <span class="string">&#x27;未知&#x27;</span>, <span class="attr">price</span>: <span class="number">0</span> &#125;)</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="8-8-pinia"><a href="#8-8-pinia" class="headerlink" title="8.8 pinia"></a>8.8 pinia</h2><p>参考之前<code>pinia</code>部分的讲解。</p>
<h2 id="8-9-slot"><a href="#8-9-slot" class="headerlink" title="8.9 slot"></a>8.9 slot</h2><h3 id="8-9-1-默认插槽"><a href="#8-9-1-默认插槽" class="headerlink" title="8.9.1 默认插槽"></a>8.9.1 默认插槽</h3><p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/Front-EndIMG/default_slot.png" alt="default_slot"></p>
<p>父组件：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Category</span> <span class="attr">title</span>=<span class="string">&quot;热门游戏列表&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span> <span class="attr">v-for</span>=<span class="string">&quot;g in games&quot;</span> <span class="attr">:key</span>=<span class="string">&quot;g.id&quot;</span>&gt;</span>&#123;&#123; g.name &#125;&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Category</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>子组件：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h3</span>&gt;</span>&#123;&#123; title &#125;&#125;<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 默认插槽，里面可以写默认内容 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">slot</span>&gt;</span>默认内容<span class="tag">&lt;/<span class="name">slot</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="8-9-2-具名插槽"><a href="#8-9-2-具名插槽" class="headerlink" title="8.9.2 具名插槽"></a>8.9.2 具名插槽</h3><p><strong>PS：插槽有默认名字default（v-slot:default）</strong></p>
<p>父组件：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Category</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">template</span> <span class="attr">v-slot:s2</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">li</span> <span class="attr">v-for</span>=<span class="string">&quot;g in games&quot;</span> <span class="attr">:key</span>=<span class="string">&quot;g.id&quot;</span>&gt;</span>&#123;&#123; g.name &#125;&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- 简写方式 #s1 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">template</span> #<span class="attr">s1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h2</span>&gt;</span>热门游戏列表<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Category</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>子组件：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">slot</span> <span class="attr">name</span>=<span class="string">&quot;s1&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">slot</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">slot</span> <span class="attr">name</span>=<span class="string">&quot;s2&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">slot</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="8-9-3-作用域插槽"><a href="#8-9-3-作用域插槽" class="headerlink" title="8.9.3 作用域插槽"></a>8.9.3 作用域插槽</h3><p>理解：<span style="color:red">数据在组件的自身，但根据数据生成的结构需要组件的使用者来决定。</span>（新闻数据在<code>News</code>组件中，但使用数据所遍历出来的结构由<code>App</code>组件决定），具体编码：</p>
<p>父组件：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Game</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">template</span> <span class="attr">v-slot</span>=<span class="string">&quot;params&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- &lt;template v-slot:default=&quot;params&quot;&gt; --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- &lt;template #default=&quot;params&quot;&gt; --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">li</span> <span class="attr">v-for</span>=<span class="string">&quot;g in params.youxi&quot;</span> <span class="attr">:key</span>=<span class="string">&quot;g.id&quot;</span>&gt;</span>&#123;&#123; g.name &#125;&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Game</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>子组件：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;category&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h2</span>&gt;</span>今日游戏榜单<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">slot</span> <span class="attr">:youxi</span>=<span class="string">&quot;games&quot;</span> <span class="attr">a</span>=<span class="string">&quot;哈哈&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">slot</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">setup</span> <span class="attr">lang</span>=<span class="string">&quot;ts&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">import</span> &#123;reactive&#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">let</span> games = <span class="title function_">reactive</span>([</span></span><br><span class="line"><span class="language-javascript">    &#123;<span class="attr">id</span>:<span class="string">&#x27;asgdytsa01&#x27;</span>,<span class="attr">name</span>:<span class="string">&#x27;英雄联盟&#x27;</span>&#125;,</span></span><br><span class="line"><span class="language-javascript">    &#123;<span class="attr">id</span>:<span class="string">&#x27;asgdytsa02&#x27;</span>,<span class="attr">name</span>:<span class="string">&#x27;王者荣耀&#x27;</span>&#125;,</span></span><br><span class="line"><span class="language-javascript">    &#123;<span class="attr">id</span>:<span class="string">&#x27;asgdytsa03&#x27;</span>,<span class="attr">name</span>:<span class="string">&#x27;红色警戒&#x27;</span>&#125;,</span></span><br><span class="line"><span class="language-javascript">    &#123;<span class="attr">id</span>:<span class="string">&#x27;asgdytsa04&#x27;</span>,<span class="attr">name</span>:<span class="string">&#x27;斗罗大陆&#x27;</span>&#125;</span></span><br><span class="line"><span class="language-javascript">  ])</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>类比：</p>
<ul>
<li>数据在子那边，但数据生成的结构，却由父亲决定。</li>
<li>压岁钱在孩子那里，但根据压岁钱买到东西，却由父亲决定。</li>
</ul>
<h1 id="9-其它-API"><a href="#9-其它-API" class="headerlink" title="9. 其它 API"></a>9. 其它 API</h1><h2 id="9-1-shallowRef-与-shallowReactive"><a href="#9-1-shallowRef-与-shallowReactive" class="headerlink" title="9.1 shallowRef 与 shallowReactive"></a>9.1 shallowRef 与 shallowReactive</h2><blockquote>
<p>shallowRef</p>
</blockquote>
<p>作用：创建一个响应式数据，但只对顶层属性进行响应式处理。</p>
<p>用法：</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> myVar = <span class="title function_">shallowRef</span>(initialValue);</span><br></pre></td></tr></table></figure>

<p>特点：只跟踪引用值的变化，不关心值内部的属性变化。</p>
<blockquote>
<p>shallowReactive</p>
</blockquote>
<p>作用：创建一个浅层响应式对象，只会使对象的最顶层属性变成响应式的，对象内部的嵌套属性则不会变成响应式的。</p>
<p>用法：</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> myObj = <span class="title function_">shallowReactive</span>(&#123; ... &#125;);</span><br></pre></td></tr></table></figure>

<p>特点：对象的顶层属性是响应式的，但嵌套对象的属性不是。</p>
<blockquote>
<p>总结</p>
</blockquote>
<p>通过使用 <a href="https://cn.vuejs.org/api/reactivity-advanced.html#shallowref"><code>shallowRef()</code></a> 和 <a href="https://cn.vuejs.org/api/reactivity-advanced.html#shallowreactive"><code>shallowReactive()</code></a> 来绕开深度响应。浅层式 <code>API</code> 创建的状态只在其顶层是响应式的，对所有深层的对象不会做任何处理，避免了对每一个内部属性做响应式所带来的性能成本，这使得属性的访问变得更快，可提升性能。</p>
<h2 id="9-2-readonly-与-shallowReadonly"><a href="#9-2-readonly-与-shallowReadonly" class="headerlink" title="9.2 readonly 与 shallowReadonly"></a>9.2 readonly 与 shallowReadonly</h2><blockquote>
<p>readonly</p>
</blockquote>
<p>作用：用于创建一个对象的深只读副本。</p>
<p>用法：</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> original = <span class="title function_">reactive</span>(&#123; ... &#125;);</span><br><span class="line"><span class="keyword">const</span> readOnlyCopy = <span class="title function_">readonly</span>(original);</span><br></pre></td></tr></table></figure>

<p>特点：</p>
<ul>
<li>对象的所有嵌套属性都将变为只读。</li>
<li>任何尝试修改这个对象的操作都会被阻止（在开发模式下，还会在控制台中发出警告）。</li>
</ul>
<p>应用场景：</p>
<ul>
<li>创建不可变的状态快照。</li>
<li>保护全局状态或配置不被修改。</li>
</ul>
<p><font color="red"><strong>PS：original 可以修改，由于 readOnlyCopy 是根据 original 生成的，所以 readOnlyCopy 会随着 original 的修改而变化，但是不能直接修改 readOnlyCopy。</strong></font></p>
<blockquote>
<p>shallowReadonly</p>
</blockquote>
<p>作用：与 <code>readonly</code> 类似，但只作用于对象的顶层属性。</p>
<p>用法：</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> original = <span class="title function_">reactive</span>(&#123; ... &#125;);</span><br><span class="line"><span class="keyword">const</span> shallowReadOnlyCopy = <span class="title function_">shallowReadonly</span>(original);</span><br></pre></td></tr></table></figure>

<p>特点：</p>
<ul>
<li><p>只将对象的顶层属性设置为只读，对象内部的嵌套属性仍然是可变的。</p>
</li>
<li><p>适用于只需保护对象顶层属性的场景。</p>
</li>
</ul>
<h2 id="9-3-toRaw-与-markRaw"><a href="#9-3-toRaw-与-markRaw" class="headerlink" title="9.3 toRaw 与 markRaw"></a>9.3 toRaw 与 markRaw</h2><blockquote>
<p>toRaw</p>
</blockquote>
<p>作用：用于获取一个响应式对象的原始对象， <code>toRaw</code> 返回的对象不再是响应式的，不会触发视图更新。</p>
<p>官网描述：这是一个可以用于临时读取而不引起代理访问&#x2F;跟踪开销，或是写入而不触发更改的特殊方法。不建议保存对原始对象的持久引用，请谨慎使用。</p>
<p>何时使用？ —— 在需要将响应式对象传递给非 <code>Vue</code> 的库或外部系统时，使用 <code>toRaw</code> 可以确保它们收到的是普通对象。</p>
<p>具体编码：</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; reactive, toRaw, markRaw, isReactive &#125; <span class="keyword">from</span> <span class="string">&quot;vue&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* toRaw */</span></span><br><span class="line"><span class="comment">// 响应式对象</span></span><br><span class="line"><span class="keyword">let</span> person = <span class="title function_">reactive</span>(&#123; <span class="attr">name</span>: <span class="string">&#x27;tony&#x27;</span>, <span class="attr">age</span>: <span class="number">18</span> &#125;)</span><br><span class="line"><span class="comment">// 原始对象</span></span><br><span class="line"><span class="keyword">let</span> rawPerson = <span class="title function_">toRaw</span>(person)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* markRaw */</span></span><br><span class="line"><span class="keyword">let</span> citys = <span class="title function_">markRaw</span>([</span><br><span class="line">	&#123; <span class="attr">id</span>: <span class="string">&#x27;asdda01&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;北京&#x27;</span> &#125;,</span><br><span class="line">	&#123; <span class="attr">id</span>: <span class="string">&#x27;asdda02&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;上海&#x27;</span> &#125;,</span><br><span class="line">	&#123; <span class="attr">id</span>: <span class="string">&#x27;asdda03&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;天津&#x27;</span> &#125;,</span><br><span class="line">	&#123; <span class="attr">id</span>: <span class="string">&#x27;asdda04&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;重庆&#x27;</span> &#125;</span><br><span class="line">])</span><br><span class="line"><span class="comment">// 根据原始对象citys去创建响应式对象citys2 —— 创建失败，因为citys被markRaw标记了</span></span><br><span class="line"><span class="keyword">let</span> citys2 = <span class="title function_">reactive</span>(citys)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">isReactive</span>(person))	<span class="comment">//true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">isReactive</span>(rawPerson))	<span class="comment">//false</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">isReactive</span>(citys))	<span class="comment">//false</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">isReactive</span>(citys2))	<span class="comment">//false</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>markRaw</p>
</blockquote>
<p>作用：标记一个对象，使其<strong>永远不会</strong>变成响应式的。</p>
<p>例如使用 <code>mockjs</code> 时，为了防止误把 <code>mockjs</code> 变为响应式对象，可以使用 <code>markRaw</code> 去标记 <code>mockjs</code>，编码：</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* markRaw */</span></span><br><span class="line"><span class="keyword">let</span> citys = <span class="title function_">markRaw</span>([</span><br><span class="line">	&#123; <span class="attr">id</span>: <span class="string">&#x27;asdda01&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;北京&#x27;</span> &#125;,</span><br><span class="line">	&#123; <span class="attr">id</span>: <span class="string">&#x27;asdda02&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;上海&#x27;</span> &#125;,</span><br><span class="line">	&#123; <span class="attr">id</span>: <span class="string">&#x27;asdda03&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;天津&#x27;</span> &#125;,</span><br><span class="line">	&#123; <span class="attr">id</span>: <span class="string">&#x27;asdda04&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;重庆&#x27;</span> &#125;</span><br><span class="line">])</span><br><span class="line"><span class="comment">// 根据原始对象citys去创建响应式对象citys2 —— 创建失败，因为citys被markRaw标记了</span></span><br><span class="line"><span class="keyword">let</span> citys2 = <span class="title function_">reactive</span>(citys)</span><br></pre></td></tr></table></figure>

<h2 id="9-4-customRef"><a href="#9-4-customRef" class="headerlink" title="9.4 customRef"></a>9.4 customRef</h2><p>作用：创建一个自定义的<code>ref</code>，并对其依赖项跟踪和更新触发进行逻辑控制。</p>
<p>实现防抖效果（<code>useSumRef.ts</code>）：</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; customRef &#125; <span class="keyword">from</span> <span class="string">&quot;vue&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> (<span class="params">initValue: <span class="built_in">string</span>, delay: <span class="built_in">number</span></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> msg = <span class="title function_">customRef</span>(<span class="function">(<span class="params">track, trigger</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="attr">timer</span>: <span class="built_in">number</span></span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="title function_">get</span>(<span class="params"></span>) &#123;</span><br><span class="line">                <span class="title function_">track</span>() <span class="comment">// 告诉Vue数据msg很重要，要对msg持续关注，一旦变化就更新</span></span><br><span class="line">                <span class="keyword">return</span> initValue</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="title function_">set</span>(<span class="params">value</span>) &#123;</span><br><span class="line">                <span class="built_in">clearTimeout</span>(timer)</span><br><span class="line">                timer = <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                    initValue = value</span><br><span class="line">                    <span class="title function_">trigger</span>() <span class="comment">//通知Vue数据msg变化了</span></span><br><span class="line">                &#125;, delay);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">return</span> &#123; msg &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="10-Vue3新组件"><a href="#10-Vue3新组件" class="headerlink" title="10. Vue3新组件"></a>10. Vue3新组件</h1><h2 id="10-1-Teleport"><a href="#10-1-Teleport" class="headerlink" title="10.1 Teleport"></a>10.1 Teleport</h2><p>什么是Teleport？—— Teleport 是一种能够将我们的<strong>组件html结构</strong>移动到指定位置的技术。</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">teleport</span> <span class="attr">to</span>=<span class="string">&#x27;body&#x27;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;modal&quot;</span> <span class="attr">v-show</span>=<span class="string">&quot;isShow&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h2</span>&gt;</span>我是一个弹窗<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">p</span>&gt;</span>我是弹窗中的一些内容<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;isShow = false&quot;</span>&gt;</span>关闭弹窗<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">teleport</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="10-2-Suspense"><a href="#10-2-Suspense" class="headerlink" title="10.2 Suspense"></a>10.2 Suspense</h2><p>等待异步组件时渲染一些额外内容，让应用有更好的用户体验 </p>
<p>使用步骤： </p>
<ul>
<li>异步引入组件</li>
<li>使用<code>Suspense</code>包裹组件，并配置好<code>default</code> 与 <code>fallback</code></li>
</ul>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; defineAsyncComponent,<span class="title class_">Suspense</span> &#125; <span class="keyword">from</span> <span class="string">&quot;vue&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Child</span> = <span class="title function_">defineAsyncComponent</span>(<span class="function">()=&gt;</span><span class="keyword">import</span>(<span class="string">&#x27;./Child.vue&#x27;</span>))</span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;app&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h3</span>&gt;</span>我是App组件<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Suspense</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">template</span> <span class="attr">v-slot:default</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">Child</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">template</span> <span class="attr">v-slot:fallback</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">h3</span>&gt;</span>加载中.......<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">Suspense</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="10-3-全局API转移到应用对象"><a href="#10-3-全局API转移到应用对象" class="headerlink" title="10.3 全局API转移到应用对象"></a>10.3 全局API转移到应用对象</h2><ul>
<li><code>app.component</code></li>
<li><code>app.config</code></li>
<li><code>app.directive</code></li>
<li><code>app.mount</code></li>
<li><code>app.unmount</code></li>
<li><code>app.use</code></li>
</ul>
<h2 id="10-4-其他"><a href="#10-4-其他" class="headerlink" title="10.4 其他"></a>10.4 其他</h2><ul>
<li><p>过渡类名 <code>v-enter</code> 修改为 <code>v-enter-from</code>、过渡类名 <code>v-leave</code> 修改为 <code>v-leave-from</code>。</p>
</li>
<li><p><code>keyCode</code> 作为 <code>v-on</code> 修饰符的支持。</p>
</li>
<li><p><code>v-model</code> 指令在组件上的使用已经被重新设计，替换掉了 <code>v-bind.sync。</code></p>
</li>
<li><p><code>v-if</code> 和 <code>v-for</code> 在同一个元素身上使用时的优先级发生了变化。</p>
</li>
<li><p>移除了<code>$on</code>、<code>$off</code> 和 <code>$once</code> 实例方法。</p>
</li>
<li><p>移除了过滤器 <code>filter</code>。</p>
</li>
<li><p>移除了<code>$children</code> 实例 <code>propert</code>。</p>
<p>……</p>
</li>
</ul>
<h1 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h1><blockquote>
<p>连续解构赋值 + 重命名</p>
</blockquote>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">setup</span> <span class="attr">lang</span>=<span class="string">&quot;ts&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 发请求，下面这行的写法是：连续解构赋值 + 重命名</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">let</span> &#123;<span class="attr">data</span>:&#123;<span class="attr">content</span>:title&#125;&#125; = <span class="keyword">await</span> axios.<span class="title function_">get</span>(<span class="string">&#x27;https://api.uomg.com/api/rand.qinghua?format=json&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>reactive 定义的响应式对象  在访问其内部属性时，自动解包</p>
</blockquote>
<p>即 <code>reactive</code> 中定义的 <code>ref</code> 在访问其内部属性时不需要 <code>.value</code> 可以访问。例：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">setup</span> <span class="attr">lang</span>=<span class="string">&quot;ts&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">let</span> obj = <span class="title function_">reactive</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">a</span>: <span class="number">1</span>,</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">b</span>: <span class="title function_">ref</span>(<span class="number">2</span>)</span></span><br><span class="line"><span class="language-javascript">    &#125;)</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">let</span> x = <span class="title function_">ref</span>(<span class="number">9</span>)</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">console</span>.<span class="title function_">log</span>(obj.<span class="property">a</span>)</span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">console</span>.<span class="title function_">log</span>(obj.<span class="property">b</span>)	<span class="comment">//直接访问，不需要.value</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">//console.log(x)直接打印 x，打印出来是一个Ref对象</span></span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">console</span>.<span class="title function_">log</span>(x.<span class="property">value</span>)	<span class="comment">//访问其内部属性时需要.value</span></span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>打印：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">9</span><br></pre></td></tr></table></figure>



<hr>
<blockquote>
<p>📢哔哔一下</p>
</blockquote>
<p>以前也马马哈哈的接触过一丢丢Vue，只可惜知识体系过于零碎，对Vue的掌握简直就是依托答辩，甚至有些语法分不清是Vue2还是Vue3😅。通过这次的系统学习，<del>自我感觉</del>自己对Vue也没有那么晕乎乎了，但是这几天不造为🐎脑瓜子有点疼，可能是因为熬夜了吧😫…所以今天就浅浅滴自律一下吧，今天我一定要早睡！！！ —— 2024&#x2F;04&#x2F;28 22:35</p>
]]></content>
      <categories>
        <category>Front-End</category>
        <category>Vue</category>
      </categories>
      <tags>
        <tag>Vue.js</tag>
      </tags>
  </entry>
  <entry>
    <title>Java泛型</title>
    <url>/posts/42613/</url>
    <content><![CDATA[<div class="note blue icon-padding flat"><i class="note-icon fas fa-bullhorn"></i><p>本文大部分内容转载至<a href="https://blog.csdn.net/weixin_45395059/article/details/126006369">Java 中的泛型（两万字超全详解）</a></p>
</div>

<h1 id="1-泛型概述"><a href="#1-泛型概述" class="headerlink" title="1. 泛型概述"></a>1. 泛型概述</h1><h2 id="1-1-初识泛型"><a href="#1-1-初识泛型" class="headerlink" title="1.1 初识泛型"></a>1.1 初识泛型</h2><p>泛型（Generic）：是 Java 5 中引入的一种特性，可以在编译阶段约束操作的数据类型，并进行检查。</p>
<p>泛型的格式：&lt;泛型标识&gt;</p>
<ul>
<li><p>尖括号 &lt;&gt; 中的 泛型标识被称作是<code>类型参数</code>，用于指代任何数据类型。</p>
</li>
<li><p>泛型标识是任意设置的（如果你想可以设置为 Hello都行），Java 常见的泛型标识以及其代表含义如下：</p>
<ul>
<li><p>T ：代表一般的任何类。</p>
</li>
<li><p>E ：代表 Element 元素的意思，或者 Exception 异常的意思。</p>
</li>
<li><p>K ：代表 Key 的意思。</p>
</li>
<li><p>V ：代表 Value 的意思，通常与 K 一起配合使用。</p>
</li>
<li><p>S ：代表 Subtype 的意思，文章后面部分会讲解示意。</p>
</li>
</ul>
</li>
</ul>
<p><font color="red"><strong>PS：泛型只能支持引用数据类型</strong></font></p>
<h3 id="1-1-1-泛型的基本概念"><a href="#1-1-1-泛型的基本概念" class="headerlink" title="1.1.1 泛型的基本概念"></a>1.1.1 泛型的基本概念</h3><p>泛型的主要特点是在定义时不指定具体的类型，而在使用的时候再指定类型的一种特性。这种特性提供了更大的代码复用和类型安全。在Java中，泛型是通过类型参数化来实现的，即通过在定义类、接口和方法时使用 <code>类型参数</code>（如<code>T</code>、<code>E</code>、<code>K</code>、<code>V</code>等），然后在实例化或调用时指定具体的类型。</p>
<h3 id="1-1-2-为什么要使用泛型？"><a href="#1-1-2-为什么要使用泛型？" class="headerlink" title="1.1.2 为什么要使用泛型？"></a>1.1.2 为什么要使用泛型？</h3><ul>
<li><strong>类型安全</strong>：泛型能够在编译时检查类型，从而避免了运行时可能出现的<code>ClassCastException</code>。通过使用泛型，你可以确保集合中只包含特定类型的对象，从而减少了类型转换的需要。</li>
<li><strong>代码重用</strong>：泛型允许你编写更加通用的代码。例如，你可以编写一个能够处理任何类型数据的泛型集合类，而不是针对每种数据类型编写一个专门的集合类。这大大提高了代码的可重用性。</li>
<li><strong>减少代码冗余</strong>：使用泛型可以避免大量的显式类型转换代码。这不仅可以使代码更加简洁，还可以减少出错的可能性。</li>
<li><strong>提高可读性</strong>：泛型的使用可以使代码更加清晰易懂。通过查看泛型类型的声明，你可以更容易地理解代码的预期用途和所处理的数据类型。</li>
<li><strong>性能优化</strong>：在某些情况下，泛型可以通过避免不必要的装箱和拆箱操作来提高性能。这是因为泛型允许在编译时确定具体的类型，从而避免了运行时的类型转换开销。</li>
</ul>
<h2 id="1-2-泛型使用场景"><a href="#1-2-泛型使用场景" class="headerlink" title="1.2 泛型使用场景"></a>1.2 泛型使用场景</h2><blockquote>
<p>没有泛型的时候，集合类型怎么破？</p>
</blockquote>
<p>在 ArrayList 集合中，可以放入所有类型的对象，假设现在有以下一个存储了 String 类型 和 Integer 类型的对象的 ArrayList 集合。</p>
<p>代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestGenerics</span> &#123;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//没有泛型的时候，集合如何存储数据</span></span><br><span class="line">        <span class="type">ArrayList</span> <span class="variable">list</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ArrayList</span>();</span><br><span class="line">        list.add(<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        list.add(<span class="string">&quot;bbb&quot;</span>);</span><br><span class="line">        list.add(<span class="string">&quot;ccc&quot;</span>);</span><br><span class="line">        list.add(<span class="string">&quot;ddd&quot;</span>);</span><br><span class="line">        list.add(<span class="number">111</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="type">Iterator</span> <span class="variable">it</span> <span class="operator">=</span> list.iterator();</span><br><span class="line">        <span class="keyword">while</span> (it.hasNext()) &#123;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">next</span> <span class="operator">=</span> it.next();</span><br><span class="line">            System.out.println(next);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到在没有使用泛型的时候，迭代器也拿到了集合里的每一个对象并成功进行打印：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">aaa</span><br><span class="line">bbb</span><br><span class="line">ccc</span><br><span class="line">ddd</span><br><span class="line">111</span><br></pre></td></tr></table></figure>

<p>有人可以就要问了：这不是没毛病吗？又没报错还成功得到了结果。那为什么还要指定泛型呢？</p>
<p>不知道大家有没有注意到，在没有使用泛型的时候，当要拿到集合里面的每一个元素的时候迭代器默认会给我们返回 <code>Object</code> 对象，而正是这里有一个致命的缺陷 —— 多态的弊端是不能访问子类的特有功能。</p>
<p>例：假如想要得到上面集合里面每个元素的长度（调用 String 特有的 <code>length()</code> 方法）</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestGenerics</span> &#123;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ArrayList</span> <span class="variable">list</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ArrayList</span>();</span><br><span class="line">        list.add(<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        list.add(<span class="string">&quot;bbb&quot;</span>);</span><br><span class="line">        list.add(<span class="string">&quot;ccc&quot;</span>);</span><br><span class="line">        list.add(<span class="string">&quot;ddd&quot;</span>);</span><br><span class="line">        list.add(<span class="number">111</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Iterator</span> <span class="variable">it</span> <span class="operator">=</span> list.iterator();</span><br><span class="line">        <span class="keyword">while</span> (it.hasNext()) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">next</span> <span class="operator">=</span> (String) it.next();</span><br><span class="line">            System.out.println(next.length());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出结果：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/JavaIMG/Integer%E5%AF%B9%E8%B1%A1%E4%B8%8D%E8%83%BD%E5%BC%BA%E8%BD%AC%E4%B8%BAString%E7%B1%BB%E5%9E%8B.png" alt="Integer对象不能强转为String类型"></p>
<p>上述代码在编译时没有报错，但在运行时却抛出了一个 <code>ClassCastException</code> 异常，其原因是 Integer 对象不能强转为 String 类型。</p>
<p><strong>那如何可以避免上述异常的出现？即我们希望当我们向集合中添加了不符合类型要求的对象时，编译器能直接给我们报错，而不是在程序运行后才产生异常。这个时候便可以使用<code>泛型</code>了。</strong></p>
<p>使用泛型代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestGenerics</span> &#123;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line">        ArrayList&lt;String&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        list.add(<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        list.add(<span class="string">&quot;bbb&quot;</span>);</span><br><span class="line">        list.add(<span class="string">&quot;ccc&quot;</span>);</span><br><span class="line">        list.add(<span class="string">&quot;ddd&quot;</span>);</span><br><span class="line">        list.add(<span class="number">111</span>);<span class="comment">// 在编译阶段，编译器会报错</span></span><br><span class="line"></span><br><span class="line">        Iterator&lt;String&gt; it = list.iterator();</span><br><span class="line">        <span class="keyword">while</span> (it.hasNext()) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">next</span> <span class="operator">=</span> it.next();</span><br><span class="line">            System.out.println(next.length());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>&lt;String&gt;</code> 是一个泛型，其限制了 ArrayList 集合中存放对象的数据类型只能是 String，当添加一个非 String 对象时，编译器会直接报错。这样，我们便解决了上面产生的 <code>ClassCastException</code> 异常的问题（这样体现了泛型的类型安全检测机制）。</p>
<h2 id="1-3-泛型的实际应用"><a href="#1-3-泛型的实际应用" class="headerlink" title="1.3 泛型的实际应用"></a>1.3 泛型的实际应用</h2><p>泛型在Java编程中得到了广泛的应用，特别是在集合框架中。例如，<code>ArrayList&lt;T&gt;</code>、<code>HashSet&lt;T&gt;</code> 等集合类都是泛型类，它们可以接受任何类型的对象作为元素，同时保证了类型安全。此外，泛型还可以用于<strong>自定义泛型类、泛型接口和泛型方法</strong>，以满足特定的编程需求，下面将正式介绍泛型的相关知识。</p>
<h1 id="2-泛型类"><a href="#2-泛型类" class="headerlink" title="2. 泛型类"></a>2. 泛型类</h1><h2 id="2-1-泛型类的定义"><a href="#2-1-泛型类的定义" class="headerlink" title="2.1 泛型类的定义"></a>2.1 泛型类的定义</h2><blockquote>
<p>（1）类型参数用于类的定义中，则该类被称为泛型类。通过泛型可以完成对一组类的操作对外开放相同的接口。最典型的就是各种容器类，如：List、Set、Map等。</p>
</blockquote>
<p>泛型类的基本语法如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">class 类名称 &lt;泛型标识&gt; &#123;</span><br><span class="line">  <span class="keyword">private</span> 泛型标识 <span class="comment">/*（成员变量类型）*/</span> 变量名; </span><br><span class="line">  .....</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>举例：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Generic</span>&lt;T&gt; &#123; </span><br><span class="line">    <span class="comment">// key 这个成员变量的数据类型为 T, T 的类型由外部传入  </span></span><br><span class="line">    <span class="keyword">private</span> T key;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 泛型构造方法形参 key 的类型也为 T，T 的类型由外部传入</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Generic</span><span class="params">(T key)</span> &#123; </span><br><span class="line">        <span class="built_in">this</span>.key = key;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">	<span class="comment">// 泛型方法 getKey 的返回值类型为 T，T 的类型由外部指定</span></span><br><span class="line">    <span class="keyword">public</span> T <span class="title function_">getKey</span><span class="params">()</span>&#123; </span><br><span class="line">        <span class="keyword">return</span> key;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在泛型类中，类型参数定义的位置有三处，分别为：</p>
<ul>
<li>非静态的成员属性类型</li>
<li>非静态方法的形参类型（包括非静态成员方法和构造器）</li>
<li>非静态的成员方法的返回值类型</li>
</ul>
<blockquote>
<p>（2）泛型类中的静态方法和静态变量<strong>不可以</strong>使用泛型类所声明的类型参数</p>
</blockquote>
<p>代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestGenericsDemo</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> T t;   <span class="comment">// 编译错误</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> T <span class="title function_">show</span><span class="params">(T t)</span> &#123; <span class="comment">// 编译错误</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>泛型类中的类型参数的确定是在创建泛型类对象的时候（例如 <code>ArrayList&lt;Integer&gt;</code>）。</li>
<li>而静态变量和静态方法在类加载时已经初始化，直接使用类名调用；在泛型类的类型参数未确定时，静态成员有可能被调用，因此泛型类的类型参数是不能在静态成员中使用的。</li>
</ul>
<blockquote>
<p>（3）静态泛型方法中可以使用自身的方法签名中新定义的类型参数（即泛型方法，后面会说到），而不能使用泛型类中定义的类型参数。</p>
</blockquote>
<p>代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestGenericsDemo</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="comment">// 泛型类定义的类型参数 T 不能在静态方法中使用  </span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;E&gt; E <span class="title function_">show</span><span class="params">(E e)</span> &#123; <span class="comment">// 这是正确的，因为 E 是在静态方法签名中新定义的类型参数    </span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>（4）泛型类不只接受一个类型参数，它还可以接受多个类型参数。</p>
</blockquote>
<p>代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MultiType</span>&lt;E, T&gt; &#123;</span><br><span class="line">    E value1;</span><br><span class="line">    T value2;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> E <span class="title function_">getValue1</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> value1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> T <span class="title function_">getValue2</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> value2;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-2-泛型类的使用"><a href="#2-2-泛型类的使用" class="headerlink" title="2.2 泛型类的使用"></a>2.2 泛型类的使用</h2><p><strong>在创建泛型类的对象时，必须指定类型参数 T 的具体数据类型，即尖括号 &lt;&gt; 中传入的什么数据类型，T 便会被替换成对应的类型。如果 &lt;&gt; 中什么都不传入，则默认是 <code>&lt;Object&gt;</code>。</strong></p>
<p>假设有个泛型类如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Generic</span>&lt;T&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> T key;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Generic</span><span class="params">(T key)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.key = key;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> T <span class="title function_">getKey</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> key;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>当创建一个 Generic&lt;T&gt; 类对象时，会向尖括号 &lt;&gt; 中传入具体的数据类型。</p>
</blockquote>
<p>代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line">    Generic&lt;String&gt; generic1 = <span class="keyword">new</span> <span class="title class_">Generic</span>&lt;&gt;();<span class="comment">// 传入 String 类型</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// &lt;&gt; 中什么都不传入，等价于 Generic&lt;Object&gt; generic = new Generic&lt;&gt;();</span></span><br><span class="line">    <span class="type">Generic</span> <span class="variable">generic2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Generic</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>传入 String 类型时，原泛型类可以想象它会自动扩展，其类型参数会被替换。</p>
</blockquote>
<p>自动扩展如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Generic</span> &#123; </span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> String key;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Generic</span><span class="params">(String key)</span> &#123; </span><br><span class="line">        <span class="built_in">this</span>.key = key;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getKey</span><span class="params">()</span> &#123; </span><br><span class="line">        <span class="keyword">return</span> key;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>可以发现，泛型类中的 <code>类型参数 T</code> 被 &lt;&gt; 中的 String 类型全部替换了。</li>
<li>使用泛型的上述特性便可以在集合中限制添加对象的数据类型，若集合中添加的对象与指定的泛型数据类型不一致，则编译器会直接报错，这也是泛型的类型安全检测机制的实现原理。</li>
</ul>
<h1 id="3-泛型接口"><a href="#3-泛型接口" class="headerlink" title="3. 泛型接口"></a>3. 泛型接口</h1><p><strong>泛型接口和泛型类的定义差不多，基本语法如下：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> interface 接口名&lt;类型参数&gt; &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>举例如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Inter</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">show</span><span class="params">(T t)</span> ;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><font color="red"><strong>泛型接口中的类型参数，在该接口被继承或者被实现时确定。</strong></font><strong>解释如下：</strong></p>
<blockquote>
<p>（1）定义一个泛型接口如下：</p>
</blockquote>
<p><strong>PS：在泛型接口中，静态成员也不能使用泛型接口定义的类型参数。</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">IUsb</span>&lt;U, R&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line">    U name;<span class="comment">// 报错！ 接口中的属性默认是静态的，因此不能使用类型参数声明</span></span><br><span class="line"></span><br><span class="line">    R <span class="title function_">get</span><span class="params">(U u)</span>;<span class="comment">// 普通方法中，可以使用类型参数</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">hi</span><span class="params">(R r)</span>;<span class="comment">// 抽象方法中，可以使用类型参数</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在 jdk8 中，可以在接口中使用默认方法, 默认方法可以使用泛型接口的类型参数</span></span><br><span class="line">    <span class="keyword">default</span> R <span class="title function_">method</span><span class="params">(U u)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>（2）定义一个接口 IA 继承了泛型接口 IUsb，在接口 IA 定义时必须确定泛型接口 IUsb 中的类型参数。</p>
</blockquote>
<p>代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 在继承泛型接口时，必须确定泛型接口的类型参数</span></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">IA</span> <span class="keyword">extends</span> <span class="title class_">IUsb</span>&lt;String, Double&gt; &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 当去实现 IA 接口时，因为 IA 在继承 IUsu 接口时，指定了类型参数 U 为 String，R 为 Double</span></span><br><span class="line"><span class="comment">// 所以在实现 IUsb 接口的方法时，使用 String 替换 U,用 Double 替换 R</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AA</span> <span class="keyword">implements</span> <span class="title class_">IA</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Double <span class="title function_">get</span><span class="params">(String s)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">hi</span><span class="params">(Double d)</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>（3）定义一个类 BB 实现了泛型接口 IUsb，在类 BB 定义时需要确定泛型接口 IUsb 中的类型参数。</p>
</blockquote>
<p>代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 实现接口时，需要指定泛型接口的类型参数</span></span><br><span class="line"><span class="comment">// 给 U 指定 Integer， 给 R 指定了 Float</span></span><br><span class="line"><span class="comment">// 所以，当我们实现 IUsb 方法时，会使用 Integer 替换 U, 使用 Float 替换 R</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BB</span> <span class="keyword">implements</span> <span class="title class_">IUsb</span>&lt;Integer, Float&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Float <span class="title function_">get</span><span class="params">(Integer integer)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">hi</span><span class="params">(Float afloat)</span> &#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>（4）定义一个类 CC 实现了泛型接口 IUsb 时，若是没有确定泛型接口 IUsb 中的类型参数，则默认为 Object。</p>
</blockquote>
<p>代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 实现泛型接口时没有确定类型参数，则默认为 Object</span></span><br><span class="line"><span class="comment">// 建议直接写成 IUsb&lt;Object, Object&gt;</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CC</span> <span class="keyword">implements</span> <span class="title class_">IUsb</span> &#123;<span class="comment">//等价 class CC implements IUsb&lt;Object, Object&gt;</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">get</span><span class="params">(Object o)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">hi</span><span class="params">(Object o)</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>（5）定义一个类 DD 实现了泛型接口 IUsb 时，若是没有确定泛型接口 IUsb 中的类型参数，也可以将 DD 类也定义为泛型类，其声明的类型参数必须要和接口 IUsb 中的类型参数相同。</p>
</blockquote>
<p>代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// DD 类定义为泛型类，则不需要确定接口的类型参数</span></span><br><span class="line"><span class="comment">// 但 DD 类定义的类型参数要和接口中类型参数的一致</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DD</span>&lt;U, R&gt; <span class="keyword">implements</span> <span class="title class_">IUsb</span>&lt;U, R&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> R <span class="title function_">get</span><span class="params">(U u)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">hi</span><span class="params">(R r)</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>补充上面（2）</p>
</blockquote>
<p>上面（2）提到定义一个接口继承了泛型接口 IUsb，在接口定义时<strong>必须</strong>确定泛型接口 IUsb 中的类型参数。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 在继承泛型接口时，必须确定泛型接口的类型参数</span></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">IA</span> <span class="keyword">extends</span> <span class="title class_">IUsb</span>&lt;String, Double&gt; &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>也可以不确定泛型接口 IUsb 中的类型参数：定义一个接口 IB 实现了泛型接口 IUsb 时，若是没有确定泛型接口 IUsb 中的类型参数，也可以将 IB 接口也定义为泛型接口，其声明的类型参数必须包含和接口 IUsb 中的类型参数，并且可以允许 IB 接口继续扩展其他泛型参数</p>
<p>代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 在继承泛型接口时，可以允许接口继续扩展其他泛型参数</span></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">IB</span>&lt;U, R, K, V&gt; <span class="keyword">extends</span> <span class="title class_">IUsb</span>&lt;U, R&gt; &#123;</span><br><span class="line">    K <span class="title function_">hello1</span><span class="params">(V v)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">hello2</span><span class="params">(K k)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="4-泛型方法"><a href="#4-泛型方法" class="headerlink" title="4. 泛型方法"></a>4. 泛型方法</h1><h2 id="4-1-泛型方法的定义"><a href="#4-1-泛型方法的定义" class="headerlink" title="4.1 泛型方法的定义"></a>4.1 泛型方法的定义</h2><p><strong>当在一个方法签名中的返回值前面声明了一个 <code>&lt;T&gt;</code> 时，该方法就被声明为一个泛型方法。<code>&lt;T&gt;</code> 表明该方法声明了一个类型参数 T，并且这个类型参数 T 只能在该方法中使用。当然，泛型方法中也可以使用泛型类中定义的泛型参数。</strong></p>
<p>基本语法如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;类型参数&gt; 返回类型 方法名（类型参数 变量名） &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>（1）只有在方法签名中声明了 <code>&lt;T&gt;</code> 的方法才是泛型方法，仅使用了泛型类定义的类型参数的方法并不是泛型方法。</p>
</blockquote>
<p>举例如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span>&lt;U&gt; &#123;</span><br><span class="line">	<span class="comment">// 该方法只是使用了泛型类定义的类型参数，不是泛型方法</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testMethod</span><span class="params">(U u)</span>&#123;</span><br><span class="line">		System.out.println(u);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// &lt;T&gt; 真正声明了下面的方法是一个泛型方法</span></span><br><span class="line">	<span class="keyword">public</span> &lt;T&gt; T <span class="title function_">testMethod1</span><span class="params">(T t)</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> t;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>（2）泛型方法中可以同时声明多个类型参数<strong>。</strong></p>
</blockquote>
<p>举例如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestMethod</span>&lt;U&gt; &#123;</span><br><span class="line">    <span class="keyword">public</span> &lt;T, S&gt; T <span class="title function_">testMethod</span><span class="params">(T t, S s)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>（3）泛型方法中也可以使用泛型类中定义的泛型参数<strong>。</strong></p>
</blockquote>
<p>举例如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestMethod</span>&lt;U&gt; &#123;</span><br><span class="line">	<span class="keyword">public</span> &lt;T&gt; U <span class="title function_">testMethod</span><span class="params">(T t, U u)</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> u;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>（4）<strong>特别注意的是：</strong>泛型类中定义的类型参数和泛型方法中定义的类型参数是相互独立的，它们一点关系都没有。</p>
</blockquote>
<p>举例如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testMethod</span><span class="params">(T t)</span> &#123;</span><br><span class="line">        System.out.println(t);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; T <span class="title function_">testMethod1</span><span class="params">(T t)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> t;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面代码中，<code>Test&lt;T&gt;</code> 是泛型类，<code>testMethod()</code> 是泛型类中的普通方法，其使用的类型参数是与泛型类中定义的类型参数。</p>
<p>而 <code>testMethod1()</code> 是一个泛型方法，它使用的类型参数是与方法签名中声明的类型参数。</p>
<p>虽然泛型类中定义的类型参数标识和泛型方法中定义的类型参数标识都为 <code>&lt;T&gt;</code>，但它们彼此之间是相互独立的。<strong>也就是说，泛型方法始终以自己声明的类型参数为准。</strong></p>
<p><font color="red"><strong>PS：</strong></font></p>
<ul>
<li><code>&lt;T&gt;</code> 表明该方法声明了一个类型参数 T，并且这个类型参数 T 只能在该方法中使用。</li>
<li>为了避免混淆，如果在一个泛型类中存在泛型方法，那么两者的类型参数最好不要同名。</li>
<li>与泛型类的类型参数定义一样，此处泛型方法中的 T 可以写为<code>任意标识</code>，常见的如 T、E、K、V 等形式的参数常用于表示泛型。</li>
</ul>
<p><strong>补充一点：将静态方法声明为泛型方法</strong></p>
<blockquote>
<p>前面在泛型类的定义中提到，在静态成员中不能使用泛型类定义的类型参数，但我们可以将静态成员方法定义为一个泛型方法。</p>
</blockquote>
<p>代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span>&lt;T&gt; &#123;   </span><br><span class="line">	<span class="comment">// 泛型类定义的类型参数 T 不能在静态方法中使用</span></span><br><span class="line">	<span class="comment">// 但可以将静态方法声明为泛型方法，方法中便可以使用其声明的类型参数了</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;E&gt; E <span class="title function_">show</span><span class="params">(E e)</span> &#123;     </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;    </span><br><span class="line">    &#125;    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-2-泛型方法的使用"><a href="#4-2-泛型方法的使用" class="headerlink" title="4.2 泛型方法的使用"></a>4.2 泛型方法的使用</h2><p>泛型类，在创建类的对象的时候确定类型参数的具体类型；泛型方法，在调用方法的时候再确定类型参数的具体类型。</p>
<p>泛型方法签名中声明的类型参数只能在该方法里使用，而泛型接口、泛型类中声明的类型参数则可以在整个接口、类中使用。</p>
<p>当调用泛型方法时，根据外部传入的实际对象的数据类型，<code>编译器</code> 就可以判断出 <code>类型参数 T</code> 所代表的具体数据类型。</p>
<p>举例如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">GenericMethod</span> <span class="variable">d</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GenericMethod</span>(); <span class="comment">// 创建 GenericMethod 对象</span></span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> d.fun(<span class="string">&quot;汤姆&quot;</span>); <span class="comment">// 给GenericMethod中的泛型方法传递字符串</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> d.fun(<span class="number">30</span>);  <span class="comment">// 给GenericMethod中的泛型方法传递数字，自动装箱</span></span><br><span class="line">        System.out.println(str); <span class="comment">// 输出 汤姆</span></span><br><span class="line">        System.out.println(i);  <span class="comment">// 输出 30</span></span><br><span class="line"></span><br><span class="line">        GenericMethod.show(<span class="number">666</span>);<span class="comment">// 输出: 静态泛型方法 666</span></span><br><span class="line">        GenericMethod.show(<span class="string">&quot;Lin&quot;</span>);<span class="comment">// 输出: 静态泛型方法 Lin</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">GenericMethod</span> &#123;</span><br><span class="line">    <span class="comment">// 普通的泛型方法</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; T <span class="title function_">fun</span><span class="params">(T t)</span> &#123; <span class="comment">// 可以接收任意类型的数据</span></span><br><span class="line">        <span class="keyword">return</span> t;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 静态的泛型方法</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;E&gt; <span class="keyword">void</span> <span class="title function_">show</span><span class="params">(E e)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;静态泛型方法 &quot;</span> + e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<p>不难发现，当调用泛型方法时，根据传入的实际对象，<code>编译器</code> 会判断出类型形参 T 所代表的具体数据类型。</p>
<h2 id="4-3-泛型方法中的类型推断"><a href="#4-3-泛型方法中的类型推断" class="headerlink" title="4.3 泛型方法中的类型推断"></a>4.3 泛型方法中的类型推断</h2><p>在调用泛型方法的时候，可以显式地指定类型参数，也可以不指定。</p>
<ul>
<li>当泛型方法的形参列表中有多个类型参数时，在不指定类型参数的情况下，方法中声明的的类型参数为泛型方法中的几种类型参数的共同父类的最小级，直到 Object。</li>
<li>在指定了类型参数的时候，传入泛型方法中的实参的数据类型必须为指定数据类型或者其子类。</li>
</ul>
<p>举例如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 这是一个简单的泛型方法</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; T <span class="title function_">add</span><span class="params">(T x, T y)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> y;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// 一、不显式地指定类型参数</span></span><br><span class="line">        <span class="comment">//（1）传入的两个实参都是 Integer，所以泛型方法中的&lt;T&gt; == &lt;Integer&gt; </span></span><br><span class="line">        <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> Test.add(<span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//（2）传入的两个实参一个是 Integer，另一个是 Float，</span></span><br><span class="line">        <span class="comment">// 所以&lt;T&gt;取共同父类的最小级，&lt;T&gt; == &lt;Number&gt;</span></span><br><span class="line">        <span class="type">Number</span> <span class="variable">f</span> <span class="operator">=</span> Test.add(<span class="number">1</span>, <span class="number">1.2</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 传入的两个实参一个是 Integer，另一个是 String，</span></span><br><span class="line">        <span class="comment">// 所以&lt;T&gt;取共同父类的最小级，&lt;T&gt; == &lt;Object&gt;</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> Test.add(<span class="number">1</span>, <span class="string">&quot;asd&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 二、显式地指定类型参数</span></span><br><span class="line">        <span class="comment">//（1）指定了&lt;T&gt; = &lt;Integer&gt;，所以传入的实参只能为 Integer 对象    </span></span><br><span class="line">        <span class="type">int</span> <span class="variable">a</span> <span class="operator">=</span> Test.&lt;Integer&gt;add(<span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//（2）指定了&lt;T&gt; = &lt;Integer&gt;，所以不能传入 Float 对象</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">b</span> <span class="operator">=</span> Test.&lt;Integer&gt;add(<span class="number">1</span>, <span class="number">2.2</span>);<span class="comment">// 编译错误</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//（3）指定&lt;T&gt; = &lt;Number&gt;，所以可以传入 Number 对象</span></span><br><span class="line">        <span class="comment">// Integer 和 Float 都是 Number 的子类，因此可以传入两者的对象</span></span><br><span class="line">        <span class="type">Number</span> <span class="variable">c</span> <span class="operator">=</span> Test.&lt;Number&gt;add(<span class="number">1</span>, <span class="number">2.2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="5-类型擦除"><a href="#5-类型擦除" class="headerlink" title="5. 类型擦除"></a>5. 类型擦除</h1><h2 id="5-1-什么是类型擦除"><a href="#5-1-什么是类型擦除" class="headerlink" title="5.1 什么是类型擦除"></a>5.1 什么是类型擦除</h2><p>泛型的本质是将 <code>数据类型参数化</code>，它通过擦除的方式来实现，即编译器会在编译期间<code>擦除</code>代码中的所有泛型语法并相应的做出一些类型转换动作。</p>
<p>换而言之，泛型信息只存在于代码编译阶段，在代码编译结束后，与泛型相关的信息会被擦除掉，专业术语叫做 <code>类型擦除</code>。也就是说，成功编译过后的 class 文件中不包含任何泛型信息，泛型信息不会进入到 <code>运行时阶段</code>。</p>
<blockquote>
<p>先看一个例子，假如我们给 ArrayList 集合传入两种不同的数据类型，并比较它们的类信息。</p>
</blockquote>
<p>代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GenericType</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;  </span><br><span class="line">        ArrayList&lt;String&gt; arrayString = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;String&gt;();   </span><br><span class="line">        ArrayList&lt;Integer&gt; arrayInteger = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;Integer&gt;();   </span><br><span class="line">        System.out.println(arrayString.getClass() == arrayInteger.getClass());<span class="comment">// true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>在这个例子中，我们定义了两个 ArrayList 集合，不过一个是 <code>ArrayList&lt;String&gt;</code>，只能存储字符串。一个是 <code>ArrayList&lt;Integer&gt;</code>，只能存储整型对象。我们通过 arrayString 对象和 arrayInteger 对象的 <code>getClass()</code> 方法获取它们的类信息并比较，发现结果为 <code>true</code>。</li>
<li><strong>明明我们在 &lt;&gt; 中传入了两种不同的数据类型，按照上文所说的，它们的类型参数 T 不是应该被替换成我们传入的数据类型了吗，那为什么它们的类信息还是相同呢？</strong> 这是因为，在编译期间，所有的 <code>泛型信息  </code>都会被擦除， <code>ArrayList&lt;Integer&gt;</code>  和 <code>ArrayList&lt;String&gt;</code> 类型，在编译后都会变成 <code>ArrayList&lt;Object&gt;</code> 类型。</li>
</ul>
<blockquote>
<p>再看一个例子，假设定义一个泛型类如下：</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Caculate</span>&lt;T&gt; &#123;</span><br><span class="line">	<span class="keyword">private</span> T num;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>在该泛型类中定义了一个属性 num，该属性的数据类型是泛型类声明的类型参数 T ，这个 T 具体是什么类型，我们也不知道，它只与外部传入的数据类型有关。将这个泛型类反编译。</strong></p>
<p>代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Caculate</span> &#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="title function_">Caculate</span><span class="params">()</span> &#123;&#125;<span class="comment">// 默认构造器，不用管</span></span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> Object num;<span class="comment">// T 被替换为 Object 类型</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以发现编译器 <code>擦除</code> 了 Caculate 类后面的泛型标识 <code>&lt;T&gt;</code>，并且将 num 的数据类型替换为 Object 类型，而替换了 T 的数据类型我们称之为 <code>原始数据类型</code>。</p>
<p><strong>那么是不是所有的类型参数被擦除后都以 Object 类进行替换呢？</strong></p>
<ul>
<li>答案是否定的，大部分情况下，类型参数 T 被擦除后都会以 Object 类进行替换；而有一种情况则不是，那就是使用到了 extends 和 super 语法的<code>有界类型参数</code>（即<code>泛型通配符</code>，后面我们会详细解释）。</li>
</ul>
<blockquote>
<p>再看一个例子，假设定义一个泛型类如下：</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Caculate</span>&lt;T <span class="keyword">extends</span> <span class="title class_">Number</span>&gt; &#123;</span><br><span class="line">	<span class="keyword">private</span> T num;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>将其反编译：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Caculate</span> &#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="title function_">Caculate</span><span class="params">()</span> &#123;&#125;<span class="comment">// 默认构造器，不用管</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Number num;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>可以发现，使用到了 extends 语法的类型参数 T 被擦除后会替换为 Number 而不再是 Object。</strong></li>
<li><strong>extends 和 super 是一个限定类型参数边界的语法，extends 限定 T 只能是 Number 或者是 Number 的子类。</strong> 也就是说，在创建 Caculate 类对象的时候，<code>尖括号 &lt;&gt; 中只能传入 Number 类或者 Number 的子类的数据类型</code>，所以在创建 Caculate 类对象时无论传入什么数据类型，Number 都是其父类，于是可以使用 Number 类作为 T 的<code>原始数据类型</code>，进行<code>类型擦除</code>并替换。（这一部分涉及到了泛型通配符，在下面还会具体介绍）</li>
</ul>
<h2 id="5-2-类型擦除的原理"><a href="#5-2-类型擦除的原理" class="headerlink" title="5.2 类型擦除的原理"></a>5.2 类型擦除的原理</h2><p><strong>假如我们定义了一个 <code>ArrayList&lt;Integer&gt;</code> 泛型集合，若向该集合中插入 String 类型的对象，不需要运行程序，编译器就会直接报错。这里可能有小伙伴就产生了疑问：</strong></p>
<ul>
<li>不是说泛型信息在编译的时候就会被擦除掉吗？那既然泛型信息被擦除了，如何保证我们在集合中只添加指定的数据类型的对象呢？</li>
<li>换而言之，我们虽然定义了 ArrayList&lt; Integer &gt; 泛型集合，但其泛型信息最终被擦除后就变成了 <code>ArrayList&lt; Object &gt; 集合</code>，那为什么不允许向其中插入 String 对象呢？</li>
</ul>
<p><strong>Java 是如何解决这个问题的？</strong></p>
<ul>
<li>其实在创建一个泛型类的对象时， Java 编译器是先检查代码中传入 <code>&lt;T&gt;</code> 的数据类型，并记录下来，然后再对代码进行编译，<code>编译的同时进行类型擦除</code>；如果需要对被擦除了泛型信息的对象进行操作，编译器会自动将对象进行类型转换。</li>
</ul>
<p><strong>可以把泛型的 <code>类型安全检查机制</code> 和 <code>类型擦除</code> 想象成演唱会的验票机制：以 <code>ArrayList&lt;Integer&gt;</code> 泛型集合为例。</strong></p>
<ol>
<li>当我们在创建一个 <code>ArrayList&lt;Integer&gt;</code> 泛型集合的时候，ArrayList 可以看作是演唱会场馆，而 <code>&lt;T&gt;</code> 就是场馆的验票系统，Integer 是验票系统设置的门票类型；</li>
<li>当验票系统设置好为 <code>&lt;Integer&gt;</code> 后，只有持有 Integer 门票的人才可以通过验票系统，进入演唱会场馆（集合）中；若是未持有 Integer 门票的人想进场，则验票系统会发出警告（编译器报错）。</li>
<li>在通过验票系统时，门票会被收掉（类型擦除），但场馆后台（JVM）会记录下观众信息（泛型信息）。</li>
<li>进场后的观众变成了没有门票的普通人（原始数据类型）。但是，在需要查看观众的信息时（操作对象），场馆后台可以找到记录的观众信息（编译器会自动将对象进行类型转换）。</li>
</ol>
<p>举例如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GenericType</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        ArrayList&lt;Integer&gt; arrayInteger = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;Integer&gt;();<span class="comment">// 设置验票系统   </span></span><br><span class="line">        arrayInteger.add(<span class="number">111</span>);<span class="comment">// 观众进场，验票系统验票，门票会被收走（类型擦除）</span></span><br><span class="line">        <span class="type">Integer</span> <span class="variable">n</span> <span class="operator">=</span> arrayInteger.get(<span class="number">0</span>);<span class="comment">// 获取观众信息，编译器会进行强制类型转换</span></span><br><span class="line">        System.out.println(n);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>擦除 ArrayList&lt; Integer &gt; 的泛型信息后，get() 方法的返回值将返回 Object 类型，但编译器会自动插入 Integer 的强制类型转换。也就是说，编译器把 get() 方法调用翻译为两条字节码指令：</strong></p>
<ol>
<li>对原始方法 get() 的调用，返回的是 Object 类型</li>
<li>将返回的 Object 类型强制转换为 Integer 类型</li>
</ol>
<p>代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Integer</span> <span class="variable">n</span> <span class="operator">=</span> arrayInteger.get(<span class="number">0</span>);<span class="comment">// 这条代码底层如下：</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//（1）get() 方法的返回值返回的是 Object 类型</span></span><br><span class="line"><span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> arrayInteger.get(<span class="number">0</span>);</span><br><span class="line"><span class="comment">//（2）编译器自动插入 Integer 的强制类型转换</span></span><br><span class="line"><span class="type">Integer</span> <span class="variable">n</span> <span class="operator">=</span> (Integer) object;</span><br></pre></td></tr></table></figure>

<h2 id="5-3-类型擦除小结"><a href="#5-3-类型擦除小结" class="headerlink" title="5.3 类型擦除小结"></a>5.3 类型擦除小结</h2><ol>
<li><code>泛型信息（包括泛型类、接口、方法）只在代码编译阶段存在</code>，在代码成功编译后，其内的所有泛型信息都会被擦除，并且类型参数 T 会被统一替换为其 <code>原始类型</code>（默认是 Object 类，若有 extends 或者 super 则另外分析）；</li>
<li>在泛型信息被擦除后，若还需要使用到对象相关的泛型信息，编译器底层会 <code>自动进行类型转换</code>（从原始类型转换为未擦除前的数据类型）。</li>
</ol>
<h1 id="6-泛型通配符"><a href="#6-泛型通配符" class="headerlink" title="6. 泛型通配符"></a>6. 泛型通配符</h1><h2 id="6-1-泛型的继承"><a href="#6-1-泛型的继承" class="headerlink" title="6.1 泛型的继承"></a>6.1 泛型的继承</h2><p>在介绍泛型通配符之前，先提出一个问题，在 Java 的多态中，我们知道可以将一个子类对象赋值给其父类的引用，这也叫<code>向上转型</code>。</p>
<p>举例如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GenericType</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">       	<span class="type">List</span> <span class="variable">list</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ArrayList</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>上面的代码很好得体现了 Java 的多态特性。</li>
</ul>
<p>在 Java 标准库中的集合 <code>ArrayList&lt;T&gt;</code> 类实现了 <code>List&lt;T&gt;</code> 接口，其源码大致如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ArrayList</span>&lt;T&gt; <span class="keyword">implements</span> <span class="title class_">List</span>&lt;T&gt; &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>那现在我们思考一个问题，在 <code>ArrayList&lt;T&gt;</code> 泛型集合中，当传入 <code>&lt;T&gt;</code> 中的数据类型相同时，是否还能将一个 <code>ArrayList&lt;T&gt;</code> 对象赋值给其父类的引用 <code>List&lt;T&gt;</code>。</p>
</blockquote>
<p>代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GenericType</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">       	List&lt;Integer&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;Integer&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>上面的代码没有问题， 即 <code>ArrayList&lt;T&gt;</code> 对象可以向上转型为 <code>List&lt;T&gt;</code>，但两者传入 <code>&lt;T&gt;</code> 中的数据类型必须相同。</li>
</ul>
<blockquote>
<p>继续思考一个问题，已知 Integer 类是 Number 类的子类，那如果 ArrayList&lt;&gt; 泛型集合中，在 &lt;&gt; 之间使用<code>向上转型</code>，也就是将 <code>ArrayList&lt;Integer&gt;</code> 对象赋值给 <code>List&lt;Number&gt;</code> 的引用，是否被允许呢？</p>
</blockquote>
<p>举例如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GenericType</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">       	List&lt;Number&gt; list01 = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;Integer&gt;();<span class="comment">// 编译错误</span></span><br><span class="line">       	</span><br><span class="line">		ArrayList&lt;Number&gt; list02 = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;Integer&gt;();<span class="comment">// 编译错误</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>上面代码会报错，我们发现并不能把 <code>ArrayList&lt;Integer&gt;</code> 对象赋值给 <code>List&lt;Number&gt;</code> 的引用，甚至不能把 <code>ArrayList&lt;Integer&gt;</code> 对象赋值给 <code>ArrayList&lt;Number&gt;</code> 的引用。<code>这也说明了在一般泛型中，不能向上转型</code>。</li>
</ul>
<blockquote>
<p>这是为什么？如果我们假设 <code>ArrayList&lt;Integer&gt;</code> 可以向上转型为 <code>ArrayList&lt;Number&gt;</code>。</p>
</blockquote>
<p>观察下面代码：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GenericType</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">       	<span class="comment">// 创建一个 ArrayList&lt;Integer&gt; 集合</span></span><br><span class="line">		ArrayList&lt;Integer&gt; integerList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// 添加一个 Integer 对象</span></span><br><span class="line">		integerList.add(<span class="keyword">new</span> <span class="title class_">Integer</span>(<span class="number">123</span>));</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// “向上转型”为 ArrayList&lt;Number&gt;</span></span><br><span class="line">		ArrayList&lt;Number&gt; numberList = integerList;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// 添加一个 Float 对象，Float 也是 Number 的子类，编译器不报错</span></span><br><span class="line">		numberList.add(<span class="keyword">new</span> <span class="title class_">Float</span>(<span class="number">12.34</span>));</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// 从 ArrayList&lt;Integer&gt; 集合中获取索引为 1 的元素（即添加的 Float 对象）：</span></span><br><span class="line">		<span class="type">Integer</span> <span class="variable">n</span> <span class="operator">=</span> integerList.get(<span class="number">1</span>); <span class="comment">// ClassCastException，运行出错</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>当我们把一个 <code>ArrayList&lt;Integer&gt;</code> 向上转型为 <code>ArrayList&lt;Number&gt;</code> 类型后，这个 <code>ArrayList&lt;Number&gt;</code> 集合就可以接收 Float 对象了，因为 Float 类是 Number 类的子类。</li>
<li>但是，<code>ArrayList&lt;Number&gt;</code> 实际上和 <code>ArrayList&lt;Integer&gt;</code> 是同一个集合，而在泛型的定义中， <code>ArrayList&lt;Integer&gt;</code> 集合是不可以接收 Float 对象的。这是因为，在使用 get() 方法获取集合元素的时候，编译器会自动将 Float 对象强转成 Integer 对象，而这会产生 <code>ClassCastException</code> 异常。</li>
</ul>
<p><strong>正因如此，编译器为了避免发生这种错误，根本就不允许把 <code>ArrayList&lt;Integer&gt;</code> 对象向上转型为 <code>ArrayList&lt;Number&gt;</code>；换而言之， <code>ArrayList&lt;Integer&gt;</code> 和 <code>ArrayList&lt;Number&gt;</code> 两者之间没有继承关系。</strong></p>
<h2 id="6-2-泛型通配符的引入"><a href="#6-2-泛型通配符的引入" class="headerlink" title="6.2 泛型通配符的引入"></a>6.2 泛型通配符的引入</h2><p><strong>我们上面讲到了泛型的继承关系，<code>ArrayList&lt;Integer&gt;</code> 不是 <code>ArrayList&lt;Number&gt;</code> 的子类。</strong></p>
<p>1、先看一个问题：假设我们定义了一个 <code>Pair&lt;T&gt;</code> 类，如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Pair</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> T first;</span><br><span class="line">    <span class="keyword">private</span> T last;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Pair</span><span class="params">(T first, T last)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.first = first;</span><br><span class="line">        <span class="built_in">this</span>.last = last;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> T <span class="title function_">getFirst</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> first;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> T <span class="title function_">getLast</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> last;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setFirst</span><span class="params">(T first)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.first = first;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setLast</span><span class="params">(T last)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.last = last;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2、然后，我们针对 <code>Pair&lt;Number&gt;</code> 类型写了一个静态方法，它接收的参数类型是 <code>Pair&lt;Number&gt;</code>。</p>
<p>代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PairHelper</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">addPair</span><span class="params">(Pair&lt;Number&gt; p)</span> &#123;</span><br><span class="line">        <span class="type">Number</span> <span class="variable">first</span> <span class="operator">=</span> p.getFirst();</span><br><span class="line">        <span class="type">Number</span> <span class="variable">last</span> <span class="operator">=</span> p.getLast();</span><br><span class="line">        <span class="keyword">return</span> first.intValue() + last.intValue();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3、在测试类中创建一个 <code>Pair&lt;Number&gt;</code> 对象，并调用 addPair() 方法。</p>
<p>代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;  </span><br><span class="line">		Pair&lt;Number&gt; pair = <span class="keyword">new</span> <span class="title class_">Pair</span>&lt;&gt;(<span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line">       	<span class="type">int</span> <span class="variable">sum</span> <span class="operator">=</span> PairHelper.addPair(pair);</span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>4、上面的代码正常编译运行。但我们发现，在实际创建 <code>Pair&lt;Number&gt;</code> 对象的时候，我们传入的实参 (1, 2) 实际上是 Integer 类型；那我们是否可以直接创建一个 <code>Pair&lt;Integer&gt;</code> 对象，并将其传给 add() 方法呢？</p>
<p>代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;  </span><br><span class="line">		Pair&lt;Integer&gt; pairInteger = <span class="keyword">new</span> <span class="title class_">Pair</span>&lt;&gt;(<span class="number">123</span>, <span class="number">456</span>);</span><br><span class="line">       	<span class="type">int</span> <span class="variable">sum</span> <span class="operator">=</span> PairHelper.addPair(pairInteger);</span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>编译器会直接报错，原因是 <code>Pair&lt;Integer&gt; </code> 并不是 <code>Pair&lt;Number&gt;</code> 的子类，而 addPair() 方法的形参数据类型为 <code>Pair&lt;Number&gt;</code>。因此， <code>Pair&lt;Integer&gt;</code> 对象不能传给 addPair() 方法。</li>
</ul>
<p><strong>那有没有办法使得 addPair() 方法可以接收 <code>Pair&lt;Integer&gt;</code> 对象？总不能重新定义一个新的 addPair() 方法来处理 <code>Pair&lt;Integer&gt;</code> 对象吧，这显然与 Java 中的多态理念相违背。</strong></p>
<ul>
<li>因此我们需要一个在逻辑上可以表示为 <code>Pair&lt;Integer&gt;</code> 和 <code>Pair&lt;Number&gt;</code> 这两者的父类引用类型，由此，泛型通配符便应运而生。</li>
</ul>
<h2 id="6-3-什么是泛型通配符"><a href="#6-3-什么是泛型通配符" class="headerlink" title="6.3 什么是泛型通配符"></a>6.3 什么是泛型通配符</h2><p>在现实编码中，确实有这样的需求，希望泛型能够处理 <code>某一类型范围内</code> 的类型参数，比如某个泛型类和它的子类，为此 Java 引入了<code>泛型通配符</code>这个概念。</p>
<p><strong>泛型通配符有 3 种形式：</strong></p>
<ul>
<li><code>&lt;?&gt;</code> ：被称作无限定的通配符。</li>
<li><code>&lt;? extends T&gt;</code> ：被称作有上界的通配符。</li>
<li><code>&lt;? super T&gt;</code> ：被称作有下界的通配符。</li>
</ul>
<p>在引入泛型通配符之后，我们便得到了一个在 <code>逻辑上 </code>可以表示为某一类型参数范围的父类引用类型。举例来说，泛型通配符可以表示 <code>Pair&lt;Integer&gt;</code> 和 <code>Pair&lt;Number&gt;</code> 两者的 <code>父类引用类型</code>。</p>
<p><strong>接下来将分别介绍 3 种形式的泛型通配符。</strong></p>
<h2 id="6-4-上界通配符"><a href="#6-4-上界通配符" class="headerlink" title="6.4 上界通配符 &lt;? extends T&gt;"></a>6.4 上界通配符 &lt;? extends T&gt;</h2><h3 id="6-4-1-的定义"><a href="#6-4-1-的定义" class="headerlink" title="6.4.1 &lt;? extends T&gt; 的定义"></a>6.4.1 &lt;? extends T&gt; 的定义</h3><p><strong>上界通配符 <code>&lt;? extends T&gt;</code>：T 代表了类型参数的上界，<code>&lt;? extends T&gt;</code>表示类型参数的范围是 T 和 T 的子类。需要注意的是： <code>&lt;? extends T&gt;</code> 也是一个数据类型实参，它和 Number、String、Integer 一样都是一种实际的数据类型。</strong></p>
<blockquote>
<p>（1）在<code>泛型的继承</code>中我们说到，<code>ArrayList&lt;Integer&gt;</code> 和 <code>ArrayList&lt;Number&gt;</code> 之间不存在继承关系。而引入<code>上界通配符</code>的概念后，我们便可以在逻辑上将 ArrayList&lt;? extends Number&gt; 看做是 <code>ArrayList&lt;Integer&gt;</code> 的父类，<strong>但实质上它们之间没有继承关系。</strong></p>
</blockquote>
<p>举例如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GenericType</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">		ArrayList&lt;Number&gt; list01 = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;Integer&gt;();<span class="comment">// 编译错误</span></span><br><span class="line"></span><br><span class="line">		ArrayList&lt;? <span class="keyword">extends</span> <span class="title class_">Number</span>&gt; list02 = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;Integer&gt;();<span class="comment">// 编译正确</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>逻辑上可以将 ArrayList&lt;? extends Number&gt; 看做是 <code>ArrayList&lt;Integer&gt;</code> 的父类，因此，在使用了上界通配符 &lt;? extends Number&gt; 后，便可以将 <code>ArrayList&lt;Integer&gt;</code> 对象<code>向上转型</code>了。</li>
</ul>
<blockquote>
<p>（2）ArrayList&lt;? extends Number&gt; 可以代表 <code>ArrayList&lt;Integer&gt;</code>、<code>ArrayList&lt;Float&gt;</code>、… 、<code>ArrayList&lt;Number&gt;</code>中的<code>某一个集合</code>，但我们不能指定 ArrayList&lt;? extends Number&gt; 的数据类型。（这里有点难理解）</p>
</blockquote>
<p>举个例子：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GenericType</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;  </span><br><span class="line">		ArrayList&lt;? <span class="keyword">extends</span> <span class="title class_">Number</span>&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">		</span><br><span class="line">		list.add(<span class="keyword">new</span> <span class="title class_">Integer</span>(<span class="number">1</span>));<span class="comment">// 编译错误</span></span><br><span class="line">		list.add(<span class="keyword">new</span> <span class="title class_">Float</span>(<span class="number">1.0</span>));<span class="comment">// 编译错误</span></span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>可以这样理解，ArrayList&lt;? extends Number&gt; 集合表示了：我这个集合可能是 <code>ArrayList&lt;Integer&gt;</code> 集合，也可能是 <code>ArrayList&lt;Float&gt;</code> 集合，… ，还可能是 <code>ArrayList&lt;Number&gt;</code> 集合；但到底是哪一个集合，<strong>不能确定</strong>；程序员也不能指定。</li>
<li>所以，在上面代码中，创建了一个 ArrayList&lt;? extends Number&gt; 集合 list，但我们并不能往 list 中添加 Integer、Float 等对象，这也说明了 list 集合并不是某个确定了数据类型的集合。</li>
</ul>
<blockquote>
<p>思考：那既然 ArrayList&lt;? extends Number&gt; 可以代表 <code>ArrayList&lt;Integer&gt;</code> 或 <code>ArrayList&lt;Float&gt;</code>，为什么不能向其中加入 Integer、Float 等对象呢？</p>
</blockquote>
<ul>
<li>其原因是 ArrayList&lt;? extends Number&gt; 表示的是一个<code>未知类型的 ArrayList 集合</code>，它可以代表 <code>ArrayList&lt;Integer&gt;</code> 或 <code>ArrayList&lt;Float&gt;</code>… 等集合，但却不能确定它到底是 <code>ArrayList&lt;Integer&gt;</code> 还是 <code>ArrayList&lt;Float&gt;</code> 集合。</li>
<li>因此，<code>泛型的特性</code>决定了不能往 ArrayList&lt;? extends Number&gt; 集合中加入 Integer 、 Float 等对象，以防止在获取 ArrayList&lt;? extends Number&gt; 集合中元素的时候，产生 <code>ClassCastException</code> 异常。</li>
</ul>
<p><strong>那为什么还需要引入 <code>上界统配符   </code>的概念？—— 为了拓展方法形参中类型参数的范围。</strong></p>
<blockquote>
<p>（1）在 <code>泛型通配符的引入</code> 部分，我们提出了一个问题，有没有办法使得 addPair(Pair&lt;Number&gt; p) 方法接收 <code>Pair&lt;Integer&gt;</code> 对象？而在有了上界通配符的概念后，这个问题便有了解决办法，就是将 addPair() 方法改写。</p>
</blockquote>
<p>代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 改写前</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PairHelper</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">addPair</span><span class="params">(Pair&lt;Number&gt; p)</span> &#123;</span><br><span class="line">        <span class="type">Number</span> <span class="variable">first</span> <span class="operator">=</span> p.getFirst();</span><br><span class="line">        <span class="type">Number</span> <span class="variable">last</span> <span class="operator">=</span> p.getLast();</span><br><span class="line">        <span class="keyword">return</span> first.intValue() + last.intValue();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 改写后</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PairHelper</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">addPair</span><span class="params">(Pair&lt;? extends Number&gt; p)</span> &#123;</span><br><span class="line">        <span class="type">Number</span> <span class="variable">first</span> <span class="operator">=</span> p.getFirst();</span><br><span class="line">        <span class="type">Number</span> <span class="variable">last</span> <span class="operator">=</span> p.getLast();</span><br><span class="line">        <span class="keyword">return</span> first.intValue() + last.intValue();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>改写 addPair() 方法，用 <code>&lt;? extends Number&gt;</code> 替换了 <code>&lt;Number&gt;</code> ，由于 <code>Pair&lt;Integer&gt;</code> 可以<code>向上转型</code>为 Pair&lt;? extends Number&gt; ，所以调用 addPair() 方法时，我们便可以传入 <code>Pair&lt;Integer&gt;</code> 对象了。</li>
<li>除了可以传入 <code>Pair&lt;Integer&gt;</code> 对象，我们还可以传入 <code>Pair&lt;Double&gt;</code> 对象，<code>Pair&lt;BigDecimal&gt;</code> 对象等等，因为 Double 类和 BigDecimal 类也都是 Number 的子类。</li>
</ul>
<h3 id="6-4-2-的用法"><a href="#6-4-2-的用法" class="headerlink" title="6.4.2 &lt;? extends T&gt; 的用法"></a>6.4.2 &lt;? extends T&gt; 的用法</h3><p>上面说到，我们无法确定 ArrayList&lt;? extends Number&gt; 具体是什么数据类型的集合，因此其 add() 方法会受限（即不能往集合中添加任何数据类型的对象）；但是可以往集合中添加 null，因为 null 表示任何类型。</p>
<p>我们可以调用 get() 方法从集合中获取元素，并赋值给集合中的最高父类 Number (<code>即 &lt;? extends T&gt; 的上界</code>)。</p>
<blockquote>
<p><strong>（1）上界通配符 &lt;? extends T&gt; 的正确用法：</strong></p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    	<span class="comment">// 创建一个 ArrayList&lt;Integer&gt; 集合</span></span><br><span class="line">        ArrayList&lt;Integer&gt; integerList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        integerList.add(<span class="number">1</span>);</span><br><span class="line">        integerList.add(<span class="number">2</span>);</span><br><span class="line">        <span class="comment">// 将 ArrayList&lt;Integer&gt; 传入 printIntVal() 方法</span></span><br><span class="line">        printIntVal(integerList);</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// 创建一个 ArrayList&lt;Float&gt; 集合</span></span><br><span class="line">        ArrayList&lt;Float&gt; floatList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        floatList.add((<span class="type">float</span>) <span class="number">1.0</span>);</span><br><span class="line">        floatList.add((<span class="type">float</span>) <span class="number">2.0</span>);</span><br><span class="line">        <span class="comment">// 将 ArrayList&lt;Float&gt; 传入 printIntVal() 方法</span></span><br><span class="line">        printIntVal(floatList);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">printIntVal</span><span class="params">(ArrayList&lt;? extends Number&gt; list)</span> &#123;</span><br><span class="line"> 		<span class="comment">// 遍历传入的集合，并输出集合中的元素       </span></span><br><span class="line">        <span class="keyword">for</span> (Number number : list) &#123;</span><br><span class="line">            System.out.print(number.intValue() + <span class="string">&quot; &quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1 2 </span><br><span class="line">1 2</span><br></pre></td></tr></table></figure>

<ul>
<li><p>在 printIntVal() 方法中，其形参为 ArrayList&lt;? extends Number&gt;，因此，可以给该方法传入 <code>ArrayList&lt;Integer&gt;</code>、<code>ArrayList&lt;Float&gt;</code> 等集合。</p>
</li>
<li><p>需要注意的是：在 printIntVal() 方法内部，必须要将传入集合中的元素赋值给 Number 对象，而不能赋值给某个子类对象； 是因为根据 ArrayList&lt;? extends Number&gt; 的特性，并不能确定传入集合的数据类型（即不能确定传入的是 <code>ArrayList&lt;Integer&gt;</code> 还是 <code>ArrayList&lt;Float&gt;</code>）。</p>
</li>
<li><p>假设在 printIntVal() 方法中存在下面代码：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Integer</span> <span class="variable">intNum</span> <span class="operator">=</span> (Integer) number;</span><br></pre></td></tr></table></figure>
</li>
<li><p>若是传入集合为 <code>ArrayList&lt;Float&gt;</code>，则必然会产生<code>ClassCastException</code> 异常。</p>
</li>
</ul>
<blockquote>
<p>（2）上界通配符 &lt;? extends T&gt; 的<strong>错误</strong>用法：</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">		ArrayList&lt;? <span class="keyword">extends</span> <span class="title class_">Number</span>&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>();</span><br><span class="line">		list.add(<span class="literal">null</span>);<span class="comment">// 编译正确</span></span><br><span class="line">		list.add(<span class="keyword">new</span> <span class="title class_">Integer</span>(<span class="number">1</span>));<span class="comment">// 编译错误</span></span><br><span class="line">		list.add(<span class="keyword">new</span> <span class="title class_">Float</span>(<span class="number">1.0</span>));<span class="comment">// 编译错误</span></span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">fillNumList</span><span class="params">(ArrayList&lt;? extends Number&gt; list)</span> &#123;</span><br><span class="line">		list.add(<span class="keyword">new</span> <span class="title class_">Integer</span>(<span class="number">0</span>));<span class="comment">//编译错误</span></span><br><span class="line">		list.add(<span class="keyword">new</span> <span class="title class_">Float</span>(<span class="number">1.0</span>));<span class="comment">//编译错误</span></span><br><span class="line">		list.set(<span class="number">0</span>, <span class="keyword">new</span> <span class="title class_">Integer</span>(<span class="number">2</span>));<span class="comment">// 编译错误</span></span><br><span class="line">		list.set(<span class="number">0</span>, <span class="literal">null</span>);<span class="comment">// 编译成功，但不建议这样使用</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>在 ArrayList&lt;? extends Number&gt; 集合中，不能添加任何数据类型的对象，只能添加空值 null，因为 null 可以表示任何数据类型。</li>
</ul>
<h3 id="6-4-3-小结"><a href="#6-4-3-小结" class="headerlink" title="6.4.3 &lt;? extends T&gt; 小结"></a>6.4.3 &lt;? extends T&gt; 小结</h3><p><strong>一句话总结：使用 extends 通配符表示可以读，不能写。</strong></p>
<h2 id="6-5-下界通配符"><a href="#6-5-下界通配符" class="headerlink" title="6.5 下界通配符 &lt;? super T&gt;"></a>6.5 下界通配符 &lt;? super T&gt;</h2><h3 id="6-5-1-的定义"><a href="#6-5-1-的定义" class="headerlink" title="6.5.1 &lt;? super T&gt; 的定义"></a>6.5.1 &lt;? super T&gt; 的定义</h3><p><strong>下界通配符 <code>&lt;? super T&gt;</code>：T 代表了类型参数的下界，<code>&lt;? super T&gt;</code>表示类型参数的范围是 T 和 T 的超类，直至 Object。需要注意的是： <code>&lt;? super T&gt;</code> 也是一个数据类型实参，它和 Number、String、Integer 一样都是一种实际的数据类型。</strong></p>
<blockquote>
<p>（1）ArrayList&lt;? super Integer&gt; 在逻辑上表示为 Integer 类以及 Integer 类的所有父类，它可以代表 <code>ArrayList&lt;Integer&gt;</code>、<code>ArrayList&lt;Number&gt;</code>、 <code>ArrayList&lt;Object&gt;</code> 中的<code>某一个集合</code>，但实质上它们之间没有继承关系。</p>
</blockquote>
<p>举个例子：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GenericType</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;  </span><br><span class="line">		ArrayList&lt;Integer&gt; list01 = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;Number&gt;();<span class="comment">// 编译错误</span></span><br><span class="line"></span><br><span class="line">		ArrayList&lt;? <span class="built_in">super</span> Integer&gt; list02 = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;Number&gt;();<span class="comment">// 编译正确</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>逻辑上可以将 ArrayList&lt;? super Integer&gt; 看做是 <code>ArrayList&lt;Number&gt;</code> 的父类，因此，在使用了下界通配符 &lt;? super Integer&gt; 后，便可以将 <code>ArrayList&lt;Number&gt;</code> 对象<code>向上转型</code>了。</li>
</ul>
<blockquote>
<p>（2）ArrayList&lt;? super Integer&gt; 只能表示指定类型参数范围中的<code>某一个集合</code>，但我们不能指定 ArrayList&lt;? super Integer&gt; 的数据类型。（这里有点难理解）</p>
</blockquote>
<p>看一个例子：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GenericType</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;  </span><br><span class="line">		ArrayList&lt;? <span class="built_in">super</span> Number&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">		</span><br><span class="line">		list.add(<span class="keyword">new</span> <span class="title class_">Integer</span>(<span class="number">1</span>));<span class="comment">// 编译正确</span></span><br><span class="line">		list.add(<span class="keyword">new</span> <span class="title class_">Float</span>(<span class="number">1.0</span>));<span class="comment">// 编译正确</span></span><br><span class="line">		</span><br><span class="line">		<span class="comment">// Object 是 Number 的父类 </span></span><br><span class="line">		list.add(<span class="keyword">new</span> <span class="title class_">Object</span>());<span class="comment">// 编译错误</span></span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>这里奇怪的地方出现了，为什么和ArrayList&lt;? extends Number&gt; 集合不同， ArrayList&lt;? super Number&gt; 集合中可以添加 Number 类及其子类的对象呢？</li>
<li>其原因是， ArrayList&lt;? super Number&gt; 的下界是 <code>ArrayList&lt;Number&gt;</code> 。因此，我们可以确定 Number 类及其子类的对象自然可以加入 ArrayList&lt;? super Number&gt; 集合中； 而 <code>Number 类的父类对象</code>就不能加入 ArrayList&lt;? super Number&gt; 集合中了，因为不能确定 ArrayList&lt;? super Number&gt; 集合的数据类型。</li>
</ul>
<h3 id="6-5-2-的用法"><a href="#6-5-2-的用法" class="headerlink" title="6.5.2 &lt;? super T&gt; 的用法"></a>6.5.2 &lt;? super T&gt; 的用法</h3><blockquote>
<p><strong>（1）下界通配符 &lt;? super T&gt; 的正确用法：</strong></p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">		<span class="comment">// 创建一个 ArrayList&lt;? super Number&gt; 集合</span></span><br><span class="line">		ArrayList&lt;Number&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>(); </span><br><span class="line">		<span class="comment">// 往集合中添加 Number 类及其子类对象</span></span><br><span class="line">		list.add(<span class="keyword">new</span> <span class="title class_">Integer</span>(<span class="number">1</span>));</span><br><span class="line">		list.add(<span class="keyword">new</span> <span class="title class_">Float</span>(<span class="number">1.1</span>));</span><br><span class="line">		<span class="comment">// 调用 fillNumList() 方法，传入 ArrayList&lt;Number&gt; 集合</span></span><br><span class="line">		fillNumList(list);</span><br><span class="line">		System.out.println(list);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">fillNumList</span><span class="params">(ArrayList&lt;? <span class="built_in">super</span> Number&gt; list)</span> &#123;</span><br><span class="line">		list.add(<span class="keyword">new</span> <span class="title class_">Integer</span>(<span class="number">0</span>));</span><br><span class="line">		list.add(<span class="keyword">new</span> <span class="title class_">Float</span>(<span class="number">1.0</span>));</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[1, 1.1, 0, 1.0]</span><br></pre></td></tr></table></figure>

<ul>
<li>与带有上界通配符的集合<code>ArrayList&lt;? extends T&gt;</code>的用法不同，带有下界通配符的集合<code>ArrayList&lt;? super Number&gt;</code> 中可以添加 Number 类及其子类的对象；<code>ArrayList&lt;? super Number&gt;</code>的下界就是<code>ArrayList&lt;Number&gt;</code>集合，因此，其中必然可以添加 Number 类及其子类的对象；但不能添加 Number 类的父类对象（不包括 Number 类）。</li>
</ul>
<blockquote>
<p><strong>（2）下界通配符 &lt;? super T&gt; 的错误用法：</strong></p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    	<span class="comment">// 创建一个 ArrayList&lt;Integer&gt; 集合</span></span><br><span class="line">        ArrayList&lt;Integer&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        list.add(<span class="keyword">new</span> <span class="title class_">Integer</span>(<span class="number">1</span>));</span><br><span class="line">        <span class="comment">// 调用 fillNumList() 方法，传入 ArrayList&lt;Integer&gt; 集合</span></span><br><span class="line">        fillNumList(list);<span class="comment">// 编译错误</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">fillNumList</span><span class="params">(ArrayList&lt;? <span class="built_in">super</span> Number&gt; list)</span> &#123;</span><br><span class="line">        list.add(<span class="keyword">new</span> <span class="title class_">Integer</span>(<span class="number">0</span>));<span class="comment">// 编译正确</span></span><br><span class="line">        list.add(<span class="keyword">new</span> <span class="title class_">Float</span>(<span class="number">1.0</span>));<span class="comment">// 编译正确</span></span><br><span class="line">		</span><br><span class="line">		<span class="comment">// 遍历传入集合中的元素，并赋值给 Number 对象；会编译错误</span></span><br><span class="line">        <span class="keyword">for</span> (Number number : list) &#123;</span><br><span class="line">            System.out.print(number.intValue() + <span class="string">&quot; &quot;</span>);</span><br><span class="line">            System.out.println();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 遍历传入集合中的元素，并赋值给 Object 对象；可以正确编译</span></span><br><span class="line">        <span class="comment">// 但只能调用 Object 类的方法，不建议这样使用</span></span><br><span class="line">        <span class="keyword">for</span> (Object obj : list) &#123;</span><br><span class="line">            System.out.println(obj);使用</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>注意，<code>ArrayList&lt;? super Number&gt;</code> 代表了 <code>ArrayList&lt;Number&gt;</code>、 <code>ArrayList&lt;Object&gt;</code> 中的某一个集合，而 ArrayList&lt; Integer &gt; 并不属于 <code>ArrayList&lt;? super Number&gt;</code> 限定的范围，因此，不能往 fillNumList() 方法中传入 <code>ArrayList&lt;Integer&gt;</code> 集合。</li>
<li>并且，不能将传入集合的元素赋值给 Number 对象，因为传入的可能是 <code>ArrayList&lt;Object&gt;</code> 集合，向下转型可能会产生<code>ClassCastException</code> 异常。</li>
<li>不过，可以将传入集合的元素赋值给 Object 对象，因为 Object 是所有类的父类，不会产生<code>ClassCastException</code> 异常，但这样的话便只能调用 Object 类的方法了，不建议这样使用。</li>
</ul>
<h3 id="6-5-3-小结"><a href="#6-5-3-小结" class="headerlink" title="6.5.3 &lt;? super T&gt; 小结"></a>6.5.3 &lt;? super T&gt; 小结</h3><p><strong>一句话总结：使用 super 通配符表示可以写，不能读。</strong></p>
<h2 id="6-6-无限定通配符"><a href="#6-6-无限定通配符" class="headerlink" title="6.6 无限定通配符 &lt;?&gt;"></a>6.6 无限定通配符 &lt;?&gt;</h2><p><strong>我们已经讨论了 <code>&lt;? extends T&gt;</code> 和 <code>&lt;? super T&gt;</code> 作为方法参数的作用。实际上，Java 的泛型还允许使用无限定通配符&lt;?&gt;，即只定义一个<code>?</code>符号。</strong></p>
<ul>
<li>无界通配符<code>&lt;?&gt;</code>：<code>?</code> 代表了任何一种数据类型，能代表任何一种数据类型的只有 null。需要注意的是： <code>&lt;?&gt;</code> 也是一个数据类型实参，它和 Number、String、Integer 一样都是一种实际的数据类型。</li>
<li>注意：Object 本身也算是一种数据类型，但却不能代表任何一种数据类型，所以 <code>ArrayList&lt; Object &gt;</code> 和 <code>ArrayList&lt;?&gt;</code> 的含义是不同的，前者类型是 Object，也就是继承树的最高父类，而后者的类型完全是未知的；<code>ArrayList&lt;?&gt;</code> 是 <code>ArrayList&lt;Object&gt;</code> 逻辑上的父类。</li>
</ul>
<blockquote>
<p>（1）ArrayList&lt;?&gt; 在逻辑上表示为所有数据类型的父类，它可以代表 <code>ArrayList&lt;Integer&gt;</code>、<code>ArrayList&lt;Number&gt;</code>、<code>ArrayList&lt;Object&gt;</code>中的某一个集合，但实质上它们之间没有继承关系。</p>
</blockquote>
<p>举例如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GenericType</span> &#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        ArrayList&lt;Integer&gt; list01 = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(<span class="number">123</span>, <span class="number">456</span>);</span><br><span class="line">        ArrayList&lt;?&gt; list02 = list01; <span class="comment">// 安全地向上转型</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>上述代码是可以正常编译运行的，因为 <code>ArrayList&lt;?&gt;</code> 在逻辑上是 <code>ArrayList&lt;Integer&gt;</code> 的父类，可以安全地<code>向上转型</code>。</li>
</ul>
<blockquote>
<p>（2）<code>ArrayList&lt;?&gt;</code> 既没有上界也没有下界，因此，它可以代表所有数据类型的某一个集合，但我们不能指定 <code>ArrayList&lt;?&gt;</code> 的数据类型。</p>
</blockquote>
<p>举例如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GenericType</span> &#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        ArrayList&lt;?&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        list.add(<span class="literal">null</span>);<span class="comment">// 编译正确</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> list.get(<span class="number">0</span>);<span class="comment">// 编译正确</span></span><br><span class="line"></span><br><span class="line">		list.add(<span class="keyword">new</span> <span class="title class_">Integer</span>(<span class="number">1</span>));<span class="comment">// 编译错误</span></span><br><span class="line">		<span class="type">Integer</span> <span class="variable">num</span> <span class="operator">=</span> list.get(<span class="number">0</span>);<span class="comment">// 编译错误</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>ArrayList&lt;?&gt;</code> 集合的数据类型是不确定的，因此我们只能往集合中添加 null；而我们从 <code>ArrayList&lt;?&gt;</code> 集合中取出的元素，也只能赋值给 Object 对象，不然会产生<code>ClassCastException</code> 异常（原因可以结合上界和下界通配符理解）。</li>
</ul>
<blockquote>
<p>（3）大多数情况下，可以用类型参数 <code>&lt;T&gt;</code> 代替 &lt;?&gt; 通配符。</p>
</blockquote>
<p>举例如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> &lt;?&gt; <span class="keyword">void</span> <span class="title function_">isNull</span><span class="params">(ArrayList&lt;?&gt; list)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 替换如下：</span></span><br><span class="line"><span class="keyword">static</span> &lt;T&gt; <span class="keyword">void</span> <span class="title function_">isNull</span><span class="params">(ArrayList&lt;T&gt; list)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="6-7-与-对比"><a href="#6-7-与-对比" class="headerlink" title="6.7 &lt;? extends T&gt;与&lt;? super T&gt; 对比"></a>6.7 &lt;? extends T&gt;与&lt;? super T&gt; 对比</h2><blockquote>
<p>（1）对于&lt;? extends T&gt; 类型，编译器将只允许读操作，不允许写操作。即只可以取值，不可以设值。<br>（2）对于&lt;? super T&gt; 类型，编译器将只允许写操作，不允许读操作。即只可以设值（比如 set 操作），不可以取值（比如 get 操作）。</p>
</blockquote>
<ul>
<li>以上两点都是针对于源码里涉及到了类型参数的方法而言的。比如对于 List 而言，不允许的写操作有 add 方法，因为它的方法签名是<code>boolean add(E e);</code>，此时这个形参 E 就变成了一个涉及了通配符的类型参数；</li>
<li>而不允许的读操作有 get 方法，因为它的方法签名是 <code>E get(int index);</code>，此时这个返回值 E 就变成了一个涉及了通配符的类型参数。</li>
</ul>
<blockquote>
<p>作为方法形参，&lt;? extends T&gt; 类型和 &lt;? super T&gt; 类型的区别在于：</p>
<ol>
<li><? extends T> 允许调用读方法 `T get()` 获取 T 的引用，但不允许调用写方法 `set(T) ` 传入 T 的引用（传入 null 除外）。</li>
<li><? super T> 允许调用写方法`set(T)`传入 T 的引用，但不允许调用读方法 T `get()` 获取 T 的引用（获取 Object 除外）。</li>
</ol>
</blockquote>
<p><strong>先记住上面的结论，我们来看 Java 标准库的 Collections 类定义的 copy() 方法。</strong></p>
<blockquote>
<p>（1）copy() 方法的作用是把一个 List 中的每个元素依次添加到另一个 List 中。它的第一个形参是 List&lt;? super T&gt;，表示 <code>目标 List</code>，第二个形参是 List&lt;? extends T&gt;，表示 <code>源 List</code>。</p>
</blockquote>
<p>代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Collections</span> &#123;</span><br><span class="line">    <span class="comment">// 把 src 的每个元素复制到 dest 中:</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="keyword">void</span> <span class="title function_">copy</span><span class="params">(List&lt;? <span class="built_in">super</span> T&gt; dest, List&lt;? extends T&gt; src)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; src.size(); i++) &#123;</span><br><span class="line">        	<span class="comment">// 获取 src 集合中的元素，并赋值给变量 t，其数据类型为 T</span></span><br><span class="line">            <span class="type">T</span> <span class="variable">t</span> <span class="operator">=</span> src.get(i);</span><br><span class="line">            <span class="comment">// 将变量 t 添加进 dest 集合中 </span></span><br><span class="line">            dest.add(t);<span class="comment">// 添加元素进入 dest 集合中</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>我们可以简单地用 for 循环实现复制。在 for 循环中，我们可以看到，对于 &lt;? extends T&gt; 集合 src，我们可以安全地获取 <code>类型参数 T</code> 的引用（即变量 t），而对于 &lt;? super T&gt; 的集合 dest，我们可以安全地传入 <code>类型参数 T</code> 的引用。</li>
</ul>
<blockquote>
<p>（2）copy() 方法的定义完美地展示了通配符 extends 和 super 的意图：</p>
<ul>
<li>copy() 方法内部不会读取 dest，因为不能调用 dest.get() 方法来获取 T 的引用（如果调用则编译器会直接报错）。</li>
<li>copy() 方法内部也不会修改 src，因为不能调用 src.add(T) 方法（如果调用则编译器会直接报错）。</li>
</ul>
<p>这是由<code>编译器检查</code>来实现的。如果在方法代码中意外修改了 src 集合，或者意外读取了 dest ，就会导致一个编译错误。</p>
</blockquote>
<p>代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Collections</span> &#123;</span><br><span class="line">    <span class="comment">// 把 src 的每个元素复制到 dest 中</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="keyword">void</span> <span class="title function_">copy</span><span class="params">(List&lt;? <span class="built_in">super</span> T&gt; dest, List&lt;? extends T&gt; src)</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">// 获取 &lt;? super T&gt; 集合的元素只能赋值给 Object 对象</span></span><br><span class="line">        <span class="type">T</span> <span class="variable">t</span> <span class="operator">=</span> dest.get(<span class="number">0</span>); <span class="comment">// 编译错误</span></span><br><span class="line">        <span class="comment">// 不能向 &lt;? extends T&gt; 集合中添加任何类型的对象，除了 null</span></span><br><span class="line">        src.add(t); <span class="comment">// 编译错误</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>根据上面介绍的，获取 &lt;? super T&gt; 集合 dest 的元素后只能赋值给 Object 对象，而不能赋值给其下界类型 T；我们不能向 &lt;? extends T&gt; 集合 src 中添加任何类型的对象，除了 null。</li>
</ul>
<blockquote>
<p>（3）copy() 方法的另一个好处是可以安全地把一个 List&lt; Integer &gt;添加到 List&lt; Number &gt;，但是<code>无法反过来添加</code>。</p>
</blockquote>
<p>代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 将 List&lt;Integer&gt; 复制到 List&lt;Number&gt;</span></span><br><span class="line">List&lt;Number&gt; numList = ...;</span><br><span class="line">List&lt;Integer&gt; intList = ...;</span><br><span class="line">Collections.copy(numList, intList);<span class="comment">// 编译正确</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 不能将 List&lt;Number&gt; 复制到 List&lt;Integer&gt;</span></span><br><span class="line">Collections.copy(intList, numList);<span class="comment">// 编译错误</span></span><br></pre></td></tr></table></figure>

<ul>
<li>这个很好理解，<code>List&lt;Number&gt;</code> 集合中可能有 Integer、Float 等对象，所以肯定不能复制到 <code>List&lt;Integer&gt;</code> 集合中；而 <code>List&lt;Integer&gt;</code> 集合中只有 Integer 对象，因此肯定可以复制到 <code>List&lt;Number&gt;</code> 集合中。</li>
</ul>
<h2 id="6-8-PECS-原则"><a href="#6-8-PECS-原则" class="headerlink" title="6.8 PECS 原则"></a>6.8 PECS 原则</h2><p><strong>我们何时使用 extends，何时使用 super 通配符呢？为了便于记忆，我们可以用 PECS 原则：Producer Extends Consumer Super。</strong></p>
<p>即：如果需要<code>返回 T</code>，则它是生产者（Producer），要使用 extends 通配符；如果需要<code>写入 T</code>，则它是消费者（Consumer），要使用 super 通配符。</p>
<blockquote>
<p>还是以 Collections 的 copy() 方法为例：</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Collections</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="keyword">void</span> <span class="title function_">copy</span><span class="params">(List&lt;? <span class="built_in">super</span> T&gt; dest, List&lt;? extends T&gt; src)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; src.size(); i++) &#123;</span><br><span class="line">            <span class="type">T</span> <span class="variable">t</span> <span class="operator">=</span> src.get(i); <span class="comment">// src 是 producer</span></span><br><span class="line">            dest.add(t); <span class="comment">// dest 是 consumer</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>需要返回 T 的 src 是生产者，因此声明为<code>List&lt;? extends T&gt;</code>，需要写入 T 的 dest 是消费者，因此声明为<code>List&lt;? super T&gt;</code>。</li>
</ul>
<h1 id="7-面试题"><a href="#7-面试题" class="headerlink" title="7. 面试题"></a>7. 面试题</h1><p><strong>1、Java中的泛型是什么 ? 使用泛型的好处是什么?</strong></p>
<ul>
<li>泛型是一种参数化类型的机制。它可以使得代码适用于各种数据类型，从而编写更加通用的代码，例如集合框架。</li>
<li>泛型是一种编译时类型确认机制。它提供了代码编译期的类型安全，确保在泛型类型（通常为泛型集合）上只能使用正确类型的对象，避免了在运行时产生<code>ClassCastException</code> 异常。</li>
</ul>
<p><strong>2、Java的泛型是如何工作的 ? 什么是类型擦除 ?</strong></p>
<ul>
<li>泛型的正常工作是依赖编译器在编译源码的时候，先进行类型检查，然后进行类型擦除并且在类型参数出现的地方插入强制转换的相关指令实现的。</li>
<li><code>类型擦除</code>：编译器在编译时擦除了代码中所有与泛型相关的信息，所以在运行时不存在任何泛型信息。例如 List&lt; String &gt; 类在运行时仅用一个 List 类型来表示。而为什么要进行擦除呢？这是为了避免<code>类型膨胀</code>。</li>
</ul>
<p><strong>3、什么是泛型中的限定通配符和非限定通配符 ?</strong></p>
<ul>
<li>限定通配符对类型参数的范围进行了限制。有两种限定通配符，一种是 <code>&lt;？ extends T&gt;</code> ，它通过确保泛型类型必须是<code>T 的子类</code>来设定类型参数的上界；另一种是 <code>&lt;？super T&gt;</code>，它通过确保泛型类型必须是<code>T 的父类</code>来设定类型参数的下界。</li>
<li>泛型类型必须使用<code>限定范围内</code>的类型来进行初始化，否则会导致编译错误。另一方面 <code>&lt;?&gt;</code> 表示了非限定通配符，因为 &lt;?&gt; 可以用任意数据类型来替代。</li>
</ul>
<p><strong>4、List&lt;? extends T&gt; 和 List &lt;? super T&gt; 之间有什么区别 ?</strong></p>
<ul>
<li>这和上一题有联系，有时面试官会用这个问题来评估你对泛型的理解，而不是直接问你什么是限定通配符和非限定通配符。</li>
<li>这两个 List 的声明都是限定通配符的例子，List&lt;? extends T&gt; 可以接受任何继承自<code>T 的类型</code>的 List，而 List&lt;? super T&gt; 可以接受任何<code>T 的父类</code>构成的 List。</li>
<li>例如：<code>List&lt;? extends Number&gt;</code> 可以接受 List&lt; Integer &gt; 或 List&lt; Float &gt;；<code>List &lt;? super Number&gt;</code> 可以接受 List&lt; Object &gt; 但不能接受 List&lt; Integer &gt;。</li>
</ul>
<p><strong>5、如何编写一个泛型方法，让它能接受泛型参数并返回泛型类型?</strong></p>
<ul>
<li>编写泛型方法并不困难，你需要用泛型类型来替代原始类型，比如使用 T，E，K，V 等被广泛认可的<code>类型占位符</code>。泛型方法的例子请参阅 Java 集合类框架，最简单的情况下，一个泛型方法可能会像这样：</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestMethod</span>&lt;U&gt; &#123;</span><br><span class="line">	<span class="keyword">public</span> &lt;T, S&gt; T <span class="title function_">testMethod</span><span class="params">(T t, S s)</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>6、Java 中如何使用泛型编写带有类型参数的类?</strong></p>
<ul>
<li>这是上一道题的延伸，面试官可能会要求你用泛型编写一个类型安全的类，而不是编写一个泛型方法。关键仍然是使用泛型类型来代替<code>原始类型</code>，而且要使用 JDK 中采用的<code>类型占位符</code>。举例如下：</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Generic</span>&lt;T&gt; &#123; </span><br><span class="line">    <span class="comment">// key 这个成员变量的数据类型为 T, T 的类型由外部传入  </span></span><br><span class="line">    <span class="keyword">private</span> T key;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 泛型构造方法形参 key 的类型也为 T，T 的类型由外部传入</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Generic</span><span class="params">(T key)</span> &#123; </span><br><span class="line">        <span class="built_in">this</span>.key = key;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">	<span class="comment">// 泛型方法 getKey 的返回值类型为 T，T 的类型由外部指定</span></span><br><span class="line">    <span class="keyword">public</span> T <span class="title function_">getKey</span><span class="params">()</span>&#123; </span><br><span class="line">        <span class="keyword">return</span> key;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>7、编写一段泛型程序来实现 LRU 缓存?</strong></p>
<ul>
<li>对于喜欢 Java 编程的人来说这相当于是一次练习。提示，LinkedHashMap 可以用来实现固定大小的 LRU 缓存，当 LRU 缓存已经满了的时候，它会把最老的键值对移出缓存。LinkedHashMap 提供了一个称为 removeEldestEntry() 的方法，该方法会被 put() 和 putAll() 调用来删除最老的键值对。</li>
</ul>
<p><strong>8、你可以把 <code>List&lt;String&gt;</code> 传递给一个接受 <code>List&lt;Object&gt;</code> 参数的方法吗？</strong></p>
<ul>
<li>对任何一个不太熟悉泛型的人来说，这个Java泛型题目看起来令人疑惑，因为乍看起来 String 是 Object 的子类，所以 <code>List&lt;String&gt;</code> 应当可以<code>向上转型</code>为 <code>List&lt;Object&gt;</code> 。但是事实并非如此， <code>List&lt;String&gt;</code> 与 <code>List&lt;Object&gt;</code> 之间没有继承关系，真这样做的话会导致编译错误。</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">List&lt;Object&gt; objectList;</span><br><span class="line">List&lt;String&gt; stringList;</span><br><span class="line">      </span><br><span class="line">objectList = stringList;<span class="comment">// 编译错误</span></span><br></pre></td></tr></table></figure>

<p><strong>9、Array 中可以用泛型吗?</strong></p>
<ul>
<li>这可能是 Java 泛型面试题中最简单的一个了，当然前提是你要知道 Array 事实上并不支持泛型，这也是为什么《Effective Java》 一书中建议使用 List 来代替 Array，因为 List 可以提供编译期的<code>类型安全保证</code>，而 Array 却不能。</li>
</ul>
<p><strong>10、Java 中 List&lt; Object &gt; 和原始类型 List 之间的区别?</strong></p>
<ul>
<li>原始类型和 &lt;Object&gt; 之间的主要区别是，在编译时编译器不会对原始类型进行类型安全检查，却会对泛型类型 &lt;Object&gt; 进行检查。&lt;Object&gt; 通过使用 Object 作为类型参数，可以告知编译器可以接收任何数据类型的对象，比如 String 或 Integer。 这道题的考察点在于对泛型中<code>原始类型</code>的正确理解。</li>
<li>它们之间的第二点区别是，你可以把<code>任何泛型类型</code>传递给接收原始类型 List 的方法，但却不能把 <code>List&lt;String&gt;</code> 传递给 <code>List&lt;Object&gt;</code> 的方法，因为会产生编译错误。举例如下：</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">		<span class="comment">// 创建一个 ArrayList&lt;String&gt; 集合</span></span><br><span class="line">		List&lt;String&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>(); </span><br><span class="line">		</span><br><span class="line">		fillNumList(list);<span class="comment">// 编译正确</span></span><br><span class="line">		fillObjList(list);<span class="comment">// 编译错误</span></span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">fillList</span><span class="params">(List list)</span> &#123;</span><br><span class="line">		...</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">fillObjList</span><span class="params">(List&lt;Object&gt; list)</span> &#123;</span><br><span class="line">		...</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>11、Java 中 List&lt;?&gt; 和 <code>List&lt;Object&gt;</code> 之间的区别是什么?</strong></p>
<ul>
<li>这道题跟上一道题看起来很像，实质上却完全不同。List&lt;?&gt; 是一个不确定的未知类型的 List，而 List&lt;Object&gt; 是一个确定的 Object 类型的 List。</li>
<li><code>List&lt;?&gt;</code> 在逻辑上是所有 <code>List&lt;T&gt;</code> 的父类，你可以把 <code>List&lt;String&gt;</code>、 <code>List&lt;Integer&gt;</code> 等集合赋值给 <code>List&lt;?&gt;</code> 的引用；而 <code>List&lt;Object&gt;</code> 只代表了自己这个泛型集合类，只能把 <code>List&lt;Object&gt;</code> 赋值给 <code>List&lt;Object&gt;</code> 的引用，但是 <code>List&lt;Object&gt;</code> 集合中可以加入任意类型的数据，因为 Object 类是<code>最高父类</code>。 举例如下：</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">List&lt;?&gt; listOfAnyType;</span><br><span class="line">List&lt;Object&gt; listOfObject = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;Object&gt;();</span><br><span class="line">List&lt;String&gt; listOfString = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;String&gt;();</span><br><span class="line">List&lt;Integer&gt; listOfInteger = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;Integer&gt;();</span><br><span class="line">      </span><br><span class="line">listOfAnyType = listOfString;<span class="comment">// 编译正确</span></span><br><span class="line">listOfAnyType = listOfInteger;<span class="comment">// 编译正确</span></span><br><span class="line">listOfObjectType =  listOfString;<span class="comment">// 编译错误</span></span><br></pre></td></tr></table></figure>

<p><strong>12、Java 中 List&lt; String &gt; 和原始类型 List 之间的区别。</strong></p>
<ul>
<li>该题类似于“<code>List&lt;Object&gt;</code> 和原始类型 List 之间的区别”。泛型数据类型是<code>类型安全</code>的，而且其类型安全是由<code>编译器</code>保证的，但原始类型 List 却<code>不是类型安全</code>的。你不能把 String 之外的任何其它类型的对象存入 <code>List&lt;String&gt;</code> 中，而你可以把任何类型的对象存入原始 List 中。</li>
<li>使用泛型数据类型你不需要进行<code>类型转换</code>，但是对于原始类型，你则需要进行<code>显式的类型转换</code>。举例如下：</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">List</span> <span class="variable">listOfRawTypes</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ArrayList</span>();</span><br><span class="line">listOfRawTypes.add(<span class="string">&quot;abc&quot;</span>);</span><br><span class="line">listOfRawTypes.add(<span class="number">123</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">String</span> <span class="variable">item</span> <span class="operator">=</span> (String) listOfRawTypes.get(<span class="number">0</span>);<span class="comment">// 获取元素时需要显式的类型转换</span></span><br><span class="line"><span class="comment">// 编译器不报错，但运行时会产生 ClassCastException异常，因为 Integer不能被转换为 String</span></span><br><span class="line">item = (String) listOfRawTypes.get(<span class="number">1</span>);</span><br><span class="line">      </span><br><span class="line">List&lt;String&gt; listOfString = <span class="keyword">new</span> <span class="title class_">ArrayList</span>();</span><br><span class="line">listOfString.add(<span class="string">&quot;abcd&quot;</span>);</span><br><span class="line">listOfString.add(<span class="number">1234</span>);<span class="comment">// 编译器直接报错</span></span><br><span class="line">item = listOfString.get(<span class="number">0</span>); <span class="comment">// 不需要显式的类型转换，编译器会自动转换</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>道之伊始 —— Java函数式编程</title>
    <url>/posts/60243/</url>
    <content><![CDATA[<h1 id="0-前言"><a href="#0-前言" class="headerlink" title="0. 前言"></a>0. 前言</h1><p>今年年初 Java 推出了22版本，但是关我啥事啊？我当然还是爱用 Java 8 咯。那为什么我会如此喜爱 Java 8这个版本呢？那还得从 Java 历代的重要版本说起：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/JavaIMG/Java%E5%8E%86%E4%BB%A3%E9%87%8D%E8%A6%81%E7%89%88%E6%9C%AC.png" alt="Java历代重要版本"></p>
<p>可以看出各个版本的招牌功能：</p>
<ul>
<li><p>Java 5：泛型、枚举、注解、自动拆装箱</p>
</li>
<li><p>Java 8：<font color="red"><strong>函数式编程、Stream API。</strong></font>💪Java 8 YYDS💪</p>
</li>
<li><p>Java 11、Java 17、Java 21：仅仅是LTS（长期支持版本），好像说不出啥特色功能😂</p>
</li>
</ul>
<p>那函数式编程有什么优点呢？</p>
<p>当然是代码简洁、功能强大、并行处理、链式调用、延时执行咯。总之就俩字 —— “优雅”。</p>
<h1 id="1-道之伊始"><a href="#1-道之伊始" class="headerlink" title="1. 道之伊始"></a>1. 道之伊始</h1><center>宇宙初开之际，混沌之气笼罩着整个宇宙，一切模糊不清。</center>

<center>然后，盘古开天，女娲造人。</center>

<center>日月乃出、星辰乃现。</center>

<center>山川蜿蜒、江河奔流。</center>

<center>生灵万物，欣欣向荣。</center>

<center>此日月、星辰、山川、江河、生灵万物，</center>

<center>谓之【对象】，皆随时间而化。</center>

<center>然而：日月之行、星汉灿烂，</center>

<center>山川起伏、湖海汇聚，</center>

<center>冥冥中有至理藏其中。</center>

<center>名曰【道】，乃万物遵循之规律，亦谓之【函数】。</center>

<center>它无问东西，亘古不变。</center>

<p>作为<strong>设计宇宙洪荒</strong>的程序员</p>
<ul>
<li>造日月、筑山川、划江河、开湖海、演化生灵万物、令其生生不息，则必用面向【对象】之手段</li>
<li>若定规则、求本源、追纯粹，论不变，则当选【函数】编程之思想</li>
</ul>
<p>下面就让我们从【函数】开始。</p>
<h2 id="1-1-什么是函数"><a href="#1-1-什么是函数" class="headerlink" title="1.1 什么是函数"></a>1.1 什么是函数</h2><p>什么是函数呢？函数即规则，函数 &#x3D;&#x3D; 道</p>
<p>数学上：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/JavaIMG/%E6%95%B0%E5%AD%A6%E4%B8%8A%E7%9A%84%E5%87%BD%E6%95%B0.png" alt="数学上的函数" style="zoom: 67%;">



<p>例如：</p>
<table>
<thead>
<tr>
<th align="center">INPUT</th>
<th align="center">f(x)</th>
<th align="center">OUTPUT</th>
</tr>
</thead>
<tbody><tr>
<td align="center">1</td>
<td align="center">?</td>
<td align="center">1</td>
</tr>
<tr>
<td align="center">2</td>
<td align="center">?</td>
<td align="center">4</td>
</tr>
<tr>
<td align="center">3</td>
<td align="center">?</td>
<td align="center">9</td>
</tr>
<tr>
<td align="center">4</td>
<td align="center">?</td>
<td align="center">16</td>
</tr>
<tr>
<td align="center">5</td>
<td align="center">?</td>
<td align="center">25</td>
</tr>
<tr>
<td align="center">…</td>
<td align="center">…</td>
<td align="center">…</td>
</tr>
</tbody></table>
<ul>
<li>f(x) &#x3D; x^2 是一种规律， input 按照此规律变化为 output</li>
<li>很多规律已经由人揭示，例如 e &#x3D; m * c^2</li>
<li>程序设计中<strong>更</strong>可以自己去制定规律，一旦成为规则的制定者，你就是神</li>
</ul>
<h2 id="1-2-大道无情"><a href="#1-2-大道无情" class="headerlink" title="1.2 大道无情"></a>1.2 大道无情</h2><p>怎样才能成为一个合格的函数？上面提过函数即规则，函数 &#x3D;&#x3D; 道。那就要先思考那怎样才能成道呢？</p>
<p>成道需要一个先决条件：<strong>成到要无情</strong></p>
<h3 id="1-2-1-无情"><a href="#1-2-1-无情" class="headerlink" title="1.2.1 无情"></a>1.2.1 无情</h3><p>何为无情？只要输入相同，无论多少次调用，无论什么时间调用，输出相同。</p>
<h3 id="1-2-2-佛祖成道"><a href="#1-2-2-佛祖成道" class="headerlink" title="1.2.2 佛祖成道"></a>1.2.2 佛祖成道</h3><p>例如：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestMutable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        System.out.println(pray(<span class="string">&quot;张三&quot;</span>));</span><br><span class="line">        System.out.println(pray(<span class="string">&quot;张三&quot;</span>));</span><br><span class="line">        System.out.println(pray(<span class="string">&quot;张三&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Buddha</span> &#123;</span><br><span class="line">        String name;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">Buddha</span><span class="params">(String name)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.name = name;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="type">Buddha</span> <span class="variable">buddha</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Buddha</span>(<span class="string">&quot;佛祖&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> String <span class="title function_">pray</span><span class="params">(String person)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (person + <span class="string">&quot;向[&quot;</span> + buddha.name + <span class="string">&quot;]虔诚祈祷&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以上 pray 的执行结果，除了参数变化外，希望函数的执行规则永远不变</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">张三向[佛祖]虔诚祈祷</span><br><span class="line">张三向[佛祖]虔诚祈祷</span><br><span class="line">张三向[佛祖]虔诚祈祷</span><br></pre></td></tr></table></figure>

<p>然而，由于设计上的缺陷，函数引用了外界可变的数据，如果这么使用：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">buddha.name = <span class="string">&quot;魔王&quot;</span>;</span><br><span class="line">System.out.println(pray(<span class="string">&quot;张三&quot;</span>));</span><br></pre></td></tr></table></figure>

<p>结果就会是：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">张三向[魔王]虔诚祈祷</span><br></pre></td></tr></table></figure>

<p>问题出在哪儿呢？函数的目的是除了参数能变化，其它部分都要不变，这样才能成为规则的一部分。佛祖要成为规则的一部分，也要保持不变。</p>
<p>改正方法：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Buddha</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Buddha</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//或（JDK 16以上版本）</span></span><br><span class="line"><span class="keyword">record</span> <span class="title class_">Buddha</span><span class="params">(String name)</span> &#123; &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>不是说函数不能引用外界的数据，而是它引用的数据必须也能作为规则的一部分</li>
<li>让佛祖不变，佛祖才能成为规则</li>
</ul>
<h3 id="1-2-3-函数与方法"><a href="#1-2-3-函数与方法" class="headerlink" title="1.2.3 函数与方法"></a>1.2.3 函数与方法</h3><p>方法本质上也是函数。不过方法绑定在对象之上，它是对象个人法则。</p>
<ul>
<li><p>函数是：函数（对象数据，其它参数）</p>
</li>
<li><p>方法是：对象数据.方法（其它参数）</p>
</li>
</ul>
<h3 id="1-2-4-不变的好处"><a href="#1-2-4-不变的好处" class="headerlink" title="1.2.4 不变的好处"></a>1.2.4 不变的好处</h3><p>只有不变，才能在滚滚时间洪流中屹立不倒，成为规则的一部分。</p>
<p>多线程编程中，不变意味着线程安全。</p>
<h3 id="1-2-5-合格的函数无状态"><a href="#1-2-5-合格的函数无状态" class="headerlink" title="1.2.5 合格的函数无状态"></a>1.2.5 合格的函数无状态</h3><h2 id="1-3-大道无形"><a href="#1-3-大道无形" class="headerlink" title="1.3 大道无形"></a>1.3 大道无形</h2><h3 id="1-3-1-函数化对象"><a href="#1-3-1-函数化对象" class="headerlink" title="1.3.1 函数化对象"></a>1.3.1 函数化对象</h3><p>函数本无形，也就是它代表的规则：位置固定、不能传播。</p>
<p>若要有形，让函数的规则能够传播，需要将函数化为对象。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyClass</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">add</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> a + b;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<p>与</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">Lambda</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="title function_">calculate</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">Lambda</span> <span class="variable">add</span> <span class="operator">=</span> (a, b) -&gt; a + b; <span class="comment">// 它已经变成了一个 Lambda 对象</span></span><br></pre></td></tr></table></figure>

<p>区别在哪？</p>
<ul>
<li>前者是纯粹的一条两数加法规则，它的位置是固定的，要使用它，需要通过 MyClass.add 找到它，然后执行</li>
<li>而后者（add 对象）就像长了腿，它的位置是可以变化的，想去哪里就去哪里，哪里要用到这条加法规则，把它传递过去<font color="red"><strong>（对象可以传到任意地方去，函数不行）</strong></font></li>
<li>接口的目的是为了将来用它来执行函数对象，此接口中只能有一个方法定义</li>
</ul>
<p>函数化为对象做个比喻：</p>
<ul>
<li>之前是大家要统一去西天取经</li>
<li>现在是每个菩萨、罗汉拿着经书，入世传经</li>
</ul>
<p>例如：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">interface</span> <span class="title class_">Lambda</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="title function_">calculate</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Server</span> &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">            <span class="type">ServerSocket</span> <span class="variable">ss</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerSocket</span>(<span class="number">8080</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;server start...&quot;</span>);</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                <span class="type">Socket</span> <span class="variable">s</span> <span class="operator">=</span> ss.accept();</span><br><span class="line">                Thread.ofVirtual().start(() -&gt; &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="type">ObjectInputStream</span> <span class="variable">is</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(s.getInputStream());</span><br><span class="line">                        <span class="type">Lambda</span> <span class="variable">lambda</span> <span class="operator">=</span> (Lambda) is.readObject();</span><br><span class="line">                        <span class="type">int</span> <span class="variable">a</span> <span class="operator">=</span> ThreadLocalRandom.current().nextInt(<span class="number">10</span>);</span><br><span class="line">                        <span class="type">int</span> <span class="variable">b</span> <span class="operator">=</span> ThreadLocalRandom.current().nextInt(<span class="number">10</span>);</span><br><span class="line">                        System.out.printf(<span class="string">&quot;%s %d op %d = %d%n&quot;</span>,</span><br><span class="line">                   s.getRemoteSocketAddress().toString(), a, b, lambda.calculate(a, b));</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (IOException | ClassNotFoundException e) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Client1</span> &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">            <span class="keyword">try</span>(<span class="type">Socket</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Socket</span>(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">8080</span>))&#123;</span><br><span class="line">                <span class="type">Lambda</span> <span class="variable">lambda</span> <span class="operator">=</span> (Lambda &amp; Serializable) (a, b) -&gt; a + b;</span><br><span class="line">                <span class="type">ObjectOutputStream</span> <span class="variable">os</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(s.getOutputStream());</span><br><span class="line">                os.writeObject(lambda);</span><br><span class="line">                os.flush();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Client2</span> &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">            <span class="keyword">try</span>(<span class="type">Socket</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Socket</span>(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">8080</span>))&#123;</span><br><span class="line">                <span class="type">Lambda</span> <span class="variable">lambda</span> <span class="operator">=</span> (Lambda &amp; Serializable) (a, b) -&gt; a - b;</span><br><span class="line">                <span class="type">ObjectOutputStream</span> <span class="variable">os</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(s.getOutputStream());</span><br><span class="line">                os.writeObject(lambda);</span><br><span class="line">                os.flush();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Client3</span> &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">            <span class="keyword">try</span>(<span class="type">Socket</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Socket</span>(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">8080</span>))&#123;</span><br><span class="line">                <span class="type">Lambda</span> <span class="variable">lambda</span> <span class="operator">=</span> (Lambda &amp; Serializable) (a, b) -&gt; a * b;</span><br><span class="line">                <span class="type">ObjectOutputStream</span> <span class="variable">os</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(s.getOutputStream());</span><br><span class="line">                os.writeObject(lambda);</span><br><span class="line">                os.flush();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面的例子做了一些简单的扩展，可以看到不同的客户端可以上传自己的计算规则。</p>
<p><strong>PS：</strong></p>
<ul>
<li>大部分文献都说 Lambda 是匿名函数，但<strong>满老师</strong>觉得需要在这个说法上进行补充</li>
<li>至少在 java 里，虽然 Lambda 表达式本身不需要起名字，但不得提供一个对应接口嘛</li>
</ul>
<h3 id="1-3-2-行为参数化"><a href="#1-3-2-行为参数化" class="headerlink" title="1.3.2 行为参数化"></a>1.3.2 行为参数化</h3><p>已知学生类定义如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Student</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line">    <span class="keyword">private</span> String sex;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Student</span><span class="params">(String name, <span class="type">int</span> age, String sex)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">        <span class="built_in">this</span>.sex = sex;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getAge</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getSex</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> sex;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Student&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;name=&#x27;&quot;</span> + name + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, age=&quot;</span> + age +</span><br><span class="line">                <span class="string">&quot;, sex=&#x27;&quot;</span> + sex + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>针对一组学生集合，筛选出男学生，下面的代码实现如何，评价一下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    List&lt;Student&gt; students = List.of(</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Student</span>(<span class="string">&quot;张无忌&quot;</span>, <span class="number">18</span>, <span class="string">&quot;男&quot;</span>),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Student</span>(<span class="string">&quot;杨不悔&quot;</span>, <span class="number">16</span>, <span class="string">&quot;女&quot;</span>),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Student</span>(<span class="string">&quot;周芷若&quot;</span>, <span class="number">19</span>, <span class="string">&quot;女&quot;</span>),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Student</span>(<span class="string">&quot;宋青书&quot;</span>, <span class="number">20</span>, <span class="string">&quot;男&quot;</span>)</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    System.out.println(filter(students)); <span class="comment">// 能得到 张无忌，宋青书</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> List&lt;Student&gt; <span class="title function_">filter</span><span class="params">(List&lt;Student&gt; students)</span> &#123;</span><br><span class="line">    List&lt;Student&gt; result = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (Student student : students) &#123;</span><br><span class="line">        <span class="keyword">if</span> (student.sex.equals(<span class="string">&quot;男&quot;</span>)) &#123;</span><br><span class="line">            result.add(student);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果需求再变动一下，要求找到 18 岁以下的学生，上面代码显然不能用了，改动方法如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> List&lt;Student&gt; <span class="title function_">filter</span><span class="params">(List&lt;Student&gt; students)</span> &#123;</span><br><span class="line">    List&lt;Student&gt; result = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (Student student : students) &#123;</span><br><span class="line">        <span class="keyword">if</span> (student.age &lt;= <span class="number">18</span>) &#123;</span><br><span class="line">            result.add(student);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">System.out.println(filter(students)); <span class="comment">// 能得到 张无忌，杨不悔</span></span><br></pre></td></tr></table></figure>

<p>那么需求如果再要变动，找18岁以下男学生，怎么改？显然上述做法并不太好… 更希望一个方法能处理各种情况，仔细观察以上两个方法，找不同。</p>
<p>不同在于筛选条件部分：<code>student.sex.equals(&quot;男&quot;)</code> 和 <code>student.age &lt;= 18</code></p>
<p>既然它们就是不同，那么能否把它作为参数传递进来，这样处理起来不就一致了吗？</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> List&lt;Student&gt; <span class="title function_">filter</span><span class="params">(List&lt;Student&gt; students, ???)</span> &#123;</span><br><span class="line">    List&lt;Student&gt; result = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (Student student : students) &#123;</span><br><span class="line">        <span class="keyword">if</span> (???) &#123;</span><br><span class="line">            result.add(student);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>它俩要判断的逻辑不同，那这两处不同的逻辑必然要用函数来表示，将来这两个函数都需要用到 student 对象来判断，都应该返回一个 boolean 结果，怎么描述函数的长相呢？</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">Lambda</span> &#123;</span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">test</span><span class="params">(Student student)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>方法可以统一成下述代码：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> List&lt;Student&gt; <span class="title function_">filter</span><span class="params">(List&lt;Student&gt; students, Lambda lambda)</span> &#123;</span><br><span class="line">    List&lt;Student&gt; result = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (Student student : students) &#123;</span><br><span class="line">        <span class="keyword">if</span> (lambda.test(student)) &#123;</span><br><span class="line">            result.add(student);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>好，最后怎么给它传递不同实现呢？</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">filter(students, student -&gt; student.sex.equals(<span class="string">&quot;男&quot;</span>));</span><br></pre></td></tr></table></figure>

<p>以及</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">filter(students, student -&gt; student.age &lt;= <span class="number">18</span>);</span><br></pre></td></tr></table></figure>

<p>还有新需求也能满足</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">filter(students, student -&gt; student.sex.equals(<span class="string">&quot;男&quot;</span>) &amp;&amp; student.age &lt;= <span class="number">18</span>);</span><br></pre></td></tr></table></figure>

<p>这样就实现了以不变应万变，而变换即是一个个函数对象，也可以称之为行为参数化</p>
<h3 id="1-3-3-延迟执行"><a href="#1-3-3-延迟执行" class="headerlink" title="1.3.3 延迟执行"></a>1.3.3 延迟执行</h3><p>在记录日志时，假设日志级别是 INFO，debug 方法会遇到下面的问题：</p>
<p>本不需要记录日志，但 expensive 方法仍被执行了。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LogManager.getLogger();</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    System.out.println(logger.getLevel());</span><br><span class="line">    logger.debug(<span class="string">&quot;&#123;&#125;&quot;</span>, expensive());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> String <span class="title function_">expensive</span><span class="params">()</span> &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;执行耗时操作&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;结果&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>改进方法1：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">    logger.debug(<span class="string">&quot;&#123;&#125;&quot;</span>, expensive());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>显然这么做，很多类似代码都要加上这样 if 判断，很不优雅。</p>
<p>改进方法2：</p>
<p>在 debug 方法外再套一个新方法，内部逻辑大概是这样：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">debug</span><span class="params">(<span class="keyword">final</span> String msg, <span class="keyword">final</span> Supplier&lt;?&gt; lambda)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.isDebugEnabled()) &#123;</span><br><span class="line">        <span class="built_in">this</span>.debug(msg, lambda.get());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用时这样：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">logger.debug(<span class="string">&quot;&#123;&#125;&quot;</span>, () -&gt; expensive());</span><br></pre></td></tr></table></figure>

<p>expensive() 变成了不是立刻执行，在未来 if 条件成立时才执行。</p>
<h3 id="1-3-4-函数对象的不同类型"><a href="#1-3-4-函数对象的不同类型" class="headerlink" title="1.3.4 函数对象的不同类型"></a>1.3.4 函数对象的不同类型</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Comparator&lt;Student&gt; c = </span><br><span class="line">    			(Student s1, Student s2) -&gt; Integer.compare(s1.age, s2.age);</span><br><span class="line"></span><br><span class="line">BiFunction&lt;Student, Student, Integer&gt; f = </span><br><span class="line">                (Student s1, Student s2) -&gt; Integer.compare(s1.age, s2.age);</span><br></pre></td></tr></table></figure>

<h1 id="2-函数编程语法"><a href="#2-函数编程语法" class="headerlink" title="2. 函数编程语法"></a>2. 函数编程语法</h1><h2 id="2-1-表现形式"><a href="#2-1-表现形式" class="headerlink" title="2.1 表现形式"></a>2.1 表现形式</h2><p>在 Java 语言中，Lambda 对象有两种形式：<code>Lambda表达式</code> 与 <code>方法引用</code></p>
<ul>
<li><code>Lambda表达式</code>：功能更全面</li>
<li><code>方法引用</code>：写法更简介</li>
</ul>
<p>Lambda 对象的类型是由它的行为决定的，如果有一些 Lambda 对象，它们的入参类型、返回值类型都一致，那么它们可以看作是同一类的 Lambda 对象，它们的类型，用 <code>函数式接口</code> 来表示。</p>
<h3 id="2-1-1-匿名内部类"><a href="#2-1-1-匿名内部类" class="headerlink" title="2.1.1 匿名内部类"></a>2.1.1 匿名内部类</h3><p>匿名内部类 ：是内部类的简化写法。他是一个隐含了名字的内部类。开发中，最常用到的内部类就是匿名内部类了。</p>
<p>匿名内部类必须<strong>继承一个父类</strong>或者<strong>实现一个父接口</strong>。格式：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">new</span> 父类名或者接口名() &#123;</span><br><span class="line">     重写方法;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>包含了：</p>
<ul>
<li><p>继承或者实现关系</p>
</li>
<li><p>方法重写</p>
</li>
<li><p>创建对象</p>
</li>
</ul>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/JavaIMG/%E5%8C%BF%E5%90%8D%E5%86%85%E9%83%A8%E7%B1%BB.png" alt="匿名内部类">

<p>所以从语法上来讲，这个整体其实是<strong>匿名内部类的对象</strong>。</p>
<p>什么时候用到匿名内部类 ？</p>
<ul>
<li><p>如果希望定义一个只要使用一次的类，就可考虑使用匿名内部类。匿名内部类的本质作用是为了简化代码</p>
</li>
<li><p>通常在方法的形式参数是接口或者抽象类时，也可以将匿名内部类作为参数传递</p>
</li>
</ul>
<p>匿名内部类的特点：</p>
<ul>
<li>定义一个没有名字的内部类</li>
<li>这个类实现了父类，或者父类接口</li>
<li>匿名内部类会创建这个没有名字的类的对象</li>
</ul>
<h3 id="2-1-2-Lambda表达式"><a href="#2-1-2-Lambda表达式" class="headerlink" title="2.1.2 Lambda表达式"></a>2.1.2 Lambda表达式</h3><p>语法：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">参数部分(方法的形参) -&gt; 执行逻辑(方法的方法体)</span><br></pre></td></tr></table></figure>

<ul>
<li><code>-&gt;</code>：固定格式</li>
</ul>
<p>注意点：</p>
<ul>
<li>Lambda表达式可以用来简化<strong>匿名内部类</strong>的书写</li>
<li>Lambda表达式<strong>只能简化函数式接口的匿名内部类方法</strong></li>
<li>函数式接口：有且仅有一个抽象方法的接口叫函数式接口，接口方法上可以加上 <code>@FunctionalInterface</code> 注解<ul>
<li><code>@FunctionalInterface</code> 作用：在编译期间检查函数式接口是否<strong>有且仅有一个</strong>抽象方法，如果不满足会提示错误</li>
</ul>
</li>
</ul>
<p>Lambda的省略规则：</p>
<ul>
<li>参数类型可以省略不写</li>
<li>如果只有一个参数，参数类型可以省略，同时()也可以省略</li>
<li>如果Lambda表达式的方法体只有一行，大括号、分号、return可以省略不写<font color="red">（需要同时省略）</font></li>
</ul>
<p>例：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LambdaDemo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line"></span><br><span class="line">        Integer[] arr = &#123;<span class="number">2</span>, <span class="number">3</span>, <span class="number">6</span>, <span class="number">4</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">5</span>, <span class="number">9</span>&#125;;</span><br><span class="line"></span><br><span class="line">        Arrays.sort(arr, <span class="keyword">new</span> <span class="title class_">Comparator</span>&lt;Integer&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">compare</span><span class="params">(Integer o1, Integer o2)</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> o1 - o2;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Lambda完整格式</span></span><br><span class="line">        Arrays.sort(arr, (Integer o1, Integer o2) -&gt; &#123;</span><br><span class="line">                    <span class="keyword">return</span> o1 - o2;</span><br><span class="line">                &#125;</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Lambda省略写法</span></span><br><span class="line">        Arrays.sort(arr, (o1, o2) -&gt; o1 - o2);</span><br><span class="line"></span><br><span class="line">        System.out.println(Arrays.toString(arr));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-1-3-方法引用"><a href="#2-1-3-方法引用" class="headerlink" title="2.1.3 方法引用"></a>2.1.3 方法引用</h3><p>方法引用的条件：</p>
<ul>
<li>引用处需要是函数式接口</li>
<li>被引用的方法需要已经存在</li>
<li>被引用方法的形参和返回值需要跟抽象方法的形参和返回值保持一致</li>
<li>被引用方法的功能需要满足当前的要求</li>
</ul>
<p>方法引用的分类：</p>
<ul>
<li>引用静态方法</li>
<li>引用成员方法<ul>
<li>引用其他类的成员方法</li>
<li>引用本类的成员方法</li>
<li>引用父类的成员方法</li>
</ul>
</li>
<li>引用构造方法</li>
<li>其他调用方式<ul>
<li>使用类名引用成员方法</li>
<li>引用数组的构造方法</li>
</ul>
</li>
</ul>
<h2 id="2-2-函数类型"><a href="#2-2-函数类型" class="headerlink" title="2.2 函数类型"></a>2.2 函数类型</h2><p>入参类型、返回值类型都一致的话，可以看作同一类的对象。</p>
<p>常见函数接口：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/JavaIMG/%E5%B8%B8%E8%A7%81%E5%87%BD%E6%95%B0%E6%8E%A5%E5%8F%A3.png" alt="常见函数接口" style="zoom: 50%;">

<p>函数接口的命名规律：</p>
<table>
<thead>
<tr>
<th align="center">名称</th>
<th align="center">含义</th>
</tr>
</thead>
<tbody><tr>
<td align="center">Consumer</td>
<td align="center">有参、无返回值</td>
</tr>
<tr>
<td align="center">Function</td>
<td align="center">有参、有返回值</td>
</tr>
<tr>
<td align="center">Predicate</td>
<td align="center">有参、返回boolean</td>
</tr>
<tr>
<td align="center">Supplier</td>
<td align="center">无参、有返回值</td>
</tr>
<tr>
<td align="center">Operator</td>
<td align="center">有参、有返回值，并且类型一样</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th align="center">前缀</th>
<th align="center">含义</th>
</tr>
</thead>
<tbody><tr>
<td align="center">Unary</td>
<td align="center">一元的意思，表示一个参数</td>
</tr>
<tr>
<td align="center">Bi 或 Binary</td>
<td align="center">二元的意思，表示两个参数</td>
</tr>
<tr>
<td align="center">Ternary</td>
<td align="center">三元</td>
</tr>
<tr>
<td align="center">Quatenary</td>
<td align="center">四元</td>
</tr>
<tr>
<td align="center">…</td>
<td align="center">…</td>
</tr>
</tbody></table>
<p>方法引用也是类似，入参类型、返回值类型都一致的话，可以看作同一类的对象，也是用函数式接口表示。</p>
<h2 id="2-3-几种方法引用"><a href="#2-3-几种方法引用" class="headerlink" title="2.3 几种方法引用"></a>2.3 几种方法引用</h2><h3 id="2-3-1-类名-静态方法名"><a href="#2-3-1-类名-静态方法名" class="headerlink" title="2.3.1 类名::静态方法名"></a>2.3.1 <code>类名::静态方法名</code></h3><p>如何理解：</p>
<ul>
<li>函数对象的逻辑部分是：调用此静态方法</li>
<li>因此这个静态方法需要什么参数，函数对象也提供相应的参数即可</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Type2Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">            需求：挑选出所有男性学生</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        Stream.of(</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Student</span>(<span class="string">&quot;张无忌&quot;</span>, <span class="string">&quot;男&quot;</span>),</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Student</span>(<span class="string">&quot;周芷若&quot;</span>, <span class="string">&quot;女&quot;</span>),</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Student</span>(<span class="string">&quot;宋青书&quot;</span>, <span class="string">&quot;男&quot;</span>)</span><br><span class="line">                )</span><br><span class="line">                .filter(Type2Test::isMale)</span><br><span class="line">                .forEach(student -&gt; System.out.println(student));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isMale</span><span class="params">(Student student)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> student.sex.equals(<span class="string">&quot;男&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">record</span> <span class="title class_">Student</span><span class="params">(String name, String sex)</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>filter</code> 这个高阶函数接收的函数类型（Predicate）是：一个 <code>T</code> 类型的入参，一个 <code>boolean</code> 的返回值，因此我们只需要给它提供一个相符合的 Lambda 对象即可</li>
<li>isMale 这个静态方法有入参 Student 对应 <code>T</code>，有返回值 <code>boolean</code> 也能对应上，所以可以直接使用</li>
</ul>
<p>输出：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Student[name=张无忌, sex=男]</span><br><span class="line">Student[name=宋青书, sex=男]</span><br></pre></td></tr></table></figure>

<h3 id="2-3-2-类名-非静态方法名"><a href="#2-3-2-类名-非静态方法名" class="headerlink" title="2.3.2 类名::非静态方法名"></a>2.3.2 <code>类名::非静态方法名</code></h3><p>如何理解：</p>
<ul>
<li>函数对象的逻辑部分是：调用此非静态方法</li>
<li>因此这个函数对象需要提供一个额外的对象参数，以便能够调用此非静态方法</li>
<li>非静态方法的剩余参数，与函数对象的剩余参数一一对应</li>
</ul>
<p>例1：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Type3Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        highOrder(Student::hello);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">highOrder</span><span class="params">(Type3 lambda)</span> &#123;</span><br><span class="line">        System.out.println(lambda.transfer(<span class="keyword">new</span> <span class="title class_">Student</span>(<span class="string">&quot;张三&quot;</span>), <span class="string">&quot;你好&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">interface</span> <span class="title class_">Type3</span> &#123;</span><br><span class="line">        String <span class="title function_">transfer</span><span class="params">(Student stu, String message)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Student</span> &#123;</span><br><span class="line">        String name;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">Student</span><span class="params">(String name)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.name = name;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">(String message)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.name + <span class="string">&quot; say: &quot;</span> + message;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上例中函数类型的</p>
<ul>
<li>参数1 对应着 hello 方法所属类型 Student</li>
<li>参数2 对应着 hello 方法自己的参数 String</li>
<li>返回值对应着 hello 方法自己的返回值 String</li>
</ul>
<p>输出：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">张三 say: 你好</span><br></pre></td></tr></table></figure>

<p>例2：改写之前根据性别过滤的需求</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Type2Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">            需求：挑选出所有男性学生</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        Stream.of(</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Student</span>(<span class="string">&quot;张无忌&quot;</span>, <span class="string">&quot;男&quot;</span>),</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Student</span>(<span class="string">&quot;周芷若&quot;</span>, <span class="string">&quot;女&quot;</span>),</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Student</span>(<span class="string">&quot;宋青书&quot;</span>, <span class="string">&quot;男&quot;</span>)</span><br><span class="line">                )</span><br><span class="line">                .filter(Student::isMale)</span><br><span class="line">                .forEach(student -&gt; System.out.println(student));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">record</span> <span class="title class_">Student</span><span class="params">(String name, String sex)</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="title function_">isMale</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.sex.equals(<span class="string">&quot;男&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>filter</code> 这个高阶函数接收的函数类型（Predicate）是：一个 <code>T</code> 类型的入参，一个 <code>boolean</code> 的返回值，因此我们只需要给它提供一个相符合的 Lambda 对象即可</li>
<li>它的入参1 <code>T</code> 对应着 isMale 非静态方法的所属类型 Student</li>
<li>它没有其它参数，isMale 方法也没有参数</li>
<li>返回值都是 boolean</li>
</ul>
<p>输出：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Student[name=张无忌, sex=男]</span><br><span class="line">Student[name=宋青书, sex=男]</span><br></pre></td></tr></table></figure>

<p>例3：将学生对象仅保留学生的姓名</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Type2Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        Stream.of(</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Student</span>(<span class="string">&quot;张无忌&quot;</span>, <span class="string">&quot;男&quot;</span>),</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Student</span>(<span class="string">&quot;周芷若&quot;</span>, <span class="string">&quot;女&quot;</span>),</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Student</span>(<span class="string">&quot;宋青书&quot;</span>, <span class="string">&quot;男&quot;</span>)</span><br><span class="line">                )</span><br><span class="line">                .map(Student::name)</span><br><span class="line">                .forEach(student -&gt; System.out.println(student));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">record</span> <span class="title class_">Student</span><span class="params">(String name, String sex)</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="title function_">isMale</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.sex.equals(<span class="string">&quot;男&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>map 这个高阶函数接收的函数类型是（Function）是：一个 <code>T</code> 类型的参数，一个 <code>R</code> 类型的返回值</li>
<li>它的入参1 <code>T</code> 对应着 name 非静态方法的所属类型 Student</li>
<li>它没有剩余参数，name 方法也没有参数</li>
<li>它的返回值 R 对应着 name 方法的返回值 String</li>
</ul>
<p>输出：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">张无忌</span><br><span class="line">周芷若</span><br><span class="line">宋青书</span><br></pre></td></tr></table></figure>

<h3 id="2-3-3-对象-非静态方法名"><a href="#2-3-3-对象-非静态方法名" class="headerlink" title="2.3.3 对象::非静态方法名"></a>2.3.3 <code>对象::非静态方法名</code></h3><p>如何理解：</p>
<ul>
<li>函数对象的逻辑部分是：调用此非静态方法</li>
<li>因为对象已提供，所以不必作为函数对象参数的一部分</li>
<li>非静态方法的剩余参数，与函数对象的剩余参数一一对应</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Type4Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Util</span> <span class="variable">util</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Util</span>(); <span class="comment">// 对象</span></span><br><span class="line">        Stream.of(</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Student</span>(<span class="string">&quot;张无忌&quot;</span>, <span class="string">&quot;男&quot;</span>),</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Student</span>(<span class="string">&quot;周芷若&quot;</span>, <span class="string">&quot;女&quot;</span>),</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Student</span>(<span class="string">&quot;宋青书&quot;</span>, <span class="string">&quot;男&quot;</span>)</span><br><span class="line">                )</span><br><span class="line">                .filter(util::isMale)</span><br><span class="line">                .map(util::getName)</span><br><span class="line">                .forEach(student -&gt; System.out.println(student));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">record</span> <span class="title class_">Student</span><span class="params">(String name, String sex)</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="title function_">isMale</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.sex.equals(<span class="string">&quot;男&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Util</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="title function_">isMale</span><span class="params">(Student student)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> student.sex.equals(<span class="string">&quot;男&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        String <span class="title function_">getName</span><span class="params">(Student student)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> student.name();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其实较为典型的一个应用就是 <code>System.out</code> 对象中的非静态方法，最后的输出可以修改为：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">.forEach(System.out::println);</span><br></pre></td></tr></table></figure>

<p>这是因为：</p>
<ul>
<li>forEach  这个高阶函数接收的函数类型（Consumer）是一个 <code>T</code> 类型参数，<code>void</code> 无返回值</li>
<li>而 System.out 对象中有非静态方法 void println(Object x) 与之一致，因此可以将此方法化为 Lambda 对象给 forEach 使用</li>
</ul>
<h3 id="2-3-4-类名-new"><a href="#2-3-4-类名-new" class="headerlink" title="2.3.4 类名::new"></a>2.3.4 <code>类名::new</code></h3><p>对于构造方法，也有专门的语法把它们转换为 Lambda 对象。</p>
<p>函数类型应满足：</p>
<ul>
<li>参数部分与构造方法参数一致</li>
<li>返回值类型与构造方法所在类一致</li>
</ul>
<p>例如：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Type5Test</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Student</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> String name;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> age;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">Student</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.name = <span class="string">&quot;某人&quot;</span>;</span><br><span class="line">            <span class="built_in">this</span>.age = <span class="number">18</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">Student</span><span class="params">(String name)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.name = name;</span><br><span class="line">            <span class="built_in">this</span>.age = <span class="number">18</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">Student</span><span class="params">(String name, <span class="type">int</span> age)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.name = name;</span><br><span class="line">            <span class="built_in">this</span>.age = age;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Student&#123;&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;name=&#x27;&quot;</span> + name + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                    <span class="string">&quot;, age=&quot;</span> + age +</span><br><span class="line">                    <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">interface</span> <span class="title class_">Type51</span> &#123;</span><br><span class="line">        Student <span class="title function_">create</span><span class="params">()</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">interface</span> <span class="title class_">Type52</span> &#123;</span><br><span class="line">        Student <span class="title function_">create</span><span class="params">(String name)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">interface</span> <span class="title class_">Type53</span> &#123;</span><br><span class="line">        Student <span class="title function_">create</span><span class="params">(String name, <span class="type">int</span> age)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        hiOrder((Type51) Student::<span class="keyword">new</span>);</span><br><span class="line">        hiOrder((Type52) Student::<span class="keyword">new</span>);</span><br><span class="line">        hiOrder((Type53) Student::<span class="keyword">new</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">hiOrder</span><span class="params">(Type51 creator)</span> &#123;</span><br><span class="line">        System.out.println(creator.create());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">hiOrder</span><span class="params">(Type52 creator)</span> &#123;</span><br><span class="line">        System.out.println(creator.create(<span class="string">&quot;张三&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">hiOrder</span><span class="params">(Type53 creator)</span> &#123;</span><br><span class="line">        System.out.println(creator.create(<span class="string">&quot;李四&quot;</span>, <span class="number">20</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-3-5-this-非静态方法名"><a href="#2-3-5-this-非静态方法名" class="headerlink" title="2.3.5 this::非静态方法名"></a>2.3.5 <code>this::非静态方法名</code></h3><p>算是 <code>类名::非静态方法名</code> 形式的特例，只能用在类内部：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Type6Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Util</span> <span class="variable">util</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UtilExt</span>();</span><br><span class="line">        util.hiOrder(Stream.of(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Student</span>(<span class="string">&quot;张无忌&quot;</span>, <span class="string">&quot;男&quot;</span>),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Student</span>(<span class="string">&quot;周芷若&quot;</span>, <span class="string">&quot;女&quot;</span>),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Student</span>(<span class="string">&quot;宋青书&quot;</span>, <span class="string">&quot;男&quot;</span>)</span><br><span class="line">        ));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">record</span> <span class="title class_">Student</span><span class="params">(String name, String sex)</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Util</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="title function_">isMale</span><span class="params">(Student student)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> student.sex.equals(<span class="string">&quot;男&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">boolean</span> <span class="title function_">isFemale</span><span class="params">(Student student)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> student.sex.equals(<span class="string">&quot;女&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">void</span> <span class="title function_">hiOrder</span><span class="params">(Stream&lt;Student&gt; stream)</span> &#123;</span><br><span class="line">            stream</span><br><span class="line">                    .filter(<span class="built_in">this</span>::isMale)</span><br><span class="line">                    .forEach(System.out::println);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-3-6-super-非静态方法名"><a href="#2-3-6-super-非静态方法名" class="headerlink" title="2.3.6 super::非静态方法名"></a>2.3.6 super::非静态方法名</h3><p>算是 <code>类名::非静态方法名</code> 形式的特例，只能用在类内部（用在要用 super 区分重载方法时）：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Type6Test</span> &#123;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">UtilExt</span> <span class="keyword">extends</span> <span class="title class_">Util</span> &#123;</span><br><span class="line">        <span class="keyword">void</span> <span class="title function_">hiOrder</span><span class="params">(Stream&lt;Student&gt; stream)</span> &#123;</span><br><span class="line">            stream</span><br><span class="line">                    .filter(<span class="built_in">super</span>::isFemale)</span><br><span class="line">                    .forEach(System.out::println);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-3-7-特例"><a href="#2-3-7-特例" class="headerlink" title="2.3.7 特例"></a>2.3.7 特例</h3><p>对于无返回值的函数接口，例如 <code>Consumer</code> 和 <code>Runnable</code>，它们可以配合有返回值的函数对象使用（函数接口和方法引用之间，可以差一个返回值），例如：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ExceptionTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Runnable</span> <span class="variable">task1</span> <span class="operator">=</span> ExceptionTest::print1;</span><br><span class="line">        <span class="type">Runnable</span> <span class="variable">task2</span> <span class="operator">=</span> ExceptionTest::print2;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">print1</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;task1 running...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">print2</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;task2 running...&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到 <code>Runnable</code> 接口不需要返回值，而实际的函数对象多出的返回值也不影响使用。</p>
<h2 id="2-4-闭包（Closure）"><a href="#2-4-闭包（Closure）" class="headerlink" title="2.4 闭包（Closure）"></a>2.4 闭包（Closure）</h2><p>何为闭包？闭包就是<strong>函数对象</strong>与<strong>外界变量</strong>绑定在一起，形成的整体。例如：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ClosureTest1</span> &#123;</span><br><span class="line">    <span class="keyword">interface</span> <span class="title class_">Lambda</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="title function_">add</span><span class="params">(<span class="type">int</span> y)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">x</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line">        highOrder(y -&gt; x + y);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">highOrder</span><span class="params">(Lambda lambda)</span> &#123;</span><br><span class="line">        System.out.println(lambda.add(<span class="number">20</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>代码中的 $y \rightarrow x + y$ 和 $x &#x3D; 10$，就形成了一个闭包</li>
<li>可以想象成，函数对象有个背包，背包里可以装变量随身携带，将来函数对象甭管传递到多远的地方，包里总装着个 $x &#x3D; 10$</li>
<li>有个限制，局部变量 x 必须是 <code>final</code> 或 <code>effective final</code> 的，effective final 意思就是，虽然没有用 final 修饰，但就像是用 final 修饰了一样，不能重新赋值，否则就语法错误。<ul>
<li>意味着闭包变量，在装进包里的那一刻，就不能变化了</li>
<li>道理也简单，为了保证函数的不变性，防止破坏成道</li>
</ul>
</li>
<li>闭包是一种给函数执行提供数据的手段，函数执行既可以使用函数入参，还可以使用闭包变量</li>
</ul>
<p>例：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ClosureTest2</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 闭包作用：给函数对象提供参数以外的数据</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// 创建 10 个任务对象，并且每个任务对象给一个任务编号</span></span><br><span class="line">        List&lt;Runnable&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">k</span> <span class="operator">=</span> i + <span class="number">1</span>;</span><br><span class="line">            <span class="type">Runnable</span> <span class="variable">task</span> </span><br><span class="line">                <span class="operator">=</span> () -&gt; System.out.println(Thread.currentThread()+<span class="string">&quot;:执行任务&quot;</span> + k);</span><br><span class="line">            list.add(task);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">ExecutorService</span> <span class="variable">service</span> <span class="operator">=</span> Executors.newVirtualThreadPerTaskExecutor();</span><br><span class="line">        <span class="keyword">for</span> (Runnable task : list) &#123;</span><br><span class="line">            service.submit(task);</span><br><span class="line">        &#125;</span><br><span class="line">        System.in.read();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-5-柯里化（Carrying）"><a href="#2-5-柯里化（Carrying）" class="headerlink" title="2.5 柯里化（Carrying）"></a>2.5 柯里化（Carrying）</h2><p>柯里化的作用是让函数对象分步执行（本质上是利用多个函数对象和闭包）。</p>
<p>例如：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Carrying1Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        highOrder(a -&gt; b -&gt; a + b);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">highOrder</span><span class="params">(Step1 step1)</span> &#123;</span><br><span class="line">        <span class="type">Step2</span> <span class="variable">step2</span> <span class="operator">=</span> step1.exec(<span class="number">10</span>);</span><br><span class="line">        System.out.println(step2.exec(<span class="number">20</span>));</span><br><span class="line">        System.out.println(step2.exec(<span class="number">50</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">interface</span> <span class="title class_">Step1</span> &#123;</span><br><span class="line">        Step2 <span class="title function_">exec</span><span class="params">(<span class="type">int</span> a)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">interface</span> <span class="title class_">Step2</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="title function_">exec</span><span class="params">(<span class="type">int</span> b)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>代码中：</p>
<ul>
<li><code>a -&gt; ...</code> 是第一个函数对象，它的返回结果  <code>b -&gt; ...</code> 是第二个函数对象，由第二个函数对象返回最终结果</li>
<li>后者与前面的参数 a 构成了闭包</li>
<li>step1.exec(10) 确定了 a 的值是 10，返回第二个函数对象 step2，a 被放入了 step2 对象的背包记下来了</li>
<li>step2.exec(20) 确定了 b 的值是 20，此时可以执行 a + b 的操作，得到结果 30</li>
<li>step2.exec(50) 分析过程类似</li>
</ul>
<h2 id="2-6-高阶函数（Higher-Order-Functions）"><a href="#2-6-高阶函数（Higher-Order-Functions）" class="headerlink" title="2.6 高阶函数（Higher-Order Functions）"></a>2.6 高阶函数（Higher-Order Functions）</h2><p>所谓高阶，就是指它是其他函数对象的使用者。</p>
<p>作用：</p>
<ul>
<li>将<strong>通用、复杂</strong>的逻辑隐含在<strong>高阶函数</strong>中</li>
<li>将<strong>易变、未定</strong>的逻辑放在外部的<strong>函数对象</strong>中</li>
</ul>
<p>1、内循环</p>
<p>2、遍历二叉树</p>
<p>3、简单流</p>
<p>4、简单流-化简</p>
<p>5、简单流-收集</p>
<h2 id="2-7-等价的-lambda-表达式"><a href="#2-7-等价的-lambda-表达式" class="headerlink" title="2.7 等价的 lambda 表达式"></a>2.7 等价的 lambda 表达式</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Student</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Student</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">equals</span><span class="params">(Object o)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span> == o) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (o == <span class="literal">null</span> || getClass() != o.getClass()) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="type">Student</span> <span class="variable">student</span> <span class="operator">=</span> (Student) o;</span><br><span class="line">        <span class="keyword">return</span> Objects.equals(name, student.name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Objects.hash(name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li><p><code>Math::random</code> </p>
<p><code>()-&gt;Math.random()</code></p>
</li>
<li><p><code>Math::sqrt</code></p>
<p><code>(double number)-&gt;Math.sqrt(number)</code></p>
</li>
<li><p><code>Student::getName</code></p>
<p><code>(Student stu)-&gt;stu.getName()</code></p>
</li>
<li><p><code>Student::setName</code></p>
<p><code>(Student stu, String newName) -&gt; stu.setName(newName)</code></p>
</li>
<li><p><code>Student::hashCode</code></p>
<p><code>(Student stu) -&gt; stu.hashCode()</code></p>
</li>
<li><p><code>Student::equals</code></p>
<p><code>(Student stu, Object o) -&gt; stu.equals(o)</code></p>
</li>
</ol>
<p>假设已有对象 <code>Student stu = new Student(&quot;张三&quot;);</code></p>
<ol>
<li><p><code>stu::getName</code></p>
<p><code>()-&gt;stu.getName()</code></p>
</li>
<li><p><code>stu::setName</code></p>
<p><code>(String newName)-&gt;stu.setName(newName)</code></p>
</li>
<li><p><code>Student::new</code></p>
<p><code>(String name)-&gt;new Student(name)</code></p>
</li>
</ol>
<h1 id="3-Stream-API"><a href="#3-Stream-API" class="headerlink" title="3. Stream API"></a>3. Stream API</h1><h2 id="3-1-Stream流的思想"><a href="#3-1-Stream流的思想" class="headerlink" title="3.1 Stream流的思想"></a>3.1 Stream流的思想</h2><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/JavaIMG/Stream%E6%B5%81%E6%80%9D%E6%83%B3.png" alt="Stream流思想" style="zoom: 67%;">

<h2 id="3-2-Stream流作用"><a href="#3-2-Stream流作用" class="headerlink" title="3.2 Stream流作用"></a>3.2 Stream流作用</h2><p>结合Lambda表达式，简化集合、数组操作。</p>
<h2 id="3-3-流的三类方法"><a href="#3-3-流的三类方法" class="headerlink" title="3.3 流的三类方法"></a>3.3 流的三类方法</h2><ul>
<li>获取Stream流<ul>
<li>创建一条流水线，并把数据放到流水线上准备进行操作</li>
</ul>
</li>
<li>中间方法<ul>
<li>流水线上的操作</li>
<li>一次操作完毕之后，还可以继续进行其他操作</li>
</ul>
</li>
<li>终结方法<ul>
<li>一个Stream流只能有一个终结方法</li>
<li>是流水线上的最后一个操作</li>
</ul>
</li>
</ul>
<h2 id="3-4-Stream使用步骤"><a href="#3-4-Stream使用步骤" class="headerlink" title="3.4 Stream使用步骤"></a>3.4 Stream使用步骤</h2><ol>
<li>先得到一条Stream流（流水线），再把数据放上去。</li>
<li>使用<strong>中间方法</strong>对流水线上的数据进行操作。</li>
<li>使用<strong>终结方法</strong>对流水线上的数据进行操作。</li>
</ol>
<blockquote>
<p>生成Stream流的方式</p>
</blockquote>
<table>
<thead>
<tr>
<th align="center">获取方式</th>
<th align="center">方法名</th>
<th align="center">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center">单列集合</td>
<td align="center">default Stream<E> stream()</E></td>
<td align="center">Collection中的默认方法</td>
</tr>
<tr>
<td align="center">双列集合</td>
<td align="center">无</td>
<td align="center">无法直接使用stream流</td>
</tr>
<tr>
<td align="center">数组</td>
<td align="center">public static <T> Stream<T> stream(T[] array)</T></T></td>
<td align="center">Arrays工具类中的静态方法</td>
</tr>
<tr>
<td align="center">一堆零散数据</td>
<td align="center">public static<T> Stream<T> of(T… values)</T></T></td>
<td align="center">Stream接口中的静态方法</td>
</tr>
</tbody></table>
<p><font color="red"><strong>PS：Stream接口中静态方法 <code>of</code> 的细节</strong></font></p>
<p>方法的形参是一个可变参数，可以传递一堆零散的数据，也可以传递数组，但是数组<strong>必须</strong>是<font color="red"><strong>引用数据类型</strong></font>的，如果传递基本数据类型，是会把整个数组当做一个元素，放到Stream当中。</p>
<blockquote>
<p>Stream流中间操作方法</p>
</blockquote>
<p>概念：中间操作的意思是,执行完此方法之后，Stream流依然可以继续执行其他操作</p>
<p>常见方法：</p>
<table>
<thead>
<tr>
<th align="center">方法名</th>
<th align="center">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center">Stream<T> filter(Predicate predicate)</T></td>
<td align="center">用于对流中的数据进行过滤</td>
</tr>
<tr>
<td align="center">Stream<T> limit(long maxSize)</T></td>
<td align="center">返回此流中的元素组成的流，截取前指定参数个数的数据</td>
</tr>
<tr>
<td align="center">Stream<T> skip(long n)</T></td>
<td align="center">跳过指定参数个数的数据，返回由该流的剩余元素组成的流</td>
</tr>
<tr>
<td align="center">static <T> Stream<T> concat(Stream a, Stream b)</T></T></td>
<td align="center">合并a和b两个流为一个流</td>
</tr>
<tr>
<td align="center">Stream<T> distinct()</T></td>
<td align="center">返回由该流的不同元素（根据Object.equals(Object) ）组成的流</td>
</tr>
</tbody></table>
<p><strong>PS：</strong></p>
<ul>
<li>中间方法，返回新的Stream流，<font color="red"><strong>原来的Stream流只能使用一次，</strong></font>建议使用链式编程。</li>
<li>修改Stream流中的数据，<font color="red"><strong>不会影响原来集合或数组的数据。</strong></font></li>
</ul>
<blockquote>
<p>Stream流终结操作方法</p>
</blockquote>
<p>概念：终结操作的意思是，执行完此方法之后，Stream流将不能再执行其他操作</p>
<p>常用方法：</p>
<table>
<thead>
<tr>
<th align="center">方法名</th>
<th align="center">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center">void forEach(Consumer action)</td>
<td align="center">遍历、打印</td>
</tr>
<tr>
<td align="center">long count()</td>
<td align="center">统计</td>
</tr>
<tr>
<td align="center">toArray()</td>
<td align="center">把结果收集到数组中</td>
</tr>
<tr>
<td align="center">collect(Collector collector)</td>
<td align="center">把结果收集到集合中</td>
</tr>
</tbody></table>
<p>工具类<code>Collectors</code>提供了具体的集合收集方式：</p>
<table>
<thead>
<tr>
<th align="center">方法名</th>
<th align="center">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center">public static <T> Collector toList()</T></td>
<td align="center">把元素收集到List集合中</td>
</tr>
<tr>
<td align="center">public static <T> Collector toSet()</T></td>
<td align="center">把元素收集到Set集合中</td>
</tr>
<tr>
<td align="center">public static  Collector toMap(Function keyMapper,Function valueMapper)</td>
<td align="center">把元素收集到Map集合中</td>
</tr>
</tbody></table>
<p><strong>PS：终结操作只能执行一次</strong></p>
<h2 id="3-5-过滤"><a href="#3-5-过滤" class="headerlink" title="3.5 过滤"></a>3.5 过滤</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">record</span> <span class="title class_">Fruit</span><span class="params">(String cname, String name, String category, String color)</span> &#123; &#125;</span><br><span class="line"></span><br><span class="line">Stream.of(</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Fruit</span>(<span class="string">&quot;草莓&quot;</span>, <span class="string">&quot;Strawberry&quot;</span>, <span class="string">&quot;浆果&quot;</span>, <span class="string">&quot;红色&quot;</span>),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Fruit</span>(<span class="string">&quot;桑葚&quot;</span>, <span class="string">&quot;Mulberry&quot;</span>, <span class="string">&quot;浆果&quot;</span>, <span class="string">&quot;紫色&quot;</span>),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Fruit</span>(<span class="string">&quot;杨梅&quot;</span>, <span class="string">&quot;Waxberry&quot;</span>, <span class="string">&quot;浆果&quot;</span>, <span class="string">&quot;红色&quot;</span>),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Fruit</span>(<span class="string">&quot;核桃&quot;</span>, <span class="string">&quot;Walnut&quot;</span>, <span class="string">&quot;坚果&quot;</span>, <span class="string">&quot;棕色&quot;</span>),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Fruit</span>(<span class="string">&quot;草莓&quot;</span>, <span class="string">&quot;Peanut&quot;</span>, <span class="string">&quot;坚果&quot;</span>, <span class="string">&quot;棕色&quot;</span>),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Fruit</span>(<span class="string">&quot;蓝莓&quot;</span>, <span class="string">&quot;Blueberry&quot;</span>, <span class="string">&quot;浆果&quot;</span>, <span class="string">&quot;蓝色&quot;</span>)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/JavaIMG/Stream%E6%B5%81%E8%BF%87%E6%BB%A4.png" alt="Stream流过滤"></p>
<p>找到所有浆果：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">.filter(f -&gt; f.category.equals(<span class="string">&quot;浆果&quot;</span>))</span><br></pre></td></tr></table></figure>

<p>找到蓝色的浆果：</p>
<p>方法1：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">.filter(f -&gt; f.category().equals(<span class="string">&quot;浆果&quot;</span>) &amp;&amp; f.color().equals(<span class="string">&quot;蓝色&quot;</span>))</span><br></pre></td></tr></table></figure>

<p>方法2：让每个 lambda 只做一件事，两次 filter 相对于并且关系</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">.filter(f -&gt; f.category.equals(<span class="string">&quot;浆果&quot;</span>))</span><br><span class="line">.filter(f -&gt; f.color().equals(<span class="string">&quot;蓝色&quot;</span>))</span><br></pre></td></tr></table></figure>

<p>方法3：让每个 lambda 只做一件事，不过比方法2强的地方可以 or，and，nagate 运算</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">.filter(((Predicate&lt;Fruit&gt;) f -&gt; f.category.equals(<span class="string">&quot;浆果&quot;</span>)).and(f -&gt; f.color().equals(<span class="string">&quot;蓝色&quot;</span>)))</span><br></pre></td></tr></table></figure>

<h2 id="3-6-映射"><a href="#3-6-映射" class="headerlink" title="3.6 映射"></a>3.6 映射</h2><p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/JavaIMG/Stream%E6%B5%81%E6%98%A0%E5%B0%84.png" alt="Stream流映射"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">.map(f -&gt; f.cname() + <span class="string">&quot;酱&quot;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="3-7-降维"><a href="#3-7-降维" class="headerlink" title="3.7 降维"></a>3.7 降维</h2><p>例1：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/JavaIMG/Stream%E6%B5%81%E9%99%8D%E7%BB%B4.png" alt="Stream流降维" style="zoom: 67%;">

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">record</span> <span class="title class_">Fruit</span><span class="params">(String cname, String name, String category, String color)</span> &#123; &#125;</span><br><span class="line"></span><br><span class="line">Stream.of(</span><br><span class="line">        List.of(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Fruit</span>(<span class="string">&quot;草莓&quot;</span>, <span class="string">&quot;Strawberry&quot;</span>, <span class="string">&quot;浆果&quot;</span>, <span class="string">&quot;红色&quot;</span>),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Fruit</span>(<span class="string">&quot;桑葚&quot;</span>, <span class="string">&quot;Mulberry&quot;</span>, <span class="string">&quot;浆果&quot;</span>, <span class="string">&quot;紫色&quot;</span>),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Fruit</span>(<span class="string">&quot;杨梅&quot;</span>, <span class="string">&quot;Waxberry&quot;</span>, <span class="string">&quot;浆果&quot;</span>, <span class="string">&quot;红色&quot;</span>),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Fruit</span>(<span class="string">&quot;蓝莓&quot;</span>, <span class="string">&quot;Blueberry&quot;</span>, <span class="string">&quot;浆果&quot;</span>, <span class="string">&quot;蓝色&quot;</span>)</span><br><span class="line">        ),</span><br><span class="line">        List.of(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Fruit</span>(<span class="string">&quot;核桃&quot;</span>, <span class="string">&quot;Walnut&quot;</span>, <span class="string">&quot;坚果&quot;</span>, <span class="string">&quot;棕色&quot;</span>),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Fruit</span>(<span class="string">&quot;草莓&quot;</span>, <span class="string">&quot;Peanut&quot;</span>, <span class="string">&quot;坚果&quot;</span>, <span class="string">&quot;棕色&quot;</span>)</span><br><span class="line">        )</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">.flatMap(Collection::stream)</span><br></pre></td></tr></table></figure>

<p>这样把坚果和浆果两个集合变成了含六个元素的水果流。</p>
<p>例2：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Stream.of(</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Order</span>(<span class="number">1</span>, List.of(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Item</span>(<span class="number">6499</span>, <span class="number">1</span>, <span class="string">&quot;HUAWEI MateBook 14s&quot;</span>),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Item</span>(<span class="number">6999</span>, <span class="number">1</span>, <span class="string">&quot;HUAWEI Mate 60 Pro&quot;</span>),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Item</span>(<span class="number">1488</span>, <span class="number">1</span>, <span class="string">&quot;HUAWEI WATCH GT 4&quot;</span>)</span><br><span class="line">        )),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Order</span>(<span class="number">1</span>, List.of(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Item</span>(<span class="number">8999</span>, <span class="number">1</span>, <span class="string">&quot;Apple MacBook Air 13&quot;</span>),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Item</span>(<span class="number">7999</span>, <span class="number">1</span>, <span class="string">&quot;Apple iPhone 15 Pro&quot;</span>),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Item</span>(<span class="number">2999</span>, <span class="number">1</span>, <span class="string">&quot;Apple Watch Series 9&quot;</span>)</span><br><span class="line">        ))</span><br><span class="line">)</span><br><span class="line">    </span><br><span class="line"><span class="comment">// 逐一处理每个订单中的商品</span></span><br><span class="line">.flatMap(order -&gt; order.items().stream())</span><br></pre></td></tr></table></figure>

<p>这样把一个有两个元素的订单流，变成了一个有六个元素的商品流。</p>
<h2 id="3-8-构建"><a href="#3-8-构建" class="headerlink" title="3.8 构建"></a>3.8 构建</h2><p>根据已有的数组构建流</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Arrays.stream(array)</span><br></pre></td></tr></table></figure>

<p>根据已有的 Collection 构建流（包括 List，Set 等）</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">List.of(<span class="string">&quot;a&quot;</span>,<span class="string">&quot;b&quot;</span>,<span class="string">&quot;c&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>把一个对象变成流</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Stream.of(<span class="string">&quot;d&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>把多个对象变成流</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Stream.of(<span class="string">&quot;x&quot;</span>, <span class="string">&quot;y&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>如果是多个数组对象变成流：</p>
<p>数组<strong>必须</strong>是<font color="red"><strong>引用数据类型</strong></font>的，如果传递基本数据类型，是会把整个数组当做一个元素，放到Stream当中。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span>[] arr1 = &#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">8</span>,<span class="number">9</span>,<span class="number">10</span>&#125;;</span><br><span class="line">String[] arr2 = &#123;<span class="string">&quot;a&quot;</span>,<span class="string">&quot;b&quot;</span>,<span class="string">&quot;c&quot;</span>&#125;;</span><br><span class="line"></span><br><span class="line">Stream.of(arr1).forEach(System.out::println);</span><br><span class="line">System.out.println(<span class="string">&quot;-----------&quot;</span>);</span><br><span class="line">Stream.of(arr2).forEach(System.out::println);</span><br></pre></td></tr></table></figure>

<p>可以看到，如果传递基本数据类型，是会把整个数组当做一个元素，放到Stream当中，打印出来的是一个地址值：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[I@446cdf90</span><br><span class="line">-----------</span><br><span class="line">a</span><br><span class="line">b</span><br><span class="line">c</span><br></pre></td></tr></table></figure>

<h2 id="3-9-拼接"><a href="#3-9-拼接" class="headerlink" title="3.9 拼接"></a>3.9 拼接</h2><p>两个流拼接</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Stream.concat(Stream.of(<span class="string">&quot;a&quot;</span>,<span class="string">&quot;b&quot;</span>,<span class="string">&quot;c&quot;</span>), Stream.of(<span class="string">&quot;d&quot;</span>))</span><br></pre></td></tr></table></figure>

<h2 id="3-10-截取"><a href="#3-10-截取" class="headerlink" title="3.10 截取"></a>3.10 截取</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Stream.concat(Stream.of(<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;c&quot;</span>), Stream.of(<span class="string">&quot;d&quot;</span>))</span><br><span class="line">    .skip(<span class="number">1</span>)</span><br><span class="line">    .limit(<span class="number">2</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">b</span><br><span class="line">c</span><br></pre></td></tr></table></figure>

<ul>
<li>skip 是跳过几个元素</li>
<li>limit 是限制处理的元素个数</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Stream.concat(Stream.of(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>), Stream.of(<span class="number">4</span>, <span class="number">5</span>, <span class="number">1</span>, <span class="number">2</span>))</span><br><span class="line">    .takeWhile(x -&gt; x &lt; <span class="number">3</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Stream.concat(Stream.of(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>), Stream.of(<span class="number">4</span>, <span class="number">5</span>, <span class="number">1</span>, <span class="number">2</span>))</span><br><span class="line">	.dropWhile(x -&gt; x &lt; <span class="number">3</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">1</span><br><span class="line">2</span><br></pre></td></tr></table></figure>

<ul>
<li><p>dropWhile 是 drop 流中元素，直到条件不成立，留下剩余元素</p>
</li>
<li><p>takeWhile 是 take 流中元素，直到条件不成立，舍弃剩余元素</p>
</li>
</ul>
<h2 id="3-11-生成"><a href="#3-11-生成" class="headerlink" title="3.11 生成"></a>3.11 生成</h2><p>生成从 0 ~ 9 的数字</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">IntStream.range(<span class="number">0</span>, <span class="number">10</span>)</span><br><span class="line"><span class="comment">//或者</span></span><br><span class="line">IntStream.rangeClosed(<span class="number">0</span>, <span class="number">9</span>)</span><br></pre></td></tr></table></figure>

<p>如果想订制，可以用 <code>iterate</code> 方法，例如下面生成奇数序列：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">IntStream.iterate(<span class="number">1</span>, x -&gt; x + <span class="number">2</span>)</span><br><span class="line">IntStream.iterate(<span class="number">1</span>, x -&gt; x + <span class="number">2</span>).limit(<span class="number">10</span>)	<span class="comment">//限制元素个数</span></span><br></pre></td></tr></table></figure>

<ul>
<li>参数1 是初始值</li>
<li>参数2 是一个特殊 Function，即参数类型与返回值相同，它会根据上一个元素 x 的值计算出当前元素</li>
<li>需要用 limit 限制元素个数</li>
</ul>
<p>也可以用 <code>iterate</code> 的重载方法：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">IntStream.iterate(<span class="number">1</span>, x -&gt; x &lt; <span class="number">10</span>, x -&gt; x + <span class="number">2</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li>参数1 是初始值</li>
<li>参数2 用来限制元素个数，一旦不满足此条件，流就结束</li>
<li>参数3 相当于上个方法的参数2</li>
</ul>
<p><code>iterate</code> 的特点是根据上一个元素计算当前元素，如果不需要依赖上一个元素，可以改用 <code>generate</code> 方法。</p>
<p>例如下面是生成 5 个随机 int：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Stream.generate(()-&gt; ThreadLocalRandom.current().nextInt()).limit(<span class="number">5</span>)</span><br></pre></td></tr></table></figure>

<p>不过如果只是生成随机数的话，有更简单的办法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">ThreadLocalRandom.current().ints(<span class="number">5</span>)</span><br></pre></td></tr></table></figure>

<p>如果要指定上下限，例如下面是生成从 0~9 的100个随机数</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">ThreadLocalRandom.current().ints(<span class="number">100</span>, <span class="number">0</span>, <span class="number">10</span>)</span><br></pre></td></tr></table></figure>

<h2 id="3-12-查找与判断"><a href="#3-12-查找与判断" class="headerlink" title="3.12 查找与判断"></a>3.12 查找与判断</h2><blockquote>
<p>查找</p>
</blockquote>
<p>下面的代码找到流中任意（Any）一个偶数</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span>[] array = &#123;<span class="number">1</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">4</span>, <span class="number">7</span>, <span class="number">6</span>, <span class="number">9</span>&#125;;</span><br><span class="line"></span><br><span class="line">Arrays.stream(array)</span><br><span class="line">    .filter(x -&gt; (x &amp; <span class="number">1</span>) == <span class="number">0</span>)</span><br><span class="line">    .findAny()</span><br><span class="line">    .ifPresent(System.out::println);</span><br></pre></td></tr></table></figure>

<ul>
<li>注意 findAny 返回的是 <code>OptionalInt</code> 对象，因为可能流中不存在偶数</li>
<li>对于 <code>OptionalInt</code> 对象，一般需要用 <code>ifPresent</code> 或 <code>orElse</code>（提供默认值）来处理</li>
</ul>
<p>与 <code>findAny</code> 比较类似的是 <code>firstFirst</code>，它俩的区别？</p>
<ul>
<li>findAny 是找在流中任意位置的元素，不需要考虑顺序，对于上例返回 6 也是可以的</li>
<li>findFirst 是找第一个出现在元素，需要考虑顺序，对于上例只能返回 4</li>
<li>findAny 在顺序流中与 findFirst 表现相同，区别在于并行流下会更快</li>
</ul>
<blockquote>
<p>判断</p>
</blockquote>
<p>判断流中是否存在任意一个偶数：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Arrays.stream(array).anyMatch(x -&gt; (x &amp; <span class="number">1</span>) == <span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li>它返回的是 boolean 值，可以直接用来判断</li>
</ul>
<p>判断流是否全部是偶数：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Arrays.stream(array).allMatch(x -&gt; (x &amp; <span class="number">1</span>) == <span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li>同样，它返回的是 boolean 值，可以直接用来判断</li>
</ul>
<p>判断流是否全部不是偶数：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Arrays.stream(array).noneMatch(x -&gt; (x &amp; <span class="number">1</span>) == <span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li>noneMatch 与 allMatch 含义恰好相反</li>
</ul>
<h2 id="3-13-排序与去重"><a href="#3-13-排序与去重" class="headerlink" title="3.13 排序与去重"></a>3.13 排序与去重</h2><blockquote>
<p>去重</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">IntStream.of(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>)</span><br><span class="line">	.distinct()</span><br></pre></td></tr></table></figure>

<blockquote>
<p>排序</p>
</blockquote>
<p>已知有数据</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">record</span> <span class="title class_">Hero</span><span class="params">(String name, <span class="type">int</span> strength)</span> &#123; &#125;</span><br><span class="line"></span><br><span class="line">Stream.of(</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Hero</span>(<span class="string">&quot;独孤求败&quot;</span>, <span class="number">100</span>),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Hero</span>(<span class="string">&quot;令狐冲&quot;</span>, <span class="number">90</span>),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Hero</span>(<span class="string">&quot;风清扬&quot;</span>, <span class="number">98</span>),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Hero</span>(<span class="string">&quot;东方不败&quot;</span>, <span class="number">98</span>),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Hero</span>(<span class="string">&quot;方证&quot;</span>, <span class="number">92</span>),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Hero</span>(<span class="string">&quot;任我行&quot;</span>, <span class="number">92</span>),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Hero</span>(<span class="string">&quot;冲虚&quot;</span>, <span class="number">90</span>),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Hero</span>(<span class="string">&quot;向问天&quot;</span>, <span class="number">88</span>),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Hero</span>(<span class="string">&quot;不戒&quot;</span>, <span class="number">88</span>)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>要求，首先按 strength 武力排序（逆序），武力相同的，按姓名长度排序（正序）</p>
<p>仅用 lambda 来解</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">.sorted((a,b)-&gt; &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">res</span> <span class="operator">=</span> Integer.compare(b.strength(), a.strength());</span><br><span class="line">    <span class="keyword">return</span> (res == <span class="number">0</span>) ? Integer.compare(a.nameLength(), b.nameLength()) : res; </span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>方法引用改写</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">.sorted(</span><br><span class="line">    Comparator.comparingInt(Hero::strength)</span><br><span class="line">      .reversed()</span><br><span class="line">      .thenComparingInt(Hero::nameLength)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>其中：</p>
<ul>
<li><code>comparingInt</code> 接收一个 key 提取器（说明按对象中哪部分来比较），返回一个比较器</li>
<li><code>reversed</code> 返回一个顺序相反的比较器</li>
<li><code>thenComparingInt</code> 接收一个 key 提取器，返回一个新比较器，新比较器在原有比较器结果相等时执行新的比较逻辑</li>
</ul>
<p>增加一个辅助方法：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">record</span> <span class="title class_">Hero</span><span class="params">(String name, <span class="type">int</span> strength)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="title function_">nameLength</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.name.length();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>原理：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">.sorted((e, f) -&gt; &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">res</span> <span class="operator">=</span></span><br><span class="line">        ((Comparator&lt;Hero&gt;) (c, d) -&gt;</span><br><span class="line">            ((Comparator&lt;Hero&gt;) (a, b) -&gt; Integer.compare(a.strength(), b.strength()))</span><br><span class="line">                .compare(d, c))</span><br><span class="line">            .compare(e, f);</span><br><span class="line">    <span class="keyword">return</span> (res == <span class="number">0</span>) ? Integer.compare(e.nameLength(), f.nameLength()) : res;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>如果不好看，改成下面的代码</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">.sorted(step3(step2(step1())))</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> Comparator&lt;Hero&gt; <span class="title function_">step1</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (a, b) -&gt; Integer.compare(a.strength(), b.strength());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> Comparator&lt;Hero&gt; <span class="title function_">step2</span><span class="params">(Comparator&lt;Hero&gt; step1)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (c, d) -&gt; step1.compare(d, c);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> Comparator&lt;Hero&gt; <span class="title function_">step3</span><span class="params">(Comparator&lt;Hero&gt; step2)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (e, f) -&gt; &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">res</span> <span class="operator">=</span> step2.compare(e, f);</span><br><span class="line">        <span class="keyword">return</span> (res == <span class="number">0</span>) ? Integer.compare(e.nameLength(), f.nameLength()) : res;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-14-化简"><a href="#3-14-化简" class="headerlink" title="3.14 化简"></a>3.14 化简</h2><p>化简：两两合并，只剩一个</p>
<p>适合：最大值、最小值、求和、求个数…</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">.reduce(init, (p,x) -&gt; r);</span><br></pre></td></tr></table></figure>

<ul>
<li><code>init</code> 代表初始值，返回值是一个<code>Optional</code>对象，当不给初始值时，流中没有元素对象的时候返回一个<code>Optional.empty</code></li>
<li><code>(p,x) -&gt; r</code> 是一个 BinaryOperator，作用是根据上次化简结果 p 和当前元素 x，得到本次化简结果 r</li>
</ul>
<p>这样两两化简，可以将流中的所有元素合并成一个结果。</p>
<h2 id="3-15-收集"><a href="#3-15-收集" class="headerlink" title="3.15 收集"></a>3.15 收集</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">.collect( supplier, accumulator, combiner);</span><br></pre></td></tr></table></figure>

<ul>
<li>supplier 是描述如何创建收集容器 c ：<code>()-&gt; c</code></li>
<li>accumulator 是描述如何向容器 c 添加元素 x：<code>(c, x) -&gt; void</code></li>
<li>combiner 是描述如何合并两个容器：<code>(c1, c2) -&gt; void</code><ul>
<li>串行流下不需要合并容器</li>
<li>并行流如果用的是并发容器，也不需要合并</li>
</ul>
</li>
</ul>
<h2 id="3-16-收集器"><a href="#3-16-收集器" class="headerlink" title="3.16 收集器"></a>3.16 收集器</h2><p>通过上面的收集可以看出，不管收集容器的种类有多少种，在收集时都需要三个参数，可以将这三个参数用一个整体来表示，这个整体就叫<code>Collector收集器</code>。JDK给我们提供了一个收集器工具类<code>Collectors</code>，工具类中的静态方法就是用来创建各种不同类型的收集器。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">.collect(Collectors.toList());	<span class="comment">//收集到 List 集合中</span></span><br></pre></td></tr></table></figure>

<p>类似，Collectors 类中还提供了很多现成的收集器：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Collectors.toSet()	<span class="comment">//收集到 Set</span></span><br><span class="line">Collectors.joining()	<span class="comment">//收集到 StringBuilder</span></span><br><span class="line">Collectors.joining(<span class="string">&quot;,&quot;</span>)	<span class="comment">//收集到 StringJoiner</span></span><br><span class="line">Collectors.toMap(x -&gt; x, x -&gt; <span class="number">1</span>)	<span class="comment">//收集到 Map</span></span><br></pre></td></tr></table></figure>

<h2 id="3-17-下游收集器"><a href="#3-17-下游收集器" class="headerlink" title="3.17 下游收集器"></a>3.17 下游收集器</h2><p>做 <code>groupingBy</code> 分组收集时，组内可能需要进一步的数据收集，称为下游收集器。</p>
<p>一些专门和 groupingBy  配合使用的下游处理器：</p>
<table>
<thead>
<tr>
<th align="center">下游收集器</th>
<th align="center">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center">mapping(x-&gt;y, dc)</td>
<td align="center">将 x 转换为 y ，用下游收集器 dc 收集</td>
</tr>
<tr>
<td align="center">flatMapping(x-&gt;substream, dc)</td>
<td align="center">将 x 转换为 substream ，用下游收集器 dc 收集</td>
</tr>
<tr>
<td align="center">filtering(x-&gt;boolean, dc)</td>
<td align="center">过滤后，用下游收集器 dc 收集</td>
</tr>
<tr>
<td align="center">counting()</td>
<td align="center">求个数</td>
</tr>
<tr>
<td align="center">minBy((a,b)-&gt;int)</td>
<td align="center">求最小</td>
</tr>
<tr>
<td align="center">maxBy((a,b)-&gt;int)</td>
<td align="center">求最大</td>
</tr>
<tr>
<td align="center">summingInt(x-&gt;int)</td>
<td align="center">转 int 后求和</td>
</tr>
<tr>
<td align="center">averagingDouble(x-&gt;double)</td>
<td align="center">转 double 后求平均</td>
</tr>
<tr>
<td align="center">reducing(init,(p,x)-&gt;r)</td>
<td align="center">init 初始值，用上次结果 p 和当前元素 x 生成本次结果 r</td>
</tr>
</tbody></table>
<p><font color="red"><strong>PS：调用静态方法可以使用 <code>import static</code> 语法省略类名</strong></font></p>
<p>未省略 <code>Collectors</code>：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">stream.collect(Collectors.groupingBy(h -&gt; h.name().length(), Collectors.mapping(h -&gt; h.strength(), Collectors.toList())));</span><br></pre></td></tr></table></figure>

<p>使用 <code>import static</code> 语法省略 <code>Collectors</code>：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> java.util.stream.Collectors.groupingBy;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> java.util.stream.Collectors.mapping;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> java.util.stream.Collectors.toList;</span><br><span class="line"><span class="comment">//或者使用通配符一次性导入</span></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> java.util.stream.Collectors.*;</span><br><span class="line"></span><br><span class="line">stream.collect(groupingBy(h -&gt; h.name().length(), mapping(h -&gt; h.strength(), toList())));</span><br></pre></td></tr></table></figure>

<h2 id="3-18-基本流"><a href="#3-18-基本流" class="headerlink" title="3.18 基本流"></a>3.18 基本流</h2><p>基本类型流指 IntStream、LongStream 和 DoubleStream，它们在做数值计算时有更好的性能。</p>
<p>转换成基本流：</p>
<ul>
<li>mapToInt</li>
<li>mapToLong</li>
<li>mapToDouble</li>
<li>flatMapToInt</li>
<li>flatMapToLong</li>
<li>flatMapToDouble</li>
<li>mapMultiToInt</li>
<li>mapMultiToLong</li>
<li>mapMultiToDouble</li>
</ul>
<p>基本流转对象流：</p>
<ul>
<li>mapToObj</li>
<li>boxed</li>
</ul>
<h2 id="3-19-并行"><a href="#3-19-并行" class="headerlink" title="3.19 并行"></a>3.19 并行</h2><p>在 Java 中，<strong>串行流</strong>和<strong>并行流</strong>是针对流操作的两种不同处理方式：</p>
<p>串行流（Sequential Stream）：</p>
<ul>
<li>串行流是流元素按顺序依次处理的流。</li>
<li>在串行流中，操作是单线程执行的，每个元素依次经过流水线上的各个阶段处理。</li>
<li>适用于简单的数据处理场景，数据量不大且处理时间短的情况下。</li>
</ul>
<p>并行流（Parallel Stream）：</p>
<ul>
<li>并行流是流元素并行处理的流。</li>
<li>在并行流中，操作会并发执行，流会被拆分为多个子任务，这些子任务可以在多个线程上同时处理。</li>
<li>适用于大规模数据处理、复杂计算或需要并行处理的场景。</li>
</ul>
<p>并行流例：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Stream.of(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>)</span><br><span class="line">    .parallel()</span><br><span class="line">    .collect(Collector.of(</span><br><span class="line">            () -&gt; &#123;</span><br><span class="line">                System.out.printf(<span class="string">&quot;%-12s %s%n&quot;</span>,simple(),<span class="string">&quot;create&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;Integer&gt;();</span><br><span class="line">            &#125;,</span><br><span class="line">            (list, x) -&gt; &#123;</span><br><span class="line">                List&lt;Integer&gt; old = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(list);</span><br><span class="line">                list.add(x);</span><br><span class="line">                System.out.printf(<span class="string">&quot;%-12s %s.add(%d)=&gt;%s%n&quot;</span>,simple(), old, x, list);</span><br><span class="line">            &#125;,</span><br><span class="line">            (list1, list2) -&gt; &#123;</span><br><span class="line">                List&lt;Integer&gt; old = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(list1);</span><br><span class="line">                list1.addAll(list2);</span><br><span class="line">                System.out.printf(<span class="string">&quot;%-12s %s.add(%s)=&gt;%s%n&quot;</span>, simple(),old, list2, list1);</span><br><span class="line">                <span class="keyword">return</span> list1;</span><br><span class="line">            &#125;,</span><br><span class="line">            list -&gt; list,</span><br><span class="line">            Collector.Characteristics.IDENTITY_FINISH</span><br><span class="line">    ));</span><br></pre></td></tr></table></figure>

<h2 id="3-20-效率"><a href="#3-20-效率" class="headerlink" title="3.20 效率"></a>3.20 效率</h2><blockquote>
<p>数组求和</p>
</blockquote>
<p>其中</p>
<ul>
<li>primitive 用 loop 循环对 int 求和</li>
<li>intStream 用 IntStream 对 int 求和</li>
<li>boxed 用 loop 循环对 Integer 求和</li>
<li>stream 用 Stream 对 Integer 求和</li>
</ul>
<p>元素个数 100</p>
<table>
<thead>
<tr>
<th align="center">Benchmark</th>
<th align="center">Mode</th>
<th align="center">Cnt</th>
<th align="center">Score (ns&#x2F;op)</th>
<th align="center">Error (ns&#x2F;op)</th>
<th align="center">Units</th>
</tr>
</thead>
<tbody><tr>
<td align="center">T01Sum.primitive</td>
<td align="center">avgt</td>
<td align="center">5</td>
<td align="center">25.424</td>
<td align="center">± 0.782</td>
<td align="center">ns&#x2F;op</td>
</tr>
<tr>
<td align="center">T01Sum.intStream</td>
<td align="center">avgt</td>
<td align="center">5</td>
<td align="center">47.482</td>
<td align="center">± 1.145</td>
<td align="center">ns&#x2F;op</td>
</tr>
<tr>
<td align="center">T01Sum.boxed</td>
<td align="center">avgt</td>
<td align="center">5</td>
<td align="center">72.457</td>
<td align="center">± 4.136</td>
<td align="center">ns&#x2F;op</td>
</tr>
<tr>
<td align="center">T01Sum.stream</td>
<td align="center">avgt</td>
<td align="center">5</td>
<td align="center">465.141</td>
<td align="center">± 4.891</td>
<td align="center">ns&#x2F;op</td>
</tr>
</tbody></table>
<p>元素个数 1000</p>
<table>
<thead>
<tr>
<th align="center">Benchmark</th>
<th align="center">Mode</th>
<th align="center">Cnt</th>
<th align="center">Score (ns&#x2F;op)</th>
<th align="center">Error (ns&#x2F;op)</th>
<th align="center">Units</th>
</tr>
</thead>
<tbody><tr>
<td align="center">T01Sum.primitive</td>
<td align="center">avgt</td>
<td align="center">5</td>
<td align="center">270.556</td>
<td align="center">± 1.277</td>
<td align="center">ns&#x2F;op</td>
</tr>
<tr>
<td align="center">T01Sum.intStream</td>
<td align="center">avgt</td>
<td align="center">5</td>
<td align="center">292.467</td>
<td align="center">± 10.987</td>
<td align="center">ns&#x2F;op</td>
</tr>
<tr>
<td align="center">T01Sum.boxed</td>
<td align="center">avgt</td>
<td align="center">5</td>
<td align="center">583.929</td>
<td align="center">± 57.338</td>
<td align="center">ns&#x2F;op</td>
</tr>
<tr>
<td align="center">T01Sum.stream</td>
<td align="center">avgt</td>
<td align="center">5</td>
<td align="center">5948.294</td>
<td align="center">± 2209.211</td>
<td align="center">ns&#x2F;op</td>
</tr>
</tbody></table>
<p>元素个数 10000</p>
<table>
<thead>
<tr>
<th align="center">Benchmark</th>
<th align="center">Mode</th>
<th align="center">Cnt</th>
<th align="center">Score (ns&#x2F;op)</th>
<th align="center">Error (ns&#x2F;op)</th>
<th align="center">Units</th>
</tr>
</thead>
<tbody><tr>
<td align="center">T01Sum.primitive</td>
<td align="center">avgt</td>
<td align="center">5</td>
<td align="center">2681.651</td>
<td align="center">± 12.614</td>
<td align="center">ns&#x2F;op</td>
</tr>
<tr>
<td align="center">T01Sum.intStream</td>
<td align="center">avgt</td>
<td align="center">5</td>
<td align="center">2718.408</td>
<td align="center">± 52.418</td>
<td align="center">ns&#x2F;op</td>
</tr>
<tr>
<td align="center">T01Sum.boxed</td>
<td align="center">avgt</td>
<td align="center">5</td>
<td align="center">6391.285</td>
<td align="center">± 358.154</td>
<td align="center">ns&#x2F;op</td>
</tr>
<tr>
<td align="center">T01Sum.stream</td>
<td align="center">avgt</td>
<td align="center">5</td>
<td align="center">44414.884</td>
<td align="center">± 3213.055</td>
<td align="center">ns&#x2F;op</td>
</tr>
</tbody></table>
<p>结论：</p>
<ul>
<li>做数值计算，优先挑选基本流（IntStream 等）在数据量较大时，它的性能已经非常接近普通 for 循环</li>
<li>做数值计算，应当避免普通流（Stream）性能与其它几种相比，慢一个数量级</li>
</ul>
<blockquote>
<p>求最大值</p>
</blockquote>
<p>其中（原始数据都是 int，没有包装类）</p>
<ul>
<li>custom 自定义多线程并行求最大值</li>
<li>parallel 并行流求最大值</li>
<li>sequence 串行流求最大值</li>
<li>primitive loop 循环求最大值</li>
</ul>
<p>元素个数 100</p>
<table>
<thead>
<tr>
<th align="center">Benchmark</th>
<th align="center">Mode</th>
<th align="center">Cnt</th>
<th align="center">Score (ns&#x2F;op)</th>
<th align="center">Error (ns&#x2F;op)</th>
<th align="center">Units</th>
</tr>
</thead>
<tbody><tr>
<td align="center">T02Parallel.custom</td>
<td align="center">avgt</td>
<td align="center">5</td>
<td align="center">39619.796</td>
<td align="center">± 1263.036</td>
<td align="center">ns&#x2F;op</td>
</tr>
<tr>
<td align="center">T02Parallel.parallel</td>
<td align="center">avgt</td>
<td align="center">5</td>
<td align="center">6754.239</td>
<td align="center">± 79.894</td>
<td align="center">ns&#x2F;op</td>
</tr>
<tr>
<td align="center">T02Parallel.primitive</td>
<td align="center">avgt</td>
<td align="center">5</td>
<td align="center">29.538</td>
<td align="center">± 3.056</td>
<td align="center">ns&#x2F;op</td>
</tr>
<tr>
<td align="center">T02Parallel.sequence</td>
<td align="center">avgt</td>
<td align="center">5</td>
<td align="center">80.170</td>
<td align="center">± 1.940</td>
<td align="center">ns&#x2F;op</td>
</tr>
</tbody></table>
<p>元素个数 10000</p>
<table>
<thead>
<tr>
<th align="center">Benchmark</th>
<th align="center">Mode</th>
<th align="center">Cnt</th>
<th align="center">Score (ns&#x2F;op)</th>
<th align="center">Error (ns&#x2F;op)</th>
<th align="center">Units</th>
</tr>
</thead>
<tbody><tr>
<td align="center">T02Parallel.custom</td>
<td align="center">avgt</td>
<td align="center">5</td>
<td align="center">41656.093</td>
<td align="center">± 1537.237</td>
<td align="center">ns&#x2F;op</td>
</tr>
<tr>
<td align="center">T02Parallel.parallel</td>
<td align="center">avgt</td>
<td align="center">5</td>
<td align="center">11218.573</td>
<td align="center">± 1994.863</td>
<td align="center">ns&#x2F;op</td>
</tr>
<tr>
<td align="center">T02Parallel.primitive</td>
<td align="center">avgt</td>
<td align="center">5</td>
<td align="center">2217.562</td>
<td align="center">± 80.981</td>
<td align="center">ns&#x2F;op</td>
</tr>
<tr>
<td align="center">T02Parallel.sequence</td>
<td align="center">avgt</td>
<td align="center">5</td>
<td align="center">5682.482</td>
<td align="center">± 264.645</td>
<td align="center">ns&#x2F;op</td>
</tr>
</tbody></table>
<p>元素个数 1000000</p>
<table>
<thead>
<tr>
<th align="center">Benchmark</th>
<th align="center">Mode</th>
<th align="center">Cnt</th>
<th align="center">Score (ns&#x2F;op)</th>
<th align="center">Error (ns&#x2F;op)</th>
<th align="center">Units</th>
</tr>
</thead>
<tbody><tr>
<td align="center">T02Parallel.custom</td>
<td align="center">avgt</td>
<td align="center">5</td>
<td align="center">194984.564</td>
<td align="center">± 25794.484</td>
<td align="center">ns&#x2F;op</td>
</tr>
<tr>
<td align="center">T02Parallel.parallel</td>
<td align="center">avgt</td>
<td align="center">5</td>
<td align="center">298940.794</td>
<td align="center">± 31944.959</td>
<td align="center">ns&#x2F;op</td>
</tr>
<tr>
<td align="center">T02Parallel.primitive</td>
<td align="center">avgt</td>
<td align="center">5</td>
<td align="center">325178.873</td>
<td align="center">± 81314.981</td>
<td align="center">ns&#x2F;op</td>
</tr>
<tr>
<td align="center">T02Parallel.sequence</td>
<td align="center">avgt</td>
<td align="center">5</td>
<td align="center">618274.062</td>
<td align="center">± 5867.812</td>
<td align="center">ns&#x2F;op</td>
</tr>
</tbody></table>
<p>结论：</p>
<ul>
<li>并行流相对自己用多线程实现分而治之更简洁</li>
<li>并行流只有在数据量非常大时，才能充分发力，数据量少，还不如用串行流</li>
</ul>
<blockquote>
<p>并行(发)收集</p>
</blockquote>
<p>元素个数 100</p>
<table>
<thead>
<tr>
<th align="center">Benchmark</th>
<th align="center">Mode</th>
<th align="center">Cnt</th>
<th align="center">Score (ns&#x2F;op)</th>
<th align="center">Error (ns&#x2F;op)</th>
<th align="center">Units</th>
</tr>
</thead>
<tbody><tr>
<td align="center">loop1</td>
<td align="center">avgt</td>
<td align="center">5</td>
<td align="center">1312.389</td>
<td align="center">±  90.683</td>
<td align="center">ns&#x2F;op</td>
</tr>
<tr>
<td align="center">loop2</td>
<td align="center">avgt</td>
<td align="center">5</td>
<td align="center">1776.391</td>
<td align="center">± 255.271</td>
<td align="center">ns&#x2F;op</td>
</tr>
<tr>
<td align="center">sequence</td>
<td align="center">avgt</td>
<td align="center">5</td>
<td align="center">1727.739</td>
<td align="center">±  28.821</td>
<td align="center">ns&#x2F;op</td>
</tr>
<tr>
<td align="center">parallelNoConcurrent</td>
<td align="center">avgt</td>
<td align="center">5</td>
<td align="center">27654.004</td>
<td align="center">± 496.970</td>
<td align="center">ns&#x2F;op</td>
</tr>
<tr>
<td align="center">parallelConcurrent</td>
<td align="center">avgt</td>
<td align="center">5</td>
<td align="center">16320.113</td>
<td align="center">± 344.766</td>
<td align="center">ns&#x2F;op</td>
</tr>
</tbody></table>
<p>元素个数 10000</p>
<table>
<thead>
<tr>
<th align="center">Benchmark</th>
<th align="center">Mode</th>
<th align="center">Cnt</th>
<th align="center">Score (ns&#x2F;op)</th>
<th align="center">Error (ns&#x2F;op)</th>
<th align="center">Units</th>
</tr>
</thead>
<tbody><tr>
<td align="center">loop1</td>
<td align="center">avgt</td>
<td align="center">5</td>
<td align="center">211526.546</td>
<td align="center">± 13549.703</td>
<td align="center">ns&#x2F;op</td>
</tr>
<tr>
<td align="center">loop2</td>
<td align="center">avgt</td>
<td align="center">5</td>
<td align="center">203794.146</td>
<td align="center">± 3525.972</td>
<td align="center">ns&#x2F;op</td>
</tr>
<tr>
<td align="center">sequence</td>
<td align="center">avgt</td>
<td align="center">5</td>
<td align="center">237688.651</td>
<td align="center">±  7593.483</td>
<td align="center">ns&#x2F;op</td>
</tr>
<tr>
<td align="center">parallelNoConcurrent</td>
<td align="center">avgt</td>
<td align="center">5</td>
<td align="center">527203.976</td>
<td align="center">±  3496.107</td>
<td align="center">ns&#x2F;op</td>
</tr>
<tr>
<td align="center">parallelConcurrent</td>
<td align="center">avgt</td>
<td align="center">5</td>
<td align="center">369630.728</td>
<td align="center">± 20549.731</td>
<td align="center">ns&#x2F;op</td>
</tr>
</tbody></table>
<p>元素个数 1000000</p>
<table>
<thead>
<tr>
<th align="center">Benchmark</th>
<th align="center">Mode</th>
<th align="center">Cnt</th>
<th align="center">Score (ms&#x2F;op)</th>
<th align="center">Error (ms&#x2F;op)</th>
<th align="center">Units</th>
</tr>
</thead>
<tbody><tr>
<td align="center">loop1</td>
<td align="center">avgt</td>
<td align="center">5</td>
<td align="center">69.154</td>
<td align="center">± 3.456</td>
<td align="center">ms&#x2F;op</td>
</tr>
<tr>
<td align="center">loop2</td>
<td align="center">avgt</td>
<td align="center">5</td>
<td align="center">83.815</td>
<td align="center">± 2.307</td>
<td align="center">ms&#x2F;op</td>
</tr>
<tr>
<td align="center">sequence</td>
<td align="center">avgt</td>
<td align="center">5</td>
<td align="center">103.585</td>
<td align="center">± 0.834</td>
<td align="center">ns&#x2F;op</td>
</tr>
<tr>
<td align="center">parallelNoConcurrent</td>
<td align="center">avgt</td>
<td align="center">5</td>
<td align="center">167.032</td>
<td align="center">± 15.406</td>
<td align="center">ms&#x2F;op</td>
</tr>
<tr>
<td align="center">parallelConcurrent</td>
<td align="center">avgt</td>
<td align="center">5</td>
<td align="center">52.326</td>
<td align="center">± 1.501</td>
<td align="center">ms&#x2F;op</td>
</tr>
</tbody></table>
<p>结论：</p>
<ul>
<li>sequence 是一个容器单线程收集，数据量少时性能占优</li>
<li>parallelNoConcurrent 是多个容器多线程并行收集，时间应该花费在合并容器上，性能最差</li>
<li>parallelConcurrent 是一个容器多线程并发收集，在数据量大时性能较优</li>
</ul>
<blockquote>
<p>MethodHandle 性能</p>
</blockquote>
<p>正常方法调用、反射、MethodHandle、Lambda 的性能对比</p>
<table>
<thead>
<tr>
<th align="center">Benchmark</th>
<th align="center">Mode</th>
<th align="center">Cnt</th>
<th align="center">Score</th>
<th align="center">Error</th>
<th align="center">Units</th>
</tr>
</thead>
<tbody><tr>
<td align="center">Sample2.lambda</td>
<td align="center">thrpt</td>
<td align="center">5</td>
<td align="center">389307532.881</td>
<td align="center">± 332213073.039</td>
<td align="center">ops&#x2F;s</td>
</tr>
<tr>
<td align="center">Sample2.method</td>
<td align="center">thrpt</td>
<td align="center">5</td>
<td align="center">157556577.611</td>
<td align="center">± 4048306.620</td>
<td align="center">ops&#x2F;s</td>
</tr>
<tr>
<td align="center">Sample2.origin</td>
<td align="center">thrpt</td>
<td align="center">5</td>
<td align="center">413287866.949</td>
<td align="center">± 65182730.966</td>
<td align="center">ops&#x2F;s</td>
</tr>
<tr>
<td align="center">Sample2.reflection</td>
<td align="center">thrpt</td>
<td align="center">5</td>
<td align="center">91640751.456</td>
<td align="center">± 37969233.369</td>
<td align="center">ops&#x2F;s</td>
</tr>
</tbody></table>
<h1 id="4-实际应用"><a href="#4-实际应用" class="headerlink" title="4. 实际应用"></a>4. 实际应用</h1><h2 id="4-1-数据统计分析"><a href="#4-1-数据统计分析" class="headerlink" title="4.1 数据统计分析"></a>4.1 数据统计分析</h2><blockquote>
<p>每月的销售量</p>
</blockquote>
<p>结果应为</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1970-01 订单数1307</span><br><span class="line">2020-01 订单数14270</span><br><span class="line">2020-02 订单数17995</span><br><span class="line">2020-03 订单数18688</span><br><span class="line">2020-04 订单数11868</span><br><span class="line">2020-05 订单数40334</span><br><span class="line">2020-06 订单数41364</span><br><span class="line">2020-07 订单数76418</span><br><span class="line">2020-08 订单数100007</span><br><span class="line">2020-09 订单数70484</span><br><span class="line">2020-10 订单数104063</span><br><span class="line">2020-11 订单数66060</span><br></pre></td></tr></table></figure>

<ul>
<li>其中 1970-01 应该是数据的问题</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">lines.skip(<span class="number">1</span>)</span><br><span class="line">    .map(l -&gt; l.split(<span class="string">&quot;,&quot;</span>))</span><br><span class="line">    .collect(groupingBy(a -&gt; YearMonth.from(formatter.parse(a[TIME])), </span><br><span class="line">                        TreeMap::<span class="keyword">new</span>, counting()))</span><br><span class="line">    .forEach((k, v) -&gt; &#123;</span><br><span class="line">        System.out.println(k + <span class="string">&quot; 订单数 &quot;</span> + v);</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>销量最高的月份</p>
</blockquote>
<p>结果应为</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1970-01 订单数1307</span><br><span class="line">2020-01 订单数14270</span><br><span class="line">2020-02 订单数17995</span><br><span class="line">2020-03 订单数18688</span><br><span class="line">2020-04 订单数11868</span><br><span class="line">2020-05 订单数40334</span><br><span class="line">2020-06 订单数41364</span><br><span class="line">2020-07 订单数76418</span><br><span class="line">2020-08 订单数100007</span><br><span class="line">2020-09 订单数70484</span><br><span class="line">2020-10 订单数104063  *</span><br><span class="line">2020-11 订单数66060</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">lines.skip(<span class="number">1</span>)</span><br><span class="line">    .map(l -&gt; l.split(<span class="string">&quot;,&quot;</span>))</span><br><span class="line">    .collect(groupingBy(a -&gt; YearMonth.from(formatter.parse(a[TIME])), counting()))</span><br><span class="line">    .entrySet()</span><br><span class="line">    .stream()</span><br><span class="line">    .max(Comparator.comparingLong(Map.Entry::getValue))</span><br><span class="line">    <span class="comment">// 也可以用 Map.Entry.comparingByValue()</span></span><br><span class="line">    .orElse(<span class="literal">null</span>);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>求销量最高的商品</p>
</blockquote>
<p>结果应为</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1515966223517846928=2746</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">lines.skip(<span class="number">1</span>)</span><br><span class="line">    .map(l -&gt; l.split(<span class="string">&quot;,&quot;</span>))</span><br><span class="line">    .collect(groupingBy(a -&gt; a[PRODUCT_ID], counting()))</span><br><span class="line">    .entrySet()</span><br><span class="line">    .stream()</span><br><span class="line">    .max(Comparator.comparingLong(Map.Entry::getValue))</span><br><span class="line">    .orElse(<span class="literal">null</span>);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>下单最多的前10用户</p>
</blockquote>
<p>结果应为</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1.515915625512423e+18 订单数1092</span><br><span class="line">1.5159156255121183e+18 订单数1073</span><br><span class="line">1.515915625512378e+18 订单数1040</span><br><span class="line">1.515915625512377e+18 订单数1028</span><br><span class="line">1.5159156255136955e+18 订单数1002</span><br><span class="line">1.515915625512422e+18 订单数957</span><br><span class="line">1.515915625513446e+18 订单数957</span><br><span class="line">1.515915625513447e+18 订单数928</span><br><span class="line">1.515915625514598e+18 订单数885</span><br><span class="line">1.5159156255147195e+18 订单数869</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">lines.skip(<span class="number">1</span>)</span><br><span class="line">    .map(l -&gt; l.split(<span class="string">&quot;,&quot;</span>))</span><br><span class="line">    .collect(groupingBy(a -&gt; a[USER_ID], counting()))</span><br><span class="line">    .entrySet()</span><br><span class="line">    .stream()</span><br><span class="line">    .sorted(Map.Entry.&lt;String, Long&gt;comparingByValue().reversed())</span><br><span class="line">    .limit(<span class="number">10</span>).forEach(e -&gt; &#123;</span><br><span class="line">        System.out.println(e.getKey() + <span class="string">&quot; 订单数 &quot;</span> + e.getValue());</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>

<p>或者</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MyQueue</span>&lt;E&gt; <span class="keyword">extends</span> <span class="title class_">PriorityQueue</span>&lt;E&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> max;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyQueue</span><span class="params">(Comparator&lt;? <span class="built_in">super</span> E&gt; comparator, <span class="type">int</span> max)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(comparator);</span><br><span class="line">        <span class="built_in">this</span>.max = max;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">offer</span><span class="params">(E e)</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">r</span> <span class="operator">=</span> <span class="built_in">super</span>.offer(e);</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.size() &gt; max) &#123;</span><br><span class="line">            <span class="built_in">this</span>.poll();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> r;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">lines.skip(<span class="number">1</span>)</span><br><span class="line">    .map(l -&gt; l.split(<span class="string">&quot;,&quot;</span>))</span><br><span class="line">    .collect(groupingBy(a -&gt; a[USER_ID], counting()))</span><br><span class="line">    .entrySet()</span><br><span class="line">    .stream()</span><br><span class="line">    .parallel()</span><br><span class="line">    .collect(</span><br><span class="line">            () -&gt; <span class="keyword">new</span> <span class="title class_">MyQueue</span>&lt;&gt;(Map.Entry.comparingByValue(), <span class="number">10</span>),</span><br><span class="line">            MyQueue::offer,</span><br><span class="line">            AbstractQueue::addAll</span><br><span class="line">    );</span><br></pre></td></tr></table></figure>

<blockquote>
<p>每个地区下单最多的用户</p>
</blockquote>
<p>结果应为：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">上海=Optional[1.5159156255127636e+18=634]</span><br><span class="line">广东=Optional[1.515915625512377e+18=1028]</span><br><span class="line">天津=Optional[1.5159156255120858e+18=530]</span><br><span class="line">四川=Optional[1.5159156255121551e+18=572]</span><br><span class="line">浙江=Optional[1.5159156255121183e+18=564]</span><br><span class="line">重庆=Optional[1.515915625512764e+18=632]</span><br><span class="line">湖北=Optional[1.5159156255121183e+18=509]</span><br><span class="line">湖南=Optional[1.5159156255120548e+18=545]</span><br><span class="line">江苏=Optional[1.5159156255122386e+18=551]</span><br><span class="line">海南=Optional[1.5159156255121178e+18=556]</span><br><span class="line">北京=Optional[1.5159156255128172e+18=584]</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">lines.skip(<span class="number">1</span>)</span><br><span class="line">    .map(line -&gt; line.split(<span class="string">&quot;,&quot;</span>))</span><br><span class="line">    .collect(groupingBy(array -&gt; array[USER_REGION], </span><br><span class="line">                        groupingBy(array -&gt; array[USER_ID], counting())))</span><br><span class="line">    .entrySet().stream()</span><br><span class="line">    .map(e -&gt; Map.entry(</span><br><span class="line">            e.getKey(),</span><br><span class="line">            e.getValue().entrySet().stream().max(Map.Entry.comparingByValue())</span><br><span class="line">    ))</span><br><span class="line">    .forEach(System.out::println);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>每个地区下单最多的前3用户</p>
</blockquote>
<p>结果应为</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">上海</span><br><span class="line">--------------------------</span><br><span class="line">1.5159156255127636e+18=634</span><br><span class="line">1.515915625512118e+18=583</span><br><span class="line">1.515915625512422e+18=561</span><br><span class="line">广东</span><br><span class="line">--------------------------</span><br><span class="line">1.515915625512377e+18=1028</span><br><span class="line">1.5159156255121544e+18=572</span><br><span class="line">1.5159156255120845e+18=571</span><br><span class="line">天津</span><br><span class="line">--------------------------</span><br><span class="line">1.5159156255120858e+18=530</span><br><span class="line">1.5159156255122383e+18=504</span><br><span class="line">1.5159156255123333e+18=481</span><br><span class="line">四川</span><br><span class="line">--------------------------</span><br><span class="line">1.5159156255121551e+18=572</span><br><span class="line">1.5159156255123768e+18=568</span><br><span class="line">1.515915625512055e+18=552</span><br><span class="line">浙江</span><br><span class="line">--------------------------</span><br><span class="line">1.5159156255121183e+18=564</span><br><span class="line">1.515915625513058e+18=520</span><br><span class="line">1.515915625512423e+18=513</span><br><span class="line">重庆</span><br><span class="line">--------------------------</span><br><span class="line">1.515915625512764e+18=632</span><br><span class="line">1.5159156255121188e+18=572</span><br><span class="line">1.515915625512085e+18=562</span><br><span class="line">湖北</span><br><span class="line">--------------------------</span><br><span class="line">1.5159156255121183e+18=509</span><br><span class="line">1.515915625512818e+18=508</span><br><span class="line">1.5159156255148017e+18=386</span><br><span class="line">湖南</span><br><span class="line">--------------------------</span><br><span class="line">1.5159156255120548e+18=545</span><br><span class="line">1.5159156255120855e+18=543</span><br><span class="line">1.5159156255134449e+18=511</span><br><span class="line">江苏</span><br><span class="line">--------------------------</span><br><span class="line">1.5159156255122386e+18=551</span><br><span class="line">1.5159156255122842e+18=541</span><br><span class="line">1.5159156255120842e+18=499</span><br><span class="line">海南</span><br><span class="line">--------------------------</span><br><span class="line">1.5159156255121178e+18=556</span><br><span class="line">1.5159156255128174e+18=547</span><br><span class="line">1.5159156255122022e+18=545</span><br><span class="line">北京</span><br><span class="line">--------------------------</span><br><span class="line">1.5159156255128172e+18=584</span><br><span class="line">1.515915625512423e+18=579</span><br><span class="line">1.5159156255123786e+18=558</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">lines.skip(<span class="number">1</span>)</span><br><span class="line">    .map(l -&gt; l.split(<span class="string">&quot;,&quot;</span>))</span><br><span class="line">    .collect(groupingBy(a -&gt; a[USER_REGION], groupingBy(a -&gt; a[USER_ID], counting())))</span><br><span class="line">    <span class="comment">/*.forEach((k,v)-&gt;&#123;</span></span><br><span class="line"><span class="comment">        System.out.println(k);</span></span><br><span class="line"><span class="comment">        System.out.println(&quot;---------------&quot;);</span></span><br><span class="line"><span class="comment">        v.forEach((x,y)-&gt;&#123;</span></span><br><span class="line"><span class="comment">            System.out.println(x + &quot;:&quot; + y);</span></span><br><span class="line"><span class="comment">        &#125;);</span></span><br><span class="line"><span class="comment">    &#125;);*/</span></span><br><span class="line">    .entrySet()</span><br><span class="line">    .stream()</span><br><span class="line">    .map(e -&gt;</span><br><span class="line">        Map.entry(</span><br><span class="line">            e.getKey(),</span><br><span class="line">            e.getValue().entrySet().stream()</span><br><span class="line">                .sorted(Map.Entry.&lt;String, Long&gt;comparingByValue().reversed())</span><br><span class="line">            	.limit(<span class="number">3</span>)</span><br><span class="line">            	.toList()</span><br><span class="line">        )</span><br><span class="line">    ).forEach(e -&gt; &#123;</span><br><span class="line">        System.out.println(e.getKey());</span><br><span class="line">        System.out.println(<span class="string">&quot;--------------------------&quot;</span>);</span><br><span class="line">        e.getValue().forEach(System.out::println);</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>按类别统计销量</p>
</blockquote>
<p>结果应为</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">accessories.bag 订单数 3063</span><br><span class="line">accessories.umbrella 订单数 33</span><br><span class="line">apparel.costume 订单数 2</span><br><span class="line">apparel.glove 订单数 1942</span><br><span class="line">apparel.shirt 订单数 235</span><br><span class="line">apparel.shoes 订单数 2</span><br><span class="line">apparel.sock 订单数 21</span><br><span class="line">apparel.trousers 订单数 99</span><br><span class="line">apparel.tshirt 订单数 372</span><br><span class="line">appliances.environment.air_conditioner 订单数 7379</span><br><span class="line">appliances.environment.air_heater 订单数 2599</span><br><span class="line">appliances.environment.climate 订单数 101</span><br><span class="line">appliances.environment.fan 订单数 3855</span><br><span class="line">appliances.environment.vacuum 订单数 15971</span><br><span class="line">appliances.environment.water_heater 订单数 3644</span><br><span class="line">appliances.iron 订单数 8249</span><br><span class="line">appliances.ironing_board 订单数 2128</span><br><span class="line">appliances.kitchen.blender 订单数 8672</span><br><span class="line">appliances.kitchen.coffee_grinder 订单数 811</span><br><span class="line">appliances.kitchen.coffee_machine 订单数 1250</span><br><span class="line">appliances.kitchen.dishwasher 订单数 2663</span><br><span class="line">appliances.kitchen.fryer 订单数 97</span><br><span class="line">appliances.kitchen.grill 订单数 1579</span><br><span class="line">appliances.kitchen.hood 订单数 9045</span><br><span class="line">appliances.kitchen.juicer 订单数 1187</span><br><span class="line">appliances.kitchen.kettle 订单数 12740</span><br><span class="line">appliances.kitchen.meat_grinder 订单数 4520</span><br><span class="line">appliances.kitchen.microwave 订单数 7615</span><br><span class="line">appliances.kitchen.mixer 订单数 2610</span><br><span class="line">appliances.kitchen.oven 订单数 4000</span><br><span class="line">appliances.kitchen.refrigerators 订单数 20259</span><br><span class="line">appliances.kitchen.steam_cooker 订单数 464</span><br><span class="line">appliances.kitchen.toster 订单数 1381</span><br><span class="line">appliances.kitchen.washer 订单数 14563</span><br><span class="line">appliances.personal.hair_cutter 订单数 2716</span><br><span class="line">appliances.personal.massager 订单数 1724</span><br><span class="line">appliances.personal.scales 订单数 6727</span><br><span class="line">appliances.sewing_machine 订单数 1576</span><br><span class="line">appliances.steam_cleaner 订单数 119</span><br><span class="line">auto.accessories.alarm 订单数 252</span><br><span class="line">auto.accessories.anti_freeze 订单数 109</span><br><span class="line">auto.accessories.compressor 订单数 276</span><br><span class="line">auto.accessories.player 订单数 117</span><br><span class="line">auto.accessories.radar 订单数 80</span><br><span class="line">auto.accessories.videoregister 订单数 533</span><br><span class="line">computers.components.cdrw 订单数 158</span><br><span class="line">computers.components.cooler 订单数 3377</span><br><span class="line">computers.components.cpu 订单数 4147</span><br><span class="line">computers.components.hdd 订单数 5054</span><br><span class="line">computers.components.memory 订单数 1597</span><br><span class="line">computers.components.motherboard 订单数 860</span><br><span class="line">computers.components.power_supply 订单数 986</span><br><span class="line">computers.components.sound_card 订单数 26</span><br><span class="line">computers.components.videocards 订单数 1190</span><br><span class="line">computers.desktop 订单数 1041</span><br><span class="line">computers.ebooks 订单数 397</span><br><span class="line">computers.gaming 订单数 164</span><br><span class="line">computers.network.router 订单数 6473</span><br><span class="line">computers.notebook 订单数 25866</span><br><span class="line">computers.peripherals.camera 订单数 1041</span><br><span class="line">computers.peripherals.joystick 订单数 1192</span><br><span class="line">computers.peripherals.keyboard 订单数 3803</span><br><span class="line">computers.peripherals.monitor 订单数 3272</span><br><span class="line">computers.peripherals.mouse 订单数 12664</span><br><span class="line">computers.peripherals.printer 订单数 3458</span><br><span class="line">computers.peripherals.scanner 订单数 74</span><br><span class="line">construction.components.faucet 订单数 133</span><br><span class="line">construction.tools.drill 订单数 622</span><br><span class="line">construction.tools.generator 订单数 46</span><br><span class="line">construction.tools.heater 订单数 348</span><br><span class="line">construction.tools.light 订单数 10</span><br><span class="line">construction.tools.pump 订单数 65</span><br><span class="line">construction.tools.saw 订单数 169</span><br><span class="line">construction.tools.screw 订单数 2408</span><br><span class="line">construction.tools.welding 订单数 183</span><br><span class="line">country_yard.cultivator 订单数 33</span><br><span class="line">country_yard.lawn_mower 订单数 111</span><br><span class="line">country_yard.watering 订单数 5</span><br><span class="line">country_yard.weather_station 订单数 53</span><br><span class="line">electronics.audio.acoustic 订单数 438</span><br><span class="line">electronics.audio.dictaphone 订单数 12</span><br><span class="line">electronics.audio.headphone 订单数 20084</span><br><span class="line">electronics.audio.microphone 订单数 1062</span><br><span class="line">electronics.audio.subwoofer 订单数 70</span><br><span class="line">electronics.calculator 订单数 35</span><br><span class="line">electronics.camera.photo 订单数 348</span><br><span class="line">electronics.camera.video 订单数 133</span><br><span class="line">electronics.clocks 订单数 6474</span><br><span class="line">electronics.smartphone 订单数 102365</span><br><span class="line">electronics.tablet 订单数 6395</span><br><span class="line">electronics.telephone 订单数 2437</span><br><span class="line">electronics.video.projector 订单数 114</span><br><span class="line">electronics.video.tv 订单数 17618</span><br><span class="line">furniture.bathroom.bath 订单数 232</span><br><span class="line">furniture.bathroom.toilet 订单数 44</span><br><span class="line">furniture.bedroom.bed 订单数 451</span><br><span class="line">furniture.bedroom.blanket 订单数 68</span><br><span class="line">furniture.bedroom.pillow 订单数 1882</span><br><span class="line">furniture.kitchen.chair 订单数 3084</span><br><span class="line">furniture.kitchen.table 订单数 11260</span><br><span class="line">furniture.living_room.cabinet 订单数 3117</span><br><span class="line">furniture.living_room.chair 订单数 1439</span><br><span class="line">furniture.living_room.shelving 订单数 2572</span><br><span class="line">furniture.living_room.sofa 订单数 401</span><br><span class="line">furniture.universal.light 订单数 22</span><br><span class="line">kids.bottles 订单数 63</span><br><span class="line">kids.carriage 订单数 41</span><br><span class="line">kids.dolls 订单数 379</span><br><span class="line">kids.fmcg.diapers 订单数 11</span><br><span class="line">kids.skates 订单数 1159</span><br><span class="line">kids.swing 订单数 8</span><br><span class="line">kids.toys 订单数 643</span><br><span class="line">medicine.tools.tonometer 订单数 1106</span><br><span class="line">sport.bicycle 订单数 569</span><br><span class="line">sport.diving 订单数 10</span><br><span class="line">sport.ski 订单数 17</span><br><span class="line">sport.snowboard 订单数 3</span><br><span class="line">sport.tennis 订单数 87</span><br><span class="line">sport.trainer 订单数 210</span><br><span class="line">stationery.battery 订单数 5210</span><br><span class="line">stationery.cartrige 订单数 2473</span><br><span class="line">stationery.paper 订单数 1085</span><br><span class="line">stationery.stapler 订单数 97</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">lines.skip(<span class="number">1</span>)</span><br><span class="line">       .map(l -&gt; l.split(<span class="string">&quot;,&quot;</span>))</span><br><span class="line">       .filter(a -&gt; !a[CATEGORY_CODE].isEmpty())</span><br><span class="line">       .collect(groupingBy(a -&gt; a[CATEGORY_CODE], TreeMap::<span class="keyword">new</span>, counting()))</span><br><span class="line">       .forEach((k, v) -&gt; &#123;</span><br><span class="line">           System.out.println(k + <span class="string">&quot; 订单数 &quot;</span> + v);</span><br><span class="line">       &#125;);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>按一级类别统计销量</p>
</blockquote>
<p>结果应为</p>
 <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">accessories 订单数 3096</span><br><span class="line">apparel 订单数 2673</span><br><span class="line">appliances 订单数 150244</span><br><span class="line">auto 订单数 1367</span><br><span class="line">computers 订单数 76840</span><br><span class="line">construction 订单数 3984</span><br><span class="line">country_yard 订单数 202</span><br><span class="line">electronics 订单数 157585</span><br><span class="line">furniture 订单数 24572</span><br><span class="line">kids 订单数 2304</span><br><span class="line">medicine 订单数 1106</span><br><span class="line">sport 订单数 896</span><br><span class="line">stationery 订单数 8865</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">lines.skip(<span class="number">1</span>)</span><br><span class="line">    .map(l -&gt; l.split(<span class="string">&quot;,&quot;</span>))</span><br><span class="line">    .filter(a -&gt; !a[CATEGORY_CODE].isEmpty())</span><br><span class="line">    .collect(groupingBy(TestData::firstCategory, TreeMap::<span class="keyword">new</span>, counting()))</span><br><span class="line">    .forEach((k, v) -&gt; &#123;</span><br><span class="line">        System.out.println(k + <span class="string">&quot; 订单数 &quot;</span> + v);</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> String <span class="title function_">firstCategory</span><span class="params">(String[] a)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">category</span> <span class="operator">=</span> a[CATEGORY_CODE];</span><br><span class="line">    <span class="type">int</span> <span class="variable">dot</span> <span class="operator">=</span> category.indexOf(<span class="string">&quot;.&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> category.substring(<span class="number">0</span>, dot);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>按价格区间统计销量</p>
</blockquote>
<ul>
<li>p &lt;100</li>
<li>100&lt;&#x3D; p &lt;500</li>
<li>500&lt;&#x3D;p&lt;1000</li>
<li>1000&lt;&#x3D;p</li>
</ul>
<p>结果应为</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[0,100)=291624</span><br><span class="line">[1000,∞)=14514</span><br><span class="line">[500,1000)=52857</span><br><span class="line">[100,500)=203863</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> String <span class="title function_">priceRange</span><span class="params">(Double price)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (price &lt; <span class="number">100</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;[0,100)&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (price &gt;= <span class="number">100</span> &amp;&amp; price &lt; <span class="number">500</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;[100,500)&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (price &gt;= <span class="number">500</span> &amp;&amp; price &lt; <span class="number">1000</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;[500,1000)&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;[1000,∞)&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">lines.skip(<span class="number">1</span>)</span><br><span class="line">    .map(line -&gt; line.split(<span class="string">&quot;,&quot;</span>))</span><br><span class="line">    .map(array -&gt; Double.parseDouble(array[PRICE]))</span><br><span class="line">    .collect(groupingBy(TestData::priceRange, counting()))</span><br></pre></td></tr></table></figure>

<blockquote>
<p>不同年龄段女性所下不同类别订单</p>
</blockquote>
<ul>
<li>a &lt; 18</li>
<li>18 &lt;&#x3D; a &lt; 30</li>
<li>30 &lt;&#x3D; a &lt; 50</li>
<li>50 &lt;&#x3D; a</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[0,18)       accessories      81</span><br><span class="line">[0,18)       apparel          60</span><br><span class="line">[0,18)       appliances       4326</span><br><span class="line">[0,18)       computers        1984</span><br><span class="line">...</span><br><span class="line">[18,30)      accessories      491</span><br><span class="line">[18,30)      apparel          488</span><br><span class="line">[18,30)      appliances       25240</span><br><span class="line">[18,30)      computers        13076</span><br><span class="line">...</span><br><span class="line">[30,50)      accessories      890</span><br><span class="line">[30,50)      apparel          893</span><br><span class="line">[30,50)      appliances       42755</span><br><span class="line">[30,50)      computers        21490</span><br><span class="line">...</span><br><span class="line">[50,∞)       accessories      41</span><br><span class="line">[50,∞)       apparel          41</span><br><span class="line">[50,∞)       appliances       2255</span><br><span class="line">[50,∞)       computers        1109</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> String <span class="title function_">ageRange</span><span class="params">(String[] array)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">age</span> <span class="operator">=</span> Double.valueOf(array[USER_AGE]).intValue();</span><br><span class="line">    <span class="keyword">if</span> (age &lt; <span class="number">18</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;[0,18)&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (age &lt; <span class="number">30</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;[18,30)&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (age &lt; <span class="number">50</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;[30,50)&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;[50,∞)&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">lines.skip(<span class="number">1</span>)</span><br><span class="line">    .map(line -&gt; line.split(<span class="string">&quot;,&quot;</span>))</span><br><span class="line">    .filter(array -&gt; !array[CATEGORY_CODE].isEmpty())</span><br><span class="line">    .filter(array -&gt; array[USER_SEX].equals(<span class="string">&quot;女&quot;</span>))</span><br><span class="line">    .collect(groupingBy(TestData::ageRange, </span><br><span class="line">                        groupingBy(TestData::firstCategory, TreeMap::<span class="keyword">new</span>, counting())))</span><br></pre></td></tr></table></figure>

<h2 id="4-2-异步处理"><a href="#4-2-异步处理" class="headerlink" title="4.2 异步处理"></a>4.2 异步处理</h2><p>要让一段逻辑异步：</p>
<ul>
<li>需要有独立线程</li>
<li>逻辑需要封装至函数对象，才能让此逻辑不是立刻执行，而是在新线程中的未来某刻执行</li>
</ul>
<p>例 1: 使用<code>ExecutorService</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(<span class="string">&quot;Test&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> (<span class="type">ExecutorService</span> <span class="variable">service</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">2</span>)) &#123;</span><br><span class="line">        logger.info(<span class="string">&quot;开始统计&quot;</span>);</span><br><span class="line">        service.submit(() -&gt; monthlySalesReport(map-&gt;map.entrySet().forEach(e-&gt;logger.info(e.toString()))));</span><br><span class="line">        logger.info(<span class="string">&quot;执行其它操作&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">monthlySalesReport</span><span class="params">(Consumer&lt;Map&lt;YearMonth, Long&gt;&gt; consumer)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> (Stream&lt;String&gt; lines = Files.lines(Path.of(<span class="string">&quot;./data.txt&quot;</span>))) &#123;</span><br><span class="line">        Map&lt;YearMonth, Long&gt; collect = lines.skip(<span class="number">1</span>)</span><br><span class="line">                .map(line -&gt; line.split(<span class="string">&quot;,&quot;</span>))</span><br><span class="line">                .collect(groupingBy(array -&gt; YearMonth.from(formatter.parse(array[TIME])), TreeMap::<span class="keyword">new</span>, counting()));</span><br><span class="line">        consumer.accept(collect);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>缺点：</p>
<ul>
<li>显式使用了线程池</li>
<li>函数对象嵌套使用，可读性差</li>
</ul>
<p>例 2: 使用<code>CompletableFuture</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(<span class="string">&quot;Test&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    logger.info(<span class="string">&quot;开始统计&quot;</span>);</span><br><span class="line">    CompletableFuture</span><br><span class="line">        	.supplyAsync(() -&gt; monthlySalesReport())</span><br><span class="line">            .thenAccept(map -&gt; map.entrySet().forEach(e -&gt; logger.info(e.toString())));</span><br><span class="line">    logger.info(<span class="string">&quot;执行其它操作&quot;</span>);</span><br><span class="line">    Thread.sleep(<span class="number">10000</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Map&lt;YearMonth, Long&gt; <span class="title function_">monthlySalesReport</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> (Stream&lt;String&gt; lines = Files.lines(Path.of(<span class="string">&quot;./data.txt&quot;</span>))) &#123;</span><br><span class="line">        Map&lt;YearMonth, Long&gt; collect = lines.skip(<span class="number">1</span>)</span><br><span class="line">                .map(line -&gt; line.split(<span class="string">&quot;,&quot;</span>))</span><br><span class="line">                .collect(groupingBy(array -&gt; YearMonth.from(formatter.parse(array[TIME])), TreeMap::<span class="keyword">new</span>, counting()));</span><br><span class="line">        <span class="keyword">return</span> collect;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-3-框架设计"><a href="#4-3-框架设计" class="headerlink" title="4.3 框架设计"></a>4.3 框架设计</h2><ul>
<li>什么是框架？<ul>
<li>半成品软件，帮助开发者快速构建应用程序</li>
<li>框架提供的都是固定<strong>不变的</strong>、<strong>已知的</strong>、可以重用的代码</li>
<li>而那些每个应用不同的业务逻辑，<strong>变化的</strong>、<strong>未知的</strong>部分，则在框架外由开发者自己实现</li>
</ul>
</li>
</ul>
<h3 id="4-3-1-将未知交给子类"><a href="#4-3-1-将未知交给子类" class="headerlink" title="4.3.1 将未知交给子类"></a>4.3.1 将未知交给子类</h3><p>Spring 延迟创建 bean</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">classDiagram</span><br><span class="line"></span><br><span class="line">class DefaultSingletonBeanRegistry &#123;</span><br><span class="line">   - singletonObjects: Map</span><br><span class="line">   + getSingleton(name, factory)</span><br><span class="line">&#125;</span><br><span class="line">class AbstractAutowireCapableBeanFactory &#123;</span><br><span class="line">   # createBean(name, definition, args)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DefaultSingletonBeanRegistry &lt;|-- AbstractAutowireCapableBeanFactory</span><br></pre></td></tr></table></figure>

<p>Spring 中的很多类有非常复杂的继承关系，并且它们分工明确，职责是划分好的。例如：</p>
<p><code>DefaultSingletonBeanRegistry</code> 是父类，它有个职责是缓存单例 bean，用下面方法实现</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">getSingleton</span><span class="params">(String beanName, ObjectFactory&lt;?&gt; factory)</span></span><br></pre></td></tr></table></figure>

<p>但如何创建 <code>bean</code>，这个父类是不知道的，创建 <code>bean</code> 是子类 <code>AbstractAutowireCapableBeanFactory</code> 的职责</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Object <span class="title function_">createBean</span><span class="params">(String beanName, RootBeanDefinition mbd, <span class="meta">@Nullable</span> Object[] args)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>父类中 <code>getSingleton</code> 的内部就要使用 <code>singletonFactory</code> 函数对象来获得创建好的对象</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">getSingleton</span><span class="params">(String beanName, ObjectFactory&lt;?&gt; singletonFactory)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="type">Object</span> <span class="variable">singletonObject</span> <span class="operator">=</span> <span class="built_in">this</span>.singletonObjects.get(beanName);</span><br><span class="line">    <span class="keyword">if</span>(singletonObject == <span class="literal">null</span>) &#123;</span><br><span class="line">        ...</span><br><span class="line">        singletonObject = singletonFactory.getObject();</span><br><span class="line">        addSingleton(beanName, singletonObject);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后子类创建单例 <code>bean</code> 时，会把 <code>ObjectFactory</code> 这个函数对象传进去，创建其它 <code>scope bean</code>，不需要用 <code>getSingleton</code> 缓存</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> &lt;T&gt; T <span class="title function_">doGetBean</span><span class="params">(...)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (mbd.isSingleton()) &#123;</span><br><span class="line">        sharedInstance = getSingleton(beanName, () -&gt; &#123;</span><br><span class="line">            ...</span><br><span class="line">            <span class="keyword">return</span> createBean(beanName, mbd, args);</span><br><span class="line">        &#125;); </span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-3-2-将未知交给用户"><a href="#4-3-2-将未知交给用户" class="headerlink" title="4.3.2 将未知交给用户"></a>4.3.2 将未知交给用户</h3><blockquote>
<p>JdbcTemplate</p>
</blockquote>
<p>数据表：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> student (</span><br><span class="line">   id <span class="type">int</span> <span class="keyword">primary</span> key auto_increment,</span><br><span class="line">   name <span class="type">varchar</span>(<span class="number">16</span>),</span><br><span class="line">   sex <span class="type">char</span>(<span class="number">1</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> student <span class="keyword">values</span></span><br><span class="line">	(<span class="number">1</span>, <span class="string">&#x27;赵一伤&#x27;</span>, <span class="string">&#x27;男&#x27;</span>),</span><br><span class="line">	(<span class="number">2</span>, <span class="string">&#x27;钱二败&#x27;</span>, <span class="string">&#x27;男&#x27;</span>),</span><br><span class="line">	(<span class="number">3</span>, <span class="string">&#x27;孙三毁&#x27;</span>, <span class="string">&#x27;男&#x27;</span>),</span><br><span class="line">	(<span class="number">4</span>, <span class="string">&#x27;李四摧&#x27;</span>, <span class="string">&#x27;男&#x27;</span>),</span><br><span class="line">	(<span class="number">5</span>, <span class="string">&#x27;周五输&#x27;</span>, <span class="string">&#x27;男&#x27;</span>),</span><br><span class="line">	(<span class="number">6</span>, <span class="string">&#x27;吴六破&#x27;</span>, <span class="string">&#x27;男&#x27;</span>),</span><br><span class="line">	(<span class="number">7</span>, <span class="string">&#x27;郑七灭&#x27;</span>, <span class="string">&#x27;男&#x27;</span>),</span><br><span class="line">	(<span class="number">8</span>, <span class="string">&#x27;王八衰&#x27;</span>, <span class="string">&#x27;男&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>spring 中 JdbcTemplate 代码：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestJdbc</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">HikariDataSource</span> <span class="variable">dataSource</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HikariDataSource</span>();</span><br><span class="line">        dataSource.setJdbcUrl(<span class="string">&quot;jdbc:mysql://localhost:3306/test&quot;</span>);</span><br><span class="line">        dataSource.setUsername(<span class="string">&quot;root&quot;</span>);</span><br><span class="line">        dataSource.setPassword(<span class="string">&quot;root&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">JdbcTemplate</span> <span class="variable">template</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JdbcTemplate</span>(dataSource);</span><br><span class="line">        <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;select id,name,sex from student&quot;</span>;</span><br><span class="line">        template.query(sql, (rs, index) -&gt; &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">id</span> <span class="operator">=</span> rs.getInt(<span class="string">&quot;id&quot;</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> rs.getString(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">sex</span> <span class="operator">=</span> rs.getString(<span class="string">&quot;sex&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Student</span>(id, name, sex);</span><br><span class="line">        &#125;).forEach(System.out::println);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">record</span> <span class="title class_">Student</span><span class="params">(<span class="type">int</span> id, String name, String sex)</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>对 query 来讲，建立数据库连接，创建 Statement 对象，执行查询这些步骤都是固定的</li>
<li>而结果要如何用 java 对象封装，这对框架代码是未知的，用 <code>RowMapper</code> 接口代表，将来它的 lambda 实现将结果转换成需要的 java 对象</li>
</ul>
<blockquote>
<p>ApplicationListener</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyEvent</span> <span class="keyword">extends</span> <span class="title class_">ApplicationEvent</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyEvent</span><span class="params">(Object source)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(source);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestExtend</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ConfigurableApplicationContext</span> <span class="variable">context</span> </span><br><span class="line">            <span class="operator">=</span> SpringApplication.run(TestExtend.class, args);</span><br><span class="line">        context.publishEvent(<span class="keyword">new</span> <span class="title class_">MyEvent</span>(<span class="string">&quot;context&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ApplicationListener&lt;MyEvent&gt; <span class="title function_">myListener</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (event -&gt; System.out.println(<span class="string">&quot;收到事件:&quot;</span> + event));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RestController</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MyController</span> &#123;</span><br><span class="line">        <span class="meta">@Autowired</span></span><br><span class="line">        <span class="keyword">private</span> ApplicationContext context;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@GetMapping(&quot;/hello&quot;)</span></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">()</span> &#123;</span><br><span class="line">            context.publishEvent(<span class="keyword">new</span> <span class="title class_">MyEvent</span>(<span class="string">&quot;controller&quot;</span>));</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;hello&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>对 spring 来讲，它并不知道如何处理事件</li>
<li>因此可以提供一个类型为 ApplicationListener 的 lambda 对象</li>
</ul>
<h3 id="4-3-3-延迟拼接条件"><a href="#4-3-3-延迟拼接条件" class="headerlink" title="4.3.3 延迟拼接条件"></a>4.3.3 延迟拼接条件</h3><blockquote>
<p>MybatisPlus</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@MapperScan</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestMyBatisPlus</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ConfigurableApplicationContext</span> <span class="variable">context</span> </span><br><span class="line">            <span class="operator">=</span> SpringApplication.run(TestMyBatisPlus.class, args);</span><br><span class="line">        <span class="type">StudentMapper</span> <span class="variable">mapper</span> <span class="operator">=</span> context.getBean(StudentMapper.class);</span><br><span class="line"></span><br><span class="line">        test(mapper, List.of(<span class="string">&quot;赵一伤&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">(StudentMapper mapper, List&lt;String&gt; names)</span> &#123;</span><br><span class="line">        LambdaQueryWrapper&lt;Student&gt; query = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();</span><br><span class="line">        query.in(!names.isEmpty(), Student::getName, names);</span><br><span class="line">        System.out.println(mapper.selectList(query));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>比较典型的用法有两处：</p>
<p>第一，在调用 in 等方法添加条件时，第一个参数是 boolean 为 true 才会拼接 SQL 条件，否则不拼接。</p>
<p>如何实现的呢？用 <code>DoSomething</code> 类型的 lambda 对象来延迟拼接操作：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">DoSomething</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">doIt</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> Children <span class="title function_">maybeDo</span><span class="params">(<span class="type">boolean</span> condition, DoSomething something)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (condition) &#123;</span><br><span class="line">        something.doIt();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> typedThis;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然而，它在实现 <code>()-&gt;appendSqlSegments(...)</code> 拼接时，是不断修改一个 expression 状态变量，为函数编程所不齿。</p>
<h3 id="4-3-4-偏门用法"><a href="#4-3-4-偏门用法" class="headerlink" title="4.3.4 偏门用法"></a>4.3.4 偏门用法</h3><p>第二，如果用 <code>LambdaQueryWrapper</code> 拼接 sql 条件时，<strong>为了取得列名</strong>，采用了这个办法：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Student::getName</span><br></pre></td></tr></table></figure>

<p>它要做的事很简单，但内部实现却比较复杂：</p>
<ol>
<li><font color="red"><strong>必须用 <code>Student::getName</code> 方法引用，而不能用其它 Lambda 对象</strong></font></li>
<li><code>Student::getName</code> 会实现 Serializable 接口，序列化时会把它变成 SerializedLambda</li>
<li>想办法拿到 SerializedLambda 对象（反射调用 writeReplace）</li>
<li>通过 SerializedLambda 能够获得它对应的实际方法，也就是 String getName() 和所在类 Student</li>
<li>再通过方法名推导得到属性名（去掉 is，get）即 name</li>
<li>所在类 Student 知道了，属性名 name 也有了，就可以进一步确定列名</li>
</ol>
<ul>
<li>属性上的 <code>@TableField</code> 指定的列名优先</li>
<li>没有 <code>@TableField</code>，把属性名当作列名</li>
</ul>
<p><strong>PS：</strong></p>
<ul>
<li>不是很喜欢这种做法，比较恶心</li>
<li>但它确实是想做这么一件事：在代码中全面使用 java 的字段名，避免出现数据库的列名</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">	<span class="comment">//(Type1 &amp; Serializable) 实现 Type1 接口的同时实现 Serializable 接口</span></span><br><span class="line">    <span class="comment">//Type1 lambda = (Type1 &amp; Serializable) (a, b) -&gt; a + b;</span></span><br><span class="line">    </span><br><span class="line">    <span class="type">Type2</span> <span class="variable">lambda</span> <span class="operator">=</span> (Type2 &amp; Serializable) Student::getName;</span><br><span class="line">    <span class="comment">// 将 lambda 对象序列化</span></span><br><span class="line">    <span class="type">Method</span> <span class="variable">writeReplace</span> <span class="operator">=</span> lambda.getClass().getDeclaredMethod(<span class="string">&quot;writeReplace&quot;</span>);</span><br><span class="line">    <span class="type">SerializedLambda</span> <span class="variable">serializedLambda</span> <span class="operator">=</span> (SerializedLambda) writeReplace.invoke(lambda);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 得到 lambda 对象使用类、所属类和实现方法名</span></span><br><span class="line">    System.out.println(serializedLambda.getCapturingClass());</span><br><span class="line">    System.out.println(serializedLambda.getImplClass());</span><br><span class="line">    System.out.println(serializedLambda.getImplMethodName());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">Type2</span> &#123;</span><br><span class="line">    String <span class="title function_">get</span><span class="params">(Student student)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">Type1</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="title function_">add</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-4-并行计算"><a href="#4-4-并行计算" class="headerlink" title="4.4 并行计算"></a>4.4 并行计算</h2><p>统计页面的访问次数：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ParallelTest</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="type">Pattern</span> <span class="variable">reg</span> <span class="operator">=</span> Pattern.compile(<span class="string">&quot;(\\S+) - \\[(.+)] (.+) (.+)&quot;</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">FILES</span> <span class="operator">=</span> <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">            sequence();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">sequence</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException, ExecutionException &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        Map&lt;String, Long&gt; m0 = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; FILES; i++) &#123;</span><br><span class="line">            Map&lt;String, Long&gt; mi = one(i);</span><br><span class="line">            m0 = Stream.of(m0, mi)</span><br><span class="line">                    .flatMap(m -&gt; m.entrySet().stream())</span><br><span class="line">                    .collect(toMap(Map.Entry::getKey, Map.Entry::getValue, Long::sum));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">long</span> <span class="variable">sum</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;String, Long&gt; e : m0.entrySet()) &#123;</span><br><span class="line"><span class="comment">//            System.out.println(e);</span></span><br><span class="line">            sum += e.getValue();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(sum);</span><br><span class="line">        System.out.println(<span class="string">&quot;cost: &quot;</span> + (System.currentTimeMillis() - start));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;String, Long&gt; <span class="title function_">one</span><span class="params">(<span class="type">int</span> i)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> (Stream&lt;String&gt; lines = Files.lines(Path.of(String.format(<span class="string">&quot;web_server_access_%d.log&quot;</span>, i)))) &#123;</span><br><span class="line">            <span class="keyword">return</span> lines</span><br><span class="line"><span class="comment">//                            .limit(10)</span></span><br><span class="line">                    .map(reg::matcher)</span><br><span class="line">                    .filter(Matcher::find)</span><br><span class="line">                    .map(matcher -&gt; matcher.group(<span class="number">3</span>))</span><br><span class="line">                    .collect(groupingBy(identity(), counting()));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">parallel</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException, ExecutionException &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        List&lt;CompletableFuture&lt;Map&lt;String, Long&gt;&gt;&gt; futures = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; FILES; i++) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">k</span> <span class="operator">=</span> i;</span><br><span class="line">            CompletableFuture&lt;Map&lt;String, Long&gt;&gt; future = CompletableFuture.supplyAsync(() -&gt; one(k));</span><br><span class="line">            futures.add(future);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        CompletableFuture&lt;Map&lt;String, Long&gt;&gt; f0 = futures.getFirst();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt; futures.size(); i++) &#123;</span><br><span class="line">            f0 = f0.thenCombine(futures.get(i), (m1, m2) -&gt;</span><br><span class="line">                    Stream.of(m1, m2)</span><br><span class="line">                            .flatMap(m -&gt; m.entrySet().stream())</span><br><span class="line">                            .collect(toMap(Map.Entry::getKey, Map.Entry::getValue, Long::sum))</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">        Map&lt;String, Long&gt; map = f0.get();</span><br><span class="line">        <span class="type">long</span> <span class="variable">sum</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;String, Long&gt; e : map.entrySet()) &#123;</span><br><span class="line"><span class="comment">//            System.out.println(e);</span></span><br><span class="line">            sum += e.getValue();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(sum);</span><br><span class="line">        System.out.println(<span class="string">&quot;cost: &quot;</span> + (System.currentTimeMillis() - start));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-5-UI-事件"><a href="#4-5-UI-事件" class="headerlink" title="4.5 UI 事件"></a>4.5 UI 事件</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestUIEvent</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">JFrame</span> <span class="variable">frame</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JFrame</span>(<span class="string">&quot;Lambda Example&quot;</span>);</span><br><span class="line">        <span class="type">JButton</span> <span class="variable">button</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JButton</span>(<span class="string">&quot;Click me&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 使用Lambda表达式定义按钮的点击事件处理程序</span></span><br><span class="line">        button.addActionListener(e -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Button clicked!&quot;</span>);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        frame.add(button);</span><br><span class="line">        frame.setSize(<span class="number">300</span>, <span class="number">200</span>);</span><br><span class="line">        frame.setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);</span><br><span class="line">        frame.setVisible(<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="5-实现原理"><a href="#5-实现原理" class="headerlink" title="5. 实现原理"></a>5. 实现原理</h1><h2 id="5-1-lambda-原理"><a href="#5-1-lambda-原理" class="headerlink" title="5.1 lambda 原理"></a>5.1 lambda 原理</h2><p>以下面代码为例：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestLambda</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        test((a, b) -&gt; a + b);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">(BinaryOperator&lt;Integer&gt; lambda)</span> &#123;</span><br><span class="line">        System.out.println(lambda.apply(<span class="number">1</span>, <span class="number">2</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行结果：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">3</span><br></pre></td></tr></table></figure>

<h3 id="5-1-1-第一步，生成静态方法"><a href="#5-1-1-第一步，生成静态方法" class="headerlink" title="5.1.1 第一步，生成静态方法"></a>5.1.1 第一步，生成静态方法</h3><p>如何证明？用反射</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> (Method method : TestLambda.class.getDeclaredMethods()) &#123;</span><br><span class="line">    System.out.println(method);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出为（去掉了包名，容易阅读）：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> TestLambda.main(java.lang.String[])</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> TestLambda.test(BinaryOperator)</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> java.lang.Integer TestLambda.lambda$main$<span class="number">0</span>(Integer,Integer)</span><br></pre></td></tr></table></figure>

<ul>
<li><p>可以看到除了我们自己写的 main 和 test 以外，多出一个名为 <code>lambda$main$0</code> 的方法</p>
</li>
<li><p>这个方法是在编译期间由编译器生成的方法，是 synthetic（合成）方法</p>
</li>
<li><p>它的参数、内容就是 lambda 表达式提供的参数和内容，如下面代码片段所示</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Integer lambda$main$<span class="number">0</span>(Integer a, Integer b) &#123;</span><br><span class="line">    <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="5-1-2-第二步，生成实现类字节码"><a href="#5-1-2-第二步，生成实现类字节码" class="headerlink" title="5.1.2 第二步，生成实现类字节码"></a>5.1.2 第二步，生成实现类字节码</h3><p>如果是我自己造一个对象包含此方法，可以这么做。</p>
<p>先创建一个类：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">LambdaObject</span> <span class="keyword">implements</span> <span class="title class_">BinaryOperator</span>&lt;Integer&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">apply</span><span class="params">(Integer a, Integer b)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> TestLambda.lambda$main$<span class="number">0</span>(a, b);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>将来使用时，创建对象：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">test(<span class="keyword">new</span> <span class="title class_">LambdaObject</span>());</span><br></pre></td></tr></table></figure>

<p>只不过，jvm 是在运行期间造出的这个类以及对象而已，要想查看这个类</p>
<p>在 jdk 21 中运行时添加虚拟机参数：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">-Djdk.invoke.LambdaMetafactory.dumpProxyClassFiles</span><br></pre></td></tr></table></figure>

<p>早期 jdk 添加的参数是（没有去进行版本比对了）：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">-Djdk.internal.lambda.dumpProxyClasses</span><br></pre></td></tr></table></figure>

<p>若想实现在运行期间生成上述 class 字节码，有两种手段：</p>
<ul>
<li>一是动态代理，jdk 并没有采用这种办法来生成 Lambda 类</li>
<li>二是用 <code>LambdaMetaFactory</code>，它配合 MethodHandle API 在执行时更具性能优势</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestLambda1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        test((a, b) -&gt; a + b);</span><br><span class="line"></span><br><span class="line">        MethodHandles.<span class="type">Lookup</span> <span class="variable">lookup</span> <span class="operator">=</span> MethodHandles.lookup();</span><br><span class="line">        <span class="type">MethodType</span> <span class="variable">factoryType</span> <span class="operator">=</span> MethodType.methodType(BinaryOperator.class);</span><br><span class="line">        <span class="type">MethodType</span> <span class="variable">interfaceMethodType</span> <span class="operator">=</span> MethodType.methodType(Object.class, Object.class, Object.class);</span><br><span class="line">        <span class="type">MethodType</span> <span class="variable">implementsMethodType</span> <span class="operator">=</span> MethodType.methodType(Integer.class, Integer.class, Integer.class);</span><br><span class="line"></span><br><span class="line">        <span class="type">MethodHandle</span> <span class="variable">implementsMethod</span> <span class="operator">=</span> lookup.findStatic(TestLambda1.class, <span class="string">&quot;lambda$main$1&quot;</span>, implementsMethodType);</span><br><span class="line"></span><br><span class="line">        <span class="type">MethodType</span> <span class="variable">lambdaType</span> <span class="operator">=</span> MethodType.methodType(Integer.class, Integer.class, Integer.class);</span><br><span class="line">        <span class="type">CallSite</span> <span class="variable">callSite</span> <span class="operator">=</span> LambdaMetafactory.metafactory(lookup,</span><br><span class="line">                <span class="string">&quot;apply&quot;</span>, factoryType, interfaceMethodType,</span><br><span class="line">                implementsMethod,</span><br><span class="line">                lambdaType);</span><br><span class="line"></span><br><span class="line">        BinaryOperator&lt;Integer&gt; lambda = (BinaryOperator) callSite.getTarget().invoke();</span><br><span class="line">        test(lambda);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> Integer lambda$main$<span class="number">1</span>(Integer a, Integer b) &#123;</span><br><span class="line">        <span class="keyword">return</span> a + b;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">(BinaryOperator&lt;Integer&gt; lambda)</span> &#123;</span><br><span class="line">        System.out.println(lambda.apply(<span class="number">1</span>, <span class="number">2</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中：</p>
<ul>
<li><p>“apply” 是接口方法名</p>
</li>
<li><p>factoryType 是工厂方法长相</p>
</li>
<li><p>interfaceMethodType 是接口方法长相</p>
</li>
<li><p>implementsMethod 是实现方法</p>
<ul>
<li>implementsMethodType 是实现方法长相</li>
</ul>
</li>
<li><p>lambdaType 是实际函数对象长相</p>
</li>
<li><p>callSite.getTarget() 实际是调用实现类的构造方法对应的 mh，最后 invoke 返回函数对象</p>
</li>
</ul>
<h2 id="5-2-方法引用原理"><a href="#5-2-方法引用原理" class="headerlink" title="5.2 方法引用原理"></a>5.2 方法引用原理</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestLambda3</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">		test(String::toLowerCase);</span><br><span class="line">        </span><br><span class="line">        MethodHandles.<span class="type">Lookup</span> <span class="variable">lookup</span> <span class="operator">=</span> MethodHandles.lookup();</span><br><span class="line">        <span class="type">MethodType</span> <span class="variable">factoryType</span> <span class="operator">=</span> MethodType.methodType(Function.class);</span><br><span class="line">        <span class="type">MethodType</span> <span class="variable">interfaceMethodType</span> <span class="operator">=</span> MethodType.methodType(Object.class, Object.class);</span><br><span class="line">        <span class="type">MethodHandle</span> <span class="variable">implementsMethod</span> <span class="operator">=</span> lookup.findVirtual(String.class, <span class="string">&quot;toLowerCase&quot;</span>, MethodType.methodType(String.class));</span><br><span class="line">        <span class="type">MethodType</span> <span class="variable">lambdaType</span> <span class="operator">=</span> MethodType.methodType(String.class, String.class);</span><br><span class="line">        <span class="type">CallSite</span> <span class="variable">callSite</span> <span class="operator">=</span> LambdaMetafactory.metafactory(lookup,</span><br><span class="line">                <span class="string">&quot;apply&quot;</span>, factoryType, interfaceMethodType,</span><br><span class="line">                implementsMethod,</span><br><span class="line">                lambdaType);</span><br><span class="line"></span><br><span class="line">        Function&lt;String, String&gt; lambda = (Function&lt;String, String&gt;) callSite.getTarget().invoke();</span><br><span class="line">        System.out.println(lambda.apply(<span class="string">&quot;Tom&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">(Function&lt;String,String&gt; lambda)</span> &#123;</span><br><span class="line">        System.out.println(lambda.apply(<span class="string">&quot;Tom&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="5-3-闭包原理"><a href="#5-3-闭包原理" class="headerlink" title="5.3 闭包原理"></a>5.3 闭包原理</h2><p>捕获基本类型变量：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line">test((a, b) -&gt; a + b + c);</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">(BinaryOperator&lt;Integer&gt; lambda)</span> &#123;</span><br><span class="line">    System.out.println(lambda.apply(<span class="number">1</span>, <span class="number">2</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>生成一个带 3 个参数的方法，但它和 BinaryOperator 还差一个 int 参数：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> Integer lambda$main$<span class="number">1</span>(<span class="type">int</span> c, Integer a, Integer b) &#123;</span><br><span class="line">    <span class="keyword">return</span> a + b + c;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestLambda2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line"><span class="comment">//        int c = 10;</span></span><br><span class="line"><span class="comment">//        test((a, b) -&gt; a + b + c);</span></span><br><span class="line"></span><br><span class="line">        MethodHandles.<span class="type">Lookup</span> <span class="variable">lookup</span> <span class="operator">=</span> MethodHandles.lookup();</span><br><span class="line">        <span class="type">MethodType</span> <span class="variable">factoryType</span> <span class="operator">=</span> MethodType.methodType(BinaryOperator.class, <span class="type">int</span>.class);</span><br><span class="line">        <span class="type">MethodType</span> <span class="variable">interfaceMethodType</span> <span class="operator">=</span> MethodType.methodType(Object.class, Object.class, Object.class);</span><br><span class="line">        <span class="type">MethodType</span> <span class="variable">implementsMethodType</span> <span class="operator">=</span> MethodType.methodType(Integer.class, <span class="type">int</span>.class, Integer.class, Integer.class);</span><br><span class="line"></span><br><span class="line">        <span class="type">MethodHandle</span> <span class="variable">implementsMethod</span> <span class="operator">=</span> lookup.findStatic(TestLambda2.class, <span class="string">&quot;lambda$main$1&quot;</span>, implementsMethodType);</span><br><span class="line"></span><br><span class="line">        <span class="type">MethodType</span> <span class="variable">lambdaType</span> <span class="operator">=</span> MethodType.methodType(Integer.class, Integer.class, Integer.class);</span><br><span class="line">        <span class="type">CallSite</span> <span class="variable">callSite</span> <span class="operator">=</span> LambdaMetafactory.metafactory(lookup,</span><br><span class="line">                <span class="string">&quot;apply&quot;</span>, factoryType, interfaceMethodType,</span><br><span class="line">                implementsMethod,</span><br><span class="line">                lambdaType);</span><br><span class="line"></span><br><span class="line">        BinaryOperator&lt;Integer&gt; lambda = (BinaryOperator) callSite.getTarget().invoke(<span class="number">10</span>);</span><br><span class="line">        test(lambda);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> Integer lambda$main$<span class="number">1</span>(<span class="type">int</span> c, Integer a, Integer b) &#123;</span><br><span class="line">        <span class="keyword">return</span> a + b + c;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">(BinaryOperator&lt;Integer&gt; lambda)</span> &#123;</span><br><span class="line">        System.out.println(lambda.apply(<span class="number">1</span>, <span class="number">2</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>不同之处：</p>
<ul>
<li>factoryType，除了原本的接口类型之外，多了实现方法第一个参数的类型</li>
<li>产生 lambda 对象的时候，通过 invoke 把这个参数的实际值传进去</li>
</ul>
<p>这样产生的 LambdaType 就是这样，并且生成 Lambda 对象时，c 的值被固定为 10</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">LambdaType</span> <span class="keyword">implements</span> <span class="title class_">BinaryOperator</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> c;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> TestLambda2$$Lambda(<span class="type">int</span> c) &#123;</span><br><span class="line">        <span class="built_in">this</span>.c = c;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">apply</span><span class="params">(Object a, Object b)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> TestLambda2.lambda$main$<span class="number">1</span>(<span class="built_in">this</span>.c, (Integer)a, (Integer)b);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>捕获引用类型变量：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestLambda4</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MyRef</span> &#123;</span><br><span class="line">        <span class="type">int</span> age;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">MyRef</span><span class="params">(<span class="type">int</span> age)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.age = age;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="comment">/*MyRef ref = new MyRef(10);</span></span><br><span class="line"><span class="comment">        test((a, b) -&gt; a + b + ref.age);*/</span></span><br><span class="line"></span><br><span class="line">        MethodHandles.<span class="type">Lookup</span> <span class="variable">lookup</span> <span class="operator">=</span> MethodHandles.lookup();</span><br><span class="line">        <span class="type">MethodType</span> <span class="variable">factoryType</span> <span class="operator">=</span> MethodType.methodType(BinaryOperator.class, MyRef.class);</span><br><span class="line">        <span class="type">MethodType</span> <span class="variable">interfaceMethodType</span> <span class="operator">=</span> MethodType.methodType(Object.class, Object.class, Object.class);</span><br><span class="line">        <span class="type">MethodType</span> <span class="variable">implementsMethodType</span> <span class="operator">=</span> MethodType.methodType(Integer.class, MyRef.class, Integer.class, Integer.class);</span><br><span class="line"></span><br><span class="line">        <span class="type">MethodHandle</span> <span class="variable">implementsMethod</span> <span class="operator">=</span> lookup.findStatic(TestLambda4.class, <span class="string">&quot;lambda$main$1&quot;</span>, implementsMethodType);</span><br><span class="line"></span><br><span class="line">        <span class="type">MethodType</span> <span class="variable">lambdaType</span> <span class="operator">=</span> MethodType.methodType(Integer.class, Integer.class, Integer.class);</span><br><span class="line">        <span class="type">CallSite</span> <span class="variable">callSite</span> <span class="operator">=</span> LambdaMetafactory.metafactory(lookup,</span><br><span class="line">                <span class="string">&quot;apply&quot;</span>, factoryType, interfaceMethodType,</span><br><span class="line">                implementsMethod,</span><br><span class="line">                lambdaType);</span><br><span class="line"></span><br><span class="line">        BinaryOperator&lt;Integer&gt; lambda = (BinaryOperator) callSite.getTarget().bindTo(<span class="keyword">new</span> <span class="title class_">MyRef</span>(<span class="number">20</span>)).invoke();</span><br><span class="line">        test(lambda);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> Integer lambda$main$<span class="number">1</span>(MyRef c, Integer a, Integer b) &#123;</span><br><span class="line">        <span class="keyword">return</span> a + b + c.age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">(BinaryOperator&lt;Integer&gt; lambda)</span> &#123;</span><br><span class="line">        System.out.println(lambda.apply(<span class="number">1</span>, <span class="number">2</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>与捕获基本类型变量类似，不过：</p>
<p>除了</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">callSite.getTarget().invoke(<span class="keyword">new</span> <span class="title class_">MyRef</span>(<span class="number">20</span>));</span><br></pre></td></tr></table></figure>

<p>还可以</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">callSite.getTarget().bindTo(<span class="keyword">new</span> <span class="title class_">MyRef</span>(<span class="number">20</span>)).invoke();</span><br></pre></td></tr></table></figure>

<h2 id="5-4-Stream-构建"><a href="#5-4-Stream-构建" class="headerlink" title="5.4 Stream 构建"></a>5.4 Stream 构建</h2><p>自定义可切分迭代器：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestSpliterator</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MySpliterator</span>&lt;T&gt; <span class="keyword">implements</span> <span class="title class_">Spliterator</span>&lt;T&gt; &#123;</span><br><span class="line">        T[] array;</span><br><span class="line">        <span class="type">int</span> begin;</span><br><span class="line">        <span class="type">int</span> end;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">MySpliterator</span><span class="params">(T[] array, <span class="type">int</span> begin, <span class="type">int</span> end)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.array = array;</span><br><span class="line">            <span class="built_in">this</span>.begin = begin;</span><br><span class="line">            <span class="built_in">this</span>.end = end;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">tryAdvance</span><span class="params">(Consumer&lt;? <span class="built_in">super</span> T&gt; action)</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (begin &gt; end) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            action.accept(array[begin++]);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Spliterator&lt;T&gt; <span class="title function_">trySplit</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (estimateSize() &gt; <span class="number">5</span>) &#123;</span><br><span class="line">                <span class="type">int</span> <span class="variable">mid</span> <span class="operator">=</span> (begin + end) &gt;&gt;&gt; <span class="number">1</span>;</span><br><span class="line">                MySpliterator&lt;T&gt; res = <span class="keyword">new</span> <span class="title class_">MySpliterator</span>&lt;&gt;(array, begin, mid);</span><br><span class="line">                System.out.println(Thread.currentThread().getName() + <span class="string">&quot;=&gt;&quot;</span> + res);</span><br><span class="line">                begin = mid + <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">return</span> res;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> Arrays.toString(Arrays.copyOfRange(array, begin, end + <span class="number">1</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">estimateSize</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> end - begin + <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">characteristics</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> Spliterator.SUBSIZED | Spliterator.ORDERED;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        Integer[] all = <span class="keyword">new</span> <span class="title class_">Integer</span>[]&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">10</span>&#125;;</span><br><span class="line">        MySpliterator&lt;Integer&gt; spliterator = <span class="keyword">new</span> <span class="title class_">MySpliterator</span>&lt;&gt;(all, <span class="number">0</span>, <span class="number">9</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        StreamSupport.stream(spliterator, <span class="literal">false</span>)</span><br><span class="line">                .parallel()</span><br><span class="line">                .forEach(x -&gt; System.out.println(Thread.currentThread().getName() + <span class="string">&quot;:&quot;</span> + x));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>练习：按每次切分固定大小来实现</p>
]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>IDEA启动！！</title>
    <url>/posts/3759/</url>
    <content><![CDATA[<div class="note blue icon-padding flat"><i class="note-icon fas fa-bullhorn"></i><p>本文内容基于 IDEA 2024.1</p>
</div>

<h1 id="0-前言"><a href="#0-前言" class="headerlink" title="0. 前言"></a>0. 前言</h1><h2 id="0-1-IDEA-简介"><a href="#0-1-IDEA-简介" class="headerlink" title="0.1 IDEA 简介"></a>0.1 IDEA 简介</h2><p>百度百科：</p>
<p>IDEA 全称 IntelliJ IDEA，是 Java 编程语言开发的集成环境。IntelliJ IDEA 在业界被公认为最好的 Java 开发工具，尤其在智能代码助手、代码自动提示、重构、JavaEE 支持、各类版本工具（Git、SVN 等）、JUnit、CVS 整合、代码分析、 创新的 GUI 设计等方面的功能可以说是超常的。IDEA 是 <a href="https://baike.baidu.com/item/JetBrains">JetBrains</a> 公司的产品，这家公司总部位于 <a href="https://baike.baidu.com/item/%E6%8D%B7%E5%85%8B/191121?fromtitle=%E6%8D%B7%E5%85%8B%E5%85%B1%E5%92%8C%E5%9B%BD&fromid=418555">捷克共和国</a> 的首都 <a href="https://baike.baidu.com/item/%E5%B8%83%E6%8B%89%E6%A0%BC/632">布拉格</a>，开发人员以严谨著称的东欧程序员为主。它的旗舰版本还支持 HTML，CSS，PHP，MySQL，Python 等。免费版只支持 Java，Kotlin 等少数语言。</p>
<h2 id="0-2-编写目的"><a href="#0-2-编写目的" class="headerlink" title="0.2 编写目的"></a>0.2 编写目的</h2><p>在学习 Java 时，除了安装 Java 环境外，还需要安装一个 IDE（集成开发环境），比如： Eclipse、MyEclipse、IDEA 等等。如今大家使用最多的 Java IDE 是 IDEA。我最开始接触 IDE 的时候是在大一下学期（好像是吧，有点忘记了😅），但是那时候用的是Eclipse，至于原因嘛…当然是老师叫我们安装的咯（我也没办法，那时候啥也不懂，只知道依样画葫芦，老师说啥就是啥，主打一个<del>没主见</del>听话），后来到期末得做项目，被逼无奈去网上找视频<del>学习</del>补习（我保证绝对不是因为平时上课没听，只是单纯觉得自己学得还不够😳），发现网上的大佬们都是使用的IDEA作为开发工具，看着大佬们使用IDEA编写代码真的好丝滑啊<del>IDEA的界面真的比Eclipse好看得太多太多啦！！！</del>，于是我按捺不住想要尝试一下IDEA的心，就去下载了个IDEA，一直用到现在…虽然我已经使用了很久的 IDEA 了，但是并没有熟练运用其特性，仅仅使用了它的自动补全和一些通用快捷键。</p>
<p>本文意在记录一些IDEA常用的 “基本设置” 和 “基本操作” ，方便本人遗忘时快速查询。</p>
<p><font color="red"><strong>PS：本文随着本人在学到新的操作后持续更新…</strong></font></p>
<h2 id="0-3-IDEA-主要优势"><a href="#0-3-IDEA-主要优势" class="headerlink" title="0.3 IDEA 主要优势"></a>0.3 IDEA 主要优势</h2><p>为什么选择IDEA呢？因为IDEA在以下几个方面具有显著的优势：</p>
<ul>
<li><strong>智能化和高效性</strong>：IDEA能够实时分析代码上下文，提供精准的代码补全、自动导入包，甚至预测可能的代码片段，使得编写代码变得更加高效和流畅。</li>
<li><strong>版本控制系统支持</strong>：IDEA支持多种版本控制系统，如Git、SVN等，提供了可视化的版本控制界面，使得开发者能够轻松管理代码变更、分支和合并操作。</li>
<li><strong>强大的重构工具</strong>：IDEA拥有强大的重构工具，支持基于语法的选择，可以方便地选取方法、循环等，并在重构时提供便利。</li>
<li><strong>调试功能</strong>：IDEA提供了强大的调试器，支持断点、变量查看、调用栈追踪等功能，帮助开发者快速定位和解决问题。</li>
<li><strong>性能分析</strong>：通过内置的性能分析工具，开发者可以检测代码的瓶颈，优化程序性能，提高软件运行效率。</li>
<li><strong>丰富的插件扩展</strong>：IDEA支持丰富的插件扩展，开发者可以根据自己的需求定制开发环境，扩展功能范围。</li>
<li><strong>简洁易用的GUI界面</strong>：IDEA具有简洁易用的图形用户界面，使得开发者能够更直观地使用各项功能。</li>
</ul>
<p>什么？看完 IDEA 主要优势有点心动了但是还没有安装 IDEA ？那不妨试试这个😏：<a href="https://blog.idejihuo.com/topics/jetbrains/idea">IDEA免费激活教程和方法</a></p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/IDEA/IDEA%E4%B8%8A%E5%8F%B7.png" alt="IDEA上号"></p>
<h1 id="1-IDEA设置"><a href="#1-IDEA设置" class="headerlink" title="1. IDEA设置"></a>1. IDEA设置</h1><h2 id="1-1-设置整体主题"><a href="#1-1-设置整体主题" class="headerlink" title="1.1 设置整体主题"></a>1.1 设置整体主题</h2><h3 id="1-1-1-设置主题"><a href="#1-1-1-设置主题" class="headerlink" title="1.1.1 设置主题"></a>1.1.1 设置主题</h3><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/IDEA/IDEA%E8%AE%BE%E7%BD%AE-%E8%AE%BE%E7%BD%AE%E4%B8%BB%E9%A2%98.png" alt="IDEA设置-设置主题" style="zoom:50%;">

<p>个人比较推荐 <code>Dark</code> 主题，护眼又炫酷，暗黑炫酷风！帅！！</p>
<h3 id="1-1-2-设置菜单和窗口字体和大小"><a href="#1-1-2-设置菜单和窗口字体和大小" class="headerlink" title="1.1.2 设置菜单和窗口字体和大小"></a>1.1.2 设置菜单和窗口字体和大小</h3><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/IDEA/IDEA%E8%AE%BE%E7%BD%AE-%E8%AE%BE%E7%BD%AE%E8%8F%9C%E5%8D%95%E5%92%8C%E7%AA%97%E5%8F%A3%E5%AD%97%E4%BD%93%E5%92%8C%E5%A4%A7%E5%B0%8F.png" alt="IDEA设置-设置菜单和窗口字体和大小" style="zoom:50%;">

<h3 id="1-1-3-设置背景图"><a href="#1-1-3-设置背景图" class="headerlink" title="1.1.3 设置背景图"></a>1.1.3 设置背景图</h3><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/IDEA/IDEA%E8%AE%BE%E7%BD%AE-%E8%AE%BE%E7%BD%AE%E8%83%8C%E6%99%AF%E5%9B%BE.png" alt="IDEA设置-设置背景图" style="zoom:50%;">

<h2 id="1-2-设置编辑器主题样式"><a href="#1-2-设置编辑器主题样式" class="headerlink" title="1.2 设置编辑器主题样式"></a>1.2 设置编辑器主题样式</h2><h3 id="1-2-1-编辑器主题"><a href="#1-2-1-编辑器主题" class="headerlink" title="1.2.1 编辑器主题"></a>1.2.1 编辑器主题</h3><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/IDEA/IDEA%E8%AE%BE%E7%BD%AE-%E7%BC%96%E8%BE%91%E5%99%A8%E4%B8%BB%E9%A2%98.png" alt="IDEA设置-编辑器主题" style="zoom:50%;">

<h3 id="1-2-2-编辑器字体大小"><a href="#1-2-2-编辑器字体大小" class="headerlink" title="1.2.2 编辑器字体大小"></a>1.2.2 编辑器字体大小</h3><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/IDEA/IDEA%E8%AE%BE%E7%BD%AE-%E7%BC%96%E8%BE%91%E5%99%A8%E5%AD%97%E4%BD%93%E5%A4%A7%E5%B0%8F.png" alt="IDEA设置-编辑器字体大小" style="zoom:50%;">

<p>编辑器更详细的字体与颜色：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/IDEA/IDEA%E8%AE%BE%E7%BD%AE-%E7%BC%96%E8%BE%91%E5%99%A8%E6%9B%B4%E8%AF%A6%E7%BB%86%E7%9A%84%E5%AD%97%E4%BD%93%E4%B8%8E%E9%A2%9C%E8%89%B2.png" alt="IDEA设置-编辑器更详细的字体与颜色" style="zoom:50%;">

<p>PS：如果选择某个font字体，中文乱码，可以在fallback font（备选字体）中选择一个支持中文的字体。</p>
<h3 id="1-2-3-注释的字体"><a href="#1-2-3-注释的字体" class="headerlink" title="1.2.3 注释的字体"></a>1.2.3 注释的字体</h3><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/IDEA/IDEA%E8%AE%BE%E7%BD%AE-%E6%B3%A8%E9%87%8A%E7%9A%84%E5%AD%97%E4%BD%93.png" alt="IDEA设置-注释的字体" style="zoom: 67%;">

<p><code>Block comment</code>：修改多行注释的字体颜色 </p>
<p><code>Doc Comment</code> —&gt; <code>Text</code>：修改文档注释的字体颜色 </p>
<p><code>Line comment</code>：修改单行注释的字体颜色</p>
<p>我这里将 <code>Block comment</code> 和 <code>Line comment</code> 都设置为了 <font color="37A5B5"><code>37A5B5</code></font> ,个人觉得配合 Dark 主题使用还是很帅的，当然你也可以选择自己喜欢到颜色🤭</p>
<h2 id="1-3-默认启动项目配置"><a href="#1-3-默认启动项目配置" class="headerlink" title="1.3 默认启动项目配置"></a>1.3 默认启动项目配置</h2><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/IDEA/IDEA%E8%AE%BE%E7%BD%AE-%E9%BB%98%E8%AE%A4%E5%90%AF%E5%8A%A8%E9%A1%B9%E7%9B%AE%E9%85%8D%E7%BD%AE.png" alt="IDEA设置-默认启动项目配置" style="zoom:50%;">

<p>启动IDEA时，默认自动打开上次开发的项目？还是自己选择？ </p>
<p>如果去掉<code>Reopen last project on startup</code>前面的 <code>√</code> ，每次启动IDEA就会出现如下界面：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/IDEA/IDEA%E5%90%AF%E5%8A%A8%E7%95%8C%E9%9D%A2.png" alt="IDEA启动界面" style="zoom: 50%;">

<h2 id="1-4-取消自动更新"><a href="#1-4-取消自动更新" class="headerlink" title="1.4 取消自动更新"></a>1.4 取消自动更新</h2><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/IDEA/IDEA%E8%AE%BE%E7%BD%AE-%E5%8F%96%E6%B6%88%E8%87%AA%E5%8A%A8%E6%9B%B4%E6%96%B0.png" alt="IDEA设置-取消自动更新" style="zoom:50%;">

<p>默认都打 <code>√</code> 了，建议检查IDE更新的 <code>√</code> 去掉，检查插件更新的 <code>√</code> 选上。</p>
<h2 id="1-5-忽略大小写"><a href="#1-5-忽略大小写" class="headerlink" title="1.5 忽略大小写"></a>1.5 忽略大小写</h2><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/IDEA/IDEA%E8%AE%BE%E7%BD%AE-%E5%BF%BD%E7%95%A5%E5%A4%A7%E5%B0%8F%E5%86%99.png" alt="IDEA设置-忽略大小写" style="zoom:50%;">

<p>IntelliJ IDEA 的代码提示和补充功能有一个特性： <code>区分大小写</code> 。 如果想不区分大小写的话，就把这个 <code>√</code> 去掉。 <code>建议去掉勾选</code> 。</p>
<h2 id="1-6-自动导包配置"><a href="#1-6-自动导包配置" class="headerlink" title="1.6 自动导包配置"></a>1.6 自动导包配置</h2><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/IDEA/IDEA%E8%AE%BE%E7%BD%AE-%E8%87%AA%E5%8A%A8%E5%AF%BC%E5%8C%85%E9%85%8D%E7%BD%AE.png" alt="IDEA设置-自动导包配置" style="zoom:50%;">

<p>默认需要自己手动导包，<code>Alt+Enter</code> 快捷键</p>
<p>自动导包设置 ：</p>
<ul>
<li>动态导入明确的包：<code>Add unambiguous imports on the fly</code>，该设置具有全局性</li>
<li>优化动态导入的包：<code>Optimize imports on the fly</code>，该设置只对当前项目有效</li>
</ul>
<p>懒人一定要做的设置😄，不过有时候需要检查自动导的包是否正确，导到错误的包就麻烦咯🤣</p>
<h2 id="1-7-设置项目文件编码"><a href="#1-7-设置项目文件编码" class="headerlink" title="1.7 设置项目文件编码"></a>1.7 设置项目文件编码</h2><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/IDEA/IDEA%E8%AE%BE%E7%BD%AE-%E8%AE%BE%E7%BD%AE%E9%A1%B9%E7%9B%AE%E6%96%87%E4%BB%B6%E7%BC%96%E7%A0%81.png" alt="IDEA设置-设置项目文件编码" style="zoom:50%;">

<p>说明： <code>Transparent native-to-ascii conversion</code> 主要用于转换 <code>ascii</code>，显式原生内容。一般都要勾选。</p>
<h2 id="1-8-设置控制台的字符编码"><a href="#1-8-设置控制台的字符编码" class="headerlink" title="1.8 设置控制台的字符编码"></a>1.8 设置控制台的字符编码</h2><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/IDEA/IDEA%E8%AE%BE%E7%BD%AE-%E8%AE%BE%E7%BD%AE%E6%8E%A7%E5%88%B6%E5%8F%B0%E7%9A%84%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81.png" alt="IDEA设置-设置控制台的字符编码" style="zoom:50%;">

<h2 id="1-9-修改类头的文档注释信息"><a href="#1-9-修改类头的文档注释信息" class="headerlink" title="1.9 修改类头的文档注释信息"></a>1.9 修改类头的文档注释信息</h2><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/IDEA/IDEA%E8%AE%BE%E7%BD%AE-%E4%BF%AE%E6%94%B9%E7%B1%BB%E5%A4%B4%E7%9A%84%E6%96%87%E6%A1%A3%E6%B3%A8%E9%87%8A%E4%BF%A1%E6%81%AF.png" alt="IDEA设置-修改类头的文档注释信息" style="zoom:50%;">

<p>比如：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Package: $&#123;PACKAGE_NAME&#125;</span></span><br><span class="line"><span class="comment">* ClassName: $&#123;NAME&#125;</span></span><br><span class="line"><span class="comment">* Description:</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* <span class="doctag">@Author</span> 木又枯了</span></span><br><span class="line"><span class="comment">* <span class="doctag">@Create</span> $&#123;DATE&#125; $&#123;TIME&#125;</span></span><br><span class="line"><span class="comment">**/</span></span><br></pre></td></tr></table></figure>

<p>常用的预设的变量，这里直接贴出官网给的：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">$&#123;PACKAGE_NAME&#125; — Name of the <span class="keyword">package</span> in which the <span class="keyword">new</span> <span class="title class_">file</span> is created</span><br><span class="line">$&#123;USER&#125; — Current user system login name</span><br><span class="line">$&#123;DATE&#125; — Current system date</span><br><span class="line">$&#123;TIME&#125; — Current system time</span><br><span class="line">$&#123;YEAR&#125; — Current year</span><br><span class="line">$&#123;MONTH&#125; — Current month</span><br><span class="line">$&#123;MONTH_NAME_SHORT&#125; — First <span class="number">3</span> letters of the current month name. Example: Jan, Feb, etc.</span><br><span class="line">$&#123;MONTH_NAME_FULL&#125; — Full name of the current month. Example: January, February, etc.</span><br><span class="line">$&#123;DAY&#125; — Current day of the month</span><br><span class="line">$&#123;DAY_NAME_SHORT&#125; — First <span class="number">3</span> letters of the current day name. Example: Mon, Tue, etc.</span><br><span class="line">$&#123;DAY_NAME_FULL&#125; — Full name of the current day. Example: Monday, Tuesday, etc.</span><br><span class="line">$&#123;HOUR&#125; — Current hour</span><br><span class="line">$&#123;MINUTE&#125; — Current minute</span><br><span class="line">$&#123;PROJECT_NAME&#125; — Name of the current project</span><br></pre></td></tr></table></figure>

<h2 id="1-10-设置自动编译"><a href="#1-10-设置自动编译" class="headerlink" title="1.10 设置自动编译"></a>1.10 设置自动编译</h2><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/IDEA/IDEA%E8%AE%BE%E7%BD%AE-%E8%AE%BE%E7%BD%AE%E8%87%AA%E5%8A%A8%E7%BC%96%E8%AF%91.png" alt="IDEA设置-设置自动编译" style="zoom:50%;">

<h1 id="2-IDEA常用快捷键"><a href="#2-IDEA常用快捷键" class="headerlink" title="2. IDEA常用快捷键"></a>2. IDEA常用快捷键</h1><p>一些通用的快捷键就懒得写了…🤣直接上帅的</p>
<h2 id="2-1-提高编写速度（上）"><a href="#2-1-提高编写速度（上）" class="headerlink" title="2.1 提高编写速度（上）"></a>2.1 提高编写速度（上）</h2><table>
<thead>
<tr>
<th align="center">快捷键</th>
<th align="center">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center">Ctrl + D</td>
<td align="center">复制一行</td>
</tr>
<tr>
<td align="center">Ctrl + Y</td>
<td align="center">删除一行</td>
</tr>
<tr>
<td align="center">Ctrl + J</td>
<td align="center">提示代码模板</td>
</tr>
<tr>
<td align="center">Ctrl + Alt + T</td>
<td align="center">使用XXX代码块环绕</td>
</tr>
<tr>
<td align="center">Alt + Enter</td>
<td align="center">智能提示</td>
</tr>
<tr>
<td align="center">Alt + Insert</td>
<td align="center">调出生成getter&#x2F;setter&#x2F;构造器等结构</td>
</tr>
<tr>
<td align="center">Ctrl + Alt + V</td>
<td align="center">自动生成变量</td>
</tr>
<tr>
<td align="center">Ctrl + Alt + Enter</td>
<td align="center">在上一行插入</td>
</tr>
<tr>
<td align="center">Shift + Enter</td>
<td align="center">在下一行插入</td>
</tr>
<tr>
<td align="center">Ctrl + Shift + 方向键</td>
<td align="center">移动代码</td>
</tr>
<tr>
<td align="center">Ctrl + P</td>
<td align="center">提示方法参数</td>
</tr>
</tbody></table>
<p>Alt 与鼠标结合可以实现批量修改，具体操作是： 按住 Alt 键，再按住鼠标左键，然后移动鼠标，可以让光标延长多行，以实现批量修改。</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/IDEA/%E5%BF%AB%E6%8D%B7%E6%96%B9%E5%BC%8F-Alt%E4%B8%8E%E9%BC%A0%E6%A0%87%E7%BB%93%E5%90%88%E5%AE%9E%E7%8E%B0%E6%89%B9%E9%87%8F%E4%BF%AE%E6%94%B9.gif" alt="快捷方式-Alt与鼠标结合实现批量修改" style="zoom:67%;">

<h2 id="2-2-提高编写速度（下）"><a href="#2-2-提高编写速度（下）" class="headerlink" title="2.2 提高编写速度（下）"></a>2.2 提高编写速度（下）</h2><table>
<thead>
<tr>
<th align="center">快捷键</th>
<th align="center">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center">Shift + F6</td>
<td align="center">批量修改指定的变量名、方法名、类名等</td>
</tr>
<tr>
<td align="center">Ctrl + Alt + M</td>
<td align="center">抽取方法</td>
</tr>
<tr>
<td align="center">Ctrl + O</td>
<td align="center">重写父类的方法</td>
</tr>
<tr>
<td align="center">Ctrl + I</td>
<td align="center">实现接口的方法</td>
</tr>
<tr>
<td align="center">Ctrl + Shift + U</td>
<td align="center">选中的结构的大小写的切换</td>
</tr>
<tr>
<td align="center">Ctrl + Alt + O</td>
<td align="center">批量导包</td>
</tr>
</tbody></table>
<h2 id="2-3-类结构、查找和查看源码"><a href="#2-3-类结构、查找和查看源码" class="headerlink" title="2.3 类结构、查找和查看源码"></a>2.3 类结构、查找和查看源码</h2><table>
<thead>
<tr>
<th align="center">快捷键</th>
<th align="center">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center">Shift + Shift</td>
<td align="center">全能！ 查看文件、类、方法、内容等等</td>
</tr>
<tr>
<td align="center">Ctrl + 选中指定的结构 或 Ctrl  + N</td>
<td align="center">查看源码</td>
</tr>
<tr>
<td align="center">Ctrl + F12</td>
<td align="center">显示当前类结构，支持搜索指定的方法、属性等</td>
</tr>
<tr>
<td align="center">Ctrl + Alt + ←</td>
<td align="center">退回到前一个编辑的页面</td>
</tr>
<tr>
<td align="center">Ctrl + Alt + →</td>
<td align="center">进入到下一个编辑的页面</td>
</tr>
<tr>
<td align="center">Alt + ←&#x2F;→</td>
<td align="center">打开的类文件之间切换</td>
</tr>
<tr>
<td align="center">Ctrl + H</td>
<td align="center">光标选中指定的类，查看继承树结构</td>
</tr>
<tr>
<td align="center">Ctrl + Q</td>
<td align="center">查看方法文档</td>
</tr>
<tr>
<td align="center">Ctrl + Alt + U</td>
<td align="center">类的UML关系图</td>
</tr>
<tr>
<td align="center">Ctrl + G</td>
<td align="center">定位某行</td>
</tr>
<tr>
<td align="center">Ctrl + Alt + B</td>
<td align="center">回溯变量或方法的来源</td>
</tr>
<tr>
<td align="center">Ctrl + Shift + -</td>
<td align="center">折叠方法实现</td>
</tr>
<tr>
<td align="center">Ctrl + Shift + +</td>
<td align="center">展开方法实现</td>
</tr>
</tbody></table>
<h2 id="2-4-查找、替换与关闭"><a href="#2-4-查找、替换与关闭" class="headerlink" title="2.4 查找、替换与关闭"></a>2.4 查找、替换与关闭</h2><table>
<thead>
<tr>
<th align="center">快捷键</th>
<th align="center">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center">Ctrl + E</td>
<td align="center">查看最近访问的文件</td>
</tr>
<tr>
<td align="center">Ctrl + F</td>
<td align="center">整个页面中查找</td>
</tr>
<tr>
<td align="center">Ctrl + L</td>
<td align="center">快速查找：选中的Word快速定位到下一个</td>
</tr>
<tr>
<td align="center">Ctrl + R</td>
<td align="center">查找与替换</td>
</tr>
<tr>
<td align="center">Home</td>
<td align="center">直接定位到当前行的首位</td>
</tr>
<tr>
<td align="center">End</td>
<td align="center">直接定位到当前行的末位</td>
</tr>
<tr>
<td align="center">Ctrl + F7</td>
<td align="center">查询当前元素在当前文件中的引用，然后按 F3 可以选择</td>
</tr>
<tr>
<td align="center">Ctrl + Shift + F</td>
<td align="center">全项目搜索文本</td>
</tr>
<tr>
<td align="center">Ctrl + F4</td>
<td align="center">关闭当前窗口</td>
</tr>
</tbody></table>
<h2 id="2-5-调整格式"><a href="#2-5-调整格式" class="headerlink" title="2.5 调整格式"></a>2.5 调整格式</h2><table>
<thead>
<tr>
<th align="center">快捷键</th>
<th align="center">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center">Ctrl + &#x2F;</td>
<td align="center">单行注释</td>
</tr>
<tr>
<td align="center">Ctrl + Shift + &#x2F;</td>
<td align="center">多行注释</td>
</tr>
<tr>
<td align="center">Ctrl + Alt + L</td>
<td align="center">格式化代码</td>
</tr>
<tr>
<td align="center">Tab</td>
<td align="center">选中数行，整体往后移动</td>
</tr>
<tr>
<td align="center">Shift + Tab</td>
<td align="center">选中数行，整体往前移动</td>
</tr>
</tbody></table>
<h2 id="2-6-Debug快捷键"><a href="#2-6-Debug快捷键" class="headerlink" title="2.6 Debug快捷键"></a>2.6 Debug快捷键</h2><table>
<thead>
<tr>
<th align="center">快捷键</th>
<th align="center">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center">F7</td>
<td align="center">单步调试（进入函数内部）</td>
</tr>
<tr>
<td align="center">F8</td>
<td align="center">单步调试（不进入函数内部）</td>
</tr>
<tr>
<td align="center">Alt + Shift + F7</td>
<td align="center">强制单步调试（进入函数内部）</td>
</tr>
<tr>
<td align="center">Shift + F7</td>
<td align="center">选择要进入的函数</td>
</tr>
<tr>
<td align="center">Shift + F8</td>
<td align="center">跳出函数</td>
</tr>
<tr>
<td align="center">Alt + F9</td>
<td align="center">运行到断点</td>
</tr>
<tr>
<td align="center">F9</td>
<td align="center">继续执行，进入下一个断点或执行完程序</td>
</tr>
<tr>
<td align="center">Ctrl + F2</td>
<td align="center">停止</td>
</tr>
<tr>
<td align="center">Ctrl + Shift + F8</td>
<td align="center">查看断点</td>
</tr>
<tr>
<td align="center">Ctrl + F4</td>
<td align="center">关闭</td>
</tr>
</tbody></table>
<h1 id="3-IDEA常用自动补全"><a href="#3-IDEA常用自动补全" class="headerlink" title="3. IDEA常用自动补全"></a>3. IDEA常用自动补全</h1><h2 id="3-1-后缀代码补全"><a href="#3-1-后缀代码补全" class="headerlink" title="3.1 后缀代码补全"></a>3.1 后缀代码补全</h2><p>使用后缀代码自动补全能够减少在编程时光标向后跳跃。</p>
<p>后缀提示已经成为基本提示的一部分，可以使用快捷键 <code>Ctrl + J</code> 直接呼出后缀提示。</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/IDEA/%E5%91%BC%E5%87%BA%E5%90%8E%E7%BC%80%E6%8F%90%E7%A4%BA.gif" alt="呼出后缀提示" style="zoom: 67%;">

<blockquote>
<p>常用后缀表达式</p>
</blockquote>
<p><strong>var</strong> ： 声明变量，效果与快捷键 <code>Alt + Enter</code> 类似</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/IDEA/%E5%B8%B8%E7%94%A8%E5%90%8E%E7%BC%80%E8%A1%A8%E8%BE%BE%E5%BC%8F-var.gif" alt="常用后缀表达式-var" style="zoom:67%;">

<p><strong>null</strong> ：判断某个表达式是否为空</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/IDEA/%E5%B8%B8%E7%94%A8%E5%90%8E%E7%BC%80%E8%A1%A8%E8%BE%BE%E5%BC%8F-null.gif" alt="常用后缀表达式-null" style="zoom:67%;">

<p><strong>notnull &#x2F; nn</strong> ： 判断某个表达式是否非空</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/IDEA/%E5%B8%B8%E7%94%A8%E5%90%8E%E7%BC%80%E8%A1%A8%E8%BE%BE%E5%BC%8F-nnAndnotnull.gif" alt="常用后缀表达式-nn / notnull" style="zoom:67%;">

<p><strong>for</strong> ：增强型遍历</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/IDEA/%E5%B8%B8%E7%94%A8%E5%90%8E%E7%BC%80%E8%A1%A8%E8%BE%BE%E5%BC%8F-for.gif" alt="常用后缀表达式-for" style="zoom:67%;">

<p><strong>fori</strong> ：带索引的遍历（正序）</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/IDEA/%E5%B8%B8%E7%94%A8%E5%90%8E%E7%BC%80%E8%A1%A8%E8%BE%BE%E5%BC%8F-fori.gif" alt="常用后缀表达式-fori" style="zoom:67%;">

<p><strong>forr</strong> ：带索引的遍历（倒序）</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/IDEA/%E5%B8%B8%E7%94%A8%E5%90%8E%E7%BC%80%E8%A1%A8%E8%BE%BE%E5%BC%8F-forr.gif" alt="常用后缀表达式-forr" style="zoom:67%;">

<p><strong>not</strong> ：对布尔类型取反</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/IDEA/%E5%B8%B8%E7%94%A8%E5%90%8E%E7%BC%80%E8%A1%A8%E8%BE%BE%E5%BC%8F-not.gif" alt="常用后缀表达式-not" style="zoom:67%;">

<p><strong>if</strong> ：条件判断</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/IDEA/%E5%B8%B8%E7%94%A8%E5%90%8E%E7%BC%80%E8%A1%A8%E8%BE%BE%E5%BC%8F-if.gif" alt="常用后缀表达式-if" style="zoom:67%;">

<p><strong>cast</strong> ： 强制类型转换</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/IDEA/%E5%B8%B8%E7%94%A8%E5%90%8E%E7%BC%80%E8%A1%A8%E8%BE%BE%E5%BC%8F-cast.gif" alt="常用后缀表达式-cast" style="zoom:67%;">

<p><strong>return</strong> ： 返回某个值</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/IDEA/%E5%B8%B8%E7%94%A8%E5%90%8E%E7%BC%80%E8%A1%A8%E8%BE%BE%E5%BC%8F-return.gif" alt="常用后缀表达式-return" style="zoom:67%;">

<p><strong>try</strong> ：自动添加try catch</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/IDEA/%E5%B8%B8%E7%94%A8%E5%90%8E%E7%BC%80%E8%A1%A8%E8%BE%BE%E5%BC%8F-try.gif" alt="常用后缀表达式-try" style="zoom:67%;">

<p><strong>twr</strong> ： 在 try-with-resources 块中插入语句</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/IDEA/%E5%B8%B8%E7%94%A8%E5%90%8E%E7%BC%80%E8%A1%A8%E8%BE%BE%E5%BC%8F-twr.gif" alt="常用后缀表达式-twr" style="zoom: 67%;">

<p><strong>while</strong> ：布尔表达式为 true 时进行循环</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/IDEA/%E5%B8%B8%E7%94%A8%E5%90%8E%E7%BC%80%E8%A1%A8%E8%BE%BE%E5%BC%8F-while.gif" alt="常用后缀表达式-while" style="zoom:67%;">

<h2 id="3-2-代码模板"><a href="#3-2-代码模板" class="headerlink" title="3.2 代码模板"></a>3.2 代码模板</h2><p><strong>psvm</strong> ：快速生成<code>main</code>方法，或者直接输入 <strong>main</strong> 也是一样的效果哦😁</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/IDEA/%E4%BB%A3%E7%A0%81%E6%A8%A1%E6%9D%BF-psvm.gif" alt="代码模板-psvm" style="zoom:67%;">

<p><strong>sout</strong> ：快速生成控制台输出打印语句</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/IDEA/%E4%BB%A3%E7%A0%81%E6%A8%A1%E6%9D%BF-sout.gif" alt="代码模板-sout" style="zoom:67%;">

<p><strong>soup</strong> ：快速打印所有参数</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/IDEA/%E4%BB%A3%E7%A0%81%E6%A8%A1%E6%9D%BF-soutp.gif" alt="代码模板-soutp" style="zoom:67%;">

<p><strong>dep</strong> ：maven的pom配置自动补全dependency</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/IDEA/%E4%BB%A3%E7%A0%81%E6%A8%A1%E6%9D%BF-dep.gif" alt="代码模板-dep" style="zoom:67%;">

<p><strong>pl</strong> ：maven的pom配置自动补全plugin</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/IDEA/%E4%BB%A3%E7%A0%81%E6%A8%A1%E6%9D%BF-pl.gif" alt="代码模板-pl" style="zoom:67%;">

<p><strong>repo</strong> ：maven的pom配置自动补全repository</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/IDEA/%E4%BB%A3%E7%A0%81%E6%A8%A1%E6%9D%BF-repo.gif" alt="代码模板-repo" style="zoom:67%;">

<h1 id="4-源码阅读利器"><a href="#4-源码阅读利器" class="headerlink" title="4. 源码阅读利器"></a>4. 源码阅读利器</h1><p>平时在阅读源码的时候都会使用到 IDEA 的 Diagram，它可以使得结果一目了然，简直好用到炸裂👍。但是每次阅读的时候都因为对它不够熟悉而不得不去百度，及其浪费时间<del>阅读五分钟，百度半小时</del>😵，为了省去每次使用都去百度的时间，所以在此记下一些常用操作。</p>
<h2 id="4-1-查看图形形式的继承链"><a href="#4-1-查看图形形式的继承链" class="headerlink" title="4.1 查看图形形式的继承链"></a>4.1 查看图形形式的继承链</h2><p><strong>光标定位在你想查看的类上</strong> 或 <strong>选中在你想查看的类的标签页内</strong>，点击右键，选择 <code>Diagrams</code>，其中有 <code>Show Diagram...</code> 和 <code>Show Diagram Popup...</code>，前者新建在标签页内，后者以浮窗的形式展示：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/IDEA/%E9%80%89%E6%8B%A9Diagrams.png" alt="选择Diagrams" style="zoom: 40%;">

<p>提示选择查看到类型，选择 <code>Java Classes</code>：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/IDEA/%E9%80%89%E6%8B%A9Java-Classes.png" alt="选择Java-Classes"></p>
<p>然后你就会得到如下图所示的继承关系图形，以刚刚选中的 <code>DefaultSingletonBeanRegistry</code> 为例：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/IDEA/DefaultSingletonBeanRegistry%E7%BB%A7%E6%89%BF%E5%85%B3%E7%B3%BB%E5%9B%BE%E5%BD%A2.png" alt="DefaultSingletonBeanRegistry继承关系图形" style="zoom:67%;">

<p><strong>关系查看</strong></p>
<ul>
<li>蓝色实线箭头是指继承关系</li>
<li>绿色虚线箭头是指接口实现关系</li>
</ul>
<p><strong>去掉不关心的类</strong></p>
<ul>
<li>点击选择你想要删除的类，然后直接使用键盘上的 <code>delete</code></li>
</ul>
<h2 id="4-2-面板操作"><a href="#4-2-面板操作" class="headerlink" title="4.2 面板操作"></a>4.2 面板操作</h2><h3 id="4-2-1-调整面板布局Layout"><a href="#4-2-1-调整面板布局Layout" class="headerlink" title="4.2.1 调整面板布局Layout"></a>4.2.1 调整面板布局Layout</h3><p>在类图上点击右键，选择 <code>Layout</code> —&gt; <code>Orthogonal</code> ，在子菜单中可以调整排列效果，如下图：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/IDEA/%E8%B0%83%E6%95%B4%E9%9D%A2%E6%9D%BF%E5%B8%83%E5%B1%80Layout.png" alt="调整面板布局Layout" style="zoom: 50%;">

<h3 id="4-2-2-查看子类父类"><a href="#4-2-2-查看子类父类" class="headerlink" title="4.2.2 查看子类父类"></a>4.2.2 查看子类父类</h3><p>选中其中的某一个类或者接口，点击右键出现上下文选择菜单：</p>
<p><code>Show Implementations</code> 显示子类，快捷键 <code>Ctrl+Alt+B</code> ；<code>Show Parents</code> 显示父类，快捷键 <code>Ctrl+Alt+P</code></p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/IDEA/%E6%9F%A5%E7%9C%8B%E5%AD%90%E7%B1%BB%E7%88%B6%E7%B1%BB.png" alt="查看子类父类" style="zoom:50%;">

<p>当然也可以选中某个类，然后 <code>Ctrl + H</code>，调出类层级关系。如图，选择这个按钮，显示所有子接口和实现类。</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/IDEA/%E8%B0%83%E5%87%BA%E7%B1%BB%E5%B1%82%E7%BA%A7%E5%85%B3%E7%B3%BB.png" alt="调出类层级关系" style="zoom:67%;">

<h3 id="4-2-3-展示类的详细信息"><a href="#4-2-3-展示类的详细信息" class="headerlink" title="4.2.3 展示类的详细信息"></a>4.2.3 展示类的详细信息</h3><p>想看继承下来的方法？简单。</p>
<p>在页面点击右键，选择 <code>Content</code> —&gt; <code>show categories</code>，根据需要可以展开类中的属性、方法、构造方法等等。也可以直接使用上面的工具栏：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/IDEA/%E5%B1%95%E7%A4%BA%E7%B1%BB%E7%9A%84%E8%AF%A6%E7%BB%86%E4%BF%A1%E6%81%AF.png" alt="展示类的详细信息" style="zoom: 50%;">

<ul>
<li><code>Fields</code> - 字段，<code>Constructors</code> - 构造函数，<code>Methods</code> - 方法，<code>Properties</code> - 属性，Inner <code>Classes</code> - 内部类</li>
</ul>
<p>例如点击 <code>Methods</code> ，然后你就会得到：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/IDEA/%E6%98%BE%E7%A4%BAMethods.png" alt="显示Methods" style="zoom: 33%;">

<p>方法里还可以进行筛选，比如说想看 protected 权限及以上范围的？简单，右键选择 <code>Content</code> —&gt; <code>Change Visibility Level</code>，根据需要调整即可，或者可以点击左上角的图标。</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/IDEA/%E7%AD%9B%E9%80%89%E6%9F%A5%E7%9C%8B%E6%9D%83%E9%99%90.png" alt="筛选查看权限" style="zoom: 50%;">

<p><strong>PS：什么，你嫌图形太小你看不清<del>我也看不清😅</del>？IDEA 也可以满足你，试试看按住键盘的 <code>Alt</code> 键，会有惊喜哦🎉🎉！！！</strong></p>
<h3 id="4-2-4-加入其他类到关系中"><a href="#4-2-4-加入其他类到关系中" class="headerlink" title="4.2.4 加入其他类到关系中"></a>4.2.4 加入其他类到关系中</h3><p>当我们还需要查看其他类和当前类是否有继承上的关系的时候，我们可以选择加其加入到当前的继承关系图形中来。</p>
<p>在页面点击右键，选择 <code>Add Class to Diagram</code> 或者直接 <code>敲空格</code>，然后输入你想加入的类就可以了：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/IDEA/%E5%8A%A0%E5%85%A5%E5%85%B6%E4%BB%96%E7%B1%BB%E5%88%B0%E5%85%B3%E7%B3%BB%E4%B8%AD.png" alt="加入其他类到关系中" style="zoom: 40%;">

<h3 id="4-2-5-进入源码查看"><a href="#4-2-5-进入源码查看" class="headerlink" title="4.2.5 进入源码查看"></a>4.2.5 进入源码查看</h3><p>如果你想查看某个类中，比如某个方法的具体源码，当然不可能再给你展现在图形上了，已经看不清了😂。但是可以利用图形，或者配合 IDEA 的 structure 方便快捷地进入某个类的源码进行查看。</p>
<p>选中某个类后，下方会出现这个类的名称，点击名称后会出现这个类所有的 <code>字段</code> 和 <code>方法</code>，直接点击想看的内容即可跳转到源码：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/IDEA/%E8%BF%9B%E5%85%A5%E6%BA%90%E7%A0%81%E6%9F%A5%E7%9C%8B.png" alt="进入源码查看" style="zoom: 50%;">

<p>在进入某个类后，如果还想快速地查看该类的其他方法，还可以利用 IDEA 提供的 structure 功能：</p>
<p>选择左侧栏的 <code>structure</code> 之后，如下图左侧会展示该类中的所有方法，直接点击想看的内容即可跳转到源码。</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/IDEA/structure%E5%8A%9F%E8%83%BD.png" alt="structure功能" style="zoom: 40%;">

<h1 id="99-一些奇奇怪怪的问题"><a href="#99-一些奇奇怪怪的问题" class="headerlink" title="99. 一些奇奇怪怪的问题"></a>99. 一些奇奇怪怪的问题</h1><blockquote>
<p>在添加web支持的时候webapp目录没有小蓝点怎么办？</p>
</blockquote>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/IDEA/webapp%E7%9B%AE%E5%BD%95%E6%B2%A1%E6%9C%89%E5%B0%8F%E8%93%9D%E7%82%B9.png" alt="webapp目录没有小蓝点"></p>
<p>1、File —&gt; Project Structure —&gt; Modules —&gt; 选中没有web支持的模块</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/IDEA/%E6%B7%BB%E5%8A%A0web%E6%94%AF%E6%8C%81.png" alt="添加web支持" style="zoom: 67%;">

<p>2、配置web.xml文件和Web资源文件夹</p>
<p><code>web.xml</code> 文件的位置：\模块名\ <code>src\main\webapp\</code> WEB-INF\web.xml</p>
<p>Web Resource Directory 的位置：\模块名\src\main\webapp</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/IDEA/%E9%85%8D%E7%BD%AEweb.xml%E6%96%87%E4%BB%B6%E5%92%8CWeb%E8%B5%84%E6%BA%90%E6%96%87%E4%BB%B6%E5%A4%B9.png" alt="配置web.xml文件和Web资源文件夹" style="zoom:50%;">

<p>3、然后就可以看到小蓝点了</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/IDEA/%E6%B7%BB%E5%8A%A0web%E6%94%AF%E6%8C%81%E6%88%90%E5%8A%9F.png" alt="添加web支持成功"></p>
<blockquote>
<p>Shift+ F6 重命名失效</p>
</blockquote>
<p>今天在使用IDEA的时候对类进行重命名，发现使用 <code>Shift+ F6</code> 对其进行重命名的时候不起作用，我就纳闷了咋回事啊？这才几天没用它啊它就闹脾气了？我先是怀疑它出Bug了，于是重启了几次IDEA发现还是不能使用，最后怀疑是和电脑热键冲突了，然后跑去网上一搜原来是因为Windows升级<del>辣鸡Win11系统我都懒得吐槽了</del>，微软输入法带来的问题。</p>
<p>需要设置【使用以前版本的微软拼音输入法】解决兼容性。</p>
<p>依次点击：设置 -&gt; 时间和语言 -&gt; 语言和区域 -&gt; 语言选项下<strong>中文</strong>右侧三个 <code>·</code>  -&gt; 语言选项 -&gt; 键盘选项下<strong>微软拼音</strong>右侧三个 <code>·</code> -&gt; 键盘选项 -&gt; 常规 -&gt; 打开 <strong>使用以前版本的微软拼音输入法</strong></p>
<p>解决！！</p>
]]></content>
      <categories>
        <category>Tools</category>
      </categories>
      <tags>
        <tag>IDEA</tag>
      </tags>
  </entry>
  <entry>
    <title>【第4章】 MySQL优化</title>
    <url>/posts/14821/</url>
    <content><![CDATA[<h1 id="1-MySQL优化手段"><a href="#1-MySQL优化手段" class="headerlink" title="1. MySQL优化手段"></a>1. MySQL优化手段</h1><p>MySQL数据库的优化手段通常包括但不限于：</p>
<ul>
<li>SQL查询优化：这是最低成本的优化手段，通过优化查询语句、适当添加索引等方式进行。并且效果显著。</li>
<li>库表结构优化：通过规范化设计、优化索引和数据类型等方式进行库表结构优化，需要对数据库结构进行调整和改进</li>
<li>系统配置优化：根据硬件和操作系统的特点，调整最大连接数、内存管理、IO调度等参数</li>
<li>硬件优化：升级硬盘、增加内存容量、升级处理器等硬件方面的投入，需要购买和替换硬件设备，成本较高</li>
</ul>
<p>我们主要掌握：SQL查询优化</p>
<h1 id="2-SQL性能分析工具"><a href="#2-SQL性能分析工具" class="headerlink" title="2. SQL性能分析工具"></a>2. SQL性能分析工具</h1><h2 id="2-1-查看数据库整体情况"><a href="#2-1-查看数据库整体情况" class="headerlink" title="2.1 查看数据库整体情况"></a>2.1 查看数据库整体情况</h2><p>通过以下命令可以查看当前数据库在SQL语句执行方面的整体情况：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">global</span> status <span class="keyword">like</span> <span class="string">&#x27;Com_select&#x27;</span>;</span><br><span class="line"><span class="keyword">show</span> <span class="keyword">global</span> status <span class="keyword">like</span> <span class="string">&#x27;Com_insert&#x27;</span>;</span><br><span class="line"><span class="keyword">show</span> <span class="keyword">global</span> status <span class="keyword">like</span> <span class="string">&#x27;Com_delete&#x27;</span>;</span><br><span class="line"><span class="keyword">show</span> <span class="keyword">global</span> status <span class="keyword">like</span> <span class="string">&#x27;Com_update&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">show</span> <span class="keyword">global</span> status <span class="keyword">like</span> <span class="string">&#x27;Com_______&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p>这些结果反映了从 MySQL 服务器启动到当前时刻，所有的 SELECT 查询总数。对于 MySQL 性能优化来说，通过查看 <code>Com_select</code> 的值可以了解 SELECT 查询在整个 MySQL 服务期间所占比例的情况：</p>
<ul>
<li>如果 <code>Com_select</code> 次数过高，可能说明查询表中的每条记录都会返回过多的字段。</li>
<li>如果 <code>Com_select</code> 次数很少，同时insert或delete或update的次数很高，可能说明服务器运行的应用程序过于依赖写入操作和少量读取操作。</li>
</ul>
<p>总之，通过查看 <code>Com_select</code> 的值，可以了解 MySQL 服务器的长期执行情况，并在优化查询性能时，帮助我们了解 MySQL 的性能瓶颈。</p>
<h2 id="2-2-慢查询日志"><a href="#2-2-慢查询日志" class="headerlink" title="2.2 慢查询日志"></a>2.2 慢查询日志</h2><p>慢查询日志文件可以将查询较慢的DQL语句记录下来，便于我们定位需要调优的select语句。</p>
<p>通过以下命令查看慢查询日志功能是否开启：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;slow_query_log&#x27;</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">+----------------+-------+</span><br><span class="line">| Variable_name  | Value |</span><br><span class="line">+----------------+-------+</span><br><span class="line">| slow_query_log | OFF   |</span><br><span class="line">+----------------+-------+</span><br></pre></td></tr></table></figure>

<p>慢查询日志功能默认是关闭的。请修改my.ini文件来开启慢查询日志功能，在<code>my.ini</code>的[mysqld]后面添加如下配置：</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="attr">slow-query-log</span>=<span class="number">1</span></span><br><span class="line"><span class="attr">long_query_time</span>=<span class="number">3</span></span><br></pre></td></tr></table></figure>

<p><strong>PS：slow_query_log&#x3D;1表示开启慢查询日志功能，long_query_time&#x3D;3表示：只要SELECT语句的执行耗时超过3秒则将其记录到慢查询日志中。</strong></p>
<p>重启mysql服务。再次查看是否开启慢查询日志功能：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">停止 mysql 服务</span></span><br><span class="line">net stop mysql</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动 mysql 服务</span></span><br><span class="line">net start mysql</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">+----------------+-------+</span><br><span class="line">| Variable_name  | Value |</span><br><span class="line">+----------------+-------+</span><br><span class="line">| slow_query_log | ON    |</span><br><span class="line">+----------------+-------+</span><br></pre></td></tr></table></figure>

<p>尝试执行一条时长超过3秒的select语句：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> empno,ename,sleep(<span class="number">4</span>) <span class="keyword">from</span> emp <span class="keyword">where</span> ename<span class="operator">=</span><span class="string">&#x27;smith&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>慢查询日志文件默认存储在：你mysql安装目录下的 Data 目录中，默认的名字是：<code>计算机名-slow.log</code></p>
<p>通过该文件可以清晰的看到哪些DQL语句属于慢查询：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/MySQL/%E6%9F%A5%E7%9C%8B%E5%93%AA%E4%BA%9BDQL%E8%AF%AD%E5%8F%A5%E5%B1%9E%E4%BA%8E%E6%85%A2%E6%9F%A5%E8%AF%A2.png" alt="查看哪些DQL语句属于慢查询"></p>
<h2 id="2-3-show-profiles"><a href="#2-3-show-profiles" class="headerlink" title="2.3 show profiles"></a>2.3 show profiles</h2><p>通过<code>show profiles</code>可以查看一个SQL语句在执行过程中具体的耗时情况。帮助我们更好的定位问题所在。</p>
<p>查看当前数据库是否支持 profile 操作：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> @<span class="variable">@have_profiling</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">+------------------+</span><br><span class="line">| @@have_profiling |</span><br><span class="line">+------------------+</span><br><span class="line">| YES              |</span><br><span class="line">+------------------+</span><br></pre></td></tr></table></figure>

<p>查看 profiling 开关是否打开：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> @<span class="variable">@profiling</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">+-------------+</span><br><span class="line">| @@profiling |</span><br><span class="line">+-------------+</span><br><span class="line">|           0 |</span><br><span class="line">+-------------+</span><br></pre></td></tr></table></figure>

<p>将 profiling 开关打开：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">set</span> profiling <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">+-------------+</span><br><span class="line">| @@profiling |</span><br><span class="line">+-------------+</span><br><span class="line">|           1 |</span><br><span class="line">+-------------+</span><br></pre></td></tr></table></figure>

<p>可以执行多条DQL语句，然后使用 <code>show profiles;</code> 来查看当前数据库中执行过的每个SELECT语句的耗时情况。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> empno,ename <span class="keyword">from</span> emp;</span><br><span class="line"><span class="keyword">select</span> empno,ename <span class="keyword">from</span> emp <span class="keyword">where</span> empno<span class="operator">=</span><span class="number">7369</span>;</span><br><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> emp;</span><br><span class="line"><span class="keyword">show</span> profiles;</span><br></pre></td></tr></table></figure>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/MySQL/%E6%AF%8F%E4%B8%AASELECT%E8%AF%AD%E5%8F%A5%E7%9A%84%E8%80%97%E6%97%B6%E6%83%85%E5%86%B5.png" alt="每个SELECT语句的耗时情况" style="zoom:67%;">

<p>查看某个SQL语句语句在执行过程中，每个阶段的耗时情况：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">show</span> profile <span class="keyword">for</span> query <span class="number">4</span>;</span><br></pre></td></tr></table></figure>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/MySQL/%E6%9F%90%E4%B8%AASQL%E8%AF%AD%E5%8F%A5%E8%AF%AD%E5%8F%A5%E5%9C%A8%E6%89%A7%E8%A1%8C%E8%BF%87%E7%A8%8B%E4%B8%AD%E6%AF%8F%E4%B8%AA%E9%98%B6%E6%AE%B5%E7%9A%84%E8%80%97%E6%97%B6%E6%83%85%E5%86%B5.png" alt="某个SQL语句语句在执行过程中每个阶段的耗时情况" style="zoom: 67%;">

<p>想查看执行过程中cpu的情况，可以执行以下命令：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">show</span> profile cpu <span class="keyword">for</span> query <span class="number">4</span>;</span><br></pre></td></tr></table></figure>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/MySQL/%E6%89%A7%E8%A1%8C%E8%BF%87%E7%A8%8B%E4%B8%ADcpu%E7%9A%84%E6%83%85%E5%86%B5.png" alt="执行过程中cpu的情况" style="zoom:67%;">

<h2 id="2-4-explain"><a href="#2-4-explain" class="headerlink" title="2.4 explain"></a>2.4 explain</h2><p>explain命令可以查看一个DQL语句的执行计划，根据执行计划可以做出相应的优化措施。提高执行效率。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> emp <span class="keyword">where</span> empno<span class="operator">=</span><span class="number">7369</span>;</span><br></pre></td></tr></table></figure>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/MySQL/DQL%E8%AF%AD%E5%8F%A5%E7%9A%84%E6%89%A7%E8%A1%8C%E8%AE%A1%E5%88%92.png" alt="DQL语句的执行计划"></p>
<blockquote>
<p>id</p>
</blockquote>
<p>id反映出一条select语句执行顺序，id越大优先级越高。id相同则按照自上而下的顺序执行。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">explain <span class="keyword">select</span> e.ename,d.dname <span class="keyword">from</span> emp e <span class="keyword">join</span> dept d <span class="keyword">on</span> e.deptno<span class="operator">=</span>d.deptno <span class="keyword">join</span> salgrade s <span class="keyword">on</span> e.sal <span class="keyword">between</span> s.losal <span class="keyword">and</span> s.hisal;</span><br></pre></td></tr></table></figure>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/MySQL/explain-id(1).png" alt="explain-id(1)"></p>
<p>由于id相同，反映出三张表在执行顺序上属于平等关系，执行时采用，先d，再e，最后s。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">explain <span class="keyword">select</span> e.ename,d.dname <span class="keyword">from</span> emp e <span class="keyword">join</span> dept d <span class="keyword">on</span> e.deptno<span class="operator">=</span>d.deptno <span class="keyword">where</span> e.sal<span class="operator">=</span>(<span class="keyword">select</span> sal <span class="keyword">from</span> emp <span class="keyword">where</span> ename<span class="operator">=</span><span class="string">&#x27;ford&#x27;</span>);</span><br></pre></td></tr></table></figure>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/MySQL/explain-id(2).png" alt="explain-id(2)"></p>
<p>反映出，先执行子查询，然后让e和d做表连接。</p>
<blockquote>
<p>select_type</p>
</blockquote>
<p>反映了mysql查询语句的类型。常用值包括：</p>
<ul>
<li><code>SIMPLE</code>：表示查询中不包含子查询或UNION操作。这种查询通常包括一个表或是最多一个联接（JOIN）</li>
<li><code>PRIMARY</code>：表示当前查询是一个主查询。（主要的查询）</li>
<li><code>UNION</code>：表示查询中包含UNION操作</li>
<li><code>SUBQUERY</code>：子查询</li>
<li><code>DERIVED</code>：派生表（表示查询语句出现在from后面）</li>
</ul>
<blockquote>
<p>table</p>
</blockquote>
<p>反映了这个查询操作的是哪个表。</p>
<blockquote>
<p>type</p>
</blockquote>
<p>反映了查询表中数据时的访问类型，常见的值：</p>
<ul>
<li><code>NULL</code>：效率最高，一般不可能优化到这个级别，只有查询时没有查询表的时候，访问类型是NULL。例如：select 1;</li>
<li><code>system</code>：通常访问系统表的时候，访问类型是system。一般也很难优化到这个程序。</li>
<li><code>const</code>：根据主键或者唯一性索引查询，索引值是常量值时。explain select * from emp where empno&#x3D;7369;</li>
<li><code>eq_ref</code>：根据主键或者唯一性索引查询。索引值不是常量值。</li>
<li><code>ref</code>：使用了非唯一的索引进行查询。</li>
<li><code>range</code>：使用了索引，扫描了索引树的一部分。</li>
<li><code>index</code>：表示用了索引，但是也需要遍历整个索引树。</li>
<li><code>all</code>：全表扫描</li>
</ul>
<p>效率最高的是<code>NULL</code>，效率最低的是<code>all</code>，从上到下，从高到低。</p>
<blockquote>
<p>possible_keys</p>
</blockquote>
<p>这个查询可能会用到的索引</p>
<blockquote>
<p>key</p>
</blockquote>
<p>实际用到的索引</p>
<blockquote>
<p>key_len</p>
</blockquote>
<p>反映索引中在查询中使用的列所占的总字节数。</p>
<blockquote>
<p>rows</p>
</blockquote>
<p>查询扫描的预估计行数。</p>
<blockquote>
<p>Extra</p>
</blockquote>
<p>给出了与查询相关的额外信息和说明。这些额外信息可以帮助我们更好地理解查询执行的过程。</p>
<h1 id="3-索引优化"><a href="#3-索引优化" class="headerlink" title="3. 索引优化"></a>3. 索引优化</h1><h2 id="3-1-加索引-vs-不加索引"><a href="#3-1-加索引-vs-不加索引" class="headerlink" title="3.1 加索引 vs 不加索引"></a>3.1 加索引 vs 不加索引</h2><p>将这个sql脚本初始化到数据库中（初始化100W条记录）：t_vip.sql</p>
<p>根据id查询（id是主键，有索引）：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_vip <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">900000</span>;</span><br></pre></td></tr></table></figure>

<p>根据name查询（name上没有索引）：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_vip <span class="keyword">where</span> name<span class="operator">=</span><span class="string">&#x27;4c6494cb&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>给name字段添加索引：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> index idx_t_user_name <span class="keyword">on</span> t_vip(name);</span><br></pre></td></tr></table></figure>

<p>再次根据name查询（此时name上已经有索引了） ：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_vip <span class="keyword">where</span> name<span class="operator">=</span><span class="string">&#x27;4c6494cb&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h2 id="3-2-最左前缀原则"><a href="#3-2-最左前缀原则" class="headerlink" title="3.2 最左前缀原则"></a>3.2 最左前缀原则</h2><p>假设有这样一张表：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> t_customer(</span><br><span class="line">	id <span class="type">int</span> <span class="keyword">primary</span> key auto_increment,</span><br><span class="line">	name <span class="type">varchar</span>(<span class="number">255</span>),</span><br><span class="line">	age <span class="type">int</span>,</span><br><span class="line">	gender <span class="type">char</span>(<span class="number">1</span>),</span><br><span class="line">	email <span class="type">varchar</span>(<span class="number">255</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>添加了这些数据：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t_customer <span class="keyword">values</span>(<span class="keyword">null</span>, <span class="string">&#x27;zhangsan&#x27;</span>, <span class="number">20</span>, <span class="string">&#x27;M&#x27;</span>, <span class="string">&#x27;zhangsan@123.com&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t_customer <span class="keyword">values</span>(<span class="keyword">null</span>, <span class="string">&#x27;lisi&#x27;</span>, <span class="number">22</span>, <span class="string">&#x27;M&#x27;</span>, <span class="string">&#x27;lisi@123.com&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t_customer <span class="keyword">values</span>(<span class="keyword">null</span>, <span class="string">&#x27;wangwu&#x27;</span>, <span class="number">18</span>, <span class="string">&#x27;F&#x27;</span>, <span class="string">&#x27;wangwu@123.com&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t_customer <span class="keyword">values</span>(<span class="keyword">null</span>, <span class="string">&#x27;zhaoliu&#x27;</span>, <span class="number">22</span>, <span class="string">&#x27;F&#x27;</span>, <span class="string">&#x27;zhaoliu@123.com&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t_customer <span class="keyword">values</span>(<span class="keyword">null</span>, <span class="string">&#x27;jack&#x27;</span>, <span class="number">30</span>, <span class="string">&#x27;M&#x27;</span>, <span class="string">&#x27;jack@123.com&#x27;</span>);</span><br></pre></td></tr></table></figure>
<p>添加了这样的复合索引：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> index idx_name_age_gender <span class="keyword">on</span> t_customer(name,age,gender);</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>最左前缀原则：当查询语句条件中包含了这个复合索引最左边的列 name 时，此时索引才会起作用</strong></p>
</blockquote>
<p>验证1：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_customer <span class="keyword">where</span> name<span class="operator">=</span><span class="string">&#x27;zhangsan&#x27;</span> <span class="keyword">and</span> age<span class="operator">=</span><span class="number">20</span> <span class="keyword">and</span> gender<span class="operator">=</span><span class="string">&#x27;M&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p>验证结果：完全使用了索引</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/MySQL/%E6%9C%80%E5%B7%A6%E5%89%8D%E7%BC%80%E5%8E%9F%E5%88%99-%E9%AA%8C%E8%AF%811.png" alt="最左前缀原则-验证1"></p>
<p>验证2：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_customer <span class="keyword">where</span> name<span class="operator">=</span><span class="string">&#x27;zhangsan&#x27;</span> <span class="keyword">and</span> age<span class="operator">=</span><span class="number">20</span>;</span><br></pre></td></tr></table></figure>
<p>验证结果：使用了部分索引</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/MySQL/%E6%9C%80%E5%B7%A6%E5%89%8D%E7%BC%80%E5%8E%9F%E5%88%99-%E9%AA%8C%E8%AF%812.png" alt="最左前缀原则-验证2"></p>
<p>验证3：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_customer <span class="keyword">where</span> name<span class="operator">=</span><span class="string">&#x27;zhangsan&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p>验证结果：使用了部分索引</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/MySQL/%E6%9C%80%E5%B7%A6%E5%89%8D%E7%BC%80%E5%8E%9F%E5%88%99-%E9%AA%8C%E8%AF%813.png" alt="最左前缀原则-验证3"></p>
<p>验证4：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_customer <span class="keyword">where</span> age<span class="operator">=</span><span class="number">20</span> <span class="keyword">and</span> gender<span class="operator">=</span><span class="string">&#x27;M&#x27;</span> <span class="keyword">and</span> name<span class="operator">=</span><span class="string">&#x27;zhangsan&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p>验证结果：完全使用了索引</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/MySQL/%E6%9C%80%E5%B7%A6%E5%89%8D%E7%BC%80%E5%8E%9F%E5%88%99-%E9%AA%8C%E8%AF%814.png" alt="最左前缀原则-验证4"></p>
<p>验证5：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_customer <span class="keyword">where</span> gender<span class="operator">=</span><span class="string">&#x27;M&#x27;</span> <span class="keyword">and</span> age<span class="operator">=</span><span class="number">20</span>;</span><br></pre></td></tr></table></figure>
<p>验证结果：没有使用任何索引</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/MySQL/%E6%9C%80%E5%B7%A6%E5%89%8D%E7%BC%80%E5%8E%9F%E5%88%99-%E9%AA%8C%E8%AF%815.png" alt="最左前缀原则-验证5"></p>
<p>验证6：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_customer <span class="keyword">where</span> name<span class="operator">=</span><span class="string">&#x27;zhangsan&#x27;</span> <span class="keyword">and</span> gender<span class="operator">=</span><span class="string">&#x27;M&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p>验证结果：使用了部分索引</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/MySQL/%E6%9C%80%E5%B7%A6%E5%89%8D%E7%BC%80%E5%8E%9F%E5%88%99-%E9%AA%8C%E8%AF%816.png" alt="最左前缀原则-验证6"></p>
<p>验证7：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_customer <span class="keyword">where</span> name<span class="operator">=</span><span class="string">&#x27;zhangsan&#x27;</span> <span class="keyword">and</span> gender<span class="operator">=</span><span class="string">&#x27;M&#x27;</span> <span class="keyword">and</span> age<span class="operator">=</span><span class="number">20</span>;</span><br></pre></td></tr></table></figure>
<p>验证结果：完全使用了索引</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/MySQL/%E6%9C%80%E5%B7%A6%E5%89%8D%E7%BC%80%E5%8E%9F%E5%88%99-%E9%AA%8C%E8%AF%817.png" alt="最左前缀原则-验证7"></p>
<blockquote>
<p><strong>范围查询时，在“范围条件”右侧的列索引会失效</strong></p>
</blockquote>
<p>验证：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_customer <span class="keyword">where</span> name<span class="operator">=</span><span class="string">&#x27;zhangsan&#x27;</span> <span class="keyword">and</span> age<span class="operator">&gt;</span><span class="number">20</span> <span class="keyword">and</span> gender<span class="operator">=</span><span class="string">&#x27;M&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p>验证结果：name和age列索引生效。gender列索引无效。</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/MySQL/%E8%8C%83%E5%9B%B4%E6%9F%A5%E8%AF%A2%E6%97%B6%E5%9C%A8%E8%8C%83%E5%9B%B4%E6%9D%A1%E4%BB%B6%E5%8F%B3%E4%BE%A7%E7%9A%84%E5%88%97%E7%B4%A2%E5%BC%95%E4%BC%9A%E5%A4%B1%E6%95%88.png" alt="范围查询时在范围条件右侧的列索引会失效"></p>
<p>怎么解决？建议范围查找时带上<code>=</code></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_customer <span class="keyword">where</span> name<span class="operator">=</span><span class="string">&#x27;zhangsan&#x27;</span> <span class="keyword">and</span> age<span class="operator">&gt;=</span><span class="number">20</span> <span class="keyword">and</span> gender<span class="operator">=</span><span class="string">&#x27;M&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/MySQL/%E8%A7%A3%E5%86%B3%E8%8C%83%E5%9B%B4%E6%9F%A5%E8%AF%A2%E6%97%B6%E5%9C%A8%E8%8C%83%E5%9B%B4%E6%9D%A1%E4%BB%B6%E5%8F%B3%E4%BE%A7%E7%9A%84%E5%88%97%E7%B4%A2%E5%BC%95%E5%A4%B1%E6%95%88.png" alt="解决范围查询时在范围条件右侧的列索引失效"></p>
<h2 id="3-3-索引失效情况"><a href="#3-3-索引失效情况" class="headerlink" title="3.3 索引失效情况"></a>3.3 索引失效情况</h2><p>有这样一张表：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> t_emp(</span><br><span class="line">  id <span class="type">int</span> <span class="keyword">primary</span> key auto_increment,</span><br><span class="line">  name <span class="type">varchar</span>(<span class="number">255</span>),</span><br><span class="line">  sal <span class="type">int</span>,</span><br><span class="line">  age <span class="type">char</span>(<span class="number">2</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>有这样一些数据：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t_emp <span class="keyword">values</span>(<span class="keyword">null</span>, <span class="string">&#x27;张三&#x27;</span>, <span class="number">5000</span>,<span class="string">&#x27;20&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t_emp <span class="keyword">values</span>(<span class="keyword">null</span>, <span class="string">&#x27;张飞&#x27;</span>, <span class="number">4000</span>,<span class="string">&#x27;30&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t_emp <span class="keyword">values</span>(<span class="keyword">null</span>, <span class="string">&#x27;李飞&#x27;</span>, <span class="number">6000</span>,<span class="string">&#x27;40&#x27;</span>);</span><br></pre></td></tr></table></figure>
<p>有这样一些索引：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> index idx_t_emp_name <span class="keyword">on</span> t_emp(name);</span><br><span class="line"><span class="keyword">create</span> index idx_t_emp_sal <span class="keyword">on</span> t_emp(sal);</span><br><span class="line"><span class="keyword">create</span> index idx_t_emp_age <span class="keyword">on</span> t_emp(age);</span><br></pre></td></tr></table></figure>

<h3 id="3-3-1-索引列参加了运算，索引失效"><a href="#3-3-1-索引列参加了运算，索引失效" class="headerlink" title="3.3.1 索引列参加了运算，索引失效"></a>3.3.1 索引列参加了运算，索引失效</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_emp <span class="keyword">where</span> sal <span class="operator">&gt;</span> <span class="number">5000</span>;</span><br></pre></td></tr></table></figure>
<p>验证结果：使用了索引</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/MySQL/%E7%B4%A2%E5%BC%95%E5%88%97%E6%9C%AA%E5%8F%82%E5%8A%A0%E8%BF%90%E7%AE%97%EF%BC%8C%E7%B4%A2%E5%BC%95%E7%94%9F%E6%95%88.png" alt="索引列未参加运算，索引生效"></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_emp <span class="keyword">where</span> sal<span class="operator">*</span><span class="number">10</span> <span class="operator">&gt;</span> <span class="number">50000</span>;</span><br></pre></td></tr></table></figure>
<p>验证结果：索引失效</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/MySQL/%E7%B4%A2%E5%BC%95%E5%88%97%E5%8F%82%E5%8A%A0%E4%BA%86%E8%BF%90%E7%AE%97%EF%BC%8C%E7%B4%A2%E5%BC%95%E5%A4%B1%E6%95%88.png" alt="索引列参加了运算，索引失效"></p>
<h3 id="3-3-2-索引列进行模糊查询时以-开始的，索引失效"><a href="#3-3-2-索引列进行模糊查询时以-开始的，索引失效" class="headerlink" title="3.3.2 索引列进行模糊查询时以 % 开始的，索引失效"></a>3.3.2 索引列进行模糊查询时以 % 开始的，索引失效</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_emp <span class="keyword">where</span> name <span class="keyword">like</span> <span class="string">&#x27;张%&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p>验证结果：索引有效</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/MySQL/%E7%B4%A2%E5%BC%95%E5%88%97%E8%BF%9B%E8%A1%8C%E6%A8%A1%E7%B3%8A%E6%9F%A5%E8%AF%A2%E6%97%B6%E6%9C%AA%E4%BB%A5%25%E5%BC%80%E5%A7%8B%EF%BC%8C%E7%B4%A2%E5%BC%95%E7%94%9F%E6%95%88.png" alt="索引列进行模糊查询时未以%开始，索引生效"></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_emp <span class="keyword">where</span> name <span class="keyword">like</span> <span class="string">&#x27;%飞&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p>验证结果：索引失效</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/MySQL/%E7%B4%A2%E5%BC%95%E5%88%97%E8%BF%9B%E8%A1%8C%E6%A8%A1%E7%B3%8A%E6%9F%A5%E8%AF%A2%E6%97%B6%E4%BB%A5%25%E5%BC%80%E5%A7%8B%E7%9A%84%EF%BC%8C%E7%B4%A2%E5%BC%95%E5%A4%B1%E6%95%88.png" alt="索引列进行模糊查询时以%开始的，索引失效"></p>
<h3 id="3-3-3-索引列是字符串类型，但查询时省略了单引号，索引失效"><a href="#3-3-3-索引列是字符串类型，但查询时省略了单引号，索引失效" class="headerlink" title="3.3.3 索引列是字符串类型，但查询时省略了单引号，索引失效"></a>3.3.3 索引列是字符串类型，但查询时省略了单引号，索引失效</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_emp <span class="keyword">where</span> age<span class="operator">=</span><span class="string">&#x27;20&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p>验证结果：索引有效</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/MySQL/%E7%B4%A2%E5%BC%95%E5%88%97%E6%98%AF%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%B1%BB%E5%9E%8B%E6%9F%A5%E8%AF%A2%E6%97%B6%E4%BD%BF%E7%94%A8%E4%BA%86%E5%8D%95%E5%BC%95%E5%8F%B7%EF%BC%8C%E7%B4%A2%E5%BC%95%E7%94%9F%E6%95%88.png" alt="索引列是字符串类型查询时使用了单引号，索引生效"></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_emp <span class="keyword">where</span> age<span class="operator">=</span><span class="number">20</span>;</span><br></pre></td></tr></table></figure>
<p>验证结果：索引失效</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/MySQL/%E7%B4%A2%E5%BC%95%E5%88%97%E6%98%AF%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%B1%BB%E5%9E%8B%E4%BD%86%E6%9F%A5%E8%AF%A2%E6%97%B6%E7%9C%81%E7%95%A5%E4%BA%86%E5%8D%95%E5%BC%95%E5%8F%B7%EF%BC%8C%E7%B4%A2%E5%BC%95%E5%A4%B1%E6%95%88.png" alt="索引列是字符串类型但查询时省略了单引号，索引失效"></p>
<h3 id="3-3-4-查询条件中有or，只要有未添加索引的字段，索引失效"><a href="#3-3-4-查询条件中有or，只要有未添加索引的字段，索引失效" class="headerlink" title="3.3.4 查询条件中有or，只要有未添加索引的字段，索引失效"></a>3.3.4 查询条件中有or，只要有未添加索引的字段，索引失效</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_emp <span class="keyword">where</span> name<span class="operator">=</span><span class="string">&#x27;张三&#x27;</span> <span class="keyword">or</span> sal<span class="operator">=</span><span class="number">5000</span>;</span><br></pre></td></tr></table></figure>
<p>验证结果：使用了索引</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/MySQL/%E6%9F%A5%E8%AF%A2%E6%9D%A1%E4%BB%B6%E4%B8%AD%E6%9C%89or%EF%BC%8C%E6%B2%A1%E6%9C%89%E6%9C%AA%E6%B7%BB%E5%8A%A0%E7%B4%A2%E5%BC%95%E7%9A%84%E5%AD%97%E6%AE%B5%EF%BC%8C%E7%B4%A2%E5%BC%95%E7%94%9F%E6%95%88.png" alt="查询条件中有or，没有未添加索引的字段，索引生效"></p>
<p>将t_emp表sal字段上的索引删除：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> t_emp <span class="keyword">drop</span> index idx_t_emp_sal;</span><br></pre></td></tr></table></figure>
<p>再次验证：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_emp <span class="keyword">where</span> name<span class="operator">=</span><span class="string">&#x27;张三&#x27;</span> <span class="keyword">or</span> sal<span class="operator">=</span><span class="number">5000</span>;</span><br></pre></td></tr></table></figure>
<p>验证结果：索引失效</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/MySQL/%E6%9F%A5%E8%AF%A2%E6%9D%A1%E4%BB%B6%E4%B8%AD%E6%9C%89or%EF%BC%8C%E6%9C%89%E6%9C%AA%E6%B7%BB%E5%8A%A0%E7%B4%A2%E5%BC%95%E7%9A%84%E5%AD%97%E6%AE%B5%EF%BC%8C%E7%B4%A2%E5%BC%95%E5%A4%B1%E6%95%88.png" alt="查询条件中有or，有未添加索引的字段，索引失效"></p>
<h3 id="3-3-5-当查询的符合条件的记录在表中占比较大，索引失效"><a href="#3-3-5-当查询的符合条件的记录在表中占比较大，索引失效" class="headerlink" title="3.3.5 当查询的符合条件的记录在表中占比较大，索引失效"></a>3.3.5 当查询的符合条件的记录在表中占比较大，索引失效</h3><p>复制一张新表：emp2</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> emp2 <span class="keyword">as</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> emp;</span><br></pre></td></tr></table></figure>
<p>给sal添加索引：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> emp2 <span class="keyword">add</span> index idx_emp2_sal(sal);</span><br></pre></td></tr></table></figure>

<p>验证1：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> emp2 <span class="keyword">where</span> sal <span class="operator">&gt;</span> <span class="number">800</span>;</span><br></pre></td></tr></table></figure>
<p>不走索引：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/MySQL/%E6%9F%A5%E8%AF%A2%E7%9A%84%E7%AC%A6%E5%90%88%E6%9D%A1%E4%BB%B6%E7%9A%84%E8%AE%B0%E5%BD%95%E5%9C%A8%E8%A1%A8%E4%B8%AD%E5%8D%A0%E6%AF%94%E8%BE%83%E5%A4%A7%EF%BC%8C%E7%B4%A2%E5%BC%95%E5%A4%B1%E6%95%88%E9%AA%8C%E8%AF%811.png" alt="查询的符合条件的记录在表中占比较大，索引失效验证1"></p>
<p>验证2：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> emp2 <span class="keyword">where</span> sal <span class="operator">&gt;</span> <span class="number">1000</span>;</span><br></pre></td></tr></table></figure>
<p>不走索引：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/MySQL/%E6%9F%A5%E8%AF%A2%E7%9A%84%E7%AC%A6%E5%90%88%E6%9D%A1%E4%BB%B6%E7%9A%84%E8%AE%B0%E5%BD%95%E5%9C%A8%E8%A1%A8%E4%B8%AD%E5%8D%A0%E6%AF%94%E8%BE%83%E5%A4%A7%EF%BC%8C%E7%B4%A2%E5%BC%95%E5%A4%B1%E6%95%88%E9%AA%8C%E8%AF%812.png" alt="查询的符合条件的记录在表中占比较大，索引失效验证2"></p>
<p>验证3：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> emp2 <span class="keyword">where</span> sal <span class="operator">&gt;</span> <span class="number">2000</span>;</span><br></pre></td></tr></table></figure>
<p>走索引：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/MySQL/%E6%9F%A5%E8%AF%A2%E7%9A%84%E7%AC%A6%E5%90%88%E6%9D%A1%E4%BB%B6%E7%9A%84%E8%AE%B0%E5%BD%95%E5%9C%A8%E8%A1%A8%E4%B8%AD%E5%8D%A0%E6%AF%94%E8%BE%83%E5%A4%A7%EF%BC%8C%E7%B4%A2%E5%BC%95%E5%A4%B1%E6%95%88%E9%AA%8C%E8%AF%813.png" alt="查询的符合条件的记录在表中占比较大，索引失效验证3"></p>
<h3 id="3-5-6-关于is-null和is-not-null的索引失效问题"><a href="#3-5-6-关于is-null和is-not-null的索引失效问题" class="headerlink" title="3.5.6 关于is null和is not null的索引失效问题"></a>3.5.6 关于is null和is not null的索引失效问题</h3><p>给emp2的comm字段添加一个索引：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> index idx_emp2_comm <span class="keyword">on</span> emp2(comm);</span><br></pre></td></tr></table></figure>
<p>将emp2表的comm字段值全部更新为NULL：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">update</span> emp2 <span class="keyword">set</span> comm<span class="operator">=</span><span class="keyword">null</span>;</span><br></pre></td></tr></table></figure>

<p>验证此时条件使用<code>is null</code>是否走索引：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> emp2 <span class="keyword">where</span> comm <span class="keyword">is</span> <span class="keyword">null</span>;</span><br></pre></td></tr></table></figure>
<p>验证结果：不走索引。</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/MySQL/%E4%BD%BF%E7%94%A8is%20null%E4%B8%8D%E8%B5%B0%E7%B4%A2%E5%BC%95.png" alt="使用is null不走索引"></p>
<p>验证此时条件使用<code>is not null</code>是否走索引：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/MySQL/%E9%AA%8C%E8%AF%81%E6%AD%A4%E6%97%B6%E6%9D%A1%E4%BB%B6%E4%BD%BF%E7%94%A8is%20not%20null%E6%98%AF%E5%90%A6%E8%B5%B0%E7%B4%A2%E5%BC%951.png" alt="验证此时条件使用is not null是否走索引1"></p>
<p>将emp2表的comm字段全部更新为非NULL：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">update</span> emp2 <span class="keyword">set</span> comm<span class="operator">=</span><span class="number">100</span>;</span><br></pre></td></tr></table></figure>

<p>验证此时条件使用<code>is null</code>是否走索引：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> emp2 <span class="keyword">where</span> comm <span class="keyword">is</span> <span class="keyword">null</span>;</span><br></pre></td></tr></table></figure>
<p>验证结果：走索引</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/MySQL/%E8%B5%B0%E7%B4%A2%E5%BC%95.png" alt="走索引"></p>
<p>验证此时条件使用<code>is not null</code>是否走索引：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> emp2 <span class="keyword">where</span> comm <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">null</span>;</span><br></pre></td></tr></table></figure>
<p>验证结果：不走索引</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/MySQL/%E4%B8%8D%E8%B5%B0%E7%B4%A2%E5%BC%95.png" alt="不走索引"></p>
<p>结论：走索引还是不走索引，根数据分布有很大关系，如果符合条件的记录占比较大，会考虑使用全表扫描，而放弃走索引。</p>
<h2 id="3-4-指定索引"><a href="#3-4-指定索引" class="headerlink" title="3.4 指定索引"></a>3.4 指定索引</h2><p>当一个字段上既有单列索引，又有复合索引时，我们可以通过以下的SQL提示来要求该SQL语句执行时采用哪个索引：</p>
<ul>
<li><code>use index(索引名称)</code>：建议使用该索引，只是建议，底层mysql会根据实际效率来考虑是否使用你推荐的索引</li>
<li><code>ignore index(索引名称)</code>：忽略该索引</li>
<li><code>force index(索引名称)</code>：强行使用该索引</li>
</ul>
<p>查看 t_customer 表上的索引：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">show</span> index <span class="keyword">from</span> t_customer;</span><br></pre></td></tr></table></figure>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/MySQL/t_customer%E8%A1%A8%E4%B8%8A%E7%9A%84%E7%B4%A2%E5%BC%95.png" alt="t_customer表上的索引"></p>
<p>可以看到name、age、gender三列添加了一个复合索引。</p>
<p>现在给name字段添加一个单列索引：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> index idx_name <span class="keyword">on</span> t_customer(name);</span><br></pre></td></tr></table></figure>
<p>看看以下的语句默认使用了哪个索引：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_customer <span class="keyword">where</span> name<span class="operator">=</span><span class="string">&#x27;zhangsan&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/MySQL/%E9%BB%98%E8%AE%A4%E4%BD%BF%E7%94%A8%E4%BA%86%E8%81%94%E5%90%88%E7%B4%A2%E5%BC%95.png" alt="默认使用了联合索引"></p>
<p>通过测试得知，默认使用了联合索引。</p>
<p>如何建议使用单列索引 <code>idx_name</code>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_customer use index(idx_name) <span class="keyword">where</span> name<span class="operator">=</span><span class="string">&#x27;zhangsan&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/MySQL/%E5%BB%BA%E8%AE%AE%E4%BD%BF%E7%94%A8%E5%8D%95%E5%88%97%E7%B4%A2%E5%BC%95idx_name.png" alt="建议使用单列索引idx_name"></p>
<p>如何忽略使用符合索引 <code>idx_name_age_gender</code>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_customer ignore index(idx_name_age_gender) <span class="keyword">where</span> name<span class="operator">=</span><span class="string">&#x27;zhangsan&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/MySQL/%E5%BF%BD%E7%95%A5%E4%BD%BF%E7%94%A8%E7%AC%A6%E5%90%88%E7%B4%A2%E5%BC%95idx_name_age_gender.png" alt="忽略使用符合索引idx_name_age_gender"></p>
<p>如何强行使用单列索引 <code>idx_name</code>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_customer force index(idx_name) <span class="keyword">where</span> name<span class="operator">=</span><span class="string">&#x27;zhangsan&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/MySQL/%E5%BC%BA%E8%A1%8C%E4%BD%BF%E7%94%A8%E5%8D%95%E5%88%97%E7%B4%A2%E5%BC%95idx_name.png" alt="强行使用单列索引idx_name"></p>
<h2 id="3-5-覆盖索引"><a href="#3-5-覆盖索引" class="headerlink" title="3.5 覆盖索引"></a>3.5 覆盖索引</h2><p>覆盖索引我们在讲解索引的时候已经提到过了，覆盖索引强调的是：在select后面写字段的时候，这些字段尽可能是索引所覆盖的字段，这样可以避免回表查询。尽可能避免使用 <code>select *</code>，因为 <code>select *</code> 很容易导致回表查询。（本质就是：能在索引上检索的，就不要再次回表查询了。）</p>
<p>例如：有一张表 emp3，其中 ename，job添加了联合索引：idx_emp3_ename_job，以下这个select语句就不会回表：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> if <span class="keyword">exists</span> emp3;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> emp3 <span class="keyword">as</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> emp;</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> emp3 <span class="keyword">add</span> <span class="keyword">constraint</span> emp3_pk <span class="keyword">primary</span> key(empno);</span><br><span class="line"><span class="keyword">create</span> index idx_emp3_ename_job <span class="keyword">on</span> emp3(ename,job);</span><br><span class="line">explain <span class="keyword">select</span> empno,ename,job <span class="keyword">from</span> emp3 <span class="keyword">where</span> ename<span class="operator">=</span><span class="string">&#x27;KING&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/MySQL/select%E8%AF%AD%E5%8F%A5%E4%B8%8D%E5%9B%9E%E8%A1%A8.png" alt="select语句不回表"></p>
<p>如果查询语句要查找的列没有在索引中，则会回表查询，例如：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">explain <span class="keyword">select</span> empno,ename,job,sal <span class="keyword">from</span> emp3 <span class="keyword">where</span> ename<span class="operator">=</span><span class="string">&#x27;KING&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/MySQL/select%E8%AF%AD%E5%8F%A5%E5%9B%9E%E8%A1%A8.png" alt="select语句回表"></p>
<p>面试题：t_user表字段如下：id,name,password,realname,birth,email。表中数据量500万条，请针对以下SQL语句给出优化方案：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> id,name,realname <span class="keyword">from</span> t_user <span class="keyword">where</span> name<span class="operator">=</span><span class="string">&#x27;鲁智深&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p>如果只给name添加索引，底层会进行大量的回表查询，效率较低，建议给name和realname两个字段添加联合索引，这样大大减少回表操作，提高查询效率。</p>
<h2 id="3-6-前缀索引"><a href="#3-6-前缀索引" class="headerlink" title="3.6 前缀索引"></a>3.6 前缀索引</h2><p>如果一个字段类型是varchar或text字段，字段中存储的是文本或者大文本，直接对这种长文本创建索引，会让索引体积很大，怎么优化呢？可以将字符串的前几个字符截取下来当做索引来创建。这种索引被称为前缀索引，例如：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> if <span class="keyword">exists</span> emp4;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> emp4 <span class="keyword">as</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> emp;</span><br><span class="line"><span class="keyword">create</span> index idx_emp4_ename_2 <span class="keyword">on</span> emp4(ename(<span class="number">2</span>));</span><br></pre></td></tr></table></figure>
<p>以上SQL表示将emp4表中ename字段的前2个字符创建到索引当中。</p>
<p>使用前缀索引时，需要通过以下公式来确定使用前几个字符作为索引：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(<span class="keyword">distinct</span> <span class="built_in">substring</span>(ename,<span class="number">1</span>,前几个字符)) <span class="operator">/</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> emp4;</span><br></pre></td></tr></table></figure>
<p>以上查询结果越接近1，表示索引的效果越好。（原理：做索引值的话，索引值越具有唯一性效率越高）</p>
<p>假设我们使用前1个字符作为索引值：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(<span class="keyword">distinct</span> <span class="built_in">substring</span>(ename,<span class="number">1</span>,<span class="number">1</span>)) <span class="operator">/</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> emp4;</span><br></pre></td></tr></table></figure>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/MySQL/%E4%BD%BF%E7%94%A8%E5%89%8D1%E4%B8%AA%E5%AD%97%E7%AC%A6%E4%BD%9C%E4%B8%BA%E7%B4%A2%E5%BC%95%E5%80%BC.png" alt="使用前1个字符作为索引值"></p>
<p>假设我们使用前2个字符作为索引值：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(<span class="keyword">distinct</span> <span class="built_in">substring</span>(ename,<span class="number">1</span>,<span class="number">2</span>)) <span class="operator">/</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> emp4;</span><br></pre></td></tr></table></figure>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/MySQL/%E4%BD%BF%E7%94%A8%E5%89%8D2%E4%B8%AA%E5%AD%97%E7%AC%A6%E4%BD%9C%E4%B8%BA%E7%B4%A2%E5%BC%95%E5%80%BC.png" alt="使用前2个字符作为索引值"></p>
<p>可见使用前2个字符作为索引值，能够让索引值更具有唯一性，效率越好，因此我们选择前2个字符作为前缀索引。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> index idx_emp4_ename_2 <span class="keyword">on</span> emp4(ename(<span class="number">2</span>));</span><br></pre></td></tr></table></figure>
<p>执行以下的查询语句则会走这个前缀索引：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> emp4 <span class="keyword">where</span> ename<span class="operator">=</span><span class="string">&#x27;KING&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/MySQL/%E6%9F%A5%E8%AF%A2%E8%AF%AD%E5%8F%A5%E8%B5%B0%E5%89%8D%E7%BC%80%E7%B4%A2%E5%BC%95.png" alt="查询语句走前缀索引"></p>
<h2 id="3-7-单列索引和复合索引怎么选择"><a href="#3-7-单列索引和复合索引怎么选择" class="headerlink" title="3.7 单列索引和复合索引怎么选择"></a>3.7 单列索引和复合索引怎么选择</h2><p>当查询语句的条件中有多个条件，建议将这几个列创建为复合索引，因为创建单列索引很容易回表查询。</p>
<p>例如分别给emp5表ename，job添加两个单列索引：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> emp5 <span class="keyword">as</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> emp;</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> emp5 <span class="keyword">add</span> <span class="keyword">constraint</span> emp5_pk <span class="keyword">primary</span> key(empno);</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> index idx_emp5_ename <span class="keyword">on</span> emp5(ename);</span><br><span class="line"><span class="keyword">create</span> index idx_emp5_job <span class="keyword">on</span> emp5(job);</span><br></pre></td></tr></table></figure>
<p>执行以下查询语句：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">explain <span class="keyword">select</span> empno,ename,job <span class="keyword">from</span> emp5 <span class="keyword">where</span> ename<span class="operator">=</span><span class="string">&#x27;SMITH&#x27;</span> <span class="keyword">and</span> job<span class="operator">=</span><span class="string">&#x27;CLERK&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/MySQL/%E4%BD%BF%E7%94%A8%E4%BA%86%E5%8D%95%E5%88%97%E7%B4%A2%E5%BC%95.png" alt="使用了单列索引"></p>
<p>ename和job都出现在查询条件中，可以给emp6表的ename和job创建一个复合索引：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> emp6 <span class="keyword">as</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> emp;</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> emp6 <span class="keyword">add</span> <span class="keyword">constraint</span> emp6_pk <span class="keyword">primary</span> key(empno);</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> index idx_emp6_ename_job <span class="keyword">on</span> emp6(ename,job);</span><br><span class="line">explain <span class="keyword">select</span> empno,ename,job <span class="keyword">from</span> emp6 <span class="keyword">where</span> ename<span class="operator">=</span><span class="string">&#x27;SMITH&#x27;</span> <span class="keyword">and</span> job<span class="operator">=</span><span class="string">&#x27;CLERK&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/MySQL/%E4%BD%BF%E7%94%A8%E4%BA%86%E5%A4%8D%E5%90%88%E7%B4%A2%E5%BC%95.png" alt="使用了复合索引"></p>
<p>对于以上查询语句，使用复合索引避免了回表，因此这种情况下还是建议使用复合索引。</p>
<p><font color="red">PS：创建索引时应考虑最左前缀原则，主字段并且具有很强唯一性的字段建议排在第一位。</font></p>
<p>例如：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> index idx_emp_ename_job <span class="keyword">on</span> emp(ename,job);</span><br></pre></td></tr></table></figure>
<p>和以下方式对比：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> index idx_emp_job_ename <span class="keyword">on</span> emp(job,ename);</span><br></pre></td></tr></table></figure>
<p>由于ename是主字段，并且ename具有很好的唯一性，建议将ename列放在最左边。因此这两种创建复合索引的方式，建议采用第一种。</p>
<p>复合索引底层原理：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/MySQL/%E5%A4%8D%E5%90%88%E7%B4%A2%E5%BC%95%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86.png" alt="复合索引底层原理"></p>
<h2 id="3-8-索引创建原则"><a href="#3-8-索引创建原则" class="headerlink" title="3.8 索引创建原则"></a>3.8 索引创建原则</h2><ul>
<li>表数据量庞大，通常超过百万条数据。</li>
<li>经常出现在<code>where</code>，<code>order by</code>，<code>group by</code>后面的字段建议添加索引。</li>
<li>创建索引的字段尽量具有很强的唯一性。</li>
<li>如果字段存储文本，内容较大，一定要创建前缀索引。</li>
<li>尽量使用复合索引，使用单列索引容易回表查询。</li>
<li>如果一个字段中的数据不会为NULL，建议建表时添加not null约束，这样优化器就知道使用哪个索引列更加有效。</li>
<li>不要创建太多索引，当对数据进行增删改的时候，索引需要重新重新排序。</li>
<li>如果很少的查询，经常的增删改不建议加索引。</li>
</ul>
<h1 id="4-SQL优化"><a href="#4-SQL优化" class="headerlink" title="4. SQL优化"></a>4. SQL优化</h1><h2 id="4-1-order-by优化"><a href="#4-1-order-by优化" class="headerlink" title="4.1 order by优化"></a>4.1 order by优化</h2><p>准备数据：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> if <span class="keyword">exists</span> workers;</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> workers(</span><br><span class="line">  id <span class="type">int</span> <span class="keyword">primary</span> key auto_increment,</span><br><span class="line">  name <span class="type">varchar</span>(<span class="number">255</span>),</span><br><span class="line">  age <span class="type">int</span>,</span><br><span class="line">  sal <span class="type">int</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> workers <span class="keyword">values</span>(<span class="keyword">null</span>, <span class="string">&#x27;孙悟空&#x27;</span>, <span class="number">500</span>, <span class="number">50000</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> workers <span class="keyword">values</span>(<span class="keyword">null</span>, <span class="string">&#x27;猪八戒&#x27;</span>, <span class="number">300</span>, <span class="number">40000</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> workers <span class="keyword">values</span>(<span class="keyword">null</span>, <span class="string">&#x27;沙和尚&#x27;</span>, <span class="number">600</span>, <span class="number">40000</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> workers <span class="keyword">values</span>(<span class="keyword">null</span>, <span class="string">&#x27;白骨精&#x27;</span>, <span class="number">600</span>, <span class="number">10000</span>);</span><br></pre></td></tr></table></figure>

<p>explain查看一个带有<code>order by</code>的语句时，Extra列会显示：using index 或者 using filesort，区别是什么？</p>
<ul>
<li>using index:  表示使用索引，因为索引是提前排好序的。效率很高。</li>
<li>using filesort：表示使用文件排序，这就表示没有走索引，对表中数据进行排序，排序时将硬盘的数据读取到内存当中，在内存当中排好序。这个效率是低的，应避免。</li>
</ul>
<p>此时name没有添加索引，如果根据name进行排序的话：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">explain <span class="keyword">select</span> id,name <span class="keyword">from</span> workers <span class="keyword">order</span> <span class="keyword">by</span> name;</span><br></pre></td></tr></table></figure>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/MySQL/name%E6%B2%A1%E6%9C%89%E6%B7%BB%E5%8A%A0%E7%B4%A2%E5%BC%95%E6%A0%B9%E6%8D%AEname%E8%BF%9B%E8%A1%8C%E6%8E%92%E5%BA%8F.png" alt="name没有添加索引根据name进行排序"></p>
<p>显然这种方式效率较低。</p>
<p>给name添加索引：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> index idx_workers_name <span class="keyword">on</span> workers(name);</span><br></pre></td></tr></table></figure>
<p>再根据name排序：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">explain <span class="keyword">select</span> id,name <span class="keyword">from</span> workers <span class="keyword">order</span> <span class="keyword">by</span> name;</span><br></pre></td></tr></table></figure>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/MySQL/%E7%BB%99name%E6%B7%BB%E5%8A%A0%E7%B4%A2%E5%BC%95%E6%A0%B9%E6%8D%AEname%E8%BF%9B%E8%A1%8C%E6%8E%92%E5%BA%8F%E7%9A%84%E8%AF%9D.png" alt="给name添加索引根据name进行排序的话"></p>
<p>这样效率则提升了。</p>
<p>如果要通过age和sal两个字段进行排序，最好给age和sal两个字段添加复合索引，不添加复合索引时：</p>
<p>按照age升序排，如果age相同则按照sal升序</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">explain <span class="keyword">select</span> id,age,sal <span class="keyword">from</span> workers <span class="keyword">order</span> <span class="keyword">by</span> age,sal;</span><br></pre></td></tr></table></figure>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/MySQL/%E4%B8%8D%E6%B7%BB%E5%8A%A0%E5%A4%8D%E5%90%88%E7%B4%A2%E5%BC%95%E6%97%B6%E6%8C%89%E7%85%A7age%E5%8D%87%E5%BA%8Fsal%E5%8D%87%E5%BA%8F.png" alt="不添加复合索引时按照age升序sal升序"></p>
<p>这样效率是低的。</p>
<p>给age和sal添加复合索引：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> index idx_workers_age_sal <span class="keyword">on</span> workers(age, sal);</span><br></pre></td></tr></table></figure>
<p>再按照age升序排，如果age相同则按照sal升序：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">explain <span class="keyword">select</span> id,age,sal <span class="keyword">from</span> workers <span class="keyword">order</span> <span class="keyword">by</span> age,sal;</span><br></pre></td></tr></table></figure>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/MySQL/%E6%B7%BB%E5%8A%A0%E5%A4%8D%E5%90%88%E7%B4%A2%E5%BC%95%E6%97%B6%E6%8C%89%E7%85%A7age%E5%8D%87%E5%BA%8Fsal%E5%8D%87%E5%BA%8F.png" alt="添加复合索引时按照age升序sal升序"></p>
<p>这样效率提升了。</p>
<p>在B+树上叶子结点上的所有数据默认是按照升序排列的，如果按照age降序，如果age相同则按照sal降序，会走索引吗？</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">explain <span class="keyword">select</span> id,age,sal <span class="keyword">from</span> workers <span class="keyword">order</span> <span class="keyword">by</span> age <span class="keyword">desc</span>,sal <span class="keyword">desc</span>;</span><br></pre></td></tr></table></figure>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/MySQL/%E5%8F%8D%E5%90%91%E7%B4%A2%E5%BC%95%E6%89%AB%E6%8F%8F%E4%BD%BF%E7%94%A8%E7%B4%A2%E5%BC%95.png" alt="反向索引扫描使用索引"></p>
<p>可以看到备注信息是：反向索引扫描，使用了索引。</p>
<p>这样效率也是很高的，因为B+树叶子结点之间采用的是双向指针。可以从左向右（升序），也可以从右向左（降序）。</p>
<p>如果一个升序，一个降序会怎样呢？</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">explain <span class="keyword">select</span> id,age,sal <span class="keyword">from</span> workers <span class="keyword">order</span> <span class="keyword">by</span> age <span class="keyword">asc</span>, sal <span class="keyword">desc</span>;</span><br></pre></td></tr></table></figure>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/MySQL/age%E5%8D%87%E5%BA%8Fsal%E9%99%8D%E5%BA%8F.png" alt="age升序sal降序"></p>
<p>可见age使用了索引，但是sal没有使用索引。怎么办呢？可以针对这种排序情况创建对应的索引来解决：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> index idx_workers_ageasc_saldesc <span class="keyword">on</span> workers(age <span class="keyword">asc</span>, sal <span class="keyword">desc</span>);</span><br></pre></td></tr></table></figure>
<p>创建的索引如下：A表示升序，D表示降序。</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/MySQL/%E5%88%9B%E5%BB%BAidx_workers_ageasc_saldesc%E7%B4%A2%E5%BC%95.png" alt="创建idx_workers_ageasc_saldesc索引"></p>
<p>再次执行：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">explain <span class="keyword">select</span> id,age,sal <span class="keyword">from</span> workers <span class="keyword">order</span> <span class="keyword">by</span> age <span class="keyword">asc</span>, sal <span class="keyword">desc</span>;</span><br></pre></td></tr></table></figure>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/MySQL/%E4%BD%BF%E7%94%A8%E4%BA%86idx_workers_ageasc_saldesc%E7%B4%A2%E5%BC%95.png" alt="使用了idx_workers_ageasc_saldesc索引"></p>
<p>我们再来看看，对于排序来说是否支持最左前缀法则：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">explain <span class="keyword">select</span> id,age,sal <span class="keyword">from</span> workers <span class="keyword">order</span> <span class="keyword">by</span> sal;</span><br></pre></td></tr></table></figure>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/MySQL/%E6%8E%92%E5%BA%8F%E9%81%B5%E5%BE%AA%E6%9C%80%E5%B7%A6%E5%89%8D%E7%BC%80%E6%B3%95%E5%88%99.png" alt="排序遵循最左前缀法则"></p>
<p>通过测试得知，order by也遵循最左前缀法则。</p>
<p>我们再来看一下未使用覆盖索引会怎样？</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> workers <span class="keyword">order</span> <span class="keyword">by</span> age,sal;</span><br></pre></td></tr></table></figure>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/MySQL/%E6%8E%92%E5%BA%8F%E6%9C%AA%E4%BD%BF%E7%94%A8%E8%A6%86%E7%9B%96%E7%B4%A2%E5%BC%95.png" alt="排序未使用覆盖索引"></p>
<p>通过测试得知，排序也要尽量使用覆盖索引。</p>
<p>order by 优化原则总结：</p>
<ul>
<li>排序也要遵循最左前缀法则。</li>
<li>使用覆盖索引。</li>
<li>针对不同的排序规则，创建不同索引。（如果所有字段都是升序，或者所有字段都是降序，则不需要创建新的索引）</li>
<li>如果无法避免filesort，要注意排序缓存的大小，默认缓存大小256KB，可以修改系统变量 sort_buffer_size ：<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;sort_buffer_size&#x27;</span>;</span><br></pre></td></tr></table></figure>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/MySQL/%E7%B3%BB%E7%BB%9F%E5%8F%98%E9%87%8Fsort_buffer_size.png" alt="系统变量sort_buffer_size"></li>
</ul>
<h2 id="4-2-group-by优化"><a href="#4-2-group-by优化" class="headerlink" title="4.2 group by优化"></a>4.2 group by优化</h2><p>创建empx表：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> empx <span class="keyword">as</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> emp;</span><br></pre></td></tr></table></figure>
<p>job字段上没有索引，根据job进行分组，查看每个工作岗位有多少人：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> job,<span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> empx <span class="keyword">group</span> <span class="keyword">by</span> job;</span><br></pre></td></tr></table></figure>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/MySQL/job%E5%AD%97%E6%AE%B5%E4%B8%8A%E6%B2%A1%E6%9C%89%E7%B4%A2%E5%BC%95%E6%A0%B9%E6%8D%AEjob%E8%BF%9B%E8%A1%8C%E5%88%86%E7%BB%84.png" alt="job字段上没有索引根据job进行分组"></p>
<p>看看是否走索引了：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">explain <span class="keyword">select</span> job,<span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> empx <span class="keyword">group</span> <span class="keyword">by</span> job;</span><br></pre></td></tr></table></figure>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/MySQL/%E4%BD%BF%E7%94%A8%E4%BA%86%E4%B8%B4%E6%97%B6%E8%A1%A8.png" alt="使用了临时表"></p>
<p>使用了临时表，效率较低。</p>
<p>给job添加索引：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> index idx_empx_job <span class="keyword">on</span> empx(job);</span><br></pre></td></tr></table></figure>
<p>再次执行：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">explain <span class="keyword">select</span> job,<span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> empx <span class="keyword">group</span> <span class="keyword">by</span> job;</span><br></pre></td></tr></table></figure>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/MySQL/%E4%BD%BF%E7%94%A8idx_empx_job%E7%B4%A2%E5%BC%95.png" alt="使用idx_empx_job索引"></p>
<p>效率提升了。</p>
<p>我们再来看看<code>group by</code>是否需要遵守最左前缀法则：给deptno和sal添加复合索引</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> index idx_empx_deptno_sal <span class="keyword">on</span> empx(deptno, sal);</span><br></pre></td></tr></table></figure>
<p>根据部门编号分组，查看每个部门人数：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">explain <span class="keyword">select</span> deptno,<span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> empx <span class="keyword">group</span> <span class="keyword">by</span> deptno;</span><br></pre></td></tr></table></figure>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/MySQL/%E4%BD%BF%E7%94%A8%E4%BA%86idx_empx_deptno_sal%E7%B4%A2%E5%BC%95.png" alt="使用了idx_empx_deptno_sal索引"></p>
<p>效率很高，因为deptno是复合索引中最左边的字段。</p>
<p>根据sal分组，查看每个工资有多少人：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">explain <span class="keyword">select</span> sal, <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> empx <span class="keyword">group</span> <span class="keyword">by</span> sal;</span><br></pre></td></tr></table></figure>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/MySQL/%E6%A0%B9%E6%8D%AEsal%E5%88%86%E7%BB%84.png" alt="根据sal分组"></p>
<p>使用了临时表，效率较低。</p>
<p>通过测试得知，<code>group by</code>也同样遵循最左前缀法则。</p>
<p>我们再来测试一下，如果将部门编号deptno（复合索引的最左列）添加到where条件中，效率会不会提升：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">explain <span class="keyword">select</span> sal, <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> empx <span class="keyword">where</span> deptno<span class="operator">=</span><span class="number">10</span> <span class="keyword">group</span> <span class="keyword">by</span> sal;</span><br></pre></td></tr></table></figure>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/MySQL/%E5%B0%86%E9%83%A8%E9%97%A8%E7%BC%96%E5%8F%B7deptno%EF%BC%88%E5%A4%8D%E5%90%88%E7%B4%A2%E5%BC%95%E7%9A%84%E6%9C%80%E5%B7%A6%E5%88%97%EF%BC%89%E6%B7%BB%E5%8A%A0%E5%88%B0where%E6%9D%A1%E4%BB%B6%E4%B8%AD.png" alt="将部门编号deptno（复合索引的最左列）添加到where条件中"></p>
<p>效率有提升的，这说明了，<code>group by</code>确实也遵循最左前缀法则。（where中使用了最左列)</p>
<h2 id="4-3-limit优化"><a href="#4-3-limit优化" class="headerlink" title="4.3 limit优化"></a>4.3 limit优化</h2><p>数据量特别庞大时，取数据时，越往后效率越低，怎么提升？mysql官方给出的解决方案是：使用覆盖索引+子查询的形式来提升效率。</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/MySQL/limit%E4%BC%98%E5%8C%96-%E6%9F%A5%E8%AF%A2%E6%95%88%E7%8E%87(1).png" alt="limit优化-查询效率(1)" style="zoom:67%;">

<p>怎么解决？使用覆盖索引，加子查询</p>
<p>使用覆盖索引：速度有所提升</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/MySQL/limit%E4%BC%98%E5%8C%96-%E6%9F%A5%E8%AF%A2%E6%95%88%E7%8E%87(2).png" alt="limit优化-查询效率(2)"></p>
<p>使用子查询形式取其他列的数据：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/MySQL/limit%E4%BC%98%E5%8C%96-%E6%9F%A5%E8%AF%A2%E6%95%88%E7%8E%87(3).png" alt="limit优化-查询效率(3)" style="zoom:67%;">

<p>通过测试，这种方式整体效率有所提升。</p>
<h2 id="4-4-主键优化"><a href="#4-4-主键优化" class="headerlink" title="4.4 主键优化"></a>4.4 主键优化</h2><p>主键设计原则：</p>
<ul>
<li>主键值不要太长，二级索引叶子结点上存储的是主键值，主键值太长，容易导致索引占用空间较大。</li>
<li>尽量使用auto_increment生成主键。尽量不要使用uuid做主键，因为uuid不是顺序插入。</li>
<li>最好不要使用业务主键，因为业务的变化会导致主键值的频繁修改，主键值不建议修改，因为主键值修改，聚集索引一定会重新排序。</li>
<li>在插入数据时，主键值最好是顺序插入，不要乱序插入，因为乱序插入可能会导致B+树叶子结点频繁的进行页分裂与页合并操作，效率较低。<ol>
<li>主键值对应聚集索引，插入主键值如果是乱序的，B+树叶子结点需要不断的重新排序，重排过程中还会频繁涉及到<strong>页分裂和页合并</strong>的操作，效率较低。</li>
<li>B+树上的每个节点都存储在页（page）中。一个页面中存储一个节点。</li>
<li>MySQL的InnoDB存储引擎一个页可以存储16KB的数据。</li>
<li>如果主键值不是顺序插入的话，会导致频繁的页分裂和页合并。在一个B+树中，页分裂和页合并是树的自动调整机制的一部分。当一个页已经满了，再插入一个新的关键字时就会触发页分裂操作，将页中的关键字分配到两个新的页中，同时调整树的结构。相反，当一个页中的关键字数量下降到一个阈值以下时，就会触发页合并操作，将两个相邻的页合并成一个新的页。如果主键值是随机的、不是顺序插入的，那么页的利用率会降低，页分裂和页合并的次数就会增加。由于页的分裂和合并是比较耗时的操作，频繁的分裂和合并会降低数据库系统的性能。因此，为了优化B+树的性能，可以将主键值设计成顺序插入的，这样可以减少页的分裂和合并的次数，提高B+树的性能。在实际应用中，如果对主键值的顺序性能要求不是特别高，也可以采用一些技术手段来减少页分裂和合并，例如B+树分裂时采用“延迟分裂”技术，或者通过调整页的大小和节点的大小等方式来优化B+树的性能。</li>
</ol>
</li>
</ul>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/MySQL/%E5%BB%B6%E8%BF%9F%E5%88%86%E8%A3%82%E6%8A%80%E6%9C%AF.jpeg" alt="延迟分裂技术" style="zoom: 25%;">

<h2 id="4-5-insert优化"><a href="#4-5-insert优化" class="headerlink" title="4.5 insert优化"></a>4.5 insert优化</h2><p>insert优化原则：</p>
<ul>
<li><p>批量插入：数据量较大时，不要一条一条插入，可以批量插入，当然，建议一次插入数据不超过1000条。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t_user(id,name,age) <span class="keyword">values</span> (<span class="number">1</span>,<span class="string">&#x27;jack&#x27;</span>,<span class="number">20</span>),(<span class="number">2</span>,<span class="string">&#x27;lucy&#x27;</span>,<span class="number">30</span>),(<span class="number">3</span>,<span class="string">&#x27;timi&#x27;</span>,<span class="number">22</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>mysql默认是自动提交事务，只要执行一条DML语句就自动提交一次，因此，当插入大量数据时，建议手动开启事务和手动提交事务。不建议使用数据库事务自动提交机制。</p>
</li>
<li><p>主键值建议采用顺序插入，顺序插入比乱序插入效率高。</p>
</li>
<li><p>超大数据量插入可以考虑使用mysql提供的load指令，load指令可以将csv文件中的数据批量导入到数据库表当中，并且效率很高，过程如下：</p>
<p> 1、登录mysql时指定参数</p>
 <figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">mysql <span class="comment">--local-infile -uroot -proot</span></span><br></pre></td></tr></table></figure>

<p> 2、开启local_infile功能</p>
 <figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">set</span> <span class="keyword">global</span> local_infile <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p> 3、执行load指令</p>
 <figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">use muyoukule;</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> t_temp(</span><br><span class="line">  id <span class="type">int</span> <span class="keyword">primary</span> key,</span><br><span class="line">  name <span class="type">varchar</span>(<span class="number">255</span>),</span><br><span class="line">  password <span class="type">varchar</span>(<span class="number">255</span>),</span><br><span class="line">  birth <span class="type">char</span>(<span class="number">10</span>),</span><br><span class="line">  email <span class="type">varchar</span>(<span class="number">255</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">load data <span class="keyword">local</span> infile <span class="string">&#x27;D:\\muyoukule.csv&#x27;</span> <span class="keyword">into</span> <span class="keyword">table</span> t_temp fields terminated <span class="keyword">by</span> <span class="string">&#x27;,&#x27;</span> lines terminated <span class="keyword">by</span> <span class="string">&#x27;\n&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p> 文件中的数据如下：</p>
<p> <img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/MySQL/muyoukule.csv%E6%96%87%E4%BB%B6%E4%B8%AD%E7%9A%84%E6%95%B0%E6%8D%AE.png" alt="muyoukule.csv文件中的数据"></p>
<p> 导入表中之后，数据如下：</p>
<p> <img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/MySQL/muyoukule.csv%E6%96%87%E4%BB%B6%E4%B8%AD%E7%9A%84%E6%95%B0%E6%8D%AE%E5%AF%BC%E5%85%A5%E8%A1%A8%E4%B8%AD.png" alt="muyoukule.csv文件中的数据导入表中"></p>
</li>
</ul>
<h2 id="4-6-count-优化"><a href="#4-6-count-优化" class="headerlink" title="4.6 count(*)优化"></a>4.6 count(*)优化</h2><p>分组函数count的使用方式：</p>
<ul>
<li>count(主键)<ul>
<li>原理：将每个主键值取出，累加</li>
</ul>
</li>
<li>count(常量值)<ul>
<li>原理：获取到每个常量值，累加</li>
</ul>
</li>
<li>count(字段)<ul>
<li>原理：取出字段的每个值，判断是否为NULL，不为NULL则累加。</li>
</ul>
</li>
<li>count(*)<ul>
<li>原理：不用取值，底层mysql做了优化，直接统计总行数，效率最高。</li>
</ul>
</li>
</ul>
<p><strong>结论：如果你要统计一张表中数据的总行数，建议使用 count(*)</strong></p>
<p><strong>注意：</strong></p>
<ul>
<li>对于InnoDB存储引擎来说，count计数的实现原理就是将表中每一条记录取出，然后累加。如果你想真正提高效率，可以自己使用额外的其他程序来实现，例如每向表中插入一条记录时，在redis数据库中维护一个总行数，这样获取总行数的时候，直接从redis中获取即可，这样效率是最高的。</li>
<li>对于MyISAM存储引擎来说，当一个select语句没有where条件时，获取总行数效率是极高的，不需要统计，因为MyISAM存储引擎维护了一个单独的总行数。</li>
</ul>
<h2 id="4-7-update优化"><a href="#4-7-update优化" class="headerlink" title="4.7 update优化"></a>4.7 update优化</h2><p>当存储引擎是InnoDB时，表的行级锁是针对索引添加的锁，如果索引失效了，或者不是索引列时，会提升为表级锁。<br>什么是行级锁？A事务和B事务，开启A事务后，通过A事务修改表中某条记录，修改后，在A事务未提交的前提下，B事务去修改同一条记录时，无法继续，直到A事务提交，B事务才可以继续。</p>
<p>有一张表：t_fruit</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> t_fruit(</span><br><span class="line">  id <span class="type">int</span> <span class="keyword">primary</span> key auto_increment,</span><br><span class="line">  name <span class="type">varchar</span>(<span class="number">255</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t_fruit <span class="keyword">values</span>(<span class="keyword">null</span>, <span class="string">&#x27;苹果&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t_fruit <span class="keyword">values</span>(<span class="keyword">null</span>, <span class="string">&#x27;香蕉&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t_fruit <span class="keyword">values</span>(<span class="keyword">null</span>, <span class="string">&#x27;橘子&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>开启A事务和B事务，演示行级锁：</p>
<p>事务A没有结束之前，事务B卡住：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/MySQL/%E4%BA%8B%E5%8A%A1A%E6%B2%A1%E6%9C%89%E7%BB%93%E6%9D%9F%E4%B9%8B%E5%89%8D%EF%BC%8C%E4%BA%8B%E5%8A%A1B%E5%8D%A1%E4%BD%8F.png" alt="事务A没有结束之前，事务B卡住"></p>
<p>事务A结束之后，事务B继续执行：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/MySQL/%E4%BA%8B%E5%8A%A1A%E7%BB%93%E6%9D%9F%E4%B9%8B%E5%90%8E%EF%BC%8C%E4%BA%8B%E5%8A%A1B%E7%BB%A7%E7%BB%AD%E6%89%A7%E8%A1%8C.png" alt="事务A结束之后，事务B继续执行"></p>
<p>当然，如果更新的不是同一行数据，事务A和事务B可以并发：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/MySQL/%E6%9B%B4%E6%96%B0%E7%9A%84%E4%B8%8D%E6%98%AF%E5%90%8C%E4%B8%80%E8%A1%8C%E6%95%B0%E6%8D%AE%EF%BC%8C%E4%BA%8B%E5%8A%A1A%E5%92%8C%E4%BA%8B%E5%8A%A1B%E5%8F%AF%E4%BB%A5%E5%B9%B6%E5%8F%91.png" alt="更新的不是同一行数据，事务A和事务B可以并发"></p>
<p>行级锁是对索引列加锁，以上更新语句的where条件是id，id是主键，当然有索引，所以使用了行级锁，如果索引失效，或者字段上没有索引，则会升级为表级锁：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/MySQL/%E8%A1%A8%E7%BA%A7%E9%94%81.png" alt="表级锁"></p>
<p>因此，为了更新的效率，建议update语句中where条件中的字段是添加索引的。</p>
]]></content>
      <categories>
        <category>DB</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>【第3章】 索引</title>
    <url>/posts/44167/</url>
    <content><![CDATA[<h1 id="1-什么是索引"><a href="#1-什么是索引" class="headerlink" title="1. 什么是索引"></a>1. 什么是索引</h1><p>索引是一种能够提高检索（查询）效率的提前排好序的数据结构。例如：书的目录就是一种索引机制。索引是解决SQL慢查询的一种方式。</p>
<h1 id="2-索引的创建和删除"><a href="#2-索引的创建和删除" class="headerlink" title="2. 索引的创建和删除"></a>2. 索引的创建和删除</h1><h2 id="2-1-主键会自动添加索引"><a href="#2-1-主键会自动添加索引" class="headerlink" title="2.1 主键会自动添加索引"></a>2.1 主键会自动添加索引</h2><p>主键字段会自动添加索引，不需要程序员干涉，主键字段上的索引被称为<code>主键索引</code></p>
<h2 id="2-2-unique约束的字段自动添加索引"><a href="#2-2-unique约束的字段自动添加索引" class="headerlink" title="2.2 unique约束的字段自动添加索引"></a>2.2 unique约束的字段自动添加索引</h2><p>unique约束的字段也会自动添加索引，不需要程序员干涉，这种字段上添加的索引称为<code>唯一索引</code></p>
<h2 id="2-3-给指定的字段添加索引"><a href="#2-3-给指定的字段添加索引" class="headerlink" title="2.3 给指定的字段添加索引"></a>2.3 给指定的字段添加索引</h2><p>建表时添加索引：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> emp (</span><br><span class="line">    ...</span><br><span class="line">    name <span class="type">varchar</span>(<span class="number">255</span>),</span><br><span class="line">    ...</span><br><span class="line">    INDEX idx_name (name)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>如果表已经创建好了，后期给字段添加索引</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> emp <span class="keyword">ADD</span> INDEX idx_name (name);</span><br></pre></td></tr></table></figure>
<p>也可以这样添加索引：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> index idx_name <span class="keyword">on</span> emp(name);</span><br></pre></td></tr></table></figure>


<h2 id="2-4-删除指定字段上的索引"><a href="#2-4-删除指定字段上的索引" class="headerlink" title="2.4 删除指定字段上的索引"></a>2.4 删除指定字段上的索引</h2><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> emp <span class="keyword">DROP</span> INDEX idx_name;</span><br></pre></td></tr></table></figure>
<h2 id="2-5-查看某张表上添加了哪些索引"><a href="#2-5-查看某张表上添加了哪些索引" class="headerlink" title="2.5 查看某张表上添加了哪些索引"></a>2.5 查看某张表上添加了哪些索引</h2><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">show</span> index <span class="keyword">from</span> 表名;</span><br></pre></td></tr></table></figure>


<h1 id="3-索引的分类"><a href="#3-索引的分类" class="headerlink" title="3. 索引的分类"></a>3. 索引的分类</h1><p>不同的<code>存储引擎</code>有不同的索引类型和实现：</p>
<ul>
<li>按照数据结构分类：<ul>
<li>B+树 索引（mysql的InnoDB存储引擎采用的就是这种索引）采用 B+树  的数据结构</li>
<li>Hash 索引（仅 <code>memory</code> 存储引擎支持）：采用  哈希表  的数据结构</li>
</ul>
</li>
<li>按照物理存储分类：<ul>
<li>聚集索引：索引和表中数据在一起，数据存储的时候就是按照索引顺序存储的。一张表只能有一个聚集索引。</li>
<li>非聚集索引：索引和表中数据是分开的，索引是独立于表空间的，一张表可以有多个非聚集索引。</li>
</ul>
</li>
<li>按照字段特性分类：<ul>
<li>主键索引（primary key）</li>
<li>唯一索引（unique）</li>
<li>普通索引（index）</li>
<li>全文索引（fulltext：仅 <code>InnoDB和MyISAM</code> 存储引擎支持）</li>
</ul>
</li>
<li>按照字段个数分类：<ul>
<li>单列索引、联合索引（也叫复合索引、组合索引）</li>
</ul>
</li>
</ul>
<h1 id="4-MySQL索引采用了B-树数据结构"><a href="#4-MySQL索引采用了B-树数据结构" class="headerlink" title="4. MySQL索引采用了B+树数据结构"></a>4. MySQL索引采用了B+树数据结构</h1><p>常见的树相关的数据结构包括：</p>
<ul>
<li>二叉树</li>
<li>红黑树</li>
<li>B树</li>
<li>B+树</li>
</ul>
<p>区别：树的高度不同。树的高度越低，性能越高。这是因为每一个节点都是一次I&#x2F;O</p>
<h2 id="4-1-二叉树"><a href="#4-1-二叉树" class="headerlink" title="4.1 二叉树"></a>4.1 二叉树</h2><p>有这样一张表</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/MySQL/%E7%B4%A2%E5%BC%95-%E8%A1%A8(1).png" alt="索引-表(1)" style="zoom: 67%;">

<p>如果不给id字段添加索引，默认进行全表扫描，假设查询id&#x3D;10的数据，那至少要进行10次磁盘IO。效率低。可以给id字段添加索引，假设该索引使用了二叉树这种数据结构，这个二叉树是这样的（<strong>推荐一个数据结构可视化网站<a href="https://www.cs.usfca.edu/~galles/visualization/Algorithms.html">Data Structure Visualizations</a>，是旧金山大学（USFCA）的一个网站</strong>）</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/MySQL/%E7%B4%A2%E5%BC%95-%E4%BA%8C%E5%8F%89%E6%A0%91.png" alt="索引-二叉树" style="zoom:80%;">

<p>如果这个时候要找id&#x3D;10的数据，需要的IO次数是？4次。效率显著提升了。</p>
<p>但是MySQL并没有直接使用这种普通的二叉树，这种普通二叉树在<code>数据极端</code>的情况下，效率较低。比如下面的数据：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/MySQL/%E7%B4%A2%E5%BC%95-%E8%A1%A8(2).png" alt="索引-表(2)" style="zoom:67%;">

<p>如果给id字段添加索引，并且该索引底层使用了普通二叉树，这棵树会是这样的：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/MySQL/%E7%B4%A2%E5%BC%95-%E6%99%AE%E9%80%9A%E4%BA%8C%E5%8F%89%E6%A0%91.png" alt="索引-普通二叉树" style="zoom:67%;">

<p>你虽然使用了二叉树，但这更像一个链表。查找效率等同于链表查询O(n)【<strong>查找算法的时间复杂度是线性的</strong>】。查找效率极低。</p>
<p>因此对于MySQL来说，它并没有选择这种数据结构作为索引。</p>
<h2 id="4-2-红黑树（自平衡二叉树）"><a href="#4-2-红黑树（自平衡二叉树）" class="headerlink" title="4.2 红黑树（自平衡二叉树）"></a>4.2 红黑树（自平衡二叉树）</h2><p>通过自旋平衡规则进行旋转，子节点会自动分叉为2个分支，从而减少树的高度，当数据有序插入时比二叉树数据检索性能更好。</p>
<p>例如有以下数据</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/MySQL/%E7%B4%A2%E5%BC%95-%E8%A1%A8(3).png" alt="索引-表(3)" style="zoom:67%;">

<p>给id字段添加索引，并且该索引使用了<code>红黑树</code>数据结构，那么会是这样：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/MySQL/%E7%B4%A2%E5%BC%95-%E7%BA%A2%E9%BB%91%E6%A0%91.png" alt="索引-红黑树" style="zoom:67%;">

<p>如果查找id&#x3D;10的数据，磁盘IO次数为：5次。效率比普通二叉树要高一些。</p>
<p>但是如果数据量庞大，例如500万条数据，也会导致树的高度很高，磁盘IO次数仍然很多，查询效率也会比较低。</p>
<p>因此MySQL并没有使用红黑树这种数据结构作为索引。</p>
<h2 id="4-3-B-Trees（B树）"><a href="#4-3-B-Trees（B树）" class="headerlink" title="4.3 B Trees（B树）"></a>4.3 B Trees（B树）</h2><p>B Trees首先是一个<code>自平衡</code>的。</p>
<p>B Trees每个节点下的子节点数量 &gt; 2。</p>
<p>B Trees每个节点中也不是存储单个数据，可以存储多个数据。</p>
<p>B Trees又称为<code>平衡多路查找树</code>。</p>
<p>B Trees分支的数量不是2，是大于2，具体是多少个分支，由<code>阶</code>决定。例如：</p>
<ul>
<li>3阶的B Trees，一个节点下最多有3个子节点，每个节点中最多有2个数据。</li>
<li>4阶的B Trees，一个节点下最多有4个子节点，每个节点中最多有3个数据。</li>
<li>5阶（5, 4）</li>
<li>6阶（6, 5）</li>
<li>….</li>
<li>16阶（16, 15）【MySQL采用了16阶】</li>
</ul>
<p>采用B Trees，你会发现相同的数据量，<strong>B Tree 树的高度更低</strong>。磁盘IO次数更少。</p>
<p>3阶的B Trees：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/MySQL/3%E9%98%B6%E7%9A%84B%E6%A0%91.png" alt="3阶的B树" style="zoom: 80%;">

<p><strong>假设id字段添加了索引，并且采用了B Trees数据结构，查找id&#x3D;10的数据，只需要3次磁盘IO。</strong></p>
<p>4阶的B Trees：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/MySQL/4%E9%98%B6%E7%9A%84B%E6%A0%91.png" alt="4阶的B树" style="zoom: 80%;">



<p>更加详细的存储是这样的，请看下图：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/MySQL/%E7%B4%A2%E5%BC%95-%E8%A1%A8(4).png" alt="索引-表(4)" style="zoom:67%;">

<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/MySQL/B%E6%A0%91%E8%AF%A6%E7%BB%86%E7%9A%84%E5%AD%98%E5%82%A8.png" alt="B树详细的存储" style="zoom:67%;">

<p>在B Trees中，每个节点不仅存储了<code>索引值</code>，还存储该索引值对应的<code>数据行</code>。</p>
<p>并且每个节点中的p1 p2 p3是指向下一个节点的指针。</p>
<p>B Trees数据结构存在的缺点是：不适合做区间查找，对于区间查找效率较低。假设要查id在[3~7]之间的，需要查找的是3,4,5,6,7。那么查这每个索引值都需要从头节点开始。</p>
<p>因此MySQL使用了B+ Trees解决了这个问题。</p>
<h2 id="4-4-B-Trees（B-树）"><a href="#4-4-B-Trees（B-树）" class="headerlink" title="4.4 B+ Trees（B+ 树）"></a>4.4 B+ Trees（B+ 树）</h2><p>B+ Trees 相较于 B Trees改进了哪些？</p>
<ul>
<li>B+树将数据都存储在叶子节点中。并且叶子节点之间使用链表连接，这样很适合范围查询。</li>
<li>B+树的非叶子节点上只有索引值，没有数据，所以非叶子节点可以存储更多的索引值，这样让B+树更矮更胖，提高检索效率。</li>
</ul>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/MySQL/%E7%B4%A2%E5%BC%95-B%E5%8A%A0%E6%A0%91.png" alt="索引-B+树" style="zoom:80%;">

<p>假设有这样一张表：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/MySQL/%E7%B4%A2%E5%BC%95-%E8%A1%A8(5).png" alt="索引-表(5)" style="zoom:67%;">

<p>B+ Trees方式存储如下图所示：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/MySQL/B%E5%8A%A0%E6%A0%91%E6%96%B9%E5%BC%8F%E5%AD%98%E5%82%A8.png" alt="B+树方式存储.png" style="zoom: 50%;">

<p><strong>经典面试题：</strong>mysql为什么选择B+树作为索引的数据结构，而不是B树？</p>
<ol>
<li>非叶子节点上可以存储更多的键值，阶数可以更大，更矮更胖，磁盘IO次数少，数据查询效率高。</li>
<li>所有数据都是有序存储在叶子节点上，让范围查找，分组查找效率更高。</li>
<li>数据页之间、数据记录之间采用链表链接，让升序降序更加方便操作。</li>
</ol>
<p><strong>经典面试题：</strong>如果一张表没有主键索引，那还会创建B+树吗？</p>
<p>当一张表没有主键索引时，默认会使用一个隐藏的内置的聚集索引（clustered index）。这个聚集索引是基于表的物理存储顺序构建的，通常是使用B+树来实现的。</p>
<h1 id="5-其他索引及相关调优"><a href="#5-其他索引及相关调优" class="headerlink" title="5. 其他索引及相关调优"></a>5. 其他索引及相关调优</h1><h2 id="5-1-Hash索引"><a href="#5-1-Hash索引" class="headerlink" title="5.1 Hash索引"></a>5.1 Hash索引</h2><p>支持Hash索引的存储引擎有：</p>
<ul>
<li>InnoDB（不支持手动创建Hash索引，系统会自动维护一个<code>自适应的Hash索引</code>）<ul>
<li>对于InnoDB来说，即使手动指定了某字段采用Hash索引，最终<code>show index from 表名</code>的时候，还是<code>BTREE</code>。</li>
</ul>
</li>
<li>Memory（支持Hash索引）</li>
</ul>
<p>Hash索引底层的数据结构就是哈希表。一个数组，数组中每个元素是链表。和java中HashMap一样。哈希表中每个元素都是key value结构。key存储<code>索引值</code>，value存储<code>行指针</code>。</p>
<p>原理如下：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/MySQL/%E7%B4%A2%E5%BC%95-%E8%A1%A8(6).png" alt="索引-表(6)"></p>
<p>如果name字段上添加了Hash索引idx_name</p>
<p>Hash索引长这个样子：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/MySQL/%E7%B4%A2%E5%BC%95-%E8%A1%A8(7).png" alt="索引-表(7)" style="zoom:67%;">

<p>检索原理：假设 name&#x3D;’孙行者’。通过哈希算法将’孙行者’转换为数组下标，通过下标找链表，在链表上遍历找到孙行者的行指针。</p>
<p>注意：不同的字符串，经过哈希算法得到的数组下标可能相同，这叫做<strong>哈希碰撞&#x2F;哈希冲突</strong>。【不过，好的哈希算法应该具有很低的碰撞概率。常用的哈希算法如MD5、SHA-1、SHA-256等都被设计为尽可能减少碰撞的发生。】</p>
<p>Hash索引优缺点：</p>
<ul>
<li>优点：只能用在等值比较中，效率很高。例如：name&#x3D;’孙悟空’</li>
<li>缺点：不支持排序，不支持范围查找。</li>
</ul>
<h2 id="5-2-聚集索引和非聚集索引"><a href="#5-2-聚集索引和非聚集索引" class="headerlink" title="5.2 聚集索引和非聚集索引"></a>5.2 聚集索引和非聚集索引</h2><p>按照数据的物理存储方式不同，可以将索引分为聚集索引（聚簇索引）和非聚集索引（非聚簇索引）。</p>
<p>存储引擎是InnoDB的，主键上的索引属于聚集索引。</p>
<p>存储引擎是MyISAM的，任意字段上的索引都是非聚集索引。</p>
<p>InnoDB的物理存储方式：当创建一张表t_user，并使用InnoDB存储引擎时，会在硬盘上生成这样一个文件：</p>
<ul>
<li>t_user.ibd （InnoDB data表索引 + 数据）</li>
<li>t_user.frm （存储表结构信息）</li>
</ul>
<p>MyISAM的物理存储方式：当创建一张表t_user，并使用MyISAM存储引擎时，会在硬盘上生成这样一个文件：</p>
<ul>
<li>t_user.MYD （表数据）</li>
<li>t_user.MYI （表索引）</li>
<li>t_user.frm （表结构）</li>
</ul>
<p><strong>注意：从MySQL8.0开始，不再生成frm文件了，引入了数据字典，用数据字典来统一存储表结构信息，例如：</strong></p>
<ul>
<li><strong>information_schema.TABLES （表包含了数据库中所有表的信息，例如表名、数据库名、引擎类型等）</strong></li>
<li><strong>information_schema.COLUMNS（表包含了数据库中所有表的列信息，例如列名、数据类型、默认值等）</strong></li>
</ul>
<p>聚集索引的原理图：（B+树，叶子节点上存储了索引值 + 数据）</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/MySQL/%E8%81%9A%E9%9B%86%E7%B4%A2%E5%BC%95%E7%9A%84%E5%8E%9F%E7%90%86%E5%9B%BE.png" alt="聚集索引的原理图" style="zoom: 50%;">

<p>非聚集索引的原理图：（B+树，叶子节点上存储了索引值 + 行指针）</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/MySQL/%E9%9D%9E%E8%81%9A%E9%9B%86%E7%B4%A2%E5%BC%95%E7%9A%84%E5%8E%9F%E7%90%86%E5%9B%BE.png" alt="非聚集索引的原理图" style="zoom: 50%;">

<p>聚集索引的优点和缺点：</p>
<ul>
<li>优点：聚集索引将数据存储在索引树的叶子节点上。可以减少一次查询，因为查询索引树的同时可以获取数据。</li>
<li>缺点：对数据进行修改或删除时需要更新索引树，会增加系统的开销。</li>
</ul>
<h2 id="5-3-二级索引"><a href="#5-3-二级索引" class="headerlink" title="5.3 二级索引"></a>5.3 二级索引</h2><p>二级索引也属于非聚集索引。也有人把二级索引称为辅助索引。</p>
<p>有表t_user，<code>id</code>是主键。<code>age</code>是非主键。在<code>age</code>字段上添加的索引称为二级索引。（所有非主键索引都是二级索引）</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/MySQL/%E7%B4%A2%E5%BC%95-%E8%A1%A8(8).png" alt="索引-表(8)"></p>
<p>二级索引的数据结构：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/MySQL/%E4%BA%8C%E7%BA%A7%E7%B4%A2%E5%BC%95%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84.png" alt="二级索引的数据结构"></p>
<p>二级索引的查询原理：</p>
<p>假设查询语句为：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_user <span class="keyword">where</span> age <span class="operator">=</span> <span class="number">30</span>;</span><br></pre></td></tr></table></figure>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/MySQL/%E4%BA%8C%E7%BA%A7%E7%B4%A2%E5%BC%95%E5%9B%9E%E8%A1%A8.png" alt="二级索引回表" style="zoom:67%;">

<p>为什么会“回表”？因为使用了<code>select *</code></p>
<p>避免“回表【回到原数据表】”是提高SQL执行效率的手段。例如：select id from t_user where age &#x3D; 30；这样的SQL语句是不需要回表的。</p>
<h2 id="5-4-覆盖索引"><a href="#5-4-覆盖索引" class="headerlink" title="5.4 覆盖索引"></a>5.4 覆盖索引</h2><p>覆盖索引（Covering Index），顾名思义，是指某个查询语句可以通过索引的覆盖来完成，而不需要回表查询真实数据。其中的覆盖指的是在执行查询语句时，查询需要的所有列都可以从索引中提取到，而不需要再去查询实际数据行获取查询所需数据。</p>
<p>当使用覆盖索引时，MySQL可以直接通过索引，也就是索引上的数据来获取所需的结果，而不必再去查找表中的数据。这样可以显著提高查询性能。</p>
<p>假设有一个用户表（user）包含以下列：id, username, email, age。</p>
<p>常见的查询是根据用户名查询用户的邮箱。如果为了提高这个查询的性能，可以创建一个覆盖索引，包含（username, email）这两列。</p>
<p>创建覆盖索引的SQL语句可以如下：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> INDEX idx_user_username_email <span class="keyword">ON</span> <span class="keyword">user</span> (username, email);</span><br></pre></td></tr></table></figure>

<p>当执行以下查询时：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> email <span class="keyword">FROM</span> <span class="keyword">user</span> <span class="keyword">WHERE</span> username <span class="operator">=</span> <span class="string">&#x27;lucy&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>MySQL可以直接使用覆盖索引（idx_user_username_email）来获取查询结果，而不必再去查找用户表中的数据。这样可以减少磁盘I&#x2F;O并提高查询效率。而如果没有覆盖索引，MySQL会先使用索引（username）来找到匹配的行，然后再回表查询获取邮箱，这个过程会增加更多的磁盘I&#x2F;O和查询时间。</p>
<p>值得注意的是，覆盖索引的创建需要考虑查询的字段选择。如果查询需要的字段较多，可能需要创建包含更多列的覆盖索引，以满足完全覆盖查询的需要。</p>
<p>覆盖索引具有以下优点：</p>
<ul>
<li>提高查询性能：覆盖索引能够满足查询的所有需求，同时不需要访问表中的实际数据行，从而可以提高查询性能。这是因为DBMS可以直接使用索引来执行查询，而不需要从磁盘读取实际的数据行。</li>
<li>减少磁盘和内存访问次数：当使用覆盖索引时，DBMS不需要访问实际的数据行。这样可以减少磁盘和内存访问次数，从而提高查询性能。</li>
<li>减少网络传输：由于在覆盖索引中可以存储所有查询所需的列，因此可以减少数据的网络传输次数，从而提高查询的性能。</li>
<li>可以降低系统开销：在高压力的数据库系统中，使用覆盖索引可以减少系统开销，从而提高系统的可靠性和可维护性。</li>
</ul>
<p>覆盖索引的缺点包括：</p>
<ul>
<li>需要更多的内存：覆盖索引需要存储查询所需的所有列，因此需要更多的内存来存储索引。在大型数据库系统中，这可能会成为一项挑战。</li>
<li>会使索引变得庞大：当索引中包含了许多列时，它们可能会使索引变得非常庞大，从而影响查询性能，并且可能会占用大量的磁盘空间。</li>
<li>只有在查询中包含了索引列时才能使用：只有当查询中包含了所有的索引列时才能使用覆盖索引。如果查询中包含了其他列，DBMS仍然需要访问实际的数据行，并且无法使用覆盖索引提高查询性能。</li>
</ul>
<h2 id="5-5-索引下推"><a href="#5-5-索引下推" class="headerlink" title="5.5 索引下推"></a>5.5 索引下推</h2><p>索引下推（Index Condition Pushdown）是一种 MySQL 中的优化方法，它可以将查询中的过滤条件下推到索引层级中处理，从而减少回表次数，优化查询性能。</p>
<p>具体来说，在使用索引下推时，MySQL 会在索引的叶节点层级执行查询的过滤条件，过滤掉无用的索引记录，仅返回符合条件的记录的主键，这样就可以避免查询时回表读取表格的数据行，从而缩短了整个查询过程的时间。</p>
<p>假设有以下表结构：</p>
<p>表名：users</p>
<table>
<thead>
<tr>
<th align="center">id</th>
<th align="center">name</th>
<th align="center">age</th>
<th align="center">city</th>
</tr>
</thead>
<tbody><tr>
<td align="center">1</td>
<td align="center">John</td>
<td align="center">25</td>
<td align="center">New York</td>
</tr>
<tr>
<td align="center">2</td>
<td align="center">Alice</td>
<td align="center">30</td>
<td align="center">London</td>
</tr>
<tr>
<td align="center">3</td>
<td align="center">Bob</td>
<td align="center">40</td>
<td align="center">Paris</td>
</tr>
<tr>
<td align="center">4</td>
<td align="center">Olivia</td>
<td align="center">35</td>
<td align="center">Berlin</td>
</tr>
<tr>
<td align="center">5</td>
<td align="center">Michael</td>
<td align="center">28</td>
<td align="center">Sydney</td>
</tr>
</tbody></table>
<p>现在我们创建了一个多列索引：（索引下推通常是基于多列索引的。）</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> users <span class="keyword">ADD</span> INDEX idx_name_city_age (name, city, age);</span><br></pre></td></tr></table></figure>

<p>假设我们要查询年龄大于30岁，并且所在城市是”London”的用户，假设只给age字段添加了索引，它就不会使用索引下推。传统的查询优化器会将所有满足年龄大于30岁的记录读入内存，然后再根据城市进行筛选。</p>
<p>使用索引下推优化后，在索引范围扫描的过程中，优化器会判断只有在城市列为”London”的情况下，才会将满足年龄大于30岁的记录加载到内存中。这样就可以避免不必要的IO和数据传输，提高查询性能。</p>
<p>具体的查询语句可以是：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> users <span class="keyword">WHERE</span> age <span class="operator">&gt;</span> <span class="number">30</span> <span class="keyword">AND</span> city <span class="operator">=</span> <span class="string">&#x27;London&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>在执行这个查询时，优化器会使用索引下推技术，先根据索引范围扫描找到所有满足条件的记录，然后再回到原数据表中获取完整的行数据，最终返回结果。</p>
<h2 id="5-6-单列索引（单一索引）"><a href="#5-6-单列索引（单一索引）" class="headerlink" title="5.6 单列索引（单一索引）"></a>5.6 单列索引（单一索引）</h2><p>单列索引是指对数据库表中的某一列或属性进行索引创建，对该列进行快速查找和排序操作。单列索引可以加快查询速度，提高数据库的性能。</p>
<p>举个例子，假设我们有一个学生表（student），其中有以下几个列：学生编号（student_id）、姓名（name）、年龄（age）和性别（gender）。</p>
<p>如果我们针对学生表的学生编号（student_id）列创建了单列索引，那么可以快速地根据学生编号进行查询或排序操作。例如，我们可以使用以下SQL语句查询学生编号为123456的学生信息：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> student <span class="keyword">WHERE</span> student_id <span class="operator">=</span> <span class="number">123456</span>;</span><br></pre></td></tr></table></figure>

<p>由于我们对学生编号列建立了单列索引，所以数据库可以直接通过索引快速定位到具有学生编号123456的那一行记录，从而加快查询速度。</p>
<h2 id="5-7-复合索引（组合索引）"><a href="#5-7-复合索引（组合索引）" class="headerlink" title="5.7 复合索引（组合索引）"></a>5.7 复合索引（组合索引）</h2><p>复合索引（Compound Index）也称为多列索引（Multi-Column Index），是指对数据库表中多个列进行索引创建。</p>
<p>与单列索引不同，复合索引可以包含多个列。这样可以将多个列的值组合起来作为索引的键，以提高多列条件查询的效率。</p>
<blockquote>
<p>举个例子</p>
</blockquote>
<p>假设我们有一个订单表（Order），其中包含以下几个列：订单编号（OrderID）、客户编号（CustomerID）、订单日期（OrderDate）和订单金额（OrderAmount）。</p>
<p>如果我们为订单表的客户编号和订单日期这两列创建复合索引（CustomerID, OrderDate），那么可以在查询时同时根据客户编号和订单日期来快速定位到匹配的记录。</p>
<p>例如，我们可以使用以下SQL语句查询客户编号为123456且订单日期为2021-01-01的订单信息：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> <span class="keyword">Order</span> <span class="keyword">WHERE</span> CustomerID <span class="operator">=</span> <span class="number">123456</span> <span class="keyword">AND</span> OrderDate <span class="operator">=</span> <span class="string">&#x27;2021-01-01&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>由于我们为客户编号和订单日期创建了复合索引，数据库可以使用这个索引来快速定位到符合条件的记录，从而加快查询速度。复合索引的使用能够提高多列条件查询的效率，但需要注意的是，复合索引的创建和维护可能会增加索引的存储空间和对于写操作的影响。</p>
<p><strong>相对于单列索引，复合索引有以下几个优势：</strong></p>
<ul>
<li>减少索引的数量：复合索引可以包含多个列，因此可以减少索引的数量，减少索引的存储空间和维护成本。</li>
<li>提高查询性能：当查询条件中涉及到复合索引的多个列时，数据库可以使用复合索引进行快速定位和过滤，从而提高查询性能。</li>
<li>覆盖查询：如果复合索引包含了所有查询需要的列，那么数据库可以直接使用索引中的数据，而不需要再进行表的读取，从而提高查询性能。</li>
<li>排序和分组：由于复合索引包含多个列，因此可以用于排序和分组操作，从而提高排序和分组的性能。</li>
</ul>
<h1 id="6-索引的优缺点"><a href="#6-索引的优缺点" class="headerlink" title="6. 索引的优缺点"></a>6. 索引的优缺点</h1><p>索引是数据库中一种重要的数据结构，用于加速数据的检索和查询操作。它的优点和缺点如下：</p>
<p>优点：</p>
<ul>
<li>提高查询性能：通过创建索引，可以大大减少数据库查询的数据量，从而提升查询的速度。</li>
<li>加速排序：当查询需要按照某个字段进行排序时，索引可以加速排序的过程，提高排序的效率。</li>
<li>减少磁盘IO：索引可以减少磁盘IO的次数，这对于磁盘读写速度较低的场景，尤其重要。</li>
</ul>
<p>缺点：</p>
<ul>
<li>占据额外的存储空间：索引需要占据额外的存储空间，特别是在大型数据库系统中，索引可能占据较大的空间。</li>
<li>增删改操作的性能损耗：每次对数据表进行插入、更新、删除等操作时，需要更新索引，会导致操作的性能降低。</li>
<li>资源消耗较大：索引需要占用内存和CPU资源，特别是在大规模并发访问的情况下，可能对系统的性能产生影响。</li>
</ul>
<h1 id="7-何时用索引"><a href="#7-何时用索引" class="headerlink" title="7. 何时用索引"></a>7. 何时用索引</h1><p>在以下情况下建议使用索引：</p>
<ul>
<li>频繁执行查询操作的字段：如果这些字段经常被查询，使用索引可以提高查询的性能，减少查询的时间。 </li>
<li>大表：当表的数据量较大时，使用索引可以快速定位到所需的数据，提高查询效率。 </li>
<li>需要排序或者分组的字段：在对字段进行排序或者分组操作时，索引可以减少排序或者分组的时间。 </li>
<li>外键关联的字段：在进行表之间的关联查询时，使用索引可以加快关联查询的速度。</li>
</ul>
<p>在以下情况下不建议使用索引：</p>
<ul>
<li>频繁执行更新操作的表：如果表经常被更新数据，使用索引可能会降低更新操作的性能，因为每次更新都需要维护索引。 </li>
<li>小表：对于数据量较小的表，使用索引可能并不会带来明显的性能提升，反而会占用额外的存储空间。 </li>
<li>对于唯一性很差的字段，一般不建议添加索引。当一个字段的唯一性很差时，查询操作基本上需要扫描整个表的大部分数据。如果为这样的字段创建索引，索引的大小可能会比数据本身还大，导致索引的存储空间占用过高，同时也会导致查询操作的性能下降。</li>
</ul>
<p>总之，索引需要根据具体情况进行使用和权衡，需要考虑到表的大小、查询频率、更新频率以及业务需求等因素。</p>
]]></content>
      <categories>
        <category>DB</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>【第2章】 存储引擎</title>
    <url>/posts/57369/</url>
    <content><![CDATA[<h1 id="1-存储引擎概述"><a href="#1-存储引擎概述" class="headerlink" title="1. 存储引擎概述"></a>1. 存储引擎概述</h1><p>MySQL存储引擎决定了数据在磁盘上的存储方式和访问方式。不同的存储引擎实现了不同的存储和检索算法，因此它们在处理和管理数据的方式上存在差异。</p>
<p>MySQL常见的存储引擎包括InnoDB、MyISAM、Memory、Archive等。每个存储引擎都有自己的特点和适用场景。</p>
<p>例如：</p>
<ul>
<li>InnoDB引擎支持事务和行级锁定，适用于需要高并发读写的应用</li>
<li>MyISAM引擎不支持事务，但适用于读操作较多的应用</li>
<li>Memory引擎数据全部存储在内存中，适用于对读写速度要求很高的应用等等</li>
</ul>
<p>选择适合的存储引擎可以提高MySQL的性能和效率，并且根据应用需求来合理选择存储引擎可以提供更好的数据管理和查询功能。</p>
<h1 id="2-MySQL支持哪些存储引擎"><a href="#2-MySQL支持哪些存储引擎" class="headerlink" title="2. MySQL支持哪些存储引擎"></a>2. MySQL支持哪些存储引擎</h1><p>使用 <code>show engines \G;</code> 命令可以查看所有的存储引擎：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">*************************** <span class="number">1.</span> row ***************************</span><br><span class="line">      Engine: MEMORY</span><br><span class="line">     Support: YES</span><br><span class="line">     Comment: Hash based, stored in memory, useful <span class="keyword">for</span> temporary tables</span><br><span class="line">Transactions: NO</span><br><span class="line">          XA: NO</span><br><span class="line">  Savepoints: NO</span><br><span class="line">*************************** <span class="number">2.</span> row ***************************</span><br><span class="line">      Engine: MRG_MYISAM</span><br><span class="line">     Support: YES</span><br><span class="line">     Comment: Collection of identical MyISAM tables</span><br><span class="line">Transactions: NO</span><br><span class="line">          XA: NO</span><br><span class="line">  Savepoints: NO</span><br><span class="line">*************************** <span class="number">3.</span> row ***************************</span><br><span class="line">      Engine: CSV</span><br><span class="line">     Support: YES</span><br><span class="line">     Comment: CSV storage engine</span><br><span class="line">Transactions: NO</span><br><span class="line">          XA: NO</span><br><span class="line">  Savepoints: NO</span><br><span class="line">*************************** <span class="number">4.</span> row ***************************</span><br><span class="line">      Engine: FEDERATED</span><br><span class="line">     Support: NO</span><br><span class="line">     Comment: Federated MySQL storage engine</span><br><span class="line">Transactions: NULL</span><br><span class="line">          XA: NULL</span><br><span class="line">  Savepoints: NULL</span><br><span class="line">*************************** <span class="number">5.</span> row ***************************</span><br><span class="line">      Engine: PERFORMANCE_SCHEMA</span><br><span class="line">     Support: YES</span><br><span class="line">     Comment: Performance Schema</span><br><span class="line">Transactions: NO</span><br><span class="line">          XA: NO</span><br><span class="line">  Savepoints: NO</span><br><span class="line">*************************** <span class="number">6.</span> row ***************************</span><br><span class="line">      Engine: MyISAM</span><br><span class="line">     Support: YES</span><br><span class="line">     Comment: MyISAM storage engine</span><br><span class="line">Transactions: NO</span><br><span class="line">          XA: NO</span><br><span class="line">  Savepoints: NO</span><br><span class="line">*************************** <span class="number">7.</span> row ***************************</span><br><span class="line">      Engine: InnoDB</span><br><span class="line">     Support: DEFAULT</span><br><span class="line">     Comment: Supports transactions, row-level locking, and foreign keys</span><br><span class="line">Transactions: YES</span><br><span class="line">          XA: YES</span><br><span class="line">  Savepoints: YES</span><br><span class="line">*************************** <span class="number">8.</span> row ***************************</span><br><span class="line">      Engine: ndbinfo</span><br><span class="line">     Support: NO</span><br><span class="line">     Comment: MySQL Cluster system information storage engine</span><br><span class="line">Transactions: NULL</span><br><span class="line">          XA: NULL</span><br><span class="line">  Savepoints: NULL</span><br><span class="line">*************************** <span class="number">9.</span> row ***************************</span><br><span class="line">      Engine: BLACKHOLE</span><br><span class="line">     Support: YES</span><br><span class="line">     Comment: /dev/<span class="literal">null</span> storage <span class="title function_">engine</span> <span class="params">(anything you write to it disappears)</span></span><br><span class="line">Transactions: NO</span><br><span class="line">          XA: NO</span><br><span class="line">  Savepoints: NO</span><br><span class="line">*************************** <span class="number">10.</span> row ***************************</span><br><span class="line">      Engine: ARCHIVE</span><br><span class="line">     Support: YES</span><br><span class="line">     Comment: Archive storage engine</span><br><span class="line">Transactions: NO</span><br><span class="line">          XA: NO</span><br><span class="line">  Savepoints: NO</span><br><span class="line">*************************** <span class="number">11.</span> row ***************************</span><br><span class="line">      Engine: ndbcluster</span><br><span class="line">     Support: NO</span><br><span class="line">     Comment: Clustered, fault-tolerant tables</span><br><span class="line">Transactions: NULL</span><br><span class="line">          XA: NULL</span><br><span class="line">  Savepoints: NULL</span><br></pre></td></tr></table></figure>
<p><code>Support</code>是<code>Yes</code>的表示支持该存储引擎。MySQL默认的存储引擎是：<code>InnoDB</code></p>
<h1 id="3-指定和修改存储引擎"><a href="#3-指定和修改存储引擎" class="headerlink" title="3. 指定和修改存储引擎"></a>3. 指定和修改存储引擎</h1><h2 id="3-1-指定存储引擎"><a href="#3-1-指定存储引擎" class="headerlink" title="3.1 指定存储引擎"></a>3.1 指定存储引擎</h2><p>在MySQL中，你可以在创建表时指定使用的存储引擎。通过在<code>CREATE TABLE</code>语句中使用<code>ENGINE</code>关键字，你可以指定要使用的存储引擎。</p>
<p>以下是指定存储引擎的示例：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> my_table (column1 <span class="type">INT</span>, column2 <span class="type">VARCHAR</span>(<span class="number">50</span>)) ENGINE <span class="operator">=</span> InnoDB;</span><br></pre></td></tr></table></figure>

<p>在这个例子中，我们创建了一个名为my_table的表，并指定了使用<code>InnoDB</code>存储引擎。</p>
<p>如果你不显式指定存储引擎，MySQL将使用默认的存储引擎。默认情况下，MySQL 8的默认存储引擎是InnoDB。</p>
<h2 id="3-2-修改存储引擎"><a href="#3-2-修改存储引擎" class="headerlink" title="3.2 修改存储引擎"></a>3.2 修改存储引擎</h2><p>在MySQL中，你可以通过<code>ALTER TABLE</code>语句修改表的存储引擎。下面是修改存储引擎的示例：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> my_table ENGINE <span class="operator">=</span> MyISAM;</span><br></pre></td></tr></table></figure>

<p>在这个例子中，我们使用<code>ALTER TABLE</code>语句将my_table表的存储引擎修改为<code>MyISAM</code>。</p>
<p>请注意，在修改存储引擎之前，你需要考虑以下几点：</p>
<ul>
<li>修改存储引擎可能需要执行复制表的操作，因此可能会造成数据的丢失或不可用。确保在执行修改之前备份你的数据</li>
<li>不是所有的存储引擎都支持相同的功能。要确保你选择的新存储引擎支持你应用程序所需的功能</li>
<li>修改表的存储引擎可能会影响到现有的应用程序和查询。确保在修改之前评估和测试所有的影响</li>
<li>ALTER TABLE语句可能需要适当的权限才能执行。确保你拥有足够的权限来执行修改存储引擎的操作</li>
</ul>
<p>总而言之，修改存储引擎需要谨慎进行，且需要考虑到可能的影响和风险。建议在进行修改之前进行适当的测试和备份。</p>
<h1 id="4-常用的存储引擎及适用场景"><a href="#4-常用的存储引擎及适用场景" class="headerlink" title="4. 常用的存储引擎及适用场景"></a>4. 常用的存储引擎及适用场景</h1><p>在实际开发中，以下存储引擎是比较常用的：</p>
<p><strong>InnoDB：</strong></p>
<ul>
<li>MySQL默认的事务型存储引擎</li>
<li>支持ACID事务</li>
<li>具有较好的并发性能和数据完整性</li>
<li>支持行级锁定。</li>
<li>适用于大多数应用场景，尤其是需要事务支持的应用。</li>
</ul>
<p><strong>MyISAM：</strong></p>
<ul>
<li>是MySQL早期版本中常用的存储引擎</li>
<li>支持全文索引和表级锁定</li>
<li>不支持事务</li>
<li>由于其简单性和高性能，在某些特定的应用场景中会得到广泛应用，如<strong>读密集</strong>的应用。</li>
</ul>
<p><strong>MEMORY：</strong></p>
<ul>
<li>称为HEAP，是将表存储在内存中的存储引擎</li>
<li>具有非常高的读写性能，但数据会在服务器重启时丢失。</li>
<li>适用于需要快速读写的临时数据集、缓存和临时表等场景。</li>
</ul>
<p><strong>CSV：</strong></p>
<ul>
<li>将数据以纯文本格式存储的存储引擎</li>
<li>适用于需要处理和导入&#x2F;导出CSV格式数据的场景。</li>
</ul>
<p><strong>ARCHIVE：</strong></p>
<ul>
<li>将数据高效地进行压缩和存储的存储引擎</li>
<li>适用于需要长期存储大量历史数据且不经常查询的场景。</li>
</ul>
]]></content>
      <categories>
        <category>DB</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>【第1章】 存储过程</title>
    <url>/posts/17823/</url>
    <content><![CDATA[<h1 id="1-存储过程的概念"><a href="#1-存储过程的概念" class="headerlink" title="1. 存储过程的概念"></a>1. 存储过程的概念</h1><p>存储过程可称为过程化SQL语言，是在普通SQL语句的基础上增加了编程语言的特点，把数据操作语句(DML)和查询语句(DQL)组织在过程化代码中，通过逻辑判断、循环等操作实现复杂计算的程序语言。</p>
<p>换句话说，存储过程其实就是数据库内置的一种编程语言，这种编程语言也有自己的变量、if语句、循环语句等。在一个存储过程中可以将多条SQL语句以逻辑代码的方式将其串联起来，执行这个存储过程就是将这些SQL语句按照一定的逻辑去执行，所以一个存储过程也可以看做是一组为了完成特定功能的SQL 语句集。</p>
<p>每一个存储过程都是一个数据库对象，就像table和view一样，存储在数据库当中，一次编译永久有效。并且每一个存储过程都有自己的名字。客户端程序通过存储过程的名字来调用存储过程。</p>
<p>在数据量特别庞大的情况下利用存储过程能达到倍速的效率提升。 </p>
<h1 id="2-存储过程的优点和缺点"><a href="#2-存储过程的优点和缺点" class="headerlink" title="2. 存储过程的优点和缺点"></a>2. 存储过程的优点和缺点</h1><p>优点：速度快。</p>
<ul>
<li>降低了<strong>应用服务器</strong>和<strong>数据库服务器</strong>之间网络通讯的开销。尤其在数据量庞大的情况下效果显著。</li>
</ul>
<p>缺点：移植性差。编写难度大。维护性差。</p>
<ul>
<li>每一个数据库都有自己的存储过程的语法规则，这种语法规则不是通用的。一旦使用了存储过程，则数据库产品很难更换，例如：编写了mysql的存储过程，这段代码只能在mysql中运行，无法在oracle数据库中运行。</li>
<li>对于数据库存储过程这种语法来说，没有专业的IDE工具（集成开发环境），所以编码速度较低。自然维护的成本也会较高。</li>
</ul>
<p>在实际开发中，存储过程还是很少使用的。只有在系统遇到了性能瓶颈，在进行优化的时候，对于大数量的应用来说，可以考虑使用一些。</p>
<h1 id="3-第一个存储过程"><a href="#3-第一个存储过程" class="headerlink" title="3. 第一个存储过程"></a>3. 第一个存储过程</h1><h2 id="3-1-存储过程的创建"><a href="#3-1-存储过程的创建" class="headerlink" title="3.1 存储过程的创建"></a>3.1 存储过程的创建</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">create procedure p1()</span><br><span class="line">begin</span><br><span class="line">	select empno,ename from emp;</span><br><span class="line">end;</span><br></pre></td></tr></table></figure>
<h2 id="3-2-存储过程的调用"><a href="#3-2-存储过程的调用" class="headerlink" title="3.2 存储过程的调用"></a>3.2 存储过程的调用</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">call p1();</span><br></pre></td></tr></table></figure>

<h2 id="3-3-存储过程的查看"><a href="#3-3-存储过程的查看" class="headerlink" title="3.3 存储过程的查看"></a>3.3 存储过程的查看</h2><p>查看创建存储过程的语句：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">show create procedure p1;</span><br></pre></td></tr></table></figure>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/MySQL/%E6%9F%A5%E7%9C%8B%E5%88%9B%E5%BB%BA%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B.png" alt="查看创建存储过程"></p>
<p>通过系统表<code>information_schema.ROUTINES</code>查看存储过程的详细信息：</p>
<p><code>information_schema.ROUTINES</code> 是 MySQL 数据库中一个系统表，存储了所有存储过程、函数、触发器的详细信息，包括名称、返回值类型、参数、创建时间、修改时间等。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> information_schema.routines <span class="keyword">where</span> routine_name <span class="operator">=</span> <span class="string">&#x27;p1&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/MySQL/%E7%B3%BB%E7%BB%9F%E8%A1%A8information_schema.ROUTINES.png" alt="系统表information_schema.ROUTINES"></p>
<p><code>information_schema.ROUTINES</code> 表中的一些重要的列包括：</p>
<ul>
<li>SPECIFIC_NAME：存储过程的具体名称，包括该存储过程的名字，参数列表。</li>
<li>ROUTINE_SCHEMA：存储过程所在的数据库名称。</li>
<li>ROUTINE_NAME：存储过程的名称。</li>
<li>ROUTINE_TYPE：PROCEDURE表示是一个存储过程，FUNCTION表示是一个函数。</li>
<li>ROUTINE_DEFINITION：存储过程的定义语句。</li>
<li>CREATED：存储过程的创建时间。</li>
<li>LAST_ALTERED：存储过程的最后修改时间。</li>
<li>DATA_TYPE：存储过程的返回值类型、参数类型等。</li>
</ul>
<h2 id="3-4-存储过程的删除"><a href="#3-4-存储过程的删除" class="headerlink" title="3.4 存储过程的删除"></a>3.4 存储过程的删除</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">drop procedure if exists p1;</span><br></pre></td></tr></table></figure>
<h2 id="3-5-delimiter命令"><a href="#3-5-delimiter命令" class="headerlink" title="3.5 delimiter命令"></a>3.5 delimiter命令</h2><p>在 MySQL 中，<code>delimiter</code> 命令用于改变 MySQL 解释语句的定界符。MySQL 默认使用分号 <code>;</code> 作为语句的定界符。而使用 <code>delimiter</code> 命令可以将分号 <code>;</code> 更改为其他字符，从而可以在 SQL 语句中使用分号 <code>;</code></p>
<p>例如，假设需要创建一个存储过程。在存储过程中通常会包括多条 SQL 语句，而这些语句都需要以分号 <code>;</code> 结尾。但默认情况下，执行到第一条语句的分号 <code>;</code> 后，MySQL 就会停止解释，导致后续的语句无法执行。解决方式就是使用 <code>delimiter</code> 命令将分号改为其他字符，使分号 <code>;</code> 不再是语句定界符。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">delimiter <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> my_proc ()</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> my_table;</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> my_table (col1, col2) <span class="keyword">VALUES</span> (<span class="string">&#x27;value1&#x27;</span>, <span class="string">&#x27;value2&#x27;</span>);</span><br><span class="line"><span class="keyword">END</span> <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"></span><br><span class="line">delimiter ;</span><br></pre></td></tr></table></figure>

<p>在这个例子中，我们使用 <code>delimiter //</code> 命令将定界符改为两个斜线 <code>//</code>。在存储过程中，以分号 <code>;</code> 结尾的语句不再被解释为语句的结束。而使用 <code>delimiter ;</code> 可以将分号恢复为语句定界符。</p>
<p>总之，<code>delimiter</code> 命令可以改变 MySQL 数据库系统中 SQL 查询语句的分隔符，从而可使一条 SQL 查询语句包含多个 SQL 语句。这样的话，就方便了我们在一个语句里面加入多个语句，而且不会被错</p>
<h1 id="4-MySQL的变量"><a href="#4-MySQL的变量" class="headerlink" title="4. MySQL的变量"></a>4. MySQL的变量</h1><p>mysql中的变量包括：系统变量、用户变量、局部变量。</p>
<h2 id="4-1-系统变量"><a href="#4-1-系统变量" class="headerlink" title="4.1 系统变量"></a>4.1 系统变量</h2><p>MySQL 系统变量是指在 MySQL 服务器运行时控制其行为的参数。这些变量可以被设置为特定的值来改变服务器的默认设置，以满足不同的需求。</p>
<p>MySQL 系统变量可以具有全局（global）或会话（session）作用域。</p>
<ul>
<li>全局作用域是指对所有连接和所有数据库都适用；</li>
<li>会话作用域是指只对当前连接和当前数据库适用。</li>
</ul>
<p>查看系统变量：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">show</span> [<span class="keyword">global</span><span class="operator">|</span>session] variables;</span><br><span class="line"></span><br><span class="line"><span class="keyword">show</span> [<span class="keyword">global</span><span class="operator">|</span>session] variables <span class="keyword">like</span> <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> @@[<span class="keyword">global</span><span class="operator">|</span>session.]系统变量名;</span><br></pre></td></tr></table></figure>
<p><font color="red">PS：没有指定session或global时，默认是session</font></p>
<p>设置系统变量：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">set</span> [<span class="keyword">global</span> <span class="operator">|</span> session] 系统变量名 <span class="operator">=</span> 值;</span><br><span class="line"></span><br><span class="line"><span class="keyword">set</span> @@[<span class="keyword">global</span> <span class="operator">|</span> session.]系统变量名 <span class="operator">=</span> 值;</span><br></pre></td></tr></table></figure>
<p><font color="red">PS：无论是全局设置还是会话设置，当mysql服务重启之后，之前配置都会失效。</font>可以通过修改MySQL根目录下的my.ini配置文件达到永久修改的效果。（my.ini是MySQL数据库默认的系统级配置文件，默认是不存在的，需要新建，并参考一些资料进行配置。）</p>
<p>windows系统是<code>my.ini</code>，linux系统是<code>my.cnf</code>，<code>my.ini</code>文件通常放在mysql安装的根目录下。</p>
<p>这个文件通常是不存在的，可以新建，新建后例如提供以下配置：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">autocommit=0</span><br></pre></td></tr></table></figure>
<p>这种配置就表示永久性关闭自动提交机制。（不建议这样做。）</p>
<h2 id="4-2-用户变量"><a href="#4-2-用户变量" class="headerlink" title="4.2 用户变量"></a>4.2 用户变量</h2><p>用户自定义的变量。只在当前会话有效。所有的用户变量<code>@</code>开始。</p>
<p>给用户变量赋值：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">set</span> <span class="variable">@name</span> <span class="operator">=</span> <span class="string">&#x27;jackson&#x27;</span>;</span><br><span class="line"><span class="keyword">set</span> <span class="variable">@age</span> :<span class="operator">=</span> <span class="number">30</span>;</span><br><span class="line"><span class="keyword">set</span> <span class="variable">@gender</span> :<span class="operator">=</span> <span class="string">&#x27;男&#x27;</span>, <span class="variable">@addr</span> :<span class="operator">=</span> <span class="string">&#x27;北京大兴区&#x27;</span>;</span><br><span class="line"><span class="keyword">select</span> <span class="variable">@email</span> :<span class="operator">=</span> <span class="string">&#x27;jackson@123.com&#x27;</span>;</span><br><span class="line"><span class="keyword">select</span> sal <span class="keyword">into</span> <span class="variable">@sal</span> <span class="keyword">from</span> emp <span class="keyword">where</span> ename <span class="operator">=</span><span class="string">&#x27;SMITH&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>读取用户变量的值：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="variable">@name</span>, <span class="variable">@age</span>, <span class="variable">@gender</span>, <span class="variable">@addr</span>, <span class="variable">@email</span>, <span class="variable">@sal</span>;</span><br></pre></td></tr></table></figure>
<p><font color="red">PS：mysql中变量不需要声明。直接赋值就行。如果没有声明变量，直接读取该变量，返回null</font></p>
<h2 id="4-3-局部变量"><a href="#4-3-局部变量" class="headerlink" title="4.3 局部变量"></a>4.3 局部变量</h2><p>在存储过程中可以使用局部变量。使用declare声明。在begin和end之间有效。</p>
<p>变量的声明：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">declare</span> 变量名 数据类型 [<span class="keyword">default</span> ...];</span><br></pre></td></tr></table></figure>
<p>变量的数据类型就是表字段的数据类型，例如：int、bigint、char、varchar、date、time、datetime等。</p>
<p><font color="red"><strong>PS：declare通常出现在begin end之间的开始部分。</strong></font></p>
<p>变量的赋值：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">set</span> 变量名 <span class="operator">=</span> 值;</span><br><span class="line"><span class="keyword">set</span> 变量名 :<span class="operator">=</span> 值;</span><br><span class="line"><span class="keyword">select</span> 字段名 <span class="keyword">into</span> 变量名 <span class="keyword">from</span> 表名 ...;</span><br></pre></td></tr></table></figure>

<p>例如：以下程序演示局部变量的声明、赋值、读取：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">PROCEDURE</span> p2()</span><br><span class="line"><span class="keyword">begin</span> </span><br><span class="line">	<span class="comment">/*声明变量*/</span></span><br><span class="line">	<span class="keyword">declare</span> emp_count <span class="type">int</span> <span class="keyword">default</span> <span class="number">0</span>;</span><br><span class="line">	<span class="comment">/*声明变量*/</span></span><br><span class="line">	<span class="keyword">declare</span> sal <span class="keyword">double</span>(<span class="number">10</span>,<span class="number">2</span>) <span class="keyword">default</span> <span class="number">0.0</span>;</span><br><span class="line">	<span class="comment">/*给变量赋值*/</span></span><br><span class="line">	<span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">into</span> emp_count <span class="keyword">from</span> emp;</span><br><span class="line">	<span class="comment">/*给变量赋值*/</span></span><br><span class="line">	<span class="keyword">set</span> sal :<span class="operator">=</span> <span class="number">5000.0</span>;</span><br><span class="line">	<span class="comment">/*读取变量的值*/</span></span><br><span class="line">	<span class="keyword">select</span> emp_count;</span><br><span class="line">	<span class="comment">/*读取变量的值*/</span></span><br><span class="line">	<span class="keyword">select</span> sal;</span><br><span class="line"><span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">call</span> p2();</span><br></pre></td></tr></table></figure>


<h1 id="5-if语句"><a href="#5-if语句" class="headerlink" title="5. if语句"></a>5. if语句</h1><p>语法格式：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">if 条件 <span class="keyword">then</span></span><br><span class="line">......</span><br><span class="line">elseif 条件 <span class="keyword">then</span></span><br><span class="line">......</span><br><span class="line">elseif 条件 <span class="keyword">then</span></span><br><span class="line">......</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">......</span><br><span class="line"><span class="keyword">end</span> if;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>案例：员工月薪sal，超过10000的属于“高收入”，6000到10000的属于“中收入”，少于6000的属于“低收入”</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> p3(               )</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">	<span class="keyword">declare</span> sal <span class="type">int</span> <span class="keyword">default</span> <span class="number">5000</span>;</span><br><span class="line">	<span class="keyword">declare</span> grade <span class="type">varchar</span>(<span class="number">20</span>);</span><br><span class="line">	if sal <span class="operator">&gt;</span> <span class="number">10000</span> <span class="keyword">then</span></span><br><span class="line">  	<span class="keyword">set</span> grade :<span class="operator">=</span> <span class="string">&#x27;高收入&#x27;</span>;</span><br><span class="line">	elseif sal <span class="operator">&gt;=</span> <span class="number">6000</span> <span class="keyword">then</span></span><br><span class="line">  	<span class="keyword">set</span> grade :<span class="operator">=</span> <span class="string">&#x27;中收入&#x27;</span>;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">  	<span class="keyword">set</span> grade :<span class="operator">=</span> <span class="string">&#x27;低收入&#x27;</span>;</span><br><span class="line">	<span class="keyword">end</span> if;</span><br><span class="line">	<span class="keyword">select</span> grade;</span><br><span class="line"><span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">call</span> p3();</span><br></pre></td></tr></table></figure>


<h1 id="6-参数"><a href="#6-参数" class="headerlink" title="6. 参数"></a>6. 参数</h1><p>存储过程的参数包括三种形式：</p>
<ul>
<li>in：入参（未指定时，默认是in）</li>
<li>out：出参</li>
<li>inout：既是入参，又是出参</li>
</ul>
<blockquote>
<p>案例：员工月薪sal，超过10000的属于“高收入”，6000到10000的属于“中收入”，少于6000的属于“低收入”</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> p4(<span class="keyword">in</span> sal <span class="type">int</span>, <span class="keyword">out</span> grade <span class="type">varchar</span>(<span class="number">20</span>))</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">	if sal <span class="operator">&gt;</span> <span class="number">10000</span> <span class="keyword">then</span></span><br><span class="line">  	<span class="keyword">set</span> grade :<span class="operator">=</span> <span class="string">&#x27;高收入&#x27;</span>;</span><br><span class="line">	elseif sal <span class="operator">&gt;=</span> <span class="number">6000</span> <span class="keyword">then</span></span><br><span class="line">  	<span class="keyword">set</span> grade :<span class="operator">=</span> <span class="string">&#x27;中收入&#x27;</span>;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">  	<span class="keyword">set</span> grade :<span class="operator">=</span> <span class="string">&#x27;低收入&#x27;</span>;</span><br><span class="line">	<span class="keyword">end</span> if;</span><br><span class="line"><span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">call</span> p4(<span class="number">5000</span>, <span class="variable">@grade</span>);</span><br><span class="line"><span class="keyword">select</span> <span class="variable">@grade</span>;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>案例：将传入的工资sal上调10%</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> p5(<span class="keyword">inout</span> sal <span class="type">int</span>)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">	<span class="keyword">set</span> sal :<span class="operator">=</span> sal <span class="operator">*</span> <span class="number">1.1</span>;</span><br><span class="line"><span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">set</span> <span class="variable">@sal</span> :<span class="operator">=</span> <span class="number">10000</span>;</span><br><span class="line"><span class="keyword">call</span> p5(<span class="variable">@sal</span>);</span><br><span class="line"><span class="keyword">select</span> <span class="variable">@sal</span>;</span><br></pre></td></tr></table></figure>


<h1 id="7-case语句"><a href="#7-case语句" class="headerlink" title="7. case语句"></a>7. case语句</h1><p>语法格式：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">case</span> 值</span><br><span class="line">	<span class="keyword">when</span> 值<span class="number">1</span> <span class="keyword">then</span></span><br><span class="line">	......</span><br><span class="line">	<span class="keyword">when</span> 值<span class="number">2</span> <span class="keyword">then</span></span><br><span class="line">	......</span><br><span class="line">	<span class="keyword">when</span> 值<span class="number">3</span> <span class="keyword">then</span></span><br><span class="line">	......</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	......</span><br><span class="line"><span class="keyword">end</span> <span class="keyword">case</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">case</span></span><br><span class="line">	<span class="keyword">when</span> 条件<span class="number">1</span> <span class="keyword">then</span></span><br><span class="line">	......</span><br><span class="line">	<span class="keyword">when</span> 条件<span class="number">2</span> <span class="keyword">then</span></span><br><span class="line">	......</span><br><span class="line">	<span class="keyword">when</span> 条件<span class="number">3</span> <span class="keyword">then</span></span><br><span class="line">	......</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	......</span><br><span class="line"><span class="keyword">end</span> <span class="keyword">case</span>;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>案例：根据不同月份，输出不同的季节。3、4、5月份春季。6、7、8月份夏季。9、10、11月份秋季。12、1、2 冬季。其他非法</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> mypro(<span class="keyword">in</span> <span class="keyword">month</span> <span class="type">int</span>, <span class="keyword">out</span> <span class="keyword">result</span> <span class="type">varchar</span>(<span class="number">100</span>))</span><br><span class="line"><span class="keyword">begin</span> </span><br><span class="line">	<span class="keyword">case</span> <span class="keyword">month</span></span><br><span class="line">		<span class="keyword">when</span> <span class="number">3</span> <span class="keyword">then</span> <span class="keyword">set</span> <span class="keyword">result</span> :<span class="operator">=</span> <span class="string">&#x27;春季&#x27;</span>;</span><br><span class="line">		<span class="keyword">when</span> <span class="number">4</span> <span class="keyword">then</span> <span class="keyword">set</span> <span class="keyword">result</span> :<span class="operator">=</span> <span class="string">&#x27;春季&#x27;</span>;</span><br><span class="line">		<span class="keyword">when</span> <span class="number">5</span> <span class="keyword">then</span> <span class="keyword">set</span> <span class="keyword">result</span> :<span class="operator">=</span> <span class="string">&#x27;春季&#x27;</span>;</span><br><span class="line">		<span class="keyword">when</span> <span class="number">6</span> <span class="keyword">then</span> <span class="keyword">set</span> <span class="keyword">result</span> :<span class="operator">=</span> <span class="string">&#x27;夏季&#x27;</span>;</span><br><span class="line">		<span class="keyword">when</span> <span class="number">7</span> <span class="keyword">then</span> <span class="keyword">set</span> <span class="keyword">result</span> :<span class="operator">=</span> <span class="string">&#x27;夏季&#x27;</span>;</span><br><span class="line">		<span class="keyword">when</span> <span class="number">8</span> <span class="keyword">then</span> <span class="keyword">set</span> <span class="keyword">result</span> :<span class="operator">=</span> <span class="string">&#x27;夏季&#x27;</span>;</span><br><span class="line">		<span class="keyword">when</span> <span class="number">9</span> <span class="keyword">then</span> <span class="keyword">set</span> <span class="keyword">result</span> :<span class="operator">=</span> <span class="string">&#x27;秋季&#x27;</span>;</span><br><span class="line">		<span class="keyword">when</span> <span class="number">10</span> <span class="keyword">then</span> <span class="keyword">set</span> <span class="keyword">result</span> :<span class="operator">=</span> <span class="string">&#x27;秋季&#x27;</span>;</span><br><span class="line">		<span class="keyword">when</span> <span class="number">11</span> <span class="keyword">then</span> <span class="keyword">set</span> <span class="keyword">result</span> :<span class="operator">=</span> <span class="string">&#x27;秋季&#x27;</span>;</span><br><span class="line">		<span class="keyword">when</span> <span class="number">12</span> <span class="keyword">then</span> <span class="keyword">set</span> <span class="keyword">result</span> :<span class="operator">=</span> <span class="string">&#x27;冬季&#x27;</span>;</span><br><span class="line">		<span class="keyword">when</span> <span class="number">1</span> <span class="keyword">then</span> <span class="keyword">set</span> <span class="keyword">result</span> :<span class="operator">=</span> <span class="string">&#x27;冬季&#x27;</span>;</span><br><span class="line">		<span class="keyword">when</span> <span class="number">2</span> <span class="keyword">then</span> <span class="keyword">set</span> <span class="keyword">result</span> :<span class="operator">=</span> <span class="string">&#x27;冬季&#x27;</span>;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">set</span> <span class="keyword">result</span> :<span class="operator">=</span> <span class="string">&#x27;非法月份&#x27;</span>;</span><br><span class="line">	<span class="keyword">end</span> <span class="keyword">case</span>;</span><br><span class="line"><span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> mypro(<span class="keyword">in</span> <span class="keyword">month</span> <span class="type">int</span>, <span class="keyword">out</span> <span class="keyword">result</span> <span class="type">varchar</span>(<span class="number">100</span>))</span><br><span class="line"><span class="keyword">begin</span> </span><br><span class="line">	<span class="keyword">case</span> </span><br><span class="line">		<span class="keyword">when</span> <span class="keyword">month</span> <span class="operator">=</span> <span class="number">3</span> <span class="keyword">or</span> <span class="keyword">month</span> <span class="operator">=</span> <span class="number">4</span> <span class="keyword">or</span> <span class="keyword">month</span> <span class="operator">=</span> <span class="number">5</span> <span class="keyword">then</span> </span><br><span class="line">			<span class="keyword">set</span> <span class="keyword">result</span> :<span class="operator">=</span> <span class="string">&#x27;春季&#x27;</span>;</span><br><span class="line">		<span class="keyword">when</span>  <span class="keyword">month</span> <span class="operator">=</span> <span class="number">6</span> <span class="keyword">or</span> <span class="keyword">month</span> <span class="operator">=</span> <span class="number">7</span> <span class="keyword">or</span> <span class="keyword">month</span> <span class="operator">=</span> <span class="number">8</span>  <span class="keyword">then</span> </span><br><span class="line">			<span class="keyword">set</span> <span class="keyword">result</span> :<span class="operator">=</span> <span class="string">&#x27;夏季&#x27;</span>;</span><br><span class="line">		<span class="keyword">when</span>  <span class="keyword">month</span> <span class="operator">=</span> <span class="number">9</span> <span class="keyword">or</span> <span class="keyword">month</span> <span class="operator">=</span> <span class="number">10</span> <span class="keyword">or</span> <span class="keyword">month</span> <span class="operator">=</span> <span class="number">11</span>  <span class="keyword">then</span> </span><br><span class="line">			<span class="keyword">set</span> <span class="keyword">result</span> :<span class="operator">=</span> <span class="string">&#x27;秋季&#x27;</span>;</span><br><span class="line">		<span class="keyword">when</span>  <span class="keyword">month</span> <span class="operator">=</span> <span class="number">12</span> <span class="keyword">or</span> <span class="keyword">month</span> <span class="operator">=</span> <span class="number">1</span> <span class="keyword">or</span> <span class="keyword">month</span> <span class="operator">=</span> <span class="number">2</span>  <span class="keyword">then</span> </span><br><span class="line">			<span class="keyword">set</span> <span class="keyword">result</span> :<span class="operator">=</span> <span class="string">&#x27;冬季&#x27;</span>;</span><br><span class="line">		<span class="keyword">else</span> </span><br><span class="line">			<span class="keyword">set</span> <span class="keyword">result</span> :<span class="operator">=</span> <span class="string">&#x27;非法月份&#x27;</span>;</span><br><span class="line">	<span class="keyword">end</span> <span class="keyword">case</span>;</span><br><span class="line"><span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">call</span> mypro(<span class="number">9</span>, <span class="variable">@season</span>);</span><br><span class="line"><span class="keyword">select</span> <span class="variable">@season</span>;</span><br></pre></td></tr></table></figure>


<h1 id="8-while循环"><a href="#8-while循环" class="headerlink" title="8. while循环"></a>8. while循环</h1><p>语法格式：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">while 条件 do</span><br><span class="line">	循环体;</span><br><span class="line"><span class="keyword">end</span> while;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>案例：传入一个数字n，计算1~n中所有偶数的和</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> mypro(<span class="keyword">in</span> n <span class="type">int</span>)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">	<span class="keyword">declare</span> sum <span class="type">int</span> <span class="keyword">default</span> <span class="number">0</span>;</span><br><span class="line">	while n <span class="operator">&gt;</span> <span class="number">0</span> do</span><br><span class="line">  		if n <span class="operator">%</span> <span class="number">2</span> <span class="operator">=</span> <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">    		<span class="keyword">set</span> sum :<span class="operator">=</span> sum <span class="operator">+</span> n;</span><br><span class="line">  		<span class="keyword">end</span> if;</span><br><span class="line">  		<span class="keyword">set</span> n :<span class="operator">=</span> n <span class="operator">-</span> <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">end</span> while;</span><br><span class="line">	<span class="keyword">select</span> sum;</span><br><span class="line"><span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">call</span> mypro(<span class="number">10</span>);</span><br></pre></td></tr></table></figure>


<h1 id="9-repeat循环"><a href="#9-repeat循环" class="headerlink" title="9. repeat循环"></a>9. repeat循环</h1><p>语法格式：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">repeat</span><br><span class="line">	循环体;</span><br><span class="line">	until 条件</span><br><span class="line"><span class="keyword">end</span> repeat;</span><br></pre></td></tr></table></figure>
<p><font color="red">PS：条件成立时结束循环</font></p>
<blockquote>
<p>案例：传入一个数字n，计算1~n中所有偶数的和</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> mypro(<span class="keyword">in</span> n <span class="type">int</span>, <span class="keyword">out</span> sum <span class="type">int</span>)</span><br><span class="line"><span class="keyword">begin</span> </span><br><span class="line">	<span class="keyword">set</span> sum :<span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">	repeat </span><br><span class="line">		if n <span class="operator">%</span> <span class="number">2</span> <span class="operator">=</span> <span class="number">0</span> <span class="keyword">then</span> </span><br><span class="line">		  <span class="keyword">set</span> sum :<span class="operator">=</span> sum <span class="operator">+</span> n;</span><br><span class="line">		<span class="keyword">end</span> if;</span><br><span class="line">		<span class="keyword">set</span> n :<span class="operator">=</span> n <span class="operator">-</span> <span class="number">1</span>;</span><br><span class="line">		until n <span class="operator">&lt;=</span> <span class="number">0</span> <span class="comment">/* 注意：这里不能添加 ; 结尾 */</span></span><br><span class="line">	<span class="keyword">end</span> repeat;</span><br><span class="line"><span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">call</span> mypro(<span class="number">10</span>, <span class="variable">@sum</span>);</span><br><span class="line"><span class="keyword">select</span> <span class="variable">@sum</span>;</span><br></pre></td></tr></table></figure>


<h1 id="10-loop循环"><a href="#10-loop循环" class="headerlink" title="10. loop循环"></a>10. loop循环</h1><p>语法格式：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> mypro()</span><br><span class="line"><span class="keyword">begin</span> </span><br><span class="line">	<span class="keyword">declare</span> i <span class="type">int</span> <span class="keyword">default</span> <span class="number">0</span>;</span><br><span class="line">  mylp:loop </span><br><span class="line">		<span class="keyword">set</span> i :<span class="operator">=</span> i <span class="operator">+</span> <span class="number">1</span>;</span><br><span class="line">		if i <span class="operator">=</span> <span class="number">5</span> <span class="keyword">then</span> </span><br><span class="line">			leave mylp;</span><br><span class="line">		<span class="keyword">end</span> if;</span><br><span class="line">		<span class="keyword">select</span> i;</span><br><span class="line">	<span class="keyword">end</span> loop;</span><br><span class="line"><span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>案例</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> mypro()</span><br><span class="line"><span class="keyword">begin</span> </span><br><span class="line">	<span class="keyword">declare</span> i <span class="type">int</span> <span class="keyword">default</span> <span class="number">0</span>;</span><br><span class="line">  mylp:loop </span><br><span class="line">		<span class="keyword">set</span> i :<span class="operator">=</span> i <span class="operator">+</span> <span class="number">1</span>;</span><br><span class="line">		if i <span class="operator">=</span> <span class="number">5</span> <span class="keyword">then</span> </span><br><span class="line">			iterate mylp;</span><br><span class="line">		<span class="keyword">end</span> if;</span><br><span class="line">		if i <span class="operator">=</span> <span class="number">10</span> <span class="keyword">then</span> </span><br><span class="line">		  leave mylp;</span><br><span class="line">		<span class="keyword">end</span> if;</span><br><span class="line">		<span class="keyword">select</span> i;</span><br><span class="line">	<span class="keyword">end</span> loop;</span><br><span class="line"><span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>


<h1 id="11-游标cursor"><a href="#11-游标cursor" class="headerlink" title="11. 游标cursor"></a>11. 游标cursor</h1><p>游标（cursor）可以理解为一个指向结果集中某条记录的指针，允许程序逐一访问结果集中的每条记录，并对其进行逐行操作和处理。</p>
<p>使用游标时，需要在存储过程或函数中定义一个游标变量，并通过 <code>DECLARE</code> 语句进行声明和初始化。然后，使用 <code>OPEN</code> 语句打开游标，使用 <code>FETCH</code> 语句逐行获取游标指向的记录，并进行处理。最后，使用 <code>CLOSE</code> 语句关闭游标，释放相关资源。游标可以大大地提高数据库查询的灵活性和效率。</p>
<p>声明游标的语法：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">declare</span> 游标名称 <span class="keyword">cursor</span> <span class="keyword">for</span> 查询语句;</span><br></pre></td></tr></table></figure>
<p>打开游标的语法：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">open</span> 游标名称;</span><br></pre></td></tr></table></figure>
<p>通过游标取数据的语法：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">fetch</span> 游标名称 <span class="keyword">into</span> 变量[,变量,变量......]</span><br></pre></td></tr></table></figure>
<p>关闭游标的语法：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">close</span> 游标名称;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>案例：从dept表查询部门编号和部门名，创建一张新表dept2，将查询结果插入到新表中</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">drop procedure if exists mypro;</span><br><span class="line"></span><br><span class="line">create procedure mypro()</span><br><span class="line">begin </span><br><span class="line">	</span><br><span class="line">	/* 声明变量 */</span><br><span class="line">	declare dept_no int;</span><br><span class="line">	declare dept_name varchar(255);</span><br><span class="line"></span><br><span class="line">	/* 声明游标，注意：声明游标的语句必须放在声明普通变量的后面。 */</span><br><span class="line">	declare dept_cursor cursor for select deptno,dname from dept;</span><br><span class="line">	</span><br><span class="line">	/* 删除表dept2 */</span><br><span class="line">	drop table if exists dept2;</span><br><span class="line">	</span><br><span class="line">	/* 创建表 dept2 */</span><br><span class="line">	create table dept2(</span><br><span class="line">		deptno int,</span><br><span class="line">		dname varchar(255)</span><br><span class="line">	);</span><br><span class="line">	</span><br><span class="line">	/* 打开游标 */</span><br><span class="line">	open dept_cursor;</span><br><span class="line">	</span><br><span class="line">	/* 通过游标取数据 */</span><br><span class="line">	/*fetch dept_cursor into dept_no, dept_name;*/</span><br><span class="line">	</span><br><span class="line">	/* 查看以下变量的值 */</span><br><span class="line">	/*select dept_no,dept_name;*/</span><br><span class="line">	</span><br><span class="line">	/* 使用循环从游标中取数据 */</span><br><span class="line">	while true do </span><br><span class="line">		fetch dept_cursor into dept_no, dept_name;</span><br><span class="line">		/*select dept_no,dept_name;*/</span><br><span class="line">		insert into dept2(deptno,dname) values(dept_no, dept_name);</span><br><span class="line">	end while;</span><br><span class="line">	</span><br><span class="line">	/* 关闭游标 */</span><br><span class="line">	close dept_cursor;</span><br><span class="line">end;</span><br><span class="line"></span><br><span class="line">call mypro();</span><br></pre></td></tr></table></figure>

<p>执行结果：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/MySQL/%E6%B8%B8%E6%A0%87cursor%E6%89%A7%E8%A1%8C%E7%BB%93%E6%9E%9C%E5%87%BA%E7%8E%B0%E5%BC%82%E5%B8%B8.png" alt="游标cursor执行结果出现异常"></p>
<p>出现了异常：异常信息中显示没有数据了。这是因为while true循环导致的。</p>
<p>不过虽然出现了异常，但是表创建成功了，数据也插入成功了：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/MySQL/%E4%BD%BF%E7%94%A8%E6%B8%B8%E6%A0%87cursor%E5%88%9B%E5%BB%BA%E8%A1%A8%E6%88%90%E5%8A%9F.png" alt="使用游标cursor创建表成功"></p>
<p><font color="red"><strong>注意：声明局部变量和声明游标有顺序要求，局部变量的声明需要在游标声明之前完成。</strong></font></p>
<h1 id="12-捕捉异常并处理"><a href="#12-捕捉异常并处理" class="headerlink" title="12. 捕捉异常并处理"></a>12. 捕捉异常并处理</h1><p>语法格式：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">DECLARE handler_name HANDLER FOR condition_value action_statement</span><br></pre></td></tr></table></figure>

<ul>
<li><code>handler_name</code> 表示异常处理程序的名称，重要取值包括：<ul>
<li><code>CONTINUE</code>：发生异常后，程序不会终止，会正常执行后续的过程。(捕捉)</li>
<li><code>EXIT</code>：发生异常后，终止存储过程的执行。（上抛）</li>
</ul>
</li>
<li><code>condition_value</code> 是指捕获的异常，重要取值包括：<ul>
<li><code>SQLSTATE sqlstate_value</code>，例如：SQLSTATE ‘02000’</li>
<li><code>SQLWARNING</code>，代表所有01开头的SQLSTATE</li>
<li><code>NOT FOUND</code>，代表所有02开头的SQLSTATE</li>
<li><code>SQLEXCEPTION</code>，代表除了01和02开头的所有SQLSTATE</li>
</ul>
</li>
<li><code>action_statement</code> 是指异常发生时执行的语句，例如：CLOSE cursor_name</li>
</ul>
<p>给之前的游标添加异常处理机制：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">drop procedure if exists mypro;</span><br><span class="line"></span><br><span class="line">create procedure mypro()</span><br><span class="line">begin </span><br><span class="line"></span><br><span class="line">	declare no int;</span><br><span class="line">	declare name varchar(100);</span><br><span class="line">	declare dept_cursor cursor for select deptno,dname from dept;</span><br><span class="line">	</span><br><span class="line">	/* 通常在这个位置进行异常的处理 */</span><br><span class="line">	declare exit handler for not found close dept_cursor;</span><br><span class="line"></span><br><span class="line">	drop table if exists dept2;</span><br><span class="line">	create table dept2(</span><br><span class="line">		no int primary key,</span><br><span class="line">		name varchar(100)</span><br><span class="line">	);</span><br><span class="line">	</span><br><span class="line">	open dept_cursor;</span><br><span class="line">	</span><br><span class="line">	while true do</span><br><span class="line">		fetch dept_cursor into no, name;</span><br><span class="line">		insert into dept2(no,name) values(no,name);</span><br><span class="line">	end while;</span><br><span class="line">	</span><br><span class="line">	close dept_cursor;</span><br><span class="line">end;</span><br><span class="line"></span><br><span class="line">call mypro();</span><br></pre></td></tr></table></figure>


<h1 id="13-存储函数"><a href="#13-存储函数" class="headerlink" title="13. 存储函数"></a>13. 存储函数</h1><p>存储函数：带返回值的存储过程。参数只允许是in（但不能写显示的写in）。没有out，也没有inout。</p>
<p>语法格式：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">CREATE FUNCTION 存储函数名称(参数列表) RETURNS 数据类型 [特征]</span><br><span class="line">BEGIN</span><br><span class="line">	--函数体</span><br><span class="line">	RETURN ...;</span><br><span class="line">END;</span><br></pre></td></tr></table></figure>

<p>“特征”的可取重要值如下：</p>
<ul>
<li><code>deterministic</code>：用该特征标记该函数为确定性函数（什么是确定性函数？每次调用函数时传同一个参数的时候，返回值都是固定的）。这是一种优化策略，这种情况下整个函数体的执行就会省略了，直接返回之前缓存的结果，来提高函数的执行效率。</li>
<li><code>no sql</code>：用该特征标记该函数执行过程中不会查询数据库，如果确实没有查询语句建议使用。告诉 MySQL 优化器不需要考虑使用查询缓存和优化器缓存来优化这个函数，这样就可以避免不必要的查询消耗产生，从而提高性能。</li>
<li><code>reads sql data</code>：用该特征标记该函数会进行查询操作，告诉 MySQL 优化器这个函数需要查询数据库的数据，可以使用查询缓存来缓存结果，从而提高查询性能；同时 MySQL 还会针对该函数的查询进行优化器缓存处理。</li>
</ul>
<blockquote>
<p>案例：计算1~n的所有偶数之和</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">-- 删除函数</span><br><span class="line">drop function if exists sum_fun;</span><br><span class="line"></span><br><span class="line">-- 创建函数</span><br><span class="line">create function sum_fun(n int)</span><br><span class="line">returns int deterministic </span><br><span class="line">begin </span><br><span class="line">	declare result int default 0;</span><br><span class="line">	while n &gt; 0 do </span><br><span class="line">		if n % 2 = 0 then </span><br><span class="line">			set result := result + n;</span><br><span class="line">		end if;</span><br><span class="line">		set n := n - 1;</span><br><span class="line">	end while;</span><br><span class="line">	return result;</span><br><span class="line">end;</span><br><span class="line"></span><br><span class="line">-- 调用函数</span><br><span class="line">set @result = sum_fun(100);</span><br><span class="line">select @result;</span><br></pre></td></tr></table></figure>


<h1 id="14-触发器"><a href="#14-触发器" class="headerlink" title="14. 触发器"></a>14. 触发器</h1><p>MySQL 触发器是一种数据库对象，它是与表相关联的特殊程序。它可以在特定的数据操作（例如插入（INSERT）、更新（UPDATE）或删除（DELETE））触发时自动执行。MySQL 触发器使数据库开发人员能够在数据的不同状态之间维护一致性和完整性，并且可以为特定的数据库表自动执行操作。</p>
<p>触发器的作用主要有以下几个方面：</p>
<ul>
<li>强制实施业务规则：触发器可以帮助确保数据表中的业务规则得到强制执行，例如检查插入或更新的数据是否符合某些规则。 </li>
<li>数据审计：触发器可以声明在执行数据修改时自动记日志或审计数据变化的操作，使数据对数据库管理员和 SQL 审计人员更易于追踪和审计。 </li>
<li>执行特定业务操作：触发器可以自动执行特定的业务操作，例如计算数据行的总数、计算平均值或总和等。</li>
</ul>
<p>MySQL 触发器分为两种类型: <code>BEFORE</code> 和 <code>AFTER</code>。BEFORE 触发器在执行 INSERT、UPDATE、DELETE 语句之前执行，而 AFTER 触发器在执行 INSERT、UPDATE、DELETE 语句之后执行。</p>
<p>创建触发器的语法如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">CREATE TRIGGER trigger_name</span><br><span class="line">BEFORE/AFTER INSERT/UPDATE/DELETE ON table_name FOR EACH ROW</span><br><span class="line">BEGIN</span><br><span class="line">-- 触发器执行的 SQL 语句</span><br><span class="line">END;</span><br></pre></td></tr></table></figure>

<p>其中：</p>
<ul>
<li><code>trigger_name</code>：触发器的名称</li>
<li><code>BEFORE/AFTER</code>：触发器的类型，可以是 BEFORE 或者 AFTER</li>
<li><code>INSERT/UPDATE/DELETE</code>：触发器所监控的 DML 调用类型</li>
<li><code>table_name</code>：触发器所绑定的表名</li>
<li><code>FOR EACH ROW</code>：表示触发器在每行受到 DML 的影响之后都会执行</li>
<li>触发器执行的 SQL 语句：该语句会在触发器被触发时执行</li>
</ul>
<p>需要注意的是，触发器是一种高级的数据库功能，只有在必要的情况下才应该使用，例如在需要实施强制性业务规则时。过多的触发器和复杂的触发器逻辑可能会影响查询性能和扩展性。</p>
<p><strong>关于触发器的NEW和OLD关键字：</strong></p>
<p>在 MySQL 触发器中，<code>NEW</code> 和 <code>OLD</code> 是两个特殊的关键字，用于引用在触发器中受到修改的行的新值和旧值。具体而言：</p>
<ul>
<li><code>NEW</code>：在触发 INSERT 或 UPDATE 操作期间，NEW 用于引用将要插入或更新到表中的新行的值。</li>
<li><code>OLD</code>：在触发 UPDATE 或 DELETE 操作期间，OLD 用于引用更新或删除之前在表中的旧行的值。</li>
</ul>
<p>通俗的讲，NEW 是指触发器执行的操作所要插入或更新到当前行中的新数据；而 OLD 则是指当前行在触发器执行前原本的数据。</p>
<p>在MySQL 触发器中，NEW 和 OLD 使用方法是相似的。在触发器中，可以像引用表的其他列一样引用 NEW 和 OLD。例如，可以使用 OLD.column_name 从旧行中引用列值，也可以使用 NEW.column_name 从新行中引用列值。</p>
<blockquote>
<p>示例</p>
</blockquote>
<p>假设有一个名为 my_table 的表，其中包含一个名为 quantity 的列。当在该表上执行 UPDATE 操作时，以下触发器会将旧值 OLD.quantity 累加到新值 NEW.quantity 中：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">CREATE TRIGGER my_trigger</span><br><span class="line">BEFORE UPDATE ON my_table</span><br><span class="line">FOR EACH ROW</span><br><span class="line">BEGIN</span><br><span class="line">SET NEW.quantity = NEW.quantity + OLD.quantity;</span><br><span class="line">END;</span><br></pre></td></tr></table></figure>

<p>在此触发器中，OLD.quantity 引用原始行的 quantity 值（旧值），而 NEW.quantity 引用更新行的 quantity 值（新值）。在触发器执行期间，数据行的 quantity 值将设置为旧值加上新值。</p>
<p><strong>需要注意的是，在使用 NEW 和 OLD 时，需要根据 DML 操作的类型进行判断，以确定哪个关键字表示新值，哪个关键字则表示旧值。</strong></p>
<blockquote>
<p>案例：当我们对dept表中的数据进行insert、delete、update的时候，请将这些操作记录到日志表当中</p>
</blockquote>
<p>日志表如下：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> if <span class="keyword">exists</span> oper_log;</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> oper_log(</span><br><span class="line">  id <span class="type">bigint</span> <span class="keyword">primary</span> key auto_increment,</span><br><span class="line">  table_name <span class="type">varchar</span>(<span class="number">100</span>) <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;操作的哪张表&#x27;</span>,</span><br><span class="line">  oper_type <span class="type">varchar</span>(<span class="number">100</span>) <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;操作类型包括insert delete update&#x27;</span>,</span><br><span class="line">  oper_time datetime <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;操作时间&#x27;</span>,</span><br><span class="line">  oper_id <span class="type">bigint</span> <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;操作的那行记录的id&#x27;</span>,</span><br><span class="line">  oper_desc text comment <span class="string">&#x27;操作描述&#x27;</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>触发器1：向dept表中插入数据时，记录日志</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">create trigger dept_trigger_insert</span><br><span class="line">after insert on dept</span><br><span class="line">for each row</span><br><span class="line">begin</span><br><span class="line">	insert into oper_log(id,table_name,oper_type,oper_time,oper_id,oper_desc) values</span><br><span class="line">(null,&#x27;dept&#x27;,&#x27;insert&#x27;,now(),new.deptno,concat(&#x27;插入数据：deptno=&#x27;, new.deptno, &#x27;,dname=&#x27;, new.dname,&#x27;,loc=&#x27;, new.loc));</span><br><span class="line">end;</span><br></pre></td></tr></table></figure>

<p>查看触发器：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">show triggers;</span><br></pre></td></tr></table></figure>

<p>删除触发器：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">trigger</span> if <span class="keyword">exists</span> dept_trigger_insert;</span><br></pre></td></tr></table></figure>

<p>向dept表中插入一条记录：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/MySQL/%E5%90%91dept%E8%A1%A8%E4%B8%AD%E6%8F%92%E5%85%A5%E4%B8%80%E6%9D%A1%E8%AE%B0%E5%BD%95.png" alt="向dept表中插入一条记录"></p>
<p>日志表中多了一条记录：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/MySQL/%E6%97%A5%E5%BF%97%E8%A1%A8%E4%B8%AD%E5%A4%9A%E4%BA%86%E4%B8%80%E6%9D%A1%E6%96%B0%E5%A2%9E%E8%AE%B0%E5%BD%95.png" alt="日志表中多了一条新增记录"></p>
<blockquote>
<p>触发器2：修改dept表中数据时，记录日志</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">create trigger dept_trigger_update</span><br><span class="line">after update on dept</span><br><span class="line">for each row</span><br><span class="line">begin</span><br><span class="line">	insert into oper_log(id,table_name,oper_type,oper_time,oper_id,oper_desc) values</span><br><span class="line">(null,&#x27;dept&#x27;,&#x27;update&#x27;,now(),new.deptno,concat(&#x27;更新前：deptno=&#x27;, old.deptno, &#x27;,dname=&#x27;, old.dname,&#x27;,loc=&#x27;, old.loc, </span><br><span class="line">                                              &#x27;,更新后：deptno=&#x27;, new.deptno, &#x27;,dname=&#x27;, new.dname,&#x27;,loc=&#x27;, new.loc));</span><br><span class="line">end;</span><br></pre></td></tr></table></figure>
<p>更新一条记录：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">update</span> dept <span class="keyword">set</span> loc <span class="operator">=</span> <span class="string">&#x27;北京&#x27;</span> <span class="keyword">where</span> deptno <span class="operator">=</span> <span class="number">60</span>;</span><br></pre></td></tr></table></figure>
<p>日志表中多了一条记录：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/MySQL/%E6%97%A5%E5%BF%97%E8%A1%A8%E4%B8%AD%E5%A4%9A%E4%BA%86%E4%B8%80%E6%9D%A1%E4%BF%AE%E6%94%B9%E8%AE%B0%E5%BD%95.png" alt="日志表中多了一条修改记录"></p>
<p><font color="red"><strong>PS：更新一条记录则对应一条日志。如果一次更新3条记录，那么日志表中插入3条记录。</strong></font></p>
<blockquote>
<p>触发器3：删除dept表中数据时，记录日志</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">create trigger dept_trigger_delete</span><br><span class="line">after delete on dept</span><br><span class="line">for each row</span><br><span class="line">begin</span><br><span class="line">	insert into oper_log(id,table_name,oper_type,oper_time,oper_id,oper_desc) values</span><br><span class="line">(null,&#x27;dept&#x27;,&#x27;delete&#x27;,now(),old.deptno,concat(&#x27;删除了数据：deptno=&#x27;, old.deptno, &#x27;,dname=&#x27;, old.dname,&#x27;,loc=&#x27;, old.loc));</span><br><span class="line">end;</span><br></pre></td></tr></table></figure>

<p>删除一条记录：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> dept <span class="keyword">where</span> deptno <span class="operator">=</span> <span class="number">60</span>;</span><br></pre></td></tr></table></figure>

<p>日志表中多了一条记录：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/DBIMG/MySQL/%E6%97%A5%E5%BF%97%E8%A1%A8%E4%B8%AD%E5%A4%9A%E4%BA%86%E4%B8%80%E6%9D%A1%E5%88%A0%E9%99%A4%E8%AE%B0%E5%BD%95.png" alt="日志表中多了一条删除记录"></p>
]]></content>
      <categories>
        <category>DB</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>【第14章】 SSM整合</title>
    <url>/posts/65497/</url>
    <content><![CDATA[<p>参考视频：<a href="https://www.bilibili.com/video/BV1sC411L76f/">SpringMVC教程，SpringMVC从零到精通，老杜SpringMVC，动力节点SpringMVC</a></p>
<h1 id="1-引入相关依赖"><a href="#1-引入相关依赖" class="headerlink" title="1. 引入相关依赖"></a>1. 引入相关依赖</h1><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.muyoukule<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>ssm-annotation<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>war<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>17<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>17<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--springmvc--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-webmvc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.1.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--spring jdbc--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.1.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--mybatis--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.5.15<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--mybatis spring--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--mysql驱动--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.3.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--德鲁伊连接池--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.22<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--jackson--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-databind<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.17.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--servlet api--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>jakarta.servlet<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jakarta.servlet-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--logback--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>ch.qos.logback<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>logback-classic<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.5.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--thymeleaf和spring6的整合依赖--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.thymeleaf<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>thymeleaf-spring6<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1.2.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--lombok依赖--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.18.28<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="2-SSM整合"><a href="#2-SSM整合" class="headerlink" title="2. SSM整合"></a>2. SSM整合</h1><p>创建项目结构</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/SSM%E6%95%B4%E5%90%88%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84.png" alt="SSM整合项目结构" style="zoom: 67%;">



<h2 id="1-1-Spring整合MyBatis"><a href="#1-1-Spring整合MyBatis" class="headerlink" title="1.1 Spring整合MyBatis"></a>1.1 Spring整合MyBatis</h2><h3 id="1-1-1-编写jdbc-properties"><a href="#1-1-1-编写jdbc-properties" class="headerlink" title="1.1.1 编写jdbc.properties"></a>1.1.1 编写jdbc.properties</h3><p>在类根路径下创建属性配置文件，配置连接数据库的信息：<code>jdbc.properties</code></p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">jdbc.driver</span>=<span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line"><span class="attr">jdbc.url</span>=<span class="string">jdbc:mysql://localhost:3306/spring_db?useUnicode=true&amp;serverTimezone=Asia/Shanghai&amp;useSSL=true&amp;characterEncoding=utf-8</span></span><br><span class="line"><span class="attr">jdbc.username</span>=<span class="string">root</span></span><br><span class="line"><span class="attr">jdbc.password</span>=<span class="string">root</span></span><br></pre></td></tr></table></figure>

<h3 id="1-1-2-编写DataSourceConfig"><a href="#1-1-2-编写DataSourceConfig" class="headerlink" title="1.1.2 编写DataSourceConfig"></a>1.1.2 编写DataSourceConfig</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DataSourceConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;jdbc.driver&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String driver;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;jdbc.url&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String url;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;jdbc.username&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;jdbc.password&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> DataSource <span class="title function_">dataSource</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">DruidDataSource</span> <span class="variable">dataSource</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DruidDataSource</span>();</span><br><span class="line">        dataSource.setDriverClassName(driver);</span><br><span class="line">        dataSource.setUrl(url);</span><br><span class="line">        dataSource.setUsername(username);</span><br><span class="line">        dataSource.setPassword(password);</span><br><span class="line">        <span class="keyword">return</span> dataSource;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="1-1-3-编写MyBatisConfig"><a href="#1-1-3-编写MyBatisConfig" class="headerlink" title="1.1.3 编写MyBatisConfig"></a>1.1.3 编写MyBatisConfig</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.muyoukule.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.mybatis.spring.SqlSessionFactoryBean;</span><br><span class="line"><span class="keyword">import</span> org.mybatis.spring.mapper.MapperScannerConfigurer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.sql.DataSource;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyBatisConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> SqlSessionFactoryBean <span class="title function_">sqlSessionFactory</span><span class="params">(DataSource dataSource)</span> &#123;</span><br><span class="line">        <span class="type">SqlSessionFactoryBean</span> <span class="variable">sqlSessionFactoryBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SqlSessionFactoryBean</span>();</span><br><span class="line">        sqlSessionFactoryBean.setDataSource(dataSource);</span><br><span class="line">        sqlSessionFactoryBean.setTypeAliasesPackage(<span class="string">&quot;com.muyoukule.bean&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> sqlSessionFactoryBean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> MapperScannerConfigurer <span class="title function_">mapperScannerConfigurer</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">MapperScannerConfigurer</span> <span class="variable">msc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MapperScannerConfigurer</span>();</span><br><span class="line">        msc.setBasePackage(<span class="string">&quot;com.muyoukule.dao&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> msc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="1-1-4-编写SpringConfig"><a href="#1-1-4-编写SpringConfig" class="headerlink" title="1.1.4 编写SpringConfig"></a>1.1.4 编写SpringConfig</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan(&#123;&quot;com.muyoukule.service&quot;&#125;)</span></span><br><span class="line"><span class="meta">@PropertySource(&quot;classpath:jdbc.properties&quot;)</span></span><br><span class="line"><span class="meta">@Import(&#123;DataSourceConfig.class, MyBatisConfig.class&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringConfig</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="1-2-Spring整合Spring-MVC"><a href="#1-2-Spring整合Spring-MVC" class="headerlink" title="1.2 Spring整合Spring MVC"></a>1.2 Spring整合Spring MVC</h2><h3 id="1-2-1-编写WebAppInitializer（web-xml）"><a href="#1-2-1-编写WebAppInitializer（web-xml）" class="headerlink" title="1.2.1 编写WebAppInitializer（web.xml）"></a>1.2.1 编写WebAppInitializer（web.xml）</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebAppInitializer</span> <span class="keyword">extends</span> <span class="title class_">AbstractAnnotationConfigDispatcherServletInitializer</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Spring的配置</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Class&lt;?&gt;[] getRootConfigClasses() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;SpringConfig.class&#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * SpringMVC的配置</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Class&lt;?&gt;[] getServletConfigClasses() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;SpringMvcConfig.class&#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用来配置DispatcherServlet的 &lt;url-pattern&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> String[] getServletMappings() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;/&quot;</span>&#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 配置过滤器</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Filter[] getServletFilters() &#123;</span><br><span class="line">        <span class="comment">// 配置字符编码过滤器</span></span><br><span class="line">        <span class="type">CharacterEncodingFilter</span> <span class="variable">characterEncodingFilter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CharacterEncodingFilter</span>();</span><br><span class="line">        characterEncodingFilter.setEncoding(<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">        characterEncodingFilter.setForceResponseEncoding(<span class="literal">true</span>);</span><br><span class="line">        characterEncodingFilter.setForceRequestEncoding(<span class="literal">true</span>);</span><br><span class="line">        <span class="comment">// 配置HiddenHttpMethodFilter</span></span><br><span class="line">        <span class="type">HiddenHttpMethodFilter</span> <span class="variable">hiddenHttpMethodFilter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HiddenHttpMethodFilter</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Filter</span>[]&#123;characterEncodingFilter, hiddenHttpMethodFilter&#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="1-2-2-编写SpringMvcConfig"><a href="#1-2-2-编写SpringMvcConfig" class="headerlink" title="1.2.2 编写SpringMvcConfig"></a>1.2.2 编写SpringMvcConfig</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan(&quot;com.muyoukule.handler&quot;)</span></span><br><span class="line"><span class="meta">@EnableWebMvc</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringMvcConfig</span> <span class="keyword">implements</span> <span class="title class_">WebMvcConfigurer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 以下三个方法合并起来就是开启视图解析器</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ThymeleafViewResolver <span class="title function_">getViewResolver</span><span class="params">(SpringTemplateEngine springTemplateEngine)</span> &#123;</span><br><span class="line">        <span class="type">ThymeleafViewResolver</span> <span class="variable">resolver</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThymeleafViewResolver</span>();</span><br><span class="line">        resolver.setTemplateEngine(springTemplateEngine);</span><br><span class="line">        resolver.setCharacterEncoding(<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">        resolver.setOrder(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> resolver;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> SpringTemplateEngine <span class="title function_">templateEngine</span><span class="params">(ITemplateResolver iTemplateResolver)</span> &#123;</span><br><span class="line">        <span class="type">SpringTemplateEngine</span> <span class="variable">templateEngine</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SpringTemplateEngine</span>();</span><br><span class="line">        templateEngine.setTemplateResolver(iTemplateResolver);</span><br><span class="line">        <span class="keyword">return</span> templateEngine;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ITemplateResolver <span class="title function_">templateResolver</span><span class="params">(ApplicationContext applicationContext)</span> &#123;</span><br><span class="line">        <span class="type">SpringResourceTemplateResolver</span> <span class="variable">resolver</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SpringResourceTemplateResolver</span>();</span><br><span class="line">        resolver.setApplicationContext(applicationContext);</span><br><span class="line">        resolver.setPrefix(<span class="string">&quot;/WEB-INF/thymeleaf/&quot;</span>);</span><br><span class="line">        resolver.setSuffix(<span class="string">&quot;.html&quot;</span>);</span><br><span class="line">        resolver.setTemplateMode(TemplateMode.HTML);</span><br><span class="line">        resolver.setCharacterEncoding(<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">        resolver.setCacheable(<span class="literal">false</span>);<span class="comment">//开发时关闭缓存，改动即可生效</span></span><br><span class="line">        <span class="keyword">return</span> resolver;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 开启静态资源处理，开启默认的Servlet处理</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configureDefaultServletHandling</span><span class="params">(DefaultServletHandlerConfigurer configurer)</span> &#123;</span><br><span class="line">        configurer.enable();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 视图控制器</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addViewControllers</span><span class="params">(ViewControllerRegistry registry)</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 配置异常处理器</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configureHandlerExceptionResolvers</span><span class="params">(List&lt;HandlerExceptionResolver&gt; resolvers)</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 配置拦截器</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="1-3-添加事务控制"><a href="#1-3-添加事务控制" class="headerlink" title="1.3 添加事务控制"></a>1.3 添加事务控制</h2><p>1、在SpringConfig中开启事务管理器</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@EnableTransactionManagement</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringConfig</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>2、在DataSourceConfig中添加事务管理器对象</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> PlatformTransactionManager <span class="title function_">platformTransactionManager</span><span class="params">(DataSource dataSource)</span>&#123;</span><br><span class="line">    <span class="type">DataSourceTransactionManager</span> <span class="variable">dataSourceTransactionManager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DataSourceTransactionManager</span>();</span><br><span class="line">    dataSourceTransactionManager.setDataSource(dataSource);</span><br><span class="line">    <span class="keyword">return</span> dataSourceTransactionManager;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>3、在service类上添加如下注解：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserService</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<h1 id="3-实现功能测试ssm整合"><a href="#3-实现功能测试ssm整合" class="headerlink" title="3. 实现功能测试ssm整合"></a>3. 实现功能测试ssm整合</h1><h2 id="3-1-数据库表"><a href="#3-1-数据库表" class="headerlink" title="3.1 数据库表"></a>3.1 数据库表</h2><p>tbl_user：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/SSM%E6%95%B0%E6%8D%AE%E8%A1%A8.png" alt="SSM数据表"></p>
<h2 id="3-2-pojo类编写"><a href="#3-2-pojo类编写" class="headerlink" title="3.2 pojo类编写"></a>3.2 pojo类编写</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">    <span class="keyword">private</span> String email;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-3-dao编写"><a href="#3-3-dao编写" class="headerlink" title="3.3 dao编写"></a>3.3 dao编写</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserDao</span> &#123;</span><br><span class="line">    <span class="meta">@Select(&quot;select * from tbl_user where id = #&#123;id&#125;&quot;)</span></span><br><span class="line">    User <span class="title function_">selectById</span><span class="params">(Long id)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-4-service编写"><a href="#3-4-service编写" class="headerlink" title="3.4 service编写"></a>3.4 service编写</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">getById</span><span class="params">(Long id)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserDao userDao;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">getById</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> userDao.selectById(id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-5-handler编写"><a href="#3-5-handler编写" class="headerlink" title="3.5 handler编写"></a>3.5 handler编写</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/users&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">detail</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> userService.getById(id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-6-前端发送ajax"><a href="#3-6-前端发送ajax" class="headerlink" title="3.6 前端发送ajax"></a>3.6 前端发送ajax</h2><p>1、引入js文件</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/SSM%E6%95%B4%E5%90%88%E5%BC%95%E5%85%A5js%E6%96%87%E4%BB%B6.png" alt="SSM整合引入js文件"></p>
<p>2、开启静态资源处理</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configureDefaultServletHandling</span><span class="params">(DefaultServletHandlerConfigurer configurer)</span> &#123;</span><br><span class="line">    configurer.enable();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3、视图控制器</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addViewControllers</span><span class="params">(ViewControllerRegistry registry)</span> &#123;</span><br><span class="line">    registry.addViewController(<span class="string">&quot;/&quot;</span>).setViewName(<span class="string">&quot;index&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>4、编写index.html页面</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span> <span class="attr">xmlns:th</span>=<span class="string">&quot;http://www.thymeleaf.org&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>ssm整合<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--引入vue--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">th:src</span>=<span class="string">&quot;@&#123;/static/js/vue3.4.21.js&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--引入axios--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">th:src</span>=<span class="string">&quot;@&#123;/static/js/axios.min.js&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;app&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;getMessage&quot;</span>&gt;</span>查看id=1的用户信息<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>&#123;&#123;message&#125;&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">th:inline</span>=<span class="string">&quot;javascript&quot;</span>&gt;</span></span><br><span class="line">    Vue.createApp(&#123;</span><br><span class="line">        data() &#123;</span><br><span class="line">            return &#123;</span><br><span class="line">                message: &#x27;&#x27;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        methods: &#123;</span><br><span class="line">            async getMessage() &#123;</span><br><span class="line">                let response = await axios.get([[@&#123;/&#125;]] + &#x27;users/1&#x27;)</span><br><span class="line">                    this.message = response.data</span><br><span class="line">            &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).mount(&quot;#app&quot;)</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>5、测试结果：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/SSM%E6%95%B4%E5%90%88%E6%B5%8B%E8%AF%95%E7%BB%93%E6%9E%9C.png" alt="SSM整合测试结果"></p>
]]></content>
      <categories>
        <category>Java</category>
        <category>SSM</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>Spring</tag>
        <tag>SpringMVC</tag>
      </tags>
  </entry>
  <entry>
    <title>【第13章】 全注解开发</title>
    <url>/posts/51421/</url>
    <content><![CDATA[<p>参考视频：<a href="https://www.bilibili.com/video/BV1sC411L76f/">SpringMVC教程，SpringMVC从零到精通，老杜SpringMVC，动力节点SpringMVC</a></p>
<h1 id="1-web-xml文件的替代"><a href="#1-web-xml文件的替代" class="headerlink" title="1. web.xml文件的替代"></a>1. web.xml文件的替代</h1><h2 id="1-1-Servlet3-0新特性"><a href="#1-1-Servlet3-0新特性" class="headerlink" title="1.1 Servlet3.0新特性"></a>1.1 Servlet3.0新特性</h2><p>Servlet3.0新特性：web.xml文件可以不写了。</p>
<p>在Servlet3.0的时候，规范中提供了一个接口<code>ServletContainerInitializer</code>：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/ServletContainerInitializer%E6%8E%A5%E5%8F%A3.png" alt="ServletContainerInitializer接口" style="zoom:67%;">

<p>服务器在启动的时候会自动从容器中找 <code>ServletContainerInitializer</code>接口的实现类，自动调用它的<code>onStartup</code>方法来完成Servlet上下文的初始化。</p>
<p>在Spring3.1版本的时候，提供了这样一个类<code>SpringServletContainerInitializer</code>，实现以上的接口：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/SpringServletContainerInitializer%E7%B1%BB.png" alt="SpringServletContainerInitializer类" style="zoom:67%;">

<p>它的核心方法如下：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/SpringServletContainerInitializer%E7%B1%BB%E7%9A%84%E6%A0%B8%E5%BF%83%E6%96%B9%E6%B3%95.png" alt="SpringServletContainerInitializer类的核心方法" style="zoom: 50%;">

<p>可以看到在服务器启动的时候，它会去加载所有实现<code>WebApplicationInitializer</code>接口的类：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/WebApplicationInitializer%E6%8E%A5%E5%8F%A3.png" alt="WebApplicationInitializer接口" style="zoom:67%;">

<p>这个接口下有一个子类是我们需要的：<code>AbstractAnnotationConfigDispatcherServletInitializer</code></p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/AbstractAnnotationConfigDispatcherServletInitializer%E7%B1%BB.png" alt="AbstractAnnotationConfigDispatcherServletInitializer类"></p>
<p>当我们编写类继承<code>AbstractAnnotationConfigDispatcherServletInitializer</code>之后，web服务器在启动的时候会根据它来初始化Servlet上下文。</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/web%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%A0%B9%E6%8D%AEAbstractAnnotationConfigDispatcherServletInitializer%E5%88%9D%E5%A7%8B%E5%8C%96Servlet%E4%B8%8A%E4%B8%8B%E6%96%87.png" alt="web服务器根据AbstractAnnotationConfigDispatcherServletInitializer初始化Servlet上下文" style="zoom:67%;">

<h2 id="1-2-编写WebAppInitializer"><a href="#1-2-编写WebAppInitializer" class="headerlink" title="1.2 编写WebAppInitializer"></a>1.2 编写WebAppInitializer</h2><p>以下这个类就是用来代替web.xml文件的：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.muyoukule.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebAppInitializer</span> <span class="keyword">extends</span> <span class="title class_">AbstractAnnotationConfigDispatcherServletInitializer</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Spring的配置</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Class&lt;?&gt;[] getRootConfigClasses() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * SpringMVC的配置</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Class&lt;?&gt;[] getServletConfigClasses() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;SpringMVCConfig.class&#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用于配置 DispatcherServlet 的映射路径</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> String[] getServletMappings() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;/&quot;</span>&#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 配置过滤器</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Filter[] getServletFilters() &#123;</span><br><span class="line">        <span class="type">CharacterEncodingFilter</span> <span class="variable">characterEncodingFilter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CharacterEncodingFilter</span>();</span><br><span class="line">        characterEncodingFilter.setEncoding(<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">        characterEncodingFilter.setForceRequestEncoding(<span class="literal">true</span>);</span><br><span class="line">        characterEncodingFilter.setForceResponseEncoding(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">HiddenHttpMethodFilter</span> <span class="variable">hiddenHttpMethodFilter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HiddenHttpMethodFilter</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Filter</span>[]&#123;characterEncodingFilter, hiddenHttpMethodFilter&#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>SpringMVC配置如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.muyoukule.config;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringMVCConfig</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="2-Spring-MVC的配置"><a href="#2-Spring-MVC的配置" class="headerlink" title="2. Spring MVC的配置"></a>2. Spring MVC的配置</h1><h2 id="2-1-组件扫描"><a href="#2-1-组件扫描" class="headerlink" title="2.1 组件扫描"></a>2.1 组件扫描</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 指定该类是一个配置类，可以当配置文件使用</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="comment">// 开启组件扫描</span></span><br><span class="line"><span class="meta">@ComponentScan(&quot;com.muyoukule.controller&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringMVCConfig</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-2-开启注解驱动"><a href="#2-2-开启注解驱动" class="headerlink" title="2.2 开启注解驱动"></a>2.2 开启注解驱动</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 指定该类是一个配置类，可以当配置文件使用</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="comment">// 开启组件扫描</span></span><br><span class="line"><span class="meta">@ComponentScan(&quot;com.muyoukule.controller&quot;)</span></span><br><span class="line"><span class="comment">// 开启注解驱动</span></span><br><span class="line"><span class="meta">@EnableWebMvc</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringMVCConfig</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-3-视图解析器"><a href="#2-3-视图解析器" class="headerlink" title="2.3 视图解析器"></a>2.3 视图解析器</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 指定该类是一个配置类，可以当配置文件使用</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="comment">// 开启组件扫描</span></span><br><span class="line"><span class="meta">@ComponentScan(&quot;com.muyoukule.controller&quot;)</span></span><br><span class="line"><span class="comment">// 开启注解驱动</span></span><br><span class="line"><span class="meta">@EnableWebMvc</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringMVCConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ThymeleafViewResolver <span class="title function_">getViewResolver</span><span class="params">(SpringTemplateEngine springTemplateEngine)</span> &#123;</span><br><span class="line">        <span class="type">ThymeleafViewResolver</span> <span class="variable">resolver</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThymeleafViewResolver</span>();</span><br><span class="line">        resolver.setTemplateEngine(springTemplateEngine);</span><br><span class="line">        resolver.setCharacterEncoding(<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">        resolver.setOrder(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> resolver;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> SpringTemplateEngine <span class="title function_">templateEngine</span><span class="params">(ITemplateResolver iTemplateResolver)</span> &#123;</span><br><span class="line">        <span class="type">SpringTemplateEngine</span> <span class="variable">templateEngine</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SpringTemplateEngine</span>();</span><br><span class="line">        templateEngine.setTemplateResolver(iTemplateResolver);</span><br><span class="line">        <span class="keyword">return</span> templateEngine;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ITemplateResolver <span class="title function_">templateResolver</span><span class="params">(ApplicationContext applicationContext)</span> &#123;</span><br><span class="line">        <span class="type">SpringResourceTemplateResolver</span> <span class="variable">resolver</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SpringResourceTemplateResolver</span>();</span><br><span class="line">        resolver.setApplicationContext(applicationContext);</span><br><span class="line">        resolver.setPrefix(<span class="string">&quot;/WEB-INF/thymeleaf/&quot;</span>);</span><br><span class="line">        resolver.setSuffix(<span class="string">&quot;.html&quot;</span>);</span><br><span class="line">        resolver.setTemplateMode(TemplateMode.HTML);</span><br><span class="line">        resolver.setCharacterEncoding(<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">        resolver.setCacheable(<span class="literal">false</span>);<span class="comment">//开发时关闭缓存，改动即可生效</span></span><br><span class="line">        <span class="keyword">return</span> resolver;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-4-开启默认Servlet处理"><a href="#2-4-开启默认Servlet处理" class="headerlink" title="2.4 开启默认Servlet处理"></a>2.4 开启默认Servlet处理</h2><p>让SpringMVCConfig类实现这个接口：<code>WebMvcConfigurer</code></p>
<p>并且重写以下的方法：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configureDefaultServletHandling</span><span class="params">(DefaultServletHandlerConfigurer configurer)</span> &#123;</span><br><span class="line">    configurer.enable();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-5-view-controller"><a href="#2-5-view-controller" class="headerlink" title="2.5 view-controller"></a>2.5 view-controller</h2><p>重写以下方法：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addViewControllers</span><span class="params">(ViewControllerRegistry registry)</span> &#123;</span><br><span class="line">    registry.addViewController(<span class="string">&quot;/test&quot;</span>).setViewName(<span class="string">&quot;test&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-6-异常处理器"><a href="#2-6-异常处理器" class="headerlink" title="2.6 异常处理器"></a>2.6 异常处理器</h2><p>重写以下方法：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 配置异常处理器</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configureHandlerExceptionResolvers</span><span class="params">(List&lt;HandlerExceptionResolver&gt; resolvers)</span> &#123;</span><br><span class="line">    <span class="comment">// 可以配置多个异常处理器，这是其中一个。</span></span><br><span class="line">    <span class="type">SimpleMappingExceptionResolver</span> <span class="variable">resolver</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleMappingExceptionResolver</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置其中的 exceptionMappings 属性</span></span><br><span class="line">    <span class="type">Properties</span> <span class="variable">prop</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Properties</span>();</span><br><span class="line">    prop.setProperty(<span class="string">&quot;java.lang.Exception&quot;</span>, <span class="string">&quot;tip&quot;</span>);</span><br><span class="line">    resolver.setExceptionMappings(prop);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置其中的 exceptionAttribute 属性</span></span><br><span class="line">    resolver.setExceptionAttribute(<span class="string">&quot;e&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将异常处理器添加到List集合中。</span></span><br><span class="line">    resolvers.add(resolver);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-7-拦截器"><a href="#2-7-拦截器" class="headerlink" title="2.7 拦截器"></a>2.7 拦截器</h2><p>自定义一个拦截器实现<code>HandlerInterceptor</code>接口：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.muyoukule.interceptors;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;MyInterceptor&#x27;s preHandle&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">postHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;MyInterceptor&#x27;s postHandle&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterCompletion</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;MyInterceptor&#x27;s afterCompletion&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在SpringMVCConfig类重写以下方法：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> &#123;</span><br><span class="line">    <span class="type">MyInterceptor</span> <span class="variable">myInterceptor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyInterceptor</span>();</span><br><span class="line">    registry.addInterceptor(myInterceptor).addPathPatterns(<span class="string">&quot;/**&quot;</span>).excludePathPatterns(<span class="string">&quot;/test&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





]]></content>
      <categories>
        <category>Java</category>
        <category>SSM</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>Spring</tag>
        <tag>SpringMVC</tag>
      </tags>
  </entry>
  <entry>
    <title>【第12章】 手写SpringMVC</title>
    <url>/posts/5625/</url>
    <content><![CDATA[<p>参考视频：<a href="https://www.bilibili.com/video/BV1sC411L76f/">SpringMVC教程，SpringMVC从零到精通，老杜SpringMVC，动力节点SpringMVC</a></p>
<div class="note blue icon-padding flat"><i class="note-icon fas fa-bullhorn"></i><p>本部分大多涉及源码，直接配合 <a href="https://github.com/muyoukule/myspringmvc.git">代码 </a>观看对应视频学习效果更佳！！</p>
</div>





]]></content>
      <categories>
        <category>Java</category>
        <category>SSM</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>Spring</tag>
        <tag>SpringMVC</tag>
      </tags>
  </entry>
  <entry>
    <title>【第11章】 SpringMVC执行流程</title>
    <url>/posts/61153/</url>
    <content><![CDATA[<p>参考视频：<a href="https://www.bilibili.com/video/BV1sC411L76f/">SpringMVC教程，SpringMVC从零到精通，老杜SpringMVC，动力节点SpringMVC</a></p>
<h1 id="1-从源码角度看执行流程"><a href="#1-从源码角度看执行流程" class="headerlink" title="1. 从源码角度看执行流程"></a>1. 从源码角度看执行流程</h1><h2 id="1-1-从源码角度分析SpringMVC执行流程"><a href="#1-1-从源码角度分析SpringMVC执行流程" class="headerlink" title="1.1 从源码角度分析SpringMVC执行流程"></a>1.1 从源码角度分析SpringMVC执行流程</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 前端控制器，SpringMVC最核心的类</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DispatcherServlet</span> <span class="keyword">extends</span> <span class="title class_">FrameworkServlet</span> &#123;</span><br><span class="line">	<span class="comment">// 前端控制器最核心的方法，这个方法是负责处理请求的，一次请求，调用一次 doDispatch 方法。</span></span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doDispatch</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		<span class="comment">// 通过请求获取处理器</span></span><br><span class="line">		<span class="comment">// 请求：http://localhost:8080/springmvc/hello （有URI）</span></span><br><span class="line">		<span class="comment">// 根据请求路径来获取对应的要执行的处理器</span></span><br><span class="line">		<span class="comment">// 实际上返回的是一个处理器执行链对象</span></span><br><span class="line">		<span class="comment">// 这个执行链(链条)把谁串起来了呢？把这一次请求要执行的所有拦截器和处理器串起来了。</span></span><br><span class="line">		<span class="comment">// HandlerExecutionChain是一次请求对应一个对象</span></span><br><span class="line">		<span class="type">HandlerExecutionChain</span> <span class="variable">mappedHandler</span> <span class="operator">=</span> getHandler(request);</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// 根据处理器获取处理器适配器对象</span></span><br><span class="line">		<span class="type">HandlerAdapter</span> <span class="variable">ha</span> <span class="operator">=</span> getHandlerAdapter(mappedHandler.getHandler()); <span class="comment">// Handler就是我们写的Controller</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">// 执行该请求对应的所有拦截器中的 preHandle 方法</span></span><br><span class="line">		<span class="keyword">if</span> (!mappedHandler.applyPreHandle(processedRequest, response)) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 调用处理器方法，返回ModelAndView对象</span></span><br><span class="line">		<span class="comment">// 在这里进行的数据绑定，实际上调用处理器方法之前要给处理器方法传参</span></span><br><span class="line">		<span class="comment">// 需要传参的话，这个参数实际上是要经过一个复杂的数据绑定过程（将前端提交的表单数据转换成POJO对象）</span></span><br><span class="line">		mv = ha.handle(processedRequest, response, mappedHandler.getHandler());</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 执行该请求对应的所有拦截器中的 postHandle 方法</span></span><br><span class="line">		mappedHandler.applyPostHandle(processedRequest, response, mv);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 处理分发结果（本质上就是响应结果到浏览器）</span></span><br><span class="line">		processDispatchResult(processedRequest, response, mappedHandler, mv, dispatchException);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">processDispatchResult</span><span class="params">(HttpServletRequest request, HttpServletResponse response,</span></span><br><span class="line"><span class="params">			<span class="meta">@Nullable</span> HandlerExecutionChain mappedHandler, <span class="meta">@Nullable</span> ModelAndView mv,</span></span><br><span class="line"><span class="params">			<span class="meta">@Nullable</span> Exception exception)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		<span class="comment">// 渲染</span></span><br><span class="line">		render(mv, request, response);</span><br><span class="line">		<span class="comment">// 执行该请求所对应的所有拦截器的afterCompletion方法</span></span><br><span class="line">		mappedHandler.triggerAfterCompletion(request, response, <span class="literal">null</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">render</span><span class="params">(ModelAndView mv, HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		<span class="comment">// 通过视图解析器进行解析，返回视图View对象</span></span><br><span class="line">		<span class="type">View</span> <span class="variable">view</span> <span class="operator">=</span> resolveViewName(viewName, mv.getModelInternal(), locale, request);</span><br><span class="line">		<span class="comment">// 调用视图对象的渲染方法（完成响应）</span></span><br><span class="line">		view.render(mv.getModelInternal(), request, response);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">protected</span> View <span class="title function_">resolveViewName</span><span class="params">(String viewName, <span class="meta">@Nullable</span> Map&lt;String, Object&gt; model,</span></span><br><span class="line"><span class="params">			Locale locale, HttpServletRequest request)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		<span class="comment">// 视图解析器</span></span><br><span class="line">		ViewResolver viewResolver;</span><br><span class="line">		<span class="comment">// 通过视图解析器解析返回视图对象View</span></span><br><span class="line">		<span class="type">View</span> <span class="variable">view</span> <span class="operator">=</span> viewResolver.resolveViewName(viewName, locale);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 视图解析器接口</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ViewResolver</span> &#123;</span><br><span class="line">	View <span class="title function_">resolveViewName</span><span class="params">(String viewName, Locale locale)</span> <span class="keyword">throws</span> Exception;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 视图解析器接口实现类也很多：ThymeleafViewResolver、InternalResourceViewResolver</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 视图接口</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">View</span>&#123;</span><br><span class="line">	<span class="keyword">void</span> <span class="title function_">render</span><span class="params">(<span class="meta">@Nullable</span> Map&lt;String, ?&gt; model, HttpServletRequest request, HttpServletResponse response)</span></span><br><span class="line">			<span class="keyword">throws</span> Exception;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 每一个接口肯定是有接口下的实现类，例如View接口的实现类：ThymeleafView、InternalResourceView....</span></span><br></pre></td></tr></table></figure>

<h2 id="1-2-关于根据请求获取处理器执行链"><a href="#1-2-关于根据请求获取处理器执行链" class="headerlink" title="1.2 关于根据请求获取处理器执行链"></a>1.2 关于根据请求获取处理器执行链</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">分析这一行代码：</span><br><span class="line"><span class="type">HandlerExecutionChain</span> <span class="variable">mappedHandler</span> <span class="operator">=</span> getHandler(request);</span><br><span class="line"></span><br><span class="line"><span class="number">1.</span> HandlerExecutionChain：处理器执行链对象</span><br><span class="line"></span><br><span class="line"><span class="number">2.</span> HandlerExecutionChain中的属性：</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HandlerExecutionChain</span>&#123;</span><br><span class="line">		<span class="comment">// 底层对应的是一个HandlerMethod对象</span></span><br><span class="line">		<span class="comment">// 处理器方法对象</span></span><br><span class="line">		<span class="type">Object</span> <span class="variable">handler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HandlerMethod</span>(.....);</span><br><span class="line">		<span class="comment">// 该请求对应的所有的拦截器按照顺序放到了ArrayList集合中</span></span><br><span class="line">		<span class="comment">// 所有的拦截器对象也都是在服务器启动的时候都创建好。</span></span><br><span class="line">		List&lt;HandlerInterceptor&gt; interceptorList;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"><span class="number">3.</span> HandlerMethod 是什么？</span><br><span class="line">	</span><br><span class="line">	HandlerMethod是最核心的要执行的目标，翻译为：处理器方法。</span><br><span class="line">	注意：HandlerMethod 是在web服务器启动时初始化spring容器的时候，就创建好了。</span><br><span class="line">	这个类当中比较重要的属性包括：beanName和Method</span><br><span class="line">	例如，以下代码：</span><br><span class="line">		<span class="meta">@Controller(&quot;userController&quot;)</span></span><br><span class="line">		<span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserController</span>&#123;</span><br><span class="line">			<span class="meta">@RequestMapping(&quot;/login&quot;)</span></span><br><span class="line">			<span class="keyword">public</span> String <span class="title function_">login</span><span class="params">(User user)</span>&#123;</span><br><span class="line">				<span class="keyword">return</span> ....</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	那么以上代码对应了一个HandlerMethod对象：</span><br><span class="line">		<span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HandlerMethod</span>&#123;</span><br><span class="line">			<span class="keyword">private</span> <span class="type">String</span> <span class="variable">beanName</span> <span class="operator">=</span> <span class="string">&quot;userController&quot;</span>;</span><br><span class="line">			<span class="keyword">private</span> Method loginMethod;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line"><span class="number">4.</span> getHandler(request);</span><br><span class="line">	这个方法还是在DispatcherServlet类中。</span><br><span class="line">	<span class="keyword">protected</span> HandlerExecutionChain <span class="title function_">getHandler</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">this</span>.handlerMappings != <span class="literal">null</span>) &#123;</span><br><span class="line">			<span class="keyword">for</span> (HandlerMapping mapping : <span class="built_in">this</span>.handlerMappings) &#123;</span><br><span class="line">				<span class="comment">// 通过合适的 HandlerMapping才能获取到 HandlerExecutionChain对象。</span></span><br><span class="line">				<span class="comment">// 如果你处理器方法使用了 @RequestMapping注解，那么以下代码中的mapping是：RequestMappingHandlerMapping对象。</span></span><br><span class="line">				<span class="type">HandlerExecutionChain</span> <span class="variable">handler</span> <span class="operator">=</span> mapping.getHandler(request);</span><br><span class="line">				<span class="keyword">if</span> (handler != <span class="literal">null</span>) &#123;</span><br><span class="line">					<span class="keyword">return</span> handler;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	重点：</span><br><span class="line">		我们处理请求的第一步代码是：<span class="type">HandlerExecutionChain</span> <span class="variable">mappedHandler</span> <span class="operator">=</span> getHandler(request);</span><br><span class="line">		其本质上是调用了：<span class="type">HandlerExecutionChain</span> <span class="variable">handler</span> <span class="operator">=</span> mapping.getHandler(request);</span><br><span class="line"></span><br><span class="line">	mapping变量就是 HandlerMapping。</span><br><span class="line">	HandlerMapping是一个接口：</span><br><span class="line">		翻译为处理器映射器，专门负责映射的。就是本质上根据请求路径去映射处理器方法的。</span><br><span class="line">		HandlerMapping接口下有很多实现类：</span><br><span class="line">			例如其中一个比较有名的，常用的：RequestMappingHandlerMapping</span><br><span class="line">			这个 RequestMappingHandlerMapping 叫做：<span class="meta">@RequestMapping</span>注解专用的处理器映射器对象。</span><br><span class="line"></span><br><span class="line">			当然，如果你没有使用 <span class="meta">@RequestMapping</span>注解，也可以写xml配置文件来进行映射，那个时候对应的就是其他的HandlerMapping接口的实现类了。</span><br><span class="line">	</span><br><span class="line">	HandlerMapping 对象也是在服务器启动阶段创建的，所有的HandlerMapping对象都是在服务器启动阶段创建，并且存放到集合中。</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DispatcherServlet</span>&#123;</span><br><span class="line">		List&lt;HandlerMapping&gt; handlerMappings;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"><span class="number">5.</span> RequestMappingHandlerMapping中的 getHandler(request);</span><br><span class="line">	<span class="type">HandlerExecutionChain</span> <span class="variable">handler</span> <span class="operator">=</span> mapping.getHandler(request);</span><br><span class="line">	</span><br><span class="line">	mapping.getHandler(request);这个方法底层一定是获取了 HandlerMethod 对象，将其赋值给 HandlerExecutionChain的handler属性</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RequestMappingHandlerMapping</span> <span class="keyword">extends</span> <span class="title class_">AbstractHandlerMethodMapping</span>&#123;</span><br><span class="line">		<span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">registerHandlerMethod</span><span class="params">(Object handler, Method method, RequestMappingInfo mapping)</span> &#123;</span><br><span class="line">			<span class="built_in">super</span>.registerHandlerMethod(handler, method, mapping);</span><br><span class="line">			updateConsumesCondition(mapping, method);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AbstractHandlerMethodMapping</span>&#123;</span><br><span class="line">		<span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">registerHandlerMethod</span><span class="params">(Object handler, Method method, T mapping)</span> &#123;</span><br><span class="line">			<span class="built_in">this</span>.mappingRegistry.register(mapping, handler, method);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">register</span><span class="params">(T mapping, Object handler, Method method)</span> &#123;</span><br><span class="line">			<span class="type">HandlerMethod</span> <span class="variable">handlerMethod</span> <span class="operator">=</span> createHandlerMethod(handler, method);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">protected</span> HandlerMethod <span class="title function_">createHandlerMethod</span><span class="params">(Object handler, Method method)</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (handler <span class="keyword">instanceof</span> String beanName) &#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HandlerMethod</span>(beanName,</span><br><span class="line">						obtainApplicationContext().getAutowireCapableBeanFactory(),</span><br><span class="line">						obtainApplicationContext(),</span><br><span class="line">						method);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HandlerMethod</span>(handler, method);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">这一步牵连到的类有哪些：</span><br><span class="line">	HandlerExecutionChain</span><br><span class="line">	HandlerMethod</span><br><span class="line">	HandlerInterceptor</span><br><span class="line">	HandlerMapping</span><br><span class="line">		RequestMappingHandlerMapping（是HandlerMaping接口的实现）</span><br></pre></td></tr></table></figure>

<h2 id="1-3-关于根据处理器来获取处理器适配器"><a href="#1-3-关于根据处理器来获取处理器适配器" class="headerlink" title="1.3 关于根据处理器来获取处理器适配器"></a>1.3 关于根据处理器来获取处理器适配器</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">分析：</span><br><span class="line"><span class="type">HandlerAdapter</span> <span class="variable">ha</span> <span class="operator">=</span> getHandlerAdapter(mappedHandler.getHandler());</span><br><span class="line"></span><br><span class="line"><span class="number">1.</span> 底层使用了适配器模式。</span><br><span class="line"></span><br><span class="line"><span class="number">2.</span> 每一个处理器(我们自己写的Controller)，都有自己适合的处理器适配器。</span><br><span class="line"></span><br><span class="line"><span class="number">3.</span> 在SpringMVC当中处理器适配器也有很多种，其中一个比较有名的，常用的处理器适配器是：RequestMappingHandlerAdapter</span><br><span class="line">这个处理器适配器是专门处理 “处理器方法”上有 <span class="meta">@RequestMapping</span> 注解的。</span><br><span class="line"></span><br><span class="line"><span class="number">4.</span> mappedHandler.getHandler() 获取的是 HandlerMethod 对象</span><br><span class="line"></span><br><span class="line"><span class="number">5.</span> HandlerAdapter也是一个接口：</span><br><span class="line">	其中有一个常用的实现类：RequestMappingHandlerAdapter</span><br><span class="line"></span><br><span class="line"><span class="number">6.</span> 在服务器启动阶段，所有的 HandlerAdapter接口的实现类都会创建出来。在服务器启动阶段！！！！！！</span><br><span class="line">	List&lt;HandlerAdapter&gt; handlerAdapters;</span><br><span class="line"></span><br><span class="line"><span class="number">7.</span> HandlerAdapter接口非常重要，通过这个接口来调用最终的 HandlerMethod。</span><br><span class="line"></span><br><span class="line"><span class="number">8.</span> HandlerAdapter是适配器，是对 HandlerMethod 进行的适配。</span><br><span class="line"></span><br><span class="line"><span class="number">9.</span> 在DispatcherServlet类中，如下代码：</span><br><span class="line">	<span class="keyword">protected</span> HandlerAdapter <span class="title function_">getHandlerAdapter</span><span class="params">(Object handler)</span> <span class="keyword">throws</span> ServletException &#123;</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">this</span>.handlerAdapters != <span class="literal">null</span>) &#123;</span><br><span class="line">			<span class="keyword">for</span> (HandlerAdapter adapter : <span class="built_in">this</span>.handlerAdapters) &#123;</span><br><span class="line">				<span class="keyword">if</span> (adapter.supports(handler)) &#123;</span><br><span class="line">					<span class="keyword">return</span> adapter;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<h2 id="1-4-关于执行请求对应的拦截器preHandle"><a href="#1-4-关于执行请求对应的拦截器preHandle" class="headerlink" title="1.4 关于执行请求对应的拦截器preHandle"></a>1.4 关于执行请求对应的拦截器preHandle</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">关于执行请求对应的拦截器的preHandle方法</span><br><span class="line"></span><br><span class="line">DispatcherServlet:</span><br><span class="line"><span class="keyword">if</span> (!mappedHandler.applyPreHandle(processedRequest, response)) &#123;</span><br><span class="line">	<span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">HandlerExecutionChain：</span><br><span class="line"><span class="type">boolean</span> <span class="title function_">applyPreHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="built_in">this</span>.interceptorList.size(); i++) &#123;</span><br><span class="line">		<span class="type">HandlerInterceptor</span> <span class="variable">interceptor</span> <span class="operator">=</span> <span class="built_in">this</span>.interceptorList.get(i);</span><br><span class="line">		<span class="keyword">if</span> (!interceptor.preHandle(request, response, <span class="built_in">this</span>.handler)) &#123;</span><br><span class="line">			triggerAfterCompletion(request, response, <span class="literal">null</span>);</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="built_in">this</span>.interceptorIndex = i;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">遍历List集合，从List集合中取出每一个 HandlerInterceptor对象，调用 preHandle，i++，可见是顺序调用。</span><br></pre></td></tr></table></figure>

<h2 id="1-5-关于调用处理器方法"><a href="#1-5-关于调用处理器方法" class="headerlink" title="1.5 关于调用处理器方法"></a>1.5 关于调用处理器方法</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">关于调用处理器方法：</span><br><span class="line">	mv = ha.handle(processedRequest, response, mappedHandler.getHandler());</span><br><span class="line"></span><br><span class="line">	ha 是处理器适配器</span><br><span class="line"></span><br><span class="line">	mv 是ModelAndView对象</span><br><span class="line"></span><br><span class="line">	这个方法是最核心的，调用请求路径对应的HandlerMethod。（调用处理器方法。）</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ha是HandlerAdapter，如果是 <span class="meta">@RequestMapping</span> 注解对应的，那么就是 RequestMappingHandlerAdapter：</span><br><span class="line"></span><br><span class="line">RequestMappingHandlerAdapter：</span><br><span class="line">	<span class="keyword">protected</span> ModelAndView <span class="title function_">handleInternal</span><span class="params">(HttpServletRequest request,</span></span><br><span class="line"><span class="params">				HttpServletResponse response, HandlerMethod handlerMethod)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		mav = invokeHandlerMethod(request, response, handlerMethod);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">protected</span> ModelAndView <span class="title function_">invokeHandlerMethod</span><span class="params">(HttpServletRequest request,</span></span><br><span class="line"><span class="params">			HttpServletResponse response, HandlerMethod handlerMethod)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		<span class="comment">// 获取一个数据绑定工厂</span></span><br><span class="line">		<span class="type">WebDataBinderFactory</span> <span class="variable">binderFactory</span> <span class="operator">=</span> getDataBinderFactory(handlerMethod);</span><br><span class="line">		<span class="comment">// 获取一个可调用的处理器方法</span></span><br><span class="line">		<span class="type">ServletInvocableHandlerMethod</span> <span class="variable">invocableMethod</span> <span class="operator">=</span> createInvocableHandlerMethod(handlerMethod);</span><br><span class="line">		<span class="comment">// 给可调用的方法绑定数据</span></span><br><span class="line">		invocableMethod.setDataBinderFactory(binderFactory);</span><br><span class="line">		<span class="comment">// 给可调用的方法设置参数</span></span><br><span class="line">		invocableMethod.setParameterNameDiscoverer(<span class="built_in">this</span>.parameterNameDiscoverer);</span><br><span class="line">		<span class="comment">// 可调用的方法执行了。</span></span><br><span class="line">		invocableMethod.invokeAndHandle(webRequest, mavContainer);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">在HandlerAdapter中做的核心事情：</span><br><span class="line">	将前端提交的form数据通过 HttpMessageConverter 将其转换成 POJO对象。（数据转换）</span><br><span class="line">	并将数据绑定到 HandlerMethod 对象上。</span><br><span class="line">	调用HandlerMethod。</span><br><span class="line">	返回 ModelAndView</span><br></pre></td></tr></table></figure>

<h2 id="1-6-关于执行请求对应的拦截器的postHandle"><a href="#1-6-关于执行请求对应的拦截器的postHandle" class="headerlink" title="1.6 关于执行请求对应的拦截器的postHandle"></a>1.6 关于执行请求对应的拦截器的postHandle</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">DispatcherServlet:</span><br><span class="line"></span><br><span class="line">	mappedHandler.applyPostHandle(processedRequest, response, mv);</span><br><span class="line"></span><br><span class="line">HandlerExecutionChain:</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">void</span> <span class="title function_">applyPostHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, <span class="meta">@Nullable</span> ModelAndView mv)</span></span><br><span class="line">			<span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="built_in">this</span>.interceptorList.size() - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">			<span class="type">HandlerInterceptor</span> <span class="variable">interceptor</span> <span class="operator">=</span> <span class="built_in">this</span>.interceptorList.get(i);</span><br><span class="line">			interceptor.postHandle(request, response, <span class="built_in">this</span>.handler, mv);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">通过源码解决，可以很轻松的看到，从List集合中逆序(i--)逐一取出拦截器对象，并且调用拦截器的 postHandle方法。</span><br></pre></td></tr></table></figure>

<h2 id="1-7-关于处理分发结果"><a href="#1-7-关于处理分发结果" class="headerlink" title="1.7 关于处理分发结果"></a>1.7 关于处理分发结果</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DispatcherServlet</span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 处理分发结果</span></span><br><span class="line">	processDispatchResult(processedRequest, response, mappedHandler, mv, dispatchException);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">processDispatchResult</span><span class="params">(HttpServletRequest request, HttpServletResponse response,</span></span><br><span class="line"><span class="params">			<span class="meta">@Nullable</span> HandlerExecutionChain mappedHandler, <span class="meta">@Nullable</span> ModelAndView mv,</span></span><br><span class="line"><span class="params">			<span class="meta">@Nullable</span> Exception exception)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		<span class="comment">// 渲染</span></span><br><span class="line">		render(mv, request, response);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">render</span><span class="params">(ModelAndView mv, HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		<span class="comment">// 通过视图解析器进行解析，返回视图View对象</span></span><br><span class="line">		<span class="type">View</span> <span class="variable">view</span> <span class="operator">=</span> resolveViewName(viewName, mv.getModelInternal(), locale, request);</span><br><span class="line">		<span class="comment">// 调用视图对象的渲染方法（完成响应）</span></span><br><span class="line">		view.render(mv.getModelInternal(), request, response);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">protected</span> View <span class="title function_">resolveViewName</span><span class="params">(String viewName, <span class="meta">@Nullable</span> Map&lt;String, Object&gt; model,</span></span><br><span class="line"><span class="params">			Locale locale, HttpServletRequest request)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		<span class="comment">// 视图解析器</span></span><br><span class="line">		ViewResolver viewResolver;</span><br><span class="line">		<span class="comment">// 通过视图解析器解析返回视图对象View</span></span><br><span class="line">		<span class="type">View</span> <span class="variable">view</span> <span class="operator">=</span> viewResolver.resolveViewName(viewName, locale);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 视图解析器接口</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ViewResolver</span> &#123;</span><br><span class="line">	View <span class="title function_">resolveViewName</span><span class="params">(String viewName, Locale locale)</span> <span class="keyword">throws</span> Exception;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 视图解析器接口实现类也很多：ThymeleafViewResolver、InternalResourceViewResolver</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 视图接口</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">View</span>&#123;</span><br><span class="line">	<span class="keyword">void</span> <span class="title function_">render</span><span class="params">(<span class="meta">@Nullable</span> Map&lt;String, ?&gt; model, HttpServletRequest request, HttpServletResponse response)</span></span><br><span class="line">			<span class="keyword">throws</span> Exception;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 每一个接口肯定是有接口下的实现类，例如View接口的实现类：ThymeleafView、InternalResourceView....</span></span><br></pre></td></tr></table></figure>

<h2 id="1-8-关于执行拦截器的afterCompletion方法"><a href="#1-8-关于执行拦截器的afterCompletion方法" class="headerlink" title="1.8 关于执行拦截器的afterCompletion方法"></a>1.8 关于执行拦截器的afterCompletion方法</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">DispatcherServlet:</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">processDispatchResult</span><span class="params">(HttpServletRequest request, HttpServletResponse response,</span></span><br><span class="line"><span class="params">			<span class="meta">@Nullable</span> HandlerExecutionChain mappedHandler, <span class="meta">@Nullable</span> ModelAndView mv,</span></span><br><span class="line"><span class="params">			<span class="meta">@Nullable</span> Exception exception)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		<span class="comment">// 渲染</span></span><br><span class="line">		render(mv, request, response);</span><br><span class="line">		<span class="comment">// 执行该请求所对应的所有拦截器的afterCompletion方法</span></span><br><span class="line">		mappedHandler.triggerAfterCompletion(request, response, <span class="literal">null</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">HandlerExecutionChain:</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">void</span> <span class="title function_">triggerAfterCompletion</span><span class="params">(HttpServletRequest request, HttpServletResponse response, <span class="meta">@Nullable</span> Exception ex)</span> &#123;</span><br><span class="line">		<span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="built_in">this</span>.interceptorIndex; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">			<span class="type">HandlerInterceptor</span> <span class="variable">interceptor</span> <span class="operator">=</span> <span class="built_in">this</span>.interceptorList.get(i);</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				interceptor.afterCompletion(request, response, <span class="built_in">this</span>.handler, ex);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">catch</span> (Throwable ex2) &#123;</span><br><span class="line">				logger.error(<span class="string">&quot;HandlerInterceptor.afterCompletion threw exception&quot;</span>, ex2);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	通过源码可以看出，也是通过逆序(i--)的方式进行拦截器的调用，调用拦截器的afterCompletion方法。</span><br></pre></td></tr></table></figure>

<h1 id="2-从图片角度看执行流程"><a href="#2-从图片角度看执行流程" class="headerlink" title="2. 从图片角度看执行流程"></a>2. 从图片角度看执行流程</h1><p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/SpringMVC%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B.png" alt="SpringMVC执行流程"></p>
<h1 id="3-WEB服务器启动时都做了什么"><a href="#3-WEB服务器启动时都做了什么" class="headerlink" title="3. WEB服务器启动时都做了什么"></a>3. WEB服务器启动时都做了什么</h1><p>先搞明白核心类的继承关系：</p>
<p><code>DispatcherServlet extends FrameworkServlet extends HttpServletBean extends HttpServlet extends GenericServlet implements Servlet</code></p>
<p>服务器启动阶段完成了：</p>
<ol>
<li>初始化Spring上下文，也就是创建所有的<code>bean</code>，让IoC容器将其管理起来。</li>
<li>初始化SpringMVC相关的对象：处理器映射器，处理器适配器等。。。</li>
</ol>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/WEB%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%90%AF%E5%8A%A8(1).png" alt="WEB服务器启动(1)" style="zoom: 67%;">

<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/WEB%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%90%AF%E5%8A%A8(2).png" alt="WEB服务器启动(2)" style="zoom: 67%;">

<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/WEB%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%90%AF%E5%8A%A8(3).png" alt="WEB服务器启动(3)" style="zoom:50%;">

<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/WEB%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%90%AF%E5%8A%A8(4).png" alt="WEB服务器启动(4)" style="zoom: 50%;">

<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/WEB%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%90%AF%E5%8A%A8(5).png" alt="WEB服务器启动(5)" style="zoom:67%;">

<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/WEB%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%90%AF%E5%8A%A8(6).png" alt="WEB服务器启动(6)" style="zoom: 67%;">

<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/WEB%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%90%AF%E5%8A%A8(7).png" alt="WEB服务器启动(7)" style="zoom: 67%;">

<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/WEB%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%90%AF%E5%8A%A8(8).png" alt="WEB服务器启动(8)" style="zoom:67%;">
]]></content>
      <categories>
        <category>Java</category>
        <category>SSM</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>Spring</tag>
        <tag>SpringMVC</tag>
      </tags>
  </entry>
  <entry>
    <title>【第8、9、10章】 文件上传与下载、异常处理器、拦截器</title>
    <url>/posts/55101/</url>
    <content><![CDATA[<p>参考视频：<a href="https://www.bilibili.com/video/BV1sC411L76f/">SpringMVC教程，SpringMVC从零到精通，老杜SpringMVC，动力节点SpringMVC</a></p>
<h1 id="第8章-文件上传与下载"><a href="#第8章-文件上传与下载" class="headerlink" title="第8章 文件上传与下载"></a>第8章 文件上传与下载</h1><h2 id="1-文件上传"><a href="#1-文件上传" class="headerlink" title="1. 文件上传"></a>1. 文件上传</h2><p>使用SpringMVC6版本，<strong>不需要</strong>添加以下依赖：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-fileupload<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-fileupload<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>1、前端页面：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span> <span class="attr">xmlns:th</span>=<span class="string">&quot;http://www.thymeleaf.org&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>文件上传<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--文件上传表单--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">th:action</span>=<span class="string">&quot;@&#123;/file/up&#125;&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span> <span class="attr">enctype</span>=<span class="string">&quot;multipart/form-data&quot;</span>&gt;</span></span><br><span class="line">    文件：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">name</span>=<span class="string">&quot;fileName&quot;</span>/&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;上传&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><font color="red">PS：form表单采用post请求，enctype是<code>multipart/form-data</code>，并且上传组件是：<code>type=&quot;file&quot;</code></font></p>
<p>2、web.xml文件：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--前端控制器--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>dispatcherServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>org.springframework.web.servlet.DispatcherServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>contextConfigLocation<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>classpath:springmvc.xml<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">load-on-startup</span>&gt;</span>1<span class="tag">&lt;/<span class="name">load-on-startup</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">multipart-config</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--设置单个支持最大文件的大小--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">max-file-size</span>&gt;</span>102400<span class="tag">&lt;/<span class="name">max-file-size</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--设置整个表单所有文件上传的最大值--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">max-request-size</span>&gt;</span>102400<span class="tag">&lt;/<span class="name">max-request-size</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--设置最小上传文件大小--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">file-size-threshold</span>&gt;</span>0<span class="tag">&lt;/<span class="name">file-size-threshold</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">multipart-config</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>dispatcherServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><font color="red"><strong>PS：在DispatcherServlet配置时，添加 multipart-config 配置信息。（这是Spring6，如果是Spring5，则不是这样配置，而是在springmvc.xml文件中配置：CommonsMultipartResolver）SpringMVC6中把这个类已经删除了。废弃了。</strong></font></p>
<p>3、Controller中的代码：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(value = &quot;/file/up&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">fileUp</span><span class="params">(<span class="meta">@RequestParam(&quot;fileName&quot;)</span> MultipartFile multipartFile, HttpServletRequest request)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> multipartFile.getName();</span><br><span class="line">        System.out.println(name);</span><br><span class="line">        <span class="comment">// 获取文件名</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">originalFilename</span> <span class="operator">=</span> multipartFile.getOriginalFilename();</span><br><span class="line">        System.out.println(originalFilename);</span><br><span class="line">        <span class="comment">// 将文件存储到服务器中</span></span><br><span class="line">        <span class="comment">// 获取输入流</span></span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span> multipartFile.getInputStream();</span><br><span class="line">        <span class="comment">// 获取上传之后的存放目录</span></span><br><span class="line">        <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(request.getServletContext().getRealPath(<span class="string">&quot;/upload&quot;</span>));</span><br><span class="line">        <span class="comment">// 如果服务器目录不存在则新建</span></span><br><span class="line">        <span class="keyword">if</span> (!file.exists()) &#123;</span><br><span class="line">            file.mkdirs();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 开始写</span></span><br><span class="line">        <span class="comment">//BufferedOutputStream out = new BufferedOutputStream(new FileOutputStream(file.getAbsolutePath() + &quot;/&quot; + originalFilename));</span></span><br><span class="line">        <span class="comment">// 可以采用UUID来生成文件名，防止服务器上传文件时产生覆盖</span></span><br><span class="line">        <span class="type">BufferedOutputStream</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(file.getAbsolutePath() + <span class="string">&quot;/&quot;</span> + UUID.randomUUID().toString() + originalFilename.substring(originalFilename.lastIndexOf(<span class="string">&quot;.&quot;</span>))));</span><br><span class="line">        <span class="type">byte</span>[] bytes = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span> * <span class="number">100</span>];</span><br><span class="line">        <span class="type">int</span> <span class="variable">readCount</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> ((readCount = in.read(bytes)) != -<span class="number">1</span>) &#123;</span><br><span class="line">            out.write(bytes, <span class="number">0</span>, readCount);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 刷新缓冲流</span></span><br><span class="line">        out.flush();</span><br><span class="line">        <span class="comment">// 关闭流</span></span><br><span class="line">        in.close();</span><br><span class="line">        out.close();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;ok&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>4、最终测试结果：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/%E6%B5%8B%E8%AF%95%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0.png" alt="测试文件上传"></p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%88%90%E5%8A%9F.png" alt="文件上传成功"></p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/%E6%9F%A5%E7%9C%8B%E4%B8%8A%E4%BC%A0%E7%9A%84%E6%96%87%E4%BB%B6.png" alt="查看上传的文件" style="zoom: 50%;">

<p><strong>建议：上传文件时，文件起名采用UUID。以防文件覆盖。</strong></p>
<h2 id="2-文件下载"><a href="#2-文件下载" class="headerlink" title="2. 文件下载"></a>2. 文件下载</h2><p>1、index.html</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--文件下载--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">th:href</span>=<span class="string">&quot;@&#123;/download&#125;&quot;</span>&gt;</span>文件下载<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>2、文件下载核心程序，使用<code>ResponseEntity</code>：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/download&quot;)</span></span><br><span class="line"><span class="keyword">public</span> ResponseEntity&lt;<span class="type">byte</span>[]&gt; downloadFile(HttpServletResponse response, HttpServletRequest request) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(request.getServletContext().getRealPath(<span class="string">&quot;/upload&quot;</span>) + <span class="string">&quot;/muyoukule.jpg&quot;</span>);</span><br><span class="line">    <span class="comment">// 创建响应头对象</span></span><br><span class="line">    <span class="type">HttpHeaders</span> <span class="variable">headers</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpHeaders</span>();</span><br><span class="line">    <span class="comment">// 设置响应内容类型</span></span><br><span class="line">    headers.setContentType(MediaType.APPLICATION_OCTET_STREAM);</span><br><span class="line">    <span class="comment">// 设置下载文件的名称</span></span><br><span class="line">    headers.setContentDispositionFormData(<span class="string">&quot;attachment&quot;</span>, file.getName());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 下载文件</span></span><br><span class="line">    ResponseEntity&lt;<span class="type">byte</span>[]&gt; entity = <span class="keyword">new</span> <span class="title class_">ResponseEntity</span>&lt;<span class="type">byte</span>[]&gt;(Files.readAllBytes(file.toPath()), headers, HttpStatus.OK);</span><br><span class="line">    <span class="keyword">return</span> entity;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>效果：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/%E6%B5%8B%E8%AF%95%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD.png" alt="测试文件下载"></p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/%E6%9F%A5%E7%9C%8B%E4%B8%8B%E8%BD%BD%E7%9A%84%E6%96%87%E4%BB%B6.png" alt="查看下载的文件" style="zoom: 50%;">

<h1 id="第9章-异常处理器"><a href="#第9章-异常处理器" class="headerlink" title="第9章 异常处理器"></a>第9章 异常处理器</h1><h2 id="1-什么是异常处理器"><a href="#1-什么是异常处理器" class="headerlink" title="1. 什么是异常处理器"></a>1. 什么是异常处理器</h2><p>Spring MVC在<code>处理器方法</code>执行过程中出现了异常，可以采用<code>异常处理器</code>进行应对。<br>一句话概括异常处理器作用：处理器方法执行过程中出现了异常，跳转到对应的视图，在视图上展示友好信息。</p>
<p>SpringMVC为异常处理提供了一个接口：<code>HandlerExceptionResolver</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.web.servlet;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> jakarta.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> jakarta.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> org.springframework.lang.Nullable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">HandlerExceptionResolver</span> &#123;</span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    ModelAndView <span class="title function_">resolveException</span><span class="params">(HttpServletRequest request, HttpServletResponse response, <span class="meta">@Nullable</span> Object handler, Exception ex)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>核心方法是：<code>resolveException</code>。</p>
<p>该方法用来编写具体的异常处理方案。返回值<code>ModelAndView</code>，表示异常处理完之后跳转到哪个视图。</p>
<p>HandlerExceptionResolver 接口有两个常用的默认实现：</p>
<ul>
<li><code>DefaultHandlerExceptionResolver</code></li>
<li><code>SimpleMappingExceptionResolver</code></li>
</ul>
<h2 id="2-默认的异常处理器"><a href="#2-默认的异常处理器" class="headerlink" title="2. 默认的异常处理器"></a>2. 默认的异常处理器</h2><p><code>DefaultHandlerExceptionResolver</code> 是默认的异常处理器。</p>
<p>核心方法：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/DefaultHandlerExceptionResolver%E7%9A%84%E6%A0%B8%E5%BF%83%E6%96%B9%E6%B3%95.png" alt="DefaultHandlerExceptionResolver的核心方法"></p>
<p>当请求方式和处理方式不同时，<code>DefaultHandlerExceptionResolver</code>的默认处理态度是：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/DefaultHandlerExceptionResolver%E9%9D%A2%E5%AF%B9%E8%AF%B7%E6%B1%82%E5%92%8C%E5%A4%84%E7%90%86%E6%96%B9%E5%BC%8F%E4%B8%8D%E5%90%8C%E7%9A%84%E9%BB%98%E8%AE%A4%E5%A4%84%E7%90%86%E6%80%81%E5%BA%A6.png" alt="DefaultHandlerExceptionResolver面对请求和处理方式不同的默认处理态度"></p>
<h2 id="3-自定义的异常处理器"><a href="#3-自定义的异常处理器" class="headerlink" title="3. 自定义的异常处理器"></a>3. 自定义的异常处理器</h2><p>自定义异常处理器需要使用：<code>SimpleMappingExceptionResolver</code></p>
<p>自定义异常处理机制有两种语法：</p>
<ul>
<li>通过XML配置文件</li>
<li>通过注解</li>
</ul>
<h3 id="3-1-配置文件方式"><a href="#3-1-配置文件方式" class="headerlink" title="3.1 配置文件方式"></a>3.1 配置文件方式</h3><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.web.servlet.handler.SimpleMappingExceptionResolver&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;exceptionMappings&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">props</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--用来指定出现异常后，跳转的视图--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">&quot;java.lang.Exception&quot;</span>&gt;</span>tip<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">props</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--将异常信息存储到request域，value属性用来指定存储时的key。--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;exceptionAttribute&quot;</span> <span class="attr">value</span>=<span class="string">&quot;e&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在视图页面上展示异常信息：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span> <span class="attr">xmlns:th</span>=<span class="string">&quot;http://www.thymeleaf.org&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>出错了<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>出错了，请联系管理员！<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;e&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/%E8%87%AA%E5%AE%9A%E4%B9%89%E7%9A%84%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E5%99%A8.png" alt="自定义的异常处理器"></p>
<h3 id="3-2-注解方式"><a href="#3-2-注解方式" class="headerlink" title="3.2 注解方式"></a>3.2 注解方式</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ControllerAdvice</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ExceptionController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExceptionHandler</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">tip</span><span class="params">(Exception e, Model model)</span>&#123;</span><br><span class="line">        model.addAttribute(<span class="string">&quot;e&quot;</span>, e);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;tip&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="第10章-拦截器"><a href="#第10章-拦截器" class="headerlink" title="第10章 拦截器"></a>第10章 拦截器</h1><h2 id="1-拦截器概述"><a href="#1-拦截器概述" class="headerlink" title="1. 拦截器概述"></a>1. 拦截器概述</h2><p><strong>拦截器（Interceptor）类似于过滤器（Filter）</strong></p>
<p>Spring MVC的拦截器作用是在请求到达控制器之前或之后进行拦截，可以对请求和响应进行一些特定的处理。</p>
<p>拦截器可以用于很多场景下：</p>
<ul>
<li>登录验证：对于需要登录才能访问的网址，使用拦截器可以判断用户是否已登录，如果未登录则跳转到登录页面。 </li>
<li>权限校验：根据用户权限对部分网址进行访问控制，拒绝未经授权的用户访问。 </li>
<li>请求日志：记录请求信息，例如请求地址、请求参数、请求时间等，用于排查问题和性能优化。 </li>
<li>更改响应：可以对响应的内容进行修改，例如添加头信息、调整响应内容格式等。</li>
</ul>
<p>拦截器和过滤器的区别在于它们的作用层面不同。</p>
<ul>
<li>过滤器更注重在请求和响应的流程中进行处理，可以修改请求和响应的内容，例如设置编码和字符集、请求头、状态码等。</li>
<li>拦截器则更加侧重于对控制器进行前置或后置处理，在请求到达控制器之前或之后进行特定的操作，例如打印日志、权限验证等。</li>
</ul>
<p><strong>Filter、Servlet、Interceptor、Controller的执行顺序：</strong></p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/Filter%E3%80%81Servlet%E3%80%81Interceptor%E3%80%81Controller%E7%9A%84%E6%89%A7%E8%A1%8C%E9%A1%BA%E5%BA%8F.png" alt="Filter、Servlet、Interceptor、Controller的执行顺序"></p>
<h2 id="2-拦截器的创建与基本配置"><a href="#2-拦截器的创建与基本配置" class="headerlink" title="2. 拦截器的创建与基本配置"></a>2. 拦截器的创建与基本配置</h2><h3 id="2-1-定义拦截器"><a href="#2-1-定义拦截器" class="headerlink" title="2.1 定义拦截器"></a>2.1 定义拦截器</h3><p>实现 <code>org.springframework.web.servlet.HandlerInterceptor</code> 接口，共有三个方法可以进行选择性的实现：</p>
<ul>
<li>preHandle：处理器方法调用之前执行<font color="red"><strong>（只有该方法有返回值，返回值是布尔类型，true放行，false拦截。）</strong></font></li>
<li>postHandle：处理器方法调用之后执行</li>
<li>afterCompletion：渲染完成后执行</li>
</ul>
<h3 id="2-2-拦截器基本配置"><a href="#2-2-拦截器基本配置" class="headerlink" title="2.2 拦截器基本配置"></a>2.2 拦截器基本配置</h3><p>在springmvc.xml文件中进行如下配置：</p>
<p>第一种方式：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mvc:interceptors</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;com.muyoukule.interceptors.Interceptor1&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mvc:interceptors</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>第二种方式：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mvc:interceptors</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">&quot;interceptor1&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mvc:interceptors</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>第二种方式的前提：</p>
<ul>
<li>前提1：包扫描</li>
</ul>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/%E6%8B%A6%E6%88%AA%E5%99%A8%E5%9F%BA%E6%9C%AC%E9%85%8D%E7%BD%AE%E5%89%8D%E6%8F%901.png" alt="拦截器基本配置前提1"></p>
<ul>
<li>前提2：使用 <code>@Component</code> 注解进行标注</li>
</ul>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/%E6%8B%A6%E6%88%AA%E5%99%A8%E5%9F%BA%E6%9C%AC%E9%85%8D%E7%BD%AE%E5%89%8D%E6%8F%902.png" alt="拦截器基本配置前提1"></p>
<p><font color="red"><strong>PS：对于这种基本配置来说，拦截器是拦截所有请求的。</strong></font></p>
<h3 id="2-3-拦截器部分源码分析"><a href="#2-3-拦截器部分源码分析" class="headerlink" title="2.3 拦截器部分源码分析"></a>2.3 拦截器部分源码分析</h3><h4 id="2-3-1-方法执行顺序的源码分析"><a href="#2-3-1-方法执行顺序的源码分析" class="headerlink" title="2.3.1 方法执行顺序的源码分析"></a>2.3.1 方法执行顺序的源码分析</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DispatcherServlet</span> <span class="keyword">extends</span> <span class="title class_">FrameworkServlet</span> &#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doDispatch</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 调用所有拦截器的 preHandle 方法</span></span><br><span class="line">        <span class="keyword">if</span> (!mappedHandler.applyPreHandle(processedRequest, response)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 调用处理器方法</span></span><br><span class="line">        mv = ha.handle(processedRequest, response, mappedHandler.getHandler());</span><br><span class="line">        <span class="comment">// 调用所有拦截器的 postHandle 方法</span></span><br><span class="line">        mappedHandler.applyPostHandle(processedRequest, response, mv);</span><br><span class="line">        <span class="comment">// 处理视图</span></span><br><span class="line">        processDispatchResult(processedRequest, response, mappedHandler, mv, dispatchException);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">processDispatchResult</span><span class="params">(HttpServletRequest request, HttpServletResponse response,</span></span><br><span class="line"><span class="params">			<span class="meta">@Nullable</span> HandlerExecutionChain mappedHandler, <span class="meta">@Nullable</span> ModelAndView mv,</span></span><br><span class="line"><span class="params">			<span class="meta">@Nullable</span> Exception exception)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 渲染页面</span></span><br><span class="line">        render(mv, request, response);</span><br><span class="line">        <span class="comment">// 调用所有拦截器的 afterCompletion 方法</span></span><br><span class="line">        mappedHandler.triggerAfterCompletion(request, response, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-3-2-拦截与放行的源码分析"><a href="#2-3-2-拦截与放行的源码分析" class="headerlink" title="2.3.2 拦截与放行的源码分析"></a>2.3.2 拦截与放行的源码分析</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DispatcherServlet</span> <span class="keyword">extends</span> <span class="title class_">FrameworkServlet</span> &#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doDispatch</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 调用所有拦截器的 preHandle 方法</span></span><br><span class="line">        <span class="keyword">if</span> (!mappedHandler.applyPreHandle(processedRequest, response)) &#123;</span><br><span class="line">            <span class="comment">// 如果 mappedHandler.applyPreHandle(processedRequest, response) 返回false，以下的return语句就会执行</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HandlerExecutionChain</span> &#123;</span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">applyPreHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		<span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="built_in">this</span>.interceptorList.size(); i++) &#123;</span><br><span class="line">			<span class="type">HandlerInterceptor</span> <span class="variable">interceptor</span> <span class="operator">=</span> <span class="built_in">this</span>.interceptorList.get(i);</span><br><span class="line">			<span class="keyword">if</span> (!interceptor.preHandle(request, response, <span class="built_in">this</span>.handler)) &#123;</span><br><span class="line">				triggerAfterCompletion(request, response, <span class="literal">null</span>);</span><br><span class="line">                <span class="comment">// 如果 interceptor.preHandle(request, response, this.handler) 返回 false，以下的 return false;就会执行。</span></span><br><span class="line">				<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="built_in">this</span>.interceptorIndex = i;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-拦截器的高级配置"><a href="#3-拦截器的高级配置" class="headerlink" title="3. 拦截器的高级配置"></a>3. 拦截器的高级配置</h2><p>采用以上基本配置方式，拦截器是拦截所有请求路径的。如果要针对某些路径进行拦截，某些路径不拦截，可以采用高级配置：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mvc:interceptors</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mvc:interceptor</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--拦截所有路径--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mvc:mapping</span> <span class="attr">path</span>=<span class="string">&quot;/**&quot;</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--除 /test 路径之外--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mvc:exclude-mapping</span> <span class="attr">path</span>=<span class="string">&quot;/test&quot;</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--拦截器--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">&quot;interceptor1&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mvc:interceptor</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mvc:interceptors</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>以上的配置表示，除 <code>/test</code> 请求路径之外，剩下的路径全部拦截。</p>
<h2 id="4-拦截器的执行顺序"><a href="#4-拦截器的执行顺序" class="headerlink" title="4. 拦截器的执行顺序"></a>4. 拦截器的执行顺序</h2><h3 id="4-1-执行顺序"><a href="#4-1-执行顺序" class="headerlink" title="4.1 执行顺序"></a>4.1 执行顺序</h3><h4 id="4-1-1-如果所有拦截器preHandle都返回true"><a href="#4-1-1-如果所有拦截器preHandle都返回true" class="headerlink" title="4.1.1 如果所有拦截器preHandle都返回true"></a>4.1.1 如果所有拦截器preHandle都返回true</h4><p>按照springmvc.xml文件中配置的顺序，自上而下调用 preHandle：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mvc:interceptors</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">&quot;interceptor1&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">&quot;interceptor2&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mvc:interceptors</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>执行顺序：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/%E6%89%80%E6%9C%89%E6%8B%A6%E6%88%AA%E5%99%A8preHandle%E9%83%BD%E8%BF%94%E5%9B%9Etrue%E6%89%A7%E8%A1%8C%E9%A1%BA%E5%BA%8F.png" alt="所有拦截器preHandle都返回true执行顺序"></p>
<h4 id="4-1-2-如果其中一个拦截器preHandle返回false"><a href="#4-1-2-如果其中一个拦截器preHandle返回false" class="headerlink" title="4.1.2 如果其中一个拦截器preHandle返回false"></a>4.1.2 如果其中一个拦截器preHandle返回false</h4><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mvc:interceptors</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">&quot;interceptor1&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">&quot;interceptor2&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mvc:interceptors</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>如果<code>interceptor2</code>的<code>preHandle</code>返回<code>false</code>，执行顺序：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/%E5%85%B6%E4%B8%AD%E4%B8%80%E4%B8%AA%E6%8B%A6%E6%88%AA%E5%99%A8preHandle%E8%BF%94%E5%9B%9Efalse%E6%89%A7%E8%A1%8C%E9%A1%BA%E5%BA%8F.png" alt="其中一个拦截器preHandle返回false执行顺序"></p>
<p>规则：只要有一个拦截器<code>preHandle</code>返回<code>false</code>，任何<code>postHandle</code>都不执行。但返回<code>false</code>的拦截器的<strong>前面</strong>的拦截器按照<strong>逆序</strong>执行<code>afterCompletion</code>。</p>
<h3 id="4-2-源码分析"><a href="#4-2-源码分析" class="headerlink" title="4.2 源码分析"></a>4.2 源码分析</h3><p><code>DispatcherServlet</code> 和 <code>HandlerExecutionChain</code> 的部分源码：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DispatcherServlet</span> <span class="keyword">extends</span> <span class="title class_">FrameworkServlet</span> &#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doDispatch</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 按照顺序执行所有拦截器的preHandle方法</span></span><br><span class="line">        <span class="keyword">if</span> (!mappedHandler.applyPreHandle(processedRequest, response)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 执行处理器方法</span></span><br><span class="line">        mv = ha.handle(processedRequest, response, mappedHandler.getHandler());</span><br><span class="line">        <span class="comment">// 按照逆序执行所有拦截器的 postHanle 方法</span></span><br><span class="line">        mappedHandler.applyPostHandle(processedRequest, response, mv);</span><br><span class="line">        <span class="comment">// 处理视图</span></span><br><span class="line">        processDispatchResult(processedRequest, response, mappedHandler, mv, dispatchException);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">processDispatchResult</span><span class="params">(HttpServletRequest request, HttpServletResponse response,</span></span><br><span class="line"><span class="params">			<span class="meta">@Nullable</span> HandlerExecutionChain mappedHandler, <span class="meta">@Nullable</span> ModelAndView mv,</span></span><br><span class="line"><span class="params">			<span class="meta">@Nullable</span> Exception exception)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 渲染视图</span></span><br><span class="line">        render(mv, request, response);</span><br><span class="line">        <span class="comment">// 按照逆序执行所有拦截器的 afterCompletion 方法</span></span><br><span class="line">        mappedHandler.triggerAfterCompletion(request, response, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HandlerExecutionChain</span> &#123;</span><br><span class="line">    <span class="comment">// 顺序执行 preHandle</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">applyPreHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="built_in">this</span>.interceptorList.size(); i++) &#123;</span><br><span class="line">            <span class="type">HandlerInterceptor</span> <span class="variable">interceptor</span> <span class="operator">=</span> <span class="built_in">this</span>.interceptorList.get(i);</span><br><span class="line">            <span class="keyword">if</span> (!interceptor.preHandle(request, response, <span class="built_in">this</span>.handler)) &#123;</span><br><span class="line">                <span class="comment">// 如果其中一个拦截器preHandle返回false</span></span><br><span class="line">                <span class="comment">// 将该拦截器前面的拦截器按照逆序执行所有的afterCompletion</span></span><br><span class="line">                triggerAfterCompletion(request, response, <span class="literal">null</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">this</span>.interceptorIndex = i;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">// 逆序执行 postHanle</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">applyPostHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, <span class="meta">@Nullable</span> ModelAndView mv)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="built_in">this</span>.interceptorList.size() - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">            <span class="type">HandlerInterceptor</span> <span class="variable">interceptor</span> <span class="operator">=</span> <span class="built_in">this</span>.interceptorList.get(i);</span><br><span class="line">            interceptor.postHandle(request, response, <span class="built_in">this</span>.handler, mv);</span><br><span class="line">        &#125;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">// 逆序执行 afterCompletion</span></span><br><span class="line">	<span class="keyword">void</span> <span class="title function_">triggerAfterCompletion</span><span class="params">(HttpServletRequest request, HttpServletResponse response, <span class="meta">@Nullable</span> Exception ex)</span> &#123;</span><br><span class="line">		<span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="built_in">this</span>.interceptorIndex; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">			<span class="type">HandlerInterceptor</span> <span class="variable">interceptor</span> <span class="operator">=</span> <span class="built_in">this</span>.interceptorList.get(i);</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				interceptor.afterCompletion(request, response, <span class="built_in">this</span>.handler, ex);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">catch</span> (Throwable ex2) &#123;</span><br><span class="line">				logger.error(<span class="string">&quot;HandlerInterceptor.afterCompletion threw exception&quot;</span>, ex2);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Java</category>
        <category>SSM</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>Spring</tag>
        <tag>SpringMVC</tag>
      </tags>
  </entry>
  <entry>
    <title>【第7章】 HttpMessageConverter</title>
    <url>/posts/44071/</url>
    <content><![CDATA[<p>参考视频：<a href="https://www.bilibili.com/video/BV1sC411L76f/">SpringMVC教程，SpringMVC从零到精通，老杜SpringMVC，动力节点SpringMVC</a></p>
<h1 id="1-HttpMessageConverter"><a href="#1-HttpMessageConverter" class="headerlink" title="1. HttpMessageConverter"></a>1. HttpMessageConverter</h1><p>HttpMessageConverter是Spring MVC中非常重要的一个接口。翻译为：HTTP消息转换器。该接口下提供了很多实现类，不同的实现类有不同的转换方式。</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/HttpMessageConverter%E7%9A%84%E5%AE%9E%E7%8E%B0%E7%B1%BB.png" alt="HttpMessageConverter的实现类" style="zoom: 67%;">

<h2 id="1-1-什么是HTTP消息"><a href="#1-1-什么是HTTP消息" class="headerlink" title="1.1 什么是HTTP消息"></a>1.1 什么是HTTP消息</h2><p>HTTP消息其实就是HTTP协议。HTTP协议包括请求协议和响应协议。</p>
<p>以下是一份HTTP POST请求协议：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">POST /springmvc/user/login HTTP/1.1																												--请求行</span><br><span class="line">Content-Type: application/x-www-form-urlencoded																						--请求头</span><br><span class="line">Content-Length: 32</span><br><span class="line">Host: www.example.com</span><br><span class="line">User-Agent: Mozilla/5.0</span><br><span class="line">Connection: Keep-Alive</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span><br><span class="line">                                                                                          --空白行</span><br><span class="line">username=admin&amp;password=1234																															--请求体</span><br></pre></td></tr></table></figure>
<p>以下是一份HTTP GET请求协议：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET /springmvc/user/del?id=1&amp;name=zhangsan HTTP/1.1																				--请求行</span><br><span class="line">Host: www.example.com																																			--请求头</span><br><span class="line">User-Agent: Mozilla/5.0</span><br><span class="line">Connection: Keep-Alive</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span><br></pre></td></tr></table></figure>
<p>以下是一份HTTP响应协议：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">HTTP/1.1 200 OK																																					--状态行</span><br><span class="line">Date: Thu, 01 Jul 2021 06:35:45 GMT																											--响应头</span><br><span class="line">Content-Type: text/plain; charset=utf-8</span><br><span class="line">Content-Length: 12</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Server: Apache/2.4.43 (Win64) OpenSSL/1.1.1g</span><br><span class="line">                                                                                        --空白行</span><br><span class="line">&lt;!DOCTYPE html&gt;																																					--响应体</span><br><span class="line">&lt;html&gt;</span><br><span class="line">  &lt;head&gt;</span><br><span class="line">    &lt;title&gt;hello&lt;/title&gt;</span><br><span class="line">  &lt;/head&gt;</span><br><span class="line">  &lt;body&gt;</span><br><span class="line">    &lt;h1&gt;Hello World!&lt;/h1&gt;</span><br><span class="line">  &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<h2 id="1-2-转换器转换的是什么"><a href="#1-2-转换器转换的是什么" class="headerlink" title="1.2 转换器转换的是什么"></a>1.2 转换器转换的是什么</h2><p>转换的是<code>HTTP协议</code>与<code>Java程序中的对象</code>之间的互相转换。请看下图：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/FormHttpMessageConverter%E8%B4%9F%E8%B4%A3%E5%B0%86%E8%AF%B7%E6%B1%82%E5%8D%8F%E8%AE%AE%E8%BD%AC%E6%8D%A2%E4%B8%BAJava%E5%AF%B9%E8%B1%A1.png" alt="FormHttpMessageConverter负责将请求协议转换为Java对象" style="zoom: 80%;">

<p>上图是我们之前经常写的代码。请求体中的数据是如何转换成user对象的，底层实际上使用了<code>HttpMessageConverter</code>接口的其中一个实现类<code>FormHttpMessageConverter</code>。</p>
<p>通过上图可以看出<code>FormHttpMessageConverter</code>是负责将<code>请求协议</code>转换为<code>Java对象</code>的。</p>
<p>再看下图：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/StringHttpMessageConverter%E8%B4%9F%E8%B4%A3%E5%B0%86Java%E5%AF%B9%E8%B1%A1%E8%BD%AC%E6%8D%A2%E4%B8%BA%E5%93%8D%E5%BA%94%E5%8D%8F%E8%AE%AE.png" alt="StringHttpMessageConverter负责将Java对象转换为响应协议">
上图的代码也是之前我们经常写的，Controller返回值看做逻辑视图名称，视图解析器将其转换成物理视图名称，生成视图对象，`StringHttpMessageConverter`负责将视图对象中的HTML字符串写入到HTTP协议的响应体中。最终完成响应。

<p>通过上图可以看出<code>StringHttpMessageConverter</code>是负责将<code>Java对象</code>转换为<code>响应协议</code>的。</p>
<p>通过以上内容的学习，大家应该能够了解到<code>HttpMessageConverter</code>接口是用来做什么的了：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/HttpMessageConverter%E6%8E%A5%E5%8F%A3%E4%BD%9C%E7%94%A8.png" alt="HttpMessageConverter接口作用"></p>
<p>如上图所示：<code>HttpMessageConverter</code>接口的可以将请求协议转换成Java对象，也可以把Java对象转换为响应协议。</p>
<p><strong>HttpMessageConverter是接口，SpringMVC帮我们提供了非常多而丰富的实现类。每个实现类都有自己不同的转换风格。</strong></p>
<p><strong>对于我们程序员来说，Spring MVC已经帮助我们写好了，我们只需要在不同的业务场景下，选择合适的HTTP消息转换器即可。</strong></p>
<p><strong>怎么选择呢？当然是通过SpringMVC为我们提供的注解，我们通过使用不同的注解来启用不同的消息转换器。</strong></p>
<p>在HTTP消息转换器这一小节，我们重点要掌握的是两个注解两个类：</p>
<ul>
<li>@ResponseBody</li>
<li>@RequestBody</li>
<li>ResponseEntity</li>
<li>RequestEntity</li>
</ul>
<h1 id="2-Spring-MVC中的AJAX请求"><a href="#2-Spring-MVC中的AJAX请求" class="headerlink" title="2. Spring MVC中的AJAX请求"></a>2. Spring MVC中的AJAX请求</h1><p>SpringMVC+Vue3+Thymeleaf+Axios发送一个简单的AJAX请求。</p>
<p>1、引入Vue和Axios的js文件：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/%E5%BC%95%E5%85%A5Vue%E5%92%8CAxios%E7%9A%84js%E6%96%87%E4%BB%B6.png" alt="引入Vue和Axios的js文件"></p>
<p>2、springmvc.xml</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:mvc</span>=<span class="string">&quot;http://www.springframework.org/schema/mvc&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/context https://www.springframework.org/schema/context/spring-context.xsd http://www.springframework.org/schema/mvc https://www.springframework.org/schema/mvc/spring-mvc.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--组件扫描--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">&quot;com.muyoukule.controller&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--视图解析器--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;thymeleafViewResolver&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.thymeleaf.spring6.view.ThymeleafViewResolver&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;characterEncoding&quot;</span> <span class="attr">value</span>=<span class="string">&quot;UTF-8&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;order&quot;</span> <span class="attr">value</span>=<span class="string">&quot;1&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;templateEngine&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;org.thymeleaf.spring6.SpringTemplateEngine&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;templateResolver&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;org.thymeleaf.spring6.templateresolver.SpringResourceTemplateResolver&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;prefix&quot;</span> <span class="attr">value</span>=<span class="string">&quot;/WEB-INF/thymeleaf/&quot;</span>/&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;suffix&quot;</span> <span class="attr">value</span>=<span class="string">&quot;.html&quot;</span>/&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;templateMode&quot;</span> <span class="attr">value</span>=<span class="string">&quot;HTML&quot;</span>/&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;characterEncoding&quot;</span> <span class="attr">value</span>=<span class="string">&quot;UTF-8&quot;</span>/&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--视图控制器映射--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mvc:view-controller</span> <span class="attr">path</span>=<span class="string">&quot;/&quot;</span> <span class="attr">view-name</span>=<span class="string">&quot;index&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--开启注解驱动--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mvc:annotation-driven</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--静态资源处理--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mvc:default-servlet-handler</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>重点是静态资源处理、开启注解驱动、视图控制器映射等相关配置。</p>
<p>3、index.html:</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span> <span class="attr">xmlns:th</span>=<span class="string">&quot;http://www.thymeleaf.org&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>首页<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">th:src</span>=<span class="string">&quot;@&#123;/static/js/vue3.4.21.js&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">th:src</span>=<span class="string">&quot;@&#123;/static/js/axios.min.js&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>首页<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">hr</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;app&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>&#123;&#123;message&#125;&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;getMessage&quot;</span>&gt;</span>获取消息<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">th:inline</span>=<span class="string">&quot;javascript&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="title class_">Vue</span>.<span class="title function_">createApp</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">data</span>(<span class="params"></span>)&#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                message : <span class="string">&quot;这里的信息将被刷新&quot;</span></span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">        &#125;,</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">methods</span>:&#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">async</span> <span class="title function_">getMessage</span>(<span class="params"></span>)&#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">try</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">const</span> response = <span class="keyword">await</span> axios.<span class="title function_">get</span>([[@&#123;/&#125;]] + <span class="string">&#x27;hello&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript">                    <span class="variable language_">this</span>.<span class="property">message</span> = response.<span class="property">data</span></span></span><br><span class="line"><span class="language-javascript">                &#125;<span class="keyword">catch</span> (e) &#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="variable language_">console</span>.<span class="title function_">error</span>(e)</span></span><br><span class="line"><span class="language-javascript">                &#125;</span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">    &#125;).<span class="title function_">mount</span>(<span class="string">&quot;#app&quot;</span>)</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>重点来了，Controller怎么写呢，之前我们都是传统的请求，Controller返回一个<code>逻辑视图名</code>，然后交给<code>视图解析器</code>解析。最后跳转页面。而AJAX请求是不需要跳转页面的，因为AJAX是页面局部刷新，以前我们在Servlet中使用<code>response.getWriter().print(&quot;message&quot;)</code>的方式响应。</strong></p>
<p><strong>在Spring MVC中怎么办呢？当然，我们在Spring MVC中也可以使用Servlet原生API来完成这个功能</strong></p>
<p>4、代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/hello&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">(HttpServletResponse response)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        response.getWriter().print(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>或者这样也行：不需要有返回值</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/hello&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">hello</span><span class="params">(HttpServletResponse response)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        response.getWriter().print(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>5、启动服务器测试：<a href="http://localhost:8080/springmvc/">http://localhost:8080/springmvc/</a></p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/%E6%B5%8B%E8%AF%95%E5%8F%91%E9%80%81AJAX%E8%AF%B7%E6%B1%82.png" alt="测试发送AJAX请求" style="zoom: 67%;">

<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/%E5%8F%91%E9%80%81AJAX%E8%AF%B7%E6%B1%82%E6%88%90%E5%8A%9F.png" alt="发送AJAX请求成功" style="zoom:67%;">

<p><font color="red"><strong>PS：如果采用这种方式响应，则和 springmvc.xml 文件中配置的视图解析器没有关系，不走视图解析器了。</strong></font></p>
<p>难道我们以后AJAX请求都要使用原生Servlet API吗？</p>
<p>不需要，我们可以使用SpringMVC中提供的<code>HttpMessageConverter</code>消息转换器。</p>
<p>我们要向前端响应一个字符串”hello”，这个”hello”就是响应协议中的响应体。</p>
<p>我们可以使用 <code>@ResponseBody</code> 注解来启用对应的消息转换器。而这种消息转换器只负责将Controller返回的信息以响应体的形式写入响应协议。</p>
<h1 id="3-ResponseBody"><a href="#3-ResponseBody" class="headerlink" title="3. @ResponseBody"></a>3. @ResponseBody</h1><h2 id="3-1-StringHttpMessageConverter"><a href="#3-1-StringHttpMessageConverter" class="headerlink" title="3.1 StringHttpMessageConverter"></a>3.1 StringHttpMessageConverter</h2><p>上面的AJAX案例，Controller的代码可以修改为：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/hello&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 由于你使用了 @ResponseBody 注解</span></span><br><span class="line">        <span class="comment">// 以下的return语句返回的字符串则不再是“逻辑视图名”了</span></span><br><span class="line">        <span class="comment">// 而是作为响应协议的响应体进行响应。</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;hello&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最核心需要理解的位置是：<code>return &quot;hello&quot;</code>，这里的”hello”不是逻辑视图名了，而是作为响应体的内容进行响应。直接输出到浏览器客户端。</p>
<p>以上程序中添加<code>@ResponseBody</code>这个注解，使用的消息转换器是：<code>StringHttpMessageConverter</code>。</p>
<p>通常AJAX请求需要服务器给返回一段JSON格式的字符串，可以返回JSON格式的字符串吗？当然可以。</p>
<p>代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/hello&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&#123;\&quot;username\&quot;:\&quot;zhangsan\&quot;,\&quot;password\&quot;:\&quot;1234\&quot;&#125;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/%E6%B5%8B%E8%AF%95AJAX%E8%AF%B7%E6%B1%82%E9%9C%80%E8%A6%81%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%BF%94%E5%9B%9EJSON%E6%A0%BC%E5%BC%8F%E5%AD%97%E7%AC%A6%E4%B8%B2.png" alt="测试AJAX请求需要服务器返回JSON格式字符串" style="zoom:67%;">

<p>这是完全可以的，此时底层使用的消息转换器还是：<code>StringHttpMessageConverter</code></p>
<blockquote>
<p>如果在程序中是一个POJO对象，怎么将POJO对象以JSON格式的字符串响应给浏览器呢？</p>
</blockquote>
<p>两种方式：</p>
<ul>
<li>自己写代码将POJO对象转换成JSON格式的字符串，用上面的方式直接return即可。</li>
<li>启用<code>MappingJackson2HttpMessageConverter</code>消息转换器。</li>
</ul>
<h2 id="3-2-MappingJackson2HttpMessageConverter"><a href="#3-2-MappingJackson2HttpMessageConverter" class="headerlink" title="3.2 MappingJackson2HttpMessageConverter"></a>3.2 MappingJackson2HttpMessageConverter</h2><p>启用<code>MappingJackson2HttpMessageConverter</code>消息转换器的步骤如下：</p>
<p>1、引入jackson依赖，可以将java对象转换为json格式字符串</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-databind<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.17.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>2、开启注解驱动</p>
<p>这一步非常关键，开启注解驱动后，在<code>HandlerAdapter</code>中会自动装配一个消息转换器：<code>MappingJackson2HttpMessageConverter</code></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mvc:annotation-driven</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>3、准备一个POJO（使用Lombok简化）</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>4、控制器方法使用<font color="red"> <strong><code>@ResponseBody</code> 注解标注！！！</strong></font>控制器方法返回这个POJO对象</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/hello&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">hello</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;zhangsan&quot;</span>, <span class="string">&quot;22222&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>5、测试：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/%E6%B5%8B%E8%AF%95@RestController%E6%B3%A8%E8%A7%A3.png" alt="测试MappingJackson2HttpMessageConverter消息转换器" style="zoom: 50%;">

<p>以上代码底层启用的就是 <code>MappingJackson2HttpMessageConverter</code> 消息转换器。</p>
<p>他的功能很强大，可以将POJO对象转换成JSON格式的字符串，响应给前端。</p>
<p>其实这个消息转换器<code>MappingJackson2HttpMessageConverter</code>本质上只是比<code>StringHttpMessageConverter</code>多了一个json字符串的转换，其他的还是一样。</p>
<h1 id="4-RestController"><a href="#4-RestController" class="headerlink" title="4. @RestController"></a>4. @RestController</h1><p>因为我们现代的开发方式都是基于AJAX方式的，因此 <code>@ResponseBody</code> 注解非常重要，很常用。</p>
<p>为了方便，Spring MVC中提供了一个注解 <code>@RestController</code>。这一个注解代表了：<code>@Controller</code> + <code>@ResponseBody</code></p>
<p><code>@RestController</code> 标注在类上即可。被它标注的Controller中所有的方法上都会自动标注 <code>@ResponseBody</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/hello&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">hello</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;zhangsan&quot;</span>, <span class="string">&quot;22222&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/%E6%B5%8B%E8%AF%95@RestController%E6%B3%A8%E8%A7%A3.png" alt="测试@RestController注解" style="zoom:50%;">

<h1 id="5-RequestBody"><a href="#5-RequestBody" class="headerlink" title="5. @RequestBody"></a>5. @RequestBody</h1><h2 id="5-1-FormHttpMessageConverter"><a href="#5-1-FormHttpMessageConverter" class="headerlink" title="5.1 FormHttpMessageConverter"></a>5.1 FormHttpMessageConverter</h2><p>这个注解的作用是直接将请求体传递给Java程序，在Java程序中可以直接使用一个String类型的变量接收这个请求体的内容。</p>
<p>在没有使用这个注解的时候：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/save&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">save</span><span class="params">(User user)</span>&#123;</span><br><span class="line">    <span class="comment">// 执行保存的业务逻辑</span></span><br><span class="line">    userDao.save(user);</span><br><span class="line">    <span class="comment">// 保存成功跳转到成功页面</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当请求体提交的数据是：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">username=zhangsan&amp;password=1234&amp;email=zhangsan@example.com</span><br></pre></td></tr></table></figure>
<p>那么Spring MVC会自动使用 <code>FormHttpMessageConverter</code>消息转换器，将请求体转换成user对象。</p>
<p>当使用这个注解的时候：<font color="red"><strong>这个注解只能出现在方法的参数上。</strong></font></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/save&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">save</span><span class="params">(<span class="meta">@RequestBody</span> String requestBodyStr)</span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;请求体：&quot;</span> + requestBodyStr);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Spring MVC仍然会使用 <code>FormHttpMessageConverter</code>消息转换器，将请求体直接以字符串形式传递给 requestBodyStr 变量。</p>
<p>测试输出结果：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">请求体：username=zhangsan&amp;password=1234&amp;email=zhangsan@example.com</span><br></pre></td></tr></table></figure>

<h2 id="5-2-MappingJackson2HttpMessageConverter"><a href="#5-2-MappingJackson2HttpMessageConverter" class="headerlink" title="5.2 MappingJackson2HttpMessageConverter"></a>5.2 MappingJackson2HttpMessageConverter</h2><p>另外，如果在请求体中提交的是一个JSON格式的字符串，这个JSON字符串传递给Spring MVC之后，能不能将JSON字符串转换成POJO对象呢？答案是可以的。</p>
<p>此时必须使用 <code>@RequestBody</code> 注解来完成 。并且底层使用的消息转换器是：<code>MappingJackson2HttpMessageConverter</code>。</p>
<blockquote>
<p>JSON字符串转换成POJO对象实现步骤</p>
</blockquote>
<p>1、引入jackson依赖</p>
<p>2、开启注解驱动</p>
<p>3、创建POJO类，将POJO类作为控制器方法的参数，并使用 @RequestBody 注解标注该参数</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/send&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">send</span><span class="params">(<span class="meta">@RequestBody</span> User user)</span> &#123;</span><br><span class="line">    System.out.println(user);</span><br><span class="line">    System.out.println(user.getUsername());</span><br><span class="line">    System.out.println(user.getPassword());</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>4、在请求体中提交json格式的数据</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span> <span class="attr">xmlns:th</span>=<span class="string">&quot;http://www.thymeleaf.org&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>首页<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">th:src</span>=<span class="string">&quot;@&#123;/static/js/vue3.4.21.js&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">th:src</span>=<span class="string">&quot;@&#123;/static/js/axios.min.js&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>首页<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">hr</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;app&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;sendJSON&quot;</span>&gt;</span>通过POST请求发送JSON给服务器<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>&#123;&#123;message&#125;&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">th:inline</span>=<span class="string">&quot;javascript&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">let</span> jsonObj = &#123;<span class="string">&quot;username&quot;</span>: <span class="string">&quot;zhangsan&quot;</span>, <span class="string">&quot;password&quot;</span>: <span class="string">&quot;1234&quot;</span>&#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="title class_">Vue</span>.<span class="title function_">createApp</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">data</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">message</span>: <span class="string">&quot;&quot;</span></span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">        &#125;,</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">methods</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">async</span> <span class="title function_">sendJSON</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;sendjson&quot;</span>)</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">try</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">const</span> res = <span class="keyword">await</span> axios.<span class="title function_">post</span>(<span class="string">&#x27;/springmvc/send&#x27;</span>, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(jsonObj), &#123;</span></span><br><span class="line"><span class="language-javascript">                        <span class="attr">headers</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">                            <span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;application/json&quot;</span></span></span><br><span class="line"><span class="language-javascript">                        &#125;</span></span><br><span class="line"><span class="language-javascript">                    &#125;)</span></span><br><span class="line"><span class="language-javascript">                    <span class="variable language_">this</span>.<span class="property">message</span> = res.<span class="property">data</span></span></span><br><span class="line"><span class="language-javascript">                &#125; <span class="keyword">catch</span> (e) &#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="variable language_">console</span>.<span class="title function_">error</span>(e)</span></span><br><span class="line"><span class="language-javascript">                &#125;</span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">    &#125;).<span class="title function_">mount</span>(<span class="string">&quot;#app&quot;</span>)</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>5、测试结果：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/%E6%B5%8B%E8%AF%95JSON%E5%AD%97%E7%AC%A6%E4%B8%B2%E8%BD%AC%E6%8D%A2%E6%88%90POJO%E5%AF%B9%E8%B1%A1.png" alt="测试JSON字符串转换成POJO对象" style="zoom:50%;">

<p>6、控制台打印：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">User(username=zhangsan, password=1234)</span><br><span class="line">zhangsan</span><br><span class="line">1234</span><br></pre></td></tr></table></figure>

<h1 id="6-RequestEntity"><a href="#6-RequestEntity" class="headerlink" title="6. RequestEntity"></a>6. RequestEntity</h1><p>RequestEntity不是一个注解，是一个普通的类。这个类的实例封装了整个请求协议：包括请求行、请求头、请求体所有信息。</p>
<p>出现在控制器方法的参数上：</p>
<p>1、index.html</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span> <span class="attr">xmlns:th</span>=<span class="string">&quot;http://www.thymeleaf.org&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>首页<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">th:src</span>=<span class="string">&quot;@&#123;/static/js/vue3.4.21.js&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">th:src</span>=<span class="string">&quot;@&#123;/static/js/axios.min.js&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>首页<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">hr</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;app&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;sendJSON&quot;</span>&gt;</span>通过POST请求发送JSON给服务器<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>&#123;&#123;message&#125;&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">th:inline</span>=<span class="string">&quot;javascript&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">let</span> jsonObj = &#123;<span class="string">&quot;username&quot;</span>: <span class="string">&quot;zhangsan&quot;</span>, <span class="string">&quot;password&quot;</span>: <span class="string">&quot;1234&quot;</span>&#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="title class_">Vue</span>.<span class="title function_">createApp</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">data</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">message</span>: <span class="string">&quot;&quot;</span></span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">        &#125;,</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">methods</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">async</span> <span class="title function_">sendJSON</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;sendjson&quot;</span>)</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">try</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">const</span> res = <span class="keyword">await</span> axios.<span class="title function_">post</span>(<span class="string">&#x27;/springmvc/send&#x27;</span>, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(jsonObj), &#123;</span></span><br><span class="line"><span class="language-javascript">                        <span class="attr">headers</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">                            <span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;application/json&quot;</span></span></span><br><span class="line"><span class="language-javascript">                        &#125;</span></span><br><span class="line"><span class="language-javascript">                    &#125;)</span></span><br><span class="line"><span class="language-javascript">                    <span class="variable language_">this</span>.<span class="property">message</span> = res.<span class="property">data</span></span></span><br><span class="line"><span class="language-javascript">                &#125; <span class="keyword">catch</span> (e) &#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="variable language_">console</span>.<span class="title function_">error</span>(e)</span></span><br><span class="line"><span class="language-javascript">                &#125;</span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">    &#125;).<span class="title function_">mount</span>(<span class="string">&quot;#app&quot;</span>)</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>2、编写Controller</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/send&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">send</span><span class="params">(RequestEntity&lt;User&gt; requestEntity)</span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;请求方式：&quot;</span> + requestEntity.getMethod());</span><br><span class="line">    System.out.println(<span class="string">&quot;请求URL：&quot;</span> + requestEntity.getUrl());</span><br><span class="line">    <span class="type">HttpHeaders</span> <span class="variable">headers</span> <span class="operator">=</span> requestEntity.getHeaders();</span><br><span class="line">    System.out.println(<span class="string">&quot;请求的内容类型：&quot;</span> + headers.getContentType());</span><br><span class="line">    System.out.println(<span class="string">&quot;请求头：&quot;</span> + headers);</span><br><span class="line"></span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> requestEntity.getBody();</span><br><span class="line">    System.out.println(user);</span><br><span class="line">    System.out.println(user.getUsername());</span><br><span class="line">    System.out.println(user.getPassword());</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>3、测试结果：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">请求方式：POST</span><br><span class="line">请求URL：http://localhost:8080/springmvc/send</span><br><span class="line">请求的内容类型：application/json;charset=UTF-8</span><br><span class="line">请求头：[host:&quot;localhost:8080&quot;, connection:&quot;keep-alive&quot;, content-length:&quot;41&quot;, sec-ch-ua:&quot;&quot;Microsoft Edge&quot;;v=&quot;123&quot;, &quot;Not:A-Brand&quot;;v=&quot;8&quot;, &quot;Chromium&quot;;v=&quot;123&quot;&quot;, accept:&quot;application/json, text/plain, */*&quot;, sec-ch-ua-mobile:&quot;?0&quot;, user-agent:&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/123.0.0.0 Safari/537.36 Edg/123.0.0.0&quot;, sec-ch-ua-platform:&quot;&quot;Windows&quot;&quot;, origin:&quot;http://localhost:8080&quot;, sec-fetch-site:&quot;same-origin&quot;, sec-fetch-mode:&quot;cors&quot;, sec-fetch-dest:&quot;empty&quot;, referer:&quot;http://localhost:8080/springmvc/&quot;, accept-encoding:&quot;gzip, deflate, br, zstd&quot;, accept-language:&quot;zh-CN,zh;q=0.9,en;q=0.8,en-GB;q=0.7,en-US;q=0.6&quot;, cookie:&quot;username-localhost-8888=&quot;2|1:0|10:1712017810|23:username-localhost-8888|192:eyJ1c2VybmFtZSI6ICIzNWI3MjhjZDkyMmI0OGFlYjM1OGYxMmY4NTFlZTMzNCIsICJuYW1lIjogIkFub255bW91cyBBb2VkZSIsICJkaXNwbGF5X25hbWUiOiAiQW5vbnltb3VzIEFvZWRlIiwgImluaXRpYWxzIjogIkFBIiwgImNvbG9yIjogbnVsbH0=|a447ec864609b4c8600bddfe5ddf9ca59ff01b60f92cdc6ee819d5fd84bf761d&quot;; _xsrf=2|810e7615|c7a87f219cbac7ee02d1fe7e6b6c093c|1712017810; id=123456789; Idea-fa2b739c=6fadb531-b45d-4f4b-9773-90a820641d74&quot;, Content-Type:&quot;application/json;charset=UTF-8&quot;]</span><br><span class="line">User(username=zhangsan, password=1234)</span><br><span class="line">zhangsan</span><br><span class="line">1234</span><br></pre></td></tr></table></figure>

<p>在实际的开发中，如果你需要获取更详细的请求协议中的信息。可以使用<code>RequestEntity</code></p>
<h1 id="7-ResponseEntity"><a href="#7-ResponseEntity" class="headerlink" title="7. ResponseEntity"></a>7. ResponseEntity</h1><p>ResponseEntity不是注解，是一个类。用该类的实例可以封装响应协议，包括：状态行、响应头、响应体。也就是说：如果你想定制属于自己的响应协议，可以使用该类。</p>
<p>假如我要完成这样一个需求：前端提交一个id，后端根据id进行查询，如果返回null，请在前端显示404错误。如果返回不是null，则输出返回的user。</p>
<p>1、编写UserService.java</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">getById</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (id == <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;zhangsan&quot;</span>, <span class="string">&quot;13234&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2、配置组件扫描</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--组件扫描--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">&quot;com.muyoukule.controller,com.muyoukule.service&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>3、在 index.html 添加超链接</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">th:href</span>=<span class="string">&quot;@&#123;/user/2&#125;&quot;</span>&gt;</span>查找id=1的用户信息<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>4、编写Controller</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserController</span> &#123;</span><br><span class="line">     </span><br><span class="line">    <span class="meta">@GetMapping(&quot;/users/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;User&gt; <span class="title function_">getUserById</span><span class="params">(<span class="meta">@PathVariable</span> Long id)</span> &#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userService.getUserById(id);</span><br><span class="line">        <span class="keyword">if</span> (user == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> ResponseEntity.status(HttpStatus.NOT_FOUND).body(<span class="literal">null</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> ResponseEntity.ok(user);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>5、测试：当用户不存在时</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/%E6%B5%8B%E8%AF%95%E5%BD%93%E7%94%A8%E6%88%B7%E4%B8%8D%E5%AD%98%E5%9C%A8%E6%97%B6.png" alt="测试当用户不存在时" style="zoom:50%;">

<p>6、测试：当用户存在时</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/%E6%B5%8B%E8%AF%95%E5%BD%93%E7%94%A8%E6%88%B7%E5%AD%98%E5%9C%A8%E6%97%B6.png" alt="测试当用户存在时"></p>
]]></content>
      <categories>
        <category>Java</category>
        <category>SSM</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>Spring</tag>
        <tag>SpringMVC</tag>
      </tags>
  </entry>
  <entry>
    <title>【第6章】 RESTFul编程风格</title>
    <url>/posts/26179/</url>
    <content><![CDATA[<p>参考视频：<a href="https://www.bilibili.com/video/BV1sC411L76f/">SpringMVC教程，SpringMVC从零到精通，老杜SpringMVC，动力节点SpringMVC</a></p>
<h1 id="1-RESTFul编程风格"><a href="#1-RESTFul编程风格" class="headerlink" title="1. RESTFul编程风格"></a>1. RESTFul编程风格</h1><h2 id="1-1-RESTFul是什么"><a href="#1-1-RESTFul是什么" class="headerlink" title="1.1 RESTFul是什么"></a>1.1 RESTFul是什么</h2><p>RESTFul是<code>WEB服务接口</code>的一种设计风格。</p>
<p>RESTFul定义了一组约束条件和规范，可以让<code>WEB服务接口</code>更加简洁、易于理解、易于扩展、安全可靠。</p>
<p>RESTFul对一个<code>WEB服务接口</code>都规定了哪些东西？</p>
<ul>
<li>对请求的URL格式有约束和规范</li>
<li>对HTTP的请求方式有约束和规范</li>
<li>对请求和响应的数据格式有约束和规范</li>
<li>对HTTP状态码有约束和规范</li>
<li>等 ……</li>
</ul>
<p>REST对请求方式的约束是这样的：</p>
<ul>
<li>查询必须发送GET请求</li>
<li>新增必须发送POST请求</li>
<li>修改必须发送PUT请求</li>
<li>删除必须发送DELETE请求</li>
</ul>
<p>REST对URL的约束是这样的：</p>
<ul>
<li><p>传统的URL：get请求，&#x2F;springmvc&#x2F;getUserById?id&#x3D;1</p>
</li>
<li><p>REST风格的URL：get请求，&#x2F;springmvc&#x2F;user&#x2F;1</p>
</li>
<li><p>传统的URL：get请求，&#x2F;springmvc&#x2F;deleteUserById?id&#x3D;1</p>
</li>
<li><p>REST风格的URL：delete请求, &#x2F;springmvc&#x2F;user&#x2F;1</p>
</li>
</ul>
<p>RESTFul对URL的约束和规范的核心是：<font color="red"><strong>通过采用</strong> <code>不同的请求方式</code> + <code>URL</code> <strong>来确定WEB服务中的资源。</strong></font></p>
<p><strong>RESTful 的英文全称是 Representational State Transfer（表述性状态转移）。简称REST。</strong></p>
<p>表述性（Representational）是：URI + 请求方式。</p>
<p>状态（State）是：服务器端的数据。</p>
<p>转移（Transfer）是：变化。</p>
<p>表述性状态转移是指：通过 URI + 请求方式 来控制服务器端数据的变化。</p>
<h2 id="1-2-RESTFul风格与传统方式对比"><a href="#1-2-RESTFul风格与传统方式对比" class="headerlink" title="1.2 RESTFul风格与传统方式对比"></a>1.2 RESTFul风格与传统方式对比</h2><p>传统的 URL 与 RESTful URL 的区别是传统的 URL 是基于方法名进行资源访问和操作，而 RESTful URL 是基于资源的结构和状态进行操作的。下面是一张表格，展示两者之间的具体区别：</p>
<table>
<thead>
<tr>
<th align="center">传统的 URL</th>
<th align="center">RESTful URL</th>
</tr>
</thead>
<tbody><tr>
<td align="center">GET &#x2F;getUserById?id&#x3D;1</td>
<td align="center">GET &#x2F;user&#x2F;1</td>
</tr>
<tr>
<td align="center">GET &#x2F;getAllUser</td>
<td align="center">GET &#x2F;user</td>
</tr>
<tr>
<td align="center">POST &#x2F;addUser</td>
<td align="center">POST &#x2F;user</td>
</tr>
<tr>
<td align="center">POST &#x2F;modifyUser</td>
<td align="center">PUT &#x2F;user</td>
</tr>
<tr>
<td align="center">GET &#x2F;deleteUserById?id&#x3D;1</td>
<td align="center">DELETE &#x2F;user&#x2F;1</td>
</tr>
</tbody></table>
<p>从上表中我们可以看出，传统的URL是基于动作的，而 RESTful URL 是基于资源和状态的，因此 RESTful URL 更加清晰和易于理解，这也是 REST 架构风格被广泛使用的主要原因之一。</p>
<h2 id="1-3-RESTFul方式演示查询"><a href="#1-3-RESTFul方式演示查询" class="headerlink" title="1.3 RESTFul方式演示查询"></a>1.3 RESTFul方式演示查询</h2><p>RESTFul规范中规定，如果要查询数据，需要发送GET请求。</p>
<h3 id="1-3-1-查询所有-GET-api-user"><a href="#1-3-1-查询所有-GET-api-user" class="headerlink" title="1.3.1 查询所有(GET &#x2F;api&#x2F;user)"></a>1.3.1 查询所有(GET &#x2F;api&#x2F;user)</h3><p>1、准备springmvc.xml文件</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span> <span class="attr">xmlns:mvc</span>=<span class="string">&quot;http://www.springframework.org/schema/mvc&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/mvc https://www.springframework.org/schema/mvc/spring-mvc.xsd http://www.springframework.org/schema/context https://www.springframework.org/schema/context/spring-context.xsd&quot;</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!--组件扫描--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">&quot;com.muyoukule.controller&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--视图解析器--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;thymeleafViewResolver&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.thymeleaf.spring6.view.ThymeleafViewResolver&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;characterEncoding&quot;</span> <span class="attr">value</span>=<span class="string">&quot;UTF-8&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;order&quot;</span> <span class="attr">value</span>=<span class="string">&quot;1&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;templateEngine&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;org.thymeleaf.spring6.SpringTemplateEngine&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;templateResolver&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;org.thymeleaf.spring6.templateresolver.SpringResourceTemplateResolver&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;prefix&quot;</span> <span class="attr">value</span>=<span class="string">&quot;/WEB-INF/thymeleaf/&quot;</span>/&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;suffix&quot;</span> <span class="attr">value</span>=<span class="string">&quot;.html&quot;</span>/&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;templateMode&quot;</span> <span class="attr">value</span>=<span class="string">&quot;HTML&quot;</span>/&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;characterEncoding&quot;</span> <span class="attr">value</span>=<span class="string">&quot;UTF-8&quot;</span>/&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--启用注解--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mvc:annotation-driven</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--视图控制器映射--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mvc:view-controller</span> <span class="attr">path</span>=<span class="string">&quot;/&quot;</span> <span class="attr">view-name</span>=<span class="string">&quot;index&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>2、准备首页index.html</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span> <span class="attr">xmlns:th</span>=<span class="string">&quot;http://www.thymeleaf.org&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>首页<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>测试RESTFul编程风格<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">hr</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--RESTful风格的：查看用户列表--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">th:href</span>=<span class="string">&quot;@&#123;/user&#125;&quot;</span>&gt;</span>查看用户列表<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>3、控制器Controller：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/user&quot;, method = RequestMethod.GET)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getAll</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;正在查询所有用户信息....&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;ok&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>4、视图页面：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span> <span class="attr">xmlns:th</span>=<span class="string">&quot;http://www.thymeleaf.org&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>ok<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>OK!<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>5、启动服务器，测试：<a href="http://localhost:8080/springmvc">http://localhost:8080/springmvc</a></p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/%E6%B5%8B%E8%AF%95RESTFul%E6%96%B9%E5%BC%8F%E6%9F%A5%E8%AF%A2%E6%89%80%E6%9C%89.png" alt="测试RESTFul方式查询所有" style="zoom: 67%;">

<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/RESTFul%E6%96%B9%E5%BC%8F%E6%9F%A5%E8%AF%A2%E6%89%80%E6%9C%89ok.png" alt="RESTFul方式查询所有ok" style="zoom:80%;">

<p>6、控制台打印：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">正在查询所有用户信息....</span><br></pre></td></tr></table></figure>

<h3 id="1-3-2-根据id查询-GET-api-user-1"><a href="#1-3-2-根据id查询-GET-api-user-1" class="headerlink" title="1.3.2 根据id查询(GET &#x2F;api&#x2F;user&#x2F;1)"></a>1.3.2 根据id查询(GET &#x2F;api&#x2F;user&#x2F;1)</h3><p>1、index.html添加超链接</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--RESTful风格的：根据id查询用户信息--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">th:href</span>=<span class="string">&quot;@&#123;/user/110&#125;&quot;</span>&gt;</span>查询id=110的这个用户信息<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>2、编写Controller</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(value = &quot;/user/&#123;id&#125;&quot;, method = RequestMethod.GET)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getById</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> String id)</span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;正在根据用户id查询用户信息...，用户id是&quot;</span> + id);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;ok&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>3、启动服务器测试：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/%E6%B5%8B%E8%AF%95RESTFul%E6%96%B9%E5%BC%8F%E6%A0%B9%E6%8D%AEid%E6%9F%A5%E8%AF%A2.png" alt="测试RESTFul方式根据id查询" style="zoom:67%;">

<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/RESTFul%E6%96%B9%E5%BC%8F%E6%A0%B9%E6%8D%AEid%E6%9F%A5%E8%AF%A2ok.png" alt="RESTFul方式根据id查询ok" style="zoom: 67%;">

<p>4、控制台打印：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">正在根据用户id查询用户信息...，用户id是110</span><br></pre></td></tr></table></figure>


<h2 id="1-4-RESTFul方式演示增加-POST-api-user"><a href="#1-4-RESTFul方式演示增加-POST-api-user" class="headerlink" title="1.4 RESTFul方式演示增加(POST &#x2F;api&#x2F;user)"></a>1.4 RESTFul方式演示增加(POST &#x2F;api&#x2F;user)</h2><p>RESTFul规范中规定，如果要进行保存操作，需要发送POST请求。</p>
<p>1、准备User实体（采用Lombok简化）</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> Integer password;</span><br><span class="line">    <span class="keyword">private</span> String age;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>PS：如需使用Lombok，需要在pom.xml引入依赖</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--lombok依赖--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.18.28<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>2、index.html添加表单</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--RESTful风格的：新增用户信息。新增必须发送POST请求，需要使用form表单--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">th:action</span>=<span class="string">&quot;@&#123;/user&#125;&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span><br><span class="line">    用户名：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    密码：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;password&quot;</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    年龄：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;age&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;保存&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>3、编写Controller</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(value = &quot;/user&quot;, method = RequestMethod.POST)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">save</span><span class="params">(User user)</span> &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;正在保存user用户信息...&quot;</span> + user);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;ok&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>4、启动服务器测试：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/%E6%B5%8B%E8%AF%95RESTFul%E6%96%B9%E5%BC%8F%E5%A2%9E%E5%8A%A0.png" alt="测试RESTFul方式增加" style="zoom:67%;">

<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/RESTFul%E6%96%B9%E5%BC%8F%E5%A2%9E%E5%8A%A0ok.png" alt="RESTFul方式增加ok" style="zoom:80%;">

<p>5、控制台打印：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">正在保存user用户信息...User(username=木又枯了, password=123, age=18)</span><br></pre></td></tr></table></figure>


<h2 id="1-5-RESTFul方式演示修改"><a href="#1-5-RESTFul方式演示修改" class="headerlink" title="1.5 RESTFul方式演示修改"></a>1.5 RESTFul方式演示修改</h2><p>RESTFul规范中规定，如果要进行保存操作，需要发送PUT请求。</p>
<p><strong>如何发送PUT请求？</strong></p>
<ul>
<li>首先你必须是一个POST请求。</li>
<li>在发送POST请求的时候，提交这样的数据：<font color="red"><code>_method=PUT</code></font></li>
<li>在web.xml文件配置SpringMVC提供的过滤器：<code>HiddenHttpMethodFilter</code></li>
</ul>
<p>实践一下：</p>
<p>1、index.html添加表单</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--RESTful风格的：修改用户信息。修改必须发送PUT请求，要发送PUT请求，首先你必须是一个POST请求--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">th:action</span>=<span class="string">&quot;@&#123;/user&#125;&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--隐藏域--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;_method&quot;</span> <span class="attr">value</span>=<span class="string">&quot;put&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    用户名：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    密码：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;password&quot;</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    年龄：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;age&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;修改&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>2、配置隐藏的HTTP请求方式过滤器</p>
<p><font color="red"><strong>PS：如果添加了字符编码过滤器，一定要在字符编码过滤器后面配置，否则字符编码过滤器会失效</strong></font></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--添加一个过滤器，这个过滤器是springmvc提前写好的，直接用就行了，这个过滤器可以帮助你将请求POST转换成PUT请求/DELETE请求--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>hiddenHttpMethodFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>org.springframework.web.filter.HiddenHttpMethodFilter<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>hiddenHttpMethodFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>3、编写Controller</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(value = &quot;/api/user&quot;, method = RequestMethod.PUT)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">update</span><span class="params">(String username)</span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;修改用户信息，用户名：&quot;</span> + username);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;ok&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>4、测试结果：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/%E6%B5%8B%E8%AF%95RESTFul%E6%96%B9%E5%BC%8F%E4%BF%AE%E6%94%B9.png" alt="测试RESTFul方式修改" style="zoom: 50%;">

<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/RESTFul%E6%96%B9%E5%BC%8F%E4%BF%AE%E6%94%B9ok.png" style="zoom:80%;">

<p>5、控制台打印：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">正在修改用户信息：User(username=木又枯了z, password=123321, age=20)</span><br></pre></td></tr></table></figure>

<h2 id="1-6-RESTFul方式演示删除"><a href="#1-6-RESTFul方式演示删除" class="headerlink" title="1.6 RESTFul方式演示删除"></a>1.6 RESTFul方式演示删除</h2><p>1、index.html添加删除按钮</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--RESTful风格的：删除用户信息--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--删除必须发送DELETE请求。和PUT请求实现方式相同。--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--发送DELETE请求的前提是POST请求，并且需要通过隐藏域提交 _method=delete --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">th:href</span>=<span class="string">&quot;@&#123;/user/120&#125;&quot;</span> <span class="attr">onclick</span>=<span class="string">&quot;del(event)&quot;</span>&gt;</span>删除用户id=120的用户信息<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">id</span>=<span class="string">&quot;delForm&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;_method&quot;</span> <span class="attr">value</span>=<span class="string">&quot;delete&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">function</span> <span class="title function_">del</span>(<span class="params">event</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 获取表单</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> delForm = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;delForm&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 给form的action赋值</span></span></span><br><span class="line"><span class="language-javascript">        delForm.<span class="property">action</span> = event.<span class="property">target</span>.<span class="property">href</span>;</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 发送POST请求提交表单</span></span></span><br><span class="line"><span class="language-javascript">        delForm.<span class="title function_">submit</span>();</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 非常重要，你需要阻止超链接的默认行为。</span></span></span><br><span class="line"><span class="language-javascript">        event.<span class="title function_">preventDefault</span>();</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>2、配置隐藏的HTTP请求方式过滤器</p>
<p><font color="red"><strong>PS：如果添加了字符编码过滤器，一定要在字符编码过滤器后面配置，否则字符编码过滤器会失效</strong></font></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--添加一个过滤器，这个过滤器是springmvc提前写好的，直接用就行了，这个过滤器可以帮助你将请求POST转换成PUT请求/DELETE请求--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>hiddenHttpMethodFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>org.springframework.web.filter.HiddenHttpMethodFilter<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>hiddenHttpMethodFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>3、编写Controller</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(value = &quot;/user/&#123;id&#125;&quot;, method = RequestMethod.DELETE)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">del</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> String id)</span> &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;正在删除用户：&quot;</span> + id);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;ok&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>4、测试结果：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/%E6%B5%8B%E8%AF%95RESTFul%E6%96%B9%E5%BC%8F%E5%88%A0%E9%99%A4.png" style="zoom:67%;">

<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/RESTFul%E6%96%B9%E5%BC%8F%E5%88%A0%E9%99%A4ok.png" style="zoom: 50%;">

<p>5、控制台打印：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">正在删除用户：120</span><br></pre></td></tr></table></figure>

<h2 id="1-7-HiddenHttpMethodFilter"><a href="#1-7-HiddenHttpMethodFilter" class="headerlink" title="1.7 HiddenHttpMethodFilter"></a>1.7 HiddenHttpMethodFilter</h2><p><code>HiddenHttpMethodFilter</code>是Spring MVC框架提供的，专门用于RESTFul编程风格。</p>
<p>实现原理可以通过源码查看：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/HiddenHttpMethodFilter%E6%BA%90%E7%A0%81(1).png" alt="HiddenHttpMethodFilter源码(1)" style="zoom: 50%;">

<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/HiddenHttpMethodFilter%E6%BA%90%E7%A0%81(2).png" alt="HiddenHttpMethodFilter源码(2)" style="zoom: 67%;">

<p>通过源码可以看到，if语句中，首先判断是否为POST请求，如果是POST请求，调用<code>request.getParameter(this.methodParam)</code>。可以看到<code>this.methodParam</code>是<code>_method</code>，这样就要求我们在提交请求方式的时候必须采用这个格式：<code>_method=put</code>。获取到请求方式之后，调用了<code>toUpperCase</code>转换成大写了。因此前端页面中小写的<code>put</code>或者大写的<code>PUT</code>都是可以的。if语句中嵌套的if语句说的是，只有请求方式是 <code>PUT</code>，<code>DELETE</code>，<code>PATCH</code>的时候会创建<code>HttpMethodRequestWrapper</code>对象。而<code>HttpMethodRequestWrapper</code>对象的构造方法是这样的：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/HiddenHttpMethodFilter%E6%BA%90%E7%A0%81(3).png" alt="HiddenHttpMethodFilter源码(3)" style="zoom: 67%;">

<p>这样method就从<code>POST</code>变成了：<code>PUT/DELETE/PATCH</code>。</p>
<p><font color="red"><strong>PS：重点注意CharacterEncodingFilter和HiddenHttpMethodFilter的顺序！！！！</strong></font></p>
<p>在<code>HiddenHttpMethodFilter</code>源码中有这样一行代码：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">paramValue</span> <span class="operator">=</span> request.getParameter(<span class="built_in">this</span>.methodParam);</span><br></pre></td></tr></table></figure>

<p>大家是否还记得，字符编码过滤器执行之前不能调用<code>request.getParameter()</code>方法，如果提前调用了，乱码问题就无法解决了。因为<code>request.setCharacterEncoding()</code>方法的执行必须在所有<code>request.getParameter()</code>方法之前执行。</p>
<p>因此这两个过滤器就有先后顺序的要求，在web.xml文件中，应该<font color="red"><strong>先配置CharacterEncodingFilter，然后再配置HiddenHttpMethodFilter。</strong></font></p>
<h1 id="2-使用RESTFul实现用户管理系统"><a href="#2-使用RESTFul实现用户管理系统" class="headerlink" title="2. 使用RESTFul实现用户管理系统"></a>2. 使用RESTFul实现用户管理系统</h1><h2 id="2-1-静态页面准备"><a href="#2-1-静态页面准备" class="headerlink" title="2.1 静态页面准备"></a>2.1 静态页面准备</h2><p>文件包括：user.css、user_index.html、user_list.html、user_add.html、user_edit.html。代码如下：</p>
<h3 id="2-1-1-user-css"><a href="#2-1-1-user-css" class="headerlink" title="2.1.1 user.css"></a>2.1.1 user.css</h3><figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-class">.header</span> &#123;</span><br><span class="line">  <span class="attribute">background-color</span>: <span class="number">#f2f2f2</span>;</span><br><span class="line">  <span class="attribute">padding</span>: <span class="number">20px</span>;</span><br><span class="line">  <span class="attribute">text-align</span>: center;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">ul</span> &#123;</span><br><span class="line">  <span class="attribute">list-style-type</span>: none;</span><br><span class="line">  <span class="attribute">margin</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">padding</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">overflow</span>: hidden;</span><br><span class="line">  <span class="attribute">background-color</span>: <span class="number">#333</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">li</span> &#123;</span><br><span class="line">  <span class="attribute">float</span>: left;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">li</span> <span class="selector-tag">a</span> &#123;</span><br><span class="line">  <span class="attribute">display</span>: block;</span><br><span class="line">  <span class="attribute">color</span>: white;</span><br><span class="line">  <span class="attribute">text-align</span>: center;</span><br><span class="line">  <span class="attribute">padding</span>: <span class="number">14px</span> <span class="number">16px</span>;</span><br><span class="line">  <span class="attribute">text-decoration</span>: none;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">li</span> <span class="selector-tag">a</span><span class="selector-pseudo">:hover</span><span class="selector-pseudo">:not</span>(<span class="selector-class">.active</span>) &#123;</span><br><span class="line">  <span class="attribute">background-color</span>: <span class="number">#111</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.active</span> &#123;</span><br><span class="line">  <span class="attribute">background-color</span>: <span class="number">#4CAF50</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">form</span> &#123;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">50%</span>;</span><br><span class="line">  <span class="attribute">margin</span>: <span class="number">0</span> auto;</span><br><span class="line">  <span class="attribute">padding</span>: <span class="number">20px</span>;</span><br><span class="line">  <span class="attribute">border</span>: <span class="number">1px</span> solid <span class="number">#ddd</span>;</span><br><span class="line">  <span class="attribute">border-radius</span>: <span class="number">4px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">label</span> &#123;</span><br><span class="line">  <span class="attribute">display</span>: block;</span><br><span class="line">  <span class="attribute">margin-bottom</span>: <span class="number">8px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">input</span><span class="selector-attr">[type=<span class="string">&quot;text&quot;</span>]</span>, <span class="selector-tag">input</span><span class="selector-attr">[type=<span class="string">&quot;email&quot;</span>]</span>, select &#123;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">  <span class="attribute">padding</span>: <span class="number">6px</span> <span class="number">10px</span>;</span><br><span class="line">  <span class="attribute">margin</span>: <span class="number">8px</span> <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">box-sizing</span>: border-box;</span><br><span class="line">  <span class="attribute">border</span>: <span class="number">1px</span> solid <span class="number">#555</span>;</span><br><span class="line">  <span class="attribute">border-radius</span>: <span class="number">4px</span>;</span><br><span class="line">  <span class="attribute">font-size</span>: <span class="number">16px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">button</span><span class="selector-attr">[type=<span class="string">&quot;submit&quot;</span>]</span> &#123;</span><br><span class="line">  <span class="attribute">padding</span>: <span class="number">10px</span>;</span><br><span class="line">  <span class="attribute">background-color</span>: <span class="number">#4CAF50</span>;</span><br><span class="line">  <span class="attribute">color</span>: <span class="number">#fff</span>;</span><br><span class="line">  <span class="attribute">border</span>: none;</span><br><span class="line">  <span class="attribute">border-radius</span>: <span class="number">4px</span>;</span><br><span class="line">  <span class="attribute">cursor</span>: pointer;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">button</span><span class="selector-attr">[type=<span class="string">&quot;submit&quot;</span>]</span><span class="selector-pseudo">:hover</span> &#123;</span><br><span class="line">  <span class="attribute">background-color</span>: <span class="number">#3e8e41</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">table</span> &#123;</span><br><span class="line">  <span class="attribute">border-collapse</span>: collapse;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">th</span>, <span class="selector-tag">td</span> &#123;</span><br><span class="line">  <span class="attribute">border</span>: <span class="number">1px</span> solid <span class="number">#ddd</span>;</span><br><span class="line">  <span class="attribute">padding</span>: <span class="number">8px</span>;</span><br><span class="line">  <span class="attribute">text-align</span>: left;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">th</span> &#123;</span><br><span class="line">  <span class="attribute">background-color</span>: <span class="number">#f2f2f2</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">tr</span><span class="selector-pseudo">:nth-child</span>(even) &#123;</span><br><span class="line">  <span class="attribute">background-color</span>: <span class="number">#f2f2f2</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.header</span> &#123;</span><br><span class="line">  <span class="attribute">background-color</span>: <span class="number">#f2f2f2</span>;</span><br><span class="line">  <span class="attribute">padding</span>: <span class="number">20px</span>;</span><br><span class="line">  <span class="attribute">text-align</span>: center;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">a</span> &#123;</span><br><span class="line">  <span class="attribute">text-decoration</span>: none;</span><br><span class="line">  <span class="attribute">color</span>: <span class="number">#333</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.add-button</span> &#123;</span><br><span class="line">  <span class="attribute">margin-bottom</span>: <span class="number">20px</span>;</span><br><span class="line">  <span class="attribute">padding</span>: <span class="number">10px</span>;</span><br><span class="line">  <span class="attribute">background-color</span>: <span class="number">#4CAF50</span>;</span><br><span class="line">  <span class="attribute">color</span>: <span class="number">#fff</span>;</span><br><span class="line">  <span class="attribute">border</span>: none;</span><br><span class="line">  <span class="attribute">border-radius</span>: <span class="number">4px</span>;</span><br><span class="line">  <span class="attribute">cursor</span>: pointer;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.add-button</span><span class="selector-pseudo">:hover</span> &#123;</span><br><span class="line">  <span class="attribute">background-color</span>: <span class="number">#3e8e41</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-1-2-user-index-html"><a href="#2-1-2-user-index-html" class="headerlink" title="2.1.2 user_index.html"></a>2.1.2 user_index.html</h3><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>用户管理系统<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">href</span>=<span class="string">&quot;user.css&quot;</span> <span class="attr">type</span>=<span class="string">&quot;text/css&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">link</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;header&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>用户管理系统<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;active&quot;</span> <span class="attr">href</span>=<span class="string">&quot;user_list.html&quot;</span>&gt;</span>用户列表<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9Fuser_index.html.png" alt="用户管理系统user_index.html"></p>
<h3 id="2-1-3-user-list-html"><a href="#2-1-3-user-list-html" class="headerlink" title="2.1.3 user_list.html"></a>2.1.3 user_list.html</h3><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>用户列表<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">href</span>=<span class="string">&quot;user.css&quot;</span> <span class="attr">type</span>=<span class="string">&quot;text/css&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">link</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;header&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>用户列表<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;add-button-wrapper&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;add-button&quot;</span> <span class="attr">href</span>=<span class="string">&quot;user_add.html&quot;</span>&gt;</span>新增用户<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">table</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">thead</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">th</span>&gt;</span>编号<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">th</span>&gt;</span>用户名<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">th</span>&gt;</span>性别<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">th</span>&gt;</span>邮箱<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">th</span>&gt;</span>操作<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">thead</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">tbody</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">td</span>&gt;</span>1<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">td</span>&gt;</span>张三<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">td</span>&gt;</span>男<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">td</span>&gt;</span>zhangsan@powernode.com<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">td</span>&gt;</span></span><br><span class="line">          修改</span><br><span class="line">          删除</span><br><span class="line">        <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">td</span>&gt;</span>2<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">td</span>&gt;</span>李四<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">td</span>&gt;</span>女<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">td</span>&gt;</span>lisi@powernode.com<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">td</span>&gt;</span></span><br><span class="line">          修改</span><br><span class="line">          删除</span><br><span class="line">        <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">tbody</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9Fuser_list.html.png" alt="用户管理系统user_list.html"></p>
<h3 id="2-1-4-user-add-html"><a href="#2-1-4-user-add-html" class="headerlink" title="2.1.4 user_add.html"></a>2.1.4 user_add.html</h3><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>新增用户<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">href</span>=<span class="string">&quot;user.css&quot;</span> <span class="attr">type</span>=<span class="string">&quot;text/css&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">link</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">h1</span>&gt;</span>新增用户<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">form</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">label</span>&gt;</span>用户名:<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">required</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">label</span>&gt;</span>性别:<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">name</span>=<span class="string">&quot;gender&quot;</span> <span class="attr">required</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;&quot;</span>&gt;</span>-- 请选择 --<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;1&quot;</span>&gt;</span>男<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;0&quot;</span>&gt;</span>女<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">label</span>&gt;</span>邮箱:<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;email&quot;</span> <span class="attr">name</span>=<span class="string">&quot;email&quot;</span> <span class="attr">required</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span>&gt;</span>保存<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9Fuser_add.html.png" alt="用户管理系统user_add.html"></p>
<h3 id="2-1-5-user-edit-html"><a href="#2-1-5-user-edit-html" class="headerlink" title="2.1.5 user_edit.html"></a>2.1.5 user_edit.html</h3><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>修改用户<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">href</span>=<span class="string">&quot;user.css&quot;</span> <span class="attr">type</span>=<span class="string">&quot;text/css&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">link</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">h1</span>&gt;</span>修改用户<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">form</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">label</span>&gt;</span>用户名:<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">value</span>=<span class="string">&quot;张三&quot;</span> <span class="attr">required</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">label</span>&gt;</span>性别:<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">name</span>=<span class="string">&quot;gender&quot;</span> <span class="attr">required</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;&quot;</span>&gt;</span>-- 请选择 --<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;1&quot;</span> <span class="attr">selected</span>&gt;</span>男<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;0&quot;</span>&gt;</span>女<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">label</span>&gt;</span>邮箱:<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;email&quot;</span> <span class="attr">name</span>=<span class="string">&quot;email&quot;</span> <span class="attr">value</span>=<span class="string">&quot;zhangsan@powernode.com&quot;</span> <span class="attr">required</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span>&gt;</span>修改<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9Fuser_edit.html.png" alt="用户管理系统user_edit.html"></p>
<h2 id="2-2-SpringMVC环境搭建"><a href="#2-2-SpringMVC环境搭建" class="headerlink" title="2.2 SpringMVC环境搭建"></a>2.2 SpringMVC环境搭建</h2><p>1、创建module：usermgt</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.muyoukule<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>usermgt<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 打包方式设置为war方式 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>war<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>17<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>17<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- Spring MVC依赖 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-webmvc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.1.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--日志框架Logback依赖--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>ch.qos.logback<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>logback-classic<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.5.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--Servlet依赖--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>jakarta.servlet<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jakarta.servlet-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--Spring6和Thymeleaf整合依赖--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.thymeleaf<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>thymeleaf-spring6<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1.2.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--lombok依赖--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.18.28<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>2、添加web支持</p>
<p>3、配置web.xml文件</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">web-app</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://xmlns.jcp.org/xml/ns/javaee&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_4_0.xsd&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">version</span>=<span class="string">&quot;4.0&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--字符编码过滤器--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>characterEncodingFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>org.springframework.web.filter.CharacterEncodingFilter<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>encoding<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>forceRequestEncoding<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>true<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>forceResponseEncoding<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>true<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>characterEncodingFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--HTTP请求方式过滤器--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>hiddenHttpMethodFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>org.springframework.web.filter.HiddenHttpMethodFilter<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>hiddenHttpMethodFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--前端控制器--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>springmvc<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>org.springframework.web.servlet.DispatcherServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>contextConfigLocation<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>classpath:springmvc.xml<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">load-on-startup</span>&gt;</span>1<span class="tag">&lt;/<span class="name">load-on-startup</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>springmvc<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>注意两个过滤器Filter的配置顺序：<font color="red"><strong>先</strong></font>配置 <code>CharacterEncodingFilter</code>，<font color="red"><strong>后</strong></font>配置 <code>HiddenHttpMethodFilter</code></p>
<p>4、配置springmvc.xml文件</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:mvc</span>=<span class="string">&quot;http://www.springframework.org/schema/mvc&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/context https://www.springframework.org/schema/context/spring-context.xsd http://www.springframework.org/schema/mvc https://www.springframework.org/schema/mvc/spring-mvc.xsd&quot;</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!--组件扫描--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">&quot;com.muyoukule&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--视图解析器--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;thymeleafViewResolver&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.thymeleaf.spring6.view.ThymeleafViewResolver&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;characterEncoding&quot;</span> <span class="attr">value</span>=<span class="string">&quot;UTF-8&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;order&quot;</span> <span class="attr">value</span>=<span class="string">&quot;1&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;templateEngine&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;org.thymeleaf.spring6.SpringTemplateEngine&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;templateResolver&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;org.thymeleaf.spring6.templateresolver.SpringResourceTemplateResolver&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;prefix&quot;</span> <span class="attr">value</span>=<span class="string">&quot;/WEB-INF/thymeleaf/&quot;</span>/&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;suffix&quot;</span> <span class="attr">value</span>=<span class="string">&quot;.html&quot;</span>/&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;templateMode&quot;</span> <span class="attr">value</span>=<span class="string">&quot;HTML&quot;</span>/&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;characterEncoding&quot;</span> <span class="attr">value</span>=<span class="string">&quot;UTF-8&quot;</span>/&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--开启注解--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mvc:annotation-driven</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--开启默认Servlet--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mvc:default-servlet-handler</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>5、创建packag</p>
<p>6、在WEB-INF目录下新建：thymeleaf目录</p>
<p>最终创建好的项目结构如下：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86%E7%95%8C%E9%9D%A2%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84.png" alt="用户管理界面项目结构" style="zoom:67%;">

<h2 id="2-3-显示首页"><a href="#2-3-显示首页" class="headerlink" title="2.3 显示首页"></a>2.3 显示首页</h2><p>1、在应用的根下新建目录：<code>static/css</code>，将user.css文件拷贝进去。</p>
<p>2、将user_index.html拷贝到WEB-INF&#x2F;thymeleaf目录下：</p>
<p>代码有两处需要修改：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/%E4%BF%AE%E6%94%B9user_index.html%E4%BB%A3%E7%A0%81.png" alt="修改user_index.html代码" style="zoom: 67%;">

<p>3、在springmvc.xml文件中配置视图控制器映射：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--视图控制器映射--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mvc:view-controller</span> <span class="attr">path</span>=<span class="string">&quot;/&quot;</span> <span class="attr">view-name</span>=<span class="string">&quot;user_index&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>4、部署，配置启动服务器，测试：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/%E6%B5%8B%E8%AF%95user_index.html%E9%A1%B5%E9%9D%A2.png" alt="测试user_index.html页面"></p>
<h2 id="2-4-实现用户列表"><a href="#2-4-实现用户列表" class="headerlink" title="2.4 实现用户列表"></a>2.4 实现用户列表</h2><p>1、修改user_index.html中的超链接：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;active&quot;</span> <span class="attr">th:href</span>=<span class="string">&quot;@&#123;/user&#125;&quot;</span>&gt;</span>用户列表<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>2、编写pojo：User</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String email;</span><br><span class="line">    <span class="keyword">private</span> Integer gender;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3、编写UserDao，提供selectAll方法：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserDao</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> List&lt;User&gt; users = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">user1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="number">10001L</span>, <span class="string">&quot;张三&quot;</span>, <span class="string">&quot;zhangsan@example.com&quot;</span>, <span class="number">1</span>);</span><br><span class="line">        <span class="type">User</span> <span class="variable">user2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="number">10002L</span>, <span class="string">&quot;李四&quot;</span>, <span class="string">&quot;lisi@example.com&quot;</span>, <span class="number">1</span>);</span><br><span class="line">        <span class="type">User</span> <span class="variable">user3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="number">10003L</span>, <span class="string">&quot;王五&quot;</span>, <span class="string">&quot;wangwu@example.com&quot;</span>, <span class="number">1</span>);</span><br><span class="line">        <span class="type">User</span> <span class="variable">user4</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="number">10004L</span>, <span class="string">&quot;赵六&quot;</span>, <span class="string">&quot;zhaoliu@example.com&quot;</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="type">User</span> <span class="variable">user5</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="number">10005L</span>, <span class="string">&quot;钱七&quot;</span>, <span class="string">&quot;qianqi@example.com&quot;</span>, <span class="number">0</span>);</span><br><span class="line">        users.add(user1);</span><br><span class="line">        users.add(user2);</span><br><span class="line">        users.add(user3);</span><br><span class="line">        users.add(user4);</span><br><span class="line">        users.add(user5);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> List&lt;User&gt; <span class="title function_">selectAll</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> users;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>4、编写控制器UserController：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserDao userDao;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/user&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">list</span><span class="params">(Model model)</span> &#123;</span><br><span class="line">        <span class="comment">// 获取所有的用户</span></span><br><span class="line">        List&lt;User&gt; users = userDao.selectAll();</span><br><span class="line">        <span class="comment">// 存储到request域</span></span><br><span class="line">        model.addAttribute(<span class="string">&quot;users&quot;</span>, users);</span><br><span class="line">        <span class="comment">// 跳转视图</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;user_list&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>5、将user_list.html拷贝到thymeleaf目录下，并进行代码修改，显示用户列表：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span> <span class="attr">xmlns:th</span>=<span class="string">&quot;http://www.thymeleaf.org&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>用户列表<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">th:href</span>=<span class="string">&quot;@&#123;/static/css/user.css&#125;&quot;</span> <span class="attr">type</span>=<span class="string">&quot;text/css&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">link</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;header&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>用户列表<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;add-button-wrapper&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;add-button&quot;</span> <span class="attr">href</span>=<span class="string">&quot;user_add.html&quot;</span>&gt;</span>新增用户<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">table</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">thead</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">th</span>&gt;</span>编号<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">th</span>&gt;</span>用户名<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">th</span>&gt;</span>性别<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">th</span>&gt;</span>邮箱<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">th</span>&gt;</span>操作<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">thead</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tbody</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">tr</span> <span class="attr">th:each</span>=<span class="string">&quot;user : $&#123;users&#125;&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">td</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;user.id&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">td</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;user.username&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">td</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;user.gender == 1 ? &#x27;男&#x27; : &#x27;女&#x27;&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">td</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;user.email&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;&quot;</span>&gt;</span>修改<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;&quot;</span>&gt;</span>删除<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">tbody</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>6、测试结果：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/%E6%B5%8B%E8%AF%95%E7%94%A8%E6%88%B7%E6%9F%A5%E8%AF%A2%E5%8A%9F%E8%83%BD%E6%88%90%E5%8A%9F.png" alt="测试用户查询功能成功"></p>
<h2 id="2-5-实现新增功能"><a href="#2-5-实现新增功能" class="headerlink" title="2.5 实现新增功能"></a>2.5 实现新增功能</h2><h3 id="2-5-1-跳转到新增页面"><a href="#2-5-1-跳转到新增页面" class="headerlink" title="2.5.1 跳转到新增页面"></a>2.5.1 跳转到新增页面</h3><p>1、在用户列表user_index.html页面，修改<code>新增用户</code>的超链接：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;add-button&quot;</span> <span class="attr">th:href</span>=<span class="string">&quot;@&#123;/toAdd&#125;&quot;</span>&gt;</span>新增用户<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>2、将user_add.html拷贝到thymeleaf目录下，并进行代码修改如下：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span> <span class="attr">xmlns:th</span>=<span class="string">&quot;http:www.thymeleaf.org&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>新增用户<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">th:href</span>=<span class="string">&quot;@&#123;/static/css/user.css&#125;&quot;</span> <span class="attr">type</span>=<span class="string">&quot;text/css&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">link</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>新增用户<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">label</span>&gt;</span>用户名:<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">required</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">label</span>&gt;</span>性别:<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">name</span>=<span class="string">&quot;gender&quot;</span> <span class="attr">required</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;&quot;</span>&gt;</span>-- 请选择 --<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;1&quot;</span>&gt;</span>男<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;0&quot;</span>&gt;</span>女<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">label</span>&gt;</span>邮箱:<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;email&quot;</span> <span class="attr">name</span>=<span class="string">&quot;email&quot;</span> <span class="attr">required</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span>&gt;</span>保存<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>3、在springmvc.xml文件中配置<code>视图控制器映射</code>：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mvc:view-controller</span> <span class="attr">path</span>=<span class="string">&quot;/toAdd&quot;</span> <span class="attr">view-name</span>=<span class="string">&quot;user_add&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<p>4、启动服务器测试：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/%E6%B5%8B%E8%AF%95user_add.html%E9%A1%B5%E9%9D%A2.png" alt="测试user_add.html页面"></p>
<h3 id="2-5-2-实现新增功能"><a href="#2-5-2-实现新增功能" class="headerlink" title="2.5.2 实现新增功能"></a>2.5.2 实现新增功能</h3><p>1、前端页面发送POST请求，提交表单，修改user_add.html代码如下：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">th:action</span>=<span class="string">&quot;@&#123;/user&#125;&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>2、编写控制器UserController：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(value = &quot;/user&quot;, method = RequestMethod.POST)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">save</span><span class="params">(User user)</span>&#123;</span><br><span class="line">    <span class="comment">// 调用userDao保存用户信息</span></span><br><span class="line">    userDao.insert(user);</span><br><span class="line">    <span class="comment">// 重定向到用户列表页面（重新让浏览器发送一次全新的请求，去请求列表页面）</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;redirect:/user&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>PS：保存成功后，采用重定向的方式跳转到用户列表。</strong></p>
<p>3、编写UserDao：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Long <span class="title function_">generateId</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="comment">// 使用Stream API</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">maxId</span> <span class="operator">=</span> users.stream().map(user -&gt; user.getId()).reduce((id1, id2) -&gt; id1 &gt; id2 ? id1 : id2).get();</span><br><span class="line">    <span class="keyword">return</span> maxId + <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">insert</span><span class="params">(User user)</span>&#123;</span><br><span class="line">    <span class="comment">// 生成id</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">id</span> <span class="operator">=</span> generateId();</span><br><span class="line">    <span class="comment">// 给user对象id属性赋值</span></span><br><span class="line">    user.setId(id);</span><br><span class="line">    <span class="comment">// 保存</span></span><br><span class="line">    users.add(user);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>PS：单独写了一个方法生成id，内部使用了Stream API。</strong></p>
<p>4、启动服务器测试：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/%E5%AE%9E%E7%8E%B0%E6%96%B0%E5%A2%9E%E7%94%A8%E6%88%B7%E5%8A%9F%E8%83%BD.png" alt="实现新增用户功能"></p>
<h2 id="2-6-实现新增功能"><a href="#2-6-实现新增功能" class="headerlink" title="2.6 实现新增功能"></a>2.6 实现新增功能</h2><h3 id="2-6-1-跳转到修改页面"><a href="#2-6-1-跳转到修改页面" class="headerlink" title="2.6.1 跳转到修改页面"></a>2.6.1 跳转到修改页面</h3><p>1、修改user_list.html中<code>修改</code>超链接：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">th:href</span>=<span class="string">&quot;@&#123;&#x27;/user/&#x27; + $&#123;user.id&#125;&#125;&quot;</span>&gt;</span>修改<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>2、编写Controller：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/user/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">toUpdate</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id, Model model)</span>&#123;</span><br><span class="line">    <span class="comment">// 根据id查询用户信息</span></span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userDao.selectById(id);</span><br><span class="line">    <span class="comment">// 将对象存储到request域</span></span><br><span class="line">    model.addAttribute(<span class="string">&quot;user&quot;</span>, user);</span><br><span class="line">    <span class="comment">// 跳转视图</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;user_edit&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>3、编写UserDao：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> User <span class="title function_">selectById</span><span class="params">(Long id)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> users.stream().filter(user -&gt; user.getId().equals(id)).findFirst().get();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>4、将user_edit.html拷贝thymeleaf目录下，并修改代码如下：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span> <span class="attr">xmlns:th</span>=<span class="string">&quot;http://www.thymeleaf.org&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>修改用户<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">th:href</span>=<span class="string">&quot;@&#123;/static/css/user.css&#125;&quot;</span> <span class="attr">type</span>=<span class="string">&quot;text/css&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">link</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>修改用户<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">label</span>&gt;</span>用户名:<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">th:value</span>=<span class="string">&quot;$&#123;user.username&#125;&quot;</span> <span class="attr">required</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">label</span>&gt;</span>性别:<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">name</span>=<span class="string">&quot;gender&quot;</span> <span class="attr">required</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;&quot;</span>&gt;</span>-- 请选择 --<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;1&quot;</span> <span class="attr">th:field</span>=<span class="string">&quot;$&#123;user.gender&#125;&quot;</span>&gt;</span>男<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;0&quot;</span> <span class="attr">th:field</span>=<span class="string">&quot;$&#123;user.gender&#125;&quot;</span>&gt;</span>女<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">label</span>&gt;</span>邮箱:<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;email&quot;</span> <span class="attr">name</span>=<span class="string">&quot;email&quot;</span> <span class="attr">th:value</span>=<span class="string">&quot;$&#123;user.email&#125;&quot;</span> <span class="attr">required</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span>&gt;</span>修改<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>5、启动服务器测试：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/%E6%B5%8B%E8%AF%95user_edit.html%E9%A1%B5%E9%9D%A2.png" alt="测试user_edit.html页面"></p>
<h3 id="2-6-2-实现修改功能"><a href="#2-6-2-实现修改功能" class="headerlink" title="2.6.2 实现修改功能"></a>2.6.2 实现修改功能</h3><p>1、将user_edit.html页面中的form表单修改一下，添加action，添加method，隐藏域的方式提交请求方式put，隐藏域的方式提交id：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">th:action</span>=<span class="string">&quot;@&#123;/user&#125;&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!--隐藏域的方式设置请求方式为put请求--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;_method&quot;</span> <span class="attr">value</span>=<span class="string">&quot;put&quot;</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!--隐藏域的方式提交id--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;id&quot;</span> <span class="attr">th:value</span>=<span class="string">&quot;$&#123;user.id&#125;&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>2、编写Controller：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@PutMapping(&quot;/user&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">modify</span><span class="params">(User user)</span>&#123;</span><br><span class="line">    <span class="comment">// 更新数据</span></span><br><span class="line">    userDao.update(user);</span><br><span class="line">    <span class="comment">// 重定向</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;redirect:/user&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>3、编写UserDao：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">update</span><span class="params">(User user)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; users.size(); i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (user.getId().equals(users.get(i).getId())) &#123;</span><br><span class="line">            users.set(i, user);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>4、启动服务器测试：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/%E6%B5%8B%E8%AF%95%E4%BF%AE%E6%94%B9%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF.png" alt="测试修改用户信息"></p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/%E4%BF%AE%E6%94%B9%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF%E6%88%90%E5%8A%9F.png" alt="修改用户信息成功"></p>
<h2 id="2-7-实现删除功能"><a href="#2-7-实现删除功能" class="headerlink" title="2.7 实现删除功能"></a>2.7 实现删除功能</h2><p>删除应该发送DELETE请求，要模拟DELETE请求，就需要使用表单方式提交。因此我们点击<code>删除</code>超链接时需要采用表单方式提交。</p>
<p>1、在user_list.html页面添加form表单，并且点击超链接时应该提交表单，代码如下：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--为删除提供一个鼠标单击事件--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">th:href</span>=<span class="string">&quot;@&#123;&#x27;/user/&#x27; + $&#123;user.id&#125;&#125;&quot;</span> <span class="attr">onclick</span>=<span class="string">&quot;del(event)&quot;</span>&gt;</span>删除<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 写在body标签里面 --&gt;</span></span><br><span class="line"><span class="comment">&lt;!--为删除操作准备一个form表单，点击删除时提交form表单--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&quot;display: none&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span> <span class="attr">id</span>=<span class="string">&quot;delForm&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;_method&quot;</span> <span class="attr">value</span>=<span class="string">&quot;delete&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">function</span> <span class="title function_">del</span>(<span class="params">event</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 获取表单</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> delForm = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;delForm&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 设置表单action</span></span></span><br><span class="line"><span class="language-javascript">        delForm.<span class="property">action</span> = event.<span class="property">target</span>.<span class="property">href</span>;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">if</span>(<span class="variable language_">window</span>.<span class="title function_">confirm</span>(<span class="string">&quot;您确定要删除吗？&quot;</span>))&#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 提交表单</span></span></span><br><span class="line"><span class="language-javascript">            delForm.<span class="title function_">submit</span>();</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 阻止超链接默认行为</span></span></span><br><span class="line"><span class="language-javascript">        event.<span class="title function_">preventDefault</span>();</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>2、编写Controller:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(value = &quot;/user/&#123;id&#125;&quot;, method = RequestMethod.DELETE)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">del</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span>&#123;</span><br><span class="line">    <span class="comment">// 调用dao删除用户</span></span><br><span class="line">    userDao.deleteById(id);</span><br><span class="line">    <span class="comment">// 重定向到列表</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;redirect:/user&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>3、编写UserDao:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deleteById</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; users.size(); i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (id.equals(users.get(i).getId())) &#123;</span><br><span class="line">            users.remove(i);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>4、启动服务器测试：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/%E6%B5%8B%E8%AF%95%E5%88%A0%E9%99%A4%E7%94%A8%E6%88%B7%E5%8A%9F%E8%83%BD.png" alt="测试删除用户功能"></p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/%E5%88%A0%E9%99%A4%E7%94%A8%E6%88%B7%E6%88%90%E5%8A%9F.png" alt="删除用户成功">
]]></content>
      <categories>
        <category>Java</category>
        <category>SSM</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>Spring</tag>
        <tag>SpringMVC</tag>
      </tags>
  </entry>
  <entry>
    <title>【第5章】 视图View</title>
    <url>/posts/50282/</url>
    <content><![CDATA[<p>参考视频：<a href="https://www.bilibili.com/video/BV1sC411L76f/">SpringMVC教程，SpringMVC从零到精通，老杜SpringMVC，动力节点SpringMVC</a></p>
<h1 id="1-SpringMVC中视图的实现原理"><a href="#1-SpringMVC中视图的实现原理" class="headerlink" title="1. SpringMVC中视图的实现原理"></a>1. SpringMVC中视图的实现原理</h1><h2 id="1-1-Spring-MVC视图支持可配置"><a href="#1-1-Spring-MVC视图支持可配置" class="headerlink" title="1.1 Spring MVC视图支持可配置"></a>1.1 Spring MVC视图支持可配置</h2><p>在Spring MVC中，视图View是支持定制的，例如我们之前在 springmvc.xml 文件中进行了如下的配置：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--视图解析器--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;thymeleafViewResolver&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.thymeleaf.spring6.view.ThymeleafViewResolver&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--作用于视图渲染的过程中，可以设置视图渲染后输出时采用的编码字符集--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;characterEncoding&quot;</span> <span class="attr">value</span>=<span class="string">&quot;UTF-8&quot;</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--如果配置多个视图解析器，它来决定优先使用哪个视图解析器，它的值越小优先级越高--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;order&quot;</span> <span class="attr">value</span>=<span class="string">&quot;1&quot;</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--当 ThymeleafViewResolver 渲染模板时，会使用该模板引擎来解析、编译和渲染模板--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;templateEngine&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;org.thymeleaf.spring6.SpringTemplateEngine&quot;</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--用于指定 Thymeleaf 模板引擎使用的模板解析器。模板解析器负责根据模板位置、模板资源名称、文件编码等信息，加载模板并对其进行解析--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;templateResolver&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;org.thymeleaf.spring6.templateresolver.SpringResourceTemplateResolver&quot;</span>&gt;</span></span><br><span class="line">                    <span class="comment">&lt;!--设置模板文件的位置（前缀）--&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;prefix&quot;</span> <span class="attr">value</span>=<span class="string">&quot;/WEB-INF/templates/&quot;</span>/&gt;</span></span><br><span class="line">                    <span class="comment">&lt;!--设置模板文件后缀（后缀），Thymeleaf文件扩展名不一定是html，也可以是其他，例如txt，大部分都是html--&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;suffix&quot;</span> <span class="attr">value</span>=<span class="string">&quot;.html&quot;</span>/&gt;</span></span><br><span class="line">                    <span class="comment">&lt;!--设置模板类型，例如：HTML,TEXT,JAVASCRIPT,CSS等--&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;templateMode&quot;</span> <span class="attr">value</span>=<span class="string">&quot;HTML&quot;</span>/&gt;</span></span><br><span class="line">                    <span class="comment">&lt;!--用于模板文件在读取和解析过程中采用的编码字符集--&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;characterEncoding&quot;</span> <span class="attr">value</span>=<span class="string">&quot;UTF-8&quot;</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>以上的配置表明当前SpringMVC框架使用的视图View是Thymeleaf的。</p>
<p>如果你需要换成其他的视图View，修改以上的配置即可。这样就可以非常轻松的完成视图View的扩展。</p>
<p>这种设计是完全符合OCP开闭原则的。视图View和框架是解耦合的，耦合度低扩展能力强。视图View可以通过配置文件进行灵活切换。</p>
<h2 id="1-2-Spring-MVC支持的常见视图"><a href="#1-2-Spring-MVC支持的常见视图" class="headerlink" title="1.2 Spring MVC支持的常见视图"></a>1.2 Spring MVC支持的常见视图</h2><p>Spring MVC支持的常见视图包括：</p>
<ul>
<li>InternalResourceView：内部资源视图（是SpringMVC内置的，专门负责解析 <code>JSP模板语法</code> 的，另外也负责 <code>转发forward</code> 功能的实现）</li>
<li>RedirectView：重定向视图（是SpringMVC内置的，专门负责 <code>重定向redirect</code> 功能的实现）</li>
<li>ThymeleafView：Thymeleaf视图（第三方的，为<code>Thymeleaf模板语法</code>准备的）</li>
<li>FreeMarkerView：FreeMarker视图（第三方的，为<code>FreeMarker模板语法</code>准备的）</li>
<li>VelocityView：Velocity视图（第三方的，为<code>Velocity模板语法</code>准备的）</li>
<li>PDFView：PDF视图（第三方的，专门用来生成pdf文件视图）</li>
<li>ExcelView：Excel视图（第三方的，专门用来生成excel文件视图）</li>
<li>……</li>
</ul>
<h2 id="1-3-实现视图机制的核心接口"><a href="#1-3-实现视图机制的核心接口" class="headerlink" title="1.3 实现视图机制的核心接口"></a>1.3 实现视图机制的核心接口</h2><p>实现视图的核心类与接口包括：</p>
<p><strong><code>DispatcherServlet</code>类（前端控制器）</strong></p>
<ul>
<li>职责：在整个Spring MVC执行流程中，负责中央调度</li>
<li>核心方法：doDispatch</li>
</ul>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/%E6%A0%B8%E5%BF%83%E6%96%B9%E6%B3%95doDispatch.png" alt="核心方法doDispatch"></p>
<p><strong><code>ViewResolver</code>接口（视图解析器）</strong></p>
<ul>
<li>职责：负责将<code>逻辑视图名</code>转换为<code>物理视图名</code>，最终创建View接口的实现类，即视图实现类对象</li>
<li>核心方法：resolveViewName</li>
</ul>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/%E6%A0%B8%E5%BF%83%E6%96%B9%E6%B3%95resolveViewName.png" alt="核心方法resolveViewName"></p>
<p><strong><code>View</code>接口（视图）</strong></p>
<ul>
<li>职责：负责将模型数据Model渲染为视图格式（HTML代码），并最终将生成的视图（HTML代码）输出到客户端。（它负责将模板语言转换成HTML代码）</li>
<li>核心方法：render</li>
</ul>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/%E6%A0%B8%E5%BF%83%E6%96%B9%E6%B3%95render.png" alt="核心方法render"></p>
<p><strong><code>ViewResolverRegistry</code>（视图解析器注册器）</strong></p>
<ul>
<li>负责在web容器（Tomcat）启动的时候，完成视图解析器的注册。如果有多个视图解析器，会将视图解析器对象按照order的配置放入List集合。</li>
</ul>
<blockquote>
<p>总结</p>
</blockquote>
<ul>
<li>实现视图的核心类和接口包括：ViewResolverRegistry、DispatcherServlet、ViewResolver、View</li>
<li>如果你想定制自己的视图组件：<ul>
<li>编写类实现ViewResolver接口，实现resolveViewName方法，在该方法中完成<code>逻辑视图名</code>转换为<code>物理视图名</code>，并返回View对象。</li>
<li>编写类实现View接口，实现render方法，在该方法中将模板语言转换成HTML代码，并将HTML代码响应到浏览器。</li>
</ul>
</li>
<li>如果Spring MVC框架中使用Thymeleaf作为视图技术。那么相关的类包括：<ul>
<li>ThymeleafView</li>
<li>ThymeleafViewResolver</li>
</ul>
</li>
</ul>
<h2 id="1-4-实现视图机制的原理描述"><a href="#1-4-实现视图机制的原理描述" class="headerlink" title="1.4 实现视图机制的原理描述"></a>1.4 实现视图机制的原理描述</h2><blockquote>
<p>假设我们SpringMVC中使用了Thymeleaf作为视图。</p>
</blockquote>
<ol>
<li><p>浏览器发送请求给web服务器</p>
</li>
<li><p>Spring MVC中的DispatcherServlet接收到请求</p>
</li>
<li><p>DispatcherServlet根据请求路径分发到对应的Controller</p>
</li>
<li><p>DispatcherServlet调用Controller的方法</p>
</li>
<li><p>Controller的方法处理业务并返回一个<code>逻辑视图名</code>给DispatcherServlet</p>
</li>
<li><p>DispatcherServlet调用ThymeleafViewResolver的resolveViewName方法，将<code>逻辑视图名</code>转换为<code>物理视图名</code>，并创建ThymeleafView对象返回给DispatcherServlet</p>
</li>
<li><p>DispatcherServlet再调用ThymeleafView的render方法，render方法将模板语言转换为HTML代码，响应给浏览器，完成最终的渲染。</p>
</li>
</ol>
<blockquote>
<p>假设我们SpringMVC中使用了JSP作为视图。</p>
</blockquote>
<ol>
<li><p>浏览器发送请求给web服务器</p>
</li>
<li><p>Spring MVC中的DispatcherServlet接收到请求</p>
</li>
<li><p>DispatcherServlet根据请求路径分发到对应的Controller</p>
</li>
<li><p>DispatcherServlet调用Controller的方法</p>
</li>
<li><p>Controller的方法处理业务并返回一个<code>逻辑视图名</code>给DispatcherServlet</p>
</li>
<li><p>DispatcherServlet调用<code>InternalResourceViewResolver</code>的<code>resolveViewName</code>方法，将<code>逻辑视图名</code>转换为<code>物理视图名</code>，并创建<code>InternalResourceView</code>对象返回给DispatcherServlet</p>
</li>
<li><p>DispatcherServlet再调用<code>InternalResourceView</code>的<code>render</code>方法，render方法将模板语言转换为HTML代码，响应给浏览器，完成最终的渲染。</p>
</li>
</ol>
<h2 id="1-5-逻辑视图名到物理视图名的转换"><a href="#1-5-逻辑视图名到物理视图名的转换" class="headerlink" title="1.5 逻辑视图名到物理视图名的转换"></a>1.5 逻辑视图名到物理视图名的转换</h2><p>逻辑视图名最终转换的物理视图名是什么，取决再springmvc.xml文件中视图解析器的配置：</p>
<p>假如视图解析器配置的是<code>ThymeleafViewResolver</code>，如下：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;thymeleafViewResolver&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.thymeleaf.spring6.view.ThymeleafViewResolver&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;characterEncoding&quot;</span> <span class="attr">value</span>=<span class="string">&quot;UTF-8&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;order&quot;</span> <span class="attr">value</span>=<span class="string">&quot;1&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;templateEngine&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;org.thymeleaf.spring6.SpringTemplateEngine&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;templateResolver&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;org.thymeleaf.spring6.templateresolver.SpringResourceTemplateResolver&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;prefix&quot;</span> <span class="attr">value</span>=<span class="string">&quot;/WEB-INF/templates/&quot;</span>/&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;suffix&quot;</span> <span class="attr">value</span>=<span class="string">&quot;.html&quot;</span>/&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;templateMode&quot;</span> <span class="attr">value</span>=<span class="string">&quot;HTML&quot;</span>/&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;characterEncoding&quot;</span> <span class="attr">value</span>=<span class="string">&quot;UTF-8&quot;</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>以下程序返回逻辑视图名：index</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/index&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">toIndex</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;index&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最终逻辑视图名<code>index</code>转换为物理视图名：<code>/WEB-INF/templates/index.html</code></p>
<p>假如视图解析器配置的是<code>InternalResourceViewResolver</code>，如下：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;viewResolver&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.web.servlet.view.InternalResourceViewResolver&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;prefix&quot;</span> <span class="attr">value</span>=<span class="string">&quot;/WEB-INF/templates/&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;suffix&quot;</span> <span class="attr">value</span>=<span class="string">&quot;.jsp&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>以下程序返回逻辑视图名：index</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/index&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">toIndex</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;index&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最终逻辑视图名<code>index</code>转换为物理视图名：<code>/WEB-INF/templates/index.jsp</code></p>
<h1 id="2-Thymeleaf视图"><a href="#2-Thymeleaf视图" class="headerlink" title="2. Thymeleaf视图"></a>2. Thymeleaf视图</h1><p>我们在学习前面内容的时候，采用的都是Thymeleaf视图。我们再来测试一下，看看底层创建的视图对象是不是<code>ThymeleafView</code>。</p>
<p>1、springmvc.xml配置内容如下：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/context https://www.springframework.org/schema/context/spring-context.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--组件扫描--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">&quot;com.muyoukule.controller&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--视图解析器--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;thymeleafViewResolver&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.thymeleaf.spring6.view.ThymeleafViewResolver&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;characterEncoding&quot;</span> <span class="attr">value</span>=<span class="string">&quot;UTF-8&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;order&quot;</span> <span class="attr">value</span>=<span class="string">&quot;1&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;templateEngine&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;org.thymeleaf.spring6.SpringTemplateEngine&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;templateResolver&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;org.thymeleaf.spring6.templateresolver.SpringResourceTemplateResolver&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;prefix&quot;</span> <span class="attr">value</span>=<span class="string">&quot;/WEB-INF/templates/&quot;</span>/&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;suffix&quot;</span> <span class="attr">value</span>=<span class="string">&quot;.html&quot;</span>/&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;templateMode&quot;</span> <span class="attr">value</span>=<span class="string">&quot;HTML&quot;</span>/&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;characterEncoding&quot;</span> <span class="attr">value</span>=<span class="string">&quot;UTF-8&quot;</span>/&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>2、Controller代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IndexController</span> &#123;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/index&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toIndex</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;index&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>3、视图页面：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span> <span class="attr">xmlns:th</span>=<span class="string">&quot;http://www.thymeleaf.org&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>首页<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>SpringMVC视图实现原理<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>4、添加断点：在<code>DispatcherServlet</code>的<code>doDispatch</code>方法的下图位置添加断点</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/%E5%9C%A8doDispatch%E6%96%B9%E6%B3%95%E6%B7%BB%E5%8A%A0%E6%96%AD%E7%82%B9.png" alt="在doDispatch方法添加断点"></p>
<p>5、启动Tomcat，在浏览器地址栏上发送请求：<a href="http://localhost:8080/springmvc/index">http://localhost:8080/springmvc/index</a></p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/%E5%8F%91%E9%80%81%E8%AF%B7%E6%B1%82%E7%A8%8B%E5%BA%8F%E5%88%B0%E8%BE%BE%E4%BD%8D%E7%BD%AE.png" alt="发送请求程序到达位置"></p>
<p>程序走到以上位置，这行代码是调用对应的Controller，并且Controller最终会返回<code>ModelAndView</code>对象：<code>mv</code></p>
<p>6、按照我们之前所讲，返回<code>mv</code>之后，接下来就是视图处理与渲染，接着往下走，走到下图这一行：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/%E5%A4%84%E7%90%86%E5%88%86%E5%8F%91%E7%BB%93%E6%9E%9C%E7%9A%84%E6%96%B9%E6%B3%95.png" alt="处理分发结果的方法"></p>
<p>7、这个方法的作用是处理分发结果，就是在这个方法当中进行了视图的处理与渲染，进入该方法：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/%E8%BF%9B%E5%85%A5%E5%A4%84%E7%90%86%E5%88%86%E5%8F%91%E7%BB%93%E6%9E%9C%E7%9A%84%E6%96%B9%E6%B3%95.png" alt="进入处理分发结果的方法"></p>
<p>8、进去之后走到上图位置：这个方法就是用来渲染页面的方法，再进入该方法：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/%E8%BF%9B%E5%85%A5%E7%94%A8%E6%9D%A5%E6%B8%B2%E6%9F%93%E9%A1%B5%E9%9D%A2%E7%9A%84%E6%96%B9%E6%B3%95.png" alt="进入用来渲染页面的方法"></p>
<p>走到上图位置就可以看到底层创建的是<code>ThymeleafView</code>对象。</p>
<h1 id="3-JSP视图（了解）"><a href="#3-JSP视图（了解）" class="headerlink" title="3. JSP视图（了解）"></a>3. JSP视图（了解）</h1><p>我们再来跟一下源码，看看JSP视图底层创建的是不是<code>InternalResourceView</code>对象。</p>
<p>我们前面说过 <code>InternalResourceView</code> 是SpringMVC框架内置的，翻译为内部资源视图，SpringMVC把JSP看做是内部资源。可见JSP在之前的技术栈中有很高的地位。</p>
<p>不过，当下流行的开发中JSP使用较少，这里不再详细讲解。只是测试一下。</p>
<p>1、springmvc.xml配置如下：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/context https://www.springframework.org/schema/context/spring-context.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--组件扫描--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">&quot;com.muyoukule.controller&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--JSP的视图解析器--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;jspViewResolver&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.web.servlet.view.InternalResourceViewResolver&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;prefix&quot;</span> <span class="attr">value</span>=<span class="string">&quot;/WEB-INF/jsp/&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;suffix&quot;</span> <span class="attr">value</span>=<span class="string">&quot;.jsp&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    </span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>2、Controller代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IndexController</span> &#123;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/index&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toIndex</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;index&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>3、视图页面：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">&lt;%--</span><br><span class="line">  Created by IntelliJ IDEA.</span><br><span class="line">  User: muyoukule</span><br><span class="line">  Date: 2024/4/7</span><br><span class="line">  Time: 12:29</span><br><span class="line">  To change this template use File | Settings | File Templates.</span><br><span class="line">--%&gt;</span><br><span class="line">&lt;%@ page contentType=&quot;text/html;charset=UTF-8&quot; language=&quot;java&quot; %&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Jsp页面<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>我的第N个Jsp页面<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>4、启动web容器，添加断点跟踪：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/%E6%B7%BB%E5%8A%A0%E6%96%AD%E7%82%B9%E6%B5%8B%E8%AF%95JSP%E8%A7%86%E5%9B%BE%E5%BA%95%E5%B1%82%E5%88%9B%E5%BB%BA%E7%9A%84%E5%AF%B9%E8%B1%A1.png" alt="添加断点测试JSP视图底层创建的对象"></p>
<p>通过测试得知：对于JSP视图来说，底层创建的视图对象是<code>InternalResourceView</code>。</p>
<h1 id="4-转发与重定向"><a href="#4-转发与重定向" class="headerlink" title="4. 转发与重定向"></a>4. 转发与重定向</h1><h2 id="4-1-回顾转发和重定向区别"><a href="#4-1-回顾转发和重定向区别" class="headerlink" title="4.1 回顾转发和重定向区别"></a>4.1 回顾转发和重定向区别</h2><ul>
<li><p>转发是一次请求。因此浏览器地址栏上的地址不会发生变化；重定向是两次请求。因此浏览器地址栏上的地址会发生变化</p>
</li>
<li><p>转发的代码实现：<code>request.getRequestDispatcher(&quot;/index&quot;).forward(request, response)</code>；重定向的代码实现：<code>response.sendRedirect(&quot;/webapproot/index&quot;)</code></p>
</li>
<li><p>转发是服务器内部资源跳转，由服务器来控制。不可实现跨域访问；重定向可以完成内部资源的跳转，也可以完成跨域跳转</p>
</li>
<li><p>转发的方式<code>可以访问WEB-INF</code>目录下受保护的资源；重定向相当于浏览器重新发送了一次请求，在浏览器直接发送的请求是<code>无法访问WEB-INF目录</code>下受保护的资源的</p>
<p>转发原理：</p>
<ul>
<li>假设发送了 <code>/a</code> 请求，执行了 AServlet</li>
<li>在AServlet 中通过<code>request.getRequestDispatcher(&quot;/b&quot;).forward(request,response)</code>；转发到BServlet</li>
<li>从AServlet跳转到BServlet是服务器内部来控制的。对于浏览器而言，浏览器只发送了一个 <code>/a</code> 请求</li>
</ul>
<p>重定向原理：</p>
<ul>
<li>假设发送了 <code>/a</code> 请求，执行了 AServlet</li>
<li>在AServlet 中通过<code>response.sendRedirect(&quot;/webapproot/b&quot;)</code>重定向到BServlet</li>
<li>此时服务器会将请求路径<code>/webapproot/b</code>响应给浏览器</li>
<li>浏览器会自发的再次发送<code>/webapproot/b</code>请求来访问BServlet</li>
<li>因此对于重定向来说，发送了两次请求，一次是 <code>/webapproot/a</code>，另一次是<code>/webapproot/b</code>。</li>
</ul>
</li>
</ul>
<p>以上所描述的是使用原生Servlet API来完成转发和重定向。在Spring MVC中是如何转发和重定向的呢？</p>
<h2 id="4-2-forward"><a href="#4-2-forward" class="headerlink" title="4.2 forward"></a>4.2 forward</h2><p>在Spring MVC中默认就是转发的方式，我们之前所写的程序，都是转发的方式。只不过都是转发到Thymeleaf的模板文件xxx.html上。</p>
<p>那么，在Spring MVC中如何转发到另一个Controller上呢？可以使用Spring MVC的<code>forward</code></p>
<p>1、代码实现如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ForwardController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/a&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toA</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 返回的是一个逻辑视图名称</span></span><br><span class="line">        <span class="comment">//return &quot;a&quot;;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 采用SpringMVC的转发方式跳转到 /b</span></span><br><span class="line">        <span class="comment">// 转发的时候，格式有特殊要求： return &quot;forward:下一个资源的路径&quot;;</span></span><br><span class="line">        <span class="comment">// 这个就不是逻辑视图名称了。</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;forward:/b&quot;</span>; <span class="comment">// 创建InternalResourceView对象。</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/b&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toB</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 返回的是一个逻辑视图名称</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;b&quot;</span>; <span class="comment">// 创建ThymeleafView对象。</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>2、视图页面：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span> <span class="attr">xmlns:th</span>=<span class="string">&quot;http://www.thymeleaf.org&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>b<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Page B!!!<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>3、启动服务器，浏览器地址栏上输入：<a href="http://localhost:8080/springmvc/a">http://localhost:8080/springmvc/a</a></p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/%E8%AF%B7%E6%B1%82a%E8%BD%AC%E5%8F%91%E5%88%B0b.png"></p>
<p>通过测试，可以顺利的完成转发，转发是一次请求，可以看到地址栏上的<strong>地址没有发生改变</strong>。</p>
<blockquote>
<p>源码剖析</p>
</blockquote>
<p>我们来跟踪一下源码，看看以上程序执行过程中，创建了几个视图对象，分别是什么？</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/%E8%BD%AC%E5%8F%91%E8%AF%B7%E6%B1%82%E5%88%9B%E5%BB%BAInternalResourceView%E5%AF%B9%E8%B1%A1.png" alt="转发请求创建InternalResourceView对象"></p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/%E8%BD%AC%E5%8F%91%E8%AF%B7%E6%B1%82%E5%88%9B%E5%BB%BAThymeleafView%E5%AF%B9%E8%B1%A1.png" alt="转发请求创建ThymeleafView对象"></p>
<p>通过源码的跟踪得知：整个请求处理过程中，一共创建了两个视图对象</p>
<ul>
<li>InternalResourceView</li>
<li>ThymeleafView</li>
</ul>
<p>这说明<strong>转发</strong>底层创建的视图对象是：<code>InternalResourceView</code>。</p>
<blockquote>
<p>思考</p>
</blockquote>
<p>既然会创建InternalResourceView，应该会对应一个视图解析器呀（InternalResourceViewResolver）？但是我在springmvc.xml文件中只配置了ThymeleafViewResolver，并没有配置InternalResourceViewResolver呀？这是为什么？</p>
<p><font color="red"><strong>这是因为<code>forward:</code> 后面的不是<code>逻辑视图名</code>，而是一个<code>请求路径</code>。因此转发是不需要视图解析器的。</strong>😁另外，转发使用的是InternalResourceView，也说明了<strong>转发是内部资源的跳转</strong>。（Internal是内部的意思，Resource是资源的意思。）</font></p>
<h2 id="4-3-redirect"><a href="#4-3-redirect" class="headerlink" title="4.3 redirect"></a>4.3 redirect</h2><p>redirect是专门完成重定向效果的。和forward语法类似，只需要将之前的 <code>return &quot;forward:/b&quot;</code>修改为 <code>return &quot;redirect:/b&quot;</code>即可。</p>
<p>1、Controller代码：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IndexController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/a&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toA</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;redirect:/b&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/b&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toB</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;b&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>2、视图页面：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span> <span class="attr">xmlns:th</span>=<span class="string">&quot;http://www.thymeleaf.org&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>b<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Page B!!!<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>3、启动服务器，浏览器地址栏上输入：<a href="http://localhost:8080/springmvc/a">http://localhost:8080/springmvc/a</a></p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/%E8%AF%B7%E6%B1%82a%E9%87%8D%E5%AE%9A%E5%90%91%E5%88%B0b.png" alt="请求a重定向到b"></p>
<p>可见，重定向是两次请求，地址栏上的<strong>地址发生了改变</strong>。</p>
<blockquote>
<p>源码剖析</p>
</blockquote>
<p>可以看一下源码，在重定向的时候，Spring MVC创建哪个视图对象？</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/%E9%87%8D%E5%AE%9A%E5%90%91%E8%AF%B7%E6%B1%82%E5%88%9B%E5%BB%BARedirectView%E5%AF%B9%E8%B1%A1.png" alt="重定向请求创建RedirectView对象"></p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/%E9%87%8D%E5%AE%9A%E5%90%91%E8%AF%B7%E6%B1%82%E5%88%9B%E5%BB%BAThymeleafView%E5%AF%B9%E8%B1%A1.png" alt="重定向请求创建ThymeleafView对象"></p>
<p>通过断点调试可以看出，当重定向的时候，SpringMVC会创建一个<strong>重定向</strong>视图对象：**<code>RedirectView</code>**。这个视图对象也是SpringMVC框架内置的。</p>
<p>另外可以看出重定向之后的第二次请求创建的视图对象就是<code>ThymeleafView</code>了。</p>
<p><strong>PS：从springmvc应用重定向到springmvc2应用（跨域），</strong>语法是：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/a&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">a</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;redirect:http://localhost:8080/springmvc2/b&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以自行测试一下！！！</p>
<h1 id="5"><a href="#5" class="headerlink" title="5. &lt;mvc:view-controller&gt;"></a>5. &lt;mvc:view-controller&gt;</h1><p><code>&lt;mvc:view-controller&gt;</code> 配置用于将某个请求映射到特定的视图上，即指定某一个 URL 请求到一个视图资源的映射，使得这个视图资源可以被访问。它相当于是一个独立的处理程序，不需要编写任何 Controller，只需要指定 URL 和对应的视图名称就可以了。</p>
<p>一般情况下，<code>&lt;mvc:view-controller&gt;</code> 配置可以替代一些没有业务逻辑的 Controller，例如首页、错误页面等。当用户访问配置的 URL 时，框架将直接匹配到对应的视图，而无需再经过其他控制器的处理。</p>
<p><code>&lt;mvc:view-controller&gt;</code> 配置的格式如下： </p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mvc:view-controller</span> <span class="attr">path</span>=<span class="string">&quot;/如何访问该页面&quot;</span> <span class="attr">view-name</span>=<span class="string">&quot;对应的逻辑视图名称&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<p>其中：</p>
<ul>
<li><code>path</code>：被映射的 URL 路径。</li>
<li><code>view-name</code>：对应的逻辑视图名称。</li>
</ul>
<p>例如，配置首页的映射：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mvc:view-controller</span> <span class="attr">path</span>=<span class="string">&quot;/&quot;</span> <span class="attr">view-name</span>=<span class="string">&quot;index&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<p>上述配置将会匹配上访问应用程序的根路径，如：<a href="http://localhost:8080/%E3%80%82%E5%BD%93%E7%94%A8%E6%88%B7%E5%9C%A8%E6%B5%8F%E8%A7%88%E5%99%A8%E4%B8%AD%E8%AE%BF%E9%97%AE%E8%AF%A5%E6%A0%B9%E8%B7%AF%E5%BE%84%E6%97%B6%EF%BC%8C%E5%B0%B1%E4%BC%9A%E7%9B%B4%E6%8E%A5%E6%B8%B2%E6%9F%93%E5%90%8D%E4%B8%BA">http://localhost:8080/。当用户在浏览器中访问该根路径时，就会直接渲染名为</a> <code>index</code> 的视图。</p>
<p><font color="red"><strong>PS：当你使用了 &lt;<code>mvc:view-controller</code>&gt; 配置，会让你整个项目中所有的注解全部失效，你需要使用以下的配置来再次开启注解。</strong></font></p>
<h1 id="6"><a href="#6" class="headerlink" title="6. &lt;mvc:annotation-driven&#x2F;&gt;"></a>6. &lt;mvc:annotation-driven&#x2F;&gt;</h1><p>在SpringMVC中，如果在springmvc.xml文件中配置了 <code>&lt;mvc:view-controller&gt;</code>，就需要同时在springmvc.xml文件中添加如下配置：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mvc:annotation-driven</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<p>该配置的作用是：启用Spring MVC的注解。</p>
<p><strong>如果没有以上的配置，Controller就无法访问到。</strong>访问之前的Controller会发生 404 问题。</p>
<h1 id="7-访问静态资源"><a href="#7-访问静态资源" class="headerlink" title="7. 访问静态资源"></a>7. 访问静态资源</h1><p>一个项目可能会包含大量的静态资源，比如：css、js、images等。</p>
<p>由于我们DispatcherServlet的url-pattern配置的是<code>/</code>，之前我们说过，这个<code>/</code>代表的是除jsp请求之外的所有请求，也就是说访问应用中的静态资源，也会走DispatcherServlet，这会导致404错误，无法访问静态资源，如何解决，两种方案：</p>
<ul>
<li>使用默认 Servlet 处理静态资源</li>
<li>使用 <code>mvc:resources</code> 标签配置静态资源处理</li>
</ul>
<p>这两种方式都可以，自行选择。</p>
<h2 id="7-1-使用默认Servlet处理静态资源"><a href="#7-1-使用默认Servlet处理静态资源" class="headerlink" title="7.1 使用默认Servlet处理静态资源"></a>7.1 使用默认Servlet处理静态资源</h2><p>首先需要在springmvc.xml文件中添加以下配置，开启 <code>默认Servlet处理静态资源</code> 功能：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 开启注解驱动 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mvc:annotation-driven</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--开启默认Servlet处理--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mvc:default-servlet-handler</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>然后在web.xml文件中指定什么样的路径走其他Servlet：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>default<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>org.apache.catalina.servlets.DefaultServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>debug<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>0<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>listings<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>false<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">load-on-startup</span>&gt;</span>1<span class="tag">&lt;/<span class="name">load-on-startup</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>default<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>以上配置url-pattern使用的也是<code>/</code>，和DispatcherServlet一样。表示的含义是：<font color="red"><strong>同一个请求路径，先走DispatcherServlet，如果找不到则走默认的Servlet。</strong></font></p>
<p>默认的 Servlet 类中的代码已经由 Tomcat 服务器提供了实现，一般不需要开发者自己编写。在上面的示例中，我们指定了 <code>org.apache.catalina.servlets.DefaultServlet</code>，则 Tomcat 服务器会自动将请求转发给该类处理。在处理时，该类会根据请求的 URL 去查询 Web 应用的静态资源（如 HTML、CSS、JavaScript 和图片等），并将其返回给用户。</p>
<p>告诉大家一个好消息，以上在web.xml文件中的配置我们也可以省略了，因为在Tomcat服务器中已经为我们提前配置好了，在<code>CATALINA_HOME/conf/web.xml</code>文件中，如下：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/Tomcat%E8%87%AA%E5%B8%A6%E7%9A%84servlet%E9%85%8D%E7%BD%AE%E9%A1%B9.png" alt="Tomcat自带的servlet配置项" style="zoom: 80%;">

<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/Tomcat%E8%87%AA%E5%B8%A6%E7%9A%84servlet-mapping%E9%85%8D%E7%BD%AE%E9%A1%B9.png" alt="Tomcat自带的servlet-mapping配置项"></p>
<p>因此我们只需要在springmvc.xml文件中启用这个默认的Servlet即可：<code>&lt;mvc:default-servlet-handler&gt;</code></p>
<h2 id="7-2-使用-mvc-resources-标签配置静态资源"><a href="#7-2-使用-mvc-resources-标签配置静态资源" class="headerlink" title="7.2 使用 mvc:resources 标签配置静态资源"></a>7.2 使用 mvc:resources 标签配置静态资源</h2><p>访问静态资源，也可以在springmvc.xml文件中添加如下的配置：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 开启注解驱动 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mvc:annotation-driven</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 配置静态资源处理 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mvc:resources</span> <span class="attr">mapping</span>=<span class="string">&quot;/static/**&quot;</span> <span class="attr">location</span>=<span class="string">&quot;/static/&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<p>表示凡是请求路径是<code>/static/</code>开始的，都会去<code>/static/</code>目录下找该资源。</p>
<p><font color="red">PS：要想使用 <code>&lt;mvc:resources&gt;</code> 配置，必须开启注解驱动 <code>&lt;mvc:annotation-driven /&gt;</code></font></p>
<h1 id="附录：视图机制源码跟踪"><a href="#附录：视图机制源码跟踪" class="headerlink" title="附录：视图机制源码跟踪"></a>附录：视图机制源码跟踪</h1><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DispatcherServlet</span> <span class="keyword">extends</span> <span class="title class_">FrameworkServlet</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 前端控制器的核心方法，处理请求，返回视图，渲染视图，都是在这个方法中完成的。</span></span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doDispatch</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">		</span><br><span class="line">		<span class="comment">// 根据请求路径调用映射的处理器方法，处理器方法执行结束之后，返回逻辑视图名称</span></span><br><span class="line">		<span class="comment">// 返回逻辑视图名称之后，DispatcherServlet会将 逻辑视图名称ViewName + Model，将其封装为ModelAndView对象。</span></span><br><span class="line">		mv = ha.handle(processedRequest, response, mappedHandler.getHandler());</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 这行代码的作用是处理视图</span></span><br><span class="line">		processDispatchResult(processedRequest, response, mappedHandler, mv, dispatchException);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">processDispatchResult</span><span class="params">(HttpServletRequest request, HttpServletResponse response,</span></span><br><span class="line"><span class="params">			<span class="meta">@Nullable</span> HandlerExecutionChain mappedHandler, <span class="meta">@Nullable</span> ModelAndView mv,</span></span><br><span class="line"><span class="params">			<span class="meta">@Nullable</span> Exception exception)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		<span class="comment">// 渲染页面（将模板字符串转换成html代码响应到浏览器）</span></span><br><span class="line">		render(mv, request, response);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">render</span><span class="params">(ModelAndView mv, HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		<span class="comment">// 这个方法的作用是将 逻辑视图名称 转换成 物理视图名称 ，并且最终返回视图对象View</span></span><br><span class="line">		<span class="type">View</span> <span class="variable">view</span> <span class="operator">=</span> resolveViewName(viewName, mv.getModelInternal(), locale, request);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 真正的将模板字符串转换成HTML代码，并且将HTML代码响应给浏览器。（真正的渲染。）</span></span><br><span class="line">		view.render(mv.getModelInternal(), request, response);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">protected</span> View <span class="title function_">resolveViewName</span><span class="params">(String viewName, <span class="meta">@Nullable</span> Map&lt;String, Object&gt; model,</span></span><br><span class="line"><span class="params">			Locale locale, HttpServletRequest request)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		<span class="comment">// 其实这一行代码才是真正起作用的：将 逻辑视图名称 转换成 物理视图名称 ，并且最终返回视图对象View</span></span><br><span class="line">		ViewResolver viewResolver;  <span class="comment">// 底层会创建一个ThymeleafViewResolver</span></span><br><span class="line">		<span class="comment">// 如果使用的是Thymeleaf，那么返回的视图对象：ThymeleafView对象。</span></span><br><span class="line">		<span class="type">View</span> <span class="variable">view</span> <span class="operator">=</span> viewResolver.resolveViewName(viewName, locale); </span><br><span class="line">		<span class="keyword">return</span> view;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 这是一个接口（负责视图解析的）</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ViewResolver</span> &#123; <span class="comment">// 如果使用Thymeleaf，那么该接口的实现类就是：ThymeleafViewResolver</span></span><br><span class="line">	<span class="comment">// 这个方法就是将:逻辑视图名称 转换成 物理视图名称 ，并且最终返回视图对象View</span></span><br><span class="line">	View <span class="title function_">resolveViewName</span><span class="params">(String viewName, Locale locale)</span> <span class="keyword">throws</span> Exception;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 这是一个接口（负责将 模板字符串 转换成HTML代码，响应给浏览器）</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">View</span> &#123;</span><br><span class="line">	<span class="keyword">void</span> <span class="title function_">render</span><span class="params">(<span class="meta">@Nullable</span> Map&lt;String, ?&gt; model, HttpServletRequest request, HttpServletResponse response)</span></span><br><span class="line">			<span class="keyword">throws</span> Exception;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	核心类：DispatcherServlet</span></span><br><span class="line"><span class="comment">	核心接口1：ViewResolver（如果你使用的是Thymeleaf，那么底层会创建ThymeleafViewResolver对象）</span></span><br><span class="line"><span class="comment">	核心接口2：View（如果你使用的是Thymeleaf，那么底层会创建ThymeleafView对象）</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">	结论：如果你自己想实现属于自己的视图。你至少需要编写两个类，</span></span><br><span class="line"><span class="comment">		一个类实现ViewResolver接口，实现其中的resolveViewName方法。</span></span><br><span class="line"><span class="comment">		另一个类实现View接口，实现其中的render方法。</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>Java</category>
        <category>SSM</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>Spring</tag>
        <tag>SpringMVC</tag>
      </tags>
  </entry>
  <entry>
    <title>【第4章】 三个域对象</title>
    <url>/posts/3035/</url>
    <content><![CDATA[<p>参考视频：<a href="https://www.bilibili.com/video/BV1sC411L76f/">SpringMVC教程，SpringMVC从零到精通，老杜SpringMVC，动力节点SpringMVC</a></p>
<h1 id="1-Servlet中的三个域对象"><a href="#1-Servlet中的三个域对象" class="headerlink" title="1. Servlet中的三个域对象"></a>1. Servlet中的三个域对象</h1><ul>
<li><p>请求域：<code>request</code></p>
</li>
<li><p>会话域：<code>session</code></p>
</li>
<li><p>应用域：<code>application</code></p>
</li>
</ul>
<p>三个域都有以下三个方法：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 向域中存储数据</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">setAttribute</span><span class="params">(String name, Object obj)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 从域中读取数据</span></span><br><span class="line">Object <span class="title function_">getAttribute</span><span class="params">(String name)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 删除域中的数据</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">removeAttribute</span><span class="params">(String name)</span>;</span><br></pre></td></tr></table></figure>
<p>主要是通过：<code>setAttribute + getAttribute</code> 方法来完成在域中数据的<strong>传递</strong>和<strong>共享</strong>。</p>
<h2 id="1-1-request"><a href="#1-1-request" class="headerlink" title="1.1 request"></a>1.1 request</h2><p>接口名：<code>HttpServletRequest</code></p>
<p>简称：<code>request</code></p>
<p>request对象代表了一次请求。一次请求一个request。</p>
<p>使用请求域的业务场景：在A资源中通过转发的方式跳转到B资源，因为是转发，因此从A到B是一次请求，如果想让A资源和B资源共享同一个数据，可以将数据存储到request域中。</p>
<h2 id="1-2-session"><a href="#1-2-session" class="headerlink" title="1.2 session"></a>1.2 session</h2><p>接口名：<code>HttpSession</code></p>
<p>简称：<code>session</code></p>
<p>session对象代表了一次会话。从打开浏览器开始访问，到最终浏览器关闭，这是一次完整的会话。每个会话session对象都对应一个JSESSIONID，而JSESSIONID生成后以cookie的方式存储在浏览器客户端。浏览器关闭，JSESSIONID失效，会话结束。</p>
<p>使用会话域的业务场景：</p>
<ul>
<li>在A资源中通过重定向的方式跳转到B资源，因为是重定向，因此从A到B是两次请求，如果想让A资源和B资源共享同一个数据，可以将数据存储到session域中。</li>
<li>登录成功后保存用户的登录状态。</li>
</ul>
<h2 id="1-3-application"><a href="#1-3-application" class="headerlink" title="1.3 application"></a>1.3 application</h2><p>接口名：<code>ServletContext</code></p>
<p>简称：<code>application</code></p>
<p>application对象代表了整个web应用，服务器启动时创建，服务器关闭时销毁。对于一个web应用来说，application对象只有一个。</p>
<p>使用应用域的业务场景：记录网站的在线人数。</p>
<h1 id="2-request域对象"><a href="#2-request域对象" class="headerlink" title="2. request域对象"></a>2. request域对象</h1><p>在SpringMVC中，在<code>request</code>域中共享数据有以下几种方式：</p>
<ul>
<li>使用原生Servlet API方式</li>
<li>使用Model接口</li>
<li>使用Map接口</li>
<li>使用ModelMap类</li>
<li>使用ModelAndView类</li>
</ul>
<h2 id="2-1-使用原生Servlet-API方式"><a href="#2-1-使用原生Servlet-API方式" class="headerlink" title="2.1 使用原生Servlet API方式"></a>2.1 使用原生Servlet API方式</h2><p>1、新建一个模块（步骤参考前面模块），创建 <code>IndexController</code> 和 <code>index.html</code>，代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IndexController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">index</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;index&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2、创建index.html并添加超链接：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span> <span class="attr">xmlns:th</span>=<span class="string">&quot;http://www.thymeleaf.org&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>index<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>测试三个域对象<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">hr</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>测试request域对象<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">th:href</span>=<span class="string">&quot;@&#123;/testServletAPI&#125;&quot;</span>&gt;</span>测试在SpringMVC当中使用原生Servlet API完成request域数据共享<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>3、在Controller的方法上使用<code>HttpServletRequest</code>：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RequestScopeTestController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/testServletAPI&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">testServletAPI</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">        <span class="comment">// 向request域中存储数据</span></span><br><span class="line">        request.setAttribute(<span class="string">&quot;testRequestScope&quot;</span>, <span class="string">&quot;在SpringMVC中使用原生Servlet API实现request域数据共享&quot;</span>);</span><br><span class="line">        <span class="comment">// 跳转视图，在视图页面将request域中的数据取出来，这样就完成了：Controller和View在同一个请求当中两个组件之间数据的共享。</span></span><br><span class="line">        <span class="comment">// 这个跳转，默认情况下是：转发的方式。（转发forward是一次请求）</span></span><br><span class="line">        <span class="comment">// 这个返回的是一个逻辑视图名称，经过视图解析器解析，变成物理视图名称。/WEB-INF/thymeleaf/view.html</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;view&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>4、创建view.html页面：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span> <span class="attr">xmlns:th</span>=<span class="string">&quot;http://www.thymeleaf.org&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>view<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;testRequestScope&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>5、启动服务器，测试结果：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/%E6%B5%8B%E8%AF%95%E4%BD%BF%E7%94%A8%E5%8E%9F%E7%94%9FAPI%E6%96%B9%E5%BC%8F%E5%85%B1%E4%BA%AB%E6%95%B0%E6%8D%AE.png" alt="测试使用原生API方式共享数据"></p>
<p>6、点击链接后成功跳转，并且携带数据：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/%E6%88%90%E5%8A%9F%E8%B7%B3%E8%BD%AC%E4%B8%94%E6%90%BA%E5%B8%A6%E6%95%B0%E6%8D%AE.png" alt="成功跳转且携带数据"></p>
<p>这种方式当然可以，用SpringMVC框架，不建议使用原生Servlet API。</p>
<h2 id="2-2-使用Model接口"><a href="#2-2-使用Model接口" class="headerlink" title="2.2 使用Model接口"></a>2.2 使用Model接口</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/testModel&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">testModel</span><span class="params">(Model model)</span> &#123;</span><br><span class="line">    <span class="comment">// 向request域当中绑定数据</span></span><br><span class="line">    model.addAttribute(<span class="string">&quot;testRequestScope&quot;</span>, <span class="string">&quot;在SpringMVC当中使用Model接口完成request域数据共享&quot;</span>);</span><br><span class="line">    System.out.println(model);</span><br><span class="line">    System.out.println(model.getClass().getName());</span><br><span class="line">    <span class="comment">// 转发</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;view&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在index.html页面添加超链接：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">th:href</span>=<span class="string">&quot;@&#123;/testModel&#125;&quot;</span>&gt;</span>测试在SpringMVC当中使用Model接口完成request域数据共享<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="2-3-使用Map接口"><a href="#2-3-使用Map接口" class="headerlink" title="2.3 使用Map接口"></a>2.3 使用Map接口</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/testMap&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">testMap</span><span class="params">(Map&lt;String, Object&gt; map)</span>&#123;</span><br><span class="line">    <span class="comment">// 向request域当中存储数据</span></span><br><span class="line">    map.put(<span class="string">&quot;testRequestScope&quot;</span>, <span class="string">&quot;在SpringMVC当中使用Map接口完成request域数据共享&quot;</span>);</span><br><span class="line">    System.out.println(map);</span><br><span class="line">    System.out.println(map.getClass().getName());</span><br><span class="line">    <span class="comment">// 转发</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;view&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在index.html页面添加超链接：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">th:href</span>=<span class="string">&quot;@&#123;/testMap&#125;&quot;</span>&gt;</span>测试在SpringMVC当中使用Map接口完成request域数据共享<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="2-4-使用ModelMap类"><a href="#2-4-使用ModelMap类" class="headerlink" title="2.4 使用ModelMap类"></a>2.4 使用ModelMap类</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/testModelMap&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">testModelMap</span><span class="params">(ModelMap modelMap)</span>&#123;</span><br><span class="line">    <span class="comment">// 向request域当中存储数据</span></span><br><span class="line">    modelMap.addAttribute(<span class="string">&quot;testRequestScope&quot;</span>, <span class="string">&quot;在SpringMVC当中使用ModelMap类完成request域数据共享&quot;</span>);</span><br><span class="line">    System.out.println(modelMap);</span><br><span class="line">    System.out.println(modelMap.getClass().getName());</span><br><span class="line">    <span class="comment">// 转发</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;view&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在index.html页面添加超链接：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">th:href</span>=<span class="string">&quot;@&#123;/testModelMap&#125;&quot;</span>&gt;</span>测试在SpringMVC当中使用ModelMap类完成request域数据共享<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>Model、Map、ModelMap的关系</p>
</blockquote>
<p>可以在以上Model、Map、ModelMap的测试程序中将其和其类名输出，看看输出什么：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;testRequestScope=在SpringMVC当中使用Model接口完成request域数据共享&#125;</span><br><span class="line">org.springframework.validation.support.BindingAwareModelMap</span><br><span class="line"></span><br><span class="line">&#123;testRequestScope=在SpringMVC当中使用Map接口完成request域数据共享&#125;</span><br><span class="line">org.springframework.validation.support.BindingAwareModelMap</span><br><span class="line"></span><br><span class="line">&#123;testRequestScope=在SpringMVC当中使用ModelMap类完成request域数据共享&#125;</span><br><span class="line">org.springframework.validation.support.BindingAwareModelMap</span><br></pre></td></tr></table></figure>

<p>通过输出结果可以看出，无论是Model、Map还是ModelMap，底层实例化的对象都是：<code>BindingAwareModelMap</code></p>
<p>可以查看<code>BindingAwareModelMap</code>的继承结构：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/BindingAwareModelMap%E7%BB%A7%E6%89%BF%E7%BB%93%E6%9E%84.png" alt="BindingAwareModelMap继承结构" style="zoom:50%;">

<p>通过继承结构可以看出：<code>BindingAwareModelMap</code>继承了<code>ExtendedModelMap</code>，而<code>ExtendedModelMap</code>又继承了<code>ModelMap</code>并且实现了<code>Model</code>接口。<code>ModelMap</code>顶层又有一个<code>Map</code>接口。因此表面上是采用了不同方式，底层本质上是相同的。</p>
<p>SpringMVC之所以提供了这些方式，目的就是方便程序员的使用，提供了多样化的方式，可见它的重要性。</p>
<h2 id="2-5-使用ModelAndView类"><a href="#2-5-使用ModelAndView类" class="headerlink" title="2.5 使用ModelAndView类"></a>2.5 使用ModelAndView类</h2><p>在SpringMVC框架中为了更好的体现MVC架构模式，提供了一个类：<code>ModelAndView</code>。这个类的实例封装了Model和View。也就是说这个类既封装业务处理之后的数据，也体现了跳转到哪个视图。使用它也可以完成request域数据共享。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/testModelAndView&quot;)</span></span><br><span class="line"><span class="keyword">public</span> ModelAndView <span class="title function_">testModelAndView</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="comment">// 创建“模型与视图对象”</span></span><br><span class="line">    <span class="type">ModelAndView</span> <span class="variable">modelAndView</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ModelAndView</span>();</span><br><span class="line">    <span class="comment">// 绑定数据</span></span><br><span class="line">    modelAndView.addObject(<span class="string">&quot;testRequestScope&quot;</span>, <span class="string">&quot;在SpringMVC中使用ModelAndView实现request域数据共享&quot;</span>);</span><br><span class="line">    <span class="comment">// 绑定视图</span></span><br><span class="line">    modelAndView.setViewName(<span class="string">&quot;view&quot;</span>);</span><br><span class="line">    <span class="comment">// 返回</span></span><br><span class="line">    <span class="keyword">return</span> modelAndView;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在index.html页面添加超链接：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">th:href</span>=<span class="string">&quot;@&#123;/testModelAndView&#125;&quot;</span>&gt;</span>测试在SpringMVC当中使用ModelAndView类完成request域数据共享<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>这种方式需要注意的是：</p>
<ul>
<li>方法的返回值类型不是String，而是<code>ModelAndView对象</code></li>
<li>ModelAndView不是出现在方法的参数位置，而是在方法体中new的</li>
<li>需要调用addObject向域中存储数据</li>
<li>需要调用setViewName设置视图的名字</li>
</ul>
<blockquote>
<p>ModelAndView源码分析</p>
</blockquote>
<p>以上我们通过了五种方式完成了request域数据共享，包括：<code>原生Servlet API</code>，<code>Model</code>、<code>Map</code>、<code>ModelMap</code>、<code>ModelAndView</code>。</p>
<p>其中后四种：Model、Map、ModelMap、ModelAndView。这四种方式在底层<code>DispatcherServlet</code>调用我们的Controller之后，返回的对象都是<code>ModelAndView</code>，这个可以通过源码进行分析。</p>
<p>在以上四种方式中，拿Model举例，添加断点进行调试：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/%E6%B7%BB%E5%8A%A0%E6%96%AD%E7%82%B9%E8%BF%9B%E8%A1%8C%E8%B0%83%E8%AF%95.png" alt="添加断点进行调试"></p>
<p>debug模式启动服务器，发送请求，走到断点：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/%E8%B5%B0%E5%88%B0%E6%96%AD%E7%82%B9.png" alt="走到断点"></p>
<p>查看VM Stack信息：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/%E6%9F%A5%E7%9C%8BVMStack%E4%BF%A1%E6%81%AF.png" alt="查看VM Stack信息"></p>
<p>查看<code>DispatcherServlet</code>，源码如下：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/DispatcherServlet%E6%BA%90%E7%A0%81.png" alt="DispatcherServlet源码"></p>
<p>可以看到这里，无论你使用哪种方式，最终都要返回一个<code>ModelAndView对象</code>。</p>
<p>PS：大家可以通过以下断点调试方式，采用一级一级返回，最终可以看到都会返回ModelAndView对象。</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/StepOut%E6%8C%89%E9%92%AE.png" alt="Step Out按钮"></p>
<h1 id="3-session域对象"><a href="#3-session域对象" class="headerlink" title="3. session域对象"></a>3. session域对象</h1><p>在SpringMVC中使用<code>session</code>域共享数据，实现方式有多种，其中比较常见的两种方式：</p>
<ul>
<li>使用原生Servlet API</li>
<li>使用SessionAttributes注解</li>
</ul>
<h2 id="3-1-使用原生Servlet-API"><a href="#3-1-使用原生Servlet-API" class="headerlink" title="3.1 使用原生Servlet API"></a>3.1 使用原生Servlet API</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SessionScopeTestController</span> &#123;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/testSessionServletAPI&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">testServletAPI</span><span class="params">(HttpSession session)</span> &#123;</span><br><span class="line">        <span class="comment">// 处理核心业务....</span></span><br><span class="line">        <span class="comment">// 将数据存储到session中</span></span><br><span class="line">        session.setAttribute(<span class="string">&quot;testSessionScope&quot;</span>, <span class="string">&quot;在SpringMVC当中使用原生Servlet API完成session域数据共享&quot;</span>);</span><br><span class="line">        <span class="comment">// 返回逻辑视图名称（这是一个转发的行为）</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;view&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在view.html视图页面添加：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;session.testSessionScope&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>index.html添加超链接：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>测试session域对象<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">th:href</span>=<span class="string">&quot;@&#123;/testSessionServletAPI&#125;&quot;</span>&gt;</span>测试在SpringMVC当中使用原生Servlet API完成session域数据共享<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="3-2-使用SessionAttributes注解"><a href="#3-2-使用SessionAttributes注解" class="headerlink" title="3.2 使用SessionAttributes注解"></a>3.2 使用SessionAttributes注解</h2><p>使用<code>@SessionAttributes</code>注解标注Controller：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="comment">//@SessionAttributes(value = &#123;&quot;x&quot;, &quot;y&quot;&#125;)</span></span><br><span class="line"><span class="meta">@SessionAttributes(&#123;&quot;x&quot;, &quot;y&quot;&#125;)</span> <span class="comment">// 标注x和y都是存放到session域中，而不是request域。</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SessionScopeTestController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/testSessionAttributes&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">testSessionAttributes</span><span class="params">(ModelMap modelMap)</span> &#123;</span><br><span class="line">        <span class="comment">// 处理业务</span></span><br><span class="line">        <span class="comment">// 将数据存储到session域当中</span></span><br><span class="line">        modelMap.addAttribute(<span class="string">&quot;x&quot;</span>, <span class="string">&quot;我是埃克斯&quot;</span>);</span><br><span class="line">        modelMap.addAttribute(<span class="string">&quot;y&quot;</span>, <span class="string">&quot;我是歪&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 返回逻辑视图名称</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;view&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><font color="red"><strong>PS：SessionAttributes注解使用在Controller类上。标注了当key是 x 或者 y 时，数据将被存储到会话<code>session</code>中。如果没有 <code>@SessionAttributes</code>注解，默认存储到<code>request</code>域中。</strong></font>😅</p>
<p>在view.html视图页面添加：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;session.x&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;session.y&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在index.html页面添加超链接：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">th:href</span>=<span class="string">&quot;@&#123;/testSessionAttributes&#125;&quot;</span>&gt;</span>测试在SpringMVC当中使用@SessionAttributes注解完成session域数据共享<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="4-application域对象"><a href="#4-application域对象" class="headerlink" title="4. application域对象"></a>4. application域对象</h1><p>在SpringMVC实现<code>application</code>域数据共享，最常见的方案就是直接使用Servlet API了：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ApplicationScopeTestController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/testApplicationScope&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">testApplicationScope</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">        <span class="comment">// 将数据存储到application域当中</span></span><br><span class="line">        <span class="comment">// 获取application对象，其实就是获取ServletContext对象</span></span><br><span class="line">        <span class="comment">// 怎么获取ServletContext对象？通过request，通过session都可以获取。</span></span><br><span class="line">        <span class="type">ServletContext</span> <span class="variable">application</span> <span class="operator">=</span> request.getServletContext();</span><br><span class="line">        application.setAttribute(<span class="string">&quot;testApplicationScope&quot;</span>, <span class="string">&quot;在SpringMVC中使用ServletAPI实现application域共享&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;view&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在view.html视图页面添加：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;application.testApplicationScope&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在index.html页面添加超链接：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>测试application域对象<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">th:href</span>=<span class="string">&quot;@&#123;/testApplicationScope&#125;&quot;</span>&gt;</span>测试在SpringMVC当中使用Servlet API实现application域数据共享<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>Java</category>
        <category>SSM</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>Spring</tag>
        <tag>SpringMVC</tag>
      </tags>
  </entry>
  <entry>
    <title>【第3章】 获取请求数据</title>
    <url>/posts/56423/</url>
    <content><![CDATA[<p>参考视频：<a href="https://www.bilibili.com/video/BV1sC411L76f/">SpringMVC教程，SpringMVC从零到精通，老杜SpringMVC，动力节点SpringMVC</a></p>
<h1 id="0-思考"><a href="#0-思考" class="headerlink" title="0. 思考"></a>0. 思考</h1><p>假设有这样一个请求：</p>
<p><code>http://localhost:8080/springmvc/register?name=muyoukule&amp;password=123&amp;email=muyoukule@example.com</code></p>
<p>在SpringMVC中应该如何获取请求提交的数据呢？</p>
<p>在SpringMVC中又应该如何获取请求头信息呢？</p>
<p>在SpringMVC中又应该如何获取客户端提交的Cookie数据呢？</p>
<h1 id="1-环境准备"><a href="#1-环境准备" class="headerlink" title="1. 环境准备"></a>1. 环境准备</h1><p>1、创建模块，添加依赖</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.muyoukule<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springmvc-004<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 打包方式设置为war方式 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>war<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>17<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>17<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- Spring MVC依赖 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-webmvc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.1.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--日志框架Logback依赖--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>ch.qos.logback<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>logback-classic<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.5.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--Servlet依赖--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>jakarta.servlet<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jakarta.servlet-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--Spring6和Thymeleaf整合依赖--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.thymeleaf<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>thymeleaf-spring6<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1.2.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>2、添加web支持</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/004%E6%A8%A1%E5%9D%97%E6%B7%BB%E5%8A%A0web%E6%94%AF%E6%8C%81.png" alt="004模块添加web支持" style="zoom: 50%;">

<p>3、编写web.xml文件</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">web-app</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://xmlns.jcp.org/xml/ns/javaee&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_4_0.xsd&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">version</span>=<span class="string">&quot;4.0&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--前端控制器--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>springmvc<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>org.springframework.web.servlet.DispatcherServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--通过初始化参数来指定springmvc配置文件的路径和名字。--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>contextConfigLocation<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>classpath:springmvc.xml<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--在服务器启动的时候初始化DispatcherServlet，提高第一次访问的效率--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">load-on-startup</span>&gt;</span>1<span class="tag">&lt;/<span class="name">load-on-startup</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>springmvc<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">    </span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>4、创建UserController</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserController</span> &#123;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toRegisterPage</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;register&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>5、编写springmvc.xml</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/context https://www.springframework.org/schema/context/spring-context.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--组件扫描--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">&quot;com.muyoukule.controller&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--视图解析器--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;thymeleafViewResolver&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.thymeleaf.spring6.view.ThymeleafViewResolver&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--作用于视图渲染的过程中，可以设置视图渲染后输出时采用的编码字符集--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;characterEncoding&quot;</span> <span class="attr">value</span>=<span class="string">&quot;UTF-8&quot;</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--如果配置多个视图解析器，它来决定优先使用哪个视图解析器，它的值越小优先级越高--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;order&quot;</span> <span class="attr">value</span>=<span class="string">&quot;1&quot;</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--当 ThymeleafViewResolver 渲染模板时，会使用该模板引擎来解析、编译和渲染模板--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;templateEngine&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;org.thymeleaf.spring6.SpringTemplateEngine&quot;</span>&gt;</span></span><br><span class="line">                <span class="comment">&lt;!--用于指定 Thymeleaf 模板引擎使用的模板解析器。模板解析器负责根据模板位置、模板资源名称、文件编码等信息，加载模板并对其进行解析--&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;templateResolver&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;org.thymeleaf.spring6.templateresolver.SpringResourceTemplateResolver&quot;</span>&gt;</span></span><br><span class="line">                        <span class="comment">&lt;!--设置模板文件的位置（前缀）--&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;prefix&quot;</span> <span class="attr">value</span>=<span class="string">&quot;/WEB-INF/templates/&quot;</span>/&gt;</span></span><br><span class="line">                        <span class="comment">&lt;!--设置模板文件后缀（后缀），Thymeleaf文件扩展名不一定是html，也可以是其他，例如txt，大部分都是html--&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;suffix&quot;</span> <span class="attr">value</span>=<span class="string">&quot;.html&quot;</span>/&gt;</span></span><br><span class="line">                        <span class="comment">&lt;!--设置模板类型，例如：HTML,TEXT,JAVASCRIPT,CSS等--&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;templateMode&quot;</span> <span class="attr">value</span>=<span class="string">&quot;HTML&quot;</span>/&gt;</span></span><br><span class="line">                        <span class="comment">&lt;!--用于模板文件在读取和解析过程中采用的编码字符集--&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;characterEncoding&quot;</span> <span class="attr">value</span>=<span class="string">&quot;UTF-8&quot;</span>/&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>6、编写register.html文件</p>
<p>在WEB-INF目录下新建<code>templates</code>目录，在templates目录中新建register.html文件：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span> <span class="attr">xmlns:th</span>=<span class="string">&quot;http://www.thymeleaf.org&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>用户注册<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h3</span>&gt;</span>用户注册<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">hr</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>7、部署测试</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/%E9%83%A8%E7%BD%B2%E6%B5%8B%E8%AF%95.png" alt="部署测试"></p>
<h1 id="2-使用原生的Servlet-API进行获取"><a href="#2-使用原生的Servlet-API进行获取" class="headerlink" title="2. 使用原生的Servlet API进行获取"></a>2. 使用原生的Servlet API进行获取</h1><p>原生的Servlet API指的是：<code>HttpServletRequest</code></p>
<p>在SpringMVC当中，一个Controller类中的方法参数上如果有<code>HttpServletRequest</code>，SpringMVC会自动将<code>当前请求对象</code>传递给这个参数，因此我们可以通过这个参数来获取请求提交的数据。</p>
<blockquote>
<p>测试</p>
</blockquote>
<p>1、在 register.html 中准备一个注册的表单：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span> <span class="attr">xmlns:th</span>=<span class="string">&quot;http://www.thymeleaf.org&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>用户注册<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h3</span>&gt;</span>用户注册<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">hr</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">th:action</span>=<span class="string">&quot;@&#123;/register&#125;&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span><br><span class="line">    用户名：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    密码：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;password&quot;</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    性别：</span><br><span class="line">    男 <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;radio&quot;</span> <span class="attr">name</span>=<span class="string">&quot;sex&quot;</span> <span class="attr">value</span>=<span class="string">&quot;1&quot;</span>&gt;</span></span><br><span class="line">    女 <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;radio&quot;</span> <span class="attr">name</span>=<span class="string">&quot;sex&quot;</span> <span class="attr">value</span>=<span class="string">&quot;0&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    爱好：</span><br><span class="line">    抽烟 <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;checkbox&quot;</span> <span class="attr">name</span>=<span class="string">&quot;hobby&quot;</span> <span class="attr">value</span>=<span class="string">&quot;smoke&quot;</span>&gt;</span></span><br><span class="line">    喝酒 <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;checkbox&quot;</span> <span class="attr">name</span>=<span class="string">&quot;hobby&quot;</span> <span class="attr">value</span>=<span class="string">&quot;drink&quot;</span>&gt;</span></span><br><span class="line">    烫头 <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;checkbox&quot;</span> <span class="attr">name</span>=<span class="string">&quot;hobby&quot;</span> <span class="attr">value</span>=<span class="string">&quot;perm&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    简介：<span class="tag">&lt;<span class="name">textarea</span> <span class="attr">rows</span>=<span class="string">&quot;10&quot;</span> <span class="attr">cols</span>=<span class="string">&quot;60&quot;</span> <span class="attr">name</span>=<span class="string">&quot;intro&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">textarea</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;注册&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>2、先测试这个页面是否可以正常打开，是否可以正常提交数据：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/%E8%BE%93%E5%85%A5%E6%B3%A8%E5%86%8C%E4%BF%A1%E6%81%AF.png" alt="输入注册信息" style="zoom:67%;">

<p>3、点击注册：F12的方式查看是否提交了数据：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/%E6%9F%A5%E7%9C%8B%E6%98%AF%E5%90%A6%E6%8F%90%E4%BA%A4%E4%BA%86%E6%95%B0%E6%8D%AE.png" alt="查看是否提交了数据" style="zoom: 80%;">

<p>通过测试得知：可以正常提交数据。</p>
<p>4、接下来在控制器添加一个方法来处理这个注册的请求：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@PostMapping(value=&quot;/register&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">register</span><span class="params">(HttpServletRequest request)</span>&#123;</span><br><span class="line">    <span class="comment">// 通过当前请求对象获取提交的数据</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;username&quot;</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;password&quot;</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">sex</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;sex&quot;</span>);</span><br><span class="line">    String[] hobbies = request.getParameterValues(<span class="string">&quot;hobby&quot;</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">intro</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;intro&quot;</span>);</span><br><span class="line">    System.out.println(username + <span class="string">&quot;,&quot;</span> + password + <span class="string">&quot;,&quot;</span> + sex + <span class="string">&quot;,&quot;</span> + Arrays.toString(hobbies) + <span class="string">&quot;,&quot;</span> + intro);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>5、提供视图页面：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span> <span class="attr">xmlns:th</span>=<span class="string">&quot;http://www.thymeleaf.org&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>注册成功<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>注册成功<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>6、测试：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/%E8%BE%93%E5%85%A5%E6%B3%A8%E5%86%8C%E4%BF%A1%E6%81%AF.png" alt="输入注册信息" style="zoom:67%;">

<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/%E8%B7%B3%E8%BD%AC%E5%88%B0%E6%B3%A8%E5%86%8C%E6%88%90%E5%8A%9F%E9%A1%B5%E9%9D%A2.png" alt="跳转到注册成功页面" style="zoom: 67%;">

<p>7、控制台打印：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">muyoukule,123,1,[smoke, drink, perm],66666666</span><br></pre></td></tr></table></figure>

<p><strong>这样通过Servlet原生的API获取到提交的数据。但是这种方式不建议使用，因为方法的参数依赖Servlet原生API，Controller的测试将不能单独测试，必须依赖WEB服务器才能测试。另外，换句话说，如果在SpringMVC中使用了原生的Servlet，你为什么还要用SpringMVC框架呢🙄！！！！！</strong></p>
<h1 id="3-使用-RequestParam注解标注"><a href="#3-使用-RequestParam注解标注" class="headerlink" title="3. 使用@RequestParam注解标注"></a>3. 使用@RequestParam注解标注</h1><h2 id="3-1-RequestParam注解的基本使用"><a href="#3-1-RequestParam注解的基本使用" class="headerlink" title="3.1 @RequestParam注解的基本使用"></a>3.1 @RequestParam注解的基本使用</h2><p><code>@RequestParam</code>注解作用：将<code>请求参数</code>与方法上的<code>形参</code>映射</p>
<p>1、修改register方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@PostMapping(value = &quot;/register&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">register</span><span class="params">(</span></span><br><span class="line"><span class="params">        <span class="meta">@RequestParam(value=&quot;username&quot;)</span></span></span><br><span class="line"><span class="params">        String a,</span></span><br><span class="line"><span class="params">        <span class="meta">@RequestParam(value=&quot;password&quot;)</span></span></span><br><span class="line"><span class="params">        String b,</span></span><br><span class="line"><span class="params">        <span class="meta">@RequestParam(value=&quot;sex&quot;)</span></span></span><br><span class="line"><span class="params">        String c,</span></span><br><span class="line"><span class="params">        <span class="meta">@RequestParam(value=&quot;hobby&quot;)</span></span></span><br><span class="line"><span class="params">        String[] d,</span></span><br><span class="line"><span class="params">        <span class="meta">@RequestParam(name=&quot;intro&quot;)</span></span></span><br><span class="line"><span class="params">        String e)</span> &#123;</span><br><span class="line">    System.out.println(a);</span><br><span class="line">    System.out.println(b);</span><br><span class="line">    System.out.println(c);</span><br><span class="line">    System.out.println(Arrays.toString(d));</span><br><span class="line">    System.out.println(e);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>PS：对于<code>@RequestParam</code>注解来说，属性有<code>value</code>和<code>name</code>，这两个属性的作用相同，都是用来指定提交数据的name。</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@AliasFor(&quot;name&quot;)</span></span><br><span class="line">String <span class="title function_">value</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@AliasFor(&quot;value&quot;)</span></span><br><span class="line">String <span class="title function_">name</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>例如：发送请求时提交的数据是：<code>name1=value1&amp;name2=value2</code>，则这个注解应该这样写：<code>@RequestParam(value=&quot;name1&quot;),@RequestParam(value=&quot;name2&quot;)</code></p>
<p>2、启动服务器测试：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/%E8%BE%93%E5%85%A5%E6%B3%A8%E5%86%8C%E4%BF%A1%E6%81%AF2.png" alt="输入注册信息2" style="zoom:67%;">

<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/%E8%B7%B3%E8%BD%AC%E5%88%B0%E6%B3%A8%E5%86%8C%E6%88%90%E5%8A%9F%E9%A1%B5%E9%9D%A2.png" alt="跳转到注册成功页面" style="zoom:80%;">

<p>3、控制台打印：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">muyoukule002</span><br><span class="line">123</span><br><span class="line">1</span><br><span class="line">[smoke, drink]</span><br><span class="line">muyoukule666</span><br></pre></td></tr></table></figure>

<p><font color="red"><strong>PS： <code>@RequestParam(value=&quot;name1&quot;)</code> 中value一定要与前端传过来的参数相同，否则会出错。</strong></font>😨</p>
<p>例如：前端传过来的参数为<code>username</code>，而后端接收参数时写的是<code>@RequestParam(value=&quot;uname&quot;)</code>，就会出现如下错误：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/%E5%89%8D%E5%90%8E%E7%AB%AF%E5%8F%82%E6%95%B0%E4%B8%8D%E5%8C%B9%E9%85%8D%E6%8A%A5%E9%94%99.png" alt="前后端参数不匹配报错"></p>
<h3 id="3-1-1-PathVariable注解"><a href="#3-1-1-PathVariable注解" class="headerlink" title="3.1.1 @PathVariable注解"></a>3.1.1 @PathVariable注解</h3><p>在SpringMVC当中，如果请求的URL使用的是RESTFul风格的，那么这个数据应该在java程序中如何获取呢？使用占位符方式。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(value = &quot;/login/&#123;a&#125;/&#123;b&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">testRESTFulURL</span><span class="params">(</span></span><br><span class="line"><span class="params">        <span class="meta">@PathVariable(&quot;a&quot;)</span></span></span><br><span class="line"><span class="params">        String username,</span></span><br><span class="line"><span class="params">        <span class="meta">@PathVariable(&quot;b&quot;)</span></span></span><br><span class="line"><span class="params">        String password)</span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;用户名：&quot;</span> + username + <span class="string">&quot;，密码：&quot;</span> + password);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;ok&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong><code>@PathVariable</code> 这个注解是可以省略的，如果<font color="red">请求的URL参数的名字和形参的name相同</font>，则 <code>@PathVariable</code> 可以省略。</strong></p>
<p>但有一个前提：如果你采用的是Spring6+版本，你需要在pom.xml文件中指定编译参数<code>-parameter</code>，配置如下：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.12.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">source</span>&gt;</span>17<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">target</span>&gt;</span>17<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">compilerArgs</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">arg</span>&gt;</span>-parameters<span class="tag">&lt;/<span class="name">arg</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">compilerArgs</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><font color="red"><strong>PS：如果你使用的是Spring5的版本，以上的配置是不需要的。</strong></font>😁</p>
<h2 id="3-2-RequestParam注解的required属性"><a href="#3-2-RequestParam注解的required属性" class="headerlink" title="3.2 @RequestParam注解的required属性"></a>3.2 @RequestParam注解的required属性</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">boolean</span> <span class="title function_">required</span><span class="params">()</span> <span class="keyword">default</span> <span class="literal">true</span>;</span><br></pre></td></tr></table></figure>

<p><code>required</code>属性用来设置该方法参数是否为必须的。</p>
<p>默认情况下，这个参数为 <code>true</code>，表示方法参数是必需的。如果请求中缺少对应的参数，则会抛出异常。</p>
<p>可以将其设置为<code>false</code>，false表示不是必须的，如果请求中缺少对应的参数，则方法的参数为<code>null</code>。</p>
<blockquote>
<p>测试</p>
</blockquote>
<p>1、修改register方法，添加一个 age 形参，没有指定 required 属性时，默认是true，表示必需的</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 添加一个 age 形参</span></span><br><span class="line"><span class="meta">@RequestParam(name = &quot;age&quot;)</span> String age</span><br></pre></td></tr></table></figure>

<p>2、启动服务器，但前端表单中<strong>没有填写年龄age的输入框</strong>，我们来看报错信息：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/%E6%9C%AA%E6%8F%90%E4%BE%9B%E5%8F%82%E6%95%B0age%E6%8A%A5%E9%94%99.png" alt="未提供参数age报错"></p>
<p>错误信息告诉我们：参数age是必需的。没有提供这个请求参数，HTTP状态码 400</p>
<p>3、如果将 <code>required</code> 属性设置为 false。则该参数则不是必须的，如果请求参数仍然未提供时，我们来看结果：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 将 required 属性设置为 false</span></span><br><span class="line"><span class="meta">@RequestParam(name = &quot;age&quot;, required = false)</span> String age</span><br><span class="line"></span><br><span class="line"><span class="comment">//打印</span></span><br><span class="line">System.out.println(<span class="string">&quot;age====&gt;&quot;</span> + age);</span><br></pre></td></tr></table></figure>

<p>4、启动服务器，填写信息后<strong>成功</strong>跳转到注册成功页面，控制台打印：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">muyoukule</span><br><span class="line">123</span><br><span class="line">1</span><br><span class="line">[smoke, drink]</span><br><span class="line">muyoukule66666</span><br><span class="line">age====&gt;null</span><br></pre></td></tr></table></figure>

<p>通过测试得知，如果一个参数被设置为<code>不是必需的</code>，当没有提交对应的请求参数时，形参默认值<code>null</code>。</p>
<p>当然，如果请求参数中提供了age，则age为真实提交的数据（<font color="red">PS：未填写信息会返回给后端一个空字符串<code>&quot;&quot;</code></font>）</p>
<p>1、给register.html添加如下输入框：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">年龄：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;number&quot;</span> <span class="attr">name</span>=<span class="string">&quot;age&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>2、重新启动服务器，填写所有信息后点击注册<strong>成功</strong>跳转到注册成功页面，控制台打印：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">muyoukule</span><br><span class="line">123</span><br><span class="line">1</span><br><span class="line">[smoke, drink, perm]</span><br><span class="line">4245</span><br><span class="line">age====&gt;18</span><br></pre></td></tr></table></figure>

<h2 id="3-3-RequestParam注解的defaultValue属性"><a href="#3-3-RequestParam注解的defaultValue属性" class="headerlink" title="3.3 @RequestParam注解的defaultValue属性"></a>3.3 @RequestParam注解的defaultValue属性</h2><p>defaultValue属性用来设置形参的默认值，当<code>没有提供对应的请求参数</code>或者<code>请求参数的值是空字符串&quot;&quot;</code>的时候，方法的形参会采用默认值。</p>
<blockquote>
<p>测试</p>
</blockquote>
<p>1、给age形参的<code>@RequestParam</code>注解添加一个<code>defaultValue = &quot;18&quot;</code>属性</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestParam(name = &quot;age&quot;, required = false,defaultValue = &quot;18&quot;)</span> String age</span><br></pre></td></tr></table></figure>

<p>2、当前端表单中<strong>没有填写年龄age的输入框</strong>，用户正常填写其他信息，点击注册后成功跳转到注册成功界面，控制台打印：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">muyoukule003</span><br><span class="line">123</span><br><span class="line">1</span><br><span class="line">[smoke, drink, perm]</span><br><span class="line">muyoukule003</span><br><span class="line">age====&gt;18</span><br></pre></td></tr></table></figure>

<p>3、给register.html添加如下输入框：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">年龄：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;number&quot;</span> <span class="attr">name</span>=<span class="string">&quot;age&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>4、重新启动服务器</p>
<p>4.1. 当前端页面用户未填写age（提交的age是空字符串<code>&quot;&quot;</code>）的时候，点击注册后成功跳转到注册成功界面，控制台打印：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">muyoukule004</span><br><span class="line">123</span><br><span class="line">1</span><br><span class="line">[smoke, drink, perm]</span><br><span class="line">muyoukule004</span><br><span class="line">age====&gt;18</span><br></pre></td></tr></table></figure>

<p>4.2. 当前端提交的age不是空字符串的时候：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/%E5%A1%AB%E5%86%99age%E6%8F%90%E4%BA%A4%E5%8F%82%E6%95%B0.png" alt="填写age提交参数" style="zoom:67%;">

<p>填写信息后点击注册<strong>成功</strong>跳转到注册成功页面，控制台打印：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">muyoukule005</span><br><span class="line">123</span><br><span class="line">1</span><br><span class="line">[smoke, drink, perm]</span><br><span class="line">muyoukule005</span><br><span class="line">age====&gt;81</span><br></pre></td></tr></table></figure>

<h1 id="4-依靠控制器方法上的形参名来接收"><a href="#4-依靠控制器方法上的形参名来接收" class="headerlink" title="4. 依靠控制器方法上的形参名来接收"></a>4. 依靠控制器方法上的形参名来接收</h1><p><strong><code>@RequestParam</code> 这个注解是可以省略的，如果方法形参的名字和提交数据时的name相同，则 <code>@RequestParam</code> 可以省略。</strong></p>
<p>但有一个前提：如果你采用的是Spring6+版本，你需要在pom.xml文件中指定编译参数<code>-parameter</code>，配置如下：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.12.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">source</span>&gt;</span>17<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">target</span>&gt;</span>17<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">compilerArgs</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">arg</span>&gt;</span>-parameters<span class="tag">&lt;/<span class="name">arg</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">compilerArgs</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><font color="red"><strong>PS：如果你使用的是Spring5的版本，以上的配置是不需要的。</strong></font>😁</p>
<p>Controller中的方法只需要这样写：<font color="red"><strong>形参的名字必须和提交的数据的name一致！！！！！</strong></font></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@PostMapping(value=&quot;/register&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">register</span><span class="params">(String username, String password, String sex, String[] hobby, String intro)</span>&#123;</span><br><span class="line">    System.out.println(username + <span class="string">&quot;,&quot;</span> + password + <span class="string">&quot;,&quot;</span> + sex + <span class="string">&quot;,&quot;</span> + Arrays.toString(hobby) + <span class="string">&quot;,&quot;</span> + intro);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试结果：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/%E4%BE%9D%E9%9D%A0%E6%8E%A7%E5%88%B6%E5%99%A8%E6%96%B9%E6%B3%95%E4%B8%8A%E7%9A%84%E5%BD%A2%E5%8F%82%E5%90%8D%E6%9D%A5%E6%8E%A5%E6%94%B6%E5%8F%82%E6%95%B0.png" alt="依靠控制器方法上的形参名来接收参数" style="zoom:67%;">

<p>填写信息后点击注册<strong>成功</strong>跳转到注册成功页面，控制台打印：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">muyoukule006,123,1,[smoke],muyoukule006</span><br></pre></td></tr></table></figure>

<p>如果形参名和提交的数据的name不一致：</p>
<p>例如前端传过来的参数为<code>username</code>，而后端接收参数时写的是<code>String umane</code>，就会出现<code>uname</code>值为<code>null</code>的情况：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">null,123,1,[smoke],muyoukule007</span><br></pre></td></tr></table></figure>

<p>另外，对于提交的hobby数据，也可以采用String来接收，不一定使用数组方式：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@PostMapping(value=&quot;/register&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">register</span><span class="params">(String username, String password, String sex, String hobby, String intro)</span>&#123;</span><br><span class="line">    System.out.println(username + <span class="string">&quot;,&quot;</span> + password + <span class="string">&quot;,&quot;</span> + sex + <span class="string">&quot;,&quot;</span> + hobby + <span class="string">&quot;,&quot;</span> + intro);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试结果：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">muyoukule008,123,1,smoke,drink,perm,muyoukule008</span><br></pre></td></tr></table></figure>

<p>根据输出结果可以看到多个hobby是采用 <code>,</code> 进行连接的。</p>
<h1 id="5-使用POJO类-JavaBean接收请求参数"><a href="#5-使用POJO类-JavaBean接收请求参数" class="headerlink" title="5. 使用POJO类&#x2F;JavaBean接收请求参数"></a>5. 使用POJO类&#x2F;JavaBean接收请求参数</h1><p>以上方式大家可以看到，当提交的数据非常多时，方法的形参个数会非常多，这不是很好的设计。在SpringMVC中也可以使用 <code>POJO类/JavaBean</code> 来接收请求参数。不过有一个非常重要的要求：<font color="red"><strong><code>POJO类的属性名</code> 必须和 <code>请求参数的参数名</code> 保持一致！！</strong></font>😁</p>
<blockquote>
<p>测试</p>
</blockquote>
<p>1、提供以下的JavaBean：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.muyoukule.pojo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="keyword">private</span> String sex;</span><br><span class="line">    <span class="keyword">private</span> String[] hobby;</span><br><span class="line">    <span class="keyword">private</span> String intro;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">User</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">User</span><span class="params">(Long id, String username, String password, String sex, String[] hobby, String intro)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.id = id;</span><br><span class="line">        <span class="built_in">this</span>.username = username;</span><br><span class="line">        <span class="built_in">this</span>.password = password;</span><br><span class="line">        <span class="built_in">this</span>.sex = sex;</span><br><span class="line">        <span class="built_in">this</span>.hobby = hobby;</span><br><span class="line">        <span class="built_in">this</span>.intro = intro;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">getId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setId</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getUsername</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> username;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUsername</span><span class="params">(String username)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.username = username;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getPassword</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> password;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setPassword</span><span class="params">(String password)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.password = password;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getSex</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> sex;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setSex</span><span class="params">(String sex)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.sex = sex;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String[] getHobby() &#123;</span><br><span class="line">        <span class="keyword">return</span> hobby;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setHobby</span><span class="params">(String[] hobby)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.hobby = hobby;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getIntro</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> intro;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setIntro</span><span class="params">(String intro)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.intro = intro;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;User&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;id=&quot;</span> + id +</span><br><span class="line">                <span class="string">&quot;, username=&#x27;&quot;</span> + username + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, password=&#x27;&quot;</span> + password + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, sex=&#x27;&quot;</span> + sex + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, hobby=&quot;</span> + Arrays.toString(hobby) +</span><br><span class="line">                <span class="string">&quot;, intro=&#x27;&quot;</span> + intro + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2、在控制器方法的形参位置上使用javabean来接收请求参数：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/register&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">register</span><span class="params">(User user)</span>&#123;</span><br><span class="line">    System.out.println(user);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3、执行结果：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/%E4%BD%BF%E7%94%A8POJO%E7%B1%BB%E6%8E%A5%E6%94%B6%E8%AF%B7%E6%B1%82%E5%8F%82%E6%95%B0.png" style="zoom: 67%;">

<p>4、填写信息后点击注册<strong>成功</strong>跳转到注册成功页面，控制台打印：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">User&#123;id=null, username=&#x27;muyoukule&#x27;, password=&#x27;123&#x27;, sex=&#x27;1&#x27;, hobby=[smoke, perm], intro=&#x27;muyoukulehaoshuaia&#x27;&#125;</span><br></pre></td></tr></table></figure>

<p><strong>底层的实现原理：反射机制。先获取请求参数的名字，因为请求参数的名字就是JavaBean的属性名，通过这种方式给对应的属性赋值</strong>。</p>
<blockquote>
<p>测试一下：当JavaBean的属性名和请求参数的参数名不一致时，会出现什么问题？</p>
</blockquote>
<p><font color="red"><strong>PS：getter和setter的方法名不修改，只修改属性名</strong></font>😃</p>
<p>1、修改属性名</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.muyoukule.pojo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String uname;</span><br><span class="line">    <span class="keyword">private</span> String upwd;</span><br><span class="line">    <span class="keyword">private</span> String usex;</span><br><span class="line">    <span class="keyword">private</span> String[] uhobby;</span><br><span class="line">    <span class="keyword">private</span> String uintro;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">User</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">User</span><span class="params">(Long id, String username, String password, String sex, String[] hobby, String intro)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.id = id;</span><br><span class="line">        <span class="built_in">this</span>.uname = username;</span><br><span class="line">        <span class="built_in">this</span>.upwd = password;</span><br><span class="line">        <span class="built_in">this</span>.usex = sex;</span><br><span class="line">        <span class="built_in">this</span>.uhobby = hobby;</span><br><span class="line">        <span class="built_in">this</span>.uintro = intro;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">getId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setId</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getUsername</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> uname;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUsername</span><span class="params">(String username)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.uname = username;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getPassword</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> upwd;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setPassword</span><span class="params">(String password)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.upwd = password;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getSex</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> usex;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setSex</span><span class="params">(String sex)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.usex = sex;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String[] getHobby() &#123;</span><br><span class="line">        <span class="keyword">return</span> uhobby;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setHobby</span><span class="params">(String[] hobby)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.uhobby = hobby;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getIntro</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> uintro;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setIntro</span><span class="params">(String intro)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.uintro = intro;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;User&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;id=&quot;</span> + id +</span><br><span class="line">                <span class="string">&quot;, username=&#x27;&quot;</span> + uname + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, password=&#x27;&quot;</span> + upwd + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, sex=&#x27;&quot;</span> + usex + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, hobby=&quot;</span> + Arrays.toString(uhobby) +</span><br><span class="line">                <span class="string">&quot;, intro=&#x27;&quot;</span> + uintro + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2、测试，填写和上面相同的信息后点击注册<strong>成功</strong>跳转到注册成功页面，控制台打印：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">User&#123;id=null, username=&#x27;muyoukule&#x27;, password=&#x27;123&#x27;, sex=&#x27;1&#x27;, hobby=[smoke, perm], intro=&#x27;muyoukulehaoshuaia&#x27;&#125;</span><br></pre></td></tr></table></figure>

<p><strong>通过测试，我们得知：<code>请求参数名</code> 可以和 <code>JavaBean的属性名</code> 不一致。</strong></p>
<p>1、我们继续将其中一个属性的setter和getter方法名修改一下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 修改前</span></span><br><span class="line"><span class="comment">/*public String getUsername() &#123;</span></span><br><span class="line"><span class="comment">    return uname;</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">public void setUsername(String username) &#123;</span></span><br><span class="line"><span class="comment">    this.uname = username;</span></span><br><span class="line"><span class="comment">&#125;*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 修改后</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getUname</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> uname;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUname</span><span class="params">(String uname)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.uname = uname;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2、再次测试，填写和上面相同的信息后点击注册<strong>成功</strong>跳转到注册成功页面，控制台打印：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">User&#123;id=null, username=&#x27;null&#x27;, password=&#x27;123&#x27;, sex=&#x27;1&#x27;, hobby=[smoke, perm], intro=&#x27;muyoukulehaoshuaia&#x27;&#125;</span><br></pre></td></tr></table></figure>

<p><strong>通过测试可以看到：username属性没有赋上值。可见请求参数是否可以赋值到JavaBean对应的属性上，不是取决于属性名，而是setter方法名</strong>。</p>
<h1 id="6-RequestHeader注解"><a href="#6-RequestHeader注解" class="headerlink" title="6. @RequestHeader注解"></a>6. @RequestHeader注解</h1><p>该注解的作用是：将 <code>请求头信息</code> 映射到 <code>方法的形参上</code>。</p>
<p>和<code>@RequestParam</code>注解功能相似，<code>@RequestParam</code>注解的作用：将<code>请求参数</code>映射到<code>方法的形参</code>上。</p>
<p>当然，对于<code>@RequestHeader</code>注解来说，也有三个属性：value、required、defaultValue，和<code>@RequestParam</code>一样，这里就不再赘述。</p>
<blockquote>
<p>测试</p>
</blockquote>
<p>1、编写register方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/register&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">register</span><span class="params">(User user,</span></span><br><span class="line"><span class="params">                       <span class="meta">@RequestHeader(value = &quot;Referer&quot;, required = false, defaultValue = &quot;&quot;)</span></span></span><br><span class="line"><span class="params">                       String referer)</span> &#123;</span><br><span class="line">    System.out.println(user);</span><br><span class="line">    System.out.println(referer);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2、填写信息后点击注册<strong>成功</strong>跳转到注册成功页面，控制台打印：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">User&#123;id=null, username=&#x27;muyoukule&#x27;, password=&#x27;123&#x27;, sex=&#x27;1&#x27;, hobby=[smoke, drink, perm], intro=&#x27;muyoukulehaoshuaia&#x27;&#125;</span><br><span class="line">http://localhost:8080/springmvc/</span><br></pre></td></tr></table></figure>

<h1 id="7-CookieValue注解"><a href="#7-CookieValue注解" class="headerlink" title="7. @CookieValue注解"></a>7. @CookieValue注解</h1><p>该注解的作用：将 <code>请求提交的Cookie数据</code> 映射到 <code>方法形参</code> 上</p>
<p>同样是有三个属性：value、required、defaultValue</p>
<blockquote>
<p>测试</p>
</blockquote>
<p>1、前端页面中编写发送cookie的代码：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">function</span> <span class="title function_">sendCookie</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">document</span>.<span class="property">cookie</span> = <span class="string">&quot;id=123456789; expires=Thu, 18 Dec 2025 12:00:00 UTC; path=/&quot;</span>;</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">document</span>.<span class="property">location</span> = <span class="string">&quot;/springmvc/register&quot;</span>;</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onclick</span>=<span class="string">&quot;sendCookie()&quot;</span>&gt;</span>向服务器端发送Cookie<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>2、后端UserController代码：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/register&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">register</span><span class="params">(User user,</span></span><br><span class="line"><span class="params">                       <span class="meta">@RequestHeader(value = &quot;Referer&quot;, required = false, defaultValue = &quot;&quot;)</span></span></span><br><span class="line"><span class="params">                       String referer,</span></span><br><span class="line"><span class="params">                       <span class="meta">@CookieValue(value = &quot;id&quot;, required = false, defaultValue = &quot;2222222222&quot;)</span></span></span><br><span class="line"><span class="params">                       String id)</span> &#123;</span><br><span class="line">    System.out.println(user);</span><br><span class="line">    System.out.println(referer);</span><br><span class="line">    System.out.println(id);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3、启动服务器打开页面，直接点击向 <code>服务器端发送Cookie</code> 按钮测试，控制台打印：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">User&#123;id=null, username=&#x27;null&#x27;, password=&#x27;null&#x27;, sex=&#x27;null&#x27;, hobby=null, intro=&#x27;null&#x27;&#125;</span><br><span class="line">http://localhost:8080/springmvc/</span><br><span class="line">123456789</span><br></pre></td></tr></table></figure>

<h1 id="8-请求的中文乱码问题"><a href="#8-请求的中文乱码问题" class="headerlink" title="8. 请求的中文乱码问题"></a>8. 请求的中文乱码问题</h1><h2 id="8-1-get请求乱码"><a href="#8-1-get请求乱码" class="headerlink" title="8.1 get请求乱码"></a>8.1 get请求乱码</h2><p>get请求数据在URI后面提交，这个乱码问题怎么解决呢？</p>
<p>解决办法是找到<code>CATALINA_HOME/config/server.xml</code>文件，找到其中配置端口号的标签<code>&lt;Connector&gt;</code>，在该标签中添加  <code>URIEncoding=&quot;UTF-8&quot;</code></p>
<p>但是对于高版本的Tomcat服务器来说，是不需要设置的，例如Tomcat10，Tomcat9，有如下的默认配置，在默认情况下URIEncoding使用的就是<code>UTF-8</code>的编码方式。</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/Tomcat10%E7%BC%96%E7%A0%81%E6%96%B9%E5%BC%8F.png" alt="Tomcat10编码方式"></p>
<p>但对于低版本的Tomcat服务器，例如：Tomcat8。URIEncoding的默认配置是<code>ISO-8859-1</code>，因此在Tomcat8中需要手动配置server.xml文件：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/Tomcat8%E7%BC%96%E7%A0%81%E6%96%B9%E5%BC%8F.png" alt="Tomcat8编码方式"></p>
<p>在 <code>conf</code> 目录下打开 <code>server.xml</code> 文件，配置如下：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/Tomcat8%E9%85%8D%E7%BD%AEUTF-8%E7%BC%96%E7%A0%81%E6%96%B9%E5%BC%8F.png" alt="Tomcat8配置UTF-8编码方式"></p>
<blockquote>
<p>测试默认情况下，Tomcat10是否已经解决了get请求乱码问题</p>
</blockquote>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">th:action</span>=<span class="string">&quot;@&#123;/register&#125;&quot;</span> <span class="attr">method</span>=<span class="string">&quot;get&quot;</span>&gt;</span></span><br><span class="line">    用户名：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    密码：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;password&quot;</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    性别：</span><br><span class="line">        男 <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;radio&quot;</span> <span class="attr">name</span>=<span class="string">&quot;sex&quot;</span> <span class="attr">value</span>=<span class="string">&quot;1&quot;</span>&gt;</span></span><br><span class="line">        女 <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;radio&quot;</span> <span class="attr">name</span>=<span class="string">&quot;sex&quot;</span> <span class="attr">value</span>=<span class="string">&quot;0&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    爱好：</span><br><span class="line">        抽烟 <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;checkbox&quot;</span> <span class="attr">name</span>=<span class="string">&quot;hobby&quot;</span> <span class="attr">value</span>=<span class="string">&quot;smoke&quot;</span>&gt;</span></span><br><span class="line">        喝酒 <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;checkbox&quot;</span> <span class="attr">name</span>=<span class="string">&quot;hobby&quot;</span> <span class="attr">value</span>=<span class="string">&quot;drink&quot;</span>&gt;</span></span><br><span class="line">        烫头 <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;checkbox&quot;</span> <span class="attr">name</span>=<span class="string">&quot;hobby&quot;</span> <span class="attr">value</span>=<span class="string">&quot;perm&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    简介：<span class="tag">&lt;<span class="name">textarea</span> <span class="attr">rows</span>=<span class="string">&quot;10&quot;</span> <span class="attr">cols</span>=<span class="string">&quot;60&quot;</span> <span class="attr">name</span>=<span class="string">&quot;intro&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">textarea</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;注册&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>注意，以上表单已经修改为<code>get</code>请求了。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/register&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">register</span><span class="params">(User user)</span>&#123;</span><br><span class="line">    System.out.println(user);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试结果：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/%E6%B5%8B%E8%AF%95Tomcat10%E6%98%AF%E5%90%A6%E5%A4%84%E7%90%86get%E8%AF%B7%E6%B1%82%E4%B9%B1%E7%A0%81.png" alt="测试Tomcat10是否处理get请求乱码" style="zoom: 80%;">

<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/Tomcat10get%E8%AF%B7%E6%B1%82%E6%B3%A8%E5%86%8C%E6%88%90%E5%8A%9F.png" alt="Tomcat10get请求注册成功" style="zoom:50%;">

<p>控制台打印：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">User&#123;id=null, username=&#x27;木又枯了&#x27;, password=&#x27;123&#x27;, sex=&#x27;1&#x27;, hobby=[smoke, drink, perm], intro=&#x27;木又枯了太酷了！&#x27;&#125;</span><br></pre></td></tr></table></figure>

<h2 id="8-2-post请求乱码"><a href="#8-2-post请求乱码" class="headerlink" title="8.2 post请求乱码"></a>8.2 post请求乱码</h2><p>post请求是解决请求体的中文乱码问题。解决办法大家都知道：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">request.setCharacterEncoding(<span class="string">&quot;UTF-8&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>同样，对于高版本的<strong>Tomcat10</strong>服务器来说，针对请求体中的字符编码也是配置好的，默认也是采用了UTF-8，中文乱码问题也解决了，在这个文件中配置的：<code>apache-tomcat-10.1.19\conf\web.xml</code></p>
<p>配置内容如下：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/Tomcat10%E9%92%88%E5%AF%B9%E8%AF%B7%E6%B1%82%E4%BD%93%E4%B8%AD%E7%9A%84%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81%E6%98%AF%E9%85%8D%E7%BD%AE%E5%A5%BD%E7%9A%84.png" alt="Tomcat10针对请求体中的字符编码是配置好的"></p>
<p>通过以上配置可以看到，Tomcat10对请求和响应都设置了默认的字符编码方式为<code>UTF-8</code>。</p>
<p><font color="red">PS：Tomcat9以及之前的版本，以上的配置是没有的。</font></p>
<blockquote>
<p>测试针对Tomcat10，SpringMVC会不会有乱码问题</p>
</blockquote>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">th:action</span>=<span class="string">&quot;@&#123;/register&#125;&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span><br><span class="line">    用户名：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    密码：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;password&quot;</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    性别：</span><br><span class="line">        男 <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;radio&quot;</span> <span class="attr">name</span>=<span class="string">&quot;sex&quot;</span> <span class="attr">value</span>=<span class="string">&quot;1&quot;</span>&gt;</span></span><br><span class="line">        女 <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;radio&quot;</span> <span class="attr">name</span>=<span class="string">&quot;sex&quot;</span> <span class="attr">value</span>=<span class="string">&quot;0&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    爱好：</span><br><span class="line">        抽烟 <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;checkbox&quot;</span> <span class="attr">name</span>=<span class="string">&quot;hobby&quot;</span> <span class="attr">value</span>=<span class="string">&quot;smoke&quot;</span>&gt;</span></span><br><span class="line">        喝酒 <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;checkbox&quot;</span> <span class="attr">name</span>=<span class="string">&quot;hobby&quot;</span> <span class="attr">value</span>=<span class="string">&quot;drink&quot;</span>&gt;</span></span><br><span class="line">        烫头 <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;checkbox&quot;</span> <span class="attr">name</span>=<span class="string">&quot;hobby&quot;</span> <span class="attr">value</span>=<span class="string">&quot;perm&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    简介：<span class="tag">&lt;<span class="name">textarea</span> <span class="attr">rows</span>=<span class="string">&quot;10&quot;</span> <span class="attr">cols</span>=<span class="string">&quot;60&quot;</span> <span class="attr">name</span>=<span class="string">&quot;intro&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">textarea</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;注册&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>PS：以上表单已经修改为post请求</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/register&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">register</span><span class="params">(User user)</span> &#123;</span><br><span class="line">    System.out.println(user);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试结果：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">User&#123;id=null, username=&#x27;木又枯了&#x27;, password=&#x27;123&#x27;, sex=&#x27;1&#x27;, hobby=[smoke, drink, perm], intro=&#x27;木又枯了太酷啦！！&#x27;&#125;</span><br></pre></td></tr></table></figure>

<p>通过测试可以看到在Tomcat10当中，默认SpringMVC，发送POST请求，是不会出现乱码问题的。</p>
<blockquote>
<p>模拟乱码</p>
</blockquote>
<p>如果不是Tomcat10，则会出现乱码问题，我们来模拟一下乱码的产生，将<code>apache-tomcat-10.1.19\conf\web.xml</code>文件中的<code>UTF-8</code>配置修改为<code>ISO-8859-1</code>：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Set the default request and response character encodings to ISO-8859-1.   --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">request-character-encoding</span>&gt;</span>ISO-8859-1<span class="tag">&lt;/<span class="name">request-character-encoding</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">response-character-encoding</span>&gt;</span>ISO-8859-1<span class="tag">&lt;/<span class="name">response-character-encoding</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>一定要重启Tomcat10</strong>，新的配置才能生效，来测试一下是否存在乱码：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">User&#123;id=null, username=&#x27;??¨?????????&#x27;, password=&#x27;123&#x27;, sex=&#x27;1&#x27;, hobby=[smoke, drink, perm], intro=&#x27;??¨??????????¤?é?·?????????&#x27;&#125;</span><br></pre></td></tr></table></figure>

<p>那么，在SpringMVC中如何解决请求体的中文乱码问题呢？</p>
<p>当然，还是使用<code>request.setCharacterEncoding(&quot;UTF-8&quot;)</code>，使用它有一个前提条件，要想解决请求体乱码问题，以上代码必须在 <code>request.getParameter(&quot;username&quot;)</code>执行之前执行才有效。</p>
<p>也就是说以上代码如果放在Controller的相关方法中执行是无效的，因为Controller的方法在执行之前 DispatcherServlet已经调用了 <code>request.getParameter(&quot;username&quot;)</code>方法。因此在Controller方法中使用<code>request.setCharacterEncoding(&quot;UTF-8&quot;)</code>无效。</p>
<p>我们来测试一下（PS：注意表单为post请求）：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/register&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">register</span><span class="params">(User user, HttpServletRequest request)</span> <span class="keyword">throws</span> UnsupportedEncodingException &#123;</span><br><span class="line">    request.setCharacterEncoding(<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">    System.out.println(user);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试结果：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">User&#123;id=null, username=&#x27;??¨?????????&#x27;, password=&#x27;123&#x27;, sex=&#x27;1&#x27;, hobby=[smoke, drink, perm], intro=&#x27;??¨??????????¤?é?·?????????&#x27;&#125;</span><br></pre></td></tr></table></figure>

<p>通过测试可以看到：在Controller当中调用 <code>request.setCharacterEncoding(&quot;UTF-8&quot;)</code> 是无法解决POST乱码问题的。</p>
<p>那怎么办呢？怎么样才能在DispatcherServlet之前执行 <code>request.setCharacterEncoding(&quot;UTF-8&quot;)</code> 呢？</p>
<p>没错，我相信大家想到了：过滤器Filter。过滤器Filter可以在Servlet执行之前执行。有人又说了：监听器不行吗？不行。因为我们需要对每一次请求解决乱码，而监听器只在服务器启动阶段执行一次。因此这里解决每一次请求的乱码问题，应该使用过滤器Filter。</p>
<p>1、编写过滤器<code>CharacterEncodingFilter</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CharacterEncodingFilter</span> <span class="keyword">implements</span> <span class="title class_">Filter</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        <span class="comment">// 设置请求体的字符集</span></span><br><span class="line">        request.setCharacterEncoding(<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">        <span class="comment">// 设置响应的字符集</span></span><br><span class="line">        response.setContentType(<span class="string">&quot;text/html;charset=UTF-8&quot;</span>);</span><br><span class="line">        <span class="comment">// 执行下一个资源</span></span><br><span class="line">        chain.doFilter(request, response);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2、在web.xml里配置过滤器</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--配置字符编码过滤器--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>characterEncodingFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>com.muyoukule.filter.CharacterEncodingFilter<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>characterEncodingFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>3、编写方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/register&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">register</span><span class="params">(User user)</span> &#123;</span><br><span class="line">    System.out.println(user);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>4、启动服务器，填写信息后点击注册<strong>成功</strong>跳转到注册成功页面，控制台打印：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">User&#123;id=null, username=&#x27;木又枯了&#x27;, password=&#x27;123&#x27;, sex=&#x27;1&#x27;, hobby=[smoke, drink, perm], intro=&#x27;木又枯了太酷啦！！！&#x27;&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>SpringMVC框架内置字符编码过滤器CharacterEncodingFilter</p>
</blockquote>
<p>除此以外，SpringMVC框架内置了字符编码过滤器，叫做 <code>CharacterEncodingFilter</code>，我们直接配置好即可使用。</p>
<p><code>CharacterEncodingFilter</code> 中最核心的方法是：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doFilterInternal</span><span class="params">(</span></span><br><span class="line"><span class="params">        HttpServletRequest request, HttpServletResponse response, FilterChain filterChain)</span></span><br><span class="line">        <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">encoding</span> <span class="operator">=</span> getEncoding();</span><br><span class="line">    <span class="keyword">if</span> (encoding != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (isForceRequestEncoding() || request.getCharacterEncoding() == <span class="literal">null</span>) &#123;</span><br><span class="line">            request.setCharacterEncoding(encoding);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (isForceResponseEncoding()) &#123;</span><br><span class="line">            response.setCharacterEncoding(encoding);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    filterChain.doFilter(request, response);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>分析以上核心方法得知该过滤器对请求和响应都设置了字符编码方式。</p>
<ul>
<li>当 <code>强行使用请求字符编码方式为true</code> 时，或者 <code>请求对象的字符编码方式为null</code> 时，设置请求的字符编码方式。</li>
<li>当 <code>强行使用响应字符编码方式为true</code> 时，设置响应的字符编码方式。</li>
</ul>
<p>根据以上代码，可以得出以下配置信息，在web.xml文件中对过滤器进行如下配置：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--使用SpringMVC框架内置的字符编码过滤器--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>characterEncodingFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>org.springframework.web.filter.CharacterEncodingFilter<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>encoding<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>forceRequestEncoding<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>true<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>forceResponseEncoding<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>true<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>characterEncodingFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>重启Tomcat10，看看乱码是否能够解决？</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">User&#123;id=null, username=&#x27;木又枯了&#x27;, password=&#x27;123&#x27;, sex=&#x27;1&#x27;, hobby=[smoke, drink, perm], intro=&#x27;木又枯了太酷啦！！&#x27;&#125;</span><br></pre></td></tr></table></figure>

<p>PS：针对于我们<strong>当前的Tomcat10的配置</strong>来说，它有默认的字符集<code>ISO-8859-1</code>，因此以下在web.xml文件中的配置是不能缺少的：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>forceRequestEncoding<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>true<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>如果缺少它，仍然是会存在乱码问题的。自行测试一下！！！！</p>
]]></content>
      <categories>
        <category>Java</category>
        <category>SSM</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>Spring</tag>
        <tag>SpringMVC</tag>
      </tags>
  </entry>
  <entry>
    <title>【第2章】 @RequestMapping注解</title>
    <url>/posts/5625/</url>
    <content><![CDATA[<p>参考视频：<a href="https://www.bilibili.com/video/BV1sC411L76f/">SpringMVC教程，SpringMVC从零到精通，老杜SpringMVC，动力节点SpringMVC</a></p>
<h1 id="1-RequestMapping的作用"><a href="#1-RequestMapping的作用" class="headerlink" title="1. RequestMapping的作用"></a>1. RequestMapping的作用</h1><p><code>@RequestMapping</code> 注解是 Spring MVC 框架中的一个控制器映射注解，用于将请求映射到相应的处理方法上。具体来说，它可以将指定 URL 的请求绑定到一个特定的方法或类上，从而实现对请求的处理和响应。</p>
<h1 id="2-RequestMapping的出现位置"><a href="#2-RequestMapping的出现位置" class="headerlink" title="2. RequestMapping的出现位置"></a>2. RequestMapping的出现位置</h1><p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/RequestMapping%E7%9A%84%E5%87%BA%E7%8E%B0%E4%BD%8D%E7%BD%AE.png" alt="RequestMapping的出现位置"></p>
<p>通过RequestMapping的源码可以看到RequestMapping注解只能出现在<code>类</code>上或者<code>方法</code>上。</p>
<h1 id="3-类上与方法上结合使用"><a href="#3-类上与方法上结合使用" class="headerlink" title="3. 类上与方法上结合使用"></a>3. 类上与方法上结合使用</h1><p>我们先来看，在同一个web应用中，是否可以有两个完全一样的<code>RequestMapping</code>。测试一下：假设两个RequestMapping，其中一个是展示用户详细信息，另一个是展示商品详细信息。提供两个Controller，一个是<code>UserController</code>，另一个是<code>ProductController</code>。如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserController</span> &#123;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/detail&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toDetail</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;detail&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProductController</span> &#123;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/detail&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toDetail</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;detail&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以上两个Controller的RequestMapping相同，都是 <code>/detail</code>，我们来启动服务器异常发生了，异常信息如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">org.springframework.beans.factory.BeanCreationException: </span><br><span class="line">Error creating bean with name &#x27;org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping&#x27;: </span><br><span class="line">Ambiguous mapping. Cannot map &#x27;userController&#x27; method </span><br><span class="line">com.powernode.springmvc.controller.UserController#toDetail()</span><br><span class="line">to &#123; [/detail]&#125;: There is already &#x27;productController&#x27; bean method</span><br><span class="line">com.powernode.springmvc.controller.ProductController#toDetail() mapped.</span><br></pre></td></tr></table></figure>
<p>以上异常信息大致的意思是：不明确的映射。无法映射UserController中的toDetail()方法，因为已经在ProductController中映射过了！！！！</p>
<p>通过测试得知，在同一个webapp中，RequestMapping必须具有唯一性。怎么解决以上问题？两种解决方案：</p>
<ul>
<li>第一种方案：将方法上RequestMapping的映射路径修改的不一样。</li>
<li>第二种方案：在类上添加RequestMapping的映射路径，以类上的RequestMapping作为命名空间，来加以区分两个不同的映射。</li>
</ul>
<h2 id="3-1-第一种方案"><a href="#3-1-第一种方案" class="headerlink" title="3.1 第一种方案"></a>3.1 第一种方案</h2><p>将方法上RequestMapping的映射路径修改的不一样。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/user/detail&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">toDetail</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;/user/detail&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/product/detail&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">toDetail</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;/product/detail&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>新建<code>templates</code>目录为这两个请求分别提供对应的视图页面：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/%E4%B8%A4%E4%B8%AA%E8%AF%B7%E6%B1%82%E5%AF%B9%E5%BA%94%E7%9A%84%E8%A7%86%E5%9B%BE%E9%A1%B5%E9%9D%A2.png" alt="两个请求对应的视图页面"></p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span> <span class="attr">xmlns:th</span>=<span class="string">&quot;http://www.thymeleaf.org&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>商品详情页面<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>商品详情<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span> <span class="attr">xmlns:th</span>=<span class="string">&quot;http://www.thymeleaf.org&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>用户详情页面<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>用户详情<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>新增一个 IndexController</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IndexController</span> &#123;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toIndex</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;index&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在首页面添加两个超链接：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span> <span class="attr">xmlns:th</span>=<span class="string">&quot;http://www.thymeleaf.org&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>index page<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>index page<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">th:href</span>=<span class="string">&quot;@&#123;/user/detail&#125;&quot;</span>&gt;</span>用户详情<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">th:href</span>=<span class="string">&quot;@&#123;/product/detail&#125;&quot;</span>&gt;</span>商品详情<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>启动Tomcat服务器就没有报错了，访问 <code>http://localhost:8080/springmvc/</code> 测试：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/%E7%94%A8%E6%88%B7%E8%AF%A6%E6%83%85%E5%92%8C%E5%95%86%E5%93%81%E8%AF%A6%E6%83%85.png" alt="用户详情和商品详情"></p>
<p>点击用户详情，点击商品详情，也都可以正常显示。</p>
<h2 id="3-2-第二种方案"><a href="#3-2-第二种方案" class="headerlink" title="3.2 第二种方案"></a>3.2 第二种方案</h2><p>在类上和方法上都使用RequestMapping注解来进行路径的映射。假设在类上映射的路径是<code>/a</code>，在方法上映射的路径是<code>/b</code>，那么整体表示映射的路径就是：<code>/a/b</code></p>
<p>在第一种方案中，假设UserController类中有很多方法，每个方法的 RequestMapping注解中都需要以<code>/user</code>开始，显然比较啰嗦，干脆将<code>/user</code>提升到类级别上，例如：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/user&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserController</span> &#123;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/detail&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toDetail</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;/user/detail&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/product&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProductController</span> &#123;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/detail&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toDetail</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;/product/detail&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>经过测试，程序可以正常执行！！！</p>
<h1 id="4-RequestMpping注解的value属性"><a href="#4-RequestMpping注解的value属性" class="headerlink" title="4. RequestMpping注解的value属性"></a>4. RequestMpping注解的value属性</h1><h2 id="4-1-value属性的使用"><a href="#4-1-value属性的使用" class="headerlink" title="4.1 value属性的使用"></a>4.1 value属性的使用</h2><p>value属性是该注解最核心的属性，value属性填写的是请求路径，也就是说通过该请求路径与对应的控制器的方法绑定在一起。另外通过源码可以看到value属性是一个字符串数组：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@AliasFor(&quot;path&quot;)</span></span><br><span class="line">String[] value() <span class="keyword">default</span> &#123;&#125;;</span><br></pre></td></tr></table></figure>

<p>既然是数组，就表示可以提供多个路径，也就是说，在SpringMVC中，多个不同的请求路径可以映射同一个控制器的同一个方法。</p>
<blockquote>
<p>测试</p>
</blockquote>
<p>1、编写新的控制器：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RequestMappingTestController</span> &#123;</span><br><span class="line">    <span class="meta">@RequestMapping(value = &#123;&quot;/testValue1&quot;, &quot;/testValue2&quot;&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">testValue</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;testValue&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>2、提供视图页面：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span> <span class="attr">xmlns:th</span>=<span class="string">&quot;http://www.thymeleaf.org&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>test Value<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Test RequestMapping&#x27;s Value<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>3、在index.html文件中添加两个超链接：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span> <span class="attr">xmlns:th</span>=<span class="string">&quot;http://www.thymeleaf.org&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>index page<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>index page<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">th:href</span>=<span class="string">&quot;@&#123;/user/detail&#125;&quot;</span>&gt;</span>用户详情<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">th:href</span>=<span class="string">&quot;@&#123;/product/detail&#125;&quot;</span>&gt;</span>商品详情<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--测试RequestMapping的value属性--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">th:href</span>=<span class="string">&quot;@&#123;/testValue1&#125;&quot;</span>&gt;</span>testValue1<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">th:href</span>=<span class="string">&quot;@&#123;/testValue2&#125;&quot;</span>&gt;</span>testValue2<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>4、启动服务器，点击刚刚添加的两个超链接，发送请求，都可以正常访问到同一个控制器上的同一个方法！！</p>
<h2 id="4-2-Ant风格的value"><a href="#4-2-Ant风格的value" class="headerlink" title="4.2 Ant风格的value"></a>4.2 Ant风格的value</h2><p>value是可以用来匹配路径的，路径支持模糊匹配，我们把这种模糊匹配称之为Ant风格。关于路径中的通配符包括：</p>
<ul>
<li><code>?</code>：代表任意一个字符（除 <code>/</code>、 <code>?</code> 之外的其它字符）<font color="red">PS：一定是一个字符哦！不能空着！！</font></li>
<li><code>*</code>：代表0到N个任意字符（除 <code>/</code> 、<code>?</code> 之外的其它字符）</li>
<li><code>**</code>：代表0到N个任意字符，并且路径中可以出现路径分隔符 <code>/</code></li>
</ul>
<p><font color="red">PS：<code>**</code> 通配符在使用时，左右不能出现字符 ，<code>**</code> 左边只能是 <code>/</code></font></p>
<blockquote>
<p>测试 <code>?</code> 通配符</p>
</blockquote>
<p>1、在 RequestMappingTestController 中添加以下方法：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/x?z/testValueAnt&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">testValueAnt</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;testValueAnt&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>2、提供视图页面：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span> <span class="attr">xmlns:th</span>=<span class="string">&quot;http://www.thymeleaf.org&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>test Value Ant<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>测试RequestMapping注解的value属性支持模糊匹配<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>3、在index.html页面中编写超链接：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--测试RequestMapping注解的value属性支持模糊匹配--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">th:href</span>=<span class="string">&quot;@&#123;/xyz/testValueAnt&#125;&quot;</span>&gt;</span>测试value属性的模糊匹配<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>4、测试结果如下：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/%E6%B5%8B%E8%AF%95%E9%80%9A%E9%85%8D%E7%AC%A6.png" alt="测试通配符"></p>
<p>通过修改浏览器地址栏上的路径，可以反复测试通配符 ? 的语法：</p>
<p><a href="http://localhost:8080/springmvc/xaz/testValueAnt">http://localhost:8080/springmvc/xaz/testValueAnt</a></p>
<p><a href="http://localhost:8080/springmvc/x+z/testValueAnt">http://localhost:8080/springmvc/x+z/testValueAnt</a></p>
<p><a href="http://localhost:8080/springmvc/x:z/testValueAnt">http://localhost:8080/springmvc/x:z/testValueAnt</a></p>
<p>以上三种写法均访问<strong>成功</strong>。</p>
<p><a href="http://localhost:8080/springmvc/xaaz/testValueAnt">http://localhost:8080/springmvc/xaaz/testValueAnt</a></p>
<p><a href="http://localhost:8080/springmvc/xz/testValueAnt">http://localhost:8080/springmvc/xz/testValueAnt</a></p>
<p><a href="http://localhost:8080/springmvc/x?z/testValueAnt">http://localhost:8080/springmvc/x?z/testValueAnt</a></p>
<p><a href="http://localhost:8080/springmvc/x/z/testValueAnt">http://localhost:8080/springmvc/x/z/testValueAnt</a></p>
<p>以上四种写法均访问<strong>失败</strong>。</p>
<blockquote>
<p>测试 <code>*</code> 通配符</p>
</blockquote>
<p>1、将 <code>?</code> 通配符修改为 <code>*</code> 通配符：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/x*z/testValueAnt&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">testValueAnt</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;testValueAnt&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>2、重启Tomcat，打开浏览器直接在地址栏上输入路径进行测试：</p>
<p><a href="http://localhost:8080/springmvc/xaaz/testValueAnt">http://localhost:8080/springmvc/xaaz/testValueAnt</a></p>
<p><a href="http://localhost:8080/springmvc/xz/testValueAnt">http://localhost:8080/springmvc/xz/testValueAnt</a></p>
<p>以上两种写法均访问<strong>成功</strong>。</p>
<p><a href="http://localhost:8080/springmvc/xaa/testValueAnt">http://localhost:8080/springmvc/xaa/testValueAnt</a></p>
<p>以上这种写法访问<strong>失败</strong>。</p>
<blockquote>
<p>测试 <code>**</code> 通配符</p>
</blockquote>
<p>1、将 <code>*</code> 通配符修改为 <code>**</code> 通配符：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/x**z/testValueAnt&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">testValueAnt</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;testValueAnt&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>2、重启Tomcat，打开浏览器直接在地址栏上输入路径进行测试：</p>
<p><a href="http://localhost:8080/springmvc/xa/az/testValueAnt">http://localhost:8080/springmvc/xa/az/testValueAnt</a></p>
<p>以上这种写法访问<strong>失败</strong>。</p>
<p><font color="red">PS：<code>/x**z/</code> 实际上并没有使用通配符 <code>**</code>，本质上还是使用的 <code>*</code>，因为通配符 <code>**</code> 在使用的时候，左右两边都不能有任何字符，必须是 <code>/</code></font></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/**/testValueAnt&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">testValueAnt</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;testValueAnt&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>启动服务器发现报错了：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/%E9%80%9A%E9%85%8D%E7%AC%A6%E5%AF%BC%E8%87%B4%E9%A1%B9%E7%9B%AE%E6%8A%A5%E9%94%99.png" alt="通配符导致项目报错"></p>
<p>以上写法在Spring5的时候是支持的，但是在Spring6中进行了严格的规定，<code>**</code> 通配符只能出现在路径的末尾，例如：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/testValueAnt/**&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">testValueAnt</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;testValueAnt&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试结果：</p>
<p><a href="http://localhost:8080/springmvc/testValueAnt">http://localhost:8080/springmvc/testValueAnt</a></p>
<p><a href="http://localhost:8080/springmvc/testValueAnt/a/b/c/d">http://localhost:8080/springmvc/testValueAnt/a/b/c/d</a></p>
<p>以上两种写法均访问<strong>成功</strong>。</p>
<h2 id="4-3-value中的占位符（重点）"><a href="#4-3-value中的占位符（重点）" class="headerlink" title="4.3 value中的占位符（重点）"></a>4.3 value中的占位符（重点）</h2><p>到目前为止，我们的请求路径是这样的格式：<code>url?name1=value1&amp;name2=value2&amp;name3=value3</code></p>
<p>其实除了这种方式，还有另外一种格式的请求路径，格式为：<code>url/value1/value2/value3</code>，我们将这样的请求路径叫做 <code>RESTful</code> 风格的请求路径。RESTful风格的请求路径在现代的开发中使用较多。</p>
<p>普通的请求路径：<code>http://localhost:8080/springmvc/login?username=admin&amp;password=123&amp;age=20</code></p>
<p>RESTful风格的请求路径：<code>http://localhost:8080/springmvc/login/admin/123/20</code></p>
<p>如果使用RESTful风格的请求路径，在控制器中应该如何获取请求中的数据呢？</p>
<p>可以在value属性中使用占位符，例如：<code>/login/&#123;id&#125;/&#123;username&#125;/&#123;password&#125;</code></p>
<p>1、在 RequestMappingTestController 类中添加一个方法：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(value = &quot;/testRESTful/&#123;id&#125;/&#123;username&#125;/&#123;age&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">testRESTful</span><span class="params">(</span></span><br><span class="line"><span class="params">    <span class="meta">@PathVariable(&quot;id&quot;)</span></span></span><br><span class="line"><span class="params">    <span class="type">int</span> id,</span></span><br><span class="line"><span class="params">    <span class="meta">@PathVariable(&quot;username&quot;)</span></span></span><br><span class="line"><span class="params">    String username,</span></span><br><span class="line"><span class="params">    <span class="meta">@PathVariable(&quot;age&quot;)</span></span></span><br><span class="line"><span class="params">    <span class="type">int</span> age)</span> &#123;</span><br><span class="line">    System.out.println(id + <span class="string">&quot;,&quot;</span> + username + <span class="string">&quot;,&quot;</span> + age);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;testRESTful&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>2、提供视图页面：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span> <span class="attr">xmlns:th</span>=<span class="string">&quot;http://www.thymeleaf.org&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>test RESTful<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>测试value属性使用占位符<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>3、在 index.html 页面中添加超链接：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--测试RequestMapping注解的value属性支持占位符--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">th:href</span>=<span class="string">&quot;@&#123;/testRESTful/1/zhangsan/20&#125;&quot;</span>&gt;</span>测试value属性使用占位符<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>4、启动服务器测试：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/%E6%B5%8B%E8%AF%95%E5%8D%A0%E4%BD%8D%E7%AC%A6.png" alt="测试占位符"></p>
<p>5、查看控制台：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1,zhangsan,20</span><br></pre></td></tr></table></figure>

<h1 id="5-RequestMapping注解的method属性"><a href="#5-RequestMapping注解的method属性" class="headerlink" title="5. RequestMapping注解的method属性"></a>5. RequestMapping注解的method属性</h1><h2 id="5-1-method属性的作用"><a href="#5-1-method属性的作用" class="headerlink" title="5.1 method属性的作用"></a>5.1 method属性的作用</h2><p>在Servlet当中，如果后端要求前端必须发送一个<code>post</code>请求，后端可以通过重写<code>doPost</code>方法来实现。后端要求前端必须发送一个<code>get</code>请求，后端可以通过重写<code>doGet</code>方法来实现。当重写的方法是<code>doPost</code>时，前端就必须发送<code>post</code>请求，当重写<code>doGet</code>方法时，前端就必须发送<code>get</code>请求。如果前端发送请求的方式和后端的处理方式不一致时，会出现<code>405</code>错误。</p>
<p><strong>HTTP状态码405，这种机制的作用是：限制客户端的请求方式，以保证服务器中数据的安全。</strong></p>
<p>假设后端程序要处理的请求是一个登录请求，为了保证登录时的用户名和密码不被显示到浏览器的地址栏上，后端程序有义务要求前端必须发送一个<code>post</code>请求，如果前端发送<code>get</code>请求，则应该拒绝。</p>
<p>那么在SpringMVC框架中应该如何实现这种机制呢？可以使用RequestMapping注解的<code>method</code>属性来实现。</p>
<p>通过RequestMapping源码可以看到，method属性也是一个数组：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">RequestMethod[] method() <span class="keyword">default</span> &#123;&#125;;</span><br></pre></td></tr></table></figure>

<p>数组中的每个元素是 RequestMethod，而RequestMethod是一个枚举类型的数据：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">RequestMethod</span> &#123;</span><br><span class="line">    GET,</span><br><span class="line">    HEAD,</span><br><span class="line">    POST,</span><br><span class="line">    PUT,</span><br><span class="line">    PATCH,</span><br><span class="line">    DELETE,</span><br><span class="line">    OPTIONS,</span><br><span class="line">    TRACE;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// -- skip --</span></span><br><span class="line">    </span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>因此如果要求前端发送POST请求，该注解应该这样用：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(value = &quot;/login&quot;, method = RequestMethod.POST)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">login</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来，我们来测试一下：</p>
<p>1、在RequestMappingTestController类中添加以下方法：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(value = &quot;/login&quot;, method = RequestMethod.POST)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">testMethod</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;testMethod&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>2、提供视图页面：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span> <span class="attr">xmlns:th</span>=<span class="string">&quot;http://www.thymeleaf.org&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>test Method<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Login Success!!!<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>3、在index.html页面中提供一个登录的form表单，后端要求发送<code>post</code>请求，则form表单的method属性应设置为<code>post</code>：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--测试RequestMapping的method属性--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">th:action</span>=<span class="string">&quot;@&#123;/login&#125;&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span><br><span class="line">    用户名：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span>/&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    密码：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;password&quot;</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span>/&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;登录&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>4、启动服务器，测试：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/%E8%A1%A8%E5%8D%95post%E6%8F%90%E4%BA%A4.png" alt="表单post提交"></p>
<p>通过测试，前端发送的请求方式<code>post</code>，后端处理请求的方式也是<code>post</code>，就不会有问题。</p>
<p>当然，如果后端要求前端必须发送<code>post</code>请求，而前端发送了<code>get</code>请求，则会出现<code>405</code>错误，将index.html中form表单提交方式修改为<code>get</code>：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--测试RequestMapping的method属性--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">th:action</span>=<span class="string">&quot;@&#123;/login&#125;&quot;</span> <span class="attr">method</span>=<span class="string">&quot;get&quot;</span>&gt;</span></span><br><span class="line">    用户名：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span>/&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    密码：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;password&quot;</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span>/&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;登录&quot;</span>&gt;</span></span><br><span class="line">&lt;/form</span><br></pre></td></tr></table></figure>
<p>再次测试：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/%E8%A1%A8%E5%8D%95get%E6%8F%90%E4%BA%A4.png" alt="表单get提交"></p>
<p><strong>因此，可以看出，对于RequestMapping注解来说，多一个属性，就相当于多了一个映射的条件，如果<code>value</code>和<code>method</code>属性都有，则表示只有前端发送的<code>请求路径 + 请求方式</code>都满足时才能与控制器上的方法建立映射关系，只要有一个不满足，则无法建立映射关系。</strong></p>
<p>例如：<code>@RequestMapping(value=&quot;/login&quot;, method = RequestMethod.POST)</code> 表示当前端发送的请求路径是 <code>/login</code>，并且发送请求的方式是<code>POST</code>的时候才会建立映射关系。如果前端发送的是<code>get</code>请求，或者前端发送的请求路径不是 <code>/login</code>，则都是无法建立映射的。</p>
<h2 id="5-2-衍生Mapping"><a href="#5-2-衍生Mapping" class="headerlink" title="5.2 衍生Mapping"></a>5.2 衍生Mapping</h2><p>对于以上的程序来说，SpringMVC提供了另一个注解，使用这个注解更加的方便，它就是：<code>@PostMapping</code></p>
<p>使用该注解时，不需要指定method属性，因为它默认采用的就是<code>POST</code>处理方式：</p>
<p>修改RequestMappingTestController代码如下</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//@RequestMapping(value=&quot;/login&quot;, method = RequestMethod.POST)</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/login&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">testMethod</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;testMethod&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当前端发送<code>get</code>请求时，测试一下：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/%E8%A1%A8%E5%8D%95get%E6%8F%90%E4%BA%A4.png" alt="表单get提交"></p>
<p>当前端发送<code>post</code>请求时，测试一下：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/%E8%A1%A8%E5%8D%95post%E6%8F%90%E4%BA%A4.png" alt="表单post提交"></p>
<p>在SpringMVC中不仅提供了 <code>@PostMaping</code> 注解，像这样的注解还有四个，包括：</p>
<ul>
<li><code>@GetMapping</code>：要求前端必须发送<code>get</code>请求</li>
<li><code>@PutMapping</code>：要求前端必须发送<code>put</code>请求</li>
<li><code>@DeleteMapping</code>：要求前端必须发送<code>delete</code>请求</li>
<li><code>@PatchMapping</code>：要求前端必须发送<code>patch</code>请求</li>
</ul>
<h2 id="5-3-web的请求方式"><a href="#5-3-web的请求方式" class="headerlink" title="5.3 web的请求方式"></a>5.3 web的请求方式</h2><p>前端向服务器发送请求的方式包括哪些？共9种，前5种常用，后面作为了解：</p>
<ul>
<li><strong>GET</strong>：获取资源，只允许读取数据，不影响数据的状态和功能。使用 URL 中传递参数或者在 HTTP 请求的头部使用参数，服务器返回请求的资源。</li>
<li><strong>POST</strong>：向服务器提交资源，可能还会改变数据的状态和功能。通过表单等方式提交请求体，服务器接收请求体后，进行数据处理。</li>
<li><strong>PUT</strong>：更新资源，用于更新指定的资源上所有可编辑内容。通过请求体发送需要被更新的全部内容，服务器接收数据后，将被更新的资源进行替换或修改。</li>
<li><strong>DELETE</strong>：删除资源，用于删除指定的资源。将要被删除的资源标识符放在 URL 中或请求体中。</li>
<li><strong>HEAD</strong>：请求服务器返回资源的头部，与 GET 命令类似，但是所有返回的信息都是头部信息，不能包含数据体。主要用于资源检测和缓存控制。</li>
<li>PATCH：部分更改请求。当被请求的资源是可被更改的资源时，请求服务器对该资源进行部分更新，即每次更新一部分。</li>
<li>OPTIONS：请求获得服务器支持的请求方法类型，以及支持的请求头标志。“OPTIONS *”则返回支持全部方法类型的服务器标志。</li>
<li>TRACE：服务器响应输出客户端的 HTTP 请求，主要用于调试和测试。</li>
<li>CONNECT：建立网络连接，通常用于加密 SSL&#x2F;TLS 连接。</li>
</ul>
<p><strong>注意：</strong></p>
<ul>
<li>使用超链接以及原生的form表单只能提交get和post请求，put、delete、head请求可以使用发送ajax请求的方式来实现。</li>
<li>使用超链接发送的是get请求</li>
<li>使用form表单，如果没有设置method，发送get请求</li>
<li>使用form表单，设置method&#x3D;”get”，发送get请求</li>
<li>使用form表单，设置method&#x3D;”post”，发送post请求</li>
<li><strong>使用form表单，设置method&#x3D;”put&#x2F;delete&#x2F;head”，发送get请求。（针对这种情况，可以测试一下）</strong></li>
</ul>
<p>将index.html中登录表单的提交方式method设置为<code>put</code>：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--测试RequestMapping的method属性--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">th:action</span>=<span class="string">&quot;@&#123;/login&#125;&quot;</span> <span class="attr">method</span>=<span class="string">&quot;put&quot;</span>&gt;</span></span><br><span class="line">    用户名：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span>/&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    密码：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;password&quot;</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span>/&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;登录&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>修改RequestMappingTestController类的代码：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(value=&quot;/login&quot;, method = RequestMethod.PUT)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">testMethod</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;testMethod&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试结果：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/%E8%A1%A8%E5%8D%95put%E6%8F%90%E4%BA%A4.png" alt="表单put提交"></p>
<p>通过测试得知，即使form中method设置为<code>put</code>方式，但仍然采用<code>get</code>方式发送请求。</p>
<p>再次修改RequestMappingTestController：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(value=&quot;/login&quot;, method = RequestMethod.GET)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">testMethod</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;testMethod&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再次测试：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/%E9%87%87%E7%94%A8get%E6%96%B9%E5%BC%8F%E5%8F%91%E9%80%81%E8%AF%B7%E6%B1%82.png" alt="采用get方式发送请求"></p>
<h2 id="5-4-GET和POST的区别"><a href="#5-4-GET和POST的区别" class="headerlink" title="5.4 GET和POST的区别"></a>5.4 GET和POST的区别</h2><p>HTTP请求协议之<code>GET</code>请求：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET /springmvc/login?username=lucy&amp;userpwd=1111 HTTP/1.1                           请求行</span><br><span class="line">Host: localhost:8080                                                                    请求头</span><br><span class="line">Connection: keep-alive</span><br><span class="line">sec-ch-ua: &quot;Google Chrome&quot;;v=&quot;95&quot;, &quot;Chromium&quot;;v=&quot;95&quot;, &quot;;Not A Brand&quot;;v=&quot;99&quot;</span><br><span class="line">sec-ch-ua-mobile: ?0</span><br><span class="line">sec-ch-ua-platform: &quot;Windows&quot;</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/95.0.4638.54 Safari/537.36</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class="line">Sec-Fetch-Site: same-origin</span><br><span class="line">Sec-Fetch-Mode: navigate</span><br><span class="line">Sec-Fetch-User: ?1</span><br><span class="line">Sec-Fetch-Dest: document</span><br><span class="line">Referer: http://localhost:8080/springmvc/index.html</span><br><span class="line">Accept-Encoding: gzip, deflate, br</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9</span><br><span class="line">                                                                                        空白行</span><br><span class="line">                                                                                        请求体</span><br></pre></td></tr></table></figure>
<p>HTTP请求协议之<code>POST</code>请求：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">POST /springmvc/login HTTP/1.1                                                  请求行</span><br><span class="line">Host: localhost:8080                                                                  请求头</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Content-Length: 25</span><br><span class="line">Cache-Control: max-age=0</span><br><span class="line">sec-ch-ua: &quot;Google Chrome&quot;;v=&quot;95&quot;, &quot;Chromium&quot;;v=&quot;95&quot;, &quot;;Not A Brand&quot;;v=&quot;99&quot;</span><br><span class="line">sec-ch-ua-mobile: ?0</span><br><span class="line">sec-ch-ua-platform: &quot;Windows&quot;</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">Origin: http://localhost:8080</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/95.0.4638.54 Safari/537.36</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class="line">Sec-Fetch-Site: same-origin</span><br><span class="line">Sec-Fetch-Mode: navigate</span><br><span class="line">Sec-Fetch-User: ?1</span><br><span class="line">Sec-Fetch-Dest: document</span><br><span class="line">Referer: http://localhost:8080/springmvc/index.html</span><br><span class="line">Accept-Encoding: gzip, deflate, br</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9</span><br><span class="line">                                                                                      空白行</span><br><span class="line">username=lisi&amp;userpwd=123                                                             请求体</span><br></pre></td></tr></table></figure>

<blockquote>
<p>区别是什么？</p>
</blockquote>
<ul>
<li>get请求发送数据的时候，数据会挂在URI的后面，并且在URI后面添加一个 <code>?</code>，<code>?</code> 后面是数据。这样会导致发送的数据回显在浏览器的地址栏上。<code>http://localhost:8080/springmvc/login?username=zhangsan&amp;userpwd=1111</code></li>
<li>post请求发送数据的时候，在请求体当中发送。不会回显到浏览器的地址栏上。也就是说post发送的数据，在浏览器地址栏上看不到。</li>
<li>get请求只能发送普通的字符串。并且发送的字符串长度有限制，不同的浏览器限制不同。这个没有明确的规范。get请求无法发送大数据量。</li>
<li>post请求可以发送任何类型的数据，包括普通字符串，流媒体等信息：视频、声音、图片。post请求可以发送大数据量，理论上没有长度限制。</li>
<li>get请求在W3C中是这样说的：get请求比较适合从服务器端获取数据。</li>
<li>post请求在W3C中是这样说的：post请求比较适合向服务器端传送数据。</li>
<li>get请求是安全的。因为在正确使用get请求的前提下，get请求只是为了从服务器上获取数据，不会对服务器数据进行修改。</li>
<li>post请求是危险的。因为post请求是修改服务器端的资源。</li>
<li>get请求支持缓存。 也就是说当第二次发送get请求时，会走浏览器上次的缓存结果，不再真正的请求服务器。（有时需要避免，怎么避免：在get请求路径后添加时间戳）</li>
<li>post请求不支持缓存。每一次发送post请求都会真正的走服务器。</li>
</ul>
<blockquote>
<p>怎么选择？</p>
</blockquote>
<ul>
<li>如果你是想从服务器上获取资源，建议使用GET请求，如果你这个请求是为了向服务器提交数据，建议使用POST请求。</li>
<li>大部分的form表单提交，都是post方式，因为form表单中要填写大量的数据，这些数据是收集用户的信息，一般是需要传给服务器，服务器将这些数据保存&#x2F;修改等。</li>
<li>如果表单中有敏感信息，建议使用post请求，因为get请求会回显敏感信息到浏览器地址栏上。（例如：密码信息）</li>
<li>做文件上传，一定是post请求。要传的数据不是普通文本。</li>
<li>其他情况大部分都是使用get请求。</li>
</ul>
<h1 id="6-RequestMapping注解的params属性"><a href="#6-RequestMapping注解的params属性" class="headerlink" title="6. RequestMapping注解的params属性"></a>6. RequestMapping注解的params属性</h1><h2 id="6-1-params属性的理解"><a href="#6-1-params属性的理解" class="headerlink" title="6.1 params属性的理解"></a>6.1 params属性的理解</h2><p><code>params</code>属性用来设置通过请求参数来映射请求。</p>
<p>对于RequestMapping注解来说：</p>
<ul>
<li>value属性是一个数组，只要满足数组中的任意一个路径，就能映射成功</li>
<li>method属性也是一个数组，只要满足数组中任意一个请求方式，就能映射成功。</li>
<li><strong>params属性也是一个数组，不过要求请求参数必须和params数组中要求的所有参数完全一致后，才能映射成功。</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">String[] params() <span class="keyword">default</span> &#123;&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="6-2-params属性的4种用法"><a href="#6-2-params属性的4种用法" class="headerlink" title="6.2 params属性的4种用法"></a>6.2 params属性的4种用法</h2><ul>
<li>@RequestMapping(value&#x3D;”&#x2F;login”, params&#x3D;{<strong>“username”</strong>, “password”}) 表示：请求参数中必须包含 username 和 password，才能与当前标注的方法进行映射。</li>
<li>@RequestMapping(value&#x3D;”&#x2F;login”, params&#x3D;{<strong>“!username”</strong>, “password”}) 表示：请求参数中不能包含username参数，但必须包含password参数，才能与当前标注的方法进行映射。</li>
<li>@RequestMapping(value&#x3D;”&#x2F;login”, params&#x3D;{<strong>“username&#x3D;admin”</strong>, “password”}) 表示：请求参数中必须包含username参数，并且参数的值必须是admin，另外也必须包含password参数，才能与当前标注的方法进行映射。</li>
<li>@RequestMapping(value&#x3D;”&#x2F;login”, params&#x3D;{<strong>“username!&#x3D;admin”</strong>, “password”}) 表示：请求参数中必须包含username参数，但参数的值不能是admin，另外也必须包含password参数，才能与当前标注的方法进行映射。</li>
</ul>
<p><font color="red">PS：如果前端提交的参数，和后端要求的请求参数不一致，则出现<code>400</code>错误！！！</font></p>
<p><font color="red"><strong>HTTP状态码400的原因：请求参数格式不正确</strong></font>😆</p>
<h2 id="6-3-测试params属性"><a href="#6-3-测试params属性" class="headerlink" title="6.3 测试params属性"></a>6.3 测试params属性</h2><p>1、在 RequestMappingTestController 类中添加如下方法：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(value = &quot;/testParams&quot;, params = &#123;&quot;username&quot;, &quot;password&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">testParams</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;testParams&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>2、提供视图页面：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span> <span class="attr">xmlns:th</span>=<span class="string">&quot;http://www.thymeleaf.org&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>testParams<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>测试RequestMapping注解的Params属性<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>3、在index.html文件中添加超链接：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--测试RequestMapping的params属性--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">th:href</span>=<span class="string">&quot;@&#123;/testParams(username=&#x27;admin&#x27;,password=&#x27;123&#x27;)&#125;&quot;</span>&gt;</span>测试params属性<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>当然，你也可以这样写：这样写IDEA会报错，但不影响使用。</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">th:href</span>=<span class="string">&quot;@&#123;/testParams?username=admin&amp;password=123&#125;&quot;</span>&gt;</span>测试params属性<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>4、启动服务器，测试：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/%E6%B5%8B%E8%AF%95params%E5%B1%9E%E6%80%A7.png" alt="测试params属性"></p>
<p>假如发送请求时，没有传递username参数会怎样？</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">th:href</span>=<span class="string">&quot;@&#123;/testParams(password=&#x27;123&#x27;)&#125;&quot;</span>&gt;</span>测试params属性<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>启动服务器，测试：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/%E6%9C%AA%E4%BC%A0%E9%80%92username%E5%8F%82%E6%95%B0.png" alt="未传递username参数"></p>
<p>提示无效的请求参数，服务器无法或不会处理当前请求。</p>
<p>params属性剩下的三种情况，自行测试！！！！</p>
<h1 id="7-RequestMapping注解的headers属性"><a href="#7-RequestMapping注解的headers属性" class="headerlink" title="7. RequestMapping注解的headers属性"></a>7. RequestMapping注解的headers属性</h1><h2 id="7-1-认识headers属性"><a href="#7-1-认识headers属性" class="headerlink" title="7.1 认识headers属性"></a>7.1 认识headers属性</h2><p><code>headers</code>和<code>params</code>原理相同，用法也相同。</p>
<p>当前端提交的请求头信息和后端要求的请求头信息一致时，才能映射成功。</p>
<p>请求头信息怎么查看？</p>
<p>在浏览器中，F12打开控制台，找到Network，可以查看具体的请求协议和响应协议。在请求协议中可以看到请求头信息，例如：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/%E6%9F%A5%E7%9C%8B%E8%AF%B7%E6%B1%82%E5%A4%B4%E4%BF%A1%E6%81%AF.png" alt="查看请求头信息"></p>
<p>请求头信息和请求参数信息一样，都是键值对形式，例如上图中：</p>
<ul>
<li><code>Referer: http://localhost:8080/springmvc/</code>     键是<code>Referer</code>，值是<code>http://localhost:8080/springmvc/</code></li>
<li><code>Host: localhost:8080</code>     键是<code>Host</code>，值是<code>localhost:8080</code></li>
</ul>
<h2 id="7-2-headers属性的4种用法"><a href="#7-2-headers属性的4种用法" class="headerlink" title="7.2 headers属性的4种用法"></a>7.2 headers属性的4种用法</h2><ul>
<li>@RequestMapping(value&#x3D;”&#x2F;login”, headers&#x3D;{<strong>“Referer”</strong>, “Host”}) 表示：请求头信息中必须包含Referer和Host，才能与当前标注的方法进行映射。</li>
<li>@RequestMapping(value&#x3D;”&#x2F;login”, headers&#x3D;{<strong>“Referer”</strong>, “!Host”}) 表示：请求头信息中必须包含Referer，但不包含Host，才能与当前标注的方法进行映射。</li>
<li>@RequestMapping(value&#x3D;”&#x2F;login”, headers&#x3D;{<strong>“Referer&#x3D;<a href="http://localhost:8080/springmvc/">http://localhost:8080/springmvc/</a>“</strong>, “Host”}) 表示：请求头信息中必须包含Referer和Host，并且Referer的值<strong>必须是</strong><code>http://localhost:8080/springmvc/</code>，才能与当前标注的方法进行映射。</li>
<li>@RequestMapping(value&#x3D;”&#x2F;login”, headers&#x3D;{<strong>“Referer!&#x3D;<a href="http://localhost:8080/springmvc/">http://localhost:8080/springmvc/</a>“</strong>, “Host”}) 表示：请求头信息中必须包含Referer和Host，并且Referer的值<strong>不是</strong><code>http://localhost:8080/springmvc/</code>，才能与当前标注的方法进行映射。</li>
</ul>
<p>PS：如果前端提交的请求头信息，和后端要求的请求头信息不一致，则出现404错误！！！</p>
<h2 id="7-3-测试headers属性"><a href="#7-3-测试headers属性" class="headerlink" title="7.3 测试headers属性"></a>7.3 测试headers属性</h2><p>1、在 RequestMappingTestController 类中添加以下方法：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(value = &quot;/testHeaders&quot;, headers = &#123;&quot;Referer=http://localhost:8080/springmvc/&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">testHeaders</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;testHeaders&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>2、提供视图页面：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span> <span class="attr">xmlns:th</span>=<span class="string">&quot;http://www.thymeleaf.org&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>test Headers<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>测试RequestMapping注解的headers属性<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>3、在index.html页面中添加超链接：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--测试RequestMapping的headers属性--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">th:href</span>=<span class="string">&quot;@&#123;/testHeaders&#125;&quot;</span>&gt;</span>测试headers属性<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>4、启动服务器，测试结果：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/%E6%B5%8B%E8%AF%95headers%E5%B1%9E%E6%80%A7.png" alt="测试headers属性"></p>
<p>将后端控制器中的headers属性值进行修改：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(value=&quot;/testHeaders&quot;, headers = &#123;&quot;Referer=http://localhost:8888/springmvc/&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">testHeaders</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;testHeaders&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再次测试：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/headers%E9%94%AE%E5%80%BC%E5%AF%B9%E4%B8%8D%E5%8C%B9%E9%85%8D.png" alt="headers键值对不匹配"></p>
<p>其他情况自行测试！！！！</p>
]]></content>
      <categories>
        <category>Java</category>
        <category>SSM</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>Spring</tag>
        <tag>SpringMVC</tag>
      </tags>
  </entry>
  <entry>
    <title>【第1章】 初识SpringMVC</title>
    <url>/posts/49108/</url>
    <content><![CDATA[<p>参考视频：<a href="https://www.bilibili.com/video/BV1sC411L76f/">SpringMVC教程，SpringMVC从零到精通，老杜SpringMVC，动力节点SpringMVC</a></p>
<h1 id="0-学习前的知识储备"><a href="#0-学习前的知识储备" class="headerlink" title="0. 学习前的知识储备"></a>0. 学习前的知识储备</h1><ul>
<li><strong>JavaSE</strong></li>
<li><strong>HTML+CSS+JavaScript</strong></li>
<li><strong>Vue</strong></li>
<li><strong>AJAX + axios</strong></li>
<li><strong>Thymeleaf</strong></li>
<li><strong>Servlet</strong></li>
<li><strong>Maven</strong></li>
<li><strong>Spring</strong></li>
</ul>
<h1 id="1-什么是MVC"><a href="#1-什么是MVC" class="headerlink" title="1. 什么是MVC"></a>1. 什么是MVC</h1><p>MVC是一种软件架构模式（是一种软件架构设计思想，不止Java开发中用到，其它语言也需要用到），它将应用分为三块：</p>
<ul>
<li>M：Model（模型）</li>
<li>V：View（视图）</li>
<li>C：Controller（控制器）</li>
</ul>
<p>应用为什么要被分为三块，优点是什么？</p>
<ul>
<li>低耦合，扩展能力增强</li>
<li>代码复用性增强</li>
<li>代码可维护性增强</li>
<li>高内聚，让程序员更加专注业务的开发</li>
</ul>
<p>MVC将应用分为三块，每一块各司其职，都有自己专注的事情要做，他们属于分工协作，互相配合：</p>
<ul>
<li>Model：负责业务处理及数据的收集。</li>
<li>View：负责数据的展示</li>
<li>Controller：负责调度。它是一个调度中心，它来决定什么时候调用Model来处理业务，什么时候调用View视图来展示数据。</li>
</ul>
<p>MVC架构模式如下所示：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/MVC%E6%9E%B6%E6%9E%84%E6%A8%A1%E5%BC%8F.png" alt="MVC架构模式"></p>
<p>MVC架构模式的描述：前端浏览器发送请求给Web服务器，Web服务器中的Controller接收到用户的请求，Controller负责将前端提交的数据进行封装，然后Controller调用Model来处理业务，当Model处理完业务后会返回处理之后的数据给Controller，Controller再调用View来完成数据的展示，最终将结果响应给浏览器，浏览器进行渲染展示页面。</p>
<blockquote>
<p>什么是三层模型？MVC架构模式与三层模型有什么区别？</p>
</blockquote>
<p>三层模型：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/%E4%B8%89%E5%B1%82%E6%A8%A1%E5%9E%8B.png" alt="三层模型" style="zoom: 67%;">                            <img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/MVC%E6%9E%B6%E6%9E%84%E6%A8%A1%E5%BC%8F%E4%B8%8E%E4%B8%89%E5%B1%82%E6%A8%A1%E5%9E%8B.png" alt="MVC架构模式与三层模型" style="zoom: 67%;"></p>
<p>MVC和三层模型都采用了分层结构来设计应用程序，都是降低耦合度，提高扩展力，提高组件复用性。区别在于：他们的关注点不同，三层模型更加关注业务逻辑组件的划分。</p>
<p>MVC架构模式关注的是整个应用程序的层次关系和分离思想。现代的开发方式大部分都是MVC架构模式结合三层模型一起用。</p>
<h1 id="2-什么是SpringMVC"><a href="#2-什么是SpringMVC" class="headerlink" title="2. 什么是SpringMVC"></a>2. 什么是SpringMVC</h1><h2 id="2-1-SpringMVC概述"><a href="#2-1-SpringMVC概述" class="headerlink" title="2.1 SpringMVC概述"></a>2.1 SpringMVC概述</h2><p>SpringMVC是一个实现了MVC架构模式的Web框架，底层基于Servlet实现。</p>
<p>SpringMVC已经将MVC架构模式实现了，因此只要我们是基于SpringMVC框架写代码，编写的程序就是符合MVC架构模式的。（<strong>MVC的架子搭好了，我们只需要添添补补</strong>）</p>
<p>Spring框架中有一个子项目叫做Spring Web，Spring Web子项目当中包含很多模块，例如：</p>
<ul>
<li>Spring MVC</li>
<li>Spring WebFlux</li>
<li>Spring Web Services</li>
<li>Spring Web Flow</li>
<li>Spring WebSocket</li>
<li>Spring Web Services Client</li>
</ul>
<p>可见SpringMVC是Spring Web子项目当中的一个模块。因此也可以说SpringMVC是Spring框架的一部分。</p>
<p>所以学习SpringMVC框架之前要先学习Spring框架中的IoC和AOP等内容。</p>
<p>另外，使用SpringMVC框架的时候同样也可以使用IoC和AOP。</p>
<p>以下就是Spring官方给出的Spring架构图，其中Web中的servlet指的就是Spring MVC：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/Spring%E6%9E%B6%E6%9E%84%E5%9B%BE.png" alt="Spring架构图"></p>
<h2 id="2-2-SpringMVC帮我们做了什么"><a href="#2-2-SpringMVC帮我们做了什么" class="headerlink" title="2.2 SpringMVC帮我们做了什么"></a>2.2 SpringMVC帮我们做了什么</h2><p>SpringMVC框架帮我们做了什么，与纯粹的Servlet开发有什么区别？</p>
<ul>
<li>入口控制：SpringMVC框架通过DispatcherServlet作为入口控制器，负责接收请求和分发请求。而在Servlet开发中，需要自己编写Servlet程序，并在web.xml中进行配置，才能接受和处理请求。 </li>
<li>在SpringMVC中，表单提交时可以自动将表单数据绑定到相应的JavaBean对象中，只需要在控制器方法的参数列表中声明该JavaBean对象即可，无需手动获取和赋值表单数据。而在纯粹的Servlet开发中，这些都是需要自己手动完成的。</li>
<li>IoC容器：SpringMVC框架通过IoC容器管理对象，只需要在配置文件中进行相应的配置即可获取实例对象，而在Servlet开发中需要手动创建对象实例。 </li>
<li>统一处理请求：SpringMVC框架提供了拦截器、异常处理器等统一处理请求的机制，并且可以灵活地配置这些处理器。而在Servlet开发中，需要自行编写过滤器、异常处理器等，增加了代码的复杂度和开发难度。 </li>
<li>视图解析：SpringMVC框架提供了多种视图模板，如JSP、Freemarker、Velocity等，并且支持国际化、主题等特性。而在Servlet开发中需要手动处理视图层，增加了代码的复杂度。</li>
</ul>
<p>总之，与Servlet开发相比，SpringMVC框架可以帮我们节省很多时间和精力，减少代码的复杂度，更加专注于业务开发。同时，也提供了更多的功能和扩展性，可以更好地满足企业级应用的开发需求。</p>
<h2 id="2-3-SpringMVC框架的特点"><a href="#2-3-SpringMVC框架的特点" class="headerlink" title="2.3 SpringMVC框架的特点"></a>2.3 SpringMVC框架的特点</h2><ul>
<li>轻量级：相对于其他Web框架，Spring MVC框架比较小巧轻便。（只有几个几百KB左右的Jar包文件） </li>
<li>模块化：请求处理过程被分成多个模块，以模块化的方式进行处理。<ul>
<li>控制器模块：Controller</li>
<li>业务逻辑模块：Model</li>
<li>视图模块：View</li>
</ul>
</li>
<li>依赖注入：Spring MVC框架利用Spring框架的依赖注入功能实现对象的管理，实现松散耦合。</li>
<li>易于扩展：提供了很多口子，允许开发者根据需要插入自己的代码，以扩展实现应用程序的特殊需求。<ul>
<li>Spring MVC框架允许开发人员通过自定义模块和组件来扩展和增强框架的功能。</li>
<li>Spring MVC框架与其他Spring框架及第三方框架集成得非常紧密，这使得开发人员可以非常方便地集成其他框架，以获得更好的功能。</li>
</ul>
</li>
<li>易于测试：支持单元测试框架，提高代码质量和可维护性。（对SpringMVC中的Controller测试时，不需要依靠Web服务器。）</li>
<li>自动化配置：提供自动化配置，减少配置细节。<ul>
<li>Spring MVC框架基于约定大于配置的原则，对常用的配置约定进行自动化配置。</li>
</ul>
</li>
<li>灵活性：Spring MVC框架支持多种视图技术，如JSP、FreeMarker、Thymeleaf、FreeMarker等，针对不同的视图配置不同的视图解析器即可。</li>
</ul>
<blockquote>
<p>自用软件相关版本</p>
</blockquote>
<ul>
<li>JDK版本：Java17</li>
<li>Maven版本：3.6.1</li>
<li>Tomcat版本：10</li>
<li>Spring版本：6.1.4</li>
<li>SpringMVC版本：6.1.4</li>
<li>IDEA版本：2022.2</li>
<li>Thymeleaf版本：3.1.2</li>
</ul>
<h1 id="3-第一个SpringMVC程序"><a href="#3-第一个SpringMVC程序" class="headerlink" title="3. 第一个SpringMVC程序"></a>3. 第一个SpringMVC程序</h1><h2 id="3-1-创建Maven模块"><a href="#3-1-创建Maven模块" class="headerlink" title="3.1 创建Maven模块"></a>3.1 创建Maven模块</h2><p>1、创建Empty Project，起名为springmvc (<font color="red">PS：记得设置项目JDK版本和Maven仓库</font>)</p>
<p>2、创建Maven模块，起名为springmvc-001</p>
<p>3、将<code>pom.xml</code>文件中的打包方式修改为<code>war</code></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.muyoukule<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springmvc-001<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 打包方式设置为war方式 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">packaging</span>&gt;</span>war<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>4、添加如下依赖</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Spring MVC依赖 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-webmvc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.1.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--日志框架Logback依赖--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>ch.qos.logback<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>logback-classic<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.5.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--Servlet依赖--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>jakarta.servlet<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jakarta.servlet-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--Spring6和Thymeleaf整合依赖--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.thymeleaf<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>thymeleaf-spring6<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1.2.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="3-2-添加web支持"><a href="#3-2-添加web支持" class="headerlink" title="3.2 添加web支持"></a>3.2 添加web支持</h2><p>1、在main目录下创建一个webapp目录</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/webapp%E7%9B%AE%E5%BD%95.png" alt="webapp目录"></p>
<p>2、添加web.xml配置文件</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/%E6%B7%BB%E5%8A%A0web.xml%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6.png" alt="添加web.xml配置文件" style="zoom:50%;">

<p>注意<code>web.xml</code>文件的位置：\springmvc-001\ <code>src\main\webapp\</code> WEB-INF\web.xml</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/web.xml%E6%96%87%E4%BB%B6%E7%9A%84%E4%BD%8D%E7%BD%AE.png" alt="web.xml文件的位置" style="zoom:50%;">

<p>添加web支持后的目录结构：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/%E6%B7%BB%E5%8A%A0web%E6%94%AF%E6%8C%81%E5%90%8E%E7%9A%84%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84.png" alt="添加web支持后的目录结构" style="zoom:67%;">

<h2 id="3-3-配置web-xml文件"><a href="#3-3-配置web-xml文件" class="headerlink" title="3.3 配置web.xml文件"></a>3.3 配置web.xml文件</h2><p>Spring MVC是一个Web框架，在JavaWeb中谁来负责接收请求、处理请求、以及响应呢？</p>
<p>当然是Servlet。在SpringMVC框架中已经为我们写好了一个Servlet，它的名字叫做：<code>DispatcherServlet</code>，我们称其为 <code>前端控制器</code> </p>
<p>既然是Servlet，那么它就需要在web.xml文件中进行配置：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">web-app</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://xmlns.jcp.org/xml/ns/javaee&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_4_0.xsd&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">version</span>=<span class="string">&quot;4.0&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--SpringMVC提供的前端控制器--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>springmvc<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>org.springframework.web.servlet.DispatcherServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>springmvc<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- /* 表示任何一个请求都交给DispatcherServlet来处理 --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- / 表示当请求不是xx.jsp的时候，DispatcherServlet来负责处理本次请求--&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- jsp本质就是Servlet，因此如果请求是jsp的话，应该走它自己的Servlet，而不应该走DispatcherServlet --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 因此我们的 url-pattern 使用 / --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">    </span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>DispatcherServlet</code>是SpringMVC框架为我们提供的最核心的类，它是整个SpringMVC框架的前端控制器，负责接收HTTP请求、将请求路由到处理程序、处理响应信息，最终将响应返回给客户端。DispatcherServlet是Web应用程序的主要入口点之一，它的职责包括：</p>
<ul>
<li>接收客户端的HTTP请求：DispatcherServlet监听来自Web浏览器的HTTP请求，然后根据请求的URL将请求数据解析为Request对象</li>
<li>处理请求的URL：DispatcherServlet将请求的URL（Uniform Resource Locator）与处理程序进行匹配，确定要调用哪个控制器（Controller）来处理此请求</li>
<li>调用相应的控制器：DispatcherServlet将请求发送给找到的控制器处理，控制器将执行业务逻辑，然后返回一个模型对象（Model）</li>
<li>渲染视图：DispatcherServlet将调用视图引擎，将模型对象呈现为用户可以查看的HTML页面</li>
<li>返回响应给客户端：DispatcherServlet将为用户生成的响应发送回浏览器，响应可以包括表单、JSON、XML、HTML以及其它类型的数据</li>
</ul>
<h2 id="3-4-编写控制器FirstController"><a href="#3-4-编写控制器FirstController" class="headerlink" title="3.4 编写控制器FirstController"></a>3.4 编写控制器FirstController</h2><p>DispatcherServlet接收到请求之后，会根据请求路径分发到对应的Controller，Controller来负责处理请求的核心业务。在SpringMVC框架中Controller是一个普通的Java类（一个普通的POJO类，不需要继承任何类或实现任何接口）。</p>
<p><strong>需要注意</strong>的是：POJO类要纳入IoC容器来管理，POJO类的生命周期由Spring来管理，因此要使用注解标注：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.muyoukule.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FirstController</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-5-配置springmvc-servlet-xml文件"><a href="#3-5-配置springmvc-servlet-xml文件" class="headerlink" title="3.5 配置springmvc-servlet.xml文件"></a>3.5 配置springmvc-servlet.xml文件</h2><p>SpringMVC框架有它自己的配置文件，该配置文件的名字默认为：<code>&lt;servlet-name&gt;-servlet.xml</code>，默认存放的位置是WEB-INF目录下：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/context https://www.springframework.org/schema/context/spring-context.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--组件扫描--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">&quot;com.muyoukule.controller&quot;</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--视图解析器--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;thymeleafViewResolver&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.thymeleaf.spring6.view.ThymeleafViewResolver&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--作用于视图渲染的过程中，可以设置视图渲染后输出时采用的编码字符集--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;characterEncoding&quot;</span> <span class="attr">value</span>=<span class="string">&quot;UTF-8&quot;</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--如果配置多个视图解析器，它来决定优先使用哪个视图解析器，它的值越小优先级越高--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;order&quot;</span> <span class="attr">value</span>=<span class="string">&quot;1&quot;</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--当 ThymeleafViewResolver 渲染模板时，会使用该模板引擎来解析、编译和渲染模板--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;templateEngine&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;org.thymeleaf.spring6.SpringTemplateEngine&quot;</span>&gt;</span></span><br><span class="line">                <span class="comment">&lt;!--用于指定 Thymeleaf 模板引擎使用的模板解析器。模板解析器负责根据模板位置、模板资源名称、文件编码等信息，加载模板并对其进行解析--&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;templateResolver&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;org.thymeleaf.spring6.templateresolver.SpringResourceTemplateResolver&quot;</span>&gt;</span></span><br><span class="line">                        <span class="comment">&lt;!--设置模板文件的位置（前缀）--&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;prefix&quot;</span> <span class="attr">value</span>=<span class="string">&quot;/WEB-INF/templates/&quot;</span>/&gt;</span></span><br><span class="line">                        <span class="comment">&lt;!--设置模板文件后缀（后缀），Thymeleaf文件扩展名不一定是html，也可以是其他，例如txt，大部分都是html--&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;suffix&quot;</span> <span class="attr">value</span>=<span class="string">&quot;.html&quot;</span>/&gt;</span></span><br><span class="line">                        <span class="comment">&lt;!--设置模板类型，例如：HTML,TEXT,JAVASCRIPT,CSS等--&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;templateMode&quot;</span> <span class="attr">value</span>=<span class="string">&quot;HTML&quot;</span>/&gt;</span></span><br><span class="line">                        <span class="comment">&lt;!--用于模板文件在读取和解析过程中采用的编码字符集--&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;characterEncoding&quot;</span> <span class="attr">value</span>=<span class="string">&quot;UTF-8&quot;</span>/&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>在WEB-INF目录下新建<code>springmvc-servlet.xml</code>文件，并且提供以上配置信息：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/%E6%8F%90%E4%BE%9B%E9%85%8D%E7%BD%AE%E4%BF%A1%E6%81%AF.png" alt="提供配置信息"></p>
<p>以上配置主要两项：</p>
<ul>
<li>组件扫描。Spring扫描这个包中的类，将这个包中的类实例化并纳入IoC容器的管理。</li>
<li>视图解析器。视图解析器（View Resolver）的作用主要是将Controller方法返回的逻辑视图名称解析成实际的视图对象。视图解析器将解析出的视图对象返回给DispatcherServlet，并最终由DispatcherServlet将该视图对象转化为响应结果，呈现给用户。</li>
</ul>
<p><font color="red">PS：如果采用了其它视图，请配置对应的视图解析器。</font>例如：</p>
<ul>
<li>JSP的视图解析器：InternalResourceViewResolver</li>
<li>FreeMarker视图解析器：FreeMarkerViewResolver</li>
<li>Velocity视图解析器：VelocityViewResolver</li>
</ul>
<h2 id="3-6-提供视图"><a href="#3-6-提供视图" class="headerlink" title="3.6 提供视图"></a>3.6 提供视图</h2><p>在WEB-INF目录下新建<code>templates</code>目录，在templates目录中新建html文件。例如：first.html，并提供以下代码：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--指定 th 命名空间，让 Thymeleaf 标准表达式可以被解析和执行--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--th不是固定的，可以指定其它的命名空间，只不过大部分情况下用th--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--表示程序中出现的 th 开头的后面代码都是 Thymeleaf 语法，需要被 Thymeleaf识别--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span> <span class="attr">xmlns:th</span>=<span class="string">&quot;http://www.thymeleaf.org&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>first springmvc<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>我的第一个Spring MVC程序<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>对于每一个Thymeleaf文件来说 <code>xmlns:th=&quot;http://www.thymeleaf.org&quot;</code> 是必须要写的，为了方便后续开发，可以将其添加到html模板文件中：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/%E6%B7%BB%E5%8A%A0%E5%88%B0html%E6%A8%A1%E6%9D%BF%E6%96%87%E4%BB%B6.png" alt="添加到html模板文件" style="zoom:50%;">

<h2 id="3-7-控制器FirstController处理请求返回逻辑视图名称"><a href="#3-7-控制器FirstController处理请求返回逻辑视图名称" class="headerlink" title="3.7 控制器FirstController处理请求返回逻辑视图名称"></a>3.7 控制器FirstController处理请求返回逻辑视图名称</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FirstController</span> &#123;</span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/haha&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String 名字随意() &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;正在处理请求....&quot;</span>);</span><br><span class="line">        <span class="comment">// 返回逻辑视图名称（决定跳转到哪个页面）</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;first&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>测试</p>
</blockquote>
<p>1、配置Tomcat服务器</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/%E9%85%8D%E7%BD%AETomcat%E6%9C%8D%E5%8A%A1%E5%99%A8.png" alt="配置Tomcat服务器" style="zoom: 50%;">

<p>2、部署Web模块到Tomcat服务器</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/%E9%83%A8%E7%BD%B2Web%E6%A8%A1%E5%9D%97%E5%88%B0Tomcat%E6%9C%8D%E5%8A%A1%E5%99%A8.png" alt="部署Web模块到Tomcat服务器" style="zoom: 50%;">

<p>3、启动Tomcat服务器</p>
<p>如果在控制台输出的信息有中文乱码，修改Tomcat服务器配置文件：<code>apache-tomcat-10.1.19\conf\logging.properties</code> ，将下面的 <code>GBK</code> 全部修改为 <code>UTF-8</code> 即可。</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/%E5%A4%84%E7%90%86Tomcat%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B9%B1%E7%A0%81.png" alt="处理Tomcat服务器乱码" style="zoom:50%;">

<p>4、在浏览器地址栏上输入地址：<a href="http://localhost:8080/springmvc/haha">http://localhost:8080/springmvc/haha</a></p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/%E6%88%91%E7%9A%84%E7%AC%AC%E4%B8%80%E4%B8%AASpringMVC%E7%A8%8B%E5%BA%8F.png" alt="我的第一个SpringMVC程序"></p>
<p>5、后端控制台输出：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/%E5%90%8E%E7%AB%AF%E6%8E%A7%E5%88%B6%E5%8F%B0%E8%BE%93%E5%87%BA.png" alt="后端控制台输出"></p>
<h2 id="3-8-执行流程总结"><a href="#3-8-执行流程总结" class="headerlink" title="3.8 执行流程总结"></a>3.8 执行流程总结</h2><ol>
<li>浏览器发送请求：<a href="http://localhost:8080/springmvc/haha">http://localhost:8080/springmvc/haha</a></li>
<li>SpringMVC的前端控制器DispatcherServlet接收到请求</li>
<li>DispatcherServlet根据请求路径 &#x2F;haha 映射到 FirstController#名字随意()，调用该方法</li>
<li>FirstController#名字随意() 处理请求</li>
<li>FirstController#名字随意() 返回逻辑视图名称 first 给视图解析器</li>
<li>视图解析器找到 <code>/WEB-INF/templates/first.html</code> 文件，并进行解析，生成视图解析对象返回给前端控制器DispatcherServlet</li>
<li>前端控制器DispatcherServlet响应结果到浏览器</li>
</ol>
<h2 id="3-9-Controller编写多个方法"><a href="#3-9-Controller编写多个方法" class="headerlink" title="3.9 Controller编写多个方法"></a>3.9 Controller编写多个方法</h2><p>一个Controller可以提供多个方法，每个方法通常是处理对应的请求。例如：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FirstController</span> &#123;</span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/haha&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String 名字随意() &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;正在处理请求....&quot;</span>);</span><br><span class="line">        <span class="comment">// 返回逻辑视图名称（决定跳转到哪个页面）</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;first&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/other&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">other</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;正在处理其它请求...&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;other&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>提供 other.html 文件</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span> <span class="attr">xmlns:th</span>=<span class="string">&quot;http://www.thymeleaf.org&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>other<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>other ...<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>在 first.html 文件中，添加超链接，用超链接发送 <code>/other</code> 请求：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--指定 th 命名空间，让 Thymeleaf 标准表达式可以被解析和执行--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--th不是固定的，可以指定其它的命名空间，只不过大部分情况下用th--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--表示程序中出现的 th 开头的后面代码都是 Thymeleaf语法，需要被 Thymeleaf 识别--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span> <span class="attr">xmlns:th</span>=<span class="string">&quot;http://www.thymeleaf.org&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>first springmvc<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>我的第一个Spring MVC程序<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- th: 表示后面的代码可以编写Thymeleaf语法，可以被Thymeleaf语法解析 --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- Thymeleaf检测到以 / 开始，表示绝对路径，自动会将webapp的上下文路径加上去 --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 最终的效果是：href=&quot;/springmvc/other&quot; --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">th:href</span>=<span class="string">&quot;@&#123;/other&#125;&quot;</span>&gt;</span>other请求<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>启动Tomcat，打开浏览器，输入请求路径：<a href="http://localhost:8080/springmvc/haha">http://localhost:8080/springmvc/haha</a></p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/%E6%90%BA%E5%B8%A6%E8%B6%85%E9%93%BE%E6%8E%A5.png" alt="携带超链接"></p>
<p>点击超链接：other请求</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/%E7%82%B9%E5%87%BB%E8%B6%85%E9%93%BE%E6%8E%A5.png" alt="点击超链接"></p>
<h1 id="4-第二个SpringMVC程序"><a href="#4-第二个SpringMVC程序" class="headerlink" title="4. 第二个SpringMVC程序"></a>4. 第二个SpringMVC程序</h1><h2 id="4-1-创建Maven模块"><a href="#4-1-创建Maven模块" class="headerlink" title="4.1 创建Maven模块"></a>4.1 创建Maven模块</h2><p>1、<code>pom.xml</code> 文件中添加依赖</p>
<ul>
<li>springmvc依赖</li>
<li>logback依赖</li>
<li>servlet依赖（scope为provided）</li>
<li>thymeleaf与spring6整合依赖</li>
</ul>
<p>2、打包方式 <code>war</code></p>
<h2 id="4-2-添加web支持"><a href="#4-2-添加web支持" class="headerlink" title="4.2 添加web支持"></a>4.2 添加web支持</h2><p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/webapp%E6%B2%A1%E6%9C%89%E5%B0%8F%E8%93%9D%E7%82%B9.png" alt="webapp没有小蓝点"></p>
<blockquote>
<p>webapp目录没有小蓝点怎么办？</p>
</blockquote>
<p>添加Web支持：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/%E6%B7%BB%E5%8A%A0Web%E6%94%AF%E6%8C%81.png" alt="添加Web支持" style="zoom:50%;">

<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/%E4%BF%AE%E6%94%B9web.xml%E6%96%87%E4%BB%B6%E8%B7%AF%E5%BE%84.png" alt="修改web.xml文件路径" style="zoom: 50%;">

<h2 id="4-3-配置web-xml文件"><a href="#4-3-配置web-xml文件" class="headerlink" title="4.3 配置web.xml文件"></a>4.3 配置web.xml文件</h2><p><font color="red"><strong>PS：SpringMVC配置文件的名字和路径是可以手动设置的。</strong></font>😮 如下：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">web-app</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://xmlns.jcp.org/xml/ns/javaee&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_4_0.xsd&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">version</span>=<span class="string">&quot;4.0&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--配置前端控制器--&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>springmvc<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>org.springframework.web.servlet.DispatcherServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--手动设置springmvc配置文件的路径及名字--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>contextConfigLocation<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>classpath:springmvc.xml<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--为了提高用户的第一次访问效率，建议在web服务器启动时初始化前端控制器--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">load-on-startup</span>&gt;</span>1<span class="tag">&lt;/<span class="name">load-on-startup</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>springmvc<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>通过<code>&lt;init-param&gt;</code>来设置SpringMVC配置文件的路径和名字，在DispatcherServlet的<code>init</code>方法执行时设置的。</strong><br><strong><code>&lt;load-on-startup&gt;1&lt;/load-on-startup&gt;</code>建议加上，这样可以提高用户第一次访问的效率。表示在web服务器启动时初始化DispatcherServlet。</strong></p>
<h2 id="4-4-编写IndexController"><a href="#4-4-编写IndexController" class="headerlink" title="4.4 编写IndexController"></a>4.4 编写IndexController</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IndexController</span> &#123;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toIndex</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;index&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>表示请求路径如果是：<a href="http://localhost:8080/springmvc/">http://localhost:8080/springmvc/</a> ，则直接进入 <code>/WEB-INF/templates/index.html</code> 页面。</p>
<p><strong>这就是项目的首页效果！！！！！</strong></p>
<h2 id="4-5-在resources目录下配置springmvc-xml文件"><a href="#4-5-在resources目录下配置springmvc-xml文件" class="headerlink" title="4.5 在resources目录下配置springmvc.xml文件"></a>4.5 在resources目录下配置springmvc.xml文件</h2><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/%E9%85%8D%E7%BD%AEspringmvc.xml%E6%96%87%E4%BB%B6.png" alt="配置springmvc.xml文件" style="zoom: 67%;">

<p>配置内容和之前一样，一个是视图解析器，一个是组件扫描。</p>
<h2 id="4-6-提供视图"><a href="#4-6-提供视图" class="headerlink" title="4.6 提供视图"></a>4.6 提供视图</h2><p>在WEB-INF目录下新建<code>templates</code>目录，在templates目录中新建index.html文件：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span> <span class="attr">xmlns:th</span>=<span class="string">&quot;http://www.thymeleaf.org&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>index page<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>index page<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>测试</p>
</blockquote>
<p>部署到web服务器，启动web服务器，打开浏览器，在地址栏上输入：<a href="http://localhost:8080/springmvc/">http://localhost:8080/springmvc/</a></p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/SpringMVC/indexPage.png" alt="indexPage"></p>
]]></content>
      <categories>
        <category>Java</category>
        <category>SSM</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>Spring</tag>
        <tag>SpringMVC</tag>
      </tags>
  </entry>
  <entry>
    <title>国产&quot;猛男&quot;——MyBatis-Plus</title>
    <url>/posts/33309/</url>
    <content><![CDATA[<p>MyBatis-Plus官网 1 ：<a href="https://baomidou.com/">https://baomidou.com/</a></p>
<p>MyBatis-Plus官网 2：<a href="https://mybatis.plus/">https://mybatis.plus/</a></p>
<h1 id="1-MyBatis-Plus-概述"><a href="#1-MyBatis-Plus-概述" class="headerlink" title="1. MyBatis-Plus 概述"></a>1. MyBatis-Plus 概述</h1><h2 id="1-1-为什么要学？"><a href="#1-1-为什么要学？" class="headerlink" title="1.1 为什么要学？"></a>1.1 为什么要学？</h2><p><del>MyBatis-Plus只需简单配置即可快速进行单表 CRUD 操作，简单的 CRUD 操作不再需要我们书写。（肯定不是因为这个）</del></p>
<p>MyBatis-Plus 由国人开发，文档很详细易上手，编码符合国人习惯，并且已连续 5 年（2017、2018 、2019、2020、2021）获得”OSC 年度最受欢迎中国开源软件”殊荣。最最最重要的是官方为我们提供了自动生成代码的代码生成器…真的是太贴心了！！🤩这不就相当于是别人都把饭喂你嘴里了吗？你还有什么理由不吃呢？😂</p>
<p><strong>PS：本文中，MP 是 MyBatis-Plus 的简写。</strong></p>
<h2 id="1-2-简介"><a href="#1-2-简介" class="headerlink" title="1.2 简介"></a>1.2 简介</h2><p><a href="https://github.com/baomidou/mybatis-plus">MyBatis-Plus</a>（简称 MP）是一个 <a href="https://www.mybatis.org/mybatis-3/">MyBatis</a> 的增强工具，在 MyBatis 的基础上只做增强不做改变，为简化开发、提高效率而生。</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/MyBatisPlus/MyBatis-Plus%E7%AE%80%E4%BB%8B.png" alt="MyBatis-Plus简介"></p>
<p>从这张图中我们可以看出 MP 旨在成为 MyBatis 的最好搭档，而不是替换 MyBatis ，所以可以理解为 MP 是 MyBatis 的一套增强工具，它是在 MyBatis 的基础上进行开发的，我们虽然使用 MP 但是底层依然是 MyBatis 的东西，也就是说我们也可以在 MP 中写 MyBatis 的内容。</p>
<p><strong>PS：使用 MP 可以节省代码的编写，尽量 <font color="red">不要同时</font> 导入 MP 和 MyBatis，避免存在依赖错误。</strong></p>
<h2 id="1-3-特性"><a href="#1-3-特性" class="headerlink" title="1.3 特性"></a>1.3 特性</h2><ul>
<li><strong>无侵入</strong>：只做增强不做改变，引入它不会对现有工程产生影响，如丝般顺滑</li>
<li><strong>损耗小</strong>：启动即会自动注入基本 CURD，性能基本无损耗，直接面向对象操作</li>
<li><strong>强大的 CRUD 操作</strong>：内置通用 Mapper、通用 Service，仅仅通过少量配置即可实现单表大部分 CRUD 操作，更有强大的条件构造器，满足各类使用需求（  <font color="red">言外之意，简单的 CRUD 操作不再需要我们书写</font>  ）</li>
<li><strong>支持 Lambda 形式调用</strong>：通过 Lambda 表达式，方便的编写各类查询条件，无需再担心字段写错</li>
<li><strong>支持主键自动生成</strong>：支持多达 4 种主键策略(内含分布式唯一 ID 生成器 - Sequence)，可自由配置，完美解决主键问题</li>
<li><strong>支持 ActiveRecord 模式</strong>：支持 ActiveRecord 形式调用，实体类只需继承 Model 类即可进行强大的 CRUD 操作</li>
<li><strong>支持自定义全局通用操作</strong>：支持全局通用方法注入( Write once, use anywhere )</li>
<li><strong>内置代码生成器</strong>：采用代码或者 Maven 插件可快速生成 Mapper 、 Model 、 Service 、 Controller 层代码，支持模板引擎，更有超多自定义配置等您来使用</li>
<li><strong>内置分页插件</strong>：基于 MyBatis 物理分页，开发者无需关心具体操作，配置好插件之后，写分页等同于普通 List 查询</li>
<li><strong>分页插件支持多种数据库</strong>：支持 MySQL、MariaDB、Oracle、DB2、H2、HSQL、SQLite、Postgre、SQLServer 等多种数据库</li>
<li><strong>内置性能分析插件</strong>：可输出 SQL 语句以及其执行时间，建议开发测试时启用该功能，能快速揪出慢查询</li>
<li><strong>内置全局拦截插件</strong>：提供全表 delete 、 update 操作智能分析阻断，也可自定义拦截规则，预防误操作</li>
</ul>
<h1 id="2-快速开始"><a href="#2-快速开始" class="headerlink" title="2. 快速开始"></a>2. 快速开始</h1><p>接下来将通过一个简单的 Demo 来阐述 MP 的强大功能，在此之前，假设你已经：</p>
<ul>
<li>拥有 Java 开发环境以及相应 IDE</li>
<li>熟悉 Spring Boot</li>
<li>熟悉 Maven</li>
</ul>
<h2 id="2-1-环境准备"><a href="#2-1-环境准备" class="headerlink" title="2.1 环境准备"></a>2.1 环境准备</h2><p>现有一张 <code>User</code> 表，其表结构如下：</p>
<table>
<thead>
<tr>
<th align="center">id</th>
<th align="center">name</th>
<th align="center">age</th>
<th align="center">email</th>
</tr>
</thead>
<tbody><tr>
<td align="center">1</td>
<td align="center">Jone</td>
<td align="center">18</td>
<td align="center"><a href="mailto:&#116;&#101;&#115;&#116;&#x31;&#x40;&#98;&#x61;&#x6f;&#x6d;&#105;&#x64;&#111;&#x75;&#x2e;&#x63;&#x6f;&#x6d;">&#116;&#101;&#115;&#116;&#x31;&#x40;&#98;&#x61;&#x6f;&#x6d;&#105;&#x64;&#111;&#x75;&#x2e;&#x63;&#x6f;&#x6d;</a></td>
</tr>
<tr>
<td align="center">2</td>
<td align="center">Jack</td>
<td align="center">20</td>
<td align="center"><a href="mailto:&#116;&#x65;&#x73;&#116;&#x32;&#x40;&#98;&#97;&#111;&#x6d;&#x69;&#x64;&#x6f;&#117;&#46;&#x63;&#111;&#109;">&#116;&#x65;&#x73;&#116;&#x32;&#x40;&#98;&#97;&#111;&#x6d;&#x69;&#x64;&#x6f;&#117;&#46;&#x63;&#111;&#109;</a></td>
</tr>
<tr>
<td align="center">3</td>
<td align="center">Tom</td>
<td align="center">28</td>
<td align="center"><a href="mailto:&#116;&#x65;&#115;&#x74;&#51;&#x40;&#98;&#x61;&#111;&#109;&#x69;&#100;&#x6f;&#x75;&#x2e;&#x63;&#111;&#109;">&#116;&#x65;&#115;&#x74;&#51;&#x40;&#98;&#x61;&#111;&#109;&#x69;&#100;&#x6f;&#x75;&#x2e;&#x63;&#111;&#109;</a></td>
</tr>
<tr>
<td align="center">4</td>
<td align="center">Sandy</td>
<td align="center">21</td>
<td align="center"><a href="mailto:&#x74;&#101;&#115;&#116;&#x34;&#x40;&#98;&#97;&#x6f;&#x6d;&#x69;&#100;&#x6f;&#x75;&#46;&#x63;&#111;&#x6d;">&#x74;&#101;&#115;&#116;&#x34;&#x40;&#98;&#97;&#x6f;&#x6d;&#x69;&#100;&#x6f;&#x75;&#46;&#x63;&#111;&#x6d;</a></td>
</tr>
<tr>
<td align="center">5</td>
<td align="center">Billie</td>
<td align="center">24</td>
<td align="center"><a href="mailto:&#116;&#101;&#x73;&#x74;&#53;&#64;&#x62;&#x61;&#111;&#x6d;&#x69;&#x64;&#111;&#117;&#46;&#x63;&#x6f;&#109;">&#116;&#101;&#x73;&#x74;&#53;&#64;&#x62;&#x61;&#111;&#x6d;&#x69;&#x64;&#111;&#117;&#46;&#x63;&#x6f;&#109;</a></td>
</tr>
</tbody></table>
<blockquote>
<p>步骤</p>
</blockquote>
<p>1、创建一个数据库 <code>mybatis_plus</code></p>
<p>2、创建 user 表</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `<span class="keyword">user</span>`;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `<span class="keyword">user</span>`</span><br><span class="line">(</span><br><span class="line">    id <span class="type">BIGINT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;主键ID&#x27;</span>,</span><br><span class="line">    name <span class="type">VARCHAR</span>(<span class="number">30</span>) <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;姓名&#x27;</span>,</span><br><span class="line">    age <span class="type">INT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;年龄&#x27;</span>,</span><br><span class="line">    email <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;邮箱&#x27;</span>,</span><br><span class="line">    <span class="keyword">PRIMARY</span> KEY (id)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> `<span class="keyword">user</span>`;</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `<span class="keyword">user</span>` (id, name, age, email) <span class="keyword">VALUES</span></span><br><span class="line">(<span class="number">1</span>, <span class="string">&#x27;Jone&#x27;</span>, <span class="number">18</span>, <span class="string">&#x27;test1@baomidou.com&#x27;</span>),</span><br><span class="line">(<span class="number">2</span>, <span class="string">&#x27;Jack&#x27;</span>, <span class="number">20</span>, <span class="string">&#x27;test2@baomidou.com&#x27;</span>),</span><br><span class="line">(<span class="number">3</span>, <span class="string">&#x27;Tom&#x27;</span>, <span class="number">28</span>, <span class="string">&#x27;test3@baomidou.com&#x27;</span>),</span><br><span class="line">(<span class="number">4</span>, <span class="string">&#x27;Sandy&#x27;</span>, <span class="number">21</span>, <span class="string">&#x27;test4@baomidou.com&#x27;</span>),</span><br><span class="line">(<span class="number">5</span>, <span class="string">&#x27;Billie&#x27;</span>, <span class="number">24</span>, <span class="string">&#x27;test5@baomidou.com&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/MyBatisPlus/%E5%88%9B%E5%BB%BAUser%E8%A1%A8.png" alt="创建User表"></p>
<p>3、使用 IDEA 初始化一个 SpringBoot 项目 mybatis_plus，选择 Spring Web 和 Lombok 依赖进行导入。</p>
<p>4、导入其他依赖</p>
<p>由于这个 <code>mybatis-plus-boot-starter</code> 包含对 Mybatis 的自动装配，因此完全可以替换掉 Mybatis 的 starter 。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--数据库驱动--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.0.31<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--mybatis-plus--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.5.3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><font color="red"><strong>PS：注意 SpringBoot 版本要与 Mybatis-Plus 版本相对应</strong></font></p>
<p>5、编写配置文件 <code>application.yml</code> 连接数据库</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">datasource:</span></span><br><span class="line">  <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">  <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/mybatis_plus?serverTimezone=Asia/Shanghai&amp;useUnicode=true&amp;characterEncoding=utf-8&amp;zeroDateTimeBehavior=convertToNull&amp;useSSL=false&amp;allowPublicKeyRetrieval=true</span></span><br><span class="line">  <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">password:</span> <span class="string">root</span></span><br></pre></td></tr></table></figure>

<p>6、编写实体类 <code>User.java</code> (此处使用了 <a href="https://www.projectlombok.org/">Lombok</a> 简化代码)</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@TableName(&quot;`user`&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">    <span class="keyword">private</span> String email;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>7、编写 Mapper 包下的 <code>UserMapper</code>接口</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserMapper</span> <span class="keyword">extends</span> <span class="title class_">BaseMapper</span>&lt;User&gt; &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>8、在 Spring Boot 启动类中添加 <code>@MapperScan</code> 注解，扫描 Mapper 文件夹：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="comment">// 扫描 mapper 文件夹</span></span><br><span class="line"><span class="meta">@MapperScan(&quot;com.muyoukule.mapper&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MybatisPlusApplication</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(MybatisPlusApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-2-标准CRUD使用"><a href="#2-2-标准CRUD使用" class="headerlink" title="2.2 标准CRUD使用"></a>2.2 标准CRUD使用</h2><p>对于标准的 CRUD 功能 MP 都提供了哪些方法可以使用呢？</p>
<blockquote>
<p>新增 Insert</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 插入一条记录</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">insert</span><span class="params">(T t)</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>T：泛型，新增用来保存新增数据</p>
</li>
<li><p>int：返回值，新增成功后返回1，没有新增成功返回的是0</p>
</li>
</ul>
<p>在测试类中进行新增操作：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MybatisPlusApplicationTests</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserMapper userMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testSave</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">        <span class="comment">// 注意：这里没有插入id</span></span><br><span class="line">        user.setName(<span class="string">&quot;木又枯了&quot;</span>);</span><br><span class="line">        user.setAge(<span class="number">18</span>);</span><br><span class="line">        user.setEmail(<span class="string">&quot;example@gmail.com&quot;</span>);</span><br><span class="line">        <span class="comment">// 受影响的行数</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> userMapper.insert(user);</span><br><span class="line">        System.out.println(i);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>控制台结果：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1</span><br></pre></td></tr></table></figure>

<p>说明数据插入成功，这时候到数据库中查看，数据库表中就会添加一条数据：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/MyBatisPlus/%E6%8F%92%E5%85%A5%E4%B8%80%E6%9D%A1%E6%95%B0%E6%8D%AE.png" alt="插入一条数据"></p>
<p>但是我们发现：我们明明没有设置 ID，插入时居然自动生成了 ID，而且生成的 ID 似乎有点 “ 奇怪 ”。那这个主键 ID 是如何来的？我们更想要的是主键自增，应该是 6 才对，这个是我们后面要学习的 <strong>主键生成策略</strong>，这块的这个问题，我们暂时先放放。</p>
<blockquote>
<p>删除 Delete</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">deleteById</span> <span class="params">(Serializable id)</span></span><br></pre></td></tr></table></figure>

<ul>
<li>Serializable：参数类型</li>
<li>int：返回值类型，数据删除成功返回 1，未删除数据返回 0</li>
</ul>
<p>思考：参数类型为什么是一个序列化类？</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/MyBatisPlus/Serializable%E5%85%B3%E7%B3%BB%E5%9B%BE.png" alt="Serializable关系图" style="zoom:67%;">

<p>从这张图可以看出：</p>
<ul>
<li>String 和 Number 是 Serializable 的子类</li>
<li>Number 又是 Float，Double，Integer 等类的父类</li>
<li>能作为主键的数据类型都已经是 Serializable 的子类</li>
<li>MP 使用 Serializable 作为参数类型，就好比我们可以用 Object 接收任何数据类型一样。</li>
</ul>
<p>在测试类中进行删除操作：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testDelete</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> userMapper.deleteById(<span class="number">1775096675078713345L</span>);</span><br><span class="line">    System.out.println(i);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>控制台结果：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1</span><br></pre></td></tr></table></figure>

<p>说明数据删除入成功，这时候到数据库中查看，数据库表中 ID 为 <code>1775096675078713345</code> 的数据就会被删除：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/MyBatisPlus/%E5%88%A0%E9%99%A4%E4%B8%80%E6%9D%A1%E6%95%B0%E6%8D%AE.png" alt="删除一条数据"></p>
<blockquote>
<p>修改 Update</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">updateById</span><span class="params">(T t)</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>T：泛型，需要修改的数据内容，注意因为是根据 ID 进行修改，所以传入的对象中需要有 ID 属性值</p>
</li>
<li><p>int：返回值，修改成功后返回 1，未修改数据返回 0</p>
</li>
</ul>
<p>在测试类中进行修改操作：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testUpdate</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">    user.setId(<span class="number">1L</span>);</span><br><span class="line">    user.setName(<span class="string">&quot;Jone001&quot;</span>);</span><br><span class="line">    user.setAge(<span class="number">20</span>);</span><br><span class="line">    <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> userMapper.updateById(user);</span><br><span class="line">    System.out.println(i);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>控制台结果：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1</span><br></pre></td></tr></table></figure>

<p>说明数据修改成功，这时候到数据库中查看，发现修改成功：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/MyBatisPlus/%E4%BF%AE%E6%94%B9%E4%B8%80%E6%9D%A1%E6%95%B0%E6%8D%AE.png" alt="修改一条数据"></p>
<blockquote>
<p>查询 Select</p>
</blockquote>
<p><strong>根据 ID 查询</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">T <span class="title function_">selectById</span> <span class="params">(Serializable id)</span></span><br></pre></td></tr></table></figure>

<ul>
<li>Serializable：参数类型，主键 ID 的值</li>
<li>T：根据 ID 查询只会返回一条数据</li>
</ul>
<p>在测试类中进行查询操作：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testSelectById</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userMapper.selectById(<span class="number">1L</span>);</span><br><span class="line">    System.out.println(user);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">User(id=1, name=Jone001, age=20, email=test1@baomidou.com)</span><br></pre></td></tr></table></figure>

<p><strong>查询所有</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">List&lt;T&gt; <span class="title function_">selectList</span><span class="params">(Wrapper&lt;T&gt; queryWrapper)</span></span><br></pre></td></tr></table></figure>

<ul>
<li>Wrapper：用来构建条件查询的条件，目前我们没有可直接传为 Null</li>
<li>List<T>：因为查询的是所有，所以返回的数据是一个集合</T></li>
</ul>
<p>在测试类中进行查询操作：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testSelectAll</span><span class="params">()</span> &#123;</span><br><span class="line">    List&lt;User&gt; userList = userMapper.selectList(<span class="literal">null</span>);</span><br><span class="line">    userList.forEach(System.out::println);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>控制台输出：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">User(id=1, name=Jone001, age=20, email=test1@baomidou.com)</span><br><span class="line">User(id=2, name=Jack, age=20, email=test2@baomidou.com)</span><br><span class="line">User(id=3, name=Tom, age=28, email=test3@baomidou.com)</span><br><span class="line">User(id=4, name=Sandy, age=21, email=test4@baomidou.com)</span><br><span class="line">User(id=5, name=Billie, age=24, email=test5@baomidou.com)</span><br></pre></td></tr></table></figure>

<p>通过以上几个简单的步骤，我们就实现了 User 表的 CRUD 功能，甚至连 XML 文件都不用编写！</p>
<p>上面我们只是继承了 BaseMapper 就省去所有的单表 CRUD，怎么实现的呢？</p>
<p>当然是 <code>BaseMapper </code> 接口其中已经实现了单表的 CRUD：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/MyBatisPlus/BaseMapper%E6%8E%A5%E5%8F%A3.png" alt="BaseMapper接口" style="zoom:67%;">

<p>因此我们自定义的 Mapper 只要实现了这个 <code>BaseMapper</code>，就无需自己实现单表 CRUD 了。</p>
<h1 id="3-配置日志"><a href="#3-配置日志" class="headerlink" title="3. 配置日志"></a>3. 配置日志</h1><p>使用 MP 后，部分 SQL 是不可见的，我们希望知道它是如何执行的，这个时候就需要查看日志！</p>
<p>在配置文件中进行配置：</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">mybatis-plus:</span></span><br><span class="line">  <span class="attr">configuration:</span></span><br><span class="line">    <span class="attr">log-impl:</span> <span class="string">org.apache.ibatis.logging.stdout.StdOutImpl</span></span><br></pre></td></tr></table></figure>

<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/MyBatisPlus/MP%E9%85%8D%E7%BD%AE%E6%97%A5%E5%BF%97%E4%BF%A1%E6%81%AF.png" alt="MP配置日志信息" style="zoom: 67%;">

<p>配置日志后，在以后的学习中，我们可以查看日志，观察 MP 的 SQL 执行。</p>
<h1 id="4-常见注解"><a href="#4-常见注解" class="headerlink" title="4. 常见注解"></a>4. 常见注解</h1><p>在刚刚的入门案例中，我们仅仅引入了依赖，继承了 BaseMapper 就能使用 MP ，非常简单。</p>
<p>但是问题来了： MP 如何知道我们要查询的是哪张表？表中有哪些字段呢？</p>
<p>大家回忆一下，UserMapper 在继承BaseMapper 的时候指定了一个泛型 <code>User</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserMapper</span> <span class="keyword">extends</span> <span class="title class_">BaseMapper</span>&lt;User&gt; &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>泛型中的 User 就是与数据库对应的 PO。</p>
<p>MP 就是根据 PO实体的信息来推断出表的信息，从而生成 SQL 的。默认情况下：</p>
<ul>
<li>MP 会把 PO 实体的类名驼峰转下划线作为表名</li>
<li>MP 会把 PO 实体的所有变量名驼峰转下划线作为表的字段名，并根据变量类型推断字段类型</li>
<li>MP 会把名为 ID 的字段作为主键</li>
</ul>
<p>但很多情况下，默认的实现与实际场景不符，因此 MP 提供了一些注解便于我们声明表信息。</p>
<h2 id="4-1-TableName"><a href="#4-1-TableName" class="headerlink" title="4.1 @TableName"></a>4.1 @TableName</h2><ul>
<li>描述：表名注解，标识实体类对应的表</li>
<li>使用位置：实体类</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@TableName(&quot;sys_user&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">    <span class="keyword">private</span> String email;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>TableName 注解除了指定表名以外，还可以指定很多其它属性：</p>
<table>
<thead>
<tr>
<th align="center">属性</th>
<th align="center">类型</th>
<th align="center">必须指定</th>
<th align="center">默认值</th>
<th align="center">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="center">value</td>
<td align="center">String</td>
<td align="center">否</td>
<td align="center">“”</td>
<td align="center">表名</td>
</tr>
<tr>
<td align="center">schema</td>
<td align="center">String</td>
<td align="center">否</td>
<td align="center">“”</td>
<td align="center">schema</td>
</tr>
<tr>
<td align="center">keepGlobalPrefix</td>
<td align="center">boolean</td>
<td align="center">否</td>
<td align="center">false</td>
<td align="center">是否保持使用全局的 tablePrefix 的值（当全局 tablePrefix 生效时）</td>
</tr>
<tr>
<td align="center">resultMap</td>
<td align="center">String</td>
<td align="center">否</td>
<td align="center">“”</td>
<td align="center">xml 中 resultMap 的 id（用于满足特定类型的实体类对象绑定）</td>
</tr>
<tr>
<td align="center">autoResultMap</td>
<td align="center">boolean</td>
<td align="center">否</td>
<td align="center">false</td>
<td align="center">是否自动构建 resultMap 并使用（如果设置 resultMap 则不会进行 resultMap 的自动构建与注入）</td>
</tr>
<tr>
<td align="center">excludeProperty</td>
<td align="center">String[]</td>
<td align="center">否</td>
<td align="center">{}</td>
<td align="center">需要排除的属性名 @since 3.3.1</td>
</tr>
</tbody></table>
<h2 id="4-2-TableId"><a href="#4-2-TableId" class="headerlink" title="4.2 @TableId"></a>4.2 @TableId</h2><ul>
<li>描述：主键注解</li>
<li>使用位置：实体类主键字段</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@TableName(&quot;sys_user&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="meta">@TableId</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">    <span class="keyword">private</span> String email;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>TableId </code>注解支持两个属性：</p>
<table>
<thead>
<tr>
<th align="center">属性</th>
<th align="center">类型</th>
<th align="center">必须指定</th>
<th align="center">默认值</th>
<th align="center">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="center">value</td>
<td align="center">String</td>
<td align="center">否</td>
<td align="center">“”</td>
<td align="center">表名</td>
</tr>
<tr>
<td align="center">type</td>
<td align="center">Enum</td>
<td align="center">否</td>
<td align="center">IdType.NONE</td>
<td align="center">指定主键类型</td>
</tr>
</tbody></table>
<p><code>IdType </code>支持的类型有：</p>
<table>
<thead>
<tr>
<th align="center">值</th>
<th align="center">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="center">AUTO</td>
<td align="center">数据库 ID 自增</td>
</tr>
<tr>
<td align="center">NONE</td>
<td align="center">无状态，该类型为未设置主键类型（注解里等于跟随全局，全局里约等于 INPUT）</td>
</tr>
<tr>
<td align="center">INPUT</td>
<td align="center">insert 前自行 set 主键值</td>
</tr>
<tr>
<td align="center">ASSIGN_ID</td>
<td align="center">分配 ID(主键类型为 Number(Long 和 Integer)或 String)(since 3.3.0),使用接口IdentifierGenerator的方法nextId(默认实现类为DefaultIdentifierGenerator雪花算法)</td>
</tr>
<tr>
<td align="center">ASSIGN_UUID</td>
<td align="center">分配 UUID,主键类型为 String(since 3.3.0),使用接口IdentifierGenerator的方法nextUUID(默认 default 方法)</td>
</tr>
<tr>
<td align="center"><del>ID_WORKER</del></td>
<td align="center">分布式全局唯一 ID 长整型类型(please use ASSIGN_ID)</td>
</tr>
<tr>
<td align="center"><del>UUID</del></td>
<td align="center">32 位 UUID 字符串(please use ASSIGN_UUID)</td>
</tr>
<tr>
<td align="center"><del>ID_WORKER_STR</del></td>
<td align="center">分布式全局唯一 ID 字符串类型(please use ASSIGN_ID)</td>
</tr>
</tbody></table>
<p>这里比较常见的有三种：</p>
<ul>
<li><code>ASSIGN_ID</code>：雪花算法生成<code>Long</code>类型的全局唯一ID，这是 MP <strong>默认</strong>的 ID 策略</li>
<li><code>AUTO</code>：利用数据库的ID自增长</li>
<li><code>INPUT</code>：手动生成ID</li>
</ul>
<h3 id="4-2-1-主键生成策略"><a href="#4-2-1-主键生成策略" class="headerlink" title="4.2.1 主键生成策略"></a>4.2.1 主键生成策略</h3><blockquote>
<p>雪花算法</p>
</blockquote>
<p>雪花算法(Snowflake)是 Twitter 开源的一种分布式ID生成算法，其生成的 ID 具有全局唯一性。这种算法的核心思想是将 64 位的 Long 型 ID 分为四个部分：时间戳、工作机器ID、数据中心ID和序列号。</p>
<p>在上面我们进行数据插入的时候，由于未对主键生成策略进行配置，而 MP <strong>默认</strong>采用的使用 Twitter 的 <code>雪花算法</code>。所以才会看到生成了一长串数字作为 ID。</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/MyBatisPlus/%E6%8F%92%E5%85%A5%E4%B8%80%E6%9D%A1%E6%95%B0%E6%8D%AE.png" alt="插入一条数据"></p>
<blockquote>
<p>利用数据库的 ID 自增长</p>
</blockquote>
<p>1、实体类中表示组件的属性上添加注解：<code>@TableId(type = IdType.AUTO)</code></p>
<p>2、 <font color="red">数据库字段一定设置为自增</font>😀</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/MyBatisPlus/%E8%AE%BE%E7%BD%AE%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AD%97%E6%AE%B5%E4%B8%BA%E8%87%AA%E5%A2%9E.png" alt="设置数据库字段为自增" style="zoom:67%;">

<p>3、再次运行插入测试：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/MyBatisPlus/ID%E8%87%AA%E5%A2%9E%E9%95%BF%E6%8F%92%E5%85%A5%E6%95%B0%E6%8D%AE.png" alt="ID自增长插入数据"></p>
<blockquote>
<p>手动生成 ID</p>
</blockquote>
<p>1、实体类中表示组件的属性上添加注解：<code>@TableId(type = IdType.INPUT)</code></p>
<p>2、修改测试类，手动设置 ID</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testSave</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">    user.setId(<span class="number">6L</span>); <span class="comment">// 手动设置 ID</span></span><br><span class="line">    user.setName(<span class="string">&quot;木又枯了&quot;</span>);</span><br><span class="line">    user.setAge(<span class="number">18</span>);</span><br><span class="line">    user.setEmail(<span class="string">&quot;example@gmail.com&quot;</span>);</span><br><span class="line">    <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> userMapper.insert(user);</span><br><span class="line">    System.out.println(i);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><font color="red">PS：如果我们设置组件生成策略为手动输入 ，但是没有输入，这个时候日志就会显示插入的是 <code>null</code>，但是数据库中也会插入一条 ID 自增的记录</font></p>
<p>3、再次运行插入测试：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/MyBatisPlus/%E6%89%8B%E5%8A%A8%E7%94%9F%E6%88%90ID%E6%8F%92%E5%85%A5%E6%95%B0%E6%8D%AE.png" alt="手动生成ID插入数据"></p>
<h2 id="4-3-TableField"><a href="#4-3-TableField" class="headerlink" title="4.3 @TableField"></a>4.3 @TableField</h2><ul>
<li>描述：字段注解(非主键)</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@TableName(&quot;sys_user&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="meta">@TableId</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="meta">@TableField(&quot;nickname&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">    <span class="keyword">private</span> String email;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>一般情况下我们并不需要给字段添加 <code>@TableField</code> 注解，一些特殊情况除外：</p>
<ul>
<li>成员变量名与数据库字段名不一致</li>
<li>成员变量是以 <code>isXXX</code> 命名，按照 <code>JavaBean</code> 的规范，<code>MP </code>识别字段时会把 <code>is</code> 去除，这就导致与数据库不符。</li>
<li>成员变量名与数据库一致，但是与数据库的关键字冲突。使用 <code>@TableField</code> 注解给字段名添加转义字符：<code>``</code></li>
</ul>
<p>更多支持的其它属性如下请参考官方文档：<a href="https://baomidou.com/pages/223848/#tablefield">@Tablefield注解</a></p>
<h1 id="5-常见配置"><a href="#5-常见配置" class="headerlink" title="5. 常见配置"></a>5. 常见配置</h1><p>MP 也支持基于 yml 文件的自定义配置，详见官方文档：<a href="https://www.baomidou.com/pages/56bac0/">使用配置</a></p>
<p>大多数的配置都有默认值，因此我们都无需配置。但还有一些是没有默认值的，例如:</p>
<ul>
<li>实体类的别名扫描包</li>
<li>全局 ID 类型</li>
</ul>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">mybatis-plus:</span></span><br><span class="line">  <span class="attr">type-aliases-package:</span> <span class="string">com.muyoukule.entity</span></span><br><span class="line">  <span class="attr">global-config:</span></span><br><span class="line">    <span class="attr">db-config:</span></span><br><span class="line">      <span class="attr">id-type:</span> <span class="string">auto</span> <span class="comment"># 全局id类型为自增长</span></span><br></pre></td></tr></table></figure>

<p>需要注意的是，MP 也支持手写 SQL 的，而 mapper 文件的读取地址可以自己配置：</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">mybatis-plus:</span></span><br><span class="line">  <span class="attr">mapper-locations:</span> <span class="string">&quot;classpath*:/mapper/**/*.xml&quot;</span> <span class="comment"># Mapper.xml文件地址，当前这个是默认值。</span></span><br></pre></td></tr></table></figure>

<p>可以看到默认值是 <code>classpath*:/mapper/**/*.xml</code>，也就是说我们只要把 mapper.xml 文件放置这个目录下就一定会被加载。</p>
<h1 id="6-条件构造器"><a href="#6-条件构造器" class="headerlink" title="6. 条件构造器"></a>6. 条件构造器</h1><p>除了新增以外，修改、删除、查询的SQL语句都需要指定 where 条件。因此 BaseMapper 中提供的相关方法除了以 <code>id</code> 作为 <code>where</code> 条件以外，还支持更加复杂的 <code>where</code> 条件。</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/MyBatisPlus/BaseMapper%E4%B8%AD%E7%9A%84%E6%9D%A1%E4%BB%B6%E6%9E%84%E9%80%A0%E5%99%A8.png" alt="BaseMapper中的条件构造器"></p>
<p>参数中的 <code>Wrapper</code> 就是条件构造的抽象类，其下有很多默认实现，继承关系如图：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/MyBatisPlus/Wrapper%E7%BB%A7%E6%89%BF%E5%85%B3%E7%B3%BB%E5%9B%BE.png" alt="Wrapper继承关系图" style="zoom: 50%;">

<p><code>Wrapper</code> 的子类 <code>AbstractWrapper</code> 提供了 where 中包含的所有条件构造方法：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/MyBatisPlus/AbstractWrapper%E4%B8%AD%E7%9A%84%E6%96%B9%E6%B3%95.png" alt="AbstractWrapper中的方法" style="zoom:67%;">

<p>而 <code>QueryWrapper</code> 在 <code>AbstractWrapper</code> 的基础上拓展了一个 <code>select</code> 方法，允许指定查询字段：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/MyBatisPlus/QueryWrapper%E7%9A%84select%E6%96%B9%E6%B3%95.png" alt="QueryWrapper的select方法"></p>
<p>而 <code>UpdateWrapper</code> 在 <code>AbstractWrapper</code> 的基础上拓展了一个 <code>set</code> 方法，允许指定 SQL 中的 SET 部分：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/MyBatisPlus/UpdateWrapper%E7%9A%84set%E6%96%B9%E6%B3%95.png" alt="UpdateWrapper的set方法"></p>
<p>接下来，我们就来看看如何利用 <code>Wrapper </code>实现复杂查询。</p>
<h2 id="6-1-QueryWrapper"><a href="#6-1-QueryWrapper" class="headerlink" title="6.1 QueryWrapper"></a>6.1 QueryWrapper</h2><p>当前数据表数据：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/MyBatisPlus/%E6%9D%A1%E4%BB%B6%E6%9F%A5%E8%AF%A2%E5%89%8D%E6%95%B0%E6%8D%AE%E5%BA%93%E6%95%B0%E6%8D%AE.png" alt="条件查询前数据库数据"></p>
<p>无论是修改、删除、查询，都可以使用 QueryWrapper 来构建查询条件。接下来看一些例子：</p>
<p><strong>多条件构建</strong></p>
<blockquote>
<p>查询出名字中带 o ，年龄大于等于 18 的人</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testQueryWrapper</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 1.构建查询条件 where name like &quot;%o%&quot; AND age &gt;= 18</span></span><br><span class="line">    QueryWrapper&lt;User&gt; wrapper = <span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;User&gt;()</span><br><span class="line">            .select(<span class="string">&quot;id&quot;</span>, <span class="string">&quot;name&quot;</span>, <span class="string">&quot;age&quot;</span>, <span class="string">&quot;email&quot;</span>)</span><br><span class="line">            .like(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;o&quot;</span>)</span><br><span class="line">            .ge(<span class="string">&quot;age&quot;</span>, <span class="number">18</span>);</span><br><span class="line">    <span class="comment">// 2.查询数据</span></span><br><span class="line">    List&lt;User&gt; userList = userMapper.selectList(wrapper);</span><br><span class="line">    userList.forEach(System.out::println);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到 MP 在编写 SQL 语句时会使用 ? 占位符，然后将参数传进去，最终查询到结果：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/MyBatisPlus/%E5%90%8D%E5%AD%97%E4%B8%AD%E5%B8%A6o%E5%B9%B4%E9%BE%84%E5%A4%A7%E4%BA%8E%E7%AD%89%E4%BA%8E18.png" alt="名字中带o年龄大于等于18"></p>
<blockquote>
<p>查询出年龄小于 20 或年龄大于 25 的人</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testQueryWrapper</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 1.构建查询条件 where (age &lt; 25 OR age &gt; 20)</span></span><br><span class="line">    QueryWrapper&lt;User&gt; wrapper = <span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;User&gt;();</span><br><span class="line">    wrapper.lt(<span class="string">&quot;age&quot;</span>, <span class="number">20</span>).or().gt(<span class="string">&quot;age&quot;</span>, <span class="number">25</span>);</span><br><span class="line">    <span class="comment">// 2.查询数据</span></span><br><span class="line">    List&lt;User&gt; userList = userMapper.selectList(wrapper);</span><br><span class="line">    userList.forEach(System.out::println);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/MyBatisPlus/%E5%B9%B4%E9%BE%84%E5%B0%8F%E4%BA%8E20%E6%88%96%E5%B9%B4%E9%BE%84%E5%A4%A7%E4%BA%8E25.png" alt="年龄小于20或年龄大于25"></p>
<p><font color="red"><strong>PS：<code>or()</code> 就相当于我们sql语句中的 <code>or</code> 关键字，不加默认是 <code>and</code></strong></font></p>
<p><strong>查询投影</strong></p>
<blockquote>
<p>查询指定字段</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testQueryWrapper</span><span class="params">()</span> &#123;</span><br><span class="line">    QueryWrapper&lt;User&gt; wrapper = <span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;User&gt;();</span><br><span class="line">    wrapper.select(<span class="string">&quot;name&quot;</span>,<span class="string">&quot;age&quot;</span>);</span><br><span class="line">    List&lt;User&gt; userList = userMapper.selectList(wrapper);</span><br><span class="line">    userList.forEach(System.out::println);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/MyBatisPlus/%E6%9F%A5%E8%AF%A2name,age%E5%AD%97%E6%AE%B5.png" alt="查询name,age字段"></p>
<p><strong>聚合查询</strong></p>
<blockquote>
<p>count、max、min、avg、sum</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testQueryWrapper</span><span class="params">()</span> &#123;</span><br><span class="line">    QueryWrapper&lt;User&gt; wrapper = <span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;User&gt;();</span><br><span class="line">    <span class="comment">// SELECT count(*) as count FROM user</span></span><br><span class="line">    <span class="comment">//wrapper.select(&quot;count(*) as count&quot;);</span></span><br><span class="line">    <span class="comment">// SELECT max(age) as maxAge FROM user</span></span><br><span class="line">    <span class="comment">//wrapper.select(&quot;max(age) as maxAge&quot;);</span></span><br><span class="line">    <span class="comment">// SELECT min(age) as minAge FROM user</span></span><br><span class="line">    <span class="comment">//wrapper.select(&quot;min(age) as minAge&quot;);</span></span><br><span class="line">    <span class="comment">// SELECT sum(age) as sumAge FROM user</span></span><br><span class="line">    <span class="comment">//wrapper.select(&quot;sum(age) as sumAge&quot;);</span></span><br><span class="line">    <span class="comment">//SELECT avg(age) as avgAge FROM user</span></span><br><span class="line">    wrapper.select(<span class="string">&quot;avg(age) as avgAge&quot;</span>);</span><br><span class="line">    List&lt;Map&lt;String, Object&gt;&gt; userList = userMapper.selectMaps(wrapper);</span><br><span class="line">    userList.forEach(System.out::println);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>分组查询</strong></p>
<blockquote>
<p>分组查询，完成 group by 的查询使用</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testQueryWrapper</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// SELECT count(*) as count,age FROM `user` GROUP BY age</span></span><br><span class="line">    QueryWrapper&lt;User&gt; wrapper = <span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;User&gt;();</span><br><span class="line">    wrapper.select(<span class="string">&quot;count(*) as count,age&quot;</span>);</span><br><span class="line">    wrapper.groupBy(<span class="string">&quot;age&quot;</span>);</span><br><span class="line">    List&lt;Map&lt;String, Object&gt;&gt; list = userMapper.selectMaps(wrapper);</span><br><span class="line">    list.forEach(System.out::println);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/MyBatisPlus/%E5%88%86%E7%BB%84%E6%9F%A5%E8%AF%A2age.png" alt="分组查询age"></p>
<blockquote>
<p>根据 ID 降序排列</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testQueryWrapper</span><span class="params">()</span> &#123;</span><br><span class="line">    QueryWrapper&lt;User&gt; wrapper = <span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * condition ：条件，返回boolean，</span></span><br><span class="line"><span class="comment">     当condition为true，进行排序，如果为false，则不排序</span></span><br><span class="line"><span class="comment">     * isAsc:是否为升序，true为升序，false为降序</span></span><br><span class="line"><span class="comment">     * columns：需要操作的列</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    wrapper.orderBy(<span class="literal">true</span>, <span class="literal">false</span>, <span class="string">&quot;id&quot;</span>);</span><br><span class="line">    List&lt;User&gt; userList = userMapper.selectList(wrapper);</span><br><span class="line">    userList.forEach(System.out::println);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/MyBatisPlus/%E6%A0%B9%E6%8D%AEID%E9%99%8D%E5%BA%8F%E6%8E%92%E5%88%97.png" alt="根据ID降序排列"></p>
<blockquote>
<p>更新用户名为 Jack 的用户的年龄为 18</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testUpdateByQueryWrapper</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 1.构建查询条件 where name = &quot;Jack&quot;</span></span><br><span class="line">    QueryWrapper&lt;User&gt; wrapper = <span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;User&gt;().eq(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;Jack&quot;</span>);</span><br><span class="line">    <span class="comment">// 2.更新数据，user中非null字段都会作为set语句</span></span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">    user.setAge(<span class="number">18</span>);</span><br><span class="line">    userMapper.update(user, wrapper);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/MyBatisPlus/%E6%9B%B4%E6%96%B0%E7%94%A8%E6%88%B7%E5%90%8D%E4%B8%BAJack%E7%9A%84%E7%94%A8%E6%88%B7%E7%9A%84%E5%B9%B4%E9%BE%84%E4%B8%BA18.png" alt="更新用户名为Jack的用户的年龄为18"></p>
<p>除了上面介绍的这几种查询条件构建方法以外还会有很多其他的方法，比如 isNull，isNotNull，in，notIn 等等方法可供选择，具体参考<a href="https://baomidou.com/pages/10c804/">官方文档</a>的条件构造器来学习使用。</p>
<h2 id="6-2-UpdateWrapper"><a href="#6-2-UpdateWrapper" class="headerlink" title="6.2 UpdateWrapper"></a>6.2 UpdateWrapper</h2><p>基于 BaseMapper 中的 update 方法更新时只能直接赋值，对于一些复杂的需求就难以实现。 </p>
<p>例如：更新 ID 为 <code>1、2、4</code> 的用户的年龄，减两岁，对应的 SQL 应该是：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> <span class="keyword">user</span> <span class="keyword">SET</span> age <span class="operator">=</span> age <span class="operator">-</span> <span class="number">2</span> <span class="keyword">WHERE</span> id <span class="keyword">in</span> (<span class="number">1</span>, <span class="number">2</span>, <span class="number">4</span>)</span><br></pre></td></tr></table></figure>

<p>SET 的赋值结果是基于字段现有值的，这个时候就要利用 UpdateWrapper 中的 setSql 功能了：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testUpdateWrapper</span><span class="params">()</span> &#123;</span><br><span class="line">    List&lt;Long&gt; ids = List.of(<span class="number">1L</span>, <span class="number">2L</span>, <span class="number">4L</span>);</span><br><span class="line">    <span class="comment">// 1.生成SQL</span></span><br><span class="line">    UpdateWrapper&lt;User&gt; wrapper = <span class="keyword">new</span> <span class="title class_">UpdateWrapper</span>&lt;User&gt;()</span><br><span class="line">            .setSql(<span class="string">&quot;age = age - 2&quot;</span>) <span class="comment">// SET age = age - 2</span></span><br><span class="line">            .in(<span class="string">&quot;id&quot;</span>, ids); <span class="comment">// WHERE id in (1, 2, 4)</span></span><br><span class="line">    <span class="comment">// 2.更新，注意第一个参数可以给 null，也就是不填更新字段和数据，而是基于 UpdateWrapper 中的 setSQL 来更新</span></span><br><span class="line">    userMapper.update(<span class="literal">null</span>, wrapper);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/MyBatisPlus/%E6%9B%B4%E6%96%B0ID%E4%B8%BA1,2,4%E7%9A%84%E7%94%A8%E6%88%B7%E7%9A%84%E5%B9%B4%E9%BE%84%E5%87%8F%E4%B8%A4%E5%B2%81.png" alt="更新ID为1,2,4的用户的年龄减两岁"></p>
<h2 id="6-3-LambdaQueryWrapper"><a href="#6-3-LambdaQueryWrapper" class="headerlink" title="6.3 LambdaQueryWrapper"></a>6.3 LambdaQueryWrapper</h2><p>无论是 QueryWrapper 还是 UpdateWrapper 在构造条件的时候都需要写死字段名称，会出现字符串<code>魔法值</code>。这在编程规范中显然是不推荐的。 那怎么样才能不写字段名，又能知道字段名呢？</p>
<p>其中一种办法是基于变量的 <code>gettter</code> 方法结合反射技术。因此我们只要将条件对应的字段的 <code>getter</code> 方法传递给 MP，它就能计算出对应的变量名了。而传递方法可以使用JDK8中的 <code>方法引用</code> 和 <code>Lambda </code>表达式。 因此 MP 又提供了一套基于 Lambda 的Wrapper，包含两个：</p>
<ul>
<li>LambdaQueryWrapper</li>
<li>LambdaUpdateWrapper</li>
</ul>
<p>分别对应 QueryWrapper 和 UpdateWrapper</p>
<p>其使用方式如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testLambdaQueryWrapper</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 1.构建条件 where name like &quot;%o%&quot; AND age &gt;= 18</span></span><br><span class="line">    QueryWrapper&lt;User&gt; wrapper = <span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;&gt;();</span><br><span class="line">    wrapper.lambda()</span><br><span class="line">            .select(User::getId, User::getName, User::getAge, User::getEmail)</span><br><span class="line">            .like(User::getName, <span class="string">&quot;o&quot;</span>)</span><br><span class="line">            .ge(User::getAge, <span class="number">18</span>);</span><br><span class="line">    <span class="comment">// 2.查询</span></span><br><span class="line">    List&lt;User&gt; userList = userMapper.selectList(wrapper);</span><br><span class="line">    userList.forEach(System.out::println);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="6-4-自定义SQL"><a href="#6-4-自定义SQL" class="headerlink" title="6.4 自定义SQL"></a>6.4 自定义SQL</h2><p>在演示 UpdateWrapper 的案例中，我们在代码中编写了更新的 SQL 语句：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/MyBatisPlus/%E6%89%8B%E5%86%99%E7%9A%84SQL%E8%AF%AD%E5%8F%A5.png" alt="手写的SQL语句"></p>
<p>这种写法在某些企业也是不允许的，因为 SQL 语句最好都维护在持久层，而不是业务层。就当前案例来说，由于条件是 in 语句，只能将SQL写在Mapper.xml文件，利用foreach来生成动态SQL。 这实在是太麻烦了。假如查询条件更复杂，动态SQL的编写也会更加复杂。</p>
<p>所以，MP提供了自定义SQL功能，可以让我们利用Wrapper生成查询条件，再结合Mapper.xml编写SQL。</p>
<h3 id="6-4-1-基本用法"><a href="#6-4-1-基本用法" class="headerlink" title="6.4.1 基本用法"></a>6.4.1 基本用法</h3><p>以当前案例来说，我们可以这样写：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testCustomWrapper</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 1.准备自定义查询条件</span></span><br><span class="line">    List&lt;Long&gt; ids = List.of(<span class="number">1L</span>, <span class="number">2L</span>, <span class="number">4L</span>);</span><br><span class="line">    QueryWrapper&lt;User&gt; wrapper = <span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;User&gt;().in(<span class="string">&quot;id&quot;</span>, ids);</span><br><span class="line">    <span class="comment">// 2.调用mapper的自定义方法，直接传递Wrapper</span></span><br><span class="line">    userMapper.deductAgeByIds(<span class="number">2</span>, wrapper);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后在UserMapper中自定义SQL：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserMapper</span> <span class="keyword">extends</span> <span class="title class_">BaseMapper</span>&lt;User&gt; &#123;</span><br><span class="line">    <span class="meta">@Select(&quot;UPDATE user SET age = age - #&#123;age&#125; $&#123;ew.customSqlSegment&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">deductAgeByIds</span><span class="params">(<span class="meta">@Param(&quot;age&quot;)</span> <span class="type">int</span> age, <span class="meta">@Param(&quot;ew&quot;)</span> QueryWrapper&lt;User&gt; wrapper)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样就省去了编写复杂查询条件的烦恼了。</p>
<h3 id="6-4-2-多表关联"><a href="#6-4-2-多表关联" class="headerlink" title="6.4.2 多表关联"></a>6.4.2 多表关联</h3><p>理论上来讲MyBatisPlus是不支持多表查询的，不过我们可以利用Wrapper中自定义条件结合自定义SQL来实现多表查询的效果。</p>
<p>执行SQL脚本，创建address表，与 user 表相关联：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> `address` (</span><br><span class="line">  `id` <span class="type">bigint</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `user_id` <span class="type">bigint</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;用户ID&#x27;</span>,</span><br><span class="line">  `province` <span class="type">varchar</span>(<span class="number">10</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;省&#x27;</span>,</span><br><span class="line">  `city` <span class="type">varchar</span>(<span class="number">10</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;市&#x27;</span>,</span><br><span class="line">  `town` <span class="type">varchar</span>(<span class="number">10</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;县/区&#x27;</span>,</span><br><span class="line">  `mobile` <span class="type">varchar</span>(<span class="number">255</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;手机&#x27;</span>,</span><br><span class="line">  `street` <span class="type">varchar</span>(<span class="number">255</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;详细地址&#x27;</span>,</span><br><span class="line">  `contact` <span class="type">varchar</span>(<span class="number">255</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;联系人&#x27;</span>,</span><br><span class="line">  `is_default` bit(<span class="number">1</span>) <span class="keyword">DEFAULT</span> b<span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;是否是默认 1默认 0否&#x27;</span>,</span><br><span class="line">  `notes` <span class="type">varchar</span>(<span class="number">255</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;备注&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`) <span class="keyword">USING</span> BTREE,</span><br><span class="line">  KEY `user_id` (`user_id`) <span class="keyword">USING</span> BTREE</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">71</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb3 ROW_FORMAT<span class="operator">=</span>COMPACT;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `address` (`id`, `user_id`, `province`, `city`, `town`, `mobile`, `street`, `contact`, `is_default`, `notes`) <span class="keyword">VALUES</span></span><br><span class="line">    (<span class="number">59</span>, <span class="number">2</span>, <span class="string">&#x27;北京&#x27;</span>, <span class="string">&#x27;北京&#x27;</span>, <span class="string">&#x27;朝阳区&#x27;</span>, <span class="string">&#x27;13900112222&#x27;</span>, <span class="string">&#x27;金燕龙办公楼&#x27;</span>, <span class="string">&#x27;Rose&#x27;</span>, b<span class="string">&#x27;1&#x27;</span>, <span class="keyword">NULL</span>),</span><br><span class="line">    (<span class="number">60</span>, <span class="number">1</span>, <span class="string">&#x27;北京&#x27;</span>, <span class="string">&#x27;北京&#x27;</span>, <span class="string">&#x27;朝阳区&#x27;</span>, <span class="string">&#x27;13700221122&#x27;</span>, <span class="string">&#x27;修正大厦&#x27;</span>, <span class="string">&#x27;Jack&#x27;</span>, b<span class="string">&#x27;0&#x27;</span>, <span class="keyword">NULL</span>),</span><br><span class="line">    (<span class="number">61</span>, <span class="number">1</span>, <span class="string">&#x27;上海&#x27;</span>, <span class="string">&#x27;上海&#x27;</span>, <span class="string">&#x27;浦东新区&#x27;</span>, <span class="string">&#x27;13301212233&#x27;</span>, <span class="string">&#x27;航头镇航头路&#x27;</span>, <span class="string">&#x27;Jack&#x27;</span>, b<span class="string">&#x27;1&#x27;</span>, <span class="keyword">NULL</span>),</span><br><span class="line">    (<span class="number">63</span>, <span class="number">2</span>, <span class="string">&#x27;广东&#x27;</span>, <span class="string">&#x27;佛山&#x27;</span>, <span class="string">&#x27;永春&#x27;</span>, <span class="string">&#x27;13301212233&#x27;</span>, <span class="string">&#x27;永春武馆&#x27;</span>, <span class="string">&#x27;Rose&#x27;</span>, b<span class="string">&#x27;0&#x27;</span>, <span class="keyword">NULL</span>),</span><br><span class="line">    (<span class="number">64</span>, <span class="number">3</span>, <span class="string">&#x27;浙江&#x27;</span>, <span class="string">&#x27;杭州&#x27;</span>, <span class="string">&#x27;拱墅区&#x27;</span>, <span class="string">&#x27;13567809102&#x27;</span>, <span class="string">&#x27;浙江大学&#x27;</span>, <span class="string">&#x27;Hope&#x27;</span>, b<span class="string">&#x27;1&#x27;</span>, <span class="keyword">NULL</span>),</span><br><span class="line">    (<span class="number">65</span>, <span class="number">3</span>, <span class="string">&#x27;浙江&#x27;</span>, <span class="string">&#x27;杭州&#x27;</span>, <span class="string">&#x27;拱墅区&#x27;</span>, <span class="string">&#x27;13967589201&#x27;</span>, <span class="string">&#x27;左岸花园&#x27;</span>, <span class="string">&#x27;Hope&#x27;</span>, b<span class="string">&#x27;0&#x27;</span>, <span class="keyword">NULL</span>),</span><br><span class="line">    (<span class="number">66</span>, <span class="number">4</span>, <span class="string">&#x27;湖北&#x27;</span>, <span class="string">&#x27;武汉&#x27;</span>, <span class="string">&#x27;汉口&#x27;</span>, <span class="string">&#x27;13967519202&#x27;</span>, <span class="string">&#x27;天天花园&#x27;</span>, <span class="string">&#x27;Thomas&#x27;</span>, b<span class="string">&#x27;1&#x27;</span>, <span class="keyword">NULL</span>),</span><br><span class="line">    (<span class="number">67</span>, <span class="number">3</span>, <span class="string">&#x27;浙江&#x27;</span>, <span class="string">&#x27;杭州&#x27;</span>, <span class="string">&#x27;拱墅区&#x27;</span>, <span class="string">&#x27;13967589201&#x27;</span>, <span class="string">&#x27;左岸花园&#x27;</span>, <span class="string">&#x27;Hopey&#x27;</span>, b<span class="string">&#x27;0&#x27;</span>, <span class="keyword">NULL</span>),</span><br><span class="line">    (<span class="number">68</span>, <span class="number">4</span>, <span class="string">&#x27;湖北&#x27;</span>, <span class="string">&#x27;武汉&#x27;</span>, <span class="string">&#x27;汉口&#x27;</span>, <span class="string">&#x27;13967519202&#x27;</span>, <span class="string">&#x27;天天花园&#x27;</span>, <span class="string">&#x27;Thomas&#x27;</span>, b<span class="string">&#x27;1&#x27;</span>, <span class="keyword">NULL</span>),</span><br><span class="line">    (<span class="number">69</span>, <span class="number">3</span>, <span class="string">&#x27;浙江&#x27;</span>, <span class="string">&#x27;杭州&#x27;</span>, <span class="string">&#x27;拱墅区&#x27;</span>, <span class="string">&#x27;13967589201&#x27;</span>, <span class="string">&#x27;左岸花园&#x27;</span>, <span class="string">&#x27;Hopey&#x27;</span>, b<span class="string">&#x27;0&#x27;</span>, <span class="keyword">NULL</span>),</span><br><span class="line">    (<span class="number">70</span>, <span class="number">4</span>, <span class="string">&#x27;湖北&#x27;</span>, <span class="string">&#x27;武汉&#x27;</span>, <span class="string">&#x27;汉口&#x27;</span>, <span class="string">&#x27;13967519202&#x27;</span>, <span class="string">&#x27;天天花园&#x27;</span>, <span class="string">&#x27;Thomas&#x27;</span>, b<span class="string">&#x27;1&#x27;</span>, <span class="keyword">NULL</span>);</span><br></pre></td></tr></table></figure>

<p>我们要查询出所有收货地址在北京的并且用户 ID 在 <code>1、2、4</code> 之中的用户 要是自己基于 Mybatis 实现 SQL，大概是这样的：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;queryUserByIdAndAddr&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;com.muyoukule.entity.User&quot;</span>&gt;</span></span><br><span class="line">      SELECT *</span><br><span class="line">      FROM user u</span><br><span class="line">      INNER JOIN address a ON u.id = a.user_id</span><br><span class="line">      WHERE u.id</span><br><span class="line">      <span class="tag">&lt;<span class="name">foreach</span> <span class="attr">collection</span>=<span class="string">&quot;ids&quot;</span> <span class="attr">separator</span>=<span class="string">&quot;,&quot;</span> <span class="attr">item</span>=<span class="string">&quot;id&quot;</span> <span class="attr">open</span>=<span class="string">&quot;IN (&quot;</span> <span class="attr">close</span>=<span class="string">&quot;)&quot;</span>&gt;</span></span><br><span class="line">          #&#123;id&#125;</span><br><span class="line">      <span class="tag">&lt;/<span class="name">foreach</span>&gt;</span></span><br><span class="line">      AND a.city = #&#123;city&#125;</span><br><span class="line">  <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>可以看出其中最复杂的就是 WHERE 条件的编写，如果业务复杂一些，这里的 SQL 会更变态。</p>
<p>但是基于自定义 SQL 结合 Wrapper 的玩法，我们就可以利用 Wrapper 来构建查询条件，然后手写 SELECT 及 FROM 部分，实现多表查询。</p>
<p>查询条件这样来构建：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testCustomJoinWrapper</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 1.准备自定义查询条件</span></span><br><span class="line">    QueryWrapper&lt;User&gt; wrapper = <span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;User&gt;()</span><br><span class="line">            .in(<span class="string">&quot;u.id&quot;</span>, List.of(<span class="number">1L</span>, <span class="number">2L</span>, <span class="number">4L</span>))</span><br><span class="line">            .eq(<span class="string">&quot;a.city&quot;</span>, <span class="string">&quot;北京&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2.调用mapper的自定义方法</span></span><br><span class="line">    List&lt;User&gt; userList = userMapper.queryUserByWrapper(wrapper);</span><br><span class="line">    userList.forEach(System.out::println);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后在UserMapper中自定义方法：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Select(&quot;SELECT u.* FROM user u INNER JOIN address a ON u.id = a.user_id $&#123;ew.customSqlSegment&#125;&quot;)</span></span><br><span class="line">List&lt;User&gt; <span class="title function_">queryUserByWrapper</span><span class="params">(<span class="meta">@Param(&quot;ew&quot;)</span> QueryWrapper&lt;User&gt; wrapper)</span>;</span><br></pre></td></tr></table></figure>

<p>当然，也可以在<code>UserMapper.xml</code>中写SQL：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;queryUserByIdAndAddr&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;com.itheima.mp.domain.po.User&quot;</span>&gt;</span></span><br><span class="line">    SELECT * FROM user u INNER JOIN address a ON u.id = a.user_id $&#123;ew.customSqlSegment&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="7-代码生成"><a href="#7-代码生成" class="headerlink" title="7. 代码生成"></a>7. 代码生成</h1><p>在使用MP 以后，基础的<code>Mapper</code>、<code>Service</code>、<code>PO</code>代码相对固定，重复编写也比较麻烦。因此MP 官方提供了代码生成器。</p>
<p>适用版本：mybatis-plus-generator 3.5.1 及其以上版本，对历史版本不兼容！</p>
<p>3.5.1 以下的请参考：<a href="https://baomidou.com/pages/d357af/">代码生成器（旧）</a></p>
<p>首先需要添加依赖，MP 从 <code>3.0.3</code> 之后移除了代码生成器与模板引擎的默认依赖，需要手动添加相关依赖：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--代码生成器--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-generator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.5.3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--模板引擎  Velocity(默认)--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.velocity<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>velocity-engine-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>创建代码生成类：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.muyoukule;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.annotation.FieldFill;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.annotation.IdType;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.generator.FastAutoGenerator;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.generator.config.OutputFile;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.generator.config.rules.DateType;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.generator.config.rules.DbColumnType;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.generator.fill.Column;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.generator.fill.Property;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.sql.Types;</span><br><span class="line"><span class="keyword">import</span> java.util.Collections;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> 木又枯了</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2024/4/4</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">// 代码自动生成器</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CodeGenerator</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// 代码生成器对象</span></span><br><span class="line">        <span class="comment">// 数据库信息</span></span><br><span class="line">        FastAutoGenerator.create(<span class="string">&quot;jdbc:mysql://127.0.0.1:3306/mybatis_plus&quot;</span>, <span class="string">&quot;root&quot;</span>, <span class="string">&quot;root&quot;</span>)</span><br><span class="line">                <span class="comment">// 1.全局配置</span></span><br><span class="line">                .globalConfig(builder -&gt; &#123;</span><br><span class="line">                    builder.disableOpenDir()</span><br><span class="line">                            .author(<span class="string">&quot;木又枯了&quot;</span>)    <span class="comment">// 设置作者</span></span><br><span class="line">                            .outputDir(System.getProperty(<span class="string">&quot;user.dir&quot;</span>) + <span class="string">&quot;/src/main/java&quot;</span>)   <span class="comment">// 代码输出目录</span></span><br><span class="line">                            <span class="comment">//.enableSwagger()  // 开启 swagger 模式</span></span><br><span class="line">                            .dateType(DateType.TIME_PACK)   <span class="comment">// 时间策略</span></span><br><span class="line">                            .commentDate(<span class="string">&quot;yyyy-MM-dd&quot;</span>)  <span class="comment">// 注释日期</span></span><br><span class="line">                            .build();</span><br><span class="line">                &#125;)</span><br><span class="line">                <span class="comment">// 2.数据库配置</span></span><br><span class="line">                .dataSourceConfig(builder -&gt;</span><br><span class="line">                        builder.typeConvertHandler((globalConfig, typeRegistry, metaInfo) -&gt; &#123;</span><br><span class="line">                            <span class="type">int</span> <span class="variable">typeCode</span> <span class="operator">=</span> metaInfo.getJdbcType().TYPE_CODE;</span><br><span class="line">                            <span class="keyword">if</span> (typeCode == Types.SMALLINT) &#123;</span><br><span class="line">                                <span class="comment">// 自定义类型转换</span></span><br><span class="line">                                <span class="keyword">return</span> DbColumnType.INTEGER;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">return</span> typeRegistry.getColumnType(metaInfo);</span><br><span class="line">                        &#125;)</span><br><span class="line">                )</span><br><span class="line">                <span class="comment">// 3.包配置</span></span><br><span class="line">                .packageConfig(builder -&gt; &#123;</span><br><span class="line">                    builder.parent(<span class="string">&quot;com.muyoukule&quot;</span>) <span class="comment">// 设置父包名</span></span><br><span class="line">                            .entity(<span class="string">&quot;entity&quot;</span>)   <span class="comment">// Entity 包名</span></span><br><span class="line">                            .service(<span class="string">&quot;service&quot;</span>) <span class="comment">// Service 包名</span></span><br><span class="line">                            .serviceImpl(<span class="string">&quot;service.impl&quot;</span>)    <span class="comment">//Service Impl 包名</span></span><br><span class="line">                            .mapper(<span class="string">&quot;mapper&quot;</span>)   <span class="comment">//Mapper 包名</span></span><br><span class="line">                            .xml(<span class="string">&quot;AddressMapper.xml&quot;</span>)   <span class="comment">//Mapper XML 包名</span></span><br><span class="line">                            .controller(<span class="string">&quot;controller&quot;</span>)   <span class="comment">//	Controller 包名</span></span><br><span class="line">                            .pathInfo(Collections.singletonMap(OutputFile.xml, System.getProperty(<span class="string">&quot;user.dir&quot;</span>) + <span class="string">&quot;/src/main/resources/mapper&quot;</span>))<span class="comment">// 设置mapperXml生成路径</span></span><br><span class="line">                            .build();</span><br><span class="line">                &#125;)</span><br><span class="line">                <span class="comment">// 4.策略配置</span></span><br><span class="line">                .strategyConfig(builder -&gt; &#123;</span><br><span class="line">                    builder</span><br><span class="line">                            <span class="comment">// 实体策略配置</span></span><br><span class="line">                            .entityBuilder()</span><br><span class="line">                            .enableLombok() <span class="comment">// 开启 lombok 模型</span></span><br><span class="line">                            .versionColumnName(<span class="string">&quot;version&quot;</span>)   <span class="comment">// 乐观锁字段名(数据库字段)</span></span><br><span class="line">                            .logicDeleteColumnName(<span class="string">&quot;deleted&quot;</span>)   <span class="comment">// 逻辑删除字段名(数据库字段)</span></span><br><span class="line">                            .addTableFills(<span class="keyword">new</span> <span class="title class_">Column</span>(<span class="string">&quot;create_time&quot;</span>, FieldFill.INSERT)) <span class="comment">// 添加表字段填充</span></span><br><span class="line">                            .addTableFills(<span class="keyword">new</span> <span class="title class_">Property</span>(<span class="string">&quot;updateTime&quot;</span>, FieldFill.INSERT_UPDATE)) <span class="comment">// 添加表字段填充</span></span><br><span class="line">                            .idType(IdType.AUTO)    <span class="comment">// 全局主键类型</span></span><br><span class="line">                            .formatFileName(<span class="string">&quot;%s&quot;</span>)   <span class="comment">// 格式化文件名称， %s为占位符，指代模块名称</span></span><br><span class="line">                            <span class="comment">// Controller 策略配置</span></span><br><span class="line">                            .controllerBuilder()</span><br><span class="line">                            .enableRestStyle() <span class="comment">// 开启生成 @RestController 控制器</span></span><br><span class="line">                            .formatFileName(<span class="string">&quot;%sController&quot;</span>) <span class="comment">// 格式化文件名称， %s为占位符，指代模块名称</span></span><br><span class="line">                            .build();</span><br><span class="line">                &#125;)</span><br><span class="line">                <span class="comment">// 5.执行生成操作</span></span><br><span class="line">                .execute();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以上代码按要求修改即可使用。对于代码生成器中的更多代码内容，我们可以直接从<a href="https://baomidou.com/pages/981406/#%E6%95%B0%E6%8D%AE%E5%BA%93%E9%85%8D%E7%BD%AE-datasourceconfig">官方文档</a>中获取代码进行修改。</p>
<h1 id="8-逻辑删除"><a href="#8-逻辑删除" class="headerlink" title="8. 逻辑删除"></a>8. 逻辑删除</h1><p>对于一些比较重要的数据，我们往往会采用逻辑删除的方案，即：</p>
<ul>
<li>在表中添加一个字段标记数据是否被删除</li>
<li>当删除数据时把标记置为true</li>
<li>查询时过滤掉标记为true的数据</li>
</ul>
<p>一旦采用了逻辑删除，所有的查询和删除逻辑都要跟着变化，非常麻烦。</p>
<p>为了解决这个问题，MP 就添加了对逻辑删除的支持。</p>
<p><font color="red">PS：只有 MP 生成的SQL语句才支持自动的逻辑删除，自定义 SQL 需要自己手动处理逻辑删除。</font></p>
<p>1、我们给 <code>user</code> 表添加一个逻辑删除字段，设置默认值为 0 ：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> <span class="keyword">user</span> <span class="keyword">add</span> deleted bit <span class="keyword">default</span> b<span class="string">&#x27;0&#x27;</span> <span class="keyword">null</span> comment <span class="string">&#x27;逻辑删除&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/MyBatisPlus/%E6%B7%BB%E5%8A%A0%E9%80%BB%E8%BE%91%E5%88%A0%E9%99%A4%E5%AD%97%E6%AE%B5deleted.png" alt="添加逻辑删除字段deleted"></p>
<p>2、给 <code>user</code> 实体添加 <code>deleted</code> 字段：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//逻辑删除</span></span><br><span class="line"><span class="keyword">private</span> Boolean deleted;</span><br></pre></td></tr></table></figure>

<p>3、在<code>application.yml</code>中配置逻辑删除字段：</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">mybatis-plus:</span></span><br><span class="line">  <span class="attr">global-config:</span></span><br><span class="line">    <span class="attr">db-config:</span></span><br><span class="line">      <span class="attr">logic-delete-field:</span> <span class="string">deleted</span> <span class="comment"># 全局逻辑删除的实体字段名(since 3.3.0,配置后可以忽略不配置步骤2)</span></span><br><span class="line">      <span class="attr">logic-delete-value:</span> <span class="number">1</span> <span class="comment"># 逻辑已删除值(默认为 1)</span></span><br><span class="line">      <span class="attr">logic-not-delete-value:</span> <span class="number">0</span> <span class="comment"># 逻辑未删除值(默认为 0)</span></span><br></pre></td></tr></table></figure>

<p>4、测试</p>
<p>首先，我们执行一个删除操作：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testDelete</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> userMapper.deleteById(<span class="number">1L</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>方法与普通删除一模一样，但是底层的SQL逻辑变了：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/MyBatisPlus/%E5%BA%95%E5%B1%82%E7%9A%84SQL%E9%80%BB%E8%BE%91%E6%94%B9%E5%8F%98.png" alt="底层的SQL逻辑改变"></p>
<p>查看数据库，发现 ID 为1 的记录还在数据库，只是 deleted 字段变为 1 ：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/MyBatisPlus/deleted%E5%AD%97%E6%AE%B5%E5%8F%98%E4%B8%BA1.png"></p>
<p>查询一下试试：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testSelectAll</span><span class="params">()</span> &#123;</span><br><span class="line">    List&lt;User&gt; userList = userMapper.selectList(<span class="literal">null</span>);</span><br><span class="line">    userList.forEach(System.out::println);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>会发现 ID为 1 的记录确实没有查询出来，而且 SQL 中也对逻辑删除字段做了判断：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/MyBatisPlus/SQL%E5%AF%B9%E9%80%BB%E8%BE%91%E5%88%A0%E9%99%A4%E5%AD%97%E6%AE%B5%E5%81%9A%E5%87%BA%E5%88%A4%E6%96%AD.png" alt="SQL对逻辑删除字段做出判断"></p>
<p>综上， 开启了逻辑删除功能以后，我们就可以像普通删除一样做CRUD，基本不用考虑代码逻辑问题。还是非常方便的。</p>
<p><strong>注意</strong>： 逻辑删除本身也有自己的问题，比如：</p>
<ul>
<li>会导致数据库表垃圾数据越来越多，从而影响查询效率</li>
<li>SQL 中全都需要对逻辑删除字段做判断，影响查询效率</li>
</ul>
<p>因此，不太推荐采用逻辑删除功能，如果数据不能删除，可以采用把数据迁移到其它表的办法。</p>
<h1 id="9-通用枚举"><a href="#9-通用枚举" class="headerlink" title="9. 通用枚举"></a>9. 通用枚举</h1><h2 id="9-1-声明通用枚举属性"><a href="#9-1-声明通用枚举属性" class="headerlink" title="9.1 声明通用枚举属性"></a>9.1 声明通用枚举属性</h2><p>1、我们给  <code>user</code>  表添加一个 <code>status</code> 字段：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> <span class="keyword">user</span> <span class="keyword">add</span> `status` <span class="type">INT</span>(<span class="number">10</span>) <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;1&#x27;</span> COMMENT <span class="string">&#x27;使用状态（1正常 2冻结）&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>2、定义一个用户状态的枚举：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.muyoukule.enums;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Getter;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">UserStatus</span> &#123;</span><br><span class="line">    NORMAL(<span class="number">1</span>, <span class="string">&quot;正常&quot;</span>),</span><br><span class="line">    FREEZE(<span class="number">2</span>, <span class="string">&quot;冻结&quot;</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> value;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String desc;</span><br><span class="line"></span><br><span class="line">    UserStatus(<span class="type">int</span> value, String desc) &#123;</span><br><span class="line">        <span class="built_in">this</span>.value = value;</span><br><span class="line">        <span class="built_in">this</span>.desc = desc;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3、给 <code>user</code> 实体添加 <code>status</code> 字段：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//使用状态（1正常 2冻结）</span></span><br><span class="line"><span class="keyword">private</span> UserStatus status;</span><br></pre></td></tr></table></figure>

<p>要让 MP 处理枚举与数据库类型自动转换，我们必须告诉 MP，枚举中的哪个字段的值作为数据库值。 </p>
<p>MP 提供了 <code>@EnumValue</code> 注解来标记枚举属性：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">UserStatus</span> &#123;</span><br><span class="line">    NORMAL(<span class="number">1</span>, <span class="string">&quot;正常&quot;</span>),</span><br><span class="line">    FREEZE(<span class="number">2</span>, <span class="string">&quot;冻结&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@EnumValue</span> <span class="comment">// 标记数据库存的值是 value</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> value;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String desc;</span><br><span class="line"></span><br><span class="line">    UserStatus(<span class="type">int</span> value, String desc) &#123;</span><br><span class="line">        <span class="built_in">this</span>.value = value;</span><br><span class="line">        <span class="built_in">this</span>.desc = desc;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="9-2-配置扫描通用枚举"><a href="#9-2-配置扫描通用枚举" class="headerlink" title="9.2 配置扫描通用枚举"></a><del>9.2 配置扫描通用枚举</del></h2><p><font color="red"><strong>PS：从 3.5.2 开始无需配置！</strong></font>😁</p>
<p><strong>方式一：仅配置指定包内的枚举类使用 MybatisEnumTypeHandler</strong></p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">mybatis-plus:</span></span><br><span class="line"> 	<span class="comment"># 设置枚举包扫描。3.5.2 版本开始，省略此配置。</span></span><br><span class="line">    <span class="comment"># 支持统配符 * 或者 ; 分割 </span></span><br><span class="line">    <span class="attr">typeEnumsPackage:</span> <span class="string">com.muyoukule.enums</span></span><br></pre></td></tr></table></figure>

<p>当添加这个配置后，mybatis-plus 提供的 <code>MybatisSqlSessionFactoryBean</code> 会自动扫描包内合法的枚举类（使用了 <code>@EnumValue</code> 注解，或者实现了 <code>IEnum</code> 接口），分别为这些类注册使用 <code>MybatisEnumTypeHandler</code>。</p>
<p>换句话说，只有指定包下的枚举类会使用新的 TypeHandler。其他包下，或者包内没有做相关改造的枚举类，仍然会使用 Mybatis 的 DefaultEnumTypeHandler。</p>
<p><strong>方式二：直接指定 DefaultEnumTypeHandler</strong></p>
<p>此方式用来 <code>全局</code> 修改 Mybatis 使用的 EnumTypeHandler。</p>
<p>在application.yaml文件中添加配置：</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">mybatis-plus:</span></span><br><span class="line">  <span class="attr">configuration:</span></span><br><span class="line">    <span class="attr">default-enum-type-handler:</span> <span class="string">com.baomidou.mybatisplus.core.handlers.MybatisEnumTypeHandler</span></span><br></pre></td></tr></table></figure>

<p>自定义配置类 MybatisPlusAutoConfiguration：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MybatisPlusAutoConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> MybatisPlusPropertiesCustomizer <span class="title function_">mybatisPlusPropertiesCustomizer</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> properties -&gt; &#123;</span><br><span class="line">            <span class="type">GlobalConfig</span> <span class="variable">globalConfig</span> <span class="operator">=</span> properties.getGlobalConfig();</span><br><span class="line">            globalConfig.setBanner(<span class="literal">false</span>);</span><br><span class="line">            <span class="type">MybatisConfiguration</span> <span class="variable">configuration</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MybatisConfiguration</span>();</span><br><span class="line">            configuration.setDefaultEnumTypeHandler(MybatisEnumTypeHandler.class);</span><br><span class="line">            properties.setConfiguration(configuration);</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>查询一条数据查看：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Jack&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;age&quot;</span><span class="punctuation">:</span> <span class="number">16</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;email&quot;</span><span class="punctuation">:</span> <span class="string">&quot;test2@baomidou.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;deleted&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="string">&quot;NORMAL&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>如何序列化枚举值为前端返回值？</p>
</blockquote>
<p>在UserStatus枚举中通过 <code>@JsonValue</code> 注解标记 JSON 序列化时展示的字段</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">UserStatus</span> &#123;</span><br><span class="line">    NORMAL(<span class="number">1</span>, <span class="string">&quot;正常&quot;</span>),</span><br><span class="line">    FREEZE(<span class="number">2</span>, <span class="string">&quot;冻结&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@EnumValue</span> <span class="comment">// 标记数据库存的值是 value</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> value;</span><br><span class="line">    <span class="meta">@JsonValue</span>    <span class="comment">//标记响应json值</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String desc;</span><br><span class="line"></span><br><span class="line">    UserStatus(<span class="type">int</span> value, String desc) &#123;</span><br><span class="line">        <span class="built_in">this</span>.value = value;</span><br><span class="line">        <span class="built_in">this</span>.desc = desc;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>再次查看：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Jack&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;age&quot;</span><span class="punctuation">:</span> <span class="number">16</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;email&quot;</span><span class="punctuation">:</span> <span class="string">&quot;test2@baomidou.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;deleted&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="string">&quot;正常&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>可以看到在 desc 上加了 <code>@JsonValue</code> 注解注解后 status 由 <code>NORMAL</code> 变为了 <code>正常</code> 。</p>
<h1 id="10-JSON类型处理器"><a href="#10-JSON类型处理器" class="headerlink" title="10. JSON类型处理器"></a>10. JSON类型处理器</h1><p>1、我们给  <code>user</code>  表添加一个 <code>info</code> 字段，是 JSON 类型：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> <span class="keyword">user</span> <span class="keyword">add</span> `info` JSON <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;详细信息&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>2、向 <code>info</code> 字段擦插入数据格式像这样：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;intro&quot;</span><span class="punctuation">:</span> <span class="string">&quot;佛系青年&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;gender&quot;</span><span class="punctuation">:</span> <span class="string">&quot;male&quot;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>3、给 <code>user</code> 实体添加 <code>info</code> 字段：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 详细信息</span></span><br><span class="line"><span class="keyword">private</span> String info;</span><br></pre></td></tr></table></figure>

<p>一般 User 实体类中都是 <code>String </code> 类型的 info，这样一来，我们要读取 info 中的属性时就非常不方便。</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Jack&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;age&quot;</span><span class="punctuation">:</span> <span class="number">16</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;email&quot;</span><span class="punctuation">:</span> <span class="string">&quot;test2@baomidou.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;deleted&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="string">&quot;正常&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;info&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;\&quot;intro\&quot;: \&quot;佛系青年\&quot;, \&quot;gender\&quot;: \&quot;male\&quot;&#125;&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>如果要方便获取，info 的类型最好是一个 <code>Map</code> 或者实体类。而一旦我们把 <code>info </code> 改为 <code>对象</code> 类型，就需要在写入数据库时手动转为 <code>String</code>，再读取数据库时，手动转换为 <code>对象</code>，这会非常麻烦。</p>
<p>因此 MP 提供了很多特殊类型字段的类型处理器，解决特殊字段类型与数据库类型转换的问题。例如处理 JSON 就可以使用 <code>JacksonTypeHandler </code> 处理器。</p>
<blockquote>
<p>怎么使用 JacksonTypeHandler 处理器呢？</p>
</blockquote>
<p>1、我们定义一个单独实体类来与 info 字段的属性匹配：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserInfo</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String intro;</span><br><span class="line">    <span class="keyword">private</span> String gender;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2、接下来，将 User 类的 info 字段设置为 UserInfo 类型，并声明类型处理器：</p>
<p><font color="red"><strong>PS：必须开启映射注解 <code>@TableName(autoResultMap = true)</code> ！！！</strong></font></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@TableName(value = &quot;`user`&quot;, autoResultMap = true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="meta">@TableId(type = IdType.INPUT)</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    </span><br><span class="line">	<span class="comment">// -- skip --</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 详细信息</span></span><br><span class="line">    <span class="meta">@TableField(typeHandler = JacksonTypeHandler.class)</span></span><br><span class="line">    <span class="keyword">private</span> UserInfo info;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3、测试可以发现，所有数据都正确封装到 UserInfo 当中了：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Jack&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;age&quot;</span><span class="punctuation">:</span> <span class="number">16</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;email&quot;</span><span class="punctuation">:</span> <span class="string">&quot;test2@baomidou.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;deleted&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="string">&quot;正常&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;info&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;intro&quot;</span><span class="punctuation">:</span> <span class="string">&quot;伏地魔&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;gender&quot;</span><span class="punctuation">:</span> <span class="string">&quot;male&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h1 id="11-自动填充功能"><a href="#11-自动填充功能" class="headerlink" title="11. 自动填充功能"></a>11. 自动填充功能</h1><p>创建时间、更新时间，对于这两个字段的操作我们希望是自动完成而不是需要手动编写。</p>
<p>1、我们给  <code>user</code>  表添加 <code>create_time</code> 字段和  <code>update_time</code> 字段并将这两个字段类型设置为 <code>timestamp</code>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> <span class="keyword">user</span> <span class="keyword">add</span> `create_time` <span class="type">timestamp</span> COMMENT <span class="string">&#x27;创建时间&#x27;</span>;</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> <span class="keyword">user</span> <span class="keyword">add</span> `update_time` <span class="type">timestamp</span> COMMENT <span class="string">&#x27;更新时间&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>2、同步实体类，实体类的属性上增加注解：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 字段填充内容</span></span><br><span class="line"><span class="meta">@TableField(fill = FieldFill.INSERT)</span></span><br><span class="line"><span class="keyword">private</span> LocalDateTime createTime;</span><br><span class="line"><span class="meta">@TableField(fill = FieldFill.INSERT_UPDATE)</span></span><br><span class="line"><span class="keyword">private</span> LocalDateTime updateTime;</span><br></pre></td></tr></table></figure>

<p>3、编写处理器来处理这些注解：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyMetaObjectHandler</span> <span class="keyword">implements</span> <span class="title class_">MetaObjectHandler</span> &#123;</span><br><span class="line">    <span class="comment">// 插入的填充策略</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">insertFill</span><span class="params">(MetaObject metaObject)</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;start insert fill ....&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.strictInsertFill(metaObject, <span class="string">&quot;createTime&quot;</span>, LocalDateTime.class, LocalDateTime.now());</span><br><span class="line">        <span class="built_in">this</span>.strictInsertFill(metaObject, <span class="string">&quot;updateTime&quot;</span>, LocalDateTime.class, LocalDateTime.now());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 更新的填充策略</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateFill</span><span class="params">(MetaObject metaObject)</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;start update fill ....&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.strictUpdateFill(metaObject, <span class="string">&quot;updateTime&quot;</span>, LocalDateTime.class, LocalDateTime.now());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3、测试插入：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testSave</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">    user.setName(<span class="string">&quot;木又枯了&quot;</span>);</span><br><span class="line">    user.setAge(<span class="number">18</span>);</span><br><span class="line">    user.setEmail(<span class="string">&quot;example@gmail.com&quot;</span>);</span><br><span class="line">    <span class="comment">// 这里使用 MP 默认主键 ID 生成策略</span></span><br><span class="line">    userMapper.insert(user); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>4、查看数据库：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/MyBatisPlus/%E6%95%B0%E6%8D%AE%E8%87%AA%E5%8A%A8%E5%A1%AB%E5%85%85.png" alt="数据自动填充"></p>
<h1 id="12-乐观锁插件"><a href="#12-乐观锁插件" class="headerlink" title="12. 乐观锁插件"></a>12. 乐观锁插件</h1><p>与乐观锁相对的有：<strong>悲观锁</strong></p>
<ul>
<li>悲观锁在数据修改前加锁，避免其他事务修改，确保数据安全但可能降低并发性能。</li>
<li>乐观锁则假设冲突少，只在数据提交时验证冲突，提高并发性能但可能需处理更多冲突。</li>
</ul>
<p>官方解释：<a href="https://baomidou.com/pages/0d93c0/#optimisticlockerinnerinterceptor">乐观锁插件</a></p>
<p>目的：当要更新一条记录的时候，希望这条记录没有被别人更新。</p>
<p>乐观锁实现方式：</p>
<ul>
<li>取出记录时，获取当前 version</li>
<li>更新时，带上这个 version</li>
<li>执行更新时， set version &#x3D; newVersion where version &#x3D; oldVersion</li>
<li>如果 version 不对，就更新失败</li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 假设有两个线程 A、B 同时修改一条记录</span></span><br><span class="line"><span class="keyword">update</span> <span class="keyword">user</span> <span class="keyword">set</span> name <span class="operator">=</span> &quot;木又枯了&quot;, version <span class="operator">=</span> version <span class="operator">+</span> <span class="number">1</span> <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">6</span> <span class="keyword">and</span> version <span class="operator">=</span> <span class="number">1</span></span><br><span class="line"><span class="comment">-- 但是 B 抢先完成了修改，version 修改成 2</span></span><br><span class="line"><span class="comment">-- 这个时候 A 就不能修改数据了，实现线程通信的安全</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>乐观锁插件实现步骤</p>
</blockquote>
<p>1、我们给 <code>user</code> 表添加一个 <code>version</code> 字段，设置默认值为 1 ：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> <span class="keyword">user</span> <span class="keyword">add</span> version <span class="type">int</span> <span class="keyword">default</span> b<span class="string">&#x27;1&#x27;</span> <span class="keyword">null</span> comment <span class="string">&#x27;乐观锁&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>添加结果如下：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/MyBatisPlus/%E6%B7%BB%E5%8A%A0version%E5%AD%97%E6%AE%B5.png" alt="添加version字段"></p>
<p>2、给实体类增加相应的字段，并添加注解 <code>@Version</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Version</span></span><br><span class="line"><span class="keyword">private</span> Integer version;</span><br></pre></td></tr></table></figure>

<p>3、注册组件</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@MapperScan(&quot;com.muyoukule.mapper&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MybatisPlusConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> MybatisPlusInterceptor <span class="title function_">mybatisPlusInterceptor</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">MybatisPlusInterceptor</span> <span class="variable">mybatisPlusInterceptor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MybatisPlusInterceptor</span>();</span><br><span class="line">        mybatisPlusInterceptor.addInnerInterceptor(<span class="keyword">new</span> <span class="title class_">OptimisticLockerInnerInterceptor</span>());</span><br><span class="line">        <span class="keyword">return</span> mybatisPlusInterceptor;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>4、编写测试方法进行测试：</p>
<p><strong>PS：要想实现乐观锁，首先第一步应该是拿到表中的 version，然后拿 version 当条件再将 version 加 1 更新回到数据库表中，所以我们需要<font color="red">先对其进行查询</font></strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 测试乐观锁</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testOptimisticLocker</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 查询</span></span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userMapper.selectById(<span class="number">2L</span>);</span><br><span class="line">    <span class="comment">// 修改信息</span></span><br><span class="line">    user.setName(<span class="string">&quot;muyoukule&quot;</span>);</span><br><span class="line">    user.setAge(<span class="number">18</span>);</span><br><span class="line">    user.setEmail(<span class="string">&quot;example@gmail.com&quot;</span>);</span><br><span class="line">    <span class="comment">// 更新信息</span></span><br><span class="line">    userMapper.updateById(user);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>5、查看数据库：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/MyBatisPlus/%E4%B9%90%E8%A7%82%E9%94%81%E4%BF%AE%E6%94%B9%E6%88%90%E5%8A%9F.png" alt="乐观锁修改成功"></p>
<p>我们再来测试一下修改失败的情况，模拟一种加锁的情况，看看能不能实现多个人修改同一个数据的时候，只能有一个人修改成功。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testOptimisticLocker2</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 1.先通过要修改的数据 id 将当前数据查询出来</span></span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userMapper.selectById(<span class="number">2L</span>);     <span class="comment">//version=2</span></span><br><span class="line">    <span class="type">User</span> <span class="variable">user2</span> <span class="operator">=</span> userMapper.selectById(<span class="number">2L</span>);    <span class="comment">//version=2</span></span><br><span class="line">    user2.setName(<span class="string">&quot;muyoukule222&quot;</span>);</span><br><span class="line">    userMapper.updateById(user2);              <span class="comment">//version=&gt;3</span></span><br><span class="line"></span><br><span class="line">    user.setName(<span class="string">&quot;muyoukule111&quot;</span>);</span><br><span class="line">    userMapper.updateById(user);               <span class="comment">//verion=2?条件还成立吗？</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果没有乐观锁，最后一次的修改会覆盖前一次的修改，但是有了乐观锁就不会出现这种情况了。查看数据库修改结果：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/MyBatisPlus/%E4%B9%90%E8%A7%82%E9%94%81%E4%BF%AE%E6%94%B9%E5%A4%B1%E8%B4%A5.png" alt="乐观锁修改失败"></p>
<p>查看数据库后发现 <code>muyoukule111</code> 并未覆盖 <code>muyoukule222</code> 。</p>
<h1 id="12-分页插件"><a href="#12-分页插件" class="headerlink" title="12. 分页插件"></a>12. 分页插件</h1><p>在未引入分页插件的情况下，<code>MP </code>是不支持分页功能的，<code>IService</code> 和 <code>BaseMapper</code> 中的分页方法都无法正常起效。 所以，我们必须配置分页插件。</p>
<p>1、配置分页插件：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@MapperScan(&quot;com.muyoukule.mapper&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MybatisPlusConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 添加分页插件</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> MybatisPlusInterceptor <span class="title function_">mybatisPlusInterceptor</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">MybatisPlusInterceptor</span> <span class="variable">interceptor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MybatisPlusInterceptor</span>();</span><br><span class="line">        interceptor.addInnerInterceptor(<span class="keyword">new</span> <span class="title class_">PaginationInnerInterceptor</span>(DbType.MYSQL));<span class="comment">//如果配置多个插件,切记分页最后添加</span></span><br><span class="line">        <span class="comment">//interceptor.addInnerInterceptor(new PaginationInnerInterceptor()); 如果有多数据源可以不配具体类型 否则都建议配上具体的DbType</span></span><br><span class="line">        <span class="keyword">return</span> interceptor;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2、编写一个分页查询的测试：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testPageQuery</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 1.分页查询，new Page()的两个参数分别是：页码、每页大小</span></span><br><span class="line">    Page&lt;User&gt; page = <span class="keyword">new</span> <span class="title class_">Page</span>&lt;&gt;(<span class="number">2</span>, <span class="number">2</span>);</span><br><span class="line">    userMapper.selectPage(page, <span class="literal">null</span>);</span><br><span class="line">    <span class="comment">// 2.总条数</span></span><br><span class="line">    System.out.println(<span class="string">&quot;total = &quot;</span> + page.getTotal());</span><br><span class="line">    <span class="comment">// 3.总页数</span></span><br><span class="line">    System.out.println(<span class="string">&quot;pages = &quot;</span> + page.getPages());</span><br><span class="line">    <span class="comment">// 4.数据</span></span><br><span class="line">    List&lt;User&gt; records = page.getRecords();</span><br><span class="line">    records.forEach(System.out::println);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3、控制台输出：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">total = 8</span><br><span class="line">pages = 4</span><br><span class="line">User(id=4, name=Sandy, age=19, email=test4@baomidou.com, deleted=false, status=NORMAL, info=null, createTime=null, updateTime=null, version=1)</span><br><span class="line">User(id=5, name=Billie, age=24, email=test5@baomidou.com, deleted=false, status=NORMAL, info=null, createTime=null, updateTime=null, version=1)</span><br></pre></td></tr></table></figure>

<p><strong>PS：由于前面我们使用了逻辑删除，<code>deleted</code> 值为 1 的字段不会被查询到，所以数据表一共是 8 条记录。</strong></p>
<p>4、对比数据库数据：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/MyBatisPlus/%E5%88%86%E9%A1%B5%E6%9F%A5%E8%AF%A2%E6%95%B0%E6%8D%AE%E5%BA%93%E6%95%B0%E6%8D%AE%E5%AF%B9%E6%AF%94.png" alt="分页查询数据库数据对比"></p>
]]></content>
      <categories>
        <category>SSM</category>
      </categories>
      <tags>
        <tag>MyBatisPlus</tag>
      </tags>
  </entry>
  <entry>
    <title>RabbitMQ高级</title>
    <url>/posts/7875/</url>
    <content><![CDATA[<p>RabbitMQ官网：<a href="https://www.rabbitmq.com/">https://www.rabbitmq.com</a></p>
<p>参考视频：<a href="https://www.bilibili.com/video/BV1mN4y1Z7t9/">黑马程序员RabbitMQ入门到实战教程，MQ消息中间件，微服务rabbitmq消息队列实战，RabbitMQ面试题一套全覆盖</a></p>
<h1 id="0-写在前面"><a href="#0-写在前面" class="headerlink" title="0. 写在前面"></a>0. 写在前面</h1><p>在使用 MQ 时我们必须尽可能确保 MQ 消息的可靠性，即：消息应该至少被消费者处理1次</p>
<p>那么问题来了：</p>
<ul>
<li><strong>我们该如何确保MQ消息的可靠性？</strong></li>
<li><strong>如果真的发送失败，有没有其它的兜底方案？</strong></li>
</ul>
<p>这些问题，在下面的学习中都会找到答案。</p>
<h1 id="1-发送者的可靠性"><a href="#1-发送者的可靠性" class="headerlink" title="1. 发送者的可靠性"></a>1. 发送者的可靠性</h1><p>首先，我们一起分析一下消息丢失的可能性有哪些。</p>
<p>消息从发送者发送消息，到消费者处理消息，需要经过的流程是这样的：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/MQIMG/RabbitMQ/%E6%B6%88%E6%81%AF%E7%BB%8F%E8%BF%87%E7%9A%84%E6%B5%81%E7%A8%8B.png" alt="消息经过的流程"></p>
<p>消息从生产者到消费者的每一步都可能导致消息丢失：</p>
<ul>
<li>发送消息时丢失：<ul>
<li>生产者发送消息时连接 MQ 失败</li>
<li>生产者发送消息到达 MQ后未找到 <code>Exchange</code></li>
<li>生产者发送消息到达 MQ 的 <code>Exchange</code> 后，未找到合适的 <code>Queue</code></li>
<li>消息到达 MQ 后，处理消息的进程发生异常</li>
</ul>
</li>
<li>MQ 导致消息丢失：<ul>
<li>消息到达 MQ ，保存到队列后，尚未消费就突然宕机</li>
</ul>
</li>
<li>消费者处理消息时：<ul>
<li>消息接收后尚未处理突然宕机</li>
<li>消息接收后处理过程中抛出异常</li>
</ul>
</li>
</ul>
<p>综上，我们要解决消息丢失问题，保证 MQ 的可靠性，就必须从 3 个方面入手：</p>
<ul>
<li>确保生产者一定把消息发送到 MQ</li>
<li>确保 MQ 不会将消息弄丢</li>
<li>确保消费者一定要处理消息</li>
</ul>
<p>这一章我们先来看如何确保生产者一定能把消息发送到 MQ。</p>
<h2 id="1-1-生产者重试机制"><a href="#1-1-生产者重试机制" class="headerlink" title="1.1 生产者重试机制"></a>1.1 生产者重试机制</h2><p>首先第一种情况，就是生产者发送消息时，出现了网络故障，导致与MQ的连接中断。</p>
<p>为了解决这个问题，SpringAMQP 提供的消息发送时的重试机制。即：当<code>RabbitTemplate </code>与 MQ 连接超时后，多次重试。</p>
<p>1、修改 <code>publisher</code> 模块的 <code>application.yaml</code> 文件，添加下面的内容：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">connection-timeout:</span> <span class="string">1s</span> <span class="comment"># 设置MQ的连接超时时间</span></span><br><span class="line">    <span class="attr">template:</span></span><br><span class="line">      <span class="attr">retry:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment"># 开启超时重试机制</span></span><br><span class="line">        <span class="attr">initial-interval:</span> <span class="string">1000ms</span> <span class="comment"># 失败后的初始等待时间</span></span><br><span class="line">        <span class="attr">multiplier:</span> <span class="number">1</span> <span class="comment"># 失败后下次的等待时长倍数，下次等待时长 = initial-interval * multiplier</span></span><br><span class="line">        <span class="attr">max-attempts:</span> <span class="number">3</span> <span class="comment"># 最大重试次数</span></span><br></pre></td></tr></table></figure>

<p>2、利用命令停掉 RabbitMQ 服务：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker stop mq</span><br></pre></td></tr></table></figure>
<p>3、然后测试发送一条消息，会发现会每隔1秒重试1次，总共重试了3次。消息发送的超时重试机制配置成功了！</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">03-31 08:54:13:838  INFO 13056 --- [           main] o.s.a.r.c.CachingConnectionFactory       : Attempting to connect to: [192.168.88.132:5672]</span><br><span class="line">03-31 08:54:15:858  INFO 13056 --- [           main] o.s.a.r.c.CachingConnectionFactory       : Attempting to connect to: [192.168.88.132:5672]</span><br><span class="line">03-31 08:54:17:885  INFO 13056 --- [           main] o.s.a.r.c.CachingConnectionFactory       : Attempting to connect to: [192.168.88.132:5672]</span><br></pre></td></tr></table></figure>

<p>PS：这个失败仅仅是连接失败的重试，如果消息发送抛出异常时不会重试😂</p>
<p><strong>注意：</strong></p>
<p>当网络不稳定的时候，利用重试机制可以有效提高消息发送的成功率。不过SpringAMQP提供的重试机制是<strong>阻塞式</strong>的重试，也就是说多次重试等待的过程中，当前线程是被阻塞的。</p>
<p>如果对于业务性能有要求，建议禁用重试机制。如果一定要使用，请合理配置等待时长和重试次数，当然也可以考虑使用异步线程来执行发送消息的代码。</p>
<h2 id="1-2-生产者确认机制"><a href="#1-2-生产者确认机制" class="headerlink" title="1.2 生产者确认机制"></a>1.2 生产者确认机制</h2><p>一般情况下，只要生产者与 MQ 之间的网路连接顺畅，基本不会出现发送消息丢失的情况，因此大多数情况下我们无需考虑这种问题。</p>
<p>不过，在少数情况下，也会出现消息发送到MQ之后丢失的现象，比如：</p>
<ul>
<li>MQ 内部处理消息的进程发生了异常</li>
<li>生产者发送消息到达 MQ 后未找到 <code>Exchange</code></li>
<li>生产者发送消息到达 MQ 的 <code>Exchange</code> 后，未找到合适的 <code>Queue</code>，因此无法路由</li>
</ul>
<p>针对上述情况，RabbitMQ 提供了生产者消息确认机制，包括 <code>Publisher Confirm</code> 和 <code>Publisher Return</code> 两种。在开启确认机制的情况下，当生产者发送消息给 MQ 后，MQ会根据消息处理的情况返回不同的<strong>回执</strong>。</p>
<p>具体如图所示：<br><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/MQIMG/RabbitMQ/RabbitMQ%E7%94%9F%E4%BA%A7%E8%80%85%E6%B6%88%E6%81%AF%E7%A1%AE%E8%AE%A4%E6%9C%BA%E5%88%B6.png" alt="RabbitMQ生产者消息确认机制"></p>
<p><strong>总结如下：</strong></p>
<ul>
<li>当消息投递到MQ，但是路由失败时，通过 <strong>Publisher Return</strong> 返回异常信息，同时返回 ACK 的确认信息，代表投递成功</li>
<li>临时消息投递到了 MQ，并且入队成功，返回 ACK，告知投递成功</li>
<li>持久消息投递到了 MQ，并且入队完成持久化，返回 ACK ，告知投递成功</li>
<li>其它情况都会返回 NACK，告知投递失败</li>
</ul>
<p>其中 <code>ACK</code> 和 <code>NACK</code> 属于<strong>Publisher Confirm</strong>机制，<code>ACK</code>是投递成功；<code>NACK</code>是投递失败。而<code>return</code>则属于 <strong>Publisher Return</strong> 机制。</p>
<p>默认两种机制都是关闭状态，需要通过配置文件来开启。</p>
<h2 id="1-3-实现生产者确认"><a href="#1-3-实现生产者确认" class="headerlink" title="1.3 实现生产者确认"></a>1.3 实现生产者确认</h2><h3 id="1-3-1-开启生产者确认"><a href="#1-3-1-开启生产者确认" class="headerlink" title="1.3.1 开启生产者确认"></a>1.3.1 开启生产者确认</h3><p>在 publisher 模块的 <code>application.yaml</code> 中添加配置：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">publisher-confirm-type:</span> <span class="string">correlated</span> <span class="comment"># 开启publisher confirm机制，并设置confirm类型</span></span><br><span class="line">    <span class="attr">publisher-returns:</span> <span class="literal">true</span> <span class="comment"># 开启publisher return机制</span></span><br></pre></td></tr></table></figure>
<p>这里 <code>publisher-confirm-type</code> 有三种模式可选：</p>
<ul>
<li><code>none</code>：关闭 confirm 机制</li>
<li><code>simple</code>：同步阻塞等待 MQ 的回执</li>
<li><code>correlated</code>：MQ 异步回调返回回执</li>
</ul>
<p>一般我们推荐使用 <code>correlated </code>回调机制。</p>
<h3 id="1-3-2-定义ReturnCallback"><a href="#1-3-2-定义ReturnCallback" class="headerlink" title="1.3.2 定义ReturnCallback"></a>1.3.2 定义ReturnCallback</h3><p>每个 <code>RabbitTemplate</code> 只能配置一个 <code>ReturnCallback</code>，因此我们可以在配置类中统一设置。我们在 publisher 模块定义一个配置类：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.muyoukule.consumer.config;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MqConfig</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">        rabbitTemplate.setReturnsCallback(<span class="keyword">new</span> <span class="title class_">RabbitTemplate</span>.ReturnsCallback() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">returnedMessage</span><span class="params">(ReturnedMessage returned)</span> &#123;</span><br><span class="line">                log.error(<span class="string">&quot;触发return callback,&quot;</span>);</span><br><span class="line">                log.debug(<span class="string">&quot;exchange: &#123;&#125;&quot;</span>, returned.getExchange());</span><br><span class="line">                log.debug(<span class="string">&quot;routingKey: &#123;&#125;&quot;</span>, returned.getRoutingKey());</span><br><span class="line">                log.debug(<span class="string">&quot;message: &#123;&#125;&quot;</span>, returned.getMessage());</span><br><span class="line">                log.debug(<span class="string">&quot;replyCode: &#123;&#125;&quot;</span>, returned.getReplyCode());</span><br><span class="line">                log.debug(<span class="string">&quot;replyText: &#123;&#125;&quot;</span>, returned.getReplyText());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="1-3-3-定义ConfirmCallback"><a href="#1-3-3-定义ConfirmCallback" class="headerlink" title="1.3.3 定义ConfirmCallback"></a>1.3.3 定义ConfirmCallback</h3><p>由于每个消息发送时的处理逻辑不一定相同，因此ConfirmCallback需要在每次发消息时定义。具体来说，是在调用RabbitTemplate中的convertAndSend方法时，多传递一个参数：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/MQIMG/RabbitMQ/convertAndSend%E6%96%B9%E6%B3%95.png" alt="convertAndSend方法"></p>
<p>这里的CorrelationData中包含两个核心的东西：</p>
<ul>
<li><code>id</code>：消息的唯一标示，MQ 对不同的消息的回执以此做判断，避免混淆</li>
<li><code>SettableListenableFuture</code>：回执结果的 Future 对象</li>
</ul>
<p>将来 MQ 的回执就会通过这个 <code>Future</code> 来返回，我们可以提前给 <code>CorrelationData</code> 中的 <code>Future</code> 添加回调函数来处理消息回执：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/MQIMG/RabbitMQ/addCallback%E5%9B%9E%E8%B0%83%E5%87%BD%E6%95%B0.png" alt="addCallback回调函数"></p>
<p>我们新建一个测试，向系统自带的交换机发送消息，并且添加 <code>ConfirmCallback</code>：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testPublisherConfirm</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="comment">// 1.创建CorrelationData</span></span><br><span class="line">    <span class="comment">// id 是当前消息的标识，让 RabbitMQ 区分消息，防止产生混乱，不知道该回调给谁</span></span><br><span class="line">    <span class="type">CorrelationData</span> <span class="variable">cd</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CorrelationData</span>(UUID.randomUUID().toString());</span><br><span class="line">    <span class="comment">// 2.给Future添加ConfirmCallback</span></span><br><span class="line">    cd.getFuture().addCallback(<span class="keyword">new</span> <span class="title class_">ListenableFutureCallback</span>&lt;CorrelationData.Confirm&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onFailure</span><span class="params">(Throwable ex)</span> &#123;</span><br><span class="line">            <span class="comment">// 2.1.Future发生异常时的处理逻辑，基本不会触发</span></span><br><span class="line">            log.error(<span class="string">&quot;消息回调失败&quot;</span>, ex);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onSuccess</span><span class="params">(CorrelationData.Confirm result)</span> &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;收到confirm callback回执&quot;</span>);</span><br><span class="line">            <span class="comment">// 2.2.Future接收到回执的处理逻辑，参数中的result就是回执内容</span></span><br><span class="line">            <span class="keyword">if</span> (result.isAck()) &#123; <span class="comment">// result.isAck()，boolean类型，true代表ack回执，false 代表 nack回执</span></span><br><span class="line">                log.debug(<span class="string">&quot;发送消息成功，收到 ack!&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123; <span class="comment">// result.getReason()，String类型，返回nack时的异常描述</span></span><br><span class="line">                log.error(<span class="string">&quot;发送消息失败，收到 nack, 原因 : &#123;&#125;&quot;</span>, result.getReason());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// 3.发送消息</span></span><br><span class="line">    rabbitTemplate.convertAndSend(<span class="string">&quot;hmall.direct&quot;</span>, <span class="string">&quot;red&quot;</span>, <span class="string">&quot;hello&quot;</span>, cd);</span><br><span class="line"></span><br><span class="line">    Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>执行结果如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">03-31 09:25:25:604 DEBUG 11344 --- [168.88.132:5672] c.m.publisher.amqp.SpringAmqpTest        : 收到confirm callback回执</span><br><span class="line">03-31 09:25:25:604 DEBUG 11344 --- [168.88.132:5672] c.m.publisher.amqp.SpringAmqpTest        : 发送消息成功，收到 ack!</span><br></pre></td></tr></table></figure>

<p>修改 <code>routingKey</code> 为不存在的 red2：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">rabbitTemplate.convertAndSend(<span class="string">&quot;hmall.direct&quot;</span>, <span class="string">&quot;red2&quot;</span>, <span class="string">&quot;hello&quot;</span>, cd);</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">03-31 09:50:32:950  WARN 9664 --- [nectionFactory1] o.s.amqp.rabbit.core.RabbitTemplate      : Returned message but no callback available</span><br><span class="line">03-31 09:50:32:951 DEBUG 9664 --- [168.88.132:5672] c.m.publisher.amqp.SpringAmqpTest        : 收到confirm callback回执</span><br><span class="line">03-31 09:50:32:951 DEBUG 9664 --- [168.88.132:5672] c.m.publisher.amqp.SpringAmqpTest        : 发送消息成功，收到 ack!</span><br></pre></td></tr></table></figure>

<p>修改 <code>exchange</code> 为不存在的 hmall.direct2：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">rabbitTemplate.convertAndSend(<span class="string">&quot;hmall.direct2&quot;</span>, <span class="string">&quot;red&quot;</span>, <span class="string">&quot;hello&quot;</span>, cd);</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">03-31 09:52:12:691 ERROR 1792 --- [168.88.132:5672] o.s.a.r.c.CachingConnectionFactory       : Shutdown Signal: channel error; protocol method: #method&lt;channel.close&gt;(reply-code=404, reply-text=NOT_FOUND - no exchange &#x27;hmall.2&#x27; in vhost &#x27;/hmall&#x27;, class-id=60, method-id=40)</span><br><span class="line">03-31 09:52:12:691 DEBUG 1792 --- [nectionFactory1] c.m.publisher.amqp.SpringAmqpTest        : 收到confirm callback回执</span><br><span class="line">03-31 09:52:12:691 ERROR 1792 --- [nectionFactory1] c.m.publisher.amqp.SpringAmqpTest        : 发送消息失败，收到 nack, 原因 : channel error; protocol method: #method&lt;channel.close&gt;(reply-code=404, reply-text=NOT_FOUND - no exchange &#x27;hmall.2&#x27; in vhost &#x27;/hmall&#x27;, class-id=60, method-id=40)</span><br></pre></td></tr></table></figure>

<p>可以看到，由于传递的 <code>RoutingKey </code>是错误的，路由失败后，触发了 <code>return callback</code>，同时也收到了 ack。</p>
<p>当我们修改为正确的 <code>RoutingKey</code> 以后，就不会触发 <code>return callback</code> 了，只收到ack。</p>
<p>而如果连交换机都是错误的，则只会收到 nack。</p>
<p><strong>注意：</strong></p>
<p>开启生产者确认比较消耗MQ性能，一般不建议开启。而且大家思考一下触发确认的几种情况：</p>
<ul>
<li>路由失败：一般是因为 RoutingKey 错误导致，往往是编程导致</li>
<li>交换机名称错误：同样是编程错误导致</li>
<li>MQ 内部故障：这种需要处理，但概率往往较低。因此只有对消息可靠性要求非常高的业务才需要开启，而且仅仅需要开启ConfirmCallback 处理 nack 就可以了。</li>
</ul>
<h1 id="2-MQ的可靠性"><a href="#2-MQ的可靠性" class="headerlink" title="2. MQ的可靠性"></a>2. MQ的可靠性</h1><p>消息到达 MQ 以后，如果 MQ 不能及时保存，也会导致消息丢失，所以 MQ 的可靠性也非常重要。</p>
<h2 id="2-1-数据持久化"><a href="#2-1-数据持久化" class="headerlink" title="2.1 数据持久化"></a>2.1 数据持久化</h2><p>为了提升性能，默认情况下 MQ 的数据都是在内存存储的临时数据，重启后就会消失。为了保证数据的可靠性，必须配置数据持久化，包括：</p>
<ul>
<li>交换机持久化</li>
<li>队列持久化</li>
<li>消息持久化</li>
</ul>
<p>我们以控制台界面为例来说明。</p>
<h3 id="2-1-1-交换机持久化"><a href="#2-1-1-交换机持久化" class="headerlink" title="2.1.1 交换机持久化"></a>2.1.1 交换机持久化</h3><p>在控制台的 <code>Exchanges</code> 页面，添加交换机时可以配置交换机的 <code>Durability </code> 参数：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/MQIMG/RabbitMQ/%E4%BA%A4%E6%8D%A2%E6%9C%BA%E7%9A%84Durability%E5%8F%82%E6%95%B0.png" alt="交换机的Durability参数" style="zoom: 80%;">

<p>设置为 <code>Durable</code> 就是持久化模式，<code>Transient </code> 就是临时模式。</p>
<h3 id="2-1-2-队列持久化"><a href="#2-1-2-队列持久化" class="headerlink" title="2.1.2 队列持久化"></a>2.1.2 队列持久化</h3><p>在控制台的 Queues 页面，添加队列时，同样可以配置队列的 <code>Durability</code> 参数：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/MQIMG/RabbitMQ/%E9%98%9F%E5%88%97%E7%9A%84Durability%E5%8F%82%E6%95%B0.png" alt="队列的Durability参数" style="zoom:67%;">

<p>设置为 <code>Durable</code> 就是持久化模式，<code>Transient </code> 就是临时模式。</p>
<p>除了持久化以外，你可以看到队列还有很多其它参数，有一些我们会在后期学习。</p>
<p><font color="red">PS：Spring 在创建交换机和队列时候默认将他们处理为持久化。</font>😄</p>
<h3 id="2-1-3-消息持久化"><a href="#2-1-3-消息持久化" class="headerlink" title="2.1.3 消息持久化"></a>2.1.3 消息持久化</h3><p>在控制台发送消息的时候，可以添加很多参数，而消息的持久化是要配置一个 <code>properties</code>：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/MQIMG/RabbitMQ/%E6%B6%88%E6%81%AF%E7%9A%84Delivered%20mode%E5%8F%82%E6%95%B0.png" alt="消息的Delivered mode参数" style="zoom: 80%;">

<p>设置为 <code>2</code> 就是持久化模式，<code>1 </code> 就是临时模式。</p>
<p><strong>说明：</strong></p>
<p>在开启持久化机制以后，如果同时还开启了生产者确认，那么 MQ 会在消息持久化以后才发送 ACK 回执，进一步确保消息的可靠性。</p>
<p>不过出于性能考虑，为了减少 IO 次数，发送到 MQ 的消息并不是逐条持久化到数据库的，而是每隔一段时间批量持久化。一般间隔在 100 毫秒左右，这就会导致 ACK 有一定的延迟，因此建议生产者确认全部采用异步方式。</p>
<h2 id="2-2-LazyQueue"><a href="#2-2-LazyQueue" class="headerlink" title="2.2 LazyQueue"></a>2.2 LazyQueue</h2><p>在默认情况下，RabbitMQ 会将接收到的信息保存在内存中以降低消息收发的延迟。但在某些特殊情况下，这会导致消息积压，比如：</p>
<ul>
<li>消费者宕机或出现网络故障</li>
<li>消息发送量激增，超过了消费者处理速度</li>
<li>消费者处理业务发生阻塞</li>
</ul>
<p>一旦出现消息堆积问题，RabbitMQ 的内存占用就会越来越高，直到触发内存预警上限。此时 RabbitMQ 会将内存消息刷到磁盘上，这个行为成为 <code>PageOut</code>， <code>PageOut </code> 会耗费一段时间，并且会阻塞队列进程。因此在这个过程中 RabbitMQ 不会再处理新的消息，生产者的所有请求都会被阻塞。</p>
<p>为了解决这个问题，从 RabbitMQ 的 3.6.0 版本开始，就增加了 Lazy Queues 的模式，也就是惰性队列。惰性队列的特征如下：</p>
<ul>
<li>接收到消息后<strong>直接存入磁盘而非内存</strong></li>
<li>消费者要消费消息时才会从磁盘中读取并加载到内存(也就是懒加载)</li>
<li>支持数百万条的消息存储</li>
</ul>
<p>而在 3.12 版本之后，LazyQueue 已经成为所有队列的默认格式。因此官方推荐升级 MQ 为 3.12 版本或者所有队列都设置为 LazyQueue 模式。</p>
<h3 id="2-2-1-控制台配置Lazy模式"><a href="#2-2-1-控制台配置Lazy模式" class="headerlink" title="2.2.1 控制台配置Lazy模式"></a>2.2.1 控制台配置Lazy模式</h3><p>在添加队列的时候，添加 <code>x-queue-mod=lazy</code> 参数即可设置队列为 Lazy 模式：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/MQIMG/RabbitMQ/%E8%AE%BE%E7%BD%AE%E9%98%9F%E5%88%97%E4%B8%BALazy%E6%A8%A1%E5%BC%8F.png" alt="设置队列为Lazy模式"></p>
<h3 id="2-2-2-代码配置Lazy模式"><a href="#2-2-2-代码配置Lazy模式" class="headerlink" title="2.2.2 代码配置Lazy模式"></a>2.2.2 代码配置Lazy模式</h3><p>在利用 SpringAMQP 声明队列的时候，添加 <code>x-queue-mod=lazy</code>参数也可设置队列为Lazy模式：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> Queue <span class="title function_">lazyQueue</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> QueueBuilder</span><br><span class="line">            .durable(<span class="string">&quot;lazy.queue&quot;</span>)</span><br><span class="line">            .lazy() <span class="comment">// 开启Lazy模式</span></span><br><span class="line">            .build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里是通过 <code>QueueBuilder</code> 的 <code>lazy()</code> 函数配置Lazy模式，底层源码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> QueueBuilder <span class="title function_">lazy</span><span class="params">()</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> withArgument(<span class="string">&quot;x-queue-mode&quot;</span>, <span class="string">&quot;lazy&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当然，我们也可以基于注解来声明队列并设置为 Lazy 模式：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RabbitListener(queuesToDeclare = @Queue(</span></span><br><span class="line"><span class="meta">        name = &quot;lazy.queue&quot;,</span></span><br><span class="line"><span class="meta">        durable = &quot;true&quot;,</span></span><br><span class="line"><span class="meta">        arguments = @Argument(name = &quot;x-queue-mode&quot;, value = &quot;lazy&quot;)</span></span><br><span class="line"><span class="meta">))</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listenLazyQueue</span><span class="params">(String msg)</span>&#123;</span><br><span class="line">    log.info(<span class="string">&quot;接收到 lazy.queue的消息：&#123;&#125;&quot;</span>, msg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-2-3-更新已有队列为Lazy模式"><a href="#2-2-3-更新已有队列为Lazy模式" class="headerlink" title="2.2.3 更新已有队列为Lazy模式"></a>2.2.3 更新已有队列为Lazy模式</h3><p>对于已经存在的队列，也可以配置为 Lazy 模式，但是要通过设置 policy 实现。</p>
<p>可以基于命令行设置 policy：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">rabbitmqctl set_policy Lazy &quot;^lazy-queue$&quot; &#x27;&#123;&quot;queue-mode&quot;:&quot;lazy&quot;&#125;&#x27; --apply-to queues  </span><br></pre></td></tr></table></figure>
<p>命令解读：</p>
<ul>
<li><code>rabbitmqctl</code> ：RabbitMQ 的命令行工具</li>
<li><code>set_policy</code> ：添加一个策略</li>
<li><code>Lazy</code> ：策略名称，可以自定义</li>
<li><code>&quot;^lazy-queue$&quot;</code> ：用正则表达式匹配队列的名字</li>
<li><code>&#39;&#123;&quot;queue-mode&quot;:&quot;lazy&quot;&#125;&#39;</code> ：设置队列模式为lazy模式</li>
<li><code>--apply-to queues</code>：策略的作用对象，是所有的队列</li>
</ul>
<p>当然，也可以在控制台配置 policy，进入在控制台的 <code>Admin</code> 页面，点击 <code>Policies</code>，即可添加配置：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/MQIMG/RabbitMQ/%E6%9B%B4%E6%96%B0%E5%B7%B2%E6%9C%89%E9%98%9F%E5%88%97%E4%B8%BAlazy%E6%A8%A1%E5%BC%8F.png" alt="更新已有队列为lazy模式">

<h1 id="3-消费者的可靠性"><a href="#3-消费者的可靠性" class="headerlink" title="3. 消费者的可靠性"></a>3. 消费者的可靠性</h1><p>当 RabbitMQ 向消费者投递消息以后，需要知道消费者的处理状态如何。因为消息投递给消费者并不代表就一定被正确消费了，可能出现的故障有很多，比如：</p>
<ul>
<li>消息投递的过程中出现了网络故障</li>
<li>消费者接收到消息后突然宕机</li>
<li>消费者接收到消息后，因处理不当导致异常</li>
</ul>
<p>一旦发生上述情况，消息也会丢失。因此，RabbitMQ 必须知道消费者的处理状态，一旦消息处理失败才能重新投递消息。</p>
<p>但问题来了：RabbitMQ 如何得知消费者的处理状态呢？</p>
<p>本章我们就一起研究一下消费者处理消息时的可靠性解决方案。</p>
<h2 id="2-1-消费者确认机制"><a href="#2-1-消费者确认机制" class="headerlink" title="2.1 消费者确认机制"></a>2.1 消费者确认机制</h2><p>为了确认消费者是否成功处理消息，RabbitMQ 提供了消费者确认机制(<strong>Consumer Acknowledgement</strong>)。即：当消费者处理消息结束后，应该向 RabbitMQ 发送一个回执，告知 RabbitMQ 自己消息处理状态。回执有三种可选值：</p>
<ul>
<li>ack：成功处理消息，RabbitMQ从队列中删除该消息</li>
<li>nack：消息处理失败，RabbitMQ需要再次投递消息</li>
<li>reject：消息处理失败并拒绝该消息，RabbitMQ从队列中删除该消息</li>
</ul>
<p>一般 reject 方式用的较少，除非是消息格式有问题，那就是开发问题了。因此大多数情况下我们需要将消息处理的代码通过 <code>try catch</code> 机制捕获，消息处理成功时返回 ack，处理失败时返回 nack.</p>
<p>由于消息回执的处理代码比较统一，因此 SpringAMQP 帮我们实现了消息确认。并允许我们通过配置文件设置 ACK 处理方式，有三种模式：</p>
<ul>
<li><code>none</code>：不处理。即消息投递给消费者后立刻ack，消息会立刻从 MQ 删除。非常不安全，不建议使用</li>
<li><code>manual</code>：手动模式。需要自己在业务代码中调用api，发送 <code>ack</code> 或 <code>reject</code>，存在业务入侵，但更灵活</li>
<li><code>auto</code>：自动模式。SpringAMQP 利用 AOP 对我们的消息处理逻辑做了环绕增强，当业务正常执行时则自动返回 <code>ack</code>。 当业务出现异常时，根据异常判断返回不同结果：<ul>
<li>如果是<strong>业务异常</strong>，会自动返回 <code>nack</code>；</li>
<li>如果是<strong>消息处理或校验异常</strong>，自动返回 <code>reject</code>;</li>
</ul>
</li>
</ul>
<p>返回 Reject 的常见异常有：</p>
<p>Starting with version 1.3.2, the default ErrorHandler is now a ConditionalRejectingErrorHandler that rejects (and does not requeue) messages that fail with an irrecoverable error. Specifically, it rejects messages that fail with the following errors:</p>
<ul>
<li>o.s.amqp…MessageConversionException: Can be thrown when converting the incoming message payload using a MessageConverter.</li>
<li>o.s.messaging…MessageConversionException: Can be thrown by the conversion service if additional conversion is required when mapping to a @RabbitListener method.</li>
<li>o.s.messaging…MethodArgumentNotValidException: Can be thrown if validation (for example, @Valid) is used in the listener and the validation fails.</li>
<li>o.s.messaging…MethodArgumentTypeMismatchException: Can be thrown if the inbound message was converted to a type that is not correct for the target method. For example, the parameter is declared as Message<Foo> but Message<Bar> is received.</Bar></Foo></li>
<li>java.lang.NoSuchMethodException: Added in version 1.6.3.</li>
<li>java.lang.ClassCastException: Added in version 1.6.3.</li>
</ul>
<p>通过下面的配置可以修改 SpringAMQP 的 ACK 处理方式：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">listener:</span></span><br><span class="line">      <span class="attr">simple:</span></span><br><span class="line">        <span class="attr">acknowledge-mode:</span> <span class="string">none</span> <span class="comment"># 不做处理</span></span><br></pre></td></tr></table></figure>

<p>修改 consumer 服务的 MqRabbitListener 类中的方法，模拟一个消息处理的异常：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RabbitListener(queues = &quot;simple.queue&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listenSimpleQueue</span><span class="params">(String msg)</span> &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;消费者收到了simple.queue的消息：【&quot;</span> + msg + <span class="string">&quot;】&quot;</span>);</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">MessageConversionException</span>(<span class="string">&quot;故意的&quot;</span>);	<span class="comment">// 此处断点</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试可以发现：当消息处理发生异常时，消息依然被 RabbitMQ 删除了。</p>
<p>我们再次把确认机制修改为 auto：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">listener:</span></span><br><span class="line">      <span class="attr">simple:</span></span><br><span class="line">        <span class="attr">acknowledge-mode:</span> <span class="string">auto</span> <span class="comment"># 自动ack</span></span><br></pre></td></tr></table></figure>

<p>在异常位置打断点，再次发送消息，程序卡在断点时，可以发现此时消息状态为 <code>unacked </code>(未确定状态)：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/MQIMG/RabbitMQ/%E6%B6%88%E6%81%AF%E7%8A%B6%E6%80%81unacked.png" alt="消息状态unacked"></p>
<p>放行以后，由于抛出的是<strong>消息转换异常</strong>，因此 Spring 会自动返回 <code>reject</code>，所以消息依然会被删除：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/MQIMG/RabbitMQ/%E6%B6%88%E6%81%AF%E8%A2%AB%E5%88%A0%E9%99%A4.png" alt="消息被删除"></p>
<p>我们将异常改为 RuntimeException 类型：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RabbitListener(queues = &quot;simple.queue&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listenSimpleQueue</span><span class="params">(String msg)</span> &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;消费者收到了simple.queue的消息：【&quot;</span> + msg + <span class="string">&quot;】&quot;</span>);</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;故意的&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在异常位置打断点，然后再次发送消息测试，程序卡在断点时，可以发现此时消息状态为 <code>unacked</code> (未确定状态)：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/MQIMG/RabbitMQ/%E6%B6%88%E6%81%AF%E7%8A%B6%E6%80%81unacked.png" alt="消息状态unacked"></p>
<p>放行以后，由于抛出的是业务异常，所以 Spring 返回 <code>ack</code>，最终消息恢复至 <code>Ready</code> 状态，并且没有被 RabbitMQ 删除：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/MQIMG/RabbitMQ/%E6%B6%88%E6%81%AF%E6%81%A2%E5%A4%8D%E8%87%B3Ready%E7%8A%B6%E6%80%81.png" alt="消息恢复至Ready状态"></p>
<p>当我们把配置改为 <code>auto</code> 时，消息处理失败后，会回到 RabbitMQ，并重新投递到消费者。</p>
<h2 id="2-2-失败重试机制"><a href="#2-2-失败重试机制" class="headerlink" title="2.2 失败重试机制"></a>2.2 失败重试机制</h2><p>当消费者出现异常后，消息会不断 requeue (重入队)到队列，再重新发送给消费者。如果消费者再次执行依然出错，消息会再次 requeue 到队列，再次投递，直到消息处理成功为止。</p>
<p>极端情况就是消费者一直无法执行成功，那么消息 requeue 就会无限循环，导致 MQ 的消息处理飙升，带来不必要的压力：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/MQIMG/RabbitMQ/MQ%E7%9A%84%E6%B6%88%E6%81%AF%E5%A4%84%E7%90%86%E9%A3%99%E5%8D%87.png" alt="MQ的消息处理飙升"></p>
<p>当然，上述极端情况发生的概率还是非常低的，不过不怕一万就怕万一。为了应对上述情况 Spring 又提供了消费者失败重试机制：在消费者出现异常时利用本地重试，而不是无限制的 requeue 到 mq 队列。</p>
<p>修改 <code>consumer</code> 服务的 <code>application.yml</code> 文件，添加内容：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">listener:</span></span><br><span class="line">      <span class="attr">simple:</span></span><br><span class="line">        <span class="attr">retry:</span></span><br><span class="line">          <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment"># 开启消费者失败重试</span></span><br><span class="line">          <span class="attr">initial-interval:</span> <span class="string">1000ms</span> <span class="comment"># 初识的失败等待时长为1秒</span></span><br><span class="line">          <span class="attr">multiplier:</span> <span class="number">1</span> <span class="comment"># 失败的等待时长倍数，下次等待时长 = multiplier * last-interval</span></span><br><span class="line">          <span class="attr">max-attempts:</span> <span class="number">3</span> <span class="comment"># 最大重试次数</span></span><br><span class="line">          <span class="attr">stateless:</span> <span class="literal">true</span> <span class="comment"># true无状态；false有状态。如果业务中包含事务，这里改为false</span></span><br></pre></td></tr></table></figure>

<p>重启 <code>consumer</code> 服务，重复之前的测试。可以发现：</p>
<ul>
<li>消费者在失败后消息没有重新回到MQ无限重新投递，而是在本地重试了 3 次</li>
<li>本地重试 3 次以后，抛出了 <code>AmqpRejectAndDontRequeueException</code> 异常。查看 RabbitMQ 控制台，发现消息被删除了，说明最后 SpringAMQP 返回的是 <code>reject</code></li>
</ul>
<p>结论：</p>
<ul>
<li>开启本地重试时，消息处理过程中抛出异常，不会 requeue 到队列，而是在消费者本地重试</li>
<li>重试达到最大次数后，Spring 会返回 reject，消息会被丢弃</li>
</ul>
<h2 id="2-3-失败处理策略"><a href="#2-3-失败处理策略" class="headerlink" title="2.3 失败处理策略"></a>2.3 失败处理策略</h2><p>在之前的测试中，本地测试达到最大重试次数后，消息会被丢弃。这在某些对于消息可靠性要求较高的业务场景下，显然不太合适了。<br>因此 Spring 允许我们自定义重试次数耗尽后的消息处理策略，这个策略是由 <code>MessageRecovery</code> 接口来定义的，它有 3 个不同实现：</p>
<ul>
<li><code>RejectAndDontRequeueRecoverer</code>：重试耗尽后，直接 <code>reject</code>，丢弃消息。默认就是这种方式 </li>
<li><code>ImmediateRequeueMessageRecoverer</code>：重试耗尽后，返回 <code>nack</code>，消息重新入队 </li>
<li><code>RepublishMessageRecoverer</code>：重试耗尽后，将失败消息投递到指定的交换机</li>
</ul>
<p>比较优雅的一种处理方案是 <code>RepublishMessageRecoverer</code>，失败后将消息投递到一个指定的，专门存放异常消息的队列，后续由人工集中处理。</p>
<p>1、在 <code>consumer</code> 服务中定义处理失败消息的交换机和队列</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> DirectExchange <span class="title function_">errorMessageExchange</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DirectExchange</span>(<span class="string">&quot;error.direct&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> Queue <span class="title function_">errorQueue</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(<span class="string">&quot;error.queue&quot;</span>, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> Binding <span class="title function_">errorBinding</span><span class="params">(Queue errorQueue, DirectExchange errorMessageExchange)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> BindingBuilder.bind(errorQueue).to(errorMessageExchange).with(<span class="string">&quot;error&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2、定义一个 RepublishMessageRecoverer，关联队列和交换机</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> MessageRecoverer <span class="title function_">republishMessageRecoverer</span><span class="params">(RabbitTemplate rabbitTemplate)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RepublishMessageRecoverer</span>(rabbitTemplate, <span class="string">&quot;error.direct&quot;</span>, <span class="string">&quot;error&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>完整代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.muyoukule.consumer.config;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConditionalOnProperty(name = &quot;spring.rabbitmq.listener.simple.retry.enabled&quot;, havingValue = &quot;true&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ErrorMessageConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> DirectExchange <span class="title function_">errorMessageExchange</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DirectExchange</span>(<span class="string">&quot;error.direct&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">errorQueue</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(<span class="string">&quot;error.queue&quot;</span>, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">errorBinding</span><span class="params">(Queue errorQueue, DirectExchange errorMessageExchange)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(errorQueue).to(errorMessageExchange).with(<span class="string">&quot;error&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> MessageRecoverer <span class="title function_">republishMessageRecoverer</span><span class="params">(RabbitTemplate rabbitTemplate)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RepublishMessageRecoverer</span>(rabbitTemplate, <span class="string">&quot;error.direct&quot;</span>, <span class="string">&quot;error&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>再次运行后，去 <code>error.queue</code> 点击 <code>Get Message</code> 查看：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/MQIMG/RabbitMQ/error.queue%E4%B8%AD%E7%9A%84%E9%94%99%E8%AF%AF%E4%BF%A1%E6%81%AF.png" alt="error.queue中的错误信息"></p>
<h2 id="2-4-业务幂等性"><a href="#2-4-业务幂等性" class="headerlink" title="2.4 业务幂等性"></a>2.4 业务幂等性</h2><p>何为幂等性？</p>
<p><strong>幂等</strong>是一个数学概念，用函数表达式来描述是这样的：<code>f(x) = f(f(x))</code>，例如求绝对值函数。</p>
<p>在程序开发中，则是指同一个业务，执行一次或多次对业务状态的影响是一致的。例如：</p>
<ul>
<li>根据id删除数据</li>
<li>查询数据</li>
<li>新增数据</li>
</ul>
<p>但数据的更新往往不是幂等的，如果重复执行可能造成不一样的后果。比如：</p>
<ul>
<li>取消订单，恢复库存的业务。如果多次恢复就会出现库存重复增加的情况</li>
<li>退款业务。重复退款对商家而言会有经济损失。</li>
</ul>
<p>所以，我们要尽可能避免业务被重复执行。</p>
<p>然而在实际业务场景中，由于意外经常会出现业务被重复执行的情况，例如：</p>
<ul>
<li>页面卡顿时频繁刷新导致表单重复提交</li>
<li>服务间调用的重试</li>
<li>MQ消息的重复投递</li>
</ul>
<p>我们在用户支付成功后会发送MQ消息到交易服务，修改订单状态为已支付，就可能出现消息重复投递的情况。如果消费者不做判断，很有可能导致消息被消费多次，出现业务故障。</p>
<p>举例：</p>
<ul>
<li>假如用户刚刚支付完成，并且投递消息到交易服务，交易服务更改订单为<strong>已支付</strong>状态。</li>
<li>由于某种原因，例如网络故障导致生产者没有得到确认，隔了一段时间后<strong>重新投递</strong>给交易服务。</li>
<li>但是，在新投递的消息被消费之前，用户选择了退款，将订单状态改为了<strong>已退款</strong>状态。</li>
<li>退款完成后，新投递的消息才被消费，那么订单状态会被再次改为<strong>已支付</strong>。业务异常。</li>
</ul>
<p>因此，我们必须想办法保证消息处理的幂等性。这里给出两种方案：</p>
<ul>
<li>唯一消息ID</li>
<li>业务状态判断</li>
</ul>
<h3 id="2-4-1-唯一消息ID"><a href="#2-4-1-唯一消息ID" class="headerlink" title="2.4.1 唯一消息ID"></a>2.4.1 唯一消息ID</h3><p>这个思路非常简单：</p>
<ol>
<li>每一条消息都生成一个唯一的id，与消息一起投递给消费者</li>
<li>消费者接收到消息后处理自己的业务，业务处理成功后将消息ID保存到数据库</li>
<li>如果下次又收到相同消息，去数据库查询判断是否存在，存在则为重复消息放弃处理</li>
</ol>
<p>我们该如何给消息添加唯一ID呢？</p>
<p>其实很简单，SpringAMQP的 MessageConverter 自带了 MessageID 的功能，我们只要开启这个功能即可。</p>
<p>以 Jackson 的消息转换器为例：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> MessageConverter <span class="title function_">messageConverter</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="comment">// 1.定义消息转换器</span></span><br><span class="line">    <span class="type">Jackson2JsonMessageConverter</span> <span class="variable">jjmc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Jackson2JsonMessageConverter</span>();</span><br><span class="line">    <span class="comment">// 2.配置自动创建消息id，用于识别不同消息，也可以在业务中基于ID判断是否是重复消息</span></span><br><span class="line">    jjmc.setCreateMessageIds(<span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">return</span> jjmc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-4-2-业务判断"><a href="#2-4-2-业务判断" class="headerlink" title="2.4.2 业务判断"></a>2.4.2 业务判断</h3><p>业务判断就是基于业务本身的逻辑或状态来判断是否是重复的请求或消息，不同的业务场景判断的思路也不一样。</p>
<p>例如我们当前案例中，处理消息的业务逻辑是把订单状态从未支付修改为已支付。因此我们就可以在执行业务时判断订单状态是否是未支付，如果不是则证明订单已经被处理过，无需重复处理。</p>
<p>相比较而言，消息ID的方案需要改造原有的数据库，所以我更推荐使用业务判断的方案。</p>
<p>以支付修改订单的业务为例，我们需要修改 <code>OrderServiceImpl</code> 中的 <code>markOrderPaySuccess</code> 方法：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">markOrderPaySuccess</span><span class="params">(Long orderId)</span> &#123;</span><br><span class="line">    <span class="comment">// 1.查询订单</span></span><br><span class="line">    <span class="type">Order</span> <span class="variable">old</span> <span class="operator">=</span> getById(orderId);</span><br><span class="line">    <span class="comment">// 2.判断订单状态</span></span><br><span class="line">    <span class="keyword">if</span> (old == <span class="literal">null</span> || old.getStatus() != <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">// 订单不存在或者订单状态不是1，放弃处理</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 3.尝试更新订单</span></span><br><span class="line">    <span class="type">Order</span> <span class="variable">order</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Order</span>();</span><br><span class="line">    order.setId(orderId);</span><br><span class="line">    order.setStatus(<span class="number">2</span>);</span><br><span class="line">    order.setPayTime(LocalDateTime.now());</span><br><span class="line">    updateById(order);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上述代码逻辑上符合了幂等判断的需求，但是由于判断和更新是两步动作，因此在极小概率下可能存在线程安全问题。</p>
<p>我们可以合并上述操作为这样：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">markOrderPaySuccess</span><span class="params">(Long orderId)</span> &#123;</span><br><span class="line">    <span class="comment">// UPDATE `order` SET status = ? , pay_time = ? WHERE id = ? AND status = 1</span></span><br><span class="line">    lambdaUpdate()</span><br><span class="line">            .set(Order::getStatus, <span class="number">2</span>)</span><br><span class="line">            .set(Order::getPayTime, LocalDateTime.now())</span><br><span class="line">            .eq(Order::getId, orderId)</span><br><span class="line">            .eq(Order::getStatus, <span class="number">1</span>)</span><br><span class="line">            .update();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意看，上述代码等同于这样的 SQL 语句：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> `<span class="keyword">order</span>` <span class="keyword">SET</span> status <span class="operator">=</span> ? , pay_time <span class="operator">=</span> ? <span class="keyword">WHERE</span> id <span class="operator">=</span> ? <span class="keyword">AND</span> status <span class="operator">=</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>我们在 where 条件中除了判断 id 以外，还加上了 status 必须为1的条件。如果条件不符(说明订单已支付)，则 SQL 匹配不到数据，根本不会执行。</p>
<h2 id="2-5-兜底方案"><a href="#2-5-兜底方案" class="headerlink" title="2.5 兜底方案"></a>2.5 兜底方案</h2><p>虽然我们利用各种机制尽可能增加了消息的可靠性，但也不好说能保证消息 100% 的可靠。万一真的 MQ 通知失败该怎么办呢？<br>有没有其它兜底方案，能够确保订单的支付状态一致呢？</p>
<p>其实思想很简单：既然 MQ 通知不一定发送到交易服务，那么交易服务就必须自己<strong>主动去查询</strong>支付状态。这样即便支付服务的 MQ 通知失败，我们依然能通过主动查询来保证订单状态的一致。</p>
<p>流程如下：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/MQIMG/RabbitMQ/%E6%9C%8D%E5%8A%A1%E6%B5%81%E7%A8%8B.png" alt="服务流程" style="zoom: 50%;">

<p>图中黄色线圈起来的部分就是 MQ 通知失败后的兜底处理方案，由交易服务自己主动去查询支付状态。</p>
<p>不过需要注意的是，交易服务并不知道用户会在什么时候支付，如果查询的时机不正确(比如查询的时候用户正在支付中)，可能查询到的支付状态也不正确。</p>
<p>那么问题来了，我们到底该在什么时间主动查询支付状态呢？</p>
<p>这个时间是无法确定的，因此，通常我们采取的措施就是利用<strong>定时任务</strong>定期查询，例如每隔20秒就查询一次，并判断支付状态。如果发现订单已经支付，则立刻更新订单状态为已支付即可。定时任务具体的实现这里就不再赘述了😏</p>
<p>至此，消息可靠性的问题已经解决了。</p>
<p>综上，支付服务与交易服务之间的订单状态一致性是如何保证的？</p>
<ul>
<li>首先，支付服务会正在用户支付成功以后利用 MQ 消息通知交易服务，完成订单状态同步。</li>
<li>其次，为了保证MQ消息的可靠性，我们采用了生产者确认机制、消费者确认、消费者失败重试等策略，确保消息投递的可靠性</li>
<li>最后，我们还在交易服务设置了定时任务，定期查询订单支付状态。这样即便 MQ 通知失败，还可以利用定时任务作为兜底方案，确保订单支付状态的最终一致性。</li>
</ul>
<h1 id="4-延迟消息"><a href="#4-延迟消息" class="headerlink" title="4. 延迟消息"></a>4. 延迟消息</h1><p>在电商的支付业务中，对于一些库存有限的商品，为了更好的用户体验，通常都会在用户下单时立刻扣减商品库存。例如电影院购票、高铁购票，下单后就会锁定座位资源，其他人无法重复购买。</p>
<p>但是这样就存在一个问题，假如用户下单后一直不付款，就会一直占有库存资源，导致其他客户无法正常交易，最终导致商户利益受损！</p>
<p>因此，电商中通常的做法就是：<strong>对于超过一定时间未支付的订单，应该立刻取消订单并释放占用的库存</strong>。</p>
<p>例如，订单支付超时时间为30分钟，则我们应该在用户下单后的第30分钟检查订单支付状态，如果发现未支付，应该立刻取消订单，释放库存。</p>
<p>但问题来了：如何才能准确的实现在下单后第30分钟去检查支付状态呢？</p>
<p>像这种在一段时间以后才执行的任务，我们称之为<strong>延迟任务</strong>，而要实现延迟任务，最简单的方案就是利用 MQ 的延迟消息了。</p>
<p>在 RabbitMQ 中实现延迟消息也有两种方案：</p>
<ul>
<li>死信交换机+TTL</li>
<li>延迟消息插件</li>
</ul>
<p>这一章我们就一起研究下这两种方案的实现方式，以及优缺点。</p>
<h2 id="4-1-死信交换机和延迟消息"><a href="#4-1-死信交换机和延迟消息" class="headerlink" title="4.1 死信交换机和延迟消息"></a>4.1 死信交换机和延迟消息</h2><p>首先我们来学习一下基于死信交换机的延迟消息方案。</p>
<h3 id="4-1-1-死信交换机"><a href="#4-1-1-死信交换机" class="headerlink" title="4.1.1 死信交换机"></a>4.1.1 死信交换机</h3><p>什么是死信？</p>
<p>当一个队列中的消息满足下列情况之一时，可以成为死信(dead letter)：</p>
<ul>
<li>消费者使用 <code>basic.reject</code> 或  <code>basic.nack </code>声明消费失败，并且消息的 <code>requeue</code> 参数设置为 false</li>
<li>消息是一个过期消息，超时无人消费</li>
<li>要投递的队列消息满了，无法投递</li>
</ul>
<p>如果一个队列中的消息已经成为死信，并且这个队列通过 <code>dead-letter-exchange</code> 属性指定了一个交换机，那么队列中的死信就会投递到这个交换机中，而这个交换机就称为 <strong>死信交换机</strong>(Dead Letter Exchange)。而此时加入有队列与死信交换机绑定，则最终死信就会被投递到这个队列中。</p>
<p>死信交换机有什么作用呢？</p>
<ul>
<li>收集那些因处理失败而被拒绝的消息</li>
<li>收集那些因队列满了而被拒绝的消息</li>
<li>收集因TTL(有效期)到期的消息</li>
</ul>
<h3 id="4-1-2-延迟消息"><a href="#4-1-2-延迟消息" class="headerlink" title="4.1.2 延迟消息"></a>4.1.2 延迟消息</h3><p>前面两种作用场景可以看做是把死信交换机当做一种消息处理的最终兜底方案，与消费者重试时讲的 <code>RepublishMessageRecoverer</code> 作用类似。</p>
<p>而最后一种场景，大家设想一下这样的场景：</p>
<p>如图，有一组绑定的交换机 <code>ttl.fanout</code> 和队列 <code>ttl.queue</code>。但是 <code>ttl.queue</code> 没有消费者监听，而是设定了死信交换机<code>hmall.direct</code>，而队列 <code>direct.queue1 </code> 则与死信交换机绑定，<code>RoutingKey</code> 是 <code>blue</code>：<br><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/MQIMG/RabbitMQ/%E5%9C%BA%E6%99%AF.png" alt="场景"></p>
<p>假如我们现在发送一条消息到 <code>ttl.fanout</code>，<code>RoutingKey</code> 为 <code>blue</code>，并设置消息的<strong>有效期</strong>为 5000 毫秒：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/MQIMG/RabbitMQ/%E5%8F%91%E9%80%81%E4%B8%80%E6%9D%A1%E6%B6%88%E6%81%AF%E5%88%B0ttl.fanout.png" alt="发送一条消息到ttl.fanout"></p>
<p><strong>注意</strong>：尽管这里的 <code>ttl.fanout</code> 不需要 <code>RoutingKey</code>，但是当消息变为死信并投递到死信交换机时，会沿用之前的 <code>RoutingKey</code>，这样 <code>hmall.direct </code>才能正确路由消息。</p>
<p>消息肯定会被投递到 <code>ttl.queue</code> 之后，由于没有消费者，因此消息无人消费。5秒之后，消息的有效期到期，成为死信：<br><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/MQIMG/RabbitMQ/5%E7%A7%92%E5%90%8E%E6%B6%88%E6%81%AF%E6%88%90%E4%B8%BA%E6%AD%BB%E4%BF%A1.png" alt="5秒后消息成为死信"><br>死信被再次投递到死信交换机 <code>hmall.direct</code>，并沿用之前的 <code>RoutingKey</code>，也就是 <code>blue</code>：<br><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/MQIMG/RabbitMQ/%E6%AD%BB%E4%BF%A1%E8%A2%AB%E5%86%8D%E6%AC%A1%E6%8A%95%E9%80%92%E5%88%B0%E6%AD%BB%E4%BF%A1%E4%BA%A4%E6%8D%A2%E6%9C%BAhmall.direct.png" alt="死信被再次投递到死信交换机hmall.direct"></p>
<p>由于 <code>direct.queue1</code> 与 <code>hmall.direct</code> 绑定的 <code>key</code> 是 <code>blue</code>，因此最终消息被成功路由到 <code>direct.queue1</code>，如果此时有消费者与<code>direct.queue1</code> 绑定， 也就能成功消费消息了。但此时已经是5秒钟以后了：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/MQIMG/RabbitMQ/5%E7%A7%92%E9%92%9F%E4%BB%A5%E5%90%8E%E6%B6%88%E8%B4%B9%E6%B6%88%E6%81%AF.png" alt="5秒钟以后消费消息"><br>也就是说，publisher 发送了一条消息，但最终 consumer 在5秒后才收到消息。我们成功实现了<strong>延迟消息</strong>。</p>
<blockquote>
<p>总结</p>
</blockquote>
<p>RabbitMQ 的消息过期是基于追溯方式来实现的，也就是说当一个消息的 TTL 到期以后不一定会被移除或投递到死信交换机，而是在消息恰好处于队首时才会被处理。</p>
<p>当队列中消息堆积很多的时候，过期消息可能不会被按时处理，因此你设置的 TTL 时间不一定准确。</p>
<h2 id="4-2-DelayExchange插件"><a href="#4-2-DelayExchange插件" class="headerlink" title="4.2.DelayExchange插件"></a>4.2.DelayExchange插件</h2><p>基于死信队列虽然可以实现延迟消息，但是太麻烦了。因此 RabbitMQ 社区提供了一个延迟消息插件来实现相同的效果。</p>
<p>官方文档说明：<a href="https://blog.rabbitmq.com/posts/2015/04/scheduling-messages-with-rabbitmq">https://blog.rabbitmq.com/posts/2015/04/scheduling-messages-with-rabbitmq</a></p>
<h3 id="4-2-1-下载"><a href="#4-2-1-下载" class="headerlink" title="4.2.1.下载"></a>4.2.1.下载</h3><p>插件下载地址：<a href="https://github.com/rabbitmq/rabbitmq-delayed-message-exchange">https://github.com/rabbitmq/rabbitmq-delayed-message-exchange</a></p>
<p>由于我们安装的MQ是 <code>3.8</code> 版本，因此这里下载 <code>3.8.17</code> 版本：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/MQIMG/RabbitMQ/DelayExchange%E6%8F%92%E4%BB%B6v3.8.17.png" alt="DelayExchange插件v3.8.17"></p>
<h3 id="4-2-2-安装"><a href="#4-2-2-安装" class="headerlink" title="4.2.2.安装"></a>4.2.2.安装</h3><p>因为我们是基于 Docker 安装，所以需要先查看 RabbitMQ 的插件目录对应的数据卷。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker volume inspect mq-plugins</span><br></pre></td></tr></table></figure>
<p>结果如下：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;CreatedAt&quot;: &quot;2024-06-19T09:22:59+08:00&quot;,</span><br><span class="line">        &quot;Driver&quot;: &quot;local&quot;,</span><br><span class="line">        &quot;Labels&quot;: null,</span><br><span class="line">        &quot;Mountpoint&quot;: &quot;/var/lib/docker/volumes/mq-plugins/_data&quot;,</span><br><span class="line">        &quot;Name&quot;: &quot;mq-plugins&quot;,</span><br><span class="line">        &quot;Options&quot;: null,</span><br><span class="line">        &quot;Scope&quot;: &quot;local&quot;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>插件目录被挂载到了 <code>/var/lib/docker/volumes/mq-plugins/_data</code> 这个目录，我们上传插件到该目录下。</p>
<p>接下来执行命令，安装插件：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker exec -it mq rabbitmq-plugins enable rabbitmq_delayed_message_exchange</span><br></pre></td></tr></table></figure>
<p>运行结果如下：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/MQIMG/RabbitMQ/DelayExchange%E6%8F%92%E4%BB%B6%E5%AE%89%E8%A3%85%E7%BB%93%E6%9E%9C.png" alt="DelayExchange插件安装结果"></p>
<h3 id="4-2-3-声明延迟交换机"><a href="#4-2-3-声明延迟交换机" class="headerlink" title="4.2.3.声明延迟交换机"></a>4.2.3.声明延迟交换机</h3><p>基于注解方式：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RabbitListener(bindings = @QueueBinding(</span></span><br><span class="line"><span class="meta">        value = @Queue(name = &quot;delay.queue&quot;, durable = &quot;true&quot;),</span></span><br><span class="line"><span class="meta">        exchange = @Exchange(name = &quot;delay.direct&quot;, delayed = &quot;true&quot;),</span></span><br><span class="line"><span class="meta">        key = &quot;delay&quot;</span></span><br><span class="line"><span class="meta">))</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listenDelayMessage</span><span class="params">(String msg)</span>&#123;</span><br><span class="line">    log.info(<span class="string">&quot;接收到delay.queue的延迟消息：&#123;&#125;&quot;</span>, msg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>基于 <code>@Bean  </code> 的方式：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.muyoukule.consumer.config;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DelayExchangeConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> DirectExchange <span class="title function_">delayExchange</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> ExchangeBuilder</span><br><span class="line">                .directExchange(<span class="string">&quot;delay.direct&quot;</span>) <span class="comment">// 指定交换机类型和名称</span></span><br><span class="line">                .delayed() <span class="comment">// 设置delay的属性为true</span></span><br><span class="line">                .durable(<span class="literal">true</span>) <span class="comment">// 持久化</span></span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">delayedQueue</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(<span class="string">&quot;delay.queue&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">delayQueueBinding</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(delayedQueue()).to(delayExchange()).with(<span class="string">&quot;delay&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-2-4-发送延迟消息"><a href="#4-2-4-发送延迟消息" class="headerlink" title="4.2.4.发送延迟消息"></a>4.2.4.发送延迟消息</h3><p>发送消息时，必须通过 <code>x-delay</code> 属性设定延迟时间：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testPublisherDelayMessage</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 1.创建消息</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">&quot;hello, delayed message&quot;</span>;</span><br><span class="line">    <span class="comment">// 2.发送消息，利用消息后置处理器添加消息头</span></span><br><span class="line">    rabbitTemplate.convertAndSend(<span class="string">&quot;delay.direct&quot;</span>, <span class="string">&quot;delay&quot;</span>, message, <span class="keyword">new</span> <span class="title class_">MessagePostProcessor</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Message <span class="title function_">postProcessMessage</span><span class="params">(Message message)</span> <span class="keyword">throws</span> AmqpException &#123;</span><br><span class="line">            <span class="comment">// 添加延迟消息属性</span></span><br><span class="line">            message.getMessageProperties().setDelay(<span class="number">5000</span>);</span><br><span class="line">            <span class="keyword">return</span> message;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注意：</strong></p>
<p>延迟消息插件内部会维护一个本地数据库表，同时使用 Elang Timers 功能实现计时。如果消息的延迟时间设置较长，可能会导致堆积的延迟消息非常多，会带来较大的 CPU 开销，同时延迟消息的时间会存在误差。</p>
<p>因此，<strong>不建议设置延迟时间过长的延迟消息</strong>。</p>
]]></content>
      <categories>
        <category>MQ</category>
      </categories>
      <tags>
        <tag>RabbitMQ</tag>
      </tags>
  </entry>
  <entry>
    <title>没有对象怎么办？——Java中创建对象的方法</title>
    <url>/posts/7459/</url>
    <content><![CDATA[<h1 id="0-前言"><a href="#0-前言" class="headerlink" title="0. 前言"></a>0. 前言</h1><p>还在为没有对象而彷徨吗？😧还在为没有对象而迷茫吗？😫还在为没有对象而自我怀疑吗？😭还在担心没有对象怎么办？</p>
<p>简单啊，自己 <code>new</code> 一个啊！！众所周知，程序员是<del>不需要</del>不缺对象的，特别是 JAVA 程序员😲。那除了直接使用 <code>new</code> 关键字创建对象，还有什么其他方法创建对象吗？当然有了。接下来就简单介绍几种创建对象的方法。还是单身的程序员们别怕啦！！😜马上就可以精心挑选一个自己满意的<del>对象</del>方法了🎉🎉🎉</p>
<p>假设我们已经有一个女朋友类：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GirlFriendFriend</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注解使用的是 Lombok 框架注解，方便快速开发。</p>
<h1 id="1-new-关键字"><a href="#1-new-关键字" class="headerlink" title="1.  new 关键字"></a>1.  new 关键字</h1><p>这是最常见的创建对象的方式，通过 <code>new</code> 关键字，Java 会在堆内存中为对象分配空间，并返回指向这个对象的引用。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">GirlFriend</span> <span class="variable">girl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GirlFriend</span>(<span class="string">&quot;小诗诗&quot;</span>, <span class="number">18</span>);</span><br><span class="line">        System.out.println(girl);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GirlFriend(name=小诗诗, age=18)</span><br></pre></td></tr></table></figure>

<h1 id="2-类派发-反射"><a href="#2-类派发-反射" class="headerlink" title="2.  类派发(反射)"></a>2.  类派发(反射)</h1><p>Class 的 <code>getDeclaredConstructor().newInstance()</code> 方法可以在运行时创建一个类的新实例。它等效于使用 <code>new</code> 操作符，但是语法更加动态。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">GirlFriend</span> <span class="variable">girlFriend</span> <span class="operator">=</span> GirlFriend.class.getDeclaredConstructor().newInstance();</span><br><span class="line">        girlFriend.setName(<span class="string">&quot;小诗诗&quot;</span>);</span><br><span class="line">        girlFriend.setAge(<span class="number">18</span>);</span><br><span class="line">        System.out.println(girlFriend);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GirlFriend&#123;name=&#x27;小诗诗&#x27;, age=18&#125;</span><br></pre></td></tr></table></figure>

<h1 id="3-构造器-反射"><a href="#3-构造器-反射" class="headerlink" title="3.  构造器(反射)"></a>3.  构造器(反射)</h1><p>Constructor 的 <code>newInstance()</code> 方法可以在运行时创建一个类的新实例，并且可以传入构造函数的参数。这种方式比 Class 的 <code>newInstance()</code> 方法更加灵活，因为可以选择不同的构造函数。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Constructor&lt;GirlFriend&gt; constructor = GirlFriend.class.getConstructor(String.class, Integer.class);</span><br><span class="line">        <span class="type">GirlFriend</span> <span class="variable">girlFriend</span> <span class="operator">=</span> constructor.newInstance(<span class="string">&quot;小诗诗&quot;</span>, <span class="number">18</span>);</span><br><span class="line">        System.out.println(girlFriend);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GirlFriend(name=小诗诗, age=18)</span><br></pre></td></tr></table></figure>

<h1 id="4-动态加载-反射"><a href="#4-动态加载-反射" class="headerlink" title="4. 动态加载(反射)"></a>4. 动态加载(反射)</h1><p>知道类全路径，使用 <code>Class.forName()</code> 获取类的 <code>Class</code> 对象，然后调用其 <code>newInstance()</code> 方法创建对象。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">GirlFriend</span> <span class="variable">girlFriend</span> <span class="operator">=</span> (GirlFriend) Class.forName(<span class="string">&quot;com.muyoukule.GirlFriend&quot;</span>)</span><br><span class="line">                .getDeclaredConstructor().newInstance();</span><br><span class="line">        girlFriend.setName(<span class="string">&quot;小诗诗&quot;</span>);</span><br><span class="line">        girlFriend.setAge(<span class="number">18</span>);</span><br><span class="line">        System.out.println(girlFriend);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GirlFriend(name=小诗诗, age=18)</span><br></pre></td></tr></table></figure>

<h1 id="5-clone-方法"><a href="#5-clone-方法" class="headerlink" title="5. clone()方法"></a>5. clone()方法</h1><p>如果一个类实现了 <code>Cloneable</code> 接口并重写了 <code>Object</code> 类中的 <code>clone()</code> 方法，那么可以通过调用已有对象的 <code>clone()</code> 方法来创建该对象的一个副本。</p>
<p><strong>PS：<code>clone()</code> 方法默认是受保护的，并且可能抛出 <code>CloneNotSupportedException</code> 异常。</strong>😅</p>
<p>因此如果要在类外部使用它，通常需要将其声明为公共的。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GirlFriend</span> <span class="keyword">implements</span> <span class="title class_">Cloneable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 访问权限为 public，并且返回值写为 girl</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> GirlFriend <span class="title function_">clone</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> (GirlFriend) <span class="built_in">super</span>.clone();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (CloneNotSupportedException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AssertionError</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">GirlFriend</span> <span class="variable">girlFriend1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GirlFriend</span>(<span class="string">&quot;小诗诗&quot;</span>, <span class="number">18</span>);</span><br><span class="line">        <span class="type">GirlFriend</span> <span class="variable">girlFriend2</span> <span class="operator">=</span> girlFriend1.clone();</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;girlFriend1===&gt;&quot;</span> + girlFriend1);</span><br><span class="line">        System.out.println(<span class="string">&quot;girlFriend2===&gt;&quot;</span> + girlFriend2);</span><br><span class="line">        System.out.println(girlFriend1 == girlFriend2); <span class="comment">//false</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">girlFriend1===&gt;GirlFriend(name=小诗诗, age=18)</span><br><span class="line">girlFriend2===&gt;GirlFriend(name=小诗诗, age=18)</span><br><span class="line">false</span><br></pre></td></tr></table></figure>

<h1 id="6-反序列化"><a href="#6-反序列化" class="headerlink" title="6. 反序列化"></a>6. 反序列化</h1><p>如果你有一个对象的序列化表示(例如一个文件或一个字节流)，你可以使用反序列化来重新创建该对象。这通常通过 <code>ObjectInputStream</code>类完成。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GirlFriend</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">GirlFriend</span> <span class="variable">girlFriend1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GirlFriend</span>(<span class="string">&quot;小诗诗&quot;</span>, <span class="number">18</span>);</span><br><span class="line">        <span class="type">Path</span> <span class="variable">path</span> <span class="operator">=</span> Paths.get(<span class="string">&quot;girlFriend.txt&quot;</span>);</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(Files.newOutputStream(path));</span><br><span class="line">        oos.writeObject(girlFriend1);</span><br><span class="line">        oos.close();</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(Files.newInputStream(path));</span><br><span class="line">        <span class="type">GirlFriend</span> <span class="variable">girlFriend2</span> <span class="operator">=</span> (GirlFriend) ois.readObject();</span><br><span class="line">        ois.close();</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;girlFriend1===&gt;&quot;</span> + girlFriend1);</span><br><span class="line">        System.out.println(<span class="string">&quot;girlFriend2===&gt;&quot;</span> + girlFriend2);</span><br><span class="line">        System.out.println(girlFriend1 == girlFriend2); <span class="comment">//false</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">girlFriend1===&gt;GirlFriend(name=小诗诗, age=18)</span><br><span class="line">girlFriend2===&gt;GirlFriend(name=小诗诗, age=18)</span><br><span class="line">false</span><br></pre></td></tr></table></figure>

<h1 id="7-工厂模式"><a href="#7-工厂模式" class="headerlink" title="7. 工厂模式"></a>7. 工厂模式</h1><p>工厂方法是一种设计模式，用于创建对象而不直接使用 <code>new</code> 关键字。工厂方法通常封装了对象的创建逻辑，并且可以根据不同的参数返回不同类型的对象。</p>
<p>1、定义一个 Girl 接口</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Girl</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2、让 GirlFriend 继承 Girl接口</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GirlFriend</span> <span class="keyword">implements</span> <span class="title class_">Girl</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3、创建一个 GirlFactory 工厂</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GirlFactory</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> Girl <span class="title function_">createGirl</span><span class="params">(String type)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (type == <span class="literal">null</span> || type.trim().length() == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">Girl</span> <span class="variable">girl</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;GirlFriend&quot;</span>.equals(type)) &#123;</span><br><span class="line">            girl = <span class="keyword">new</span> <span class="title class_">GirlFriend</span>(<span class="string">&quot;小诗诗&quot;</span>, <span class="number">18</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Unsupported type: &quot;</span> + type);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> girl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">GirlFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GirlFactory</span>();</span><br><span class="line">        <span class="type">GirlFriend</span> <span class="variable">girlFriend</span> <span class="operator">=</span> (GirlFriend) factory.createGirl(<span class="string">&quot;GirlFriend&quot;</span>);</span><br><span class="line">        System.out.println(girlFriend);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GirlFriend(name=小诗诗, age=18)</span><br></pre></td></tr></table></figure>

<h1 id="8-Builder模式"><a href="#8-Builder模式" class="headerlink" title="8. Builder模式"></a>8. Builder模式</h1><p>Builder 模式用于创建复杂的对象，允许用户以不同的方式构建对象。它通常涉及到一个 <code>Builder</code> 类，该类包含了一系列设置对象属性的方法，并最终返回一个构建好的对象。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GirlFriend</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">GirlFriend</span><span class="params">(Builder builder)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = builder.name;</span><br><span class="line">        <span class="built_in">this</span>.age = builder.age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Builder</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> String name;</span><br><span class="line">        <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> Builder <span class="title function_">withName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.name = name;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> Builder <span class="title function_">withAge</span><span class="params">(<span class="type">int</span> age)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.age = age;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> GirlFriend <span class="title function_">build</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">GirlFriend</span>(<span class="built_in">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">GirlFriend</span> <span class="variable">girlFriend</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GirlFriend</span>.Builder()</span><br><span class="line">                .withName(<span class="string">&quot;小诗诗&quot;</span>)</span><br><span class="line">                .withAge(<span class="number">18</span>)</span><br><span class="line">                .build();</span><br><span class="line">        System.out.println(girlFriend);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GirlFriend(name=小诗诗, age=18)</span><br></pre></td></tr></table></figure>

<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>没有对象不要彷徨、不要迷茫、不要自我怀疑。在上面的方法中精心挑选一个自己满意的方法去造对象吧！！😊</p>
<p>记住，没有对象就自己zao，以后别再说自己没对象了，Java 程序员从不说自己没对象！！！</p>
<p>仰起单身🐶高贵的头颅😬！！！！</p>
]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>RabbitMQ基础</title>
    <url>/posts/33842/</url>
    <content><![CDATA[<p>RabbitMQ官网：<a href="https://www.rabbitmq.com/">https://www.rabbitmq.com</a></p>
<p>参考视频：<a href="https://www.bilibili.com/video/BV1mN4y1Z7t9/">黑马程序员RabbitMQ入门到实战教程，MQ消息中间件，微服务rabbitmq消息队列实战，RabbitMQ面试题一套全覆盖</a></p>
<h1 id="0-写在前面"><a href="#0-写在前面" class="headerlink" title="0. 写在前面"></a>0. 写在前面</h1><p>微服务一旦拆分，必然涉及到服务之间的相互调用，目前我们服务之间调用采用的都是基于 OpenFeign 的调用。这种调用中，调用者发起请求后需要<strong>等待</strong>服务提供者执行业务返回结果后，才能继续执行后面的业务。也就是说调用者在调用过程中处于阻塞状态，因此我们成这种调用方式为<strong>同步调用</strong>，也可以叫<strong>同步通讯</strong>。但在很多场景下，我们可能需要采用<strong>异步通讯</strong>的方式，为什么呢？</p>
<p>我们先来看看什么是同步通讯和异步通讯。如图：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/MQIMG/RabbitMQ/%E5%90%8C%E6%AD%A5%E9%80%9A%E8%AE%AF%E5%92%8C%E5%BC%82%E6%AD%A5%E9%80%9A%E8%AE%AF.png" alt="同步通讯和异步通讯" style="zoom:50%;">

<p>解读：</p>
<ul>
<li>同步通讯：就如同打视频电话，双方的交互都是实时的。因此同一时刻你只能跟一个人打视频电话。</li>
<li>异步通讯：就如同发微信聊天，双方的交互不是实时的，你不需要立刻给对方回应。因此你可以多线操作，同时跟多人聊天。</li>
</ul>
<p>两种方式各有优劣，打电话可以立即得到响应，但是你却不能跟多个人同时通话。发微信可以同时与多个人收发微信，但是往往响应会有延迟。</p>
<p>所以，如果我们的业务需要实时得到服务提供方的响应，则应该选择同步通讯(同步调用)。而如果我们追求更高的效率，并且不需要实时响应，则应该选择异步通讯(异步调用)。</p>
<p> OpenFeign 调用就是同步调用的方式。但是：</p>
<ul>
<li>异步调用又该如何实现？</li>
<li>哪些业务适合用异步调用来实现呢？</li>
</ul>
<p>通过今天的学习你就能明白这些问题了。</p>
<h1 id="1-初识MQ"><a href="#1-初识MQ" class="headerlink" title="1. 初识MQ"></a>1. 初识MQ</h1><h2 id="1-1-同步调用"><a href="#1-1-同步调用" class="headerlink" title="1.1 同步调用"></a>1.1 同步调用</h2><p>我们基于 OpenFeign 的调用都属于是同步调用，那么这种方式存在哪些问题呢？</p>
<p>举个例子，以<strong>余额支付功能</strong>为例来分析，首先看下整个流程：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/MQIMG/RabbitMQ/%E4%BD%99%E9%A2%9D%E6%94%AF%E4%BB%98%E5%8A%9F%E8%83%BD%E6%B5%81%E7%A8%8B.png" alt="余额支付功能流程"></p>
<p>目前我们采用的是基于 OpenFeign 的同步调用，也就是说业务执行流程是这样的：</p>
<ol>
<li>支付服务需要先调用用户服务完成余额扣减</li>
<li>然后支付服务自己要更新支付流水单的状态</li>
<li>然后支付服务调用交易服务，更新业务订单状态为已支付</li>
</ol>
<p>这其中就存在3个问题：</p>
<p><strong>拓展性差</strong></p>
<p>我们目前的业务相对简单，但是随着业务规模扩大，产品的功能也在不断完善。</p>
<p>在大多数电商业务中，用户支付成功后都会以短信或者其它方式通知用户，告知支付成功。假如后期产品经理提出这样新的需求，你怎么办？是不是要在上述业务中再加入通知用户的业务？</p>
<p>某些电商项目中，还会有积分或金币的概念。假如产品经理提出需求，用户支付成功后，给用户以积分奖励或者返还金币，你怎么办？是不是要在上述业务中再加入积分业务、返还金币业务？</p>
<p>最终你的支付业务会越来越臃肿：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/MQIMG/RabbitMQ/%E6%94%AF%E4%BB%98%E4%B8%9A%E5%8A%A1.png" alt="支付业务" style="zoom: 50%;">

<p>也就是说每次有新的需求，现有支付逻辑都要跟着变化，代码经常变动，不符合开闭原则，拓展性不好。</p>
<p><strong>性能下降</strong></p>
<p>由于我们采用了同步调用，调用者需要等待服务提供者执行完返回结果后，才能继续向下执行，也就是说每次远程调用，调用者都是阻塞等待状态。最终整个业务的响应时长就是每次远程调用的执行时长之和：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/MQIMG/RabbitMQ/%E6%89%A7%E8%A1%8C%E6%97%B6%E9%95%BF.png" alt="执行时长" style="zoom: 50%;">

<p>假如每个微服务的执行时长都是 50ms，则最终整个业务的耗时可能高达 300ms，性能太差了。</p>
<p><strong>级联失败</strong></p>
<p>由于我们是基于 OpenFeign 调用交易服务、通知服务。当交易服务、通知服务出现故障时，整个事务都会回滚，交易失败。</p>
<p>这其实就是同步调用的<strong>级联失败</strong>问题。</p>
<p>但是大家思考一下，我们假设用户余额充足，扣款已经成功，此时我们应该确保支付流水单更新为已支付，确保交易成功。毕竟收到手里的钱没道理再退回去吧。😬</p>
<p>因此，这里不能因为短信通知、更新订单状态失败而回滚整个事务。</p>
<blockquote>
<p>总结</p>
</blockquote>
<p>综上，同步调用的方式存在下列问题：</p>
<ul>
<li>拓展性差</li>
<li>性能下降</li>
<li>级联失败</li>
</ul>
<p>而要解决这些问题，我们就必须用<strong>异步调用</strong>的方式来代替<strong>同步调用</strong>。</p>
<h2 id="1-2-异步调用"><a href="#1-2-异步调用" class="headerlink" title="1.2 异步调用"></a>1.2 异步调用</h2><p>异步调用方式其实就是基于消息通知的方式，一般包含三个角色：</p>
<ul>
<li>消息发送者：投递消息的人，就是原来的调用方</li>
<li>消息 Broker：管理、暂存、转发消息，你可以把它理解成微信服务器</li>
<li>消息接收者：接收和处理消息的人，就是原来的服务提供方</li>
</ul>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/MQIMG/RabbitMQ/%E5%BC%82%E6%AD%A5%E8%B0%83%E7%94%A8%E4%B8%89%E8%A7%92%E8%89%B2.png" alt="异步调用三角色"></p>
<p>在异步调用中，发送者不再直接同步调用接收者的业务接口，而是发送一条消息投递给消息Broker。然后接收者根据自己的需求从消息 Broker 那里订阅消息。每当发送方发送消息后，接受者都能获取消息并处理。</p>
<p>这样，发送消息的人和接收消息的人就完全解耦了。</p>
<p>还是以余额支付业务为例：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/MQIMG/RabbitMQ/%E4%BD%99%E9%A2%9D%E6%94%AF%E4%BB%98%E4%B8%9A%E5%8A%A1.png" alt="余额支付业务" style="zoom: 50%;">

<p>除了扣减余额、更新支付流水单状态以外，其它调用逻辑全部取消。而是改为发送一条消息到 Broker。而相关的微服务都可以订阅消息通知，一旦消息到达 Broker，则会分发给每一个订阅了的微服务，处理各自的业务。</p>
<p>假如产品经理提出了新的需求，比如要在支付成功后更新用户积分。支付代码完全不用变更，而仅仅是让积分服务也订阅消息即可：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/MQIMG/RabbitMQ/%E5%A2%9E%E5%8A%A0%E6%9B%B4%E6%96%B0%E7%94%A8%E6%88%B7%E7%A7%AF%E5%88%86.png" alt="增加更新用户积分" style="zoom:50%;">

<p>不管后期增加了多少消息订阅者，作为支付服务来讲，执行问扣减余额、更新支付流水状态后，发送消息即可。业务耗时仅仅是这三部分业务耗时，仅仅 100ms，大大提高了业务性能。</p>
<p>另外，不管是交易服务、通知服务，还是积分服务，他们的业务与支付关联度低。现在采用了异步调用，解除了耦合，他们即便执行过程中出现了故障，也不会影响到支付服务。</p>
<blockquote>
<p>总结</p>
</blockquote>
<p>综上，异步调用的优势包括</p>
<ul>
<li>耦合度更低</li>
<li>性能更好</li>
<li>业务拓展性强</li>
<li>故障隔离，避免级联失败</li>
</ul>
<p>当然，异步通信也并非完美无缺，它存在下列缺点：</p>
<ul>
<li>完全依赖于 Broker 的可靠性、安全性和性能</li>
<li>架构复杂，后期维护和调试麻烦</li>
</ul>
<h2 id="1-3-技术选型"><a href="#1-3-技术选型" class="headerlink" title="1.3 技术选型"></a>1.3 技术选型</h2><p>消息 Broker，目前常见的实现方案就是消息队列(MessageQueue)，简称为 MQ。</p>
<p>目比较常见的 MQ 实现对比：</p>
<table>
<thead>
<tr>
<th align="center"></th>
<th align="center"><strong>RabbitMQ</strong></th>
<th align="center"><strong>ActiveMQ</strong></th>
<th align="center"><strong>RocketMQ</strong></th>
<th align="center"><strong>Kafka</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="center">公司&#x2F;社区</td>
<td align="center">Rabbit</td>
<td align="center">Apache</td>
<td align="center">阿里</td>
<td align="center">Apache</td>
</tr>
<tr>
<td align="center">开发语言</td>
<td align="center">Erlang</td>
<td align="center">Java</td>
<td align="center">Java</td>
<td align="center">Scala&amp;Java</td>
</tr>
<tr>
<td align="center">协议支持</td>
<td align="center">AMQP，XMPP，SMTP，STOMP</td>
<td align="center">OpenWire,STOMP，REST,XMPP,AMQP</td>
<td align="center">自定义协议</td>
<td align="center">自定义协议</td>
</tr>
<tr>
<td align="center">可用性</td>
<td align="center">高</td>
<td align="center">一般</td>
<td align="center">高</td>
<td align="center">高</td>
</tr>
<tr>
<td align="center">单机吞吐量</td>
<td align="center">一般</td>
<td align="center">差</td>
<td align="center">高</td>
<td align="center">非常高</td>
</tr>
<tr>
<td align="center">消息延迟</td>
<td align="center">微秒级</td>
<td align="center">毫秒级</td>
<td align="center">毫秒级</td>
<td align="center">毫秒以内</td>
</tr>
<tr>
<td align="center">消息可靠性</td>
<td align="center">高</td>
<td align="center">一般</td>
<td align="center">高</td>
<td align="center">一般</td>
</tr>
</tbody></table>
<p>追求可用性：Kafka、 RocketMQ 、RabbitMQ</p>
<p>追求可靠性：RabbitMQ、RocketMQ</p>
<p>追求吞吐能力：RocketMQ、Kafka</p>
<p>追求消息低延迟：RabbitMQ、Kafka</p>
<p>据统计，目前国内消息队列使用最多的还是 RabbitMQ，其各方面都比较均衡，稳定性也好。</p>
<h1 id="2-RabbitMQ"><a href="#2-RabbitMQ" class="headerlink" title="2. RabbitMQ"></a>2. RabbitMQ</h1><p>RabbitMQ 是基于 Erlang 语言开发的开源消息通信中间件，官网地址：<a href="https://www.rabbitmq.com/">https://www.rabbitmq.com</a></p>
<h2 id="2-1-安装"><a href="#2-1-安装" class="headerlink" title="2.1 安装"></a>2.1 安装</h2><p>我们基于 Docker 来安装 RabbitMQ，使用下面的命令即可：</p>
<p>1、拉取镜像</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker pull rabbitmq:3.8-management</span><br></pre></td></tr></table></figure>

<p>2、创建并运行容器</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker run \</span><br><span class="line"> -e RABBITMQ_DEFAULT_USER=muyoukule \</span><br><span class="line"> -e RABBITMQ_DEFAULT_PASS=123456 \</span><br><span class="line"> -v mq-plugins:/plugins \</span><br><span class="line"> --name mq \</span><br><span class="line"> --hostname mq \</span><br><span class="line"> -p 15672:15672 \</span><br><span class="line"> -p 5672:5672 \</span><br><span class="line"> --network hmall \</span><br><span class="line"> -d \</span><br><span class="line"> rabbitmq:3.8-management</span><br></pre></td></tr></table></figure>

<p>可以看到在安装命令中有两个映射的端口：</p>
<ul>
<li>15672：RabbitMQ 提供的管理控制台的端口</li>
<li>5672：RabbitMQ 的消息发送处理接口</li>
</ul>
<p>安装完成后，我们访问 <code>http://YourIp:15672/</code> 即可看到管理控制台。首次访问需要登录，默认的用户名和密码在配置文件中已经指定了。</p>
<p>登录后即可看到管理控制台总览页面：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/MQIMG/RabbitMQ/RabbitMQ%E7%AE%A1%E7%90%86%E6%8E%A7%E5%88%B6%E5%8F%B0%E6%80%BB%E8%A7%88%E9%A1%B5%E9%9D%A2.png" alt="RabbitMQ管理控制台总览页面"></p>
<p>RabbitMQ 对应的架构如图：<br><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/MQIMG/RabbitMQ/RabbitMQ%E6%9E%B6%E6%9E%84%E5%A6%82%E5%9B%BE.png" alt="RabbitMQ架构如图"></p>
<p>其中包含几个概念：</p>
<ul>
<li><code>publisher</code>：生产者，也就是发送消息的一方</li>
<li><code>consumer</code>：消费者，也就是消费消息的一方</li>
<li><code>queue</code>：队列，存储消息。生产者投递的消息会暂存在消息队列中，等待消费者处理</li>
<li><code>exchange</code>：交换机，负责消息路由。生产者发送的消息由交换机决定投递到哪个队列。</li>
<li><code>virtual host</code>：虚拟主机，起到数据隔离的作用。每个虚拟主机相互独立，有各自的exchange、queue</li>
</ul>
<p>上述这些东西都可以在 RabbitMQ 的管理控制台来管理，下一节我们就一起来学习控制台的使用。</p>
<h2 id="2-2-收发消息"><a href="#2-2-收发消息" class="headerlink" title="2.2 收发消息"></a>2.2 收发消息</h2><h3 id="2-2-1-交换机"><a href="#2-2-1-交换机" class="headerlink" title="2.2.1 交换机"></a>2.2.1 交换机</h3><p>我们打开 <code>Exchanges</code> 选项卡，可以看到已经存在很多交换机：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/MQIMG/RabbitMQ/RabbitMQ%E9%BB%98%E8%AE%A4%E4%BA%A4%E6%8D%A2%E6%9C%BA.png" alt="RabbitMQ默认交换机" style="zoom:50%;">

<p>我们点击任意交换机，即可进入交换机详情页面。仍然会利用控制台中的 <code>publish message</code> 发送一条消息：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/MQIMG/RabbitMQ/RabbitMQ%E4%BA%A4%E6%8D%A2%E6%9C%BA%E8%AF%A6%E6%83%85%E9%A1%B5%E9%9D%A2.png" alt="RabbitMQ交换机详情页面"><br><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/MQIMG/RabbitMQ/RabbitMQ%E6%8E%A7%E5%88%B6%E5%8F%B0%E5%8F%91%E9%80%81%E6%B6%88%E6%81%AF.png" alt="RabbitMQ控制台发送消息" style="zoom:50%;"></p>
<p>点击后会提示<code>Message published, but not routed.</code>这里是由控制台模拟了生产者发送的消息。由于没有消费者存在，最终消息丢失了，这样说明交换机没有存储消息的能力。</p>
<h3 id="2-2-2-队列"><a href="#2-2-2-队列" class="headerlink" title="2.2.2 队列"></a>2.2.2 队列</h3><p>我们打开 <code>Queues</code> 选项卡，新建一个队列：<br><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/MQIMG/RabbitMQ/RabbitMQ%E6%96%B0%E5%BB%BA%E9%98%9F%E5%88%97.png" alt="RabbitMQ新建队列" style="zoom: 67%;"></p>
<p>命名为 <code>hello.queue1</code>：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/MQIMG/RabbitMQ/%E5%91%BD%E5%90%8D%E9%98%9F%E5%88%97%E4%B8%BAhello.queue1.png" alt="命名队列为hello.queue1" style="zoom: 67%;">

<p>再以相同的方式，创建一个队列，命名为 <code>hello.queue2</code>，最终队列列表如下：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/MQIMG/RabbitMQ/%E5%91%BD%E5%90%8D%E9%98%9F%E5%88%97%E4%B8%BAhello.queue2.png" alt="命名队列为hello.queue2" style="zoom:67%;">

<p>此时，我们再次向 <code>amq.fanout</code> 交换机发送一条消息。会发现消息依然没有到达队列！！</p>
<p>怎么回事呢？</p>
<p>发送到交换机的消息，只会路由到与其绑定的队列，因此仅仅创建队列是不够的，我们还需要将其与交换机绑定。</p>
<h3 id="2-2-3-绑定关系"><a href="#2-2-3-绑定关系" class="headerlink" title="2.2.3 绑定关系"></a>2.2.3 绑定关系</h3><p>点击 <code>Exchanges</code> 选项卡，点击 <code>amq.fanout</code> 交换机，进入交换机详情页，然后点击<code>Bindings</code>菜单，在表单中填写要绑定的队列名称：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/MQIMG/RabbitMQ/%E5%A1%AB%E5%86%99%E8%A6%81%E7%BB%91%E5%AE%9A%E7%9A%84%E9%98%9F%E5%88%97%E5%90%8D%E7%A7%B0.png" alt="填写要绑定的队列名称" style="zoom: 50%;">

<p>相同的方式，将 <code>hello.queue2</code> 也绑定到改交换机。</p>
<p>最终，绑定结果如下：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/MQIMG/RabbitMQ/%E4%BA%A4%E6%8D%A2%E6%9C%BA%E7%BB%91%E5%AE%9A%E7%BB%93%E6%9E%9C.png" alt="交换机绑定结果" style="zoom:67%;">

<h3 id="2-2-4-发送消息"><a href="#2-2-4-发送消息" class="headerlink" title="2.2.4 发送消息"></a>2.2.4 发送消息</h3><p>再次回到 <code>Exchange</code> 页面，找到刚刚绑定的 <code>amq.fanout</code>，点击进入详情页，再次发送一条消息：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/MQIMG/RabbitMQ/%E5%A1%AB%E5%86%99%E8%A6%81%E7%BB%91%E5%AE%9A%E7%9A%84%E9%98%9F%E5%88%97%E5%90%8D%E7%A7%B0.png" alt="填写要绑定的队列名称" style="zoom: 50%;">

<p>回到 <code>Queues</code> 页面，可以发现 <code>hello.queue</code> 中已经有一条消息了：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/MQIMG/RabbitMQ/hello.queue%E4%B8%AD%E5%B7%B2%E6%9C%89%E4%B8%80%E6%9D%A1%E6%B6%88%E6%81%AF.png" alt="hello.queue中已有一条消息" style="zoom:67%;">

<p>点击队列名称，进入详情页，查看队列详情，这次我们点击 <code>Get message</code>：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/MQIMG/RabbitMQ/%E7%82%B9%E5%87%BBgetmessage.png" alt="点击getmessage" style="zoom: 80%;">

<p>可以看到消息到达队列了：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/MQIMG/RabbitMQ/%E6%B6%88%E6%81%AF%E5%88%B0%E8%BE%BE%E9%98%9F%E5%88%97.png" alt="消息到达队列" style="zoom: 80%;">



<p>这个时候如果有消费者监听了 MQ 的 <code>hello.queue1</code> 或 <code>hello.queue2</code> 队列，自然就能接收到消息了。</p>
<p><strong>总结</strong></p>
<ul>
<li><p>交换机负责路由和转发消息，没有存储消息的能力</p>
</li>
<li><p>一旦队列与交换机绑定，每个队列都可以收到信息</p>
</li>
</ul>
<h2 id="2-3-数据隔离"><a href="#2-3-数据隔离" class="headerlink" title="2.3 数据隔离"></a>2.3 数据隔离</h2><h3 id="2-3-1-用户管理"><a href="#2-3-1-用户管理" class="headerlink" title="2.3.1 用户管理"></a>2.3.1 用户管理</h3><p>点击 <code>Admin</code> 选项卡，首先会看到 RabbitMQ 控制台的用户管理界面：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/MQIMG/RabbitMQ/RabbitMQ%E6%8E%A7%E5%88%B6%E5%8F%B0%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86%E7%95%8C%E9%9D%A2.png" alt="RabbitMQ控制台用户管理界面"></p>
<p>这里的用户都是 RabbitMQ 的管理或运维人员。目前只有安装 RabbitMQ 时添加的 <code>muyoukule</code> 这个用户。仔细观察用户表格中的字段，如下：</p>
<ul>
<li><code>Name</code>：<code>muyoukule</code>，也就是用户名</li>
<li><code>Tags</code>：<code>administrator</code>，说明 <code>muyoukule</code> 用户是超级管理员，拥有所有权限</li>
<li><code>Can access virtual host</code>： <code>/</code>，可以访问的<code>virtual host</code>，这里的 <code>/ </code>是默认的 <code>virtual host</code></li>
</ul>
<p>对于小型企业而言，出于成本考虑，我们通常只会搭建一套 MQ 集群，公司内的多个不同项目同时使用。这个时候为了避免互相干扰，我们会利用 <code>virtual host</code> 的隔离特性，将不同项目隔离。一般会做两件事情：</p>
<ul>
<li>给每个项目创建独立的运维账号，将管理权限分离。</li>
<li>给每个项目创建不同的 <code>virtual host</code> ，将每个项目的数据隔离。</li>
</ul>
<p>比如，我们给黑马商城创建一个新的用户，命名为 <code>hmall</code> ,密码为  <code>123</code> ：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/MQIMG/RabbitMQ/%E5%88%9B%E5%BB%BA%E6%96%B0%E7%94%A8%E6%88%B7hmall-1711859231732-4.png" alt="创建新用户hmall"></p>
<p>你会发现此时 hmall 用户没有任何 <code>virtual host</code> 的访问权限：<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/MQIMG/RabbitMQ/hmall%E6%97%A0%E8%AE%BF%E9%97%AE%E6%9D%83%E9%99%90.png" alt="hmall无访问权限"></p>
<p>别急，接下来我们就来授权。</p>
<h3 id="2-3-2-virtual-host"><a href="#2-3-2-virtual-host" class="headerlink" title="2.3.2 virtual host"></a>2.3.2 virtual host</h3><p>我们先退出登录：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/MQIMG/RabbitMQ/%E9%80%80%E5%87%BA%E7%99%BB%E5%BD%95.png" alt="退出登录"></p>
<p>切换到刚刚创建的 hmall 用户登录，然后点击 <code>Virtual Hosts</code> 菜单，进入 <code>virtual host</code> 管理页：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/MQIMG/RabbitMQ/%E8%BF%9B%E5%85%A5virtual%20host%E7%AE%A1%E7%90%86%E9%A1%B5.png" alt="进入virtual host管理页"></p>
<p>可以看到目前只有一个默认的 <code>virtual host</code>，名字为 <code>/</code>。</p>
<p> 我们可以给黑马商城项目创建一个单独的 <code>virtual host</code>，而不是使用默认的<code>/</code>。<font color="red">PS：注意 hmall 前面有个 <code>/</code> </font></p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/MQIMG/RabbitMQ/%E5%88%9B%E5%BB%BA%E5%8D%95%E7%8B%AC%E7%9A%84virtual%20host.png" alt="创建单独的virtual host"></p>
<p>创建完成后如图：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/MQIMG/RabbitMQ/%E5%88%9B%E5%BB%BA%E5%8D%95%E7%8B%AC%E7%9A%84virtual%20host%E5%AE%8C%E6%88%90.png" alt="创建单独的virtual host完成"></p>
<p>由于我们是登录 <code>hmall</code> 账户后创建的 <code>virtual host</code>，因此回到 <code>users</code> 菜单，你会发现当前用户已经具备了对 <code>/hmall</code> 这个<code>virtual host</code> 的访问权限了：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/MQIMG/RabbitMQ/%E5%85%B7%E5%A4%87%E8%AE%BF%E9%97%AE%E6%9D%83%E9%99%90.png" alt="具备访问权限"></p>
<p>此时，点击页面右上角的 <code>virtual host</code> 下拉菜单，切换 <code>virtual host</code> 为  <code>/hmall</code>：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/MQIMG/RabbitMQ/%E5%88%87%E6%8D%A2virtual%20host.png" alt="切换virtual host"></p>
<p>然后再次查看 <code>Queues</code> 选项卡，会发现之前的队列已经看不到了：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/MQIMG/RabbitMQ/%E9%98%9F%E5%88%97%E5%88%97%E8%A1%A8.png" alt="队列列表"></p>
<p>这就是基于<code>virtual host </code>的隔离效果。</p>
<h1 id="3-SpringAMQP"><a href="#3-SpringAMQP" class="headerlink" title="3. SpringAMQP"></a>3. SpringAMQP</h1><p>将来我们开发业务功能的时候，肯定不会在控制台收发消息，而是应该基于编程的方式。由于<code>RabbitMQ</code>采用了AMQP协议，因此它具备跨语言的特性。任何语言只要遵循 AMQP 协议收发消息，都可以与 RabbitMQ 交互。并且 RabbitMQ 官方也提供了各种不同语言的客户端。</p>
<p>但是，RabbitMQ 官方提供的 Java 客户端编码相对复杂，一般生产环境下我们更多会结合 Spring 来使用。而 Spring 的官方刚好基于RabbitMQ 提供了这样一套消息收发的模板工具：SpringAMQP。并且还基于 SpringBoot 对其实现了自动装配，使用起来非常方便。</p>
<p>SpringAMQP 的官方地址：<a href="https://spring.io/projects/spring-amqp/">https://spring.io/projects/spring-amqp/</a></p>
<p>SpringAMQP 提供了三个功能：</p>
<ul>
<li>自动声明队列、交换机及其绑定关系</li>
<li>基于注解的监听器模式，异步接收消息</li>
<li>封装了RabbitTemplate工具，用于发送消息</li>
</ul>
<p>这一章我们就一起学习一下，如何利用 SpringAMQP 实现对 RabbitMQ 的消息收发。</p>
<h2 id="3-1-导入Demo工程"><a href="#3-1-导入Demo工程" class="headerlink" title="3.1 导入Demo工程"></a>3.1 导入Demo工程</h2><p>项目结构如图：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/MQIMG/RabbitMQ/Demo%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84.png" alt="Demo项目结构"></p>
<p>包括三部分：</p>
<ul>
<li>mq-demo：父工程，管理项目依赖</li>
<li>publisher：消息的发送者</li>
<li>consumer：消息的消费者</li>
</ul>
<p>在 <code>mq-demo</code> 这个父工程中，已经配置好了 SpringAMQP 相关的依赖：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.itcast.demo<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mq-demo<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modules</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">module</span>&gt;</span>publisher<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">module</span>&gt;</span>consumer<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">modules</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.12<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--AMQP依赖，包含RabbitMQ--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--单元测试--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>因此，子工程中就可以直接使用 SpringAMQP 了。</p>
<h2 id="3-2-快速入门"><a href="#3-2-快速入门" class="headerlink" title="3.2 快速入门"></a>3.2 快速入门</h2><p>在之前的案例中，我们都是经过交换机发送消息到队列，不过有时候为了测试方便，我们也可以直接向队列发送消息，跳过交换机。</p>
<p>在入门案例中，我们就演示这样的简单模型，如图：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/MQIMG/RabbitMQ/MQ%E7%AE%80%E5%8D%95%E6%A8%A1%E5%9E%8B.jpeg" alt="MQ简单模型"></p>
<p>也就是：</p>
<ul>
<li>publisher直接发送消息到队列</li>
<li>消费者监听并处理队列中的消息</li>
</ul>
<p>注意：这种模式一般测试使用，很少在生产中使用。</p>
<p>为了方便测试，我们现在控制台新建一个队列：<code>simple.queue</code></p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/MQIMG/RabbitMQ/%E6%96%B0%E5%BB%BA%E9%98%9F%E5%88%97simple.queue.png" alt="新建队列simple.queue" style="zoom:67%;">

<p>添加成功：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/MQIMG/RabbitMQ/%E9%98%9F%E5%88%97simple.queue.png" alt="队列simple.queue"></p>
<p>接下来，我们就可以利用 Java 代码收发消息了。</p>
<h3 id="3-1-1-消息发送"><a href="#3-1-1-消息发送" class="headerlink" title="3.1.1 消息发送"></a>3.1.1 消息发送</h3><p>首先配置 MQ 地址，在 <code>publisher</code> 服务的 <code>application.yml</code> 中添加配置：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.88</span><span class="number">.132</span> <span class="comment"># 你的虚拟机IP</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span> <span class="comment"># 端口</span></span><br><span class="line">    <span class="attr">virtual-host:</span> <span class="string">/hmall</span> <span class="comment"># 虚拟主机</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">hmall</span> <span class="comment"># 用户名</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123</span> <span class="comment"># 密码</span></span><br></pre></td></tr></table></figure>

<p>然后在 <code>publisher</code> 服务中编写测试类 <code>SpringAmqpTest</code>，并利用 <code>RabbitTemplate</code> 实现消息发送：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.muyoukule.publisher.amqp;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringAmqpTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSimpleQueue</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 队列名称</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">queueName</span> <span class="operator">=</span> <span class="string">&quot;simple.queue&quot;</span>;</span><br><span class="line">        <span class="comment">// 消息</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">&quot;hello, spring amqp!&quot;</span>;</span><br><span class="line">        <span class="comment">// 发送消息</span></span><br><span class="line">        rabbitTemplate.convertAndSend(queueName, message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>打开控制台，可以看到消息已经发送到队列中：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/MQIMG/RabbitMQ/%E6%B6%88%E6%81%AF%E5%B7%B2%E7%BB%8F%E5%8F%91%E9%80%81%E5%88%B0%E9%98%9F%E5%88%97.png" alt="消息已经发送到队列"></p>
<h3 id="3-1-2-消息接收"><a href="#3-1-2-消息接收" class="headerlink" title="3.1.2 消息接收"></a>3.1.2 消息接收</h3><p>首先配置 MQ 地址，在 <code>consumer</code> 服务的 <code>application.yml</code> 中添加配置：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.88</span><span class="number">.132</span> <span class="comment"># 你的虚拟机IP</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span> <span class="comment"># 端口</span></span><br><span class="line">    <span class="attr">virtual-host:</span> <span class="string">/hmall</span> <span class="comment"># 虚拟主机</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">hmall</span> <span class="comment"># 用户名</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123</span> <span class="comment"># 密码</span></span><br></pre></td></tr></table></figure>

<p>然后在 <code>consumer</code> 服务的 <code>com.muyoukule.consumer.listener</code> 包中新建一个类 <code>SpringRabbitListener</code>，代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.muyoukule.consumer.listener;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringRabbitListener</span> &#123;</span><br><span class="line">	<span class="comment">// 利用RabbitListener来声明要监听的队列信息</span></span><br><span class="line">    <span class="comment">// 将来一旦监听的队列中有了消息，就会推送给当前服务，调用当前方法，处理消息。</span></span><br><span class="line">    <span class="comment">// 可以看到方法体中接收的就是消息体的内容</span></span><br><span class="line">    <span class="meta">@RabbitListener(queues = &quot;simple.queue&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listenSimpleQueueMessage</span><span class="params">(String msg)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;spring 消费者接收到消息：【&quot;</span> + msg + <span class="string">&quot;】&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>测试</p>
</blockquote>
<p>启动 <code>consumer</code> 服务，然后在 <code>publisher</code> 服务中运行测试代码，发送 MQ 消息。最终 <code>consumer</code> 收到消息：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">spring 消费者接收到消息：【hello, spring amqp!】</span><br></pre></td></tr></table></figure>

<h2 id="3-3-WorkQueues模型"><a href="#3-3-WorkQueues模型" class="headerlink" title="3.3 WorkQueues模型"></a>3.3 WorkQueues模型</h2><p>Work queues，任务模型。简单来说就是<strong>让多个消费者绑定到一个队列，共同消费队列中的消息</strong>。</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/MQIMG/RabbitMQ/WorkQueues%E6%A8%A1%E5%9E%8B.png" alt="WorkQueues模型"></p>
<p>当消息处理比较耗时的时候，可能生产消息的速度会远远大于消息的消费速度。长此以往，消息就会堆积越来越多，无法及时处理。</p>
<p>此时就可以使用 work 模型，<strong>多个消费者共同处理消息处理，消息处理的速度就能大大提高</strong>了。</p>
<p>接下来，我们就来模拟这样的场景。</p>
<p>首先，我们在控制台创建一个新的队列，命名为 <code>work.queue</code>：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/MQIMG/RabbitMQ/%E6%96%B0%E5%BB%BAwork.queue.png" alt="新建work.queue"></p>
<h3 id="3-3-1-消息发送"><a href="#3-3-1-消息发送" class="headerlink" title="3.3.1 消息发送"></a>3.3.1 消息发送</h3><p>这次我们循环发送，模拟大量消息堆积现象。</p>
<p>在 <code>publisher</code> 服务中的 <code>SpringAmqpTest</code> 类中添加一个测试方法：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * workQueue</span></span><br><span class="line"><span class="comment"> * 向队列中不停发送消息，模拟消息堆积。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testWorkQueue</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="comment">// 队列名称</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">queueName</span> <span class="operator">=</span> <span class="string">&quot;work.queue&quot;</span>;</span><br><span class="line">    <span class="comment">// 消息</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">&quot;hello, message_&quot;</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">50</span>; i++) &#123;</span><br><span class="line">        <span class="comment">// 发送消息，每20毫秒发送一次，相当于每秒发送50条消息</span></span><br><span class="line">        rabbitTemplate.convertAndSend(queueName, message + i);</span><br><span class="line">        Thread.sleep(<span class="number">20</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-3-2-消息接收"><a href="#3-3-2-消息接收" class="headerlink" title="3.3.2 消息接收"></a>3.3.2 消息接收</h3><p>要模拟多个消费者绑定同一个队列，我们在 <code>consumer</code> 服务的 <code>SpringRabbitListener</code> 中添加2个新的方法：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RabbitListener(queues = &quot;work.queue&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listenWorkQueue1</span><span class="params">(String msg)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;消费者1接收到消息：【&quot;</span> + msg + <span class="string">&quot;】&quot;</span> + Localtime.now());</span><br><span class="line">    Thread.sleep(<span class="number">20</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RabbitListener(queues = &quot;work.queue&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listenWorkQueue2</span><span class="params">(String msg)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    System.err.println(<span class="string">&quot;消费者2........接收到消息：【&quot;</span> + msg + <span class="string">&quot;】&quot;</span> + Localtime.now());</span><br><span class="line">    Thread.sleep(<span class="number">200</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意到这两消费者，都设置了 <code>Thead.sleep</code>，模拟任务耗时：</p>
<ul>
<li>消费者1 sleep了20毫秒，相当于每秒钟处理 50 个消息</li>
<li>消费者2 sleep了200毫秒，相当于每秒处理 5 个消息</li>
</ul>
<blockquote>
<p>测试</p>
</blockquote>
<p>启动 <code>ConsumerApplication</code> 后，在执行 publisher 服务中刚刚编写的发送测试方法 <code>testWorkQueue</code>。</p>
<p>最终结果如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">消费者<span class="number">2.</span>.......接收到消息：【hello, message_0】<span class="number">13</span>:<span class="number">32</span>:<span class="number">09.536087700</span></span><br><span class="line">消费者<span class="number">1</span>接收到消息：【hello, message_1】<span class="number">13</span>:<span class="number">32</span>:<span class="number">09.551980600</span></span><br><span class="line">消费者<span class="number">1</span>接收到消息：【hello, message_3】<span class="number">13</span>:<span class="number">32</span>:<span class="number">09.613422600</span></span><br><span class="line">消费者<span class="number">1</span>接收到消息：【hello, message_5】<span class="number">13</span>:<span class="number">32</span>:<span class="number">09.675505600</span></span><br><span class="line">消费者<span class="number">1</span>接收到消息：【hello, message_7】<span class="number">13</span>:<span class="number">32</span>:<span class="number">09.736149700</span></span><br><span class="line">消费者<span class="number">2.</span>.......接收到消息：【hello, message_2】<span class="number">13</span>:<span class="number">32</span>:<span class="number">09.750059700</span></span><br><span class="line">消费者<span class="number">1</span>接收到消息：【hello, message_9】<span class="number">13</span>:<span class="number">32</span>:<span class="number">09.798666</span></span><br><span class="line">消费者<span class="number">1</span>接收到消息：【hello, message_11】<span class="number">13</span>:<span class="number">32</span>:<span class="number">09.858968900</span></span><br><span class="line">消费者<span class="number">1</span>接收到消息：【hello, message_13】<span class="number">13</span>:<span class="number">32</span>:<span class="number">09.921156200</span></span><br><span class="line">消费者<span class="number">2.</span>.......接收到消息：【hello, message_4】<span class="number">13</span>:<span class="number">32</span>:<span class="number">09.964499700</span></span><br><span class="line">消费者<span class="number">1</span>接收到消息：【hello, message_15】<span class="number">13</span>:<span class="number">32</span>:<span class="number">09.981896500</span></span><br><span class="line">消费者<span class="number">1</span>接收到消息：【hello, message_17】<span class="number">13</span>:<span class="number">32</span>:<span class="number">10.042619700</span></span><br><span class="line">消费者<span class="number">1</span>接收到消息：【hello, message_19】<span class="number">13</span>:<span class="number">32</span>:<span class="number">10.104275100</span></span><br><span class="line">消费者<span class="number">1</span>接收到消息：【hello, message_21】<span class="number">13</span>:<span class="number">32</span>:<span class="number">10.165434600</span></span><br><span class="line">消费者<span class="number">2.</span>.......接收到消息：【hello, message_6】<span class="number">13</span>:<span class="number">32</span>:<span class="number">10.178848100</span></span><br><span class="line">消费者<span class="number">1</span>接收到消息：【hello, message_23】<span class="number">13</span>:<span class="number">32</span>:<span class="number">10.225494800</span></span><br><span class="line">消费者<span class="number">1</span>接收到消息：【hello, message_25】<span class="number">13</span>:<span class="number">32</span>:<span class="number">10.287941400</span></span><br><span class="line">消费者<span class="number">1</span>接收到消息：【hello, message_27】<span class="number">13</span>:<span class="number">32</span>:<span class="number">10.349246100</span></span><br><span class="line">消费者<span class="number">2.</span>.......接收到消息：【hello, message_8】<span class="number">13</span>:<span class="number">32</span>:<span class="number">10.393275300</span></span><br><span class="line">消费者<span class="number">1</span>接收到消息：【hello, message_29】<span class="number">13</span>:<span class="number">32</span>:<span class="number">10.409556700</span></span><br><span class="line">消费者<span class="number">1</span>接收到消息：【hello, message_31】<span class="number">13</span>:<span class="number">32</span>:<span class="number">10.471235500</span></span><br><span class="line">消费者<span class="number">1</span>接收到消息：【hello, message_33】<span class="number">13</span>:<span class="number">32</span>:<span class="number">10.532975600</span></span><br><span class="line">消费者<span class="number">1</span>接收到消息：【hello, message_35】<span class="number">13</span>:<span class="number">32</span>:<span class="number">10.594234</span></span><br><span class="line">消费者<span class="number">2.</span>.......接收到消息：【hello, message_10】<span class="number">13</span>:<span class="number">32</span>:<span class="number">10.608551200</span></span><br><span class="line">消费者<span class="number">1</span>接收到消息：【hello, message_37】<span class="number">13</span>:<span class="number">32</span>:<span class="number">10.655375500</span></span><br><span class="line">消费者<span class="number">1</span>接收到消息：【hello, message_39】<span class="number">13</span>:<span class="number">32</span>:<span class="number">10.716239400</span></span><br><span class="line">消费者<span class="number">1</span>接收到消息：【hello, message_41】<span class="number">13</span>:<span class="number">32</span>:<span class="number">10.777315</span></span><br><span class="line">消费者<span class="number">2.</span>.......接收到消息：【hello, message_12】<span class="number">13</span>:<span class="number">32</span>:<span class="number">10.822535300</span></span><br><span class="line">消费者<span class="number">1</span>接收到消息：【hello, message_43】<span class="number">13</span>:<span class="number">32</span>:<span class="number">10.838913400</span></span><br><span class="line">消费者<span class="number">1</span>接收到消息：【hello, message_45】<span class="number">13</span>:<span class="number">32</span>:<span class="number">10.900169200</span></span><br><span class="line">消费者<span class="number">1</span>接收到消息：【hello, message_47】<span class="number">13</span>:<span class="number">32</span>:<span class="number">10.961616800</span></span><br><span class="line">消费者<span class="number">1</span>接收到消息：【hello, message_49】<span class="number">13</span>:<span class="number">32</span>:<span class="number">11.022953200</span></span><br><span class="line">消费者<span class="number">2.</span>.......接收到消息：【hello, message_14】<span class="number">13</span>:<span class="number">32</span>:<span class="number">11.037243800</span></span><br><span class="line">消费者<span class="number">2.</span>.......接收到消息：【hello, message_16】<span class="number">13</span>:<span class="number">32</span>:<span class="number">11.251656100</span></span><br><span class="line">消费者<span class="number">2.</span>.......接收到消息：【hello, message_18】<span class="number">13</span>:<span class="number">32</span>:<span class="number">11.465585400</span></span><br><span class="line">消费者<span class="number">2.</span>.......接收到消息：【hello, message_20】<span class="number">13</span>:<span class="number">32</span>:<span class="number">11.665810700</span></span><br><span class="line">消费者<span class="number">2.</span>.......接收到消息：【hello, message_22】<span class="number">13</span>:<span class="number">32</span>:<span class="number">11.880131200</span></span><br><span class="line">消费者<span class="number">2.</span>.......接收到消息：【hello, message_24】<span class="number">13</span>:<span class="number">32</span>:<span class="number">12.094026700</span></span><br><span class="line">消费者<span class="number">2.</span>.......接收到消息：【hello, message_26】<span class="number">13</span>:<span class="number">32</span>:<span class="number">12.309042400</span></span><br><span class="line">消费者<span class="number">2.</span>.......接收到消息：【hello, message_28】<span class="number">13</span>:<span class="number">32</span>:<span class="number">12.523591600</span></span><br><span class="line">消费者<span class="number">2.</span>.......接收到消息：【hello, message_30】<span class="number">13</span>:<span class="number">32</span>:<span class="number">12.724700700</span></span><br><span class="line">消费者<span class="number">2.</span>.......接收到消息：【hello, message_32】<span class="number">13</span>:<span class="number">32</span>:<span class="number">12.939740200</span></span><br><span class="line">消费者<span class="number">2.</span>.......接收到消息：【hello, message_34】<span class="number">13</span>:<span class="number">32</span>:<span class="number">13.141516900</span></span><br><span class="line">消费者<span class="number">2.</span>.......接收到消息：【hello, message_36】<span class="number">13</span>:<span class="number">32</span>:<span class="number">13.354740500</span></span><br><span class="line">消费者<span class="number">2.</span>.......接收到消息：【hello, message_38】<span class="number">13</span>:<span class="number">32</span>:<span class="number">13.555752900</span></span><br><span class="line">消费者<span class="number">2.</span>.......接收到消息：【hello, message_40】<span class="number">13</span>:<span class="number">32</span>:<span class="number">13.771193800</span></span><br><span class="line">消费者<span class="number">2.</span>.......接收到消息：【hello, message_42】<span class="number">13</span>:<span class="number">32</span>:<span class="number">13.984944100</span></span><br><span class="line">消费者<span class="number">2.</span>.......接收到消息：【hello, message_44】<span class="number">13</span>:<span class="number">32</span>:<span class="number">14.198056</span></span><br><span class="line">消费者<span class="number">2.</span>.......接收到消息：【hello, message_46】<span class="number">13</span>:<span class="number">32</span>:<span class="number">14.412763700</span></span><br><span class="line">消费者<span class="number">2.</span>.......接收到消息：【hello, message_48】<span class="number">13</span>:<span class="number">32</span>:<span class="number">14.627655600</span></span><br></pre></td></tr></table></figure>

<p>可以看到消费者 1 和消费者 2 竟然每人消费了 25 条消息：</p>
<ul>
<li>消费者1很快完成了自己的 25 条消息</li>
<li>消费者 2 却在缓慢的处理自己的 25 条消息。</li>
</ul>
<p>也就是说消息是平均分配给每个消费者，并没有考虑到消费者的处理能力。导致 1 个消费者空闲，另一个消费者忙的不可开交。没有充分利用每一个消费者的能力，最终消息处理的耗时远远超过了1秒。这样显然是有问题的。</p>
<h3 id="3-3-3-能者多劳"><a href="#3-3-3-能者多劳" class="headerlink" title="3.3.3 能者多劳"></a>3.3.3 能者多劳</h3><p>在 spring 中有一个简单的配置，可以解决这个问题。我们修改 <code>consumer</code> 服务的 <code>application.yml</code> 文件，添加配置：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">listener:</span></span><br><span class="line">      <span class="attr">simple:</span></span><br><span class="line">        <span class="attr">prefetch:</span> <span class="number">1</span> <span class="comment"># 每次只能获取一条消息，处理完成才能获取下一个消息</span></span><br></pre></td></tr></table></figure>

<p>再次测试，发现结果如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">消费者<span class="number">2.</span>.......接收到消息：【hello, message_0】<span class="number">13</span>:<span class="number">35</span>:<span class="number">42.160102800</span></span><br><span class="line">消费者<span class="number">1</span>接收到消息：【hello, message_1】<span class="number">13</span>:<span class="number">35</span>:<span class="number">42.181459500</span></span><br><span class="line">消费者<span class="number">1</span>接收到消息：【hello, message_2】<span class="number">13</span>:<span class="number">35</span>:<span class="number">42.212252400</span></span><br><span class="line">消费者<span class="number">1</span>接收到消息：【hello, message_3】<span class="number">13</span>:<span class="number">35</span>:<span class="number">42.243198500</span></span><br><span class="line">消费者<span class="number">1</span>接收到消息：【hello, message_4】<span class="number">13</span>:<span class="number">35</span>:<span class="number">42.273495200</span></span><br><span class="line">消费者<span class="number">1</span>接收到消息：【hello, message_5】<span class="number">13</span>:<span class="number">35</span>:<span class="number">42.304288600</span></span><br><span class="line">消费者<span class="number">1</span>接收到消息：【hello, message_6】<span class="number">13</span>:<span class="number">35</span>:<span class="number">42.334585200</span></span><br><span class="line">消费者<span class="number">1</span>接收到消息：【hello, message_7】<span class="number">13</span>:<span class="number">35</span>:<span class="number">42.366371400</span></span><br><span class="line">消费者<span class="number">2.</span>.......接收到消息：【hello, message_8】<span class="number">13</span>:<span class="number">35</span>:<span class="number">42.396668300</span></span><br><span class="line">消费者<span class="number">1</span>接收到消息：【hello, message_9】<span class="number">13</span>:<span class="number">35</span>:<span class="number">42.427462</span></span><br><span class="line">消费者<span class="number">1</span>接收到消息：【hello, message_10】<span class="number">13</span>:<span class="number">35</span>:<span class="number">42.458255100</span></span><br><span class="line">消费者<span class="number">1</span>接收到消息：【hello, message_11】<span class="number">13</span>:<span class="number">35</span>:<span class="number">42.489047900</span></span><br><span class="line">消费者<span class="number">1</span>接收到消息：【hello, message_12】<span class="number">13</span>:<span class="number">35</span>:<span class="number">42.519842500</span></span><br><span class="line">消费者<span class="number">1</span>接收到消息：【hello, message_13】<span class="number">13</span>:<span class="number">35</span>:<span class="number">42.550635400</span></span><br><span class="line">消费者<span class="number">1</span>接收到消息：【hello, message_14】<span class="number">13</span>:<span class="number">35</span>:<span class="number">42.581428100</span></span><br><span class="line">消费者<span class="number">1</span>接收到消息：【hello, message_15】<span class="number">13</span>:<span class="number">35</span>:<span class="number">42.612221700</span></span><br><span class="line">消费者<span class="number">2.</span>.......接收到消息：【hello, message_16】<span class="number">13</span>:<span class="number">35</span>:<span class="number">42.643014600</span></span><br><span class="line">消费者<span class="number">1</span>接收到消息：【hello, message_17】<span class="number">13</span>:<span class="number">35</span>:<span class="number">42.674304900</span></span><br><span class="line">消费者<span class="number">1</span>接收到消息：【hello, message_18】<span class="number">13</span>:<span class="number">35</span>:<span class="number">42.704601200</span></span><br><span class="line">消费者<span class="number">1</span>接收到消息：【hello, message_19】<span class="number">13</span>:<span class="number">35</span>:<span class="number">42.735394900</span></span><br><span class="line">消费者<span class="number">1</span>接收到消息：【hello, message_20】<span class="number">13</span>:<span class="number">35</span>:<span class="number">42.766188100</span></span><br><span class="line">消费者<span class="number">1</span>接收到消息：【hello, message_21】<span class="number">13</span>:<span class="number">35</span>:<span class="number">42.796458</span></span><br><span class="line">消费者<span class="number">1</span>接收到消息：【hello, message_22】<span class="number">13</span>:<span class="number">35</span>:<span class="number">42.830668700</span></span><br><span class="line">消费者<span class="number">1</span>接收到消息：【hello, message_23】<span class="number">13</span>:<span class="number">35</span>:<span class="number">42.858482500</span></span><br><span class="line">消费者<span class="number">2.</span>.......接收到消息：【hello, message_24】<span class="number">13</span>:<span class="number">35</span>:<span class="number">42.888778200</span></span><br><span class="line">消费者<span class="number">1</span>接收到消息：【hello, message_25】<span class="number">13</span>:<span class="number">35</span>:<span class="number">42.920069300</span></span><br><span class="line">消费者<span class="number">1</span>接收到消息：【hello, message_26】<span class="number">13</span>:<span class="number">35</span>:<span class="number">42.950364900</span></span><br><span class="line">消费者<span class="number">1</span>接收到消息：【hello, message_27】<span class="number">13</span>:<span class="number">35</span>:<span class="number">42.981163300</span></span><br><span class="line">消费者<span class="number">1</span>接收到消息：【hello, message_28】<span class="number">13</span>:<span class="number">35</span>:<span class="number">43.011454900</span></span><br><span class="line">消费者<span class="number">1</span>接收到消息：【hello, message_29】<span class="number">13</span>:<span class="number">35</span>:<span class="number">43.042248</span></span><br><span class="line">消费者<span class="number">1</span>接收到消息：【hello, message_30】<span class="number">13</span>:<span class="number">35</span>:<span class="number">43.073042600</span></span><br><span class="line">消费者<span class="number">1</span>接收到消息：【hello, message_31】<span class="number">13</span>:<span class="number">35</span>:<span class="number">43.103835100</span></span><br><span class="line">消费者<span class="number">2.</span>.......接收到消息：【hello, message_32】<span class="number">13</span>:<span class="number">35</span>:<span class="number">43.134628400</span></span><br><span class="line">消费者<span class="number">1</span>接收到消息：【hello, message_33】<span class="number">13</span>:<span class="number">35</span>:<span class="number">43.165923</span></span><br><span class="line">消费者<span class="number">1</span>接收到消息：【hello, message_34】<span class="number">13</span>:<span class="number">35</span>:<span class="number">43.196219900</span></span><br><span class="line">消费者<span class="number">1</span>接收到消息：【hello, message_35】<span class="number">13</span>:<span class="number">35</span>:<span class="number">43.227505100</span></span><br><span class="line">消费者<span class="number">1</span>接收到消息：【hello, message_36】<span class="number">13</span>:<span class="number">35</span>:<span class="number">43.259292700</span></span><br><span class="line">消费者<span class="number">1</span>接收到消息：【hello, message_37】<span class="number">13</span>:<span class="number">35</span>:<span class="number">43.289091200</span></span><br><span class="line">消费者<span class="number">1</span>接收到消息：【hello, message_38】<span class="number">13</span>:<span class="number">35</span>:<span class="number">43.319387700</span></span><br><span class="line">消费者<span class="number">1</span>接收到消息：【hello, message_39】<span class="number">13</span>:<span class="number">35</span>:<span class="number">43.350181800</span></span><br><span class="line">消费者<span class="number">2.</span>.......接收到消息：【hello, message_40】<span class="number">13</span>:<span class="number">35</span>:<span class="number">43.380978800</span></span><br><span class="line">消费者<span class="number">1</span>接收到消息：【hello, message_41】<span class="number">13</span>:<span class="number">35</span>:<span class="number">43.411920700</span></span><br><span class="line">消费者<span class="number">1</span>接收到消息：【hello, message_42】<span class="number">13</span>:<span class="number">35</span>:<span class="number">43.443211600</span></span><br><span class="line">消费者<span class="number">1</span>接收到消息：【hello, message_43】<span class="number">13</span>:<span class="number">35</span>:<span class="number">43.474500800</span></span><br><span class="line">消费者<span class="number">1</span>接收到消息：【hello, message_44】<span class="number">13</span>:<span class="number">35</span>:<span class="number">43.504301700</span></span><br><span class="line">消费者<span class="number">1</span>接收到消息：【hello, message_45】<span class="number">13</span>:<span class="number">35</span>:<span class="number">43.535094800</span></span><br><span class="line">消费者<span class="number">1</span>接收到消息：【hello, message_46】<span class="number">13</span>:<span class="number">35</span>:<span class="number">43.565888200</span></span><br><span class="line">消费者<span class="number">1</span>接收到消息：【hello, message_47】<span class="number">13</span>:<span class="number">35</span>:<span class="number">43.596681100</span></span><br><span class="line">消费者<span class="number">1</span>接收到消息：【hello, message_48】<span class="number">13</span>:<span class="number">35</span>:<span class="number">43.627474500</span></span><br><span class="line">消费者<span class="number">2.</span>.......接收到消息：【hello, message_49】<span class="number">13</span>:<span class="number">35</span>:<span class="number">43.658764100</span></span><br></pre></td></tr></table></figure>

<p>可以发现，由于消费者 1 处理速度较快，所以处理了更多的消息；消费者 2 处理速度较慢，只处理了 6 条消息。而最终总的执行耗时也在 1 秒左右，大大提升。</p>
<p>正所谓能者多劳，这样充分利用了每一个消费者的处理能力，可以有效避免消息积压问题。</p>
<blockquote>
<p>总结</p>
</blockquote>
<p>Work 模型的使用：</p>
<ul>
<li>多个消费者绑定到一个队列，同一条消息只会被一个消费者处理</li>
<li>通过设置prefetch来控制消费者预取的消息数量</li>
</ul>
<h2 id="3-4-交换机类型"><a href="#3-4-交换机类型" class="headerlink" title="3.4 交换机类型"></a>3.4 交换机类型</h2><p>在之前的两个测试案例中，都没有交换机，生产者直接发送消息到队列。而一旦引入交换机，消息发送的模式会有很大变化：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/MQIMG/RabbitMQ/%E6%B6%88%E6%81%AF%E5%8F%91%E9%80%81%E6%A8%A1%E5%BC%8F%E5%BC%95%E5%85%A5%E4%BA%A4%E6%8D%A2%E6%9C%BA.png" alt="消息发送模式引入交换机"><br>可以看到，在订阅模型中，多了一个 Exchange 角色，而且过程略有变化：</p>
<ul>
<li><strong>Publisher</strong>：生产者，不再发送消息到队列中，而是发给交换机</li>
<li><strong>Exchange</strong>：交换机，一方面，接收生产者发送的消息。另一方面，知道如何处理消息，例如递交给某个特别队列、递交给所有队列、或是将消息丢弃。到底如何操作，取决于 Exchange 的类型。</li>
<li><strong>Queue</strong>：消息队列也与以前一样，接收消息、缓存消息。不过队列一定要与交换机绑定。</li>
<li><strong>Consumer</strong>：消费者，与以前一样，订阅队列，没有变化</li>
</ul>
<p><strong>Exchange (交换机)只负责转发消息，不具备存储消息的能力</strong>，因此如果没有任何队列与 Exchange 绑定，或者没有符合路由规则的队列，那么消息会丢失！</p>
<p>交换机的类型有四种：</p>
<ul>
<li><strong>Fanout</strong>：广播，将消息交给所有绑定到交换机的队列。我们最早在控制台使用的正是Fanout交换机</li>
<li><strong>Direct</strong>：订阅，基于 RoutingKey (路由 key )发送给订阅了消息的队列</li>
<li><strong>Topic</strong>：通配符订阅，与 Direct 类似，只不过 RoutingKey 可以使用通配符</li>
<li><strong>Headers</strong>：头匹配，基于 MQ 的消息头匹配，用的较少。</li>
</ul>
<p>这里，我们讲解前面的三种交换机模式。</p>
<h2 id="3-5-Fanout交换机"><a href="#3-5-Fanout交换机" class="headerlink" title="3.5 Fanout交换机"></a>3.5 Fanout交换机</h2><p>Fanout，英文翻译是扇出，我觉得在 MQ 中叫广播更合适。</p>
<p>在广播模式下，消息发送流程是这样的：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/MQIMG/RabbitMQ/%E5%B9%BF%E6%92%AD%E6%A8%A1%E5%BC%8F%E4%B8%8B%E6%B6%88%E6%81%AF%E5%8F%91%E9%80%81%E6%B5%81%E7%A8%8B.png" alt="广播模式下消息发送流程"></p>
<ul>
<li> 可以有多个队列</li>
<li>每个队列都要绑定到 Exchange (交换机)</li>
<li>生产者发送的消息，只能发送到交换机</li>
<li>机把消息发送给绑定过的所有队列</li>
<li>订阅队列的消费者都能拿到消息</li>
</ul>
<p><strong>案例需求如图：</strong><br><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/MQIMG/RabbitMQ/Fanout%E4%BA%A4%E6%8D%A2%E6%9C%BA%E9%9C%80%E6%B1%82%E6%A1%88%E4%BE%8B.png" alt="Fanout交换机需求案例"></p>
<ul>
<li>创建一个名为 <code>hmall.fanout</code> 的交换机，类型是 <code>Fanout</code></li>
<li>创建两个队列 <code>fanout.queue1 </code> 和 <code>fanout.queue2</code>，绑定到交换机 <code>hmall.fanout</code></li>
</ul>
<h3 id="3-5-1-声明队列和交换机"><a href="#3-5-1-声明队列和交换机" class="headerlink" title="3.5.1 声明队列和交换机"></a>3.5.1 声明队列和交换机</h3><p>在控制台创建队列 <code>fanout.queue1</code>，创建一个队列  <code>fanout.queue2</code>，然后再创建一个交换机 <code>hmall.fanout</code>：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/MQIMG/RabbitMQ/%E5%A3%B0%E6%98%8EFanout%E9%98%9F%E5%88%97%E5%92%8C%E4%BA%A4%E6%8D%A2%E6%9C%BA.png" alt="声明Fanout队列和交换机" style="zoom:67%;">

<p>然后绑定两个队列到交换机：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/MQIMG/RabbitMQ/%E7%BB%91%E5%AE%9Afanout.queue1%E9%98%9F%E5%88%97%E5%88%B0%E4%BA%A4%E6%8D%A2%E6%9C%BA.png" alt="绑定fanout.queue1队列到交换机" style="zoom:67%;">
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/MQIMG/RabbitMQ/%E7%BB%91%E5%AE%9Afanout.queue2%E9%98%9F%E5%88%97%E5%88%B0%E4%BA%A4%E6%8D%A2%E6%9C%BA.png" alt="绑定fanout.queue2队列到交换机" style="zoom:67%;">


<h3 id="3-5-2-消息发送"><a href="#3-5-2-消息发送" class="headerlink" title="3.5.2 消息发送"></a>3.5.2 消息发送</h3><p>在 <code>publisher</code> 服务的 <code>SpringAmqpTest</code> 类中添加测试方法：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testFanoutExchange</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 交换机名称</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">exchangeName</span> <span class="operator">=</span> <span class="string">&quot;hmall.fanout&quot;</span>;</span><br><span class="line">    <span class="comment">// 消息</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">&quot;hello, everyone!&quot;</span>;</span><br><span class="line">    rabbitTemplate.convertAndSend(exchangeName, <span class="string">&quot;&quot;</span>, message);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-5-3-消息接收"><a href="#3-5-3-消息接收" class="headerlink" title="3.5.3 消息接收"></a>3.5.3 消息接收</h3><p>在 <code>consumer</code> 服务的 <code>SpringRabbitListener</code> 中添加两个方法，作为消费者：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RabbitListener(queues = &quot;fanout.queue1&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listenFanoutQueue1</span><span class="params">(String msg)</span> &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;消费者1接收到Fanout消息：【&quot;</span> + msg + <span class="string">&quot;】&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RabbitListener(queues = &quot;fanout.queue2&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listenFanoutQueue2</span><span class="params">(String msg)</span> &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;消费者2接收到Fanout消息：【&quot;</span> + msg + <span class="string">&quot;】&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结果：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">消费者2接收到Fanout消息：【hello, everyone!】</span><br><span class="line">消费者1接收到Fanout消息：【hello, everyone!】</span><br></pre></td></tr></table></figure>

<blockquote>
<p>总结</p>
</blockquote>
<p>交换机的作用是什么？</p>
<ul>
<li>接收 publisher 发送的消息</li>
<li>将消息按照规则路由到与之绑定的队列</li>
<li>不能缓存消息，路由失败，消息丢失</li>
<li>FanoutExchange 的会将消息路由到每个绑定的队列</li>
</ul>
<h2 id="3-6-Direct交换机"><a href="#3-6-Direct交换机" class="headerlink" title="3.6 Direct交换机"></a>3.6 Direct交换机</h2><p>在 Fanout 模式中，一条消息，会被所有订阅的队列都消费。但是，在某些场景下，我们希望不同的消息被不同的队列消费。这时就要用到 Direct 类型的 Exchange。</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/MQIMG/RabbitMQ/Direct%E4%BA%A4%E6%8D%A2%E6%9C%BA.png" alt="Direct交换机"></p>
<p>在 Direct 模型下：</p>
<ul>
<li>队列与交换机的绑定，不能是任意绑定了，而是要指定一个 <code>RoutingKey</code> (路由 key )</li>
<li>消息的发送方在 向 Exchange 发送消息时，也必须指定消息的 <code>RoutingKey</code></li>
<li>Exchange不再把消息交给每一个绑定的队列，而是根据消息的 <code>Routing Key</code> 进行判断，只有队列的 <code>Routingkey</code> 与消息的 <code>Routing key</code> 完全一致，才会接收到消息</li>
</ul>
<p><strong>案例需求如图：</strong></p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/MQIMG/RabbitMQ/Direct%E4%BA%A4%E6%8D%A2%E6%9C%BA%E9%9C%80%E6%B1%82%E6%A1%88%E4%BE%8B.png" alt="Direct交换机需求案例"></p>
<ul>
<li>声明一个名为 <code>hmall.direct</code> 的交换机</li>
<li>声明队列 <code>direct.queue1</code>，绑定 <code>hmall.direct</code>，<code>bindingKey </code>为 <code>blud </code>和 <code>red</code></li>
<li>声明队列 <code>direct.queue2</code>，绑定 <code>hmall.direct</code>，<code>bindingKey</code> 为 <code>yellow</code>和 <code>red</code></li>
<li>在<code>consumer</code>服务中，编写两个消费者方法，分别监听 <code>direct.queue1</code> 和 <code>direct.queue2</code> </li>
<li>在 publisher 中编写测试方法，向 <code>hmall.direct</code> 发送消息</li>
</ul>
<h3 id="3-6-1-声明队列和交换机"><a href="#3-6-1-声明队列和交换机" class="headerlink" title="3.6.1 声明队列和交换机"></a>3.6.1 声明队列和交换机</h3><p>首先在控制台声明两个队列 <code>direct.queue1</code> 和 <code>direct.queue2 </code>，这里不再展示过程：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/MQIMG/RabbitMQ/%E5%A3%B0%E6%98%8EDirect%E9%98%9F%E5%88%97%E5%92%8C%E4%BA%A4%E6%8D%A2%E6%9C%BA.png" alt="声明Direct队列和交换机"></p>
<p>然后声明一个 Direct 类型的交换机，命名为 <code>hmall.direct</code>：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/MQIMG/RabbitMQ/Direct%E4%BA%A4%E6%8D%A2%E6%9C%BAhmall.direct.png" alt="Direct交换机hmall.direct"></p>
<p>然后使用 <code>red  </code> 和 <code>blue  </code> 作为 key，绑定 <code>direct.queue1 </code>到  <code>hmall.direct</code>：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/MQIMG/RabbitMQ/%E4%BD%BF%E7%94%A8red%E4%BD%9C%E4%B8%BAkey%E7%BB%91%E5%AE%9Adirect.queue1.png" alt="使用red作为key绑定direct.queue1"><br><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/MQIMG/RabbitMQ/%E4%BD%BF%E7%94%A8blue%E4%BD%9C%E4%B8%BAkey%E7%BB%91%E5%AE%9Adirect.queue1.png" alt="使用blue作为key绑定direct.queue1"></p>
<p>同理，使用 <code>red </code> 和 <code>yellow   </code>作为 key，绑定 <code>direct.queue2</code> 到 <code>hmall.direct</code>，步骤略，最终结果：<br><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/MQIMG/RabbitMQ/hmall.direct%E4%BA%A4%E6%8D%A2%E6%9C%BA%E7%BB%91%E5%AE%9A%E7%BB%93%E6%9E%9C.png" alt="hmall.direct交换机绑定结果"></p>
<h3 id="3-6-2-消息接收"><a href="#3-6-2-消息接收" class="headerlink" title="3.6.2 消息接收"></a>3.6.2 消息接收</h3><p>在 <code>consumer</code> 服务的 <code>SpringRabbitListener</code> 中添加方法：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RabbitListener(queues = &quot;direct.queue1&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listenDirectQueue1</span><span class="params">(String msg)</span> &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;消费者1接收到direct.queue1的消息：【&quot;</span> + msg + <span class="string">&quot;】&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RabbitListener(queues = &quot;direct.queue2&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listenDirectQueue2</span><span class="params">(String msg)</span> &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;消费者2接收到direct.queue2的消息：【&quot;</span> + msg + <span class="string">&quot;】&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="3-6-3-消息发送"><a href="#3-6-3-消息发送" class="headerlink" title="3.6.3 消息发送"></a>3.6.3 消息发送</h3><p>在 <code>publisher</code> 服务的 <code>SpringAmqpTest</code> 类中添加测试方法：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSendDirectExchange</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 交换机名称</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">exchangeName</span> <span class="operator">=</span> <span class="string">&quot;hmall.direct&quot;</span>;</span><br><span class="line">    <span class="comment">// 消息</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">&quot;红色警报！日本乱排核废水，导致海洋生物变异，惊现哥斯拉！&quot;</span>;</span><br><span class="line">    <span class="comment">// 发送消息</span></span><br><span class="line">    rabbitTemplate.convertAndSend(exchangeName, <span class="string">&quot;red&quot;</span>, message);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由于使用的 <code>red</code> 这个 key，所以两个消费者都收到了消息：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">消费者2接收到direct.queue2的消息：【红色警报！日本乱排核废水，导致海洋生物变异，惊现哥斯拉！】</span><br><span class="line">消费者1接收到direct.queue1的消息：【红色警报！日本乱排核废水，导致海洋生物变异，惊现哥斯拉！】</span><br></pre></td></tr></table></figure>

<p>我们再切换为 <code>blue</code> 这个 key：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSendDirectExchange</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 交换机名称</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">exchangeName</span> <span class="operator">=</span> <span class="string">&quot;hmall.direct&quot;</span>;</span><br><span class="line">    <span class="comment">// 消息</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">&quot;最新报道，哥斯拉是居民自治巨型气球，虚惊一场！&quot;</span>;</span><br><span class="line">    <span class="comment">// 发送消息</span></span><br><span class="line">    rabbitTemplate.convertAndSend(exchangeName, <span class="string">&quot;blue&quot;</span>, message);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>会发现，只有消费者 1 收到了消息：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">消费者1接收到direct.queue1的消息：【最新报道，哥斯拉是居民自治巨型气球，虚惊一场！】</span><br></pre></td></tr></table></figure>

<blockquote>
<p>总结</p>
</blockquote>
<p>描述下 Direct 交换机与 Fanout 交换机的差异？</p>
<ul>
<li>Fanout 交换机将消息路由给每一个与之绑定的队列</li>
<li>Direct交换机根据 RoutingKey 判断路由给哪个队列</li>
<li>如果多个队列具有相同的 RoutingKey，则与 Fanout 功能类似</li>
</ul>
<h2 id="3-7-Topic交换机"><a href="#3-7-Topic交换机" class="headerlink" title="3.7 Topic交换机"></a>3.7 Topic交换机</h2><h3 id="3-7-1-说明"><a href="#3-7-1-说明" class="headerlink" title="3.7.1 说明"></a>3.7.1 说明</h3><p><code>Topic</code> 类型的 <code>Exchange</code> 与 <code>Direct</code> 相比，都是可以根据 <code>RoutingKey</code> 把消息路由到不同的队列。</p>
<p>只不过 <code>Topic</code> 类型 <code>Exchange</code> 可以让队列在绑定 <code>BindingKey</code> 的时候使用通配符！</p>
<p><code>BindingKey</code> 一般都是有一个或多个单词组成，多个单词之间以  <code>. </code> 分割，例如： <code>item.insert</code></p>
<p>通配符规则：</p>
<ul>
<li><code>#</code>：匹配一个或多个词</li>
<li><code>*</code>：匹配不多不少恰好1个词</li>
</ul>
<p>举例：</p>
<ul>
<li><code>item.#</code>：能够匹配 <code>item.spu.insert</code> 或者 <code>item.spu</code></li>
<li><code>item.*</code>：只能匹配 <code>item.spu</code></li>
</ul>
<p>图示：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/MQIMG/RabbitMQ/Topic%E4%BA%A4%E6%8D%A2%E6%9C%BA.png" alt="Topic交换机"></p>
<p>假如此时 publisher 发送的消息使用的 <code>RoutingKey</code> 共有四种：</p>
<ul>
<li><code>china.news </code> 代表有中国的新闻消息；</li>
<li><code>china.weather</code> 代表中国的天气消息；</li>
<li><code>japan.news</code> 则代表日本新闻</li>
<li><code>japan.weather</code> 代表日本的天气消息；</li>
</ul>
<p>解释：</p>
<ul>
<li><code>topic.queue1</code>：绑定的是 <code>china.#</code> ，凡是以 <code>china.</code>开头的 <code>routing key</code> 都会被匹配到，包括：<ul>
<li><code>china.news</code></li>
<li><code>china.weather</code></li>
</ul>
</li>
<li><code>topic.queue2</code>：绑定的是 <code>#.news</code> ，凡是以 <code>.news </code>结尾的 <code>routing key</code> 都会被匹配。包括:<ul>
<li><code>china.news</code></li>
<li><code>japan.news</code></li>
</ul>
</li>
</ul>
<p>接下来，我们就按照上图所示，来演示一下 Topic 交换机的用法。</p>
<p>首先，在控制台按照图示例子创建队列、交换机，并利用通配符绑定队列和交换机。此处步骤略。最终结果如下：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/MQIMG/RabbitMQ/%E5%88%A9%E7%94%A8%E9%80%9A%E9%85%8D%E7%AC%A6%E7%BB%91%E5%AE%9A%E9%98%9F%E5%88%97%E5%92%8C%E4%BA%A4%E6%8D%A2%E6%9C%BA.png" alt="利用通配符绑定队列和交换机"></p>
<h3 id="3-7-2-消息发送"><a href="#3-7-2-消息发送" class="headerlink" title="3.7.2 消息发送"></a>3.7.2 消息发送</h3><p>在 publisher 服务的 <code>SpringAmqpTest</code> 类中添加测试方法：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * topicExchange</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSendTopicExchange</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 交换机名称</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">exchangeName</span> <span class="operator">=</span> <span class="string">&quot;hmall.topic&quot;</span>;</span><br><span class="line">    <span class="comment">// 消息</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">&quot;喜报！孙悟空大战哥斯拉，胜!&quot;</span>;</span><br><span class="line">    <span class="comment">// 发送消息</span></span><br><span class="line">    rabbitTemplate.convertAndSend(exchangeName, <span class="string">&quot;china.news&quot;</span>, message);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-7-3-消息接收"><a href="#3-7-3-消息接收" class="headerlink" title="3.7.3 消息接收"></a>3.7.3 消息接收</h3><p>在 <code>consumer</code> 服务的 <code>SpringRabbitListener</code> 中添加方法：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RabbitListener(queues = &quot;topic.queue1&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listenTopicQueue1</span><span class="params">(String msg)</span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;消费者1接收到topic.queue1的消息：【&quot;</span> + msg + <span class="string">&quot;】&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RabbitListener(queues = &quot;topic.queue2&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listenTopicQueue2</span><span class="params">(String msg)</span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;消费者2接收到topic.queue2的消息：【&quot;</span> + msg + <span class="string">&quot;】&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">消费者2接收到topic.queue2的消息：【喜报！孙悟空大战哥斯拉，胜!】</span><br><span class="line">消费者1接收到topic.queue1的消息：【喜报！孙悟空大战哥斯拉，胜!】</span><br></pre></td></tr></table></figure>

<p>我们再切换为 <code>china.message</code> 这个 key 测试：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">消费者1接收到topic.queue1的消息：【喜报！孙悟空大战哥斯拉，胜!】</span><br></pre></td></tr></table></figure>

<p>我们再切换为 <code>chengdu.news</code> 这个 key 测试：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">消费者2接收到topic.queue2的消息：【喜报！孙悟空大战哥斯拉，胜!】</span><br></pre></td></tr></table></figure>

<blockquote>
<p>总结</p>
</blockquote>
<p>描述下 Direct 交换机与 Topic 交换机的差异？</p>
<ul>
<li>Topic 交换机接收的消息 RoutingKey 可以是多个单词，以 <code>**.**</code> 分割</li>
<li>Topic交换机与队列绑定时的 bindingKey 可以指定通配符</li>
<li><code>#</code>：代表0个或多个词</li>
<li><code>*</code>：代表1个词</li>
</ul>
<h2 id="3-8-声明队列和交换机"><a href="#3-8-声明队列和交换机" class="headerlink" title="3.8 声明队列和交换机"></a>3.8 声明队列和交换机</h2><p>在之前我们都是基于 RabbitMQ 控制台来创建队列、交换机。但是在实际开发时，队列和交换机是程序员定义的，将来项目上线，又要交给运维去创建。那么程序员就需要把程序中运行的所有队列和交换机都写下来，交给运维。在这个过程中是很容易出现错误的。</p>
<p>因此推荐的做法是由程序启动时检查队列和交换机是否存在，如果不存在自动创建。</p>
<h3 id="3-8-1-基本API"><a href="#3-8-1-基本API" class="headerlink" title="3.8.1 基本API"></a>3.8.1 基本API</h3><p>SpringAMQP 提供了一个 Queue 类，用来创建队列：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Queue</span> <span class="keyword">extends</span> <span class="title class_">AbstractDeclarable</span> <span class="keyword">implements</span> <span class="title class_">Cloneable</span> &#123;</span><br><span class="line">    <span class="comment">// --snip--</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>SpringAMQP 还提供了一个 <code>Exchange</code> 接口，来表示所有不同类型的交换机：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/MQIMG/RabbitMQ/Exchange%E6%8E%A5%E5%8F%A3.png" alt="Exchange接口"></p>
<p>我们可以自己创建队列和交换机，不过 SpringAMQP 还提供了 <code>ExchangeBuilder</code> 来简化这个过程：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/MQIMG/RabbitMQ/ExchangeBuilder.png" alt="ExchangeBuilder"></p>
<p>而在绑定队列和交换机时，则需要使用 <code>BindingBuilder</code> 来创建 Binding 对象：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/MQIMG/RabbitMQ/BindingBuilder%E4%B8%AD%E7%9A%84%E6%96%B9%E6%B3%95.png" alt="BindingBuilder中的方法"></p>
<h3 id="3-8-2-Fanout示例"><a href="#3-8-2-Fanout示例" class="headerlink" title="3.8.2 Fanout示例"></a>3.8.2 Fanout示例</h3><p>在 <code>consumer</code> 中创建一个类，声明队列和交换机：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.muyoukule.consumer.config;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FanoutConfig</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 声明交换机</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> Fanout类型交换机</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> FanoutExchange <span class="title function_">fanoutExchange</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">FanoutExchange</span>(<span class="string">&quot;hmall.fanout&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 第1个队列</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">fanoutQueue1</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(<span class="string">&quot;fanout.queue1&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 绑定队列和交换机</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">bindingQueue1</span><span class="params">(Queue fanoutQueue1, FanoutExchange fanoutExchange)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(fanoutQueue1).to(fanoutExchange);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 第2个队列</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">fanoutQueue2</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(<span class="string">&quot;fanout.queue2&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 绑定队列和交换机</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">bindingQueue2</span><span class="params">(Queue fanoutQueue2, FanoutExchange fanoutExchange)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(fanoutQueue2).to(fanoutExchange);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-8-3-Direct示例"><a href="#3-8-3-Direct示例" class="headerlink" title="3.8.3 Direct示例"></a>3.8.3 Direct示例</h3><p>Direct 模式由于要绑定多个 Key，会非常麻烦，每一个 Key 都要编写一个 binding：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.muyoukule.consumer.config;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DirectConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 声明交换机</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> Direct类型交换机</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> DirectExchange <span class="title function_">directExchange</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> ExchangeBuilder.directExchange(<span class="string">&quot;hmall.direct&quot;</span>).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 第1个队列</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">directQueue1</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(<span class="string">&quot;direct.queue1&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 绑定队列和交换机</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">bindingQueue1WithRed</span><span class="params">(Queue directQueue1, DirectExchange directExchange)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(directQueue1).to(directExchange).with(<span class="string">&quot;red&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 绑定队列和交换机</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">bindingQueue1WithBlue</span><span class="params">(Queue directQueue1, DirectExchange directExchange)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(directQueue1).to(directExchange).with(<span class="string">&quot;blue&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 第2个队列</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">directQueue2</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(<span class="string">&quot;direct.queue2&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 绑定队列和交换机</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">bindingQueue2WithRed</span><span class="params">(Queue directQueue2, DirectExchange directExchange)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(directQueue2).to(directExchange).with(<span class="string">&quot;red&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 绑定队列和交换机</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">bindingQueue2WithYellow</span><span class="params">(Queue directQueue2, DirectExchange directExchange)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(directQueue2).to(directExchange).with(<span class="string">&quot;yellow&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-8-4-基于注解声明"><a href="#3-8-4-基于注解声明" class="headerlink" title="3.8.4 基于注解声明"></a>3.8.4 基于注解声明</h3><p>基于 <code>@Bean</code> 的方式声明队列和交换机比较麻烦，Spring 还提供了基于注解方式来声明。<font color="red">PS：不要导错包了哦，是注解类型的包</font>😀</p>
<p>例如，我们同样声明 Direct 模式的交换机和队列：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RabbitListener(bindings = @QueueBinding(</span></span><br><span class="line"><span class="meta">        value = @Queue(name = &quot;direct.queue1&quot;),</span></span><br><span class="line"><span class="meta">        exchange = @Exchange(name = &quot;hmall.direct&quot;, type = ExchangeTypes.DIRECT),</span></span><br><span class="line"><span class="meta">        key = &#123;&quot;red&quot;, &quot;blue&quot;&#125;</span></span><br><span class="line"><span class="meta">))</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listenDirectQueue1</span><span class="params">(String msg)</span> &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;消费者1接收到direct.queue1的消息：【&quot;</span> + msg + <span class="string">&quot;】&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RabbitListener(bindings = @QueueBinding(</span></span><br><span class="line"><span class="meta">        value = @Queue(name = &quot;direct.queue2&quot;),</span></span><br><span class="line"><span class="meta">        exchange = @Exchange(name = &quot;hmall.direct&quot;, type = ExchangeTypes.DIRECT),</span></span><br><span class="line"><span class="meta">        key = &#123;&quot;red&quot;, &quot;yellow&quot;&#125;</span></span><br><span class="line"><span class="meta">))</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listenDirectQueue2</span><span class="params">(String msg)</span> &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;消费者2接收到direct.queue2的消息：【&quot;</span> + msg + <span class="string">&quot;】&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>是不是简单多了。</p>
<p>再试试 Topic 模式：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RabbitListener(bindings = @QueueBinding(</span></span><br><span class="line"><span class="meta">        value = @Queue(name = &quot;topic.queue1&quot;),</span></span><br><span class="line"><span class="meta">        exchange = @Exchange(name = &quot;hmall.topic&quot;, type = ExchangeTypes.TOPIC),</span></span><br><span class="line"><span class="meta">        key = &quot;china.#&quot;</span></span><br><span class="line"><span class="meta">))</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listenTopicQueue1</span><span class="params">(String msg)</span> &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;消费者1接收到topic.queue1的消息：【&quot;</span> + msg + <span class="string">&quot;】&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RabbitListener(bindings = @QueueBinding(</span></span><br><span class="line"><span class="meta">        value = @Queue(name = &quot;topic.queue2&quot;),</span></span><br><span class="line"><span class="meta">        exchange = @Exchange(name = &quot;hmall.topic&quot;, type = ExchangeTypes.TOPIC),</span></span><br><span class="line"><span class="meta">        key = &quot;#.news&quot;</span></span><br><span class="line"><span class="meta">))</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listenTopicQueue2</span><span class="params">(String msg)</span> &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;消费者2接收到topic.queue2的消息：【&quot;</span> + msg + <span class="string">&quot;】&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="3-9-消息转换器"><a href="#3-9-消息转换器" class="headerlink" title="3.9 消息转换器"></a>3.9 消息转换器</h2><p>Spring 的消息发送代码接收的消息体是一个 Object：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/MQIMG/RabbitMQ/%E6%8E%A5%E6%94%B6%E7%9A%84Object.png" alt="接收的Object"></p>
<p>而在数据传输时，它会把你发送的消息序列化为字节发送给 MQ，接收消息的时候，还会把字节反序列化为 Java 对象。</p>
<p>只不过，默认情况下 Spring 采用的序列化方式是 JDK 序列化。众所周知，JDK 序列化存在下列问题：</p>
<ul>
<li>数据体积过大</li>
<li>有安全漏洞</li>
<li>可读性差</li>
</ul>
<p>我们来测试一下。</p>
<h3 id="3-9-1-测试默认转换器"><a href="#3-9-1-测试默认转换器" class="headerlink" title="3.9.1 测试默认转换器"></a>3.9.1 测试默认转换器</h3><p>1、创建测试队列</p>
<p>首先，我们在 <code>consumer</code> 服务中声明一个新的配置类 <code>MessageConfig</code>，利用 <code>@Bean</code> 的方式创建一个队列，具体代码：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MessageConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">objectQueue</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(<span class="string">&quot;object.queue&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意，这里我们先不要给这个队列添加消费者，我们要查看消息体的格式。</p>
<p>重启 <code>consumer</code> 服务以后，该队列就会被自动创建出来了：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/MQIMG/RabbitMQ/object.queue%E9%98%9F%E5%88%97.png" alt="object.queue队列"></p>
<p>2、发送消息</p>
<p>我们在 publisher 模块的 <code>SpringAmqpTest</code> 中新增一个消息发送的代码，发送一个 Map 对象：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSendMap</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 准备消息</span></span><br><span class="line">    Map&lt;String, Object&gt; msg = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    msg.put(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;柳岩&quot;</span>);</span><br><span class="line">    msg.put(<span class="string">&quot;age&quot;</span>, <span class="number">21</span>);</span><br><span class="line">    <span class="comment">// 发送消息</span></span><br><span class="line">    rabbitTemplate.convertAndSend(<span class="string">&quot;object.queue&quot;</span>, msg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3、发送消息后查看控制台：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/MQIMG/RabbitMQ/JDK%E5%BA%8F%E5%88%97%E5%8C%96%E6%B6%88%E6%81%AF.png" alt=" JDK序列化消息"></p>
<p>可以看到消息格式非常不友好。</p>
<h3 id="3-9-2-配置JSON转换器"><a href="#3-9-2-配置JSON转换器" class="headerlink" title="3.9.2 配置JSON转换器"></a>3.9.2 配置JSON转换器</h3><p>显然，JDK 序列化方式并不合适。我们希望消息体的体积更小、可读性更高，因此可以使用 JSON 方式来做序列化和反序列化。</p>
<p>1、在父工程引入依赖：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--jackson--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.dataformat<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-dataformat-xml<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.10<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>PS：如果项目中引入了 <code>spring-boot-starter-web</code> 依赖，则无需再次引入 <code>Jackson</code> 依赖。</p>
<p>2、配置消息转换器，在 <code>publisher </code>和 <code>consumer</code> 两个服务的启动类中添加一个 Bean 即可：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> MessageConverter <span class="title function_">messageConverter</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 1.定义消息转换器</span></span><br><span class="line">    <span class="type">Jackson2JsonMessageConverter</span> <span class="variable">jackson2JsonMessageConverter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Jackson2JsonMessageConverter</span>();</span><br><span class="line">    <span class="comment">// 2.配置自动创建消息id，用于识别不同消息，也可以在业务中基于ID判断是否是重复消息</span></span><br><span class="line">    jackson2JsonMessageConverter.setCreateMessageIds(<span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">return</span> jackson2JsonMessageConverter;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>消息转换器中添加的 messageId 可以便于我们将来做幂等性判断。</p>
<p>3、此时，再次执行刚才的消息发送的代码，到 RabbitMQ 的控制台查看消息结构(Get messages 填 <code>2</code> ) ：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/MQIMG/RabbitMQ/RabbitMQ%E6%8E%A7%E5%88%B6%E5%8F%B0%E6%9F%A5%E7%9C%8B%E6%B6%88%E6%81%AF%E7%BB%93%E6%9E%84.png" alt="RabbitMQ控制台查看消息结构" style="zoom: 80%;">

<p>对比发现数据体积小了很多。</p>
<h3 id="3-9-3-消费者接收Object"><a href="#3-9-3-消费者接收Object" class="headerlink" title="3.9.3 消费者接收Object"></a>3.9.3 消费者接收Object</h3><p>我们在consumer服务中定义一个新的消费者，publisher是用 Map 发送，那么消费者也一定要用 Map 接收，格式如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RabbitListener(queues = &quot;object.queue&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listenSimpleQueueMessage</span><span class="params">(Map&lt;String, Object&gt; msg)</span> &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;消费者接收到object.queue消息：【&quot;</span> + msg + <span class="string">&quot;】&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>会发现接收第一条消息报错，第二条消息正常。但是回到 RabbitMQ 控制台发现第一条消息消失了，说明第一条消息丢失了。</p>
<p>怎么解决呢？</p>
<p>请参考文章 <code>RabbitMQ高级</code> 😁</p>
]]></content>
      <categories>
        <category>MQ</category>
      </categories>
      <tags>
        <tag>RabbitMQ</tag>
      </tags>
  </entry>
  <entry>
    <title>Docker教程</title>
    <url>/posts/24889/</url>
    <content><![CDATA[<p>Docker 官网：<a href="https://www.docker.com/">https://www.docker.com</a></p>
<p>参考视频：<a href="https://www.bilibili.com/video/BV1HP4118797/">黑马程序员Docker快速入门到项目部署，MySQL部署+Nginx部署+docker自定义镜像+DockerCompose项目实战一套搞定</a></p>
<h1 id="1-初识-Docker"><a href="#1-初识-Docker" class="headerlink" title="1. 初识 Docker"></a>1. 初识 Docker</h1><h2 id="1-1-什么是-Docker"><a href="#1-1-什么是-Docker" class="headerlink" title="1.1 什么是 Docker"></a>1.1 什么是 Docker</h2><p>Docker 是一个开源的应用容器引擎，它可以让开发者打包他们的应用以及依赖包到一个可移植的容器中，然后发布到任何 Linux 机器上，也可以实现虚拟化。容器是完全使用沙箱机制，相互之间没有任何接口(类似 iPhon e的 app)，几乎没有性能开销，可以很容易地在机器和数据中心中运行。最重要的是，容器性能开销极低。</p>
<p>Docker 的主要特点包括：</p>
<ul>
<li><strong>轻量级与可移植性</strong>：Docker 容器是基于 Linux 内核的虚拟化技术，不依赖于特定的硬件架构或操作系统。因此，它可以轻松地从一个环境迁移到另一个环境，实现应用的快速部署和扩展。</li>
<li><strong>版本控制</strong>：Docker 允许开发者像管理代码一样管理基础设施。这意味着可以使用版本控制工具(如 Git)来跟踪容器的变更历史，确保每次变更都是可追踪和可重复的。</li>
<li><strong>隔离性</strong>：每个 Docker 容器都运行在自己的命名空间中，拥有独立的文件系统、网络栈和进程空间。这种隔离性确保了容器之间的安全性，防止了潜在的冲突和干扰。</li>
<li><strong>自动化与编排</strong>：Docker 与各种自动化工具和编排平台(如 Kubernetes、Docker Swarm 等)集成，可以轻松地实现容器的自动化部署、扩展和管理。</li>
<li><strong>丰富的生态系统</strong>：Docker 拥有庞大的用户群体和丰富的生态系统，包括大量的官方和第三方镜像、插件和工具。这使得开发者可以轻松地找到所需的资源，加速应用的开发和部署过程。</li>
</ul>
<p>总的来说，Docker 提供了一种高效、可靠和灵活的方式来构建、部署和管理应用。它简化了应用的开发和运维过程，降低了成本，提高了效率。无论是个人开发者还是大型企业，都可以从 Docker 中受益。</p>
<h2 id="1-2-Docker-和虚拟机的区别"><a href="#1-2-Docker-和虚拟机的区别" class="headerlink" title="1.2 Docker 和虚拟机的区别"></a>1.2 Docker 和虚拟机的区别</h2><p>Docker 可以让一个应用在任何操作系统中非常方便的运行。而以前我们接触的虚拟机，也能在一个操作系统中，运行另外一个操作系统，保护系统中的任何应用。两者有什么差异呢？</p>
<p><strong>虚拟机</strong>(virtual machine)是在操作系统中<strong>模拟</strong>硬件设备，然后运行另一个操作系统，比如在 Windows 系统里面运行 Ubuntu 系统，这样就可以运行任意的Ubuntu应用了。</p>
<p><strong>Docker</strong>仅仅是封装函数库，并没有模拟完整的操作系统，如图：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/Docker/Docker%E5%92%8C%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%9A%84%E5%8C%BA%E5%88%AB.png" style="zoom: 33%;">

<p>对比来看：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/Docker/Docker%E5%92%8C%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%9A%84%E7%89%B9%E5%BE%81.png" style="zoom:50%;">

<p><strong>小结</strong></p>
<p>Docker 和虚拟机的差异：</p>
<ul>
<li><p>Docker 是一个系统进程；虚拟机是在操作系统中的操作系统</p>
</li>
<li><p>Docker 体积小、启动速度快、性能好；虚拟机体积大、启动速度慢、性能一般</p>
</li>
</ul>
<h2 id="1-3-Docker架构"><a href="#1-3-Docker架构" class="headerlink" title="1.3 Docker架构"></a>1.3 Docker架构</h2><h3 id="1-3-1-镜像-Image-和容器-Container"><a href="#1-3-1-镜像-Image-和容器-Container" class="headerlink" title="1.3.1 镜像(Image)和容器(Container)"></a>1.3.1 镜像(Image)和容器(Container)</h3><p>Docker 中有几个重要的概念：</p>
<p><strong>镜像</strong>：Docker将应用程序及其所需的依赖、函数库、环境、配置等文件打包在一起，称为镜像。</p>
<p><strong>容器</strong>：镜像中的应用程序运行后形成的进程就是<strong>容器</strong>，只是Docker会给容器进程做隔离，对外不可见。</p>
<p>一切应用最终都是代码组成，都是硬盘中的一个个的字节形成的<strong>文件</strong>。只有运行时，才会加载到内存，形成进程。</p>
<p><strong>镜像</strong>就是把一个应用在硬盘上的文件、及其运行环境、部分系统函数库文件一起打包形成的文件包。这个文件包是只读的。</p>
<p><strong>容器</strong>就是将这些文件中编写的程序、函数加载到内存中允许，形成进程，只不过要隔离起来。因此一个镜像可以启动多次，形成多个容器进程。</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/Docker/Docker%E9%95%9C%E5%83%8F%E5%92%8C%E5%AE%B9%E5%99%A8.png" style="zoom: 33%;">

<p>例如你下载了一个QQ，如果我们将QQ在磁盘上的运行<strong>文件</strong>及其运行的操作系统依赖打包，形成QQ镜像。然后你可以启动多次，双开、甚至三开QQ，跟多个妹子聊天。😎</p>
<h3 id="1-3-2-DockerHub"><a href="#1-3-2-DockerHub" class="headerlink" title="1.3.2 DockerHub"></a>1.3.2 DockerHub</h3><p>开源应用程序非常多，打包这些应用往往是重复的劳动。为了避免这些重复劳动，人们就会将自己打包的应用镜像，例如 Redis、MySQL 镜像放到网络上，共享使用，就像 GitHub 的代码共享一样。</p>
<p>Docker 官方提供了一个专门管理、存储镜像的网站，并对外开放了镜像上传、下载的权利。Docker 官方提供了一些基础镜像，然后各大软件公司又在基础镜像基础上，制作了自家软件的镜像，全部都存放在这个网站。这个网站就成了 Docker 镜像交流的社区：<a href="https://hub.docker.com/">https://hub.docker.com/</a></p>
<ul>
<li><p>DockerHub：DockerHub 是一个官方的 Docker 镜像的托管平台。这样的平台称为 Docker Registry。</p>
</li>
<li><p>国内也有类似于 DockerHub 的公开服务，比如 <a href="https://c.163yun.com/hub">网易云镜像服务</a>、<a href="https://cr.console.aliyun.com/">阿里云镜像库</a>等。</p>
</li>
</ul>
<p>我们一方面可以将自己的镜像共享到 DockerHub，另一方面也可以从 DockerHub 拉取镜像：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/Docker/DockerHub%E4%B8%8A%E4%BC%A0%E4%B8%8E%E6%8B%89%E5%8F%96%E9%95%9C%E5%83%8F.png" style="zoom: 25%;">

<h3 id="1-3-3-Docker架构"><a href="#1-3-3-Docker架构" class="headerlink" title="1.3.3 Docker架构"></a>1.3.3 Docker架构</h3><p>Docker 是一个 CS 架构的程序，由两部分组成：</p>
<ul>
<li><p>服务端(server)：Docker 守护进程，负责处理 Docker 指令，管理镜像、容器等</p>
</li>
<li><p>客户端(client)：通过命令或RestAPI向Docker服务端发送指令。可以在本地或远程向服务端发送指令</p>
</li>
</ul>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/Docker/Docker%E6%9E%B6%E6%9E%84.png" style="zoom: 50%;">

<h1 id="2-快速入门"><a href="#2-快速入门" class="headerlink" title="2. 快速入门"></a>2. 快速入门</h1><h2 id="2-1-安装-Docker"><a href="#2-1-安装-Docker" class="headerlink" title="2.1 安装 Docker"></a>2.1 安装 Docker</h2><p>Docker 分为 CE 和 EE 两大版本。CE 即社区版（免费，支持周期 7 个月），EE 即企业版，强调安全，付费使用，支持周期 24 个月。</p>
<p>Docker CE 分为 <code>stable</code> <code>test</code> 和 <code>nightly</code> 三个更新频道。</p>
<p>官方网站上有各种环境下的 <a href="https://docs.docker.com/install/">安装指南</a>，这里主要介绍 Docker CE 在 CentOS上的安装。</p>
<p>1、卸载旧版</p>
<p>首先如果系统中已经存在旧的 Docker，则先卸载：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">yum remove docker \</span><br><span class="line">    docker-client \</span><br><span class="line">    docker-client-latest \</span><br><span class="line">    docker-common \</span><br><span class="line">    docker-latest \</span><br><span class="line">    docker-latest-logrotate \</span><br><span class="line">    docker-logrotate \</span><br><span class="line">    docker-engine</span><br></pre></td></tr></table></figure>

<p>2、配置Docker的 yum 库</p>
<p>首先要安装一个 yum 工具</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">yum install -y yum-utils</span><br></pre></td></tr></table></figure>

<p>安装成功后，执行命令，配置 Docker 的 yum 源：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo</span><br></pre></td></tr></table></figure>

<p>3、安装 Docker</p>
<p>最后，执行命令，安装 Docker</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">yum install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin</span><br></pre></td></tr></table></figure>

<p>4、启动和校验</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动Docker</span></span><br><span class="line">systemctl start docker</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">停止Docker</span></span><br><span class="line">systemctl stop docker</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">重启</span></span><br><span class="line">systemctl restart docker</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置开机自启</span></span><br><span class="line">systemctl enable docker</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">执行docker ps命令，如果不报错，说明安装启动成功</span></span><br><span class="line">docker ps</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看 Docekr 版本</span></span><br><span class="line">docker -v</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">返回如下信息</span></span><br><span class="line">Docker version 26.0.0, build 2ae903e</span><br></pre></td></tr></table></figure>

<p>5、配置镜像加速</p>
<p>这里以阿里云镜像加速为例。</p>
<p>(1) 注册阿里云账号</p>
<p>首先访问<a href="https://www.aliyun.com/">阿里云网站</a>注册一个账号。</p>
<p>(2) 开通镜像服务</p>
<p>在首页的产品中，找到阿里云的<strong>容器镜像服务</strong>：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/Docker/Docker%E9%85%8D%E7%BD%AE%E9%98%BF%E9%87%8C%E4%BA%91%E9%95%9C%E5%83%8F(1).png" style="zoom: 67%;">

<p>点击后进入控制台：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/Docker/Docker%E9%85%8D%E7%BD%AE%E9%98%BF%E9%87%8C%E4%BA%91%E9%95%9C%E5%83%8F(2).png" style="zoom:67%;">

<p>(3) 配置镜像加速</p>
<p>找到<strong>镜像工具</strong>下的<strong>镜像加速器</strong>：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/Docker/Docker%E9%85%8D%E7%BD%AE%E9%98%BF%E9%87%8C%E4%BA%91%E9%95%9C%E5%83%8F(3).png" style="zoom: 80%;">

<p>页面向下滚动，即可找到配置的文档说明：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/Docker/Docker%E9%85%8D%E7%BD%AE%E9%98%BF%E9%87%8C%E4%BA%91%E9%95%9C%E5%83%8F(4).png" style="zoom: 80%;">

<p>具体命令如下：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建目录</span></span><br><span class="line">mkdir -p /etc/docker</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">复制内容，注意把其中的镜像加速地址改成你自己的</span></span><br><span class="line">tee /etc/docker/daemon.json &lt;&lt;-&#x27;EOF&#x27;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;registry-mirrors&quot;: [&quot;https://xxxx.mirror.aliyuncs.com&quot;]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">重新加载配置</span></span><br><span class="line">systemctl daemon-reload</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">重启Docker</span></span><br><span class="line">systemctl restart docker</span><br></pre></td></tr></table></figure>

<h2 id="2-2-部署-MySQL"><a href="#2-2-部署-MySQL" class="headerlink" title="2.2 部署 MySQL"></a>2.2 部署 MySQL</h2><p>首先，我们利用 Docker 来安装一个 MySQL 软件，大家可以对比一下之前传统的安装方式，看看哪个效率更高一些。</p>
<p>如果是利用传统方式部署 MySQL，大概的步骤有：</p>
<ul>
<li>搜索并下载 MySQL 安装包</li>
<li>上传至Linux环境</li>
<li>编译和配置环境</li>
<li>安装</li>
</ul>
<p>而使用 Docker 安装，仅仅需要一步即可，在命令行输入下面的命令(建议采用 CV 大法)：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker run -d \</span><br><span class="line">  --name mysql \</span><br><span class="line">  -p 3306:3306 \</span><br><span class="line">  -e TZ=Asia/Shanghai \</span><br><span class="line">  -e MYSQL_ROOT_PASSWORD=123 \</span><br><span class="line">  mysql</span><br></pre></td></tr></table></figure>

<p>运行效果如图：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/Docker/Docker%E9%83%A8%E7%BD%B2MySQL.png" style="zoom: 67%;">

<p>MySQL 安装完毕！通过任意客户端工具即可连接到 MySQL。</p>
<p>大家可以发现，当我们执行命令后，Docker 做的第一件事情，是去自动搜索并下载了 MySQL，然后会自动运行 MySQL，我们完全不用插手，非常方便。而且，这种安装方式你完全不用考虑运行的操作系统环境。</p>
<p><font color="red">PS：这里下载的不是安装包，而是<strong>镜像。</strong></font>😀 镜像中不仅包含了 MySQL 本身，还包含了其运行所需要的环境、配置、系统级函数库。因此它在运行时就有自己独立的环境，就可以跨系统运行，也不需要手动再次配置环境了。这套独立运行的隔离环境我们称为<strong>容器</strong>。</p>
<p>因此，Docker 安装软件的过程，就是自动搜索下载镜像，然后创建并运行容器的过程。😏😏Docker 会根据命令中的镜像名称去 DockerHub 自动搜索并下载镜像。</p>
<p><strong>总结</strong>：</p>
<p>Docker 本身包含一个后台服务，我们可以利用 Docker 命令告诉 Docker 服务，帮助我们快速部署指定的应用。Docker 服务部署应用时，首先要去搜索并下载应用对应的镜像，然后根据镜像创建并允许容器，应用就部署完成了。</p>
<h2 id="2-3-命令解读"><a href="#2-3-命令解读" class="headerlink" title="2.3 命令解读"></a>2.3 命令解读</h2><p>利用 Docker 快速的安装了 MySQL，非常的方便，不过我们执行的命令到底是什么意思呢？</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker run -d \</span><br><span class="line">  --name mysql \</span><br><span class="line">  -p 3306:3306 \</span><br><span class="line">  -e TZ=Asia/Shanghai \</span><br><span class="line">  -e MYSQL_ROOT_PASSWORD=123 \</span><br><span class="line">  mysql</span><br></pre></td></tr></table></figure>

<p>解读：</p>
<ul>
<li><code>docker run -d</code> ：创建并运行一个容器，<code>-d</code>则是让容器以后台进程运行</li>
<li><code>--name mysql </code> : 给容器起个名字叫<code>mysql</code>，你可以叫别的</li>
<li><code>-p 3306:3306</code> : 设置端口映射。<ul>
<li><strong>容器是隔离环境</strong>，外界不可访问。但是可以<strong>将宿主机端口映射容器内到端口</strong>，当访问宿主机指定端口时，就是在访问容器内的端口了。</li>
<li>容器内端口往往是由容器内的进程决定，例如 MySQL 进程默认端口是 3306，因此容器内端口一定是 3306；而宿主机端口则可以任意指定，一般与容器内保持一致。</li>
<li>格式： <code>-p 宿主机端口:容器内端口</code>，示例中就是将宿主机的 3306 映射到容器内的3306端口</li>
</ul>
</li>
<li><code>-e TZ=Asia/Shanghai</code> : 配置容器内进程运行时的一些参数<ul>
<li>格式：<code>-e KEY=VALUE</code>，KEY 和 VALUE 都由容器内进程决定</li>
<li>案例中，<code>TZ=Asia/Shanghai</code>是设置时区；<code>MYSQL_ROOT_PASSWORD=123</code>是设置 MySQL 默认密码</li>
</ul>
</li>
<li><code>mysql</code> : 设置<strong>镜像</strong>名称，Docker 会根据这个名字搜索并下载镜像<ul>
<li>格式：<code>REPOSITORY:TAG</code>，例如<code>mysql:8.0</code>，其中<code>REPOSITORY</code>可以理解为镜像名，<code>TAG</code>是版本号</li>
<li>在未指定<code>TAG</code>的情况下，默认是最新版本，也就是<code>mysql:latest</code></li>
</ul>
</li>
</ul>
<p>镜像的名称<font color="red">不是随意的</font>，而是要到 DockerRegistry 中寻找，镜像运行时的配置<font color="red">也不是随意的</font>，要参考镜像的帮助文档，这些在DockerHub 网站或者软件的官方网站中都能找到。</p>
<p>如果我们要安装其它软件，也可以到 DockerRegistry 中寻找对应的镜像名称和版本，阅读相关配置即可。</p>
<h1 id="3-Docker-基础"><a href="#3-Docker-基础" class="headerlink" title="3. Docker 基础"></a>3. Docker 基础</h1><p> Docker 使用的一些基础知识。具体用法可以参考 Docker 官方文档：<a href="https://docs.docker.com/">https://docs.docker.com/</a></p>
<h2 id="3-1-镜像操作"><a href="#3-1-镜像操作" class="headerlink" title="3.1 镜像操作"></a>3.1 镜像操作</h2><h3 id="3-1-1-镜像名称"><a href="#3-1-1-镜像名称" class="headerlink" title="3.1.1 镜像名称"></a>3.1.1 镜像名称</h3><p>首先来看下镜像的名称组成：</p>
<ul>
<li>镜名称一般分两部分组成：[repository]:[tag]</li>
<li>在没有指定 tag 时，默认是 latest，代表最新版本的镜像</li>
</ul>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/Docker/Docker%E9%95%9C%E5%83%8F%E5%90%8D%E7%A7%B0.png" style="zoom: 50%;">

<h3 id="3-1-2-镜像相关命令"><a href="#3-1-2-镜像相关命令" class="headerlink" title="3.1.2 镜像相关命令"></a>3.1.2 镜像相关命令</h3><p>常见的镜像操作命令：</p>
<table>
<thead>
<tr>
<th align="center"><strong>命令</strong></th>
<th align="center"><strong>说明</strong></th>
<th align="center"><strong>文档地址</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="center">docker pull</td>
<td align="center">拉取镜像</td>
<td align="center"><a href="https://docs.docker.com/engine/reference/commandline/pull/">docker pull</a></td>
</tr>
<tr>
<td align="center">docker push</td>
<td align="center">推送镜像到DockerRegistry</td>
<td align="center"><a href="https://docs.docker.com/engine/reference/commandline/push/">docker push</a></td>
</tr>
<tr>
<td align="center">docker images</td>
<td align="center">查看本地镜像</td>
<td align="center"><a href="https://docs.docker.com/engine/reference/commandline/images/">docker images</a></td>
</tr>
<tr>
<td align="center">docker rmi</td>
<td align="center">删除本地镜像</td>
<td align="center"><a href="https://docs.docker.com/engine/reference/commandline/rmi/">docker rmi</a></td>
</tr>
<tr>
<td align="center">docker save</td>
<td align="center">保存镜像到本地压缩文件</td>
<td align="center"><a href="https://docs.docker.com/engine/reference/commandline/save/">docker save</a></td>
</tr>
<tr>
<td align="center">docker load</td>
<td align="center">加载本地压缩文件到镜像</td>
<td align="center"><a href="https://docs.docker.com/engine/reference/commandline/load/">docker load</a></td>
</tr>
</tbody></table>
<p>用一副图来表示这些命令的关系：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/Docker/Docker%E9%95%9C%E5%83%8F%E5%91%BD%E4%BB%A4%E5%85%B3%E7%B3%BB%E5%9B%BE.png" style="zoom: 33%;">

<blockquote>
<p>演示</p>
</blockquote>
<p>1、去 DockerHub 查看 nginx 镜像仓库及相关信息</p>
<p>2、拉取Nginx镜像</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker pull nginx</span><br></pre></td></tr></table></figure>

<p>3、查看镜像</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker images</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">REPOSITORY   TAG       IMAGE ID       CREATED        SIZE</span><br><span class="line">mysql        latest    82563e0cbf18   45 hours ago   632MB</span><br><span class="line">nginx        latest    92b11f67642b   6 weeks ago    187MB</span><br></pre></td></tr></table></figure>

<p>4、将 nginx 镜像导出磁盘</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">利用docker xx --<span class="built_in">help</span>命令可以查看docker save和docker load的语法，例如，查看save命令用法，可以输入命令：</span></span><br><span class="line">docker save --help</span><br></pre></td></tr></table></figure>

<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/Docker/docker%20save%E5%91%BD%E4%BB%A4%E7%94%A8%E6%B3%95.png"></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">命令格式</span></span><br><span class="line">docker save -o [保存的目标文件名称] [镜像名称]</span><br></pre></td></tr></table></figure>

<p>5、将 nginx 镜像导出磁盘</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker save -o nginx.tar nginx:latest</span><br></pre></td></tr></table></figure>

<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/Docker/%E5%B0%86nginx%E9%95%9C%E5%83%8F%E5%AF%BC%E5%87%BA%E7%A3%81%E7%9B%98.png"></p>
<p>6、使用 load 加载镜像</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">先删除本地的nginx镜像</span></span><br><span class="line">docker rmi nginx:latest</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">然后运行命令，加载本地文件</span></span><br><span class="line">docker load -i nginx.tar</span><br></pre></td></tr></table></figure>

<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/Docker/%E4%BD%BF%E7%94%A8docker%20load%E5%8A%A0%E8%BD%BD%E9%95%9C%E5%83%8F.png">

<h2 id="3-2-容器操作"><a href="#3-2-容器操作" class="headerlink" title="3.2 容器操作"></a>3.2 容器操作</h2><h3 id="3-2-1-容器相关命令"><a href="#3-2-1-容器相关命令" class="headerlink" title="3.2.1 容器相关命令"></a>3.2.1 容器相关命令</h3><p>常见的容器操作命令：</p>
<table>
<thead>
<tr>
<th align="center"><strong>命令</strong></th>
<th align="center"><strong>说明</strong></th>
<th align="center"><strong>文档地址</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="center">docker run</td>
<td align="center">创建并运行容器(不能重复创建)</td>
<td align="center"><a href="https://docs.docker.com/engine/reference/commandline/run/">docker run</a></td>
</tr>
<tr>
<td align="center">docker stop</td>
<td align="center">停止指定容器</td>
<td align="center"><a href="https://docs.docker.com/engine/reference/commandline/stop/">docker stop</a></td>
</tr>
<tr>
<td align="center">docker start</td>
<td align="center">启动指定容器</td>
<td align="center"><a href="https://docs.docker.com/engine/reference/commandline/start/">docker start</a></td>
</tr>
<tr>
<td align="center">docker restart</td>
<td align="center">重新启动容器</td>
<td align="center"><a href="https://docs.docker.com/engine/reference/commandline/restart/">docker restart</a></td>
</tr>
<tr>
<td align="center">docker rm</td>
<td align="center">删除指定容器</td>
<td align="center"><a href="https://docs.docker.com/engine/reference/commandline/rm/">docs.docker.com</a></td>
</tr>
<tr>
<td align="center">docker ps</td>
<td align="center">查看容器</td>
<td align="center"><a href="https://docs.docker.com/engine/reference/commandline/ps/">docker ps</a></td>
</tr>
<tr>
<td align="center">docker logs</td>
<td align="center">查看容器运行日志</td>
<td align="center"><a href="https://docs.docker.com/engine/reference/commandline/logs/">docker logs</a></td>
</tr>
<tr>
<td align="center">docker exec</td>
<td align="center">进入容器</td>
<td align="center"><a href="https://docs.docker.com/engine/reference/commandline/exec/">docker exec</a></td>
</tr>
<tr>
<td align="center">docker inspect</td>
<td align="center">查看容器详细信息</td>
<td align="center"><a href="https://docs.docker.com/engine/reference/commandline/inspect/">docker inspect</a></td>
</tr>
</tbody></table>
<p>用一副图来表示这些命令的关系：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/Docker/Docker%E5%AE%B9%E5%99%A8%E5%91%BD%E4%BB%A4%E5%85%B3%E7%B3%BB%E5%9B%BE.png" style="zoom: 33%;">

<p>容器保护三个状态：</p>
<ul>
<li>运行：进程正常运行</li>
<li>暂停：进程暂停，CPU 不再运行，并不释放内存</li>
<li>停止：进程终止，回收进程占用的内存、CPU 等资源</li>
</ul>
<blockquote>
<p>演示</p>
</blockquote>
<p>1、创建并运行 nginx 容器的命令：</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment">#创建并运行Nginx容器</span></span><br><span class="line">docker run -d --name nginx -p 80:80 nginx</span><br></pre></td></tr></table></figure>

<p>创建成功后会返回一串数字：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">f37101c8fff6fddcc5fa8207a53af1799a281a6b26fc2cc4139964b5f73fc05e</span><br></pre></td></tr></table></figure>

<p>命令解读：</p>
<ul>
<li><code>docker run</code> ：创建并运行一个容器</li>
<li><code>-d</code>：后台运行容器</li>
<li><code>--name</code> : 给容器起一个名字，比如叫做 nginx</li>
<li><code>-p</code> ：将宿主机端口与容器端口映射，冒号左侧是宿主机端口，右侧是容器端口</li>
<li><code>nginx</code>：镜像名称，例如nginx</li>
</ul>
<p>这里的 <code>-p</code> 参数，是将容器端口映射到宿主机端口。</p>
<p>默认情况下，容器是隔离环境，我们直接访问宿主机的 80 端口，肯定访问不到容器中的 nginx。</p>
<p>现在，将容器的 80 与宿主机的 80 关联起来，当我们访问宿主机的 80 端口时，就会被映射到容器的 80，这样就能访问到 nginx 了。</p>
<p>2、查看容器是否运行</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看运行中容器</span></span><br><span class="line">docker ps</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">也可以加格式化方式访问，格式会更加清爽</span></span><br><span class="line">docker ps --format &quot;table &#123;&#123;.ID&#125;&#125;\t&#123;&#123;.Image&#125;&#125;\t&#123;&#123;.Ports&#125;&#125;\t&#123;&#123;.Status&#125;&#125;\t&#123;&#123;.Names&#125;&#125;&quot;</span><br></pre></td></tr></table></figure>

<p>格式化后查看到 nginx，说明已经运行：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">CONTAINER ID   IMAGE     PORTS                                                  STATUS         NAMES</span><br><span class="line">f37101c8fff6   nginx     0.0.0.0:80-&gt;80/tcp, :::80-&gt;80/tcp                      Up 2 minutes   nginx</span><br><span class="line">9e617ee3fdb5   mysql     0.0.0.0:3306-&gt;3306/tcp, :::3306-&gt;3306/tcp, 33060/tcp   Up 2 hours     mysql</span><br></pre></td></tr></table></figure>

<p>3、停掉容器</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker stop nginx</span><br></pre></td></tr></table></figure>

<p>4、停掉容器后再次执行 <code>docker ps</code> 就看不到 nginx 了，需要使用 <code>-a</code> 参数查看所有容器</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看所有容器</span></span><br><span class="line">docker ps -a --format &quot;table &#123;&#123;.ID&#125;&#125;\t&#123;&#123;.Image&#125;&#125;\t&#123;&#123;.Ports&#125;&#125;\t&#123;&#123;.Status&#125;&#125;\t&#123;&#123;.Names&#125;&#125;&quot;</span><br></pre></td></tr></table></figure>

<p>可以发现 nginx 的 <code>STATUS</code> 变为了 <code>Exited (0)</code> ，表示已经停掉</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">CONTAINER ID   IMAGE     PORTS                                                  STATUS                     NAMES</span><br><span class="line">f37101c8fff6   nginx                                                            Exited (0) 2 minutes ago   nginx</span><br><span class="line">9e617ee3fdb5   mysql     0.0.0.0:3306-&gt;3306/tcp, :::3306-&gt;3306/tcp, 33060/tcp   Up 2 hours                 mysql</span><br></pre></td></tr></table></figure>

<p>5、启动 nginx 容器，再次执行 <code>docker ps</code> 查看运行中容器就会发现 nginx 又运行起来了。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动nginx容器</span></span><br><span class="line">docker start nginx</span><br></pre></td></tr></table></figure>

<p>6、查看 nginx 容器日志</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker logs nginx  </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">可以加 -f 参数，一直查看日志</span></span><br><span class="line">docker logs -f nginx</span><br></pre></td></tr></table></figure>

<p>7、进入容器</p>
<p>(1) 进入我们刚刚创建的 nginx 容器：</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> -it nginx bash</span><br></pre></td></tr></table></figure>

<p>命令解读：</p>
<ul>
<li><p><code>docker exec</code> ：进入容器内部，执行一个命令</p>
</li>
<li><p><code>-it</code> : 给当前进入的容器创建一个标准输入、输出终端，允许我们与容器交互</p>
</li>
<li><p><code>nginx</code> ：要进入的容器的名称</p>
</li>
<li><p><code>bash</code> ：进入容器后执行的命令，bash是一个linux终端交互命令</p>
</li>
</ul>
<p>进入 nginx 的 HTML 所在目录 &#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html，容器内部会模拟一个独立的 Linux 文件系统，看起来如同一个 Linux 服务器一样。nginx 的环境、配置、运行文件全部都在这个文件系统中，包括我们要修改的 html 文件。</p>
<p>(2) 查看 DockerHub 网站中的 nginx 页面，可以知道 nginx 的 html 目录位置在 <code>/usr/share/nginx/html</code></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">进入目录</span></span><br><span class="line">cd /usr/share/nginx/html</span><br></pre></td></tr></table></figure>

<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/Docker/nginx%E7%9A%84html%E7%9B%AE%E5%BD%95%E5%9C%A8%E5%AE%B9%E5%99%A8%E4%B8%AD%E7%9A%84%E4%BD%8D%E7%BD%AE.png"></p>
<p>(3) 修改 index.html 的内容</p>
<p>容器内没有 vi 命令，无法直接修改，我们用下面的命令来修改：</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">sed -i -e <span class="string">&#x27;s#Welcome to nginx#木又枯了#g&#x27;</span> -e <span class="string">&#x27;s#&lt;head&gt;#&lt;head&gt;&lt;meta charset=&quot;utf-8&quot;&gt;#g&#x27;</span> index.html</span><br></pre></td></tr></table></figure>

<p>在浏览器访问自己的虚拟机地址，例如我的是：<a href="http://192.168.88.132，即可看到结果：">http://192.168.88.132，即可看到结果：</a></p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/Docker/%E4%BF%AE%E6%94%B9%E5%90%8E%E7%9A%84nginx%E9%A1%B5%E9%9D%A2.png"></p>
<p>8、删除容器</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除容器</span></span><br><span class="line">docker rm nginx</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">发现无法删除，因为容器运行中，强制删除容器</span></span><br><span class="line">docker rm -f nginx</span><br></pre></td></tr></table></figure>

<h2 id="3-3-常见命令总结"><a href="#3-3-常见命令总结" class="headerlink" title="3.3 常见命令总结"></a>3.3 常见命令总结</h2><p>Docker 中的常见命令，可以参考官方文档：<a href="https://docs.docker.com/engine/reference/commandline/cli/">https://docs.docker.com/engine/reference/commandline/cli/</a></p>
<h3 id="3-3-1-命令介绍"><a href="#3-3-1-命令介绍" class="headerlink" title="3.3.1 命令介绍"></a>3.3.1 命令介绍</h3><p>其中，比较常见的命令有：</p>
<table>
<thead>
<tr>
<th align="center"><strong>命令</strong></th>
<th align="center"><strong>说明</strong></th>
<th align="center"><strong>文档地址</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="center">docker pull</td>
<td align="center">拉取镜像</td>
<td align="center"><a href="https://docs.docker.com/engine/reference/commandline/pull/">docker pull</a></td>
</tr>
<tr>
<td align="center">docker push</td>
<td align="center">推送镜像到DockerRegistry</td>
<td align="center"><a href="https://docs.docker.com/engine/reference/commandline/push/">docker push</a></td>
</tr>
<tr>
<td align="center">docker images</td>
<td align="center">查看本地镜像</td>
<td align="center"><a href="https://docs.docker.com/engine/reference/commandline/images/">docker images</a></td>
</tr>
<tr>
<td align="center">docker rmi</td>
<td align="center">删除本地镜像</td>
<td align="center"><a href="https://docs.docker.com/engine/reference/commandline/rmi/">docker rmi</a></td>
</tr>
<tr>
<td align="center">docker run</td>
<td align="center">创建并运行容器(不能重复创建)</td>
<td align="center"><a href="https://docs.docker.com/engine/reference/commandline/run/">docker run</a></td>
</tr>
<tr>
<td align="center">docker stop</td>
<td align="center">停止指定容器</td>
<td align="center"><a href="https://docs.docker.com/engine/reference/commandline/stop/">docker stop</a></td>
</tr>
<tr>
<td align="center">docker start</td>
<td align="center">启动指定容器</td>
<td align="center"><a href="https://docs.docker.com/engine/reference/commandline/start/">docker start</a></td>
</tr>
<tr>
<td align="center">docker restart</td>
<td align="center">重新启动容器</td>
<td align="center"><a href="https://docs.docker.com/engine/reference/commandline/restart/">docker restart</a></td>
</tr>
<tr>
<td align="center">docker rm</td>
<td align="center">删除指定容器</td>
<td align="center"><a href="https://docs.docker.com/engine/reference/commandline/rm/">docs.docker.com</a></td>
</tr>
<tr>
<td align="center">docker ps</td>
<td align="center">查看容器</td>
<td align="center"><a href="https://docs.docker.com/engine/reference/commandline/ps/">docker ps</a></td>
</tr>
<tr>
<td align="center">docker logs</td>
<td align="center">查看容器运行日志</td>
<td align="center"><a href="https://docs.docker.com/engine/reference/commandline/logs/">docker logs</a></td>
</tr>
<tr>
<td align="center">docker exec</td>
<td align="center">进入容器</td>
<td align="center"><a href="https://docs.docker.com/engine/reference/commandline/exec/">docker exec</a></td>
</tr>
<tr>
<td align="center">docker save</td>
<td align="center">保存镜像到本地压缩文件</td>
<td align="center"><a href="https://docs.docker.com/engine/reference/commandline/save/">docker save</a></td>
</tr>
<tr>
<td align="center">docker load</td>
<td align="center">加载本地压缩文件到镜像</td>
<td align="center"><a href="https://docs.docker.com/engine/reference/commandline/load/">docker load</a></td>
</tr>
<tr>
<td align="center">docker inspect</td>
<td align="center">查看容器详细信息</td>
<td align="center"><a href="https://docs.docker.com/engine/reference/commandline/inspect/">docker inspect</a></td>
</tr>
</tbody></table>
<p>用一副图来表示这些命令的关系：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/Docker/Docker%E5%B8%B8%E8%A7%81%E5%91%BD%E4%BB%A4%E5%85%B3%E7%B3%BB%E5%9B%BE.png"></p>
<p>PS：默认情况下，每次重启虚拟机我们都需要手动启动 Docker 和 Docker 中的容器。通过命令可以实现开机自启：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Docker开机自启</span></span><br><span class="line">systemctl enable docker</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Docker容器开机自启</span></span><br><span class="line">docker update --restart=always [容器名/容器id]</span><br></pre></td></tr></table></figure>

<h3 id="3-3-2-命令别名"><a href="#3-3-2-命令别名" class="headerlink" title="3.3.2 命令别名"></a>3.3.2 命令别名</h3><p>给常用 Docker 命令起别名，方便我们访问：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改/root/.bashrc文件</span></span><br><span class="line">vi /root/.bashrc</span><br></pre></td></tr></table></figure>

<p>内容如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># .bashrc</span><br><span class="line"></span><br><span class="line"># User specific aliases and functions</span><br><span class="line"></span><br><span class="line">alias rm=&#x27;rm -i&#x27;</span><br><span class="line">alias cp=&#x27;cp -i&#x27;</span><br><span class="line">alias mv=&#x27;mv -i&#x27;</span><br><span class="line">alias dps=&#x27;docker ps --format &quot;table &#123;&#123;.ID&#125;&#125;\t&#123;&#123;.Image&#125;&#125;\t&#123;&#123;.Ports&#125;&#125;\t&#123;&#123;.Status&#125;&#125;\t&#123;&#123;.Names&#125;&#125;&quot;&#x27;</span><br><span class="line">alias dis=&#x27;docker images&#x27;</span><br><span class="line"></span><br><span class="line"># Source global definitions</span><br><span class="line">if [ -f /etc/bashrc ]; then</span><br><span class="line">        . /etc/bashrc</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>

<p>然后，执行命令使别名生效</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">source /root/.bashrc</span><br></pre></td></tr></table></figure>

<p>接下来，试试看新的命令吧。</p>
<h2 id="3-4-数据卷-volume"><a href="#3-4-数据卷-volume" class="headerlink" title="3.4 数据卷(volume)"></a>3.4 数据卷(volume)</h2><p>容器是隔离环境，容器内程序的文件、配置、运行时产生的容器都在容器内部，我们要读写容器内的文件非常不方便。大家思考几个问题：</p>
<ul>
<li>如果要升级 MySQL 版本，需要销毁旧容器，那么数据岂不是跟着被销毁了？</li>
<li>MySQL、Nginx 容器运行后，如果我要修改其中的某些配置该怎么办？</li>
<li>我想要让 Nginx 代理我的静态资源怎么办？</li>
</ul>
<p>因此，容器提供程序的运行环境，但是<strong>程序运行产生的数据、程序运行依赖的配置都应该与容器解耦</strong>。</p>
<h3 id="3-4-1-什么是数据卷"><a href="#3-4-1-什么是数据卷" class="headerlink" title="3.4.1 什么是数据卷"></a>3.4.1 什么是数据卷</h3><p><strong>数据卷</strong>是一个虚拟目录，是<strong>容器内目录</strong> <strong>宿主机目录</strong>之间映射的桥梁。</p>
<p>以 Nginx 为例，我们知道 Nginx 中有两个关键的目录：</p>
<ul>
<li><code>html</code>：放置一些静态资源</li>
<li><code>conf</code>：放置配置文件</li>
</ul>
<p>如果我们要让 Nginx 代理我们的静态资源，最好是放到 <code>html</code> 目录；如果我们要修改 Nginx 的配置，最好是找到 <code>conf</code> 下的<code>nginx.conf</code>文件。</p>
<p>但遗憾的是，容器运行的 Nginx 所有的文件都在容器内部。所以我们必须利用数据卷将两个目录与宿主机目录关联，方便我们操作。如图：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/Docker/%E5%88%A9%E7%94%A8%E6%95%B0%E6%8D%AE%E5%8D%B7%E5%B0%86nginx%E4%B8%A4%E4%B8%AA%E7%9B%AE%E5%BD%95%E4%B8%8E%E5%AE%BF%E4%B8%BB%E6%9C%BA%E7%9B%AE%E5%BD%95%E5%85%B3%E8%81%94.png" style="zoom: 50%;">

<p>在上图中：</p>
<ul>
<li>我们创建了两个数据卷：<code>conf</code>、<code>html</code></li>
<li>Nginx 容器内部的 <code>conf</code> 目录和 <code>html</code> 目录分别与两个数据卷关联。</li>
<li>而数据卷 conf 和 html 分别指向了宿主机的 <code>/var/lib/docker/volumes/conf/_data</code> 目录和 <code>/var/lib/docker/volumes/html/_data</code> 目录</li>
</ul>
<p>这样以来，容器内的 <code>conf</code>和<code>html</code> 目录就 与宿主机的 <code>conf</code> 和 <code>html</code> 目录关联起来，我们称为<strong>挂载</strong>。此时，我们操作宿主机的 <code>/var/lib/docker/volumes/html/_data</code> 就是在操作容器内的 <code>/usr/share/nginx/html/_data</code>目录。只要我们将静态资源放入宿主机对应目录，就可以被 Nginx 代理了。</p>
<blockquote>
<p>小提示😃</p>
</blockquote>
<p><code>/var/lib/docker/volumes</code>这个目录就是默认的存放所有容器数据卷的目录，其下再根据数据卷名称创建新目录，格式为<code>/数据卷名/_data</code>。</p>
<p>为什么不让容器目录直接指向宿主机目录呢？</p>
<p>因为直接指向宿主机目录就与宿主机强耦合了，如果切换了环境，宿主机目录就可能发生改变了。由于容器一旦创建，目录挂载就无法修改，这样容器就无法正常工作了。</p>
<p>但是容器指向数据卷，一个逻辑名称，而数据卷再指向宿主机目录，就不存在强耦合。如果宿主机目录发生改变，只要改变数据卷与宿主机目录之间的映射关系即可。</p>
<p>不过，我们通过由于数据卷目录比较深，不好寻找，通常我们也<strong>允许让容器直接与宿主机目录挂载而不使用数据卷</strong>。</p>
<h3 id="3-4-2-数据卷命令"><a href="#3-4-2-数据卷命令" class="headerlink" title="3.4.2 数据卷命令"></a>3.4.2 数据卷命令</h3><p>数据卷的相关命令有：</p>
<table>
<thead>
<tr>
<th align="center"><strong>命令</strong></th>
<th align="center"><strong>说明</strong></th>
<th align="center"><strong>文档地址</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="center">docker volume create</td>
<td align="center">创建数据卷</td>
<td align="center"><a href="https://docs.docker.com/engine/reference/commandline/volume_create/">docker volume create</a></td>
</tr>
<tr>
<td align="center">docker volume ls</td>
<td align="center">查看所有数据卷</td>
<td align="center"><a href="https://docs.docker.com/engine/reference/commandline/volume_ls/">docs.docker.com</a></td>
</tr>
<tr>
<td align="center">docker volume rm</td>
<td align="center">删除指定数据卷</td>
<td align="center"><a href="https://docs.docker.com/engine/reference/commandline/volume_prune/">docs.docker.com</a></td>
</tr>
<tr>
<td align="center">docker volume inspect</td>
<td align="center">查看某个数据卷的详情</td>
<td align="center"><a href="https://docs.docker.com/engine/reference/commandline/volume_inspect/">docs.docker.com</a></td>
</tr>
<tr>
<td align="center">docker volume prune</td>
<td align="center">清除数据卷</td>
<td align="center"><a href="https://docs.docker.com/engine/reference/commandline/volume_prune/">docker volume prune</a></td>
</tr>
</tbody></table>
<p>在执行docker run命令时，使用 <code>-v 数据卷:容器内目录</code> 可以完成数据卷挂载。当创建容器时，如果挂载了数据卷且数据卷不存在，会自动创建数据卷。</p>
<p><font color="red">PS：挂载的动作一定是在docker run(容器创建)的时候执行，容器一旦已经创建是没有办法再去挂载的！！</font>😉</p>
<blockquote>
<p>演示 Nginx 的 html 目录挂载</p>
</blockquote>
<p>1、创建容器并指定数据卷，注意通过 <code>-v</code> 参数来指定数据卷</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker run -d --name nginx -p 80:80 -v html:/usr/share/nginx/html nginx</span><br></pre></td></tr></table></figure>

<p>2、查看数据卷</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker volume ls</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">DRIVER    VOLUME NAME</span><br><span class="line">local     b388dcff529dd819f25d271e22f5b1438a12afc5afb5069228230b64b8d8e98a</span><br><span class="line">local     html</span><br></pre></td></tr></table></figure>

<p>3、查看数据卷详情</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker volume inspect html</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;CreatedAt&quot;: &quot;2024-03-27T22:58:31-07:00&quot;,</span><br><span class="line">        &quot;Driver&quot;: &quot;local&quot;,</span><br><span class="line">        &quot;Labels&quot;: null,</span><br><span class="line">        &quot;Mountpoint&quot;: &quot;/var/lib/docker/volumes/html/_data&quot;,</span><br><span class="line">        &quot;Name&quot;: &quot;html&quot;,</span><br><span class="line">        &quot;Options&quot;: null,</span><br><span class="line">        &quot;Scope&quot;: &quot;local&quot;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>4、查看 &#x2F;var&#x2F;lib&#x2F;docker&#x2F;volumes&#x2F;html&#x2F;_data 目录</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ll /var/lib/docker/volumes/html/_data</span><br></pre></td></tr></table></figure>

<p>可以看到与nginx的html目录内容一样，结果如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">total 8</span><br><span class="line">-rw-r--r--. 1 root root 497 Feb 14 08:03 50x.html</span><br><span class="line">-rw-r--r--. 1 root root 615 Feb 14 08:03 index.html</span><br></pre></td></tr></table></figure>

<p>5、进入该目录，并随意修改index.html内容，修改后打开页面，查看效果</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cd /var/lib/docker/volumes/html/_data</span><br><span class="line">vim index.html</span><br></pre></td></tr></table></figure>

<p>6、进入容器内部，查看 &#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html 目录内的文件是否变化</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker exec -it nginx bash</span><br></pre></td></tr></table></figure>

<blockquote>
<p>演示 MySQL 的匿名数据卷</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看MySQL容器详细信息</span></span><br><span class="line">docker inspect mysql</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">关注其中.Config.Volumes部分和.Mounts部分</span></span><br></pre></td></tr></table></figure>

<p>我们关注两部分内容，第一是<code>.Config.Volumes</code>部分：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;Config&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="comment">// ... 略</span></span><br><span class="line">    <span class="attr">&quot;Volumes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;/var/lib/mysql&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="comment">// ... 略</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>可以发现这个容器声明了一个本地目录，需要挂载数据卷，但是<strong>数据卷未定义</strong>。这就是匿名卷。</p>
<p>然后，我们再看结果中的<code>.Mounts</code>部分：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;Mounts&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;Type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;volume&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;Name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;29524ff09715d3688eae3f99803a2796558dbd00ca584a25a4bbc193ca82459f&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;Source&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/var/lib/docker/volumes/29524ff09715d3688eae3f99803a2796558dbd00ca584a25a4bbc193ca82459f/_data&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;Destination&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/var/lib/mysql&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;Driver&quot;</span><span class="punctuation">:</span> <span class="string">&quot;local&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>可以发现，其中有几个关键属性：</p>
<ul>
<li>Name：数据卷名称。由于定义容器未设置容器名，这里的就是匿名卷自动生成的名字，一串hash值。</li>
<li>Source：宿主机目录</li>
<li>Destination : 容器内的目录</li>
</ul>
<p>上述配置是将容器内的<code>/var/lib/mysql</code>这个目录，与数据卷<code>29524ff09715d3688eae3f99803a2796558dbd00ca584a25a4bbc193ca82459f</code>挂载。于是在宿主机中就有了<code>/var/lib/docker/volumes/29524ff09715d3688eae3f99803a2796558dbd00ca584a25a4bbc193ca82459f/_data</code>这个目录。这就是匿名数据卷对应的目录，其使用方式与普通数据卷没有差别。</p>
<p>接下来，可以查看该目录下的MySQL的data文件：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">ls</span> -l /var/lib/docker/volumes/29524ff09715d3688eae3f99803a2796558dbd00ca584a25a4bbc193ca82459f/_data</span><br></pre></td></tr></table></figure>

<p>注意：每一个不同的镜像，将来创建容器后内部有哪些目录可以挂载，可以参考DockerHub对应的页面。</p>
<h3 id="3-4-3-挂载本地目录或文件"><a href="#3-4-3-挂载本地目录或文件" class="headerlink" title="3.4.3 挂载本地目录或文件"></a>3.4.3 挂载本地目录或文件</h3><p>可以发现，数据卷的目录结构较深，如果我们去操作数据卷目录会不太方便。在很多情况下，我们会直接将容器目录与宿主机指定目录挂载。挂载语法与数据卷类似：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 挂载本地目录</span></span><br><span class="line">-v 本地目录:容器内目录</span><br><span class="line"></span><br><span class="line"><span class="comment"># 挂载本地文件</span></span><br><span class="line">-v 本地文件:容器内文件</span><br></pre></td></tr></table></figure>

<p><font color="red"><strong>PS：本地目录或文件必须以 <code>/</code> 或 <code>./</code>开头，如果直接以名字开头，会被识别为数据卷名而非本地目录名。</strong></font>😄😄😄 例如：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 会被识别为一个数据卷叫mysql，运行时会自动创建这个数据卷</span></span><br><span class="line">-v mysql:/var/lib/mysql</span><br><span class="line"></span><br><span class="line"><span class="comment"># 会被识别为当前目录下的mysql目录，运行时如果不存在会创建目录</span></span><br><span class="line">-v ./mysql:/var/lib/mysql</span><br></pre></td></tr></table></figure>

<blockquote>
<p>演示基于宿主机目录实现 MySQL 数据目录、配置文件、初始化脚本的挂载(查阅官方镜像文档)：</p>
</blockquote>
<ul>
<li>挂载<code>/root/mysql/data</code>到容器内的<code>/var/lib/mysql</code>目录</li>
<li>挂载<code>/root/mysql/init</code>到容器内的<code>/docker-entrypoint-initdb.d</code>目录(初始化的SQL脚本目录)</li>
<li>挂载<code>/root/mysql/conf</code>到容器内的<code>/etc/mysql/conf.d</code>目录(这个是MySQL配置文件目录)</li>
</ul>
<p>准备好了 mysql 的初始化 SQL 脚本和配置文件，在创建 mysql 容器后，上传到对应挂载的本地目录。</p>
<p>其中，hm.cnf 主要是配置了 MySQL 的默认编码，改为 utf8mb4；而 hmall.sql 则是黑马商城项目的初始化 SQL 脚本。</p>
<p>接下来，我们演示本地目录挂载：</p>
<p>1、删除原来的 MySQL 容器，进入 root 目录</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker rm -f mysql</span><br><span class="line">cd ~</span><br></pre></td></tr></table></figure>

<p>2、创建并运行新 mysql 容器，挂载本地目录(<strong>注意挂载的目录权限，权限不足会导致挂载的目录文件不生效</strong>)</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker run -d \</span><br><span class="line">  --name mysql \</span><br><span class="line">  -p 3306:3306 \</span><br><span class="line">  -e TZ=Asia/Shanghai \</span><br><span class="line">  -e MYSQL_ROOT_PASSWORD=123 \</span><br><span class="line">  -v ./mysql/data:/var/lib/mysql \</span><br><span class="line">  -v ./mysql/conf:/etc/mysql/conf.d \</span><br><span class="line">  -v ./mysql/init:/docker-entrypoint-initdb.d \</span><br><span class="line">  mysql</span><br></pre></td></tr></table></figure>

<p>3、查看 root 目录，可以发现 ~&#x2F;mysql&#x2F;data 目录已经自动创建好了</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ls -l mysql</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看data目录，会发现里面有大量数据库数据，说明数据库完成了初始化</span></span><br><span class="line">ls -l data</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">总用量 4</span><br><span class="line">drwxr-xr-x. 2 root    root   20 5月  19 15:11 conf</span><br><span class="line">drwxr-xr-x. 7 polkitd root 4096 5月  19 15:11 data</span><br><span class="line">drwxr-xr-x. 2 root    root   23 5月  19 15:11 init</span><br></pre></td></tr></table></figure>

<p>4、查看MySQL容器内数据</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">进入MySQL</span></span><br><span class="line">docker exec -it mysql mysql -uroot -p123</span><br></pre></td></tr></table></figure>

<p>(1) 查看编码表</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">show variables like &quot;%char%&quot;;</span><br></pre></td></tr></table></figure>

<p>编码是 utf8mb4 则没有问题</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">+--------------------------+--------------------------------+</span><br><span class="line">| Variable_name            | Value                          |</span><br><span class="line">+--------------------------+--------------------------------+</span><br><span class="line">| character_set_client     | utf8mb4                        |</span><br><span class="line">| character_set_connection | utf8mb4                        |</span><br><span class="line">| character_set_database   | utf8mb4                        |</span><br><span class="line">| character_set_filesystem | binary                         |</span><br><span class="line">| character_set_results    | utf8mb4                        |</span><br><span class="line">| character_set_server     | utf8mb4                        |</span><br><span class="line">| character_set_system     | utf8mb3                        |</span><br><span class="line">| character_sets_dir       | /usr/share/mysql-8.0/charsets/ |</span><br><span class="line">+--------------------------+--------------------------------+</span><br></pre></td></tr></table></figure>

<p>(2) 查看数据库</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">show databases;</span><br></pre></td></tr></table></figure>

<p>结果查看到 hmall 黑马商城数据库</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| hmall              |</span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| sys                |</span><br><span class="line">+--------------------+</span><br></pre></td></tr></table></figure>

<p>(3) 切换到 hmall 数据库，查看表</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">use hmall;</span><br><span class="line">show tables;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">+-----------------+</span><br><span class="line">| Tables_in_hmall |</span><br><span class="line">+-----------------+</span><br><span class="line">| address         |</span><br><span class="line">| cart            |</span><br><span class="line">| item            |</span><br><span class="line">| order           |</span><br><span class="line">| order_detail    |</span><br><span class="line">| order_logistics |</span><br><span class="line">| pay_order       |</span><br><span class="line">| user            |</span><br><span class="line">+-----------------+</span><br></pre></td></tr></table></figure>

<p>(4) 查看 address 表数据</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">+----+---------+----------+--------+----------+-------------+---------------+-----------+------------+-------+</span><br><span class="line">| id | user_id | province | city   | town     | mobile      | street        | contact   | is_default | notes |</span><br><span class="line">+----+---------+----------+--------+----------+-------------+---------------+-----------+------------+-------+</span><br><span class="line">| 59 |       1 | 北京     | 北京   | 朝阳区    | 13900112222 | 金燕龙办公楼   | 李佳诚    | 0          | NULL  |</span><br><span class="line">| 60 |       1 | 北京     | 北京   | 朝阳区    | 13700221122 | 修正大厦       | 李佳红    | 0          | NULL  |</span><br><span class="line">| 61 |       1 | 上海     | 上海   | 浦东新区  | 13301212233 | 航头镇航头路   | 李佳星    | 1          | NULL  |</span><br><span class="line">| 63 |       1 | 广东     | 佛山   | 永春      | 13301212233 | 永春武馆       | 李晓龙    | 0          | NULL  |</span><br><span class="line">+----+---------+----------+--------+----------+-------------+---------------+-----------+------------+-------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>推荐挂载到一个固定的自己设置的本地目录。挂载到本地目录后，即使将 mysql 容器删掉，再次创建并运行新mysql容器，只要挂载的地方不变，会发现所有的数据依然会存在。也就是说<font color="red">只要挂载的目录还在，数据就不会丢失，实现了数据的持久保存。</font></p>
<h2 id="3-5-镜像"><a href="#3-5-镜像" class="headerlink" title="3.5 镜像"></a>3.5 镜像</h2><p>前面我们一直在使用别人准备好的镜像，那如果我要部署一个 Java 项目，把它打包为一个镜像该怎么做呢？</p>
<h3 id="3-5-1-镜像结构"><a href="#3-5-1-镜像结构" class="headerlink" title="3.5.1 镜像结构"></a>3.5.1 镜像结构</h3><p>镜像之所以能让我们快速跨操作系统部署应用而忽略其运行环境、配置，就是因为镜像中包含了程序运行需要的系统函数库、环境、配置、依赖。因此，自定义镜像本质就是依次准备好程序运行的基础环境、依赖、应用本身、运行配置等文件，并且打包而成。</p>
<p>我们打包镜像也是分成这么几步：</p>
<ul>
<li>准备Linux运行环境(Java项目并不需要完整的操作系统，仅仅是基础运行环境即可)</li>
<li>安装并配置JDK</li>
<li>拷贝jar包</li>
<li>配置启动脚本</li>
</ul>
<p>上述步骤中的每一次操作其实都是在生产一些文件(系统运行环境、函数库、配置最终都是磁盘文件)，所以<strong>镜像就是一堆文件的集合</strong>。</p>
<p>但需要注意的是，镜像文件不是随意堆放的，而是按照操作的步骤分层叠加而成，每一层形成的文件都会单独打包并标记一个唯一 id，称为 **Layer(层)**。这样，如果我们构建时用到的某些层其他人已经制作过，就可以直接拷贝使用这些层，而不用重复制作。</p>
<p>例如，第一步中需要的 Linux 运行环境，通用性就很强，所以 Docker 官方就制作了这样的只包含 Linux 运行环境的镜像。我们在制作Java 镜像时，就无需重复制作，直接使用 Docker 官方提供的 CentOS 或 Ubuntu 镜像作为基础镜像。然后再搭建其它层即可，这样逐层搭建，最终整个 Java 项目的镜像结构如图所示：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/Docker/Docker%E9%95%9C%E5%83%8F%E7%BB%93%E6%9E%84.png" style="zoom:50%;">

<h3 id="3-5-2-Dockerfile"><a href="#3-5-2-Dockerfile" class="headerlink" title="3.5.2 Dockerfile"></a>3.5.2 Dockerfile</h3><p>由于制作镜像的过程中，需要逐层处理和打包，比较复杂，所以 Docker 就提供了自动打包镜像的功能。我们只需要将打包的过程，每一层要做的事情用固定的语法写下来，交给 Docker 去执行即可。</p>
<p>而这种记录镜像结构的文件就称为 <strong>Dockerfile</strong>，其对应的语法可以参考官方文档：<a href="https://docs.docker.com/engine/reference/builder/">https://docs.docker.com/engine/reference/builder/</a></p>
<p>其中的语法比较多，比较常用的有：</p>
<table>
<thead>
<tr>
<th align="center"><strong>指令</strong></th>
<th align="center"><strong>说明</strong></th>
<th align="center"><strong>示例</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="center"><strong>FROM</strong></td>
<td align="center">指定基础镜像</td>
<td align="center"><code>FROM centos:6</code></td>
</tr>
<tr>
<td align="center"><strong>ENV</strong></td>
<td align="center">设置环境变量，可在后面指令使用</td>
<td align="center"><code>ENV key value</code></td>
</tr>
<tr>
<td align="center"><strong>COPY</strong></td>
<td align="center">拷贝本地文件到镜像的指定目录</td>
<td align="center"><code>COPY ./xx.jar /tmp/app.jar</code></td>
</tr>
<tr>
<td align="center"><strong>RUN</strong></td>
<td align="center">执行Linux的shell命令，一般是安装过程的命令</td>
<td align="center"><code>RUN yum install gcc</code></td>
</tr>
<tr>
<td align="center"><strong>EXPOSE</strong></td>
<td align="center">指定容器运行时监听的端口，是给镜像使用者看的</td>
<td align="center">EXPOSE 8080</td>
</tr>
<tr>
<td align="center"><strong>ENTRYPOINT</strong></td>
<td align="center">镜像中应用的启动命令，容器运行时调用</td>
<td align="center">ENTRYPOINT java -jar xx.jar</td>
</tr>
</tbody></table>
<p>例如，要基于Ubuntu镜像来构建一个 Java 应用，其 Dockerfile 内容如下：</p>
<figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 指定基础镜像</span></span><br><span class="line"><span class="keyword">FROM</span> ubuntu:<span class="number">16.04</span></span><br><span class="line"><span class="comment"># 配置环境变量，JDK的安装目录、容器内时区</span></span><br><span class="line"><span class="keyword">ENV</span> JAVA_DIR=/usr/local</span><br><span class="line"><span class="keyword">ENV</span> TZ=Asia/Shanghai</span><br><span class="line"><span class="comment"># 拷贝JDK和Java项目的包</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> ./jdk8.tar.gz <span class="variable">$JAVA_DIR</span>/</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> ./docker-demo.jar /tmp/app.jar</span></span><br><span class="line"><span class="comment"># 设定时区</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">ln</span> -snf /usr/share/zoneinfo/<span class="variable">$TZ</span> /etc/localtime &amp;&amp; <span class="built_in">echo</span> <span class="variable">$TZ</span> &gt; /etc/timezone</span></span><br><span class="line"><span class="comment"># 安装JDK</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">cd</span> <span class="variable">$JAVA_DIR</span> \</span></span><br><span class="line"><span class="language-bash"> &amp;&amp; tar -xf ./jdk8.tar.gz \</span></span><br><span class="line"><span class="language-bash"> &amp;&amp; <span class="built_in">mv</span> ./jdk1.8.0_144 ./java8</span></span><br><span class="line"><span class="comment"># 配置环境变量</span></span><br><span class="line"><span class="keyword">ENV</span> JAVA_HOME=$JAVA_DIR/java8</span><br><span class="line"><span class="keyword">ENV</span> PATH=$PATH:$JAVA_HOME/bin</span><br><span class="line"><span class="comment"># 指定项目监听的端口</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">8080</span></span><br><span class="line"><span class="comment"># 入口，Java项目的启动命令</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;java&quot;</span>, <span class="string">&quot;-jar&quot;</span>, <span class="string">&quot;/app.jar&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<p>我们思考一下：以后我们会有很多很多 Java 项目需要打包为镜像，他们都需要 Linux 系统环境、JDK 环境这两层，只有上面的3层不同(因为jar包不同)。如果每次制作 Java 镜像都重复制作前两层镜像，是不是很麻烦。</p>
<p>所以，就有人提供了基础的系统加 JDK 环境，我们在此基础上制作 Java 镜像，就可以省去 JDK 的配置了：</p>
<figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 基础镜像</span></span><br><span class="line"><span class="keyword">FROM</span> openjdk:<span class="number">11.0</span>-jre-buster</span><br><span class="line"><span class="comment"># 设定时区</span></span><br><span class="line"><span class="keyword">ENV</span> TZ=Asia/Shanghai</span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">ln</span> -snf /usr/share/zoneinfo/<span class="variable">$TZ</span> /etc/localtime &amp;&amp; <span class="built_in">echo</span> <span class="variable">$TZ</span> &gt; /etc/timezone</span></span><br><span class="line"><span class="comment"># 拷贝jar包</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> docker-demo.jar /app.jar</span></span><br><span class="line"><span class="comment"># 入口</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;java&quot;</span>, <span class="string">&quot;-jar&quot;</span>, <span class="string">&quot;/app.jar&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<p>是不是简单多了。</p>
<h3 id="3-5-3-构建镜像"><a href="#3-5-3-构建镜像" class="headerlink" title="3.5.3 构建镜像"></a>3.5.3 构建镜像</h3><p>当 Dockerfile 文件写好以后，就可以利用命令来构建镜像了。</p>
<p>准备以下 Dockerfile 文件：</p>
<figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 基础镜像</span></span><br><span class="line"><span class="keyword">FROM</span> openjdk:<span class="number">11.0</span>-jre-buster</span><br><span class="line"><span class="comment"># 设定时区</span></span><br><span class="line"><span class="keyword">ENV</span> TZ=Asia/Shanghai</span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">ln</span> -snf /usr/share/zoneinfo/<span class="variable">$TZ</span> /etc/localtime &amp;&amp; <span class="built_in">echo</span> <span class="variable">$TZ</span> &gt; /etc/timezone</span></span><br><span class="line"><span class="comment"># 拷贝jar包</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> docker-demo.jar /app.jar</span></span><br><span class="line"><span class="comment"># 入口</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;java&quot;</span>, <span class="string">&quot;-jar&quot;</span>, <span class="string">&quot;/app.jar&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<p>将<code>docker-demo.jar</code>包以及<code>Dockerfile</code>拷贝到虚拟机的<code>/root/demo</code>目录：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/Docker/docker-demo.jar%E5%8C%85%E5%92%8CDockerfile%E6%8B%B7%E8%B4%9D%E5%88%B0%E8%99%9A%E6%8B%9F%E6%9C%BA.png"></p>
<p>然后，执行命令，构建镜像：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 进入镜像目录</span></span><br><span class="line"><span class="built_in">cd</span> /root/demo</span><br><span class="line"><span class="comment"># 开始构建</span></span><br><span class="line">docker build -t docker-demo:1.0 .</span><br></pre></td></tr></table></figure>

<p>命令说明：</p>
<ul>
<li><p><code>docker build </code> : 就是构建一个docker镜像</p>
</li>
<li><p><code>-t docker-demo:1.0</code> ：<code>-t</code>参数是指定镜像的名称(<code>repository</code>和<code>tag</code>)</p>
</li>
<li><p><code>.</code> : 最后的点是指构建时 Dockerfile 所在路径，由于我们进入了 demo 目录，所以指定的是<code>.</code>代表当前目录，也可以直接指定 Dockerfile 目录：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 直接指定Dockerfile目录</span></span><br><span class="line">docker build -t docker-demo:1.0 /root/demo</span><br></pre></td></tr></table></figure>

<p>结果：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/Docker/%E6%9E%84%E5%BB%BAdocker-demo%E9%95%9C%E5%83%8F.png"></p>
</li>
</ul>
<p>查看镜像列表：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看镜像列表：</span></span><br><span class="line">docker images</span><br><span class="line"><span class="comment"># 结果</span></span><br><span class="line">REPOSITORY    TAG       IMAGE ID       CREATED         SIZE</span><br><span class="line">docker-demo   1.0       135cfdff1520   4 minutes ago   315MB</span><br><span class="line">mysql         latest    82563e0cbf18   2 days ago      632MB</span><br><span class="line">nginx         latest    92b11f67642b   6 weeks ago     187MB</span><br></pre></td></tr></table></figure>

<p>然后尝试运行该镜像：</p>
<p>1、创建并运行容器</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker run -d --name dd -p 8080:8080 docker-demo:1.0</span><br></pre></td></tr></table></figure>

<p>2、查看容器</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker ps</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">CONTAINER ID   IMAGE             PORTS                                                  STATUS              NAMES</span><br><span class="line">bf65aebe697b   docker-demo:1.0   0.0.0.0:8080-&gt;8080/tcp, :::8080-&gt;8080/tcp              Up About a minute   dd</span><br><span class="line">84f8c612dc9d   mysql             0.0.0.0:3306-&gt;3306/tcp, :::3306-&gt;3306/tcp, 33060/tcp   Up 2 hours          mysql</span><br><span class="line">d38d34cb0b17   nginx             0.0.0.0:80-&gt;80/tcp, :::80-&gt;80/tcp                      Up 3 hours          nginx</span><br></pre></td></tr></table></figure>

<p>3、访问</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">curl localhost:8080/hello/count</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;h5&gt;欢迎访问黑马商城, 这是您第1次访问&lt;h5&gt;</span><br></pre></td></tr></table></figure>

<h2 id="3-6-网络"><a href="#3-6-网络" class="headerlink" title="3.6 网络"></a>3.6 网络</h2><p>上面我们创建了一个 Java 项目的容器，而 Java 项目往往需要访问其它各种中间件，例如 MySQL、Redis 等。现在，我们的容器之间能否互相访问呢？我们来测试一下</p>
<p>首先，我们查看下 MySQL 容器的详细信息，重点关注其中的网络IP地址：</p>
<p>1、用基本命令，寻找Networks.bridge.IPAddress属性</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker inspect mysql</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">也可以使用format过滤结果</span></span><br><span class="line">docker inspect --format=&#x27;&#123;&#123;range .NetworkSettings.Networks&#125;&#125;&#123;&#123;println .IPAddress&#125;&#125;&#123;&#123;end&#125;&#125;&#x27; mysql</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 得到的 IP 地址</span><br><span class="line">172.17.0.3</span><br></pre></td></tr></table></figure>

<p>2、然后通过命令进入dd容器</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker exec -it dd bash</span><br></pre></td></tr></table></figure>

<p>3、在容器内，通过 ping 命令测试网络</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ping 172.17.0.3</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">PING 172.17.0.3 (172.17.0.3) 56(84) bytes of data.</span><br><span class="line">64 bytes from 172.17.0.3: icmp_seq=1 ttl=64 time=0.140 ms</span><br><span class="line">64 bytes from 172.17.0.3: icmp_seq=2 ttl=64 time=0.081 ms</span><br><span class="line">64 bytes from 172.17.0.3: icmp_seq=3 ttl=64 time=0.065 ms</span><br></pre></td></tr></table></figure>

<p>发现可以互联，没有问题。</p>
<p>但是，容器的网络IP其实是一个虚拟的 IP，其值并不固定与某一个容器绑定，如果我们在开发时写死某个 IP，而在部署时很可能 MySQL容器的 IP 会发生变化，连接会失败。</p>
<p>所以，我们必须借助于docker的网络功能来解决这个问题，官方文档：<a href="https://docs.docker.com/engine/reference/commandline/network/">https://docs.docker.com/engine/reference/commandline/network/</a></p>
<p>常见命令有：</p>
<table>
<thead>
<tr>
<th align="left"><strong>命令</strong></th>
<th align="left"><strong>说明</strong></th>
<th align="left"><strong>文档地址</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="left">docker network create</td>
<td align="left">创建一个网络</td>
<td align="left"><a href="https://docs.docker.com/engine/reference/commandline/network_create/">docker network create</a></td>
</tr>
<tr>
<td align="left">docker network ls</td>
<td align="left">查看所有网络</td>
<td align="left"><a href="https://docs.docker.com/engine/reference/commandline/network_ls/">docs.docker.com</a></td>
</tr>
<tr>
<td align="left">docker network rm</td>
<td align="left">删除指定网络</td>
<td align="left"><a href="https://docs.docker.com/engine/reference/commandline/network_rm/">docs.docker.com</a></td>
</tr>
<tr>
<td align="left">docker network prune</td>
<td align="left">清除未使用的网络</td>
<td align="left"><a href="https://docs.docker.com/engine/reference/commandline/network_prune/">docs.docker.com</a></td>
</tr>
<tr>
<td align="left">docker network connect</td>
<td align="left">使指定容器连接加入某网络</td>
<td align="left"><a href="https://docs.docker.com/engine/reference/commandline/network_connect/">docs.docker.com</a></td>
</tr>
<tr>
<td align="left">docker network disconnect</td>
<td align="left">使指定容器连接离开某网络</td>
<td align="left"><a href="https://docs.docker.com/engine/reference/commandline/network_disconnect/">docker network disconnect</a></td>
</tr>
<tr>
<td align="left">docker network inspect</td>
<td align="left">查看网络详细信息</td>
<td align="left"><a href="https://docs.docker.com/engine/reference/commandline/network_inspect/">docker network inspect</a></td>
</tr>
</tbody></table>
<blockquote>
<p>演示自定义网络</p>
</blockquote>
<p>1、首先通过命令创建一个网络</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker network create hmall</span><br></pre></td></tr></table></figure>

<p>2、然后查看网络</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker network ls</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">NETWORK ID     NAME      DRIVER    SCOPE</span><br><span class="line">450aad7a52da   bridge    bridge    local</span><br><span class="line">a93df4a22e20   hmall     bridge    local</span><br><span class="line">7e4aae31adc0   host      host      local</span><br><span class="line">fdf56146d7d7   none      null      local</span><br></pre></td></tr></table></figure>

<p>其中，除了hmall以外，其它都是默认的网络</p>
<p>3、让dd和mysql都加入该网络，注意，在加入网络时可以通过–alias给容器起别名，这样该网络内的其它容器可以用别名互相访问！</p>
<p>(1) mysql容器，指定别名为db，另外每一个容器都有一个别名是容器名</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker network connect hmall mysql --alias db</span><br></pre></td></tr></table></figure>

<p>(2) db容器，也就是我们的Java项目</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker network connect hmall dd</span><br></pre></td></tr></table></figure>

<p>4、进入 dd 容器，尝试利用别名访问 db</p>
<p>(1) 进入容器</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker exec -it dd bash</span><br></pre></td></tr></table></figure>

<p>(2) 用 db 别名访问</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ping db</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">PING db (172.19.0.2) 56(84) bytes of data.</span><br><span class="line">64 bytes from mysql.hmall (172.19.0.2): icmp_seq=1 ttl=64 time=0.063 ms</span><br><span class="line">64 bytes from mysql.hmall (172.19.0.2): icmp_seq=2 ttl=64 time=0.071 ms</span><br><span class="line">64 bytes from mysql.hmall (172.19.0.2): icmp_seq=3 ttl=64 time=0.062 ms</span><br></pre></td></tr></table></figure>

<p>(3) 用容器名访问</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ping mysql</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">PING mysql (172.19.0.2) 56(84) bytes of data.</span><br><span class="line">64 bytes from mysql.hmall (172.19.0.2): icmp_seq=1 ttl=64 time=0.074 ms</span><br><span class="line">64 bytes from mysql.hmall (172.19.0.2): icmp_seq=2 ttl=64 time=0.057 ms</span><br><span class="line">64 bytes from mysql.hmall (172.19.0.2): icmp_seq=3 ttl=64 time=0.057 ms</span><br></pre></td></tr></table></figure>

<p>OK，现在无需记住 IP 地址也可以实现容器互联了。</p>
<p><strong>总结</strong>：</p>
<ul>
<li>在自定义网络中，可以给容器起多个别名，默认的别名是容器名本身</li>
<li>在同一个自定义网络中的容器，可以通过别名互相访问</li>
</ul>
<h1 id="4-项目部署"><a href="#4-项目部署" class="headerlink" title="4. 项目部署"></a>4. 项目部署</h1><p>项目说明：</p>
<ul>
<li>hmall：商城的后端代码</li>
<li>hmall-portal：商城用户端的前端代码</li>
<li>hmall-admin：商城管理端的前端代码</li>
</ul>
<p>部署的容器及端口说明：</p>
<table>
<thead>
<tr>
<th align="center"><strong>项目</strong></th>
<th align="center"><strong>容器名</strong></th>
<th align="center"><strong>端口</strong></th>
<th align="center"><strong>备注</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="center">hmall</td>
<td align="center">hmall</td>
<td align="center">8080</td>
<td align="center">黑马商城后端API入口</td>
</tr>
<tr>
<td align="center">hmall-portal</td>
<td align="center">nginx</td>
<td align="center">18080</td>
<td align="center">黑马商城用户端入口</td>
</tr>
<tr>
<td align="center">hmall-admin</td>
<td align="center">nginx</td>
<td align="center">18081</td>
<td align="center">黑马商城管理端入口</td>
</tr>
<tr>
<td align="center">mysql</td>
<td align="center">mysql</td>
<td align="center">3306</td>
<td align="center">数据库</td>
</tr>
</tbody></table>
<p>在正式部署前，我们先删除之前的 nginx、dd 两个容器：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker <span class="built_in">rm</span> -f nginx <span class="built_in">dd</span></span><br></pre></td></tr></table></figure>

<p>mysql容器中已经准备好了商城的数据，所以就不再删除了。</p>
<h2 id="4-1-部署Java项目"><a href="#4-1-部署Java项目" class="headerlink" title="4.1 部署Java项目"></a>4.1 部署Java项目</h2><p><code>hmall</code>项目是一个maven聚合项目，使用IDEA打开<code>hmall</code>项目，查看项目结构如图：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/Docker/%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84.png"></p>
<p>我们要部署的就是其中的<code>hm-service</code>，其中的配置文件采用了多环境的方式：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/Docker/%E5%A4%9A%E7%8E%AF%E5%A2%83.png"></p>
<p>其中的<code>application-dev.yaml</code>是部署到开发环境的配置，<code>application-local.yaml</code>是本地运行时的配置。</p>
<p>查看 <code>application.yaml</code>，你会发现其中的 JDBC 地址并未写死，而是读取变量：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/Docker/JDBC%E5%9C%B0%E5%9D%80%E6%9C%AA%E5%86%99%E6%AD%BB.png"></p>
<p>这两个变量在<code>application-dev.yaml</code>和<code>application-local.yaml</code>中并不相同：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/Docker/host%E5%8F%98%E9%87%8F%E5%8C%BA%E5%88%AB.png"></p>
<p>在 dev 开发环境(也就是 Docker 部署时)采用了 mysql 作为地址，刚好是我们的 mysql 容器名，只要两者在一个网络，就一定能互相访问。</p>
<p>我们将项目打包：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/Docker/%E6%89%93%E5%8C%85hmall.png" style="zoom: 67%;">

<p>结果：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/Docker/%E6%89%93%E5%8C%85hmall%E7%BB%93%E6%9E%9C.png" style="zoom:80%;">

<p>将<code>hm-service</code>目录下的<code>Dockerfile</code>和<code>hm-service/target</code>目录下的<code>hm-service.jar</code>一起上传到虚拟机的<code>root</code>目录：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/Docker/Dockerfile%E5%92%8Chm-service.jar%E4%B8%8A%E4%BC%A0%E5%88%B0%E8%99%9A%E6%8B%9F%E6%9C%BA.png"></p>
<p>部署项目：</p>
<p>1、构建项目镜像，不指定tag，则默认为latest</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker build -t hmall .</span><br></pre></td></tr></table></figure>

<p>2、查看镜像</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker images</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">REPOSITORY    TAG       IMAGE ID       CREATED             SIZE</span><br><span class="line">hmall         latest    5edaf76e6b44   38 minutes ago      365MB</span><br><span class="line">docker-demo   1.0       135cfdff1520   About an hour ago   315MB</span><br><span class="line">mysql         latest    82563e0cbf18   2 days ago          632MB</span><br><span class="line">nginx         latest    92b11f67642b   6 weeks ago         187MB</span><br></pre></td></tr></table></figure>

<p>3、创建并运行容器，并通过 <code>--network</code> 将其加入 <code>hmall</code> 网络，这样才能通过容器名访问 <code>mysql</code></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker run -d --name hmall --network hmall -p 8080:8080 hmall</span><br></pre></td></tr></table></figure>

<p>测试，通过浏览器访问：<a href="http://yourip:8080/search/list%EF%BC%8C%E6%9F%A5%E7%9C%8B%E5%88%B0%E5%AF%B9%E5%BA%94%E4%BF%A1%E6%81%AF%E5%B0%B1%E6%88%90%E5%8A%9F%E9%83%A8%E7%BD%B2%E3%80%82">http://YourIp:8080/search/list，查看到对应信息就成功部署。</a></p>
<h2 id="4-2-部署前端"><a href="#4-2-部署前端" class="headerlink" title="4.2 部署前端"></a>4.2 部署前端</h2><p><code>hmall-portal</code>和<code>hmall-admin</code>是前端代码，需要基于nginx部署。nginx的部署目录：</p>
<p>其中：</p>
<ul>
<li><code>html</code>是静态资源目录，我们需要把<code>hmall-portal</code>以及<code>hmall-admin</code>都复制进去</li>
<li><code>nginx.conf</code>是nginx的配置文件，主要是完成对<code>html</code>下的两个静态资源目录做代理</li>
</ul>
<p>我们现在要做的就是把整个 nginx 目录上传到虚拟机的 <code>/root</code> 目录下：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/Docker/%E6%95%B4%E4%B8%AAnginx%E7%9B%AE%E5%BD%95%E4%B8%8A%E4%BC%A0%E5%88%B0%E8%99%9A%E6%8B%9F%E6%9C%BA.png"></p>
<p>然后创建 nginx 容器并完成两个挂载：</p>
<ul>
<li>把<code>/root/nginx/nginx.conf</code>挂载到<code>/etc/nginx/nginx.conf</code></li>
<li>把<code>/root/nginx/html</code>挂载到<code>/usr/share/nginx/html</code></li>
</ul>
<p>由于需要让 nginx 同时代理 hmall-portal 和 hmall-admin 两套前端资源，因此我们需要暴露两个端口：</p>
<ul>
<li>18080：对应hmall-portal</li>
<li>18081：对应hmall-admin</li>
</ul>
<p>命令如下：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker run -d \</span><br><span class="line">  --name nginx \</span><br><span class="line">  -p 18080:18080 \</span><br><span class="line">  -p 18081:18081 \</span><br><span class="line">  -v /root/nginx/html:/usr/share/nginx/html \</span><br><span class="line">  -v /root/nginx/nginx.conf:/etc/nginx/nginx.conf \</span><br><span class="line">  --network hmall \</span><br><span class="line">  nginx</span><br></pre></td></tr></table></figure>

<p>测试，通过浏览器访问：<a href="http://yourip:18080/">http://YourIp:18080</a></p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/Docker/nginx%E9%A1%B9%E7%9B%AE%E9%83%A8%E7%BD%B2%E7%BB%93%E6%9E%9C.png"></p>
<h2 id="4-3-DockerCompose"><a href="#4-3-DockerCompose" class="headerlink" title="4.3 DockerCompose"></a>4.3 DockerCompose</h2><p>Docker Compose就可以帮助我们实现<strong>多个相互关联的Docker容器的快速部署</strong>。它允许用户通过一个单独的 <code>docker-compose.yml</code> 模板文件(YAML 格式)来定义一组相关联的应用容器。</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/Docker/DockerCompose.png" style="zoom:50%;">

<h3 id="4-3-1-基本语法"><a href="#4-3-1-基本语法" class="headerlink" title="4.3.1 基本语法"></a>4.3.1 基本语法</h3><p>docker-compose.yml文件的基本语法可以参考官方文档：<a href="https://docs.docker.com/compose/compose-file/compose-file-v3/">https://docs.docker.com/compose/compose-file/compose-file-v3/</a></p>
<p>docker-compose文件中可以定义多个相互关联的应用容器，每一个应用容器被称为一个服务(service)。由于 service 就是在定义某个应用的运行时参数，因此与 <code>docker run</code> 参数非常相似。</p>
<p>举例来说，用docker run部署MySQL的命令如下：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker run -d \</span><br><span class="line">  --name mysql \</span><br><span class="line">  -p 3306:3306 \</span><br><span class="line">  -e TZ=Asia/Shanghai \</span><br><span class="line">  -e MYSQL_ROOT_PASSWORD=123 \</span><br><span class="line">  -v ./mysql/data:/var/lib/mysql \</span><br><span class="line">  -v ./mysql/conf:/etc/mysql/conf.d \</span><br><span class="line">  -v ./mysql/init:/docker-entrypoint-initdb.d \</span><br><span class="line">  --network hmall</span><br><span class="line">  mysql</span><br></pre></td></tr></table></figure>

<p>如果用<code>docker-compose.yml</code>文件来定义，就是这样：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&quot;3.8&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">mysql:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">mysql</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">mysql</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;3306:3306&quot;</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">TZ:</span> <span class="string">Asia/Shanghai</span></span><br><span class="line">      <span class="attr">MYSQL_ROOT_PASSWORD:</span> <span class="number">123</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;./mysql/conf:/etc/mysql/conf.d&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;./mysql/data:/var/lib/mysql&quot;</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">new</span></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">new:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">hmall</span></span><br></pre></td></tr></table></figure>

<p>对比如下：</p>
<table>
<thead>
<tr>
<th align="center"><strong>docker run 参数</strong></th>
<th align="center"><strong>docker compose 指令</strong></th>
<th align="center"><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="center">–name</td>
<td align="center">container_name</td>
<td align="center">容器名称</td>
</tr>
<tr>
<td align="center">-p</td>
<td align="center">ports</td>
<td align="center">端口映射</td>
</tr>
<tr>
<td align="center">-e</td>
<td align="center">environment</td>
<td align="center">环境变量</td>
</tr>
<tr>
<td align="center">-v</td>
<td align="center">volumes</td>
<td align="center">数据卷配置</td>
</tr>
<tr>
<td align="center">–network</td>
<td align="center">networks</td>
<td align="center">网络</td>
</tr>
</tbody></table>
<p>黑马商城部署文件：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&quot;3.8&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">mysql:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">mysql</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">mysql</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;3306:3306&quot;</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">TZ:</span> <span class="string">Asia/Shanghai</span></span><br><span class="line">      <span class="attr">MYSQL_ROOT_PASSWORD:</span> <span class="number">123</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;./mysql/conf:/etc/mysql/conf.d&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;./mysql/data:/var/lib/mysql&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;./mysql/init:/docker-entrypoint-initdb.d&quot;</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">hm-net</span></span><br><span class="line">  <span class="attr">hmall:</span></span><br><span class="line">    <span class="attr">build:</span> </span><br><span class="line">      <span class="attr">context:</span> <span class="string">.</span></span><br><span class="line">      <span class="attr">dockerfile:</span> <span class="string">Dockerfile</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">hmall</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8080:8080&quot;</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">hm-net</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">mysql</span></span><br><span class="line">  <span class="attr">nginx:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;18080:18080&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;18081:18081&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;./nginx/nginx.conf:/etc/nginx/nginx.conf&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;./nginx/html:/usr/share/nginx/html&quot;</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">hmall</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">hm-net</span></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">hm-net:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">hmall</span></span><br></pre></td></tr></table></figure>

<h3 id="4-3-2-基础命令"><a href="#4-3-2-基础命令" class="headerlink" title="4.3.2 基础命令"></a>4.3.2 基础命令</h3><p>编写好docker-compose.yml文件，就可以部署项目了。常见的命令：<a href="https://docs.docker.com/compose/reference/">https://docs.docker.com/compose/reference/</a></p>
<p>基本语法如下：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker compose [OPTIONS] [COMMAND]</span><br></pre></td></tr></table></figure>

<p>其中，OPTIONS 和 COMMAND 都是可选参数，比较常见的有：</p>
<table>
<thead>
<tr>
<th align="center"><strong>类型</strong></th>
<th align="center"><strong>参数或指令</strong></th>
<th align="center"><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="center">Options</td>
<td align="center">-f</td>
<td align="center">指定compose文件的路径和名称</td>
</tr>
<tr>
<td align="center">Options</td>
<td align="center">-p</td>
<td align="center">指定project名称。project就是当前compose文件中设置的多个service的集合，是逻辑概念</td>
</tr>
<tr>
<td align="center">Commands</td>
<td align="center">up</td>
<td align="center">创建并启动所有service容器</td>
</tr>
<tr>
<td align="center">Commands</td>
<td align="center">down</td>
<td align="center">停止并移除所有容器、网络</td>
</tr>
<tr>
<td align="center">Commands</td>
<td align="center">ps</td>
<td align="center">列出所有启动的容器</td>
</tr>
<tr>
<td align="center">Commands</td>
<td align="center">logs</td>
<td align="center">查看指定容器的日志</td>
</tr>
<tr>
<td align="center">Commands</td>
<td align="center">stop</td>
<td align="center">停止容器</td>
</tr>
<tr>
<td align="center">Commands</td>
<td align="center">start</td>
<td align="center">启动容器</td>
</tr>
<tr>
<td align="center">Commands</td>
<td align="center">restart</td>
<td align="center">重启容器</td>
</tr>
<tr>
<td align="center">Commands</td>
<td align="center">top</td>
<td align="center">查看运行的进程</td>
</tr>
</tbody></table>
<blockquote>
<p>演示</p>
</blockquote>
<p>1、进入 root 目录</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cd /root</span><br></pre></td></tr></table></figure>

<p>2、删除旧容器</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker rm -f $(docker ps -qa)</span><br></pre></td></tr></table></figure>

<p>3、删除hmall镜像</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker rmi hmall</span><br></pre></td></tr></table></figure>

<p>4、清空MySQL数据</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">rm -rf mysql/data</span><br></pre></td></tr></table></figure>

<p>5、启动所有，<code>-d</code> 参数是后台启动</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker compose up -d</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[+] Building 15.5s (8/8) FINISHED</span><br><span class="line"> =&gt; [internal] load build definition from Dockerfile                                    0.0s</span><br><span class="line"> =&gt; =&gt; transferring dockerfile: 358B                                                    0.0s</span><br><span class="line"> =&gt; [internal] load .dockerignore                                                       0.0s</span><br><span class="line"> =&gt; =&gt; transferring context: 2B                                                         0.0s</span><br><span class="line"> =&gt; [internal] load metadata for docker.io/library/openjdk:11.0-jre-buster             15.4s</span><br><span class="line"> =&gt; [1/3] FROM docker.io/library/openjdk:11.0-jre-buster@sha256:3546a17e6fb4ff4fa681c3  0.0s</span><br><span class="line"> =&gt; [internal] load build context                                                       0.0s</span><br><span class="line"> =&gt; =&gt; transferring context: 98B                                                        0.0s</span><br><span class="line"> =&gt; CACHED [2/3] RUN ln -snf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime &amp;&amp; echo   0.0s</span><br><span class="line"> =&gt; CACHED [3/3] COPY hm-service.jar /app.jar                                           0.0s</span><br><span class="line"> =&gt; exporting to image                                                                  0.0s</span><br><span class="line"> =&gt; =&gt; exporting layers                                                                 0.0s</span><br><span class="line"> =&gt; =&gt; writing image sha256:32eebee16acde22550232f2eb80c69d2ce813ed099640e4cfed2193f71  0.0s</span><br><span class="line"> =&gt; =&gt; naming to docker.io/library/root-hmall                                           0.0s</span><br><span class="line">[+] Running 4/4</span><br><span class="line"> ✔ Network hmall    Created                                                             0.2s</span><br><span class="line"> ✔ Container mysql  Started                                                             0.5s</span><br><span class="line"> ✔ Container hmall  Started                                                             0.9s</span><br><span class="line"> ✔ Container nginx  Started                                                             1.5s</span><br></pre></td></tr></table></figure>

<p>6、查看镜像</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker compose images</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">CONTAINER           REPOSITORY          TAG                 IMAGE ID            SIZE</span><br><span class="line">hmall               root-hmall          latest              32eebee16acd        362MB</span><br><span class="line">mysql               mysql               latest              3218b38490ce        516MB</span><br><span class="line">nginx               nginx               latest              605c77e624dd        141MB</span><br></pre></td></tr></table></figure>

<p>7、查看容器</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker compose ps</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">NAME                IMAGE               COMMAND                  SERVICE             CREATED             STATUS              PORTS</span><br><span class="line">hmall               root-hmall          <span class="string">&quot;java -jar /app.jar&quot;</span>     hmall               54 seconds ago      Up 52 seconds       0.0.0.0:8080-&gt;8080/tcp, :::8080-&gt;8080/tcp</span><br><span class="line">mysql               mysql               <span class="string">&quot;docker-entrypoint.s…&quot;</span>   mysql               54 seconds ago      Up 53 seconds       0.0.0.0:3306-&gt;3306/tcp, :::3306-&gt;3306/tcp, 33060/tcp</span><br><span class="line">nginx               nginx               <span class="string">&quot;/docker-entrypoint.…&quot;</span>   nginx               54 seconds ago      Up 52 seconds       80/tcp, 0.0.0.0:18080-18081-&gt;18080-18081/tcp, :::18080-18081-&gt;18080-18081/tcp</span><br></pre></td></tr></table></figure>

<p>打开浏览器，访问：<a href="http://yourip:8080/">http://YourIp:8080</a></p>
]]></content>
      <categories>
        <category>Tools</category>
      </categories>
      <tags>
        <tag>Docker</tag>
      </tags>
  </entry>
  <entry>
    <title>【步骤四】利用R进行数据可视化分析</title>
    <url>/posts/57262/</url>
    <content><![CDATA[<h1 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h1><p>简介：本文章基于厦门大学提供的<a href="https://dblab.xmu.edu.cn/post/7499/">大数据课程实验案例：网站用户行为分析</a>，通过使用 CentOS 操作编写而来。具体介绍请打开链接进行阅读。</p>
<p><font color="red">这里介绍几点值得特别注意的事项：</font></p>
<p>1、对于案例所涉及的系统及软件此文档使用的是以下版本，其他软件版本随意：</p>
<ul>
<li>Linux系统（CentOS7）</li>
<li>MySQL（5.7）</li>
<li>Hadoop（3.1.3）</li>
<li>HBase（2.2.2，HBase版本需要和Hadoop版本兼容）</li>
<li>Hive（3.1.2，Hive需要和Hadoop版本兼容）</li>
<li>Sqoop（1.4.7）</li>
<li>R（3.6.0）</li>
<li>IDEA（ 2023.3.6 社区版）</li>
</ul>
<p><font color="red"><strong>PS：Hadoop 与 HBase、Hive 版本一定要兼容！！！版本一定要兼容！！！这很重要！！！</strong></font>😃😃😃其他软件随意。</p>
<p>2、本文章所有<strong>下载</strong>的所有软件均在 <code>/</code> 目录下。所有<strong>安装</strong>的所有软件均在 <code>/usr/local/</code> 目录下以 <code>软件名-版本号</code> 方式命名。在进行每个软件的安装操作之前请先<strong>整体阅读</strong>整个软件安装流程的文章有个整体思路，<strong>了解到安装此软件需要做哪些设置再进行操作</strong>，这样可以避免很多不必要的麻烦。</p>
<p>3、<font color="red"><strong>此案例分为五个步骤，请按照步骤顺序进行阅读！！</strong>🙂🙂</font></p>
<h1 id="1-环境"><a href="#1-环境" class="headerlink" title="1. 环境"></a>1. 环境</h1><p>1、由于官方仓库中没有 R 的软件包所以需要先安装 epel-release 软件包</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 先安装epel-release软件包</span></span><br><span class="line">sudo yum install -y epel-release</span><br></pre></td></tr></table></figure>

<p>EPEL (Extra Packages for Enterprise Linux) 是一个基于Fedora的项目，为 RHEL(Red Hat Enterprise Linux)及其衍生发行版如 CentOS、Scientific Linux 等提供额外的软件包。安装 epel-release 软件包可以扩展这些系统上的软件包选择，特别是那些官方仓库中没有的软件包或更新版本的软件包。</p>
<p>2、安装 R 语言</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo yum -y install R</span><br></pre></td></tr></table></figure>

<p>安装结束后，可以执行下面命令启动 R：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">R</span><br></pre></td></tr></table></figure>

<p>启动后，会显示如下信息，并进入 <code>&gt;</code> 命令提示符状态：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/R%E5%AE%89%E8%A3%85%E6%88%90%E5%8A%9F.png"></p>
<p><code>&gt;</code> 就是 R 的命令提示符，你可以在后面输入 R 语言命令。可以执行下面命令退出R：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">q<span class="punctuation">(</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<h1 id="2-可视化分析MySQL中的数据"><a href="#2-可视化分析MySQL中的数据" class="headerlink" title="2. 可视化分析MySQL中的数据"></a>2. 可视化分析MySQL中的数据</h1><h2 id="2-1-安装依赖库"><a href="#2-1-安装依赖库" class="headerlink" title="2.1 安装依赖库"></a>2.1 安装依赖库</h2><p>为了完成可视化功能，我们需要为 R 安装一些依赖库，包括：<code>RMySQL</code>、<code>ggplot2</code>、<code>devtools</code> 和 <code>recharts</code>。</p>
<ul>
<li><code>RMySQL</code> 是一个提供了访问 MySQL 数据库的R语言接口程序的R语言依赖库。</li>
<li><code>ggplot2</code> 和 <code>recharts</code> 则是R语言中提供绘图可视化功能的依赖库。</li>
</ul>
<p>启动 R 进入 R 命令提示符状态，执行如下命令安装 RMySQL：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">install.packages<span class="punctuation">(</span><span class="string">&#x27;RMySQL&#x27;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<p>上面命令执行后， 屏幕会提示 <code>Would you like to user a personal library instead?(y/n)</code> 等问题，只要遇到提问，都在键盘输入y后回车即可。然后，屏幕会显示 <code>---在此连线阶段时请选用CRAN的镜子---</code> ，并会弹出一个白色背景的竖条形窗口，窗口标题是 <code>HTTPS CRAN mirros</code>，标题下面列出了很多国家的镜像列表，我们可以选择位于 China 的镜像，比如，选择 <code>China (Beijing 2) [https]</code> ，然后点击 <code>Enter</code> 按钮，就开始安装了。安装过程需要几分钟(当然，也和当前网络速度有关系)。</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/%E8%AF%B7%E9%80%89%E7%94%A8CRAN%E7%9A%84%E9%95%9C%E5%AD%90.png" style="zoom: 67%;">

<p>由于不同用户的开发环境(虚拟机)不一样，安装有很大可能因为缺少组件导致失败，如果出现如下错误信息：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/%E7%BC%BA%E5%B0%91%E7%BB%84%E4%BB%B6%E5%AF%BC%E8%87%B4%E5%A4%B1%E8%B4%A5.png" style="zoom:67%;">

<p>只要根据错误给出的错误信息，进行操作即可。<code>q()</code> 退出 R 命令提示符状态，回到 Shell 状态，根据上面的英文错误信息，就需要在Shell 命令提示符状态下执行下面命令安装 <code>libmariadb-client-lgpl-dev</code> ：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo yum -y install mariadb-devel</span><br></pre></td></tr></table></figure>

<p>然后，再次输入下面命令进入 R 命令提示符状态：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">R</span><br></pre></td></tr></table></figure>

<p>成功会出现以下信息：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">下载的程序包在</span><br><span class="line">        ‘/tmp/RtmpyKeMBU/downloaded_packages’里</span><br></pre></td></tr></table></figure>

<p>和上面一样继续安装以下包，如果还出现缺少组件的错误，请按照上面的解决方案解决！：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">install.packages<span class="punctuation">(</span><span class="string">&#x27;ggplot2&#x27;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">install.packages<span class="punctuation">(</span><span class="string">&#x27;devtools&#x27;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">install.packages<span class="punctuation">(</span><span class="string">&#x27;DBI&#x27;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<p>如果在上面安装包的过程中，又出现了错误，处理方法很简单，还是按照上面介绍的方法，根据屏幕上给出的英文错误信息，缺少什么软件，就用 <code>sudo yum -y install</code> 命令安装该软件就可以了。我在 CentOS上执行安装时，用到了以下几个软件，安装命令如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo yum -y install harfbuzz-devel fribidi-devel fontconfig-devel libfreetype6-dev libjpeg-turbo-devel</span><br></pre></td></tr></table></figure>

<p>你在安装过程中，可能会出现不同的错误，按照同样的处理方法可以顺利解决。</p>
<p><font color="red">PS：在 CentOS 系统和 Ubuntu 系统软件名可能会有差异，在安装时会提示找不到可用的包，你可以在英文错误信息中找到软件包关键字使用以下命令进行包的查找。</font>😀</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查找特定的包</span></span><br><span class="line">yum list | grep &lt;package_name&gt;</span><br></pre></td></tr></table></figure>

<p>上面的包安装好后，下面在 R 命令提示符下再执行如下命令安装 <code>taiyun/recharts</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">devtools::install_github(&#x27;taiyun/recharts&#x27;)</span><br></pre></td></tr></table></figure>

<h2 id="2-2-分析"><a href="#2-2-分析" class="headerlink" title="2.2 分析"></a>2.2 分析</h2><p>以下分析使用的函数方法，都可以使用如下命令查询函数的相关文档。例如：查询 <code>sort()</code> 函数如何使用</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line"><span class="operator">?</span>sort</span><br></pre></td></tr></table></figure>

<p>这时，就会进入冒号 <code>:</code> 提示符状态(也就是帮助文档状态)，在冒号后面输入q即可退出帮助文档状态，返回到 R 提示符状态！</p>
<p>连接 MySQL 获取数据，请在 Linux 系统中新建另外一个终端，然后执行下面命令启动 MySQL 数据库：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 启动 MySQL</span></span><br><span class="line">sudo systemctl start mysqld</span><br></pre></td></tr></table></figure>

<p>然后进入 MySQL 命令提示符状态：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">mysql -u root -p</span><br></pre></td></tr></table></figure>

<p>会提示你输入密码，输入密码，就进入了 <code>mysql&gt;</code> 提示符状态，下面就可以输入一些 SQL 语句查询数据：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">use dblab;</span><br><span class="line">select * from user_action limit 10;</span><br></pre></td></tr></table></figure>

<p>这样，就可以查看到数据库 dblab 中的 <code>user_action</code> 表的前10行记录，如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">+--------+-----------+-----------+---------------+---------------+------------+-----------+</span><br><span class="line">| id     | uid       | item_id   | behavior_type | item_category | visit_date | province  |</span><br><span class="line">+--------+-----------+-----------+---------------+---------------+------------+-----------+</span><br><span class="line">| 225651 | 102865660 | 237147749 | 1             | 5689          | 2014-12-04 | 黑龙江    |</span><br><span class="line">| 225652 | 102865660 | 395294600 | 1             | 3099          | 2014-12-11 | 山西      |</span><br><span class="line">| 225653 | 102865660 | 164310319 | 1             | 5027          | 2014-12-08 | 江苏      |</span><br><span class="line">| 225654 | 102865660 | 72511722  | 1             | 1121          | 2014-12-13 | 西藏      |</span><br><span class="line">| 225655 | 102865660 | 334372932 | 1             | 5027          | 2014-11-30 | 甘肃      |</span><br><span class="line">| 225656 | 102865660 | 323237439 | 1             | 5027          | 2014-12-02 | 广东      |</span><br><span class="line">| 225657 | 102865660 | 323237439 | 1             | 5027          | 2014-12-07 | 重庆市    |</span><br><span class="line">| 225658 | 102865660 | 34102362  | 1             | 1863          | 2014-12-13 | 宁夏      |</span><br><span class="line">| 225659 | 102865660 | 373499226 | 1             | 12388         | 2014-11-26 | 黑龙江    |</span><br><span class="line">| 225660 | 102865660 | 271583890 | 1             | 5027          | 2014-12-06 | 福建      |</span><br><span class="line">+--------+-----------+-----------+---------------+---------------+------------+-----------+</span><br><span class="line">10 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>然后切换到刚才已经打开的R命令提示符终端窗口：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">library<span class="punctuation">(</span>DBI<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>RMySQL<span class="punctuation">)</span></span><br><span class="line">conn <span class="operator">&lt;-</span> dbConnect<span class="punctuation">(</span>MySQL<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span>dbname<span class="operator">=</span><span class="string">&#x27;dblab&#x27;</span><span class="punctuation">,</span>username<span class="operator">=</span><span class="string">&#x27;root&#x27;</span><span class="punctuation">,</span>password<span class="operator">=</span><span class="string">&#x27;root&#x27;</span><span class="punctuation">,</span>host<span class="operator">=</span><span class="string">&quot;127.0.0.1&quot;</span><span class="punctuation">,</span>port<span class="operator">=</span><span class="number">3306</span><span class="punctuation">)</span></span><br><span class="line">user_action <span class="operator">&lt;-</span> dbGetQuery<span class="punctuation">(</span>conn<span class="punctuation">,</span><span class="string">&#x27;select * from user_action&#x27;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<p>1、分析消费者对商品的行为</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">summary<span class="punctuation">(</span>user_action<span class="operator">$</span>behavior_type<span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<p><code>summary()</code> 函数可以得到样本数据类型和长度,如果样本是数值型,我们还能得到样本数据的最小值、最大值、四分位数以及均值信息。<br>得到结果：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Length     Class      Mode </span><br><span class="line">300000 character character </span><br></pre></td></tr></table></figure>

<p>可以看出原来的 MySQL 数据中，消费者行为变量的类型是字符型。这样不好做比较，需要把消费者行为变量转换为数值型变量</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">summary<span class="punctuation">(</span><span class="built_in">as.numeric</span><span class="punctuation">(</span>user_action<span class="operator">$</span>behavior_type<span class="punctuation">)</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<p>得到结果：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"> Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span><br><span class="line">1.000   1.000   1.000   1.105   1.000   4.000 </span><br></pre></td></tr></table></figure>

<p>接下来用柱状图表示：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">library<span class="punctuation">(</span>ggplot2<span class="punctuation">)</span></span><br><span class="line">ggplot<span class="punctuation">(</span>user_action<span class="punctuation">,</span>aes<span class="punctuation">(</span><span class="built_in">as.numeric</span><span class="punctuation">(</span>behavior_type<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span>geom_histogram<span class="punctuation">(</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<p>在使用 <code>ggplot2</code> 库的时候，需要使用library导入库。ggplot()绘制时，创建绘图对象，即第一个图层，包含两个参数(数据与变量名称映射)。变量名称需要被包含aes函数里面。<code>ggplot2</code> 的图层与图层之间用 <code>+</code> 进行连接。<code>ggplot2</code> 包中的 <code>geom_histogram()</code> 可以很方便的实现直方图的绘制。</p>
<p>分析结果如下图:</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/%E6%9F%B1%E7%8A%B6%E5%9B%BE.png" style="zoom:50%;">

<p>从上图可以得到：大部分消费者行为仅仅只是浏览。只有很少部分的消费者会购买商品。</p>
<p>2、分析哪一类商品被购买总量前十的商品和被购买总量</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 获取子数据集</span></span><br><span class="line">temp <span class="operator">&lt;-</span> subset<span class="punctuation">(</span>user_action<span class="punctuation">,</span><span class="built_in">as.numeric</span><span class="punctuation">(</span>behavior_type<span class="punctuation">)</span><span class="operator">==</span><span class="number">4</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#排序</span></span><br><span class="line">count <span class="operator">&lt;-</span> sort<span class="punctuation">(</span>table<span class="punctuation">(</span>temp<span class="operator">$</span>item_category<span class="punctuation">)</span><span class="punctuation">,</span>decreasing <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取第1到10个排序结果</span></span><br><span class="line">print<span class="punctuation">(</span>count<span class="punctuation">[</span><span class="number">1</span><span class="operator">:</span><span class="number">10</span><span class="punctuation">]</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<p><code>subset()</code> 函数，从某一个数据框中选择出符合某条件的数据或是相关的列.table()对应的就是统计学中的列联表，是一种记录频数的方法。<code>sort()</code> 进行排序，返回排序后的数值向量。</p>
<p>得到结果：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">6344  1863  5232 12189  7957  4370 13230 11537  1838  5894 </span><br><span class="line">  79    46    45    42    40    34    33    32    31    30 </span><br></pre></td></tr></table></figure>

<p>结果第一行表示商品分类,该类下被消费的数次。</p>
<p>接下来用散点图表示：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line"><span class="comment">#将count矩阵结果转换成数据框</span></span><br><span class="line">result <span class="operator">&lt;-</span> as.data.frame<span class="punctuation">(</span>count<span class="punctuation">[</span><span class="number">1</span><span class="operator">:</span><span class="number">10</span><span class="punctuation">]</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">ggplot<span class="punctuation">(</span>result<span class="punctuation">,</span>aes<span class="punctuation">(</span>Var1<span class="punctuation">,</span>Freq<span class="punctuation">,</span>col<span class="operator">=</span>factor<span class="punctuation">(</span>Var1<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span>geom_point<span class="punctuation">(</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<p>通过 <code>as.data.frame()</code> 把矩阵等转换成为数据框。</p>
<p>分析结果如下图：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/%E6%95%A3%E7%82%B9%E5%9B%BE.png" style="zoom: 50%;">



<p>3、分析每年的哪个月份购买商品的量最多</p>
<p>从 MySQL 直接获取的数据中 <code>visit_date</code> 变量都是 2014 年份,并没有划分出具体的月份，那么可以在数据集增加一列月份数据。</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line"><span class="comment"># visit_date变量中截取月份</span></span><br><span class="line">month <span class="operator">&lt;-</span> substr<span class="punctuation">(</span>user_action<span class="operator">$</span>visit_date<span class="punctuation">,</span><span class="number">6</span><span class="punctuation">,</span><span class="number">7</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># user_action增加一列月份数据</span></span><br><span class="line">user_action <span class="operator">&lt;-</span> cbind<span class="punctuation">(</span>user_action<span class="punctuation">,</span>month<span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<p>接下来用柱状图分别表示消费者购买量</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">ggplot<span class="punctuation">(</span>user_action<span class="punctuation">,</span>aes<span class="punctuation">(</span><span class="built_in">as.numeric</span><span class="punctuation">(</span>behavior_type<span class="punctuation">)</span><span class="punctuation">,</span>col<span class="operator">=</span>factor<span class="punctuation">(</span>month<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span>geom_histogram<span class="punctuation">(</span><span class="punctuation">)</span><span class="operator">+</span>facet_grid<span class="punctuation">(</span>.<span class="operator">~</span>month<span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<p><code>aes()</code> 函数中的 col 属性可以用来设置颜色。<code>factor()</code> 函数则是把数值变量转换成分类变量，作用是以不同的颜色表示。如果不使用<code>factor()</code> 函数，颜色将以同一种颜色渐变的颜色表现。 <code>facet_grid(.~month)</code> 表示柱状图按照不同月份进行分区。</p>
<p>由于 MySQL 获取的数据中只有11月份和12月份的数据，所以上图只有显示两个表格。</p>
<p>分析结果如下图：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/%E6%B6%88%E8%B4%B9%E8%80%85%E8%B4%AD%E4%B9%B0%E9%87%8F%E6%9F%B1%E7%8A%B6%E5%9B%BE.png" style="zoom:50%;">

<p>4、分析国内哪个省份的消费者最有购买欲望</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">library<span class="punctuation">(</span>recharts<span class="punctuation">)</span></span><br><span class="line">rel <span class="operator">&lt;-</span> as.data.frame<span class="punctuation">(</span>table<span class="punctuation">(</span>temp<span class="operator">$</span>province<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">provinces <span class="operator">&lt;-</span> rel<span class="operator">$</span>Var1</span><br><span class="line">x <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line"><span class="keyword">for</span><span class="punctuation">(</span>n <span class="keyword">in</span> provinces<span class="punctuation">)</span><span class="punctuation">&#123;</span></span><br><span class="line">x<span class="punctuation">[</span><span class="built_in">length</span><span class="punctuation">(</span>x<span class="punctuation">)</span><span class="operator">+</span><span class="number">1</span><span class="punctuation">]</span> <span class="operator">=</span> nrow<span class="punctuation">(</span>subset<span class="punctuation">(</span>temp<span class="punctuation">,</span><span class="punctuation">(</span>province<span class="operator">==</span>n<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置地图信息</span></span><br><span class="line">mapData <span class="operator">&lt;-</span> data.frame<span class="punctuation">(</span>province<span class="operator">=</span>rel<span class="operator">$</span>Var1<span class="punctuation">,</span>count<span class="operator">=</span>x<span class="punctuation">,</span> stringsAsFactors<span class="operator">=</span><span class="built_in">F</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#画出中国地图</span></span><br><span class="line">eMap<span class="punctuation">(</span>mapData<span class="punctuation">,</span> namevar<span class="operator">=</span><span class="operator">~</span>province<span class="punctuation">,</span> datavar <span class="operator">=</span> <span class="operator">~</span>count<span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<p><code>nrow()</code> 用来计算数据集的行数。</p>
<p>分析结果如下图：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/%E5%85%A8%E5%9B%BD%E6%95%B0%E6%8D%AE%E5%9B%BE.png" style="zoom:50%;">

<p><strong>大数据案例网站用户购物行为分析所有实验步骤到此结束！！！！！</strong></p>
<p><strong>大数据案例网站用户购物行为分析所有实验步骤到此结束！！！！！</strong></p>
<p>😀😀😀😀😀😀😀😀😀😀😀😀😀😀😀😀😀😀😀😀😀😀</p>
]]></content>
      <categories>
        <category>BigData</category>
      </categories>
      <tags>
        <tag>R</tag>
      </tags>
  </entry>
  <entry>
    <title>【步骤三】Hive、MySQL、HBase数据互导</title>
    <url>/posts/53835/</url>
    <content><![CDATA[<h1 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h1><p>简介：本文章基于厦门大学提供的<a href="https://dblab.xmu.edu.cn/post/7499/">大数据课程实验案例：网站用户行为分析</a>，通过使用 CentOS 操作编写而来。具体介绍请打开链接进行阅读。</p>
<p><font color="red">这里介绍几点值得特别注意的事项：</font></p>
<p>1、对于案例所涉及的系统及软件此文档使用的是以下版本，其他软件版本随意：</p>
<ul>
<li>Linux系统（CentOS7）</li>
<li>MySQL（5.7）</li>
<li>Hadoop（3.1.3）</li>
<li>HBase（2.2.2，HBase版本需要和Hadoop版本兼容）</li>
<li>Hive（3.1.2，Hive需要和Hadoop版本兼容）</li>
<li>Sqoop（1.4.7）</li>
<li>R（3.6.0）</li>
<li>IDEA（ 2023.3.6 社区版）</li>
</ul>
<p><font color="red"><strong>PS：Hadoop 与 HBase、Hive 版本一定要兼容！！！版本一定要兼容！！！这很重要！！！</strong></font>😃😃😃其他软件随意。</p>
<p>2、本文章所有<strong>下载</strong>的所有软件均在 <code>/</code> 目录下。所有<strong>安装</strong>的所有软件均在 <code>/usr/local/</code> 目录下以 <code>软件名-版本号</code> 方式命名。在进行每个软件的安装操作之前请先<strong>整体阅读</strong>整个软件安装流程的文章有个整体思路，<strong>了解到安装此软件需要做哪些设置再进行操作</strong>，这样可以避免很多不必要的麻烦。</p>
<p>3、<font color="red"><strong>此案例分为五个步骤，请按照步骤顺序进行阅读！！</strong>🙂🙂</font></p>
<h1 id="1-Hive预操作"><a href="#1-Hive预操作" class="headerlink" title="1. Hive预操作"></a>1. Hive预操作</h1><p>1、启动 MySQL 数据库</p>
<p>因为需要借助于 MySQL 保存 Hive 的元数据，所以，请首先启动 MySQL 数据库，请在终端中输入下面命令：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看 MySQL 状态</span></span><br><span class="line">systemctl status mysqld</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动 MySQL</span></span><br><span class="line">sudo systemctl start mysqld</span><br></pre></td></tr></table></figure>

<p>2、启动 Hadoop</p>
<p>由于 Hive 是基于 Hadoop 的数据仓库，使用 HiveQL 语言撰写的查询语句，最终都会被 Hive 自动解析成 MapReduce 任务由 Hadoop 去具体执行，因此，需要启动 Hadoop，然后再启动 Hive。</p>
<p>请执行下面命令启动 Hadoop(如果你已经启动了 Hadoop 就不用再次启动了)：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动 Hadoop</span></span><br><span class="line">start-all.sh</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看当前运行的进程</span></span><br><span class="line">jps</span><br></pre></td></tr></table></figure>

<p>如果出现下面这些进程，说明Hadoop启动成功了。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">NameNode</span><br><span class="line">DataNode</span><br><span class="line">NodeManager</span><br><span class="line">Jps</span><br><span class="line">SecondaryNameNode</span><br><span class="line">ResourceManager</span><br></pre></td></tr></table></figure>

<p>3、启动进入 Hive：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">hive</span><br></pre></td></tr></table></figure>

<p>通过上述过程，我们就完成了 MySQL、Hadoop 和 Hive 三者的启动。启动成功以后，就进入了 <code>hive&gt;</code> 命令提示符状态，可以输入类似SQL 语句的 HiveQL 语句。</p>
<p>然后，在 <code>hive&gt;</code> 命令提示符状态下执行下面命令：</p>
<p>(1) 创建临时表 user_action</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">create table dblab.user_action(id STRING,uid STRING, item_id STRING, behavior_type STRING, item_category STRING, visit_date DATE, province STRING) COMMENT &#x27;Welcome to XMU dblab! &#x27; ROW FORMAT DELIMITED FIELDS TERMINATED BY &#x27;\t&#x27; STORED AS TEXTFILE;</span><br></pre></td></tr></table></figure>

<p>这个命令执行完以后，Hive 会自动在 HDFS 文件系统中创建对应的数据文件<code>/user/hive/warehouse/dblab.db/user_action</code><br>我们可以新建一个终端，执行命令查看一下，确认这个数据文件在 HDFS 中确实被创建了，请在新建的终端中执行下面命令：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">hdfs dfs -ls /user/hive/warehouse/dblab.db</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">drwxr-xr-x   - muyoukule supergroup          0 2024-03-24 02:06 /user/hive/warehouse/dblab.db/scan</span><br><span class="line">drwxr-xr-x   - muyoukule supergroup          0 2024-03-24 02:15 /user/hive/warehouse/dblab.db/user_action</span><br></pre></td></tr></table></figure>

<p>这说明，这个数据文件在 HDFS 中确实被创建了。注意，这个 HDFS 中的数据文件，在我们后面的 “使用 HBase Java API 把数据从本地导入到 HBase 中” 操作中会使用到。</p>
<p>(2) 将 <code>bigdata_user</code> 表中的数据插入到 <code>user_action</code> (执行时间：10秒左右)</p>
<p>在第二个步骤—— Hive 数据分析中，我们已经在 Hive 中的 dblab 数据库中创建了一个外部表 <code>bigdata_user</code>。下面把<code>dblab.bigdata_user</code> 数据插入到 <code>dblab.user_action</code> 表中，命令如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">INSERT OVERWRITE TABLE dblab.user_action select * from dblab.bigdata_user;</span><br></pre></td></tr></table></figure>

<p>请执行下面命令查询上面的插入命令是否成功执行：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">select * from dblab.user_action limit 10;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">OK</span><br><span class="line">1       10001082        285259775       1       4076    2014-12-08      吉林</span><br><span class="line">2       10001082        4368907 1       5503    2014-12-12      贵州</span><br><span class="line">3       10001082        4368907 1       5503    2014-12-12      西藏</span><br><span class="line">4       10001082        53616768        1       9762    2014-12-02      江苏</span><br><span class="line">5       10001082        151466952       1       5232    2014-12-12      青海</span><br><span class="line">6       10001082        53616768        4       9762    2014-12-02      广西</span><br><span class="line">7       10001082        290088061       1       5503    2014-12-12      台湾</span><br><span class="line">8       10001082        298397524       1       10894   2014-12-12      辽宁</span><br><span class="line">9       10001082        32104252        1       6513    2014-12-12      内蒙古</span><br><span class="line">10      10001082        323339743       1       10894   2014-12-12      四川</span><br><span class="line">Time taken: 0.132 seconds, Fetched: 10 row(s)</span><br></pre></td></tr></table></figure>

<h1 id="2-使用-Sqoop-将数据从-Hive-导入-MySQL"><a href="#2-使用-Sqoop-将数据从-Hive-导入-MySQL" class="headerlink" title="2. 使用 Sqoop 将数据从 Hive 导入 MySQL"></a>2. 使用 Sqoop 将数据从 Hive 导入 MySQL</h1><p>1、启动Hadoop集群、MySQL服务</p>
<p>前面我们已经启动了Hadoop集群和MySQL服务。这里请确认已经按照前面操作启动成功。</p>
<p>2、将前面生成的临时表数据从Hive导入到 MySQL 中，包含如下四个步骤。</p>
<p>(1) 登录 MySQL</p>
<p>请在 Linux 系统中新建一个终端，执行下面命令：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">mysql -uroot -p</span><br></pre></td></tr></table></figure>

<p>为了简化操作，本教程直接使用 root 用户登录 MySQL 数据库。但是，在实际应用中，建议在 MySQL 中再另外创建一个用户。</p>
<p>执行上面命令以后，就进入了 <code>mysql&gt;</code> 命令提示符状态。</p>
<p>(2) 创建数据库</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"> #显示所有数据库</span><br><span class="line">show databases;</span><br><span class="line"></span><br><span class="line">#创建dblab数据库</span><br><span class="line">create database dblab;</span><br><span class="line"></span><br><span class="line">#使用数据库</span><br><span class="line">use dblab;</span><br></pre></td></tr></table></figure>

<p><strong>PS：请使用下面命令查看数据库的编码：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">show variables like &quot;char%&quot;;</span><br></pre></td></tr></table></figure>

<p>会显示类似下面的结果：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">+--------------------------+----------------------------+</span><br><span class="line">| Variable_name            | Value                      |</span><br><span class="line">+--------------------------+----------------------------+</span><br><span class="line">| character_set_client     | utf8                       |</span><br><span class="line">| character_set_connection | utf8                       |</span><br><span class="line">| character_set_database   | latin1                     |</span><br><span class="line">| character_set_filesystem | binary                     |</span><br><span class="line">| character_set_results    | utf8                       |</span><br><span class="line">| character_set_server     | latin1                     |</span><br><span class="line">| character_set_system     | utf8                       |</span><br><span class="line">| character_sets_dir       | /usr/share/mysql/charsets/ |</span><br><span class="line">+--------------------------+----------------------------+</span><br><span class="line">8 rows in set (0.01 sec)</span><br></pre></td></tr></table></figure>

<p>请确认当前编码为 <code>utf8</code>，否则无法导入中文。如果不是 <code>utf8</code>则需要找到自己 MySQL 的配置文件(不同的安装方式对应的配置文件位置不同)，<code>yum</code> 方式安装的 MySQL 配置文件所在位置为 <code>/etc/my.cnf</code> 。找到之后使用 vim 编辑器打开：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改 MySQL 配置文件，目录根据安装时自行查找</span></span><br><span class="line">sudo vim /etc/my.cnf</span><br></pre></td></tr></table></figure>

<p>打开后在配置文件中添加 <code>character_set_server=utf8</code>：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/MySQL%E9%85%8D%E7%BD%AE%E5%AD%97%E7%AC%A6%E9%9B%86.png" style="zoom: 50%;">

<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改完后重启 MySQL 服务</span></span><br><span class="line">sudo systemctl restart mysqld</span><br></pre></td></tr></table></figure>

<p>下面是修改了编码格式后的结果：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">+--------------------------+----------------------------+</span><br><span class="line">| Variable_name            | Value                      |</span><br><span class="line">+--------------------------+----------------------------+</span><br><span class="line">| character_set_client     | utf8                       |</span><br><span class="line">| character_set_connection | utf8                       |</span><br><span class="line">| character_set_database   | utf8                       |</span><br><span class="line">| character_set_filesystem | binary                     |</span><br><span class="line">| character_set_results    | utf8                       |</span><br><span class="line">| character_set_server     | utf8                       |</span><br><span class="line">| character_set_system     | utf8                       |</span><br><span class="line">| character_sets_dir       | /usr/share/mysql/charsets/ |</span><br><span class="line">+--------------------------+----------------------------+</span><br><span class="line">8 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>(3) 创建表</p>
<p>下面在 MySQL 的数据库 <code>dblab</code> 中创建一个新表 <code>user_action</code>，并设置其编码为 <code>utf-8</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">CREATE TABLE `dblab`.`user_action` (`id` varchar(50),`uid` varchar(50),`item_id` varchar(50),`behavior_type` varchar(10),`item_category` varchar(50), `visit_date` DATE,`province` varchar(20)) ENGINE=InnoDB DEFAULT CHARSET=utf8;</span><br></pre></td></tr></table></figure>

<p>PS：语句中的引号是反引号 &#96; ，不是单引号  ’  </p>
<p>创建成功后，输入下面命令退出 MySQL：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">exit</span><br></pre></td></tr></table></figure>

<p>(4) 导入数据(执行时间：20秒左右)</p>
<p>注意，刚才已经退出 MySQL，回到了 Shell 命令提示符状态。下面就可以执行数据导入操作，</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">导入命令</span></span><br><span class="line">sqoop export --connect jdbc:mysql://localhost:3306/dblab?useSSL=false --username root --password root --table user_action --export-dir &#x27;/user/hive/warehouse/dblab.db/user_action&#x27; --fields-terminated-by &#x27;\t&#x27;; </span><br></pre></td></tr></table></figure>

<p>字段解释：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sqoop export			# 表示数据从 hive 复制到 mysql 中</span><br><span class="line">--connect jdbc:mysql://localhost:3306/dblab </span><br><span class="line">--username root			# mysql登陆用户名</span><br><span class="line">--password root			# 登录密码</span><br><span class="line">--table user_action		# mysql 中的表，即将被导入的表名称  </span><br><span class="line">--export-dir &#x27;/user/hive/warehouse/dblab.db/user_action &#x27;	#hive 中被导出的文件 </span><br><span class="line">--fields-terminated-by &#x27;\t&#x27;		#Hive 中被导出的文件字段的分隔符</span><br></pre></td></tr></table></figure>

<p>如果出现错误，找不到或无法加载主类 <code>org.apache.hadoop.mapreduce.v2.app.MRAppMaster</code>：</p>
<p>在命令行下输入如下命令，并将返回的内容复制。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">hadoop classpath</span><br></pre></td></tr></table></figure>

<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/hadoop%20classpath.png" style="zoom:67%;">

<p>将如上信息全部复制，找到自己安装 Hadoop 的路径打开 <code>yarn-site.xml</code> 文件，在后面添加如下配置：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">使用 gedit 编辑器记得直接操作虚拟机</span></span><br><span class="line">gedit /usr/local/hadoop-3.1.3/etc/hadoop/yarn-site.xml</span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.application.classpath<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>输入刚才返回的Hadoop classpath路径<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/yarn-site.xml%E6%B7%BB%E5%8A%A0%E9%85%8D%E7%BD%AE.png" style="zoom:50%;">

<p>在所有的 Master 和 Slave 节点进行如上设置，设置完毕后重启 Hadoop 集群，重新运行刚才的 MapReduce 程序，修改后运行成功：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">2024-03-24 05:18:25,571 INFO mapreduce.Job: Job job_1711280620175_0004 completed successfully</span><br><span class="line">2024-03-24 05:18:25,655 INFO mapreduce.Job: Counters: 32</span><br><span class="line">        File System Counters</span><br><span class="line">                FILE: Number of bytes read=0</span><br><span class="line">                FILE: Number of bytes written=904948</span><br><span class="line">                FILE: Number of read operations=0</span><br><span class="line">                FILE: Number of large read operations=0</span><br><span class="line">                FILE: Number of write operations=0</span><br><span class="line">                HDFS: Number of bytes read=15607365</span><br><span class="line">                HDFS: Number of bytes written=0</span><br><span class="line">                HDFS: Number of read operations=19</span><br><span class="line">                HDFS: Number of large read operations=0</span><br><span class="line">                HDFS: Number of write operations=0</span><br><span class="line">        Job Counters </span><br><span class="line">                Launched map tasks=4</span><br><span class="line">                Data-local map tasks=4</span><br><span class="line">                Total time spent by all maps in occupied slots (ms)=37647</span><br><span class="line">                Total time spent by all reduces in occupied slots (ms)=0</span><br><span class="line">                Total time spent by all map tasks (ms)=37647</span><br><span class="line">                Total vcore-milliseconds taken by all map tasks=37647</span><br><span class="line">                Total megabyte-milliseconds taken by all map tasks=38550528</span><br><span class="line">        Map-Reduce Framework</span><br><span class="line">                Map input records=300000</span><br><span class="line">                Map output records=300000</span><br><span class="line">                Input split bytes=696</span><br><span class="line">                Spilled Records=0</span><br><span class="line">                Failed Shuffles=0</span><br><span class="line">                Merged Map outputs=0</span><br><span class="line">                GC time elapsed (ms)=1097</span><br><span class="line">                CPU time spent (ms)=14110</span><br><span class="line">                Physical memory (bytes) snapshot=1415909376</span><br><span class="line">                Virtual memory (bytes) snapshot=11207258112</span><br><span class="line">                Total committed heap usage (bytes)=1074266112</span><br><span class="line">                Peak Map Physical memory (bytes)=360275968</span><br><span class="line">                Peak Map Virtual memory (bytes)=2806079488</span><br><span class="line">        File Input Format Counters </span><br><span class="line">                Bytes Read=0</span><br><span class="line">        File Output Format Counters </span><br><span class="line">                Bytes Written=0</span><br><span class="line">2024-03-24 05:18:25,659 INFO mapreduce.ExportJobBase: Transferred 14.8843 MB in 31.3371 seconds (486.3743 KB/sec)</span><br><span class="line">2024-03-24 05:18:25,661 INFO mapreduce.ExportJobBase: Exported 300000 records.</span><br></pre></td></tr></table></figure>

<p>3、查看MySQL中user_action表数据</p>
<p>下面需要再次启动 MySQL，进入 <code>mysql&gt;</code> 命令提示符状态：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">mysql -uroot -p</span><br></pre></td></tr></table></figure>

<p>会提示你输入 MySQL 的 root 用户的密码，然后执行下面命令查询 <code>user_action</code> 表中的数据：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">use dblab;</span><br><span class="line">select * from user_action limit 10;</span><br></pre></td></tr></table></figure>

<p>会得到类似下面的查询结果：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">+--------+-----------+-----------+---------------+---------------+------------+-----------+</span><br><span class="line">| id     | uid       | item_id   | behavior_type | item_category | visit_date | province  |</span><br><span class="line">+--------+-----------+-----------+---------------+---------------+------------+-----------+</span><br><span class="line">| 225651 | 102865660 | 237147749 | 1             | 5689          | 2014-12-04 | 黑龙江    |</span><br><span class="line">| 225652 | 102865660 | 395294600 | 1             | 3099          | 2014-12-11 | 山西      |</span><br><span class="line">| 225653 | 102865660 | 164310319 | 1             | 5027          | 2014-12-08 | 江苏      |</span><br><span class="line">| 225654 | 102865660 | 72511722  | 1             | 1121          | 2014-12-13 | 西藏      |</span><br><span class="line">| 225655 | 102865660 | 334372932 | 1             | 5027          | 2014-11-30 | 甘肃      |</span><br><span class="line">| 225656 | 102865660 | 323237439 | 1             | 5027          | 2014-12-02 | 广东      |</span><br><span class="line">| 225657 | 102865660 | 323237439 | 1             | 5027          | 2014-12-07 | 重庆市    |</span><br><span class="line">| 225658 | 102865660 | 34102362  | 1             | 1863          | 2014-12-13 | 宁夏      |</span><br><span class="line">| 225659 | 102865660 | 373499226 | 1             | 12388         | 2014-11-26 | 黑龙江    |</span><br><span class="line">| 225660 | 102865660 | 271583890 | 1             | 5027          | 2014-12-06 | 福建      |</span><br><span class="line">+--------+-----------+-----------+---------------+---------------+------------+-----------+</span><br><span class="line">10 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>从Hive导入数据到MySQL中，成功！</p>
<h1 id="3-使用-Sqoop-将数据从-MySQL-导入-HBase"><a href="#3-使用-Sqoop-将数据从-MySQL-导入-HBase" class="headerlink" title="3. 使用 Sqoop 将数据从 MySQL 导入 HBase"></a>3. 使用 Sqoop 将数据从 MySQL 导入 HBase</h1><p>1、启动 Hadoop 集群、MySQL 服务、HBase 服务</p>
<p>之前我们已经启动了 Hadoop 集群、MySQL 服务，这里请确认已经按照前面操作启动成功。这里我们再启动 HBase 服务。本教程中，HBase的安装目录是 <code>/usr/local/hbase-2.2.2</code>，而且本教程中，HBase 配置为使用 HDFS 存储数据。</p>
<p>请新建一个终端，执行下面命令：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">start-hbase.sh</span><br><span class="line"></span><br><span class="line">jps</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">HRegionServer</span><br><span class="line">Jps</span><br><span class="line">ResourceManager</span><br><span class="line">NameNode</span><br><span class="line">SecondaryNameNode</span><br><span class="line">NodeManager</span><br><span class="line">DataNode</span><br><span class="line">HQuorumPeer</span><br><span class="line">HMaster</span><br></pre></td></tr></table></figure>

<p>2、启动 HBase shell</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">hbase shell</span><br></pre></td></tr></table></figure>

<p>启动成功后，就进入了 <code>hbase&gt;</code> 命令提示符状态。</p>
<p>3、创建表 <code>user_action</code></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">create &#x27;user_action&#x27;, &#123; NAME =&gt; &#x27;f1&#x27;, VERSIONS =&gt; 5&#125;</span><br></pre></td></tr></table></figure>

<p>上面命令在 HBase 中创建了一个 <code>user_action</code> 表，这个表中有一个列族 f1(你愿意把列族名称取为其他名称也可以，比如列族名称为<code>userinfo</code> )，历史版本保留数量为 5 。</p>
<p>4、导入数据(执行时间：30秒左右)</p>
<p>下面新建一个终端，执行下面命令导入数据：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sqoop import --connect jdbc:mysql://localhost:3306/dblab?useSSL=false --username root --password root --table user_action --hbase-table user_action --column-family f1 --hbase-row-key id --hbase-create-table -m 1</span><br></pre></td></tr></table></figure>

<p><font color="red">PS：IP部分改为本机IP地址或localhost。同时，HBase只支持十六进制存储中文。</font></p>
<p>命令解释如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sqoop import --connect jdbc:mysql://localhost:3306/dblab</span><br><span class="line">--username  root</span><br><span class="line">--password  root </span><br><span class="line">--table user_action</span><br><span class="line">--hbase-table user_action 	#HBase中表名称</span><br><span class="line">--column-family f1		#列簇名称</span><br><span class="line">--hbase-row-key id		#HBase 行键</span><br><span class="line">--hbase-create-table	#是否在不存在情况下创建表</span><br><span class="line">-m 1	#启动 Map 数量</span><br></pre></td></tr></table></figure>

<p>如果出现 <code>Exception in thread “main“ java.lang.NoSuchMethodError: org.apache.hadoop.hbase.client.HBaseAdmin.</code> 的错误：根据报错信息提示，HBase 中没有对应的方法执行语句。查看错误，因为对应 HBase 版本太高导致。</p>
<p>解决方法：根据链接下载 <a href="http://archive.apache.org/dist/hbase/1.6.0/">HBase1.6 版本</a>，本地解压，将 lib 文件夹中所有 jar 包上传至虚拟机 <code>$SQOOP_HOME/lib</code> 文件夹中。</p>
<p>修改后再执行上面的 sqoop import 命令以后，会得到类似下面的结果(省略了很多非重要的屏幕信息)：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">        File System Counters</span><br><span class="line">                FILE: Number of bytes read=0</span><br><span class="line">                FILE: Number of bytes written=277341</span><br><span class="line">                FILE: Number of read operations=0</span><br><span class="line">                FILE: Number of large read operations=0</span><br><span class="line">                FILE: Number of write operations=0</span><br><span class="line">                HDFS: Number of bytes read=87</span><br><span class="line">                HDFS: Number of bytes written=0</span><br><span class="line">                HDFS: Number of read operations=1</span><br><span class="line">                HDFS: Number of large read operations=0</span><br><span class="line">                HDFS: Number of write operations=0</span><br><span class="line">        Job Counters </span><br><span class="line">                Launched map tasks=1</span><br><span class="line">                Other local map tasks=1</span><br><span class="line">                Total time spent by all maps in occupied slots (ms)=13618</span><br><span class="line">                Total time spent by all reduces in occupied slots (ms)=0</span><br><span class="line">                Total time spent by all map tasks (ms)=13618</span><br><span class="line">                Total vcore-milliseconds taken by all map tasks=13618</span><br><span class="line">                Total megabyte-milliseconds taken by all map tasks=13944832</span><br><span class="line">        Map-Reduce Framework</span><br><span class="line">                Map input records=300000</span><br><span class="line">                Map output records=300000</span><br><span class="line">                Input split bytes=87</span><br><span class="line">                Spilled Records=0</span><br><span class="line">                Failed Shuffles=0</span><br><span class="line">                Merged Map outputs=0</span><br><span class="line">                GC time elapsed (ms)=217</span><br><span class="line">                CPU time spent (ms)=8620</span><br><span class="line">                Physical memory (bytes) snapshot=425291776</span><br><span class="line">                Virtual memory (bytes) snapshot=2816741376</span><br><span class="line">                Total committed heap usage (bytes)=321388544</span><br><span class="line">                Peak Map Physical memory (bytes)=425291776</span><br><span class="line">                Peak Map Virtual memory (bytes)=2816741376</span><br><span class="line">        File Input Format Counters </span><br><span class="line">                Bytes Read=0</span><br><span class="line">        File Output Format Counters </span><br><span class="line">                Bytes Written=0</span><br><span class="line">2024-03-24 07:06:38,422 INFO mapreduce.ImportJobBase: Transferred 0 bytes in 69.6995 seconds (0 bytes/sec)</span><br><span class="line">2024-03-24 07:06:38,425 INFO mapreduce.ImportJobBase: Retrieved 300000 records.</span><br></pre></td></tr></table></figure>

<p>5、查看 HBase 中 <code>user_action</code> 表数据</p>
<p>现在，再次切换到 HBase Shell 运行的那个终端窗口，在 <code>hbase&gt;</code> 命令提示符下，执行下面命令查询刚才导入的数据：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">只查询前面10行</span></span><br><span class="line">scan &#x27;user_action&#x27;,&#123;LIMIT=&gt;10&#125;  </span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ROW                         COLUMN+CELL                                                                    </span><br><span class="line"> 1                          column=f1:behavior_type, timestamp=1711289186613, value=1                      </span><br><span class="line"> 1                          column=f1:item_category, timestamp=1711289186613, value=4076                   </span><br><span class="line"> 1                          column=f1:item_id, timestamp=1711289186613, value=285259775                    </span><br><span class="line"> 1                          column=f1:province, timestamp=1711289186613, value=\xE6\xB1\x9F\xE8\xA5\xBF    </span><br><span class="line"> 1                          column=f1:uid, timestamp=1711289186613, value=10001082                         </span><br><span class="line"> 1                          column=f1:visit_date, timestamp=1711289186613, value=2014-12-08                </span><br><span class="line"> 10                         column=f1:behavior_type, timestamp=1711289186613, value=1                      </span><br><span class="line"> 10                         column=f1:item_category, timestamp=1711289186613, value=10894                  </span><br><span class="line"> 10                         column=f1:item_id, timestamp=1711289186613, value=323339743                    </span><br><span class="line"> 10                         column=f1:province, timestamp=1711289186613, value=\xE6\xB5\x99\xE6\xB1\x9F    </span><br><span class="line"> 10                         column=f1:uid, timestamp=1711289186613, value=10001082                         </span><br><span class="line"> 10                         column=f1:visit_date, timestamp=1711289186613, value=2014-12-12                </span><br><span class="line"> 100                        column=f1:behavior_type, timestamp=1711289186613, value=1                      </span><br><span class="line"> 100                        column=f1:item_category, timestamp=1711289186613, value=10576                  </span><br><span class="line"> 100                        column=f1:item_id, timestamp=1711289186613, value=275221686                    </span><br><span class="line"> 100                        column=f1:province, timestamp=1711289186613, value=\xE9\xBB\x91\xE9\xBE\x99\xE6</span><br><span class="line">                            \xB1\x9F                                                                       </span><br><span class="line"> 100                        column=f1:uid, timestamp=1711289186613, value=10001082                         </span><br><span class="line"> 100                        column=f1:visit_date, timestamp=1711289186613, value=2014-12-02                </span><br><span class="line"> 1000                       column=f1:behavior_type, timestamp=1711289186910, value=1                      </span><br><span class="line"> 1000                       column=f1:item_category, timestamp=1711289186910, value=3381                   </span><br><span class="line"> 1000                       column=f1:item_id, timestamp=1711289186910, value=168463559                    </span><br><span class="line"> 1000                       column=f1:province, timestamp=1711289186910, value=\xE9\xA6\x99\xE6\xB8\xAF    </span><br><span class="line"> 1000                       column=f1:uid, timestamp=1711289186910, value=100068031                        </span><br><span class="line"> 1000                       column=f1:visit_date, timestamp=1711289186910, value=2014-12-02                </span><br><span class="line"> 10000                      column=f1:behavior_type, timestamp=1711289188323, value=1                      </span><br><span class="line"> 10000                      column=f1:item_category, timestamp=1711289188323, value=12488                  </span><br><span class="line"> 10000                      column=f1:item_id, timestamp=1711289188323, value=45571867                     </span><br><span class="line"> 10000                      column=f1:province, timestamp=1711289188323, value=\xE6\x96\xB0\xE7\x96\x86    </span><br><span class="line"> 10000                      column=f1:uid, timestamp=1711289188323, value=100198255                        </span><br><span class="line"> 10000                      column=f1:visit_date, timestamp=1711289188323, value=2014-12-05                </span><br><span class="line"> 100000                     column=f1:behavior_type, timestamp=1711289190040, value=1                      </span><br><span class="line"> 100000                     column=f1:item_category, timestamp=1711289190040, value=6580                   </span><br><span class="line"> 100000                     column=f1:item_id, timestamp=1711289190040, value=78973192                     </span><br><span class="line"> 100000                     column=f1:province, timestamp=1711289190040, value=\xE5\xA4\xA9\xE6\xB4\xA5\xE5</span><br><span class="line">                            \xB8\x82                                                                       </span><br><span class="line"> 100000                     column=f1:uid, timestamp=1711289190040, value=101480065                        </span><br><span class="line"> 100000                     column=f1:visit_date, timestamp=1711289190040, value=2014-11-29                </span><br><span class="line"> 100001                     column=f1:behavior_type, timestamp=1711289190040, value=1                      </span><br><span class="line"> 100001                     column=f1:item_category, timestamp=1711289190040, value=3472                   </span><br><span class="line"> 100001                     column=f1:item_id, timestamp=1711289190040, value=34929314                     </span><br><span class="line"> 100001                     column=f1:province, timestamp=1711289190040, value=\xE5\xB9\xBF\xE8\xA5\xBF    </span><br><span class="line"> 100001                     column=f1:uid, timestamp=1711289190040, value=101480065                        </span><br><span class="line"> 100001                     column=f1:visit_date, timestamp=1711289190040, value=2014-12-15                </span><br><span class="line"> 100002                     column=f1:behavior_type, timestamp=1711289190040, value=1                      </span><br><span class="line"> 100002                     column=f1:item_category, timestamp=1711289190040, value=10392                  </span><br><span class="line"> 100002                     column=f1:item_id, timestamp=1711289190040, value=401104894                    </span><br><span class="line"> 100002                     column=f1:province, timestamp=1711289190040, value=\xE5\x8C\x97\xE4\xBA\xAC\xE5</span><br><span class="line">                            \xB8\x82                                                                       </span><br><span class="line"> 100002                     column=f1:uid, timestamp=1711289190040, value=101480065                        </span><br><span class="line"> 100002                     column=f1:visit_date, timestamp=1711289190040, value=2014-11-29                </span><br><span class="line"> 100003                     column=f1:behavior_type, timestamp=1711289190040, value=1                      </span><br><span class="line"> 100003                     column=f1:item_category, timestamp=1711289190040, value=5894                   </span><br><span class="line"> 100003                     column=f1:item_id, timestamp=1711289190040, value=217913901                    </span><br><span class="line"> 100003                     column=f1:province, timestamp=1711289190040, value=\xE7\x94\x98\xE8\x82\x83    </span><br><span class="line"> 100003                     column=f1:uid, timestamp=1711289190040, value=101480065                        </span><br><span class="line"> 100003                     column=f1:visit_date, timestamp=1711289190040, value=2014-12-04                </span><br><span class="line"> 100004                     column=f1:behavior_type, timestamp=1711289190040, value=1                      </span><br><span class="line"> 100004                     column=f1:item_category, timestamp=1711289190040, value=12189                  </span><br><span class="line"> 100004                     column=f1:item_id, timestamp=1711289190040, value=295053167                    </span><br><span class="line"> 100004                     column=f1:province, timestamp=1711289190040, value=\xE6\xB9\x96\xE5\x8C\x97    </span><br><span class="line"> 100004                     column=f1:uid, timestamp=1711289190040, value=101480065                        </span><br><span class="line"> 100004                     column=f1:visit_date, timestamp=1711289190040, value=2014-11-26                </span><br><span class="line">10 row(s)</span><br><span class="line">Took 0.3723 seconds </span><br></pre></td></tr></table></figure>

<p>注意，我们用 <code>limit10</code> 是返回 HBase 表中的前面10行数据，但是，上面的结果，从 “行数” 来看，给人一种错误，似乎不是10行，要远远多于10行。这是因为，HBase 在显示数据的时候，和关系型数据库 MySQL 是不同的，每行显示的不是一行记录，而是一个 “单元格”。</p>
<h1 id="4-使用HBase-Java-API把数据从本地导入到HBase中"><a href="#4-使用HBase-Java-API把数据从本地导入到HBase中" class="headerlink" title="4. 使用HBase Java API把数据从本地导入到HBase中"></a>4. 使用HBase Java API把数据从本地导入到HBase中</h1><p>1、启动 Hadoop 集群、HBase 服务</p>
<p>请首先确保启动了 Hadoop 集群和 HBase 服务。如果还没有启动，请在Linux 系统中打开一个终端。</p>
<p>首先，按照下面命令启动 Hadoop、HBase：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动 Hadoop</span></span><br><span class="line">start-all.sh</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动 HBase</span></span><br><span class="line">start-hbase.sh</span><br></pre></td></tr></table></figure>

<p>2、数据准备</p>
<p>实际上，我们也可以编写 Java 程序，直接从 HDFS 中读取数据加载到 HBase。但是，这里我们展示的是如何用 JAVA 程序把本地数据导入到 HBase 中。你只要把程序做简单修改，就可以实现从 HDFS 中读取数据加载到 HBase。</p>
<p>首先，请将之前的 <code>user_action</code> 数据从 HDFS 复制到 Linux 系统的本地文件系统中，命令如下：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cd /usr/local/bigdatacase/dataset</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">将 HDFS 上的 user_action 数据复制到本地当前目录，注意<span class="string">&#x27;.&#x27;</span>表示当前目录</span></span><br><span class="line">hdfs dfs -get /user/hive/warehouse/dblab.db/user_action .</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看前 10 行数据</span></span><br><span class="line">cat ./user_action/* | head -10</span><br></pre></td></tr></table></figure>

<p>结果：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1       10001082        285259775       1       4076    2014-12-08      江西</span><br><span class="line">2       10001082        4368907 1       5503    2014-12-12      西藏</span><br><span class="line">3       10001082        4368907 1       5503    2014-12-12      贵州</span><br><span class="line">4       10001082        53616768        1       9762    2014-12-02      广西</span><br><span class="line">5       10001082        151466952       1       5232    2014-12-12      陕西</span><br><span class="line">6       10001082        53616768        4       9762    2014-12-02      河南</span><br><span class="line">7       10001082        290088061       1       5503    2014-12-12      重庆市</span><br><span class="line">8       10001082        298397524       1       10894   2014-12-12      云南</span><br><span class="line">9       10001082        32104252        1       6513    2014-12-12      安徽</span><br><span class="line">10      10001082        323339743       1       10894   2014-12-12      浙江</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">将00000*文件复制一份重命名为user_action.output，*表示通配符</span></span><br><span class="line">cat ./user_action/00000* &gt; user_action.output</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看user_action.output前10行</span></span><br><span class="line">head user_action.output</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">![muyoukule_2024-03-25_10-38-00](./数据互导/muyoukule_2024-03-25_10-38-00.png)1       10001082        285259775       1       4076    2014-12-08      江西</span><br><span class="line">2       10001082        4368907 1       5503    2014-12-12      西藏</span><br><span class="line">3       10001082        4368907 1       5503    2014-12-12      贵州</span><br><span class="line">4       10001082        53616768        1       9762    2014-12-02      广西</span><br><span class="line">5       10001082        151466952       1       5232    2014-12-12      陕西</span><br><span class="line">6       10001082        53616768        4       9762    2014-12-02      河南</span><br><span class="line">7       10001082        290088061       1       5503    2014-12-12      重庆市</span><br><span class="line">8       10001082        298397524       1       10894   2014-12-12      云南</span><br><span class="line">9       10001082        32104252        1       6513    2014-12-12      安徽</span><br><span class="line">10      10001082        323339743       1       10894   2014-12-12      浙江</span><br></pre></td></tr></table></figure>

<p>3、编写数据导入程序</p>
<p>这里采用 IDEA 编写 Java 程序实现 HBase 数据导入功能。</p>
<p>请使用 IDEA 编写 ImportHBase 程序（ Java 代码在本文最后的附录部分），并打包成可执行 jar 包，命名为 ImportHBase.jar。</p>
<p>然后，请在 <code>/usr/local/bigdatacase/</code> 目录下面新建一个 hbase 子目录，用来存放 ImportHBase.jar。</p>
<p>IEDA 打包成可执行 jar 包：</p>
<p>左上角 <code>File</code> –&gt; Project Structure 打开如下界面，点击 <code>Artifacts</code> –&gt; <code>From moudles with dependencies</code> ，然后依次操作：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/IEDA%20%E6%89%93%E5%8C%85%E6%88%90%E5%8F%AF%E6%89%A7%E8%A1%8C%20jar%20%E5%8C%851.png" style="zoom:50%;">

<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/IEDA%20%E6%89%93%E5%8C%85%E6%88%90%E5%8F%AF%E6%89%A7%E8%A1%8C%20jar%20%E5%8C%852.png" style="zoom:50%;">

<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/IEDA%20%E6%89%93%E5%8C%85%E6%88%90%E5%8F%AF%E6%89%A7%E8%A1%8C%20jar%20%E5%8C%853.png" style="zoom: 50%;">

<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/IEDA%20%E6%89%93%E5%8C%85%E6%88%90%E5%8F%AF%E6%89%A7%E8%A1%8C%20jar%20%E5%8C%854.png"></p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/BigDataIMG/IEDA%20%E6%89%93%E5%8C%85%E6%88%90%E5%8F%AF%E6%89%A7%E8%A1%8C%20jar%20%E5%8C%855.png"></p>
<p>然后就可以在设置的 jar 包输出路径下找到对应 jar 包。</p>
<p>4、数据导入</p>
<p>使用 Java 程序将数据从本地导入 HBase 中，导入前，请先清空 user_action 表。</p>
<p>请在之前已经打开的 HBase Shel l窗口中（也就是在 <code>hbase&gt;</code> 命令提示符下）执行下面操作：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">truncate &#x27;user_action&#x27;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Truncating &#x27;user_action&#x27; table (it may take a while):</span><br><span class="line">Disabling table...</span><br><span class="line">Truncating table...</span><br><span class="line">Took 2.3970 seconds </span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除以后再查看就没有记录了</span></span><br><span class="line">scan &#x27;user_action&#x27;,&#123;LIMIT=&gt;10&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ROW                   COLUMN+CELL                                               </span><br><span class="line">0 row(s)</span><br><span class="line">Took 0.0542 seconds </span><br></pre></td></tr></table></figure>

<p>下面就可以运行 hadoop jar 命令运行程序：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">hadoop jar /usr/local/bigdatacase/hbase/ImportHBase.jar HBaseImportTest /usr/local/bigdatacase/dataset/user_action.output</span><br></pre></td></tr></table></figure>

<p>命令解释如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/usr/local/hadoop/bin/hadoop jar  #hadoop jar包执行方式</span><br><span class="line">/usr/local/bigdatacase/hbase/ImportHBase.jar  #jar包的路径</span><br><span class="line">HBaseImportTest   #主函数入口 </span><br><span class="line">/usr/local/bigdatacase/dataset/user_action.output  #main方法接收的参数args，用来指定输入文件的路径</span><br></pre></td></tr></table></figure>

<p>这个命令大概会执行3分钟左右，执行过程中，屏幕上会打印出执行进度，每执行1万条，对打印出一行信息，所以，整个执行过程屏幕上显示如下信息：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">10000</span><br><span class="line">20000</span><br><span class="line">30000</span><br><span class="line">40000</span><br><span class="line">50000</span><br><span class="line">60000</span><br><span class="line">70000</span><br><span class="line">80000</span><br><span class="line">90000</span><br><span class="line">100000</span><br><span class="line">110000</span><br><span class="line">120000</span><br><span class="line">130000</span><br><span class="line">140000</span><br><span class="line">150000</span><br><span class="line">160000</span><br><span class="line">170000</span><br><span class="line">180000</span><br><span class="line">190000</span><br><span class="line">200000</span><br><span class="line">210000</span><br><span class="line">220000</span><br><span class="line">230000</span><br><span class="line">240000</span><br><span class="line">250000</span><br><span class="line">260000</span><br><span class="line">270000</span><br><span class="line">280000</span><br><span class="line">290000</span><br><span class="line">300000</span><br><span class="line">Total Time: 140506 ms</span><br></pre></td></tr></table></figure>

<p>5、查看 HBase 中 user_action 表数据</p>
<p>下面，再次切换到 HBase Shell 窗口，执行下面命令查询数据：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">只查询前面10行</span></span><br><span class="line">scan &#x27;user_action&#x27;,&#123;LIMIT=&gt;10&#125;  </span><br></pre></td></tr></table></figure>

<p>就可以得到类似下面的查询结果了：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ROW                                           COLUMN+CELL                                                                                                                         </span><br><span class="line"> 1                                            column=f1:behavior_type, timestamp=1711334492967, value=1                                                                           </span><br><span class="line"> 1                                            column=f1:date, timestamp=1711334492967, value=2014-12-08                                                                           </span><br><span class="line"> 1                                            column=f1:item_category, timestamp=1711334492967, value=4076                                                                        </span><br><span class="line"> 1                                            column=f1:item_id, timestamp=1711334492967, value=285259775                                                                         </span><br><span class="line"> 1                                            column=f1:province, timestamp=1711334492967, value=\xE6\xB1\x9F\xE8\xA5\xBF                                                         </span><br><span class="line"> 1                                            column=f1:uid, timestamp=1711334492967, value=10001082                                                                              </span><br><span class="line"> 10                                           column=f1:behavior_type, timestamp=1711334493000, value=1                                                                           </span><br><span class="line"> 10                                           column=f1:date, timestamp=1711334493000, value=2014-12-12                                                                           </span><br><span class="line"> 10                                           column=f1:item_category, timestamp=1711334493000, value=10894                                                                       </span><br><span class="line"> 10                                           column=f1:item_id, timestamp=1711334493000, value=323339743                                                                         </span><br><span class="line"> 10                                           column=f1:province, timestamp=1711334493000, value=\xE6\xB5\x99\xE6\xB1\x9F                                                         </span><br><span class="line"> 10                                           column=f1:uid, timestamp=1711334493000, value=10001082                                                                              </span><br><span class="line"> 100                                          column=f1:behavior_type, timestamp=1711334493295, value=1                                                                           </span><br><span class="line"> 100                                          column=f1:date, timestamp=1711334493295, value=2014-12-02                                                                           </span><br><span class="line"> 100                                          column=f1:item_category, timestamp=1711334493295, value=10576                                                                       </span><br><span class="line"> 100                                          column=f1:item_id, timestamp=1711334493295, value=275221686                                                                         </span><br><span class="line"> 100                                          column=f1:province, timestamp=1711334493295, value=\xE9\xBB\x91\xE9\xBE\x99\xE6\xB1\x9F                                             </span><br><span class="line"> 100                                          column=f1:uid, timestamp=1711334493295, value=10001082                                                                              </span><br><span class="line"> 1000                                         column=f1:behavior_type, timestamp=1711334494583, value=1                                                                           </span><br><span class="line"> 1000                                         column=f1:date, timestamp=1711334494583, value=2014-12-02                                                                           </span><br><span class="line"> 1000                                         column=f1:item_category, timestamp=1711334494583, value=3381                                                                        </span><br><span class="line"> 1000                                         column=f1:item_id, timestamp=1711334494583, value=168463559                                                                         </span><br><span class="line"> 1000                                         column=f1:province, timestamp=1711334494583, value=\xE9\xA6\x99\xE6\xB8\xAF                                                         </span><br><span class="line"> 1000                                         column=f1:uid, timestamp=1711334494583, value=100068031                                                                             </span><br><span class="line"> 10000                                        column=f1:behavior_type, timestamp=1711334500210, value=1                                                                           </span><br><span class="line"> 10000                                        column=f1:date, timestamp=1711334500210, value=2014-12-05                                                                           </span><br><span class="line"> 10000                                        column=f1:item_category, timestamp=1711334500210, value=12488                                                                       </span><br><span class="line"> 10000                                        column=f1:item_id, timestamp=1711334500210, value=45571867                                                                          </span><br><span class="line"> 10000                                        column=f1:province, timestamp=1711334500210, value=\xE6\x96\xB0\xE7\x96\x86                                                         </span><br><span class="line"> 10000                                        column=f1:uid, timestamp=1711334500210, value=100198255                                                                             </span><br><span class="line"> 100000                                       column=f1:behavior_type, timestamp=1711334543592, value=1                                                                           </span><br><span class="line"> 100000                                       column=f1:date, timestamp=1711334543592, value=2014-11-29                                                                           </span><br><span class="line"> 100000                                       column=f1:item_category, timestamp=1711334543592, value=6580                                                                        </span><br><span class="line"> 100000                                       column=f1:item_id, timestamp=1711334543592, value=78973192                                                                          </span><br><span class="line"> 100000                                       column=f1:province, timestamp=1711334543592, value=\xE5\xA4\xA9\xE6\xB4\xA5\xE5\xB8\x82                                             </span><br><span class="line"> 100000                                       column=f1:uid, timestamp=1711334543592, value=101480065                                                                             </span><br><span class="line"> 100001                                       column=f1:behavior_type, timestamp=1711334543592, value=1                                                                           </span><br><span class="line"> 100001                                       column=f1:date, timestamp=1711334543592, value=2014-12-15                                                                           </span><br><span class="line"> 100001                                       column=f1:item_category, timestamp=1711334543592, value=3472                                                                        </span><br><span class="line"> 100001                                       column=f1:item_id, timestamp=1711334543592, value=34929314                                                                          </span><br><span class="line"> 100001                                       column=f1:province, timestamp=1711334543592, value=\xE5\xB9\xBF\xE8\xA5\xBF                                                         </span><br><span class="line"> 100001                                       column=f1:uid, timestamp=1711334543592, value=101480065                                                                             </span><br><span class="line"> 100002                                       column=f1:behavior_type, timestamp=1711334543593, value=1                                                                           </span><br><span class="line"> 100002                                       column=f1:date, timestamp=1711334543593, value=2014-11-29                                                                           </span><br><span class="line"> 100002                                       column=f1:item_category, timestamp=1711334543593, value=10392                                                                       </span><br><span class="line"> 100002                                       column=f1:item_id, timestamp=1711334543593, value=401104894                                                                         </span><br><span class="line"> 100002                                       column=f1:province, timestamp=1711334543593, value=\xE5\x8C\x97\xE4\xBA\xAC\xE5\xB8\x82                                             </span><br><span class="line"> 100002                                       column=f1:uid, timestamp=1711334543593, value=101480065                                                                             </span><br><span class="line"> 100003                                       column=f1:behavior_type, timestamp=1711334543593, value=1                                                                           </span><br><span class="line"> 100003                                       column=f1:date, timestamp=1711334543593, value=2014-12-04                                                                           </span><br><span class="line"> 100003                                       column=f1:item_category, timestamp=1711334543593, value=5894                                                                        </span><br><span class="line"> 100003                                       column=f1:item_id, timestamp=1711334543593, value=217913901                                                                         </span><br><span class="line"> 100003                                       column=f1:province, timestamp=1711334543593, value=\xE7\x94\x98\xE8\x82\x83                                                         </span><br><span class="line"> 100003                                       column=f1:uid, timestamp=1711334543593, value=101480065                                                                             </span><br><span class="line"> 100004                                       column=f1:behavior_type, timestamp=1711334543593, value=1                                                                           </span><br><span class="line"> 100004                                       column=f1:date, timestamp=1711334543593, value=2014-11-26                                                                           </span><br><span class="line"> 100004                                       column=f1:item_category, timestamp=1711334543593, value=12189                                                                       </span><br><span class="line"> 100004                                       column=f1:item_id, timestamp=1711334543593, value=295053167                                                                         </span><br><span class="line"> 100004                                       column=f1:province, timestamp=1711334543593, value=\xE6\xB9\x96\xE5\x8C\x97                                                         </span><br><span class="line"> 100004                                       column=f1:uid, timestamp=1711334543593, value=101480065                                                                             </span><br><span class="line">10 row(s)</span><br><span class="line">Took 0.2652 seconds </span><br></pre></td></tr></table></figure>

<p>实验顺利结束！</p>
<h1 id="附录：ImportHBase-java"><a href="#附录：ImportHBase-java" class="headerlink" title="附录：ImportHBase.java"></a>附录：ImportHBase.java</h1><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.muyoukule;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.conf.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.Cell;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.HBaseConfiguration;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.TableName;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.client.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.util.Bytes;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.BufferedReader;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStreamReader;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HBaseImportTest</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> Configuration config;</span><br><span class="line">    <span class="keyword">public</span> Table table;</span><br><span class="line">    <span class="keyword">public</span> HBaseAdmin admin;</span><br><span class="line">    <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> ConnectionFactory.createConnection();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">HBaseImportTest</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        config = HBaseConfiguration.create();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            table = connection.getTable(TableName.valueOf(<span class="string">&quot;user_action&quot;</span>));</span><br><span class="line">            <span class="comment">// 根据配置创建连接</span></span><br><span class="line">            connection = ConnectionFactory.createConnection(config);</span><br><span class="line">            <span class="comment">// 获取Admin实例</span></span><br><span class="line">            admin = (HBaseAdmin) connection.getAdmin();</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">if</span> (args.length == <span class="number">0</span>) &#123;       <span class="comment">//第一个参数是该jar所使用的类，第二个参数是数据集所存放的路径</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Exception</span>(<span class="string">&quot;You must set input path!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">fileName</span> <span class="operator">=</span> args[args.length - <span class="number">1</span>];  <span class="comment">//输入的文件路径是最后一个参数</span></span><br><span class="line">        <span class="type">HBaseImportTest</span> <span class="variable">test</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HBaseImportTest</span>();</span><br><span class="line">        test.importLocalFileToHBase(fileName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//    /usr/local/bigdatacase/dataset/user_action.output</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">importLocalFileToHBase</span><span class="params">(String fileName)</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">st</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="type">BufferedReader</span> <span class="variable">br</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            br = <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(Files.newInputStream(Paths.get(fileName))));</span><br><span class="line">            <span class="type">String</span> <span class="variable">line</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">while</span> ((line = br.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">                count++;</span><br><span class="line">                put(line);</span><br><span class="line">                <span class="keyword">if</span> (count % <span class="number">10000</span> == <span class="number">0</span>)</span><br><span class="line">                    System.out.println(count);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (br != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    br.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                table.close(); <span class="comment">// must close the client</span></span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">long</span> <span class="variable">en2</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        System.out.println(<span class="string">&quot;Total Time: &quot;</span> + (en2 - st) + <span class="string">&quot; ms&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;deprecation&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">put</span><span class="params">(String line)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        String[] arr = line.split(<span class="string">&quot;\t&quot;</span>, -<span class="number">1</span>);</span><br><span class="line">        String[] column = &#123;<span class="string">&quot;id&quot;</span>, <span class="string">&quot;uid&quot;</span>, <span class="string">&quot;item_id&quot;</span>, <span class="string">&quot;behavior_type&quot;</span>, <span class="string">&quot;item_category&quot;</span>, <span class="string">&quot;date&quot;</span>, <span class="string">&quot;province&quot;</span>&#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (arr.length == <span class="number">7</span>) &#123;</span><br><span class="line">            <span class="type">Put</span> <span class="variable">put</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Put</span>(Bytes.toBytes(arr[<span class="number">0</span>]));<span class="comment">// rowkey</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt; arr.length; i++) &#123;</span><br><span class="line">                put.addColumn(Bytes.toBytes(<span class="string">&quot;f1&quot;</span>), Bytes.toBytes(column[i]), Bytes.toBytes(arr[i]));</span><br><span class="line">            &#125;</span><br><span class="line">            table.put(put); <span class="comment">// put to server</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">get</span><span class="params">(String rowkey, String columnFamily, String column,</span></span><br><span class="line"><span class="params">                    <span class="type">int</span> versions)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">st</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">        <span class="type">Get</span> <span class="variable">get</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Get</span>(Bytes.toBytes(rowkey));</span><br><span class="line">        get.addColumn(Bytes.toBytes(columnFamily), Bytes.toBytes(column));</span><br><span class="line"></span><br><span class="line">        <span class="type">Scan</span> <span class="variable">scanner</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scan</span>(get);</span><br><span class="line">        scanner.setMaxVersions(versions);</span><br><span class="line"></span><br><span class="line">        <span class="type">ResultScanner</span> <span class="variable">rsScanner</span> <span class="operator">=</span> table.getScanner(scanner);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (Result result : rsScanner) &#123;</span><br><span class="line">            <span class="keyword">final</span> List&lt;Cell&gt; list = result.listCells();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">final</span> Cell kv : list) &#123;</span><br><span class="line">                System.out.println(Bytes.toStringBinary(kv.getValueArray()) + <span class="string">&quot;\t&quot;</span></span><br><span class="line">                        + kv.getTimestamp()); <span class="comment">// mid + time</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        rsScanner.close();</span><br><span class="line"></span><br><span class="line">        <span class="type">long</span> <span class="variable">en2</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        System.out.println(<span class="string">&quot;Total Time: &quot;</span> + (en2 - st) + <span class="string">&quot; ms&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>BigData</category>
      </categories>
      <tags>
        <tag>Hadoop</tag>
        <tag>Hive</tag>
        <tag>MySQL</tag>
        <tag>HBase</tag>
        <tag>Sqoop</tag>
      </tags>
  </entry>
  <entry>
    <title>【步骤二】Hive数据分析</title>
    <url>/posts/18969/</url>
    <content><![CDATA[<h1 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h1><p>简介：本文章基于厦门大学提供的<a href="https://dblab.xmu.edu.cn/post/7499/">大数据课程实验案例：网站用户行为分析</a>，通过使用 CentOS 操作编写而来。具体介绍请打开链接进行阅读。</p>
<p><font color="red">这里介绍几点值得特别注意的事项：</font></p>
<p>1、对于案例所涉及的系统及软件此文档使用的是以下版本，其他软件版本随意：</p>
<ul>
<li>Linux系统（CentOS7）</li>
<li>MySQL（5.7）</li>
<li>Hadoop（3.1.3）</li>
<li>HBase（2.2.2，HBase版本需要和Hadoop版本兼容）</li>
<li>Hive（3.1.2，Hive需要和Hadoop版本兼容）</li>
<li>Sqoop（1.4.7）</li>
<li>R（3.6.0）</li>
<li>IDEA（ 2023.3.6 社区版）</li>
</ul>
<p><font color="red"><strong>PS：Hadoop 与 HBase、Hive 版本一定要兼容！！！版本一定要兼容！！！这很重要！！！</strong></font>😃😃😃其他软件随意。</p>
<p>2、本文章所有<strong>下载</strong>的所有软件均在 <code>/</code> 目录下。所有<strong>安装</strong>的所有软件均在 <code>/usr/local/</code> 目录下以 <code>软件名-版本号</code> 方式命名。在进行每个软件的安装操作之前请先<strong>整体阅读</strong>整个软件安装流程的文章有个整体思路，<strong>了解到安装此软件需要做哪些设置再进行操作</strong>，这样可以避免很多不必要的麻烦。</p>
<p>3、<font color="red"><strong>此案例分为五个步骤，请按照步骤顺序进行阅读！！</strong>🙂🙂</font></p>
<h1 id="1-操作Hive"><a href="#1-操作Hive" class="headerlink" title="1. 操作Hive"></a>1. 操作Hive</h1><p>1、启动 MySQL 数据库</p>
<p>因为需要借助于 MySQL 保存 Hive 的元数据，所以，请首先启动 MySQL 数据库，请在终端中输入下面命令：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看 MySQL 状态</span></span><br><span class="line">systemctl status mysqld</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动 MySQL</span></span><br><span class="line">sudo systemctl start mysqld</span><br></pre></td></tr></table></figure>

<p>2、启动 Hadoop</p>
<p>由于 Hive 是基于 Hadoop 的数据仓库，使用 HiveQL 语言撰写的查询语句，最终都会被 Hive 自动解析成 MapReduce 任务由 Hadoop 去具体执行，因此，需要启动 Hadoop，然后再启动 Hive。</p>
<p>请执行下面命令启动 Hadoop(如果你已经启动了 Hadoop 就不用再次启动了)：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动 Hadoop</span></span><br><span class="line">start-all.sh</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看当前运行的进程</span></span><br><span class="line">jps</span><br></pre></td></tr></table></figure>

<p>如果出现下面这些进程，说明Hadoop启动成功了。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">NameNode</span><br><span class="line">DataNode</span><br><span class="line">NodeManager</span><br><span class="line">Jps</span><br><span class="line">SecondaryNameNode</span><br><span class="line">ResourceManager</span><br></pre></td></tr></table></figure>

<p>3、启动进入 Hive：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">hive</span><br></pre></td></tr></table></figure>

<p>通过上述过程，我们就完成了 MySQL、Hadoop 和 Hive 三者的启动。</p>
<p>启动成功以后，就进入了 <code>hive&gt;</code> 命令提示符状态，可以输入类似 SQL 语句的 HiveQL 语句。</p>
<p>4、在 <code>hive&gt;</code> 命令提示符状态下执行下面命令：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 使用dblab数据库</span><br><span class="line">use dblab;</span><br><span class="line"></span><br><span class="line"># 显示数据库中所有表。</span><br><span class="line">show tables;</span><br><span class="line"></span><br><span class="line"># 查看 bigdata_user 表的各种属性；</span><br><span class="line">show create table bigdata_user;</span><br></pre></td></tr></table></figure>

<p>执行结果如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">OK</span><br><span class="line">CREATE EXTERNAL TABLE `bigdata_user`(</span><br><span class="line">  `id` int, </span><br><span class="line">  `uid` string, </span><br><span class="line">  `item_id` string, </span><br><span class="line">  `behavior_type` int, </span><br><span class="line">  `item_category` string, </span><br><span class="line">  `visit_date` date, </span><br><span class="line">  `province` string)</span><br><span class="line">COMMENT &#x27;Welcome to xmu dblab!&#x27;</span><br><span class="line">ROW FORMAT SERDE </span><br><span class="line">  &#x27;org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe&#x27; </span><br><span class="line">WITH SERDEPROPERTIES ( </span><br><span class="line">  &#x27;field.delim&#x27;=&#x27;\t&#x27;, </span><br><span class="line">  &#x27;serialization.format&#x27;=&#x27;\t&#x27;) </span><br><span class="line">STORED AS INPUTFORMAT </span><br><span class="line">  &#x27;org.apache.hadoop.mapred.TextInputFormat&#x27; </span><br><span class="line">OUTPUTFORMAT </span><br><span class="line">  &#x27;org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat&#x27;</span><br><span class="line">LOCATION</span><br><span class="line">  &#x27;hdfs://localhost:9000/bigdatacase/dataset&#x27;</span><br><span class="line">TBLPROPERTIES (</span><br><span class="line">  &#x27;bucketing_version&#x27;=&#x27;2&#x27;, </span><br><span class="line">  &#x27;transient_lastDdlTime&#x27;=&#x27;1711268943&#x27;)</span><br><span class="line">Time taken: 0.124 seconds, Fetched: 23 row(s)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>5、执行下面命令查看表的简单结构：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">desc bigdata_user;</span><br></pre></td></tr></table></figure>

<p>执行结果如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">OK</span><br><span class="line">id                      int                                         </span><br><span class="line">uid                     string                                      </span><br><span class="line">item_id                 string                                      </span><br><span class="line">behavior_type           int                                         </span><br><span class="line">item_category           string                                      </span><br><span class="line">visit_date              date                                        </span><br><span class="line">province                string                                      </span><br><span class="line">Time taken: 0.041 seconds, Fetched: 7 row(s)</span><br></pre></td></tr></table></figure>

<h1 id="2-简单查询分析"><a href="#2-简单查询分析" class="headerlink" title="2. 简单查询分析"></a>2. 简单查询分析</h1><p>1、先测试一下简单的指令：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 看前10位用户对商品的行为</span><br><span class="line">select behavior_type from bigdata_user limit 10;</span><br></pre></td></tr></table></figure>

<p>执行结果如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">OK</span><br><span class="line">1</span><br><span class="line">1</span><br><span class="line">1</span><br><span class="line">1</span><br><span class="line">1</span><br><span class="line">4</span><br><span class="line">1</span><br><span class="line">1</span><br><span class="line">1</span><br><span class="line">1</span><br><span class="line">Time taken: 0.929 seconds, Fetched: 10 row(s)</span><br></pre></td></tr></table></figure>

<p>2、如果要查出每位用户购买商品时的多种信息，输出语句格式为 <code>select 列1，列2，….，列n from</code> 表名；比如我们现在查询前20位用户购买商品时的时间和商品的种类</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">select visit_date,item_category from bigdata_user limit 20;</span><br></pre></td></tr></table></figure>

<p>执行结果如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">OK</span><br><span class="line">2014-12-08      4076</span><br><span class="line">2014-12-12      5503</span><br><span class="line">2014-12-12      5503</span><br><span class="line">2014-12-02      9762</span><br><span class="line">2014-12-12      5232</span><br><span class="line">2014-12-02      9762</span><br><span class="line">2014-12-12      5503</span><br><span class="line">2014-12-12      10894</span><br><span class="line">2014-12-12      6513</span><br><span class="line">2014-12-12      10894</span><br><span class="line">2014-12-12      2825</span><br><span class="line">2014-11-28      2825</span><br><span class="line">2014-12-15      3200</span><br><span class="line">2014-12-03      10576</span><br><span class="line">2014-11-20      10576</span><br><span class="line">2014-12-13      10576</span><br><span class="line">2014-12-08      10576</span><br><span class="line">2014-12-14      7079</span><br><span class="line">2014-12-02      6669</span><br><span class="line">2014-12-12      5232</span><br><span class="line">Time taken: 0.107 seconds, Fetched: 20 row(s)</span><br></pre></td></tr></table></figure>

<p>3、有时我们在表中查询可以利用嵌套语句，如果列名太复杂可以设置该列的别名，以简化我们操作的难度，以下我们可以举个例子：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">select e.bh, e.it from (select behavior_type as bh, item_category as it from bigdata_user) as e limit 20;</span><br></pre></td></tr></table></figure>

<p>执行结果如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">OK</span><br><span class="line">1       4076</span><br><span class="line">1       5503</span><br><span class="line">1       5503</span><br><span class="line">1       9762</span><br><span class="line">1       5232</span><br><span class="line">4       9762</span><br><span class="line">1       5503</span><br><span class="line">1       10894</span><br><span class="line">1       6513</span><br><span class="line">1       10894</span><br><span class="line">1       2825</span><br><span class="line">1       2825</span><br><span class="line">1       3200</span><br><span class="line">1       10576</span><br><span class="line">1       10576</span><br><span class="line">1       10576</span><br><span class="line">1       10576</span><br><span class="line">1       7079</span><br><span class="line">1       6669</span><br><span class="line">1       5232</span><br><span class="line">Time taken: 0.107 seconds, Fetched: 20 row(s)</span><br></pre></td></tr></table></figure>

<p>这里简单的做个讲解，<code>behavior_type as bh</code> , <code>item_category as it</code> 就是把 <code>behavior_type</code> 设置别名 <code>bh</code> ,<code>item_category</code> 设置别名 <code>it</code>，<code>FROM</code> 的括号里的内容我们也设置了别名 <code>e</code>，这样调用时用 <code>e.bh</code>，<code>e.it</code>，可以简化代码。</p>
<h1 id="3-查询条数统计分析"><a href="#3-查询条数统计分析" class="headerlink" title="3. 查询条数统计分析"></a>3. 查询条数统计分析</h1><p>经过简单的查询后我们同样也可以在select后加入更多的条件对表进行查询,下面可以用函数来查找我们想要的内容。</p>
<p>1、用聚合函数 <code>count()</code> 计算出表内有多少条行数据</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 用聚合函数count()计算出表内有多少条行数据 </span><br><span class="line">select count(*) from bigdata_user;</span><br></pre></td></tr></table></figure>

<p>出现：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Ended Job = job_1711268571920_0001 with errors</span><br><span class="line">Error during job, obtaining debugging information...</span><br><span class="line">FAILED: Execution Error, return code 2 from org.apache.hadoop.hive.ql.exec.mr.MapRedTask</span><br><span class="line">MapReduce Jobs Launched: </span><br><span class="line">Stage-Stage-1:  HDFS Read: 0 HDFS Write: 0 FAIL</span><br><span class="line">Total MapReduce CPU Time Spent: 0 msec</span><br></pre></td></tr></table></figure>

<p>原因：namenode 内存空间不够，jvm 剩余空间不够新的 job 运行。</p>
<p>解决方法：将 Hive 设置成本地模式来执行任务。</p>
<p><strong>临时设置</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">set hive.exec.mode.local.auto=true;</span><br></pre></td></tr></table></figure>

<p>这样设置比较麻烦，需要每次执行语句的时候输入这条命令，而且输一次命令只能执行一次语句，再次执行其他语句的时候就会提示进程被杀死。需要从新启动 Hive 。每次都要重新启动一次 Hive 然后在输一次这条语句比较麻烦。</p>
<p><strong>长远设置</strong></p>
<p>在 <code>hive-site.xml</code> 文件添加配置，设置了之后从新启动 Hive 就可以了。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>hive.exec.mode.local.auto<span class="tag">&lt;/<span class="name">name</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span>true<span class="tag">&lt;/<span class="name">value</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span> </span><br></pre></td></tr></table></figure>

<p>设置好后重新查询：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">select count(*) from bigdata_user;</span><br></pre></td></tr></table></figure>

<p>执行结果如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Automatically selecting local only mode for query</span><br><span class="line">Query ID = muyoukule_20240324015155_7ae1692b-c09d-4234-9d4d-3404a61fb05c</span><br><span class="line">Total jobs = 1</span><br><span class="line">Launching Job 1 out of 1</span><br><span class="line">Number of reduce tasks determined at compile time: 1</span><br><span class="line">In order to change the average load for a reducer (in bytes):</span><br><span class="line">  set hive.exec.reducers.bytes.per.reducer=&lt;number&gt;</span><br><span class="line">In order to limit the maximum number of reducers:</span><br><span class="line">  set hive.exec.reducers.max=&lt;number&gt;</span><br><span class="line">In order to set a constant number of reducers:</span><br><span class="line">  set mapreduce.job.reduces=&lt;number&gt;</span><br><span class="line">Job running in-process (local Hadoop)</span><br><span class="line">2024-03-24 01:51:57,388 Stage-1 map = 100%,  reduce = 100%</span><br><span class="line">Ended Job = job_local2145470938_0001</span><br><span class="line">MapReduce Jobs Launched: </span><br><span class="line">Stage-Stage-1:  HDFS Read: 31204930 HDFS Write: 81922062 SUCCESS</span><br><span class="line">Total MapReduce CPU Time Spent: 0 msec</span><br><span class="line">OK</span><br><span class="line">300000</span><br><span class="line">Time taken: 1.461 seconds, Fetched: 1 row(s)</span><br></pre></td></tr></table></figure>

<p>我们可以看到，得出的结果为 OK 下的那个数字 <code>300000</code>(因为我们的 <code>small_user.csv</code> 中包含了 300000 条记录，导入到 Hive 中)。</p>
<p>2、在函数内部加上 <code>distinct</code>，查出 <code>uid</code> 不重复的数据有多少条</p>
<p>下面继续执行操作：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 在函数内部加上 distinct，查出 uid 不重复的数据有多少条</span><br><span class="line">select count(distinct uid) from bigdata_user;</span><br></pre></td></tr></table></figure>

<p>执行结果如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Automatically selecting local only mode for query</span><br><span class="line">Query ID = muyoukule_20240324015507_77989e78-51e4-45c1-9eb1-200c0787c3ec</span><br><span class="line">Total jobs = 1</span><br><span class="line">Launching Job 1 out of 1</span><br><span class="line">Number of reduce tasks determined at compile time: 1</span><br><span class="line">In order to change the average load for a reducer (in bytes):</span><br><span class="line">  set hive.exec.reducers.bytes.per.reducer=&lt;number&gt;</span><br><span class="line">In order to limit the maximum number of reducers:</span><br><span class="line">  set hive.exec.reducers.max=&lt;number&gt;</span><br><span class="line">In order to set a constant number of reducers:</span><br><span class="line">  set mapreduce.job.reduces=&lt;number&gt;</span><br><span class="line">Job running in-process (local Hadoop)</span><br><span class="line">2024-03-24 01:55:09,012 Stage-1 map = 100%,  reduce = 100%</span><br><span class="line">Ended Job = job_local1035121157_0002</span><br><span class="line">MapReduce Jobs Launched: </span><br><span class="line">Stage-Stage-1:  HDFS Read: 62385496 HDFS Write: 81922271 SUCCESS</span><br><span class="line">Total MapReduce CPU Time Spent: 0 msec</span><br><span class="line">OK</span><br><span class="line">270</span><br><span class="line">Time taken: 1.346 seconds, Fetched: 1 row(s)</span><br></pre></td></tr></table></figure>

<p>3、查询不重复的数据有多少条(为了排除客户刷单情况) </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">select count(*) from (select uid,item_id,behavior_type,item_category,visit_date,province from bigdata_user group by uid,item_id,behavior_type,item_category,visit_date,province having count(*)=1)a;</span><br></pre></td></tr></table></figure>

<p>执行结果如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Automatically selecting local only mode for query</span><br><span class="line">Query ID = muyoukule_20240324015553_0c5051e4-2030-4be3-b27a-f981274e056d</span><br><span class="line">Total jobs = 2</span><br><span class="line">Launching Job 1 out of 2</span><br><span class="line">Number of reduce tasks not specified. Estimated from input data size: 1</span><br><span class="line">In order to change the average load for a reducer (in bytes):</span><br><span class="line">  set hive.exec.reducers.bytes.per.reducer=&lt;number&gt;</span><br><span class="line">In order to limit the maximum number of reducers:</span><br><span class="line">  set hive.exec.reducers.max=&lt;number&gt;</span><br><span class="line">In order to set a constant number of reducers:</span><br><span class="line">  set mapreduce.job.reduces=&lt;number&gt;</span><br><span class="line">Job running in-process (local Hadoop)</span><br><span class="line">2024-03-24 01:55:55,036 Stage-1 map = 0%,  reduce = 0%</span><br><span class="line">2024-03-24 01:55:57,044 Stage-1 map = 100%,  reduce = 0%</span><br><span class="line">2024-03-24 01:55:58,049 Stage-1 map = 100%,  reduce = 100%</span><br><span class="line">Ended Job = job_local1915786213_0003</span><br><span class="line">Launching Job 2 out of 2</span><br><span class="line">Number of reduce tasks determined at compile time: 1</span><br><span class="line">In order to change the average load for a reducer (in bytes):</span><br><span class="line">  set hive.exec.reducers.bytes.per.reducer=&lt;number&gt;</span><br><span class="line">In order to limit the maximum number of reducers:</span><br><span class="line">  set hive.exec.reducers.max=&lt;number&gt;</span><br><span class="line">In order to set a constant number of reducers:</span><br><span class="line">  set mapreduce.job.reduces=&lt;number&gt;</span><br><span class="line">Selecting local mode for task: Stage-2</span><br><span class="line">Job running in-process (local Hadoop)</span><br><span class="line">2024-03-24 01:56:00,021 Stage-2 map = 100%,  reduce = 100%</span><br><span class="line">Ended Job = job_local1303362696_0004</span><br><span class="line">MapReduce Jobs Launched: </span><br><span class="line">Stage-Stage-1:  HDFS Read: 93566056 HDFS Write: 81927009 SUCCESS</span><br><span class="line">Stage-Stage-2:  HDFS Read: 93584837 HDFS Write: 81944726 SUCCESS</span><br><span class="line">Total MapReduce CPU Time Spent: 0 msec</span><br><span class="line">OK</span><br><span class="line">284047</span><br><span class="line">Time taken: 6.41 seconds, Fetched: 1 row(s)</span><br></pre></td></tr></table></figure>

<p>可以看出，排除掉重复信息以后，只有 284047 条记录。</p>
<p><strong>PS：嵌套语句最好取别名，就是上面的 a，否则很容易出现如下错误。</strong></p>
<h1 id="4-关键字条件查询分析"><a href="#4-关键字条件查询分析" class="headerlink" title="4. 关键字条件查询分析"></a>4. 关键字条件查询分析</h1><p>1、以关键字的存在区间为条件的查询</p>
<p>使用 <code>where</code> 可以缩小查询分析的范围和精确度，下面用实例来测试一下。</p>
<p>(1) 查询 2014年12月10日 到 2014年12月13日 有多少人浏览了商品</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">select count(*) from bigdata_user where behavior_type=&#x27;1&#x27; and visit_date&lt;&#x27;2014-12-13&#x27; and visit_date&gt;&#x27;2014-12-10&#x27;;</span><br></pre></td></tr></table></figure>

<p>执行结果如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Automatically selecting local only mode for query</span><br><span class="line">Query ID = muyoukule_20240324015825_ec7ac2f7-57a2-48cb-bda7-729a69bf164c</span><br><span class="line">Total jobs = 1</span><br><span class="line">Launching Job 1 out of 1</span><br><span class="line">Number of reduce tasks determined at compile time: 1</span><br><span class="line">In order to change the average load for a reducer (in bytes):</span><br><span class="line">  set hive.exec.reducers.bytes.per.reducer=&lt;number&gt;</span><br><span class="line">In order to limit the maximum number of reducers:</span><br><span class="line">  set hive.exec.reducers.max=&lt;number&gt;</span><br><span class="line">In order to set a constant number of reducers:</span><br><span class="line">  set mapreduce.job.reduces=&lt;number&gt;</span><br><span class="line">Job running in-process (local Hadoop)</span><br><span class="line">2024-03-24 01:58:27,122 Stage-1 map = 100%,  reduce = 100%</span><br><span class="line">Ended Job = job_local803845934_0007</span><br><span class="line">MapReduce Jobs Launched: </span><br><span class="line">Stage-Stage-1:  HDFS Read: 155963028 HDFS Write: 81958359 SUCCESS</span><br><span class="line">Total MapReduce CPU Time Spent: 0 msec</span><br><span class="line">OK</span><br><span class="line">26329</span><br><span class="line">Time taken: 1.395 seconds, Fetched: 1 row(s)</span><br></pre></td></tr></table></figure>

<p>(2) 以月的第n天为统计单位，依次显示第n天网站卖出去的商品的个数</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">select count(distinct uid), day(visit_date) from bigdata_user where behavior_type=&#x27;4&#x27; group by day(visit_date);</span><br></pre></td></tr></table></figure>

<p>执行结果如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Automatically selecting local only mode for query</span><br><span class="line">Query ID = muyoukule_20240324015901_e5a2dc9f-ba6e-4c3b-918e-47ad98ff9bb7</span><br><span class="line">Total jobs = 1</span><br><span class="line">Launching Job 1 out of 1</span><br><span class="line">Number of reduce tasks not specified. Estimated from input data size: 1</span><br><span class="line">In order to change the average load for a reducer (in bytes):</span><br><span class="line">  set hive.exec.reducers.bytes.per.reducer=&lt;number&gt;</span><br><span class="line">In order to limit the maximum number of reducers:</span><br><span class="line">  set hive.exec.reducers.max=&lt;number&gt;</span><br><span class="line">In order to set a constant number of reducers:</span><br><span class="line">  set mapreduce.job.reduces=&lt;number&gt;</span><br><span class="line">Job running in-process (local Hadoop)</span><br><span class="line">2024-03-24 01:59:02,325 Stage-1 map = 100%,  reduce = 100%</span><br><span class="line">Ended Job = job_local1221129954_0008</span><br><span class="line">MapReduce Jobs Launched: </span><br><span class="line">Stage-Stage-1:  HDFS Read: 187143592 HDFS Write: 81959082 SUCCESS</span><br><span class="line">Total MapReduce CPU Time Spent: 0 msec</span><br><span class="line">OK</span><br><span class="line">37      1</span><br><span class="line">48      2</span><br><span class="line">42      3</span><br><span class="line">38      4</span><br><span class="line">42      5</span><br><span class="line">33      6</span><br><span class="line">42      7</span><br><span class="line">36      8</span><br><span class="line">34      9</span><br><span class="line">40      10</span><br><span class="line">43      11</span><br><span class="line">98      12</span><br><span class="line">39      13</span><br><span class="line">43      14</span><br><span class="line">42      15</span><br><span class="line">44      16</span><br><span class="line">42      17</span><br><span class="line">66      18</span><br><span class="line">38      19</span><br><span class="line">50      20</span><br><span class="line">33      21</span><br><span class="line">34      22</span><br><span class="line">32      23</span><br><span class="line">47      24</span><br><span class="line">34      25</span><br><span class="line">31      26</span><br><span class="line">30      27</span><br><span class="line">34      28</span><br><span class="line">39      29</span><br><span class="line">38      30</span><br><span class="line">Time taken: 1.31 seconds, Fetched: 30 row(s)</span><br></pre></td></tr></table></figure>

<p>2、关键字赋予给定值为条件，对其他数据进行分析</p>
<p>取给定时间和给定地点，求当天发出到该地点的货物的数量</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">select count(*) from bigdata_user where province=&#x27;江西&#x27; and visit_date=&#x27;2014-12-12&#x27; and behavior_type=&#x27;4&#x27;;</span><br></pre></td></tr></table></figure>

<p>执行结果如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Automatically selecting local only mode for query</span><br><span class="line">Query ID = muyoukule_20240324015952_f881672f-70ca-4303-b128-dd3f8c552945</span><br><span class="line">Total jobs = 1</span><br><span class="line">Launching Job 1 out of 1</span><br><span class="line">Number of reduce tasks determined at compile time: 1</span><br><span class="line">In order to change the average load for a reducer (in bytes):</span><br><span class="line">  set hive.exec.reducers.bytes.per.reducer=&lt;number&gt;</span><br><span class="line">In order to limit the maximum number of reducers:</span><br><span class="line">  set hive.exec.reducers.max=&lt;number&gt;</span><br><span class="line">In order to set a constant number of reducers:</span><br><span class="line">  set mapreduce.job.reduces=&lt;number&gt;</span><br><span class="line">Job running in-process (local Hadoop)</span><br><span class="line">2024-03-24 01:59:53,388 Stage-1 map = 100%,  reduce = 100%</span><br><span class="line">Ended Job = job_local479466284_0009</span><br><span class="line">MapReduce Jobs Launched: </span><br><span class="line">Stage-Stage-1:  HDFS Read: 218325182 HDFS Write: 81959801 SUCCESS</span><br><span class="line">Total MapReduce CPU Time Spent: 0 msec</span><br><span class="line">OK</span><br><span class="line">8</span><br><span class="line">Time taken: 1.264 seconds, Fetched: 1 row(s)</span><br></pre></td></tr></table></figure>

<h1 id="5-根据用户行为分析"><a href="#5-根据用户行为分析" class="headerlink" title="5. 根据用户行为分析"></a>5. 根据用户行为分析</h1><p>从现在开始，我们只给出查询语句，将不再给出执行结果。</p>
<p>1、查询一件商品在某天的购买比例或浏览比例</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 查询有多少用户在 2014-12-11 购买了商品</span><br><span class="line">select count(*) from bigdata_user where visit_date=&#x27;2014-12-11&#x27;and behavior_type=&#x27;4&#x27;;</span><br></pre></td></tr></table></figure>

<p>执行结果如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Automatically selecting local only mode for query</span><br><span class="line">Query ID = muyoukule_20240324020118_47a9bc8d-2397-42c8-a4ec-8d4ffc46674c</span><br><span class="line">Total jobs = 1</span><br><span class="line">Launching Job 1 out of 1</span><br><span class="line">Number of reduce tasks determined at compile time: 1</span><br><span class="line">In order to change the average load for a reducer (in bytes):</span><br><span class="line">  set hive.exec.reducers.bytes.per.reducer=&lt;number&gt;</span><br><span class="line">In order to limit the maximum number of reducers:</span><br><span class="line">  set hive.exec.reducers.max=&lt;number&gt;</span><br><span class="line">In order to set a constant number of reducers:</span><br><span class="line">  set mapreduce.job.reduces=&lt;number&gt;</span><br><span class="line">Job running in-process (local Hadoop)</span><br><span class="line">2024-03-24 02:01:20,097 Stage-1 map = 100%,  reduce = 0%</span><br><span class="line">2024-03-24 02:01:21,099 Stage-1 map = 100%,  reduce = 100%</span><br><span class="line">Ended Job = job_local1882990576_0010</span><br><span class="line">MapReduce Jobs Launched: </span><br><span class="line">Stage-Stage-1:  HDFS Read: 249505738 HDFS Write: 81960004 SUCCESS</span><br><span class="line">Total MapReduce CPU Time Spent: 0 msec</span><br><span class="line">OK</span><br><span class="line">69</span><br><span class="line">Time taken: 2.335 seconds, Fetched: 1 row(s)</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 查询有多少用户在 2014-12-11 点击了该店</span><br><span class="line">select count(*) from bigdata_user where visit_date =&#x27;2014-12-11&#x27;;</span><br></pre></td></tr></table></figure>

<p>执行结果如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Automatically selecting local only mode for query</span><br><span class="line">Query ID = muyoukule_20240324020155_4f1a4baf-b338-4ab9-8d05-a0064474caa7</span><br><span class="line">Total jobs = 1</span><br><span class="line">Launching Job 1 out of 1</span><br><span class="line">Number of reduce tasks determined at compile time: 1</span><br><span class="line">In order to change the average load for a reducer (in bytes):</span><br><span class="line">  set hive.exec.reducers.bytes.per.reducer=&lt;number&gt;</span><br><span class="line">In order to limit the maximum number of reducers:</span><br><span class="line">  set hive.exec.reducers.max=&lt;number&gt;</span><br><span class="line">In order to set a constant number of reducers:</span><br><span class="line">  set mapreduce.job.reduces=&lt;number&gt;</span><br><span class="line">Job running in-process (local Hadoop)</span><br><span class="line">2024-03-24 02:01:56,329 Stage-1 map = 100%,  reduce = 100%</span><br><span class="line">Ended Job = job_local1753478999_0011</span><br><span class="line">MapReduce Jobs Launched: </span><br><span class="line">Stage-Stage-1:  HDFS Read: 280686296 HDFS Write: 81960211 SUCCESS</span><br><span class="line">Total MapReduce CPU Time Spent: 0 msec</span><br><span class="line">OK</span><br><span class="line">10649</span><br><span class="line">Time taken: 1.313 seconds, Fetched: 1 row(s)</span><br></pre></td></tr></table></figure>

<p>根据上面语句得到购买数量和点击数量，两个数相除即可得出当天该商品的购买率。</p>
<p>2、查询某个用户在某一天点击网站占该天所有点击行为的比例(点击行为包括浏览，加入购物车，收藏，购买)</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 查询用户 10001082 在 2014-12-12 点击网站的次数</span><br><span class="line">select count(*) from bigdata_user where uid=10001082 and visit_date=&#x27;2014-12-12&#x27;;</span><br></pre></td></tr></table></figure>

<p>执行结果如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Automatically selecting local only mode for query</span><br><span class="line">Query ID = muyoukule_20240324020405_c0631a79-6d8d-4029-812c-6592d727a478</span><br><span class="line">Total jobs = 1</span><br><span class="line">Launching Job 1 out of 1</span><br><span class="line">Number of reduce tasks determined at compile time: 1</span><br><span class="line">In order to change the average load for a reducer (in bytes):</span><br><span class="line">  set hive.exec.reducers.bytes.per.reducer=&lt;number&gt;</span><br><span class="line">In order to limit the maximum number of reducers:</span><br><span class="line">  set hive.exec.reducers.max=&lt;number&gt;</span><br><span class="line">In order to set a constant number of reducers:</span><br><span class="line">  set mapreduce.job.reduces=&lt;number&gt;</span><br><span class="line">Job running in-process (local Hadoop)</span><br><span class="line">2024-03-24 02:04:06,828 Stage-1 map = 100%,  reduce = 100%</span><br><span class="line">Ended Job = job_local877196646_0012</span><br><span class="line">MapReduce Jobs Launched: </span><br><span class="line">Stage-Stage-1:  HDFS Read: 311866860 HDFS Write: 81960418 SUCCESS</span><br><span class="line">Total MapReduce CPU Time Spent: 0 msec</span><br><span class="line">OK</span><br><span class="line">69</span><br><span class="line">Time taken: 1.307 seconds, Fetched: 1 row(s)</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 查询所有用户在这一天点击该网站的次数</span><br><span class="line">select count(*) from bigdata_user where visit_date=&#x27;2014-12-12&#x27;;</span><br></pre></td></tr></table></figure>

<p>执行结果如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Automatically selecting local only mode for query</span><br><span class="line">Query ID = muyoukule_20240324020425_b2082f31-ead2-4901-bd90-e24610fc4891</span><br><span class="line">Total jobs = 1</span><br><span class="line">Launching Job 1 out of 1</span><br><span class="line">Number of reduce tasks determined at compile time: 1</span><br><span class="line">In order to change the average load for a reducer (in bytes):</span><br><span class="line">  set hive.exec.reducers.bytes.per.reducer=&lt;number&gt;</span><br><span class="line">In order to limit the maximum number of reducers:</span><br><span class="line">  set hive.exec.reducers.max=&lt;number&gt;</span><br><span class="line">In order to set a constant number of reducers:</span><br><span class="line">  set mapreduce.job.reduces=&lt;number&gt;</span><br><span class="line">Job running in-process (local Hadoop)</span><br><span class="line">2024-03-24 02:04:26,393 Stage-1 map = 100%,  reduce = 100%</span><br><span class="line">Ended Job = job_local783450845_0013</span><br><span class="line">MapReduce Jobs Launched: </span><br><span class="line">Stage-Stage-1:  HDFS Read: 343047418 HDFS Write: 81960625 SUCCESS</span><br><span class="line">Total MapReduce CPU Time Spent: 0 msec</span><br><span class="line">OK</span><br><span class="line">17494</span><br><span class="line">Time taken: 1.332 seconds, Fetched: 1 row(s)</span><br></pre></td></tr></table></figure>

<p>上面两条语句的结果相除，就得到了要要求的比例。</p>
<p>3、给定购买商品的数量范围，查询某一天在该网站的购买该数量商品的用户id</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 查询某一天在该网站购买商品超过 5 次的用户 id</span><br><span class="line">select uid from bigdata_user where behavior_type=&#x27;4&#x27; and visit_date=&#x27;2014-12-12&#x27; group by uid having count(behavior_type=&#x27;4&#x27;)&gt;5;</span><br></pre></td></tr></table></figure>

<p>执行结果如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Automatically selecting local only mode for query</span><br><span class="line">Query ID = muyoukule_20240324020454_4841d58d-313e-4319-87b3-01d8836606ca</span><br><span class="line">Total jobs = 1</span><br><span class="line">Launching Job 1 out of 1</span><br><span class="line">Number of reduce tasks not specified. Estimated from input data size: 1</span><br><span class="line">In order to change the average load for a reducer (in bytes):</span><br><span class="line">  set hive.exec.reducers.bytes.per.reducer=&lt;number&gt;</span><br><span class="line">In order to limit the maximum number of reducers:</span><br><span class="line">  set hive.exec.reducers.max=&lt;number&gt;</span><br><span class="line">In order to set a constant number of reducers:</span><br><span class="line">  set mapreduce.job.reduces=&lt;number&gt;</span><br><span class="line">Job running in-process (local Hadoop)</span><br><span class="line">2024-03-24 02:04:55,645 Stage-1 map = 100%,  reduce = 100%</span><br><span class="line">Ended Job = job_local1954605595_0014</span><br><span class="line">MapReduce Jobs Launched: </span><br><span class="line">Stage-Stage-1:  HDFS Read: 374227982 HDFS Write: 81961208 SUCCESS</span><br><span class="line">Total MapReduce CPU Time Spent: 0 msec</span><br><span class="line">OK</span><br><span class="line">100226515</span><br><span class="line">100300684</span><br><span class="line">100555417</span><br><span class="line">100605</span><br><span class="line">10095384</span><br><span class="line">10142625</span><br><span class="line">101490976</span><br><span class="line">101982646</span><br><span class="line">102011320</span><br><span class="line">102030700</span><br><span class="line">102079825</span><br><span class="line">102349447</span><br><span class="line">102612580</span><br><span class="line">102650143</span><br><span class="line">103082347</span><br><span class="line">103139791</span><br><span class="line">103794013</span><br><span class="line">103995979</span><br><span class="line">Time taken: 1.298 seconds, Fetched: 18 row(s)</span><br></pre></td></tr></table></figure>

<h1 id="6-用户实时查询分析"><a href="#6-用户实时查询分析" class="headerlink" title="6. 用户实时查询分析"></a>6. 用户实时查询分析</h1><p>某个地区的用户当天浏览网站的次数</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 创建新的数据表进行存储</span><br><span class="line">create table scan(province STRING,scan INT) COMMENT &#x27;This is the search of bigdataday&#x27; ROW FORMAT DELIMITED FIELDS TERMINATED BY &#x27;\t&#x27; STORED AS TEXTFILE;</span><br><span class="line"></span><br><span class="line"># 导入数据</span><br><span class="line">insert overwrite table scan select province,count(behavior_type) from bigdata_user where behavior_type=&#x27;1&#x27; group by province;</span><br><span class="line"></span><br><span class="line"># 显示结果</span><br><span class="line">select * from scan;</span><br></pre></td></tr></table></figure>

<p>执行结果如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">OK</span><br><span class="line">上海市  8372</span><br><span class="line">云南    8220</span><br><span class="line">内蒙古  8195</span><br><span class="line">北京市  8348</span><br><span class="line">台湾    8327</span><br><span class="line">吉林    8242</span><br><span class="line">四川    8234</span><br><span class="line">天津市  8454</span><br><span class="line">宁夏    8429</span><br><span class="line">安徽    8340</span><br><span class="line">山东    8449</span><br><span class="line">山西    8347</span><br><span class="line">广东    8305</span><br><span class="line">广西    8378</span><br><span class="line">新疆    8446</span><br><span class="line">江苏    8400</span><br><span class="line">江西    8395</span><br><span class="line">河北    8437</span><br><span class="line">河南    8277</span><br><span class="line">浙江    8319</span><br><span class="line">海南    8389</span><br><span class="line">湖北    8399</span><br><span class="line">湖南    8173</span><br><span class="line">澳门    8360</span><br><span class="line">甘肃    8283</span><br><span class="line">福建    8459</span><br><span class="line">西藏    8424</span><br><span class="line">贵州    8282</span><br><span class="line">辽宁    8333</span><br><span class="line">重庆市  8256</span><br><span class="line">陕西    8379</span><br><span class="line">青海    8266</span><br><span class="line">香港    8242</span><br><span class="line">黑龙江  8357</span><br><span class="line">Time taken: 0.07 seconds, Fetched: 34 row(s)</span><br></pre></td></tr></table></figure>

<p>到这里，Hive 数据分析实验顺利结束。</p>
]]></content>
      <categories>
        <category>BigData</category>
      </categories>
      <tags>
        <tag>Hadoop</tag>
        <tag>Hive</tag>
      </tags>
  </entry>
  <entry>
    <title>【步骤一】本地数据集上传到数据仓库Hive</title>
    <url>/posts/19926/</url>
    <content><![CDATA[<h1 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h1><p>简介：本文章基于厦门大学提供的<a href="https://dblab.xmu.edu.cn/post/7499/">大数据课程实验案例：网站用户行为分析</a>，通过使用 CentOS 操作编写而来。具体介绍请打开链接进行阅读。</p>
<p><font color="red">这里介绍几点值得特别注意的事项：</font></p>
<p>1、对于案例所涉及的系统及软件此文档使用的是以下版本，其他软件版本随意：</p>
<ul>
<li>Linux系统（CentOS7）</li>
<li>MySQL（5.7）</li>
<li>Hadoop（3.1.3）</li>
<li>HBase（2.2.2，HBase版本需要和Hadoop版本兼容）</li>
<li>Hive（3.1.2，Hive需要和Hadoop版本兼容）</li>
<li>Sqoop（1.4.7）</li>
<li>R（3.6.0）</li>
<li>IDEA（ 2023.3.6 社区版）</li>
</ul>
<p><font color="red"><strong>PS：Hadoop 与 HBase、Hive 版本一定要兼容！！！版本一定要兼容！！！这很重要！！！</strong></font>😃😃😃其他软件随意。</p>
<p>2、本文章所有<strong>下载</strong>的所有软件均在 <code>/</code> 目录下。所有<strong>安装</strong>的所有软件均在 <code>/usr/local/</code> 目录下以 <code>软件名-版本号</code> 方式命名。在进行每个软件的安装操作之前请先<strong>整体阅读</strong>整个软件安装流程的文章有个整体思路，<strong>了解到安装此软件需要做哪些设置再进行操作</strong>，这样可以避免很多不必要的麻烦。</p>
<p>3、<font color="red"><strong>此案例分为五个步骤，请按照步骤顺序进行阅读！！</strong>🙂🙂</font></p>
<h1 id="1-实验数据集的下载"><a href="#1-实验数据集的下载" class="headerlink" title="1. 实验数据集的下载"></a>1. 实验数据集的下载</h1><p>本案例采用的数据集为 <code>user.zip</code>，包含了一个大规模数据集 <code>raw_user.csv</code> (包含2000万条记录)，和一个小数据集 <code>small_user.csv</code>(只包含30万条记录)。小数据集 <code>small_user.csv</code> 是从大规模数据集 <code>raw_user.csv</code> 中抽取的一小部分数据。之所以抽取出一少部分记录单独构成一个小数据集，是因为，在第一遍跑通整个实验流程时，会遇到各种错误，各种问题，先用小数据集测试，可以大量节约程序运行时间。等到第一次完整实验流程都顺利跑通以后，就可以最后用大规模数据集进行最后的测试。</p>
<p>下面，请在本机先下载 <a href="http://pan.baidu.com/s/1nuOSo7B">user.zip数据集</a> ，然后上传到自己的 Linux 系统。或者直接在虚拟机的浏览器打开下载。</p>
<p>我这里将它上传到 Linux 的 <code>/</code> 目录：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 进入 / 目录</span></span><br><span class="line"><span class="built_in">cd</span> /</span><br><span class="line"></span><br><span class="line"><span class="comment"># 上传</span></span><br><span class="line">sudo rz</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看</span></span><br><span class="line">ll</span><br></pre></td></tr></table></figure>

<p>通过上面命令，就进入到了 user.zip 文件所在的目录，并且可以看到有个 user.zip 文件。注意，如果你把 user.zip 下载到了其他目录，这里请进入到你自己的存放 user.zip 的目录。</p>
<p>下面需要把 user.zip 进行解压缩，我们需要首先建立一个用于运行本案例的目录 bigdatacase，请执行以下命令：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cd /usr/local</span><br><span class="line"></span><br><span class="line">sudo mkdir bigdatacase</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">下面给 muyoukule 用户赋予针对 bigdatacase 目录的各种操作权限</span></span><br><span class="line">sudo chown -R muyoukule:muyoukule ./bigdatacase</span><br><span class="line"></span><br><span class="line">cd bigdatacase</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">下面创建一个dataset目录，用于保存数据集</span></span><br><span class="line">mkdir dataset</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">下面就可以解压缩user.zip文件</span></span><br><span class="line">sudo unzip /user.zip -d /usr/local/bigdatacase/dataset</span><br><span class="line"></span><br><span class="line">cd /usr/local/bigdatacase/dataset</span><br><span class="line"></span><br><span class="line">ls</span><br></pre></td></tr></table></figure>

<p>现在你就可以看到在dataset目录下有两个文件：<code>raw_user.csv</code> 和 <code>small_user.csv</code></p>
<p>我们执行下面命令取出前面 5 条记录看一下：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">head -5 raw_user.csv</span><br></pre></td></tr></table></figure>

<p>可以看到，前 5 行记录如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">user_id,item_id,behavior_type,user_geohash,item_category,time</span><br><span class="line">10001082,285259775,1,97lk14c,4076,2014-12-08 18</span><br><span class="line">10001082,4368907,1,,5503,2014-12-12 12</span><br><span class="line">10001082,4368907,1,,5503,2014-12-12 12</span><br><span class="line">10001082,53616768,1,,9762,2014-12-02 15</span><br></pre></td></tr></table></figure>

<p>可以看出，每行记录都包含 5 个字段，数据集中的字段及其含义如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">user_id(用户id)</span><br><span class="line">item_id(商品id)</span><br><span class="line">behaviour_type(包括浏览、收藏、加购物车、购买，对应取值分别是1、2、3、4)</span><br><span class="line">user_geohash(用户地理位置哈希值，有些记录中没有这个字段值，所以后面我们会用脚本做数据预处理时把这个字段全部删除)</span><br><span class="line">item_category(商品分类)</span><br><span class="line">time(该记录产生时间)</span><br></pre></td></tr></table></figure>

<h1 id="2-数据集的预处理"><a href="#2-数据集的预处理" class="headerlink" title="2. 数据集的预处理"></a>2. 数据集的预处理</h1><h2 id="2-1-删除文件第一行记录，即字段名称"><a href="#2-1-删除文件第一行记录，即字段名称" class="headerlink" title="2.1 删除文件第一行记录，即字段名称"></a>2.1 删除文件第一行记录，即字段名称</h2><p><code>raw_user</code> 和 <code>small_user</code> 中的第一行都是字段名称，我们在文件中的数据导入到数据仓库 Hive 中时，不需要第一行字段名称。因此，这里在做数据预处理时，删除第一行</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cd /usr/local/bigdatacase/dataset</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">下面删除raw_user中的第1行</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">1d表示删除第1行，同理，3d表示删除第3行，nd表示删除第n行</span></span><br><span class="line">sed -i &#x27;1d&#x27; raw_user.csv </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">下面删除small_user中的第1行</span></span><br><span class="line">sed -i &#x27;1d&#x27; small_user.csv </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">下面再用<span class="built_in">head</span>命令去查看文件的前5行记录，就看不到字段名称这一行了</span></span><br><span class="line">head -5 raw_user.csv</span><br><span class="line">head -5 small_user.csv</span><br></pre></td></tr></table></figure>

<p>接下来的操作中，我们都是用 <code>small_user.csv</code> 这个小数据集进行操作，这样可以节省时间。等所有流程都跑通以后，你就可以使用大数据集 <code>raw_user.csv</code> 去测试一遍了。</p>
<h2 id="2-2-对字段进行预处理"><a href="#2-2-对字段进行预处理" class="headerlink" title="2.2 对字段进行预处理"></a>2.2 对字段进行预处理</h2><p>下面对数据集进行一些预处理，包括为每行记录增加一个 <code>id</code> 字段(让记录具有唯一性)、增加一个省份字段(用来后续进行可视化分析)，并且丢弃 <code>user_geohash</code> 字段(后面分析不需要这个字段)。</p>
<p>下面我们要建一个脚本文件 <code>pre_deal.sh</code>，请把这个脚本文件放在 <code>dataset</code> 目录下，和数据集 <code>small_user.csv</code> 放在同一个目录下：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cd /usr/local/bigdatacase/dataset</span><br><span class="line">vim pre_deal.sh</span><br></pre></td></tr></table></figure>

<p>上面使用 vim 编辑器新建了一个 <code>pre_deal.sh</code> 脚本文件，请在这个脚本文件中加入下面代码：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">下面设置输入文件，把用户执行pre_deal.sh命令时提供的第一个参数作为输入文件名称</span></span><br><span class="line">infile=$1</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">下面设置输出文件，把用户执行pre_deal.sh命令时提供的第二个参数作为输出文件名称</span></span><br><span class="line">outfile=$2</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">注意！！最后的<span class="variable">$infile</span> &gt; <span class="variable">$outfile</span>必须跟在&#125;’这两个字符的后面</span></span><br><span class="line">awk -F &quot;,&quot; &#x27;BEGIN&#123;</span><br><span class="line">        srand();</span><br><span class="line">        id=0;</span><br><span class="line">        Province[0]=&quot;山东&quot;;Province[1]=&quot;山西&quot;;Province[2]=&quot;河南&quot;;Province[3]=&quot;河北&quot;;Province[4]=&quot;陕西&quot;;Province[5]=&quot;内蒙古&quot;;Province[6]=&quot;上海市&quot;;</span><br><span class="line">        Province[7]=&quot;北京市&quot;;Province[8]=&quot;重庆市&quot;;Province[9]=&quot;天津市&quot;;Province[10]=&quot;福建&quot;;Province[11]=&quot;广东&quot;;Province[12]=&quot;广西&quot;;Province[13]=&quot;云南&quot;; </span><br><span class="line">        Province[14]=&quot;浙江&quot;;Province[15]=&quot;贵州&quot;;Province[16]=&quot;新疆&quot;;Province[17]=&quot;西藏&quot;;Province[18]=&quot;江西&quot;;Province[19]=&quot;湖南&quot;;Province[20]=&quot;湖北&quot;;</span><br><span class="line">        Province[21]=&quot;黑龙江&quot;;Province[22]=&quot;吉林&quot;;Province[23]=&quot;辽宁&quot;; Province[24]=&quot;江苏&quot;;Province[25]=&quot;甘肃&quot;;Province[26]=&quot;青海&quot;;Province[27]=&quot;四川&quot;;</span><br><span class="line">        Province[28]=&quot;安徽&quot;; Province[29]=&quot;宁夏&quot;;Province[30]=&quot;海南&quot;;Province[31]=&quot;香港&quot;;Province[32]=&quot;澳门&quot;;Province[33]=&quot;台湾&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    &#123;</span><br><span class="line">        id=id+1;</span><br><span class="line">        value=int(rand()*34);       </span><br><span class="line">        print id&quot;\t&quot;$1&quot;\t&quot;$2&quot;\t&quot;$3&quot;\t&quot;$5&quot;\t&quot;substr($6,1,10)&quot;\t&quot;Province[value]</span><br><span class="line">    &#125;&#x27; $infile &gt; $outfile</span><br></pre></td></tr></table></figure>

<p>上面的代码的基本形式是：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">awk -F &quot;,&quot; &#x27;处理逻辑&#x27; $infile &gt; $outfile</span><br></pre></td></tr></table></figure>

<p>使用 <code>awk</code> 可以逐行读取输入文件，并对逐行进行相应操作。其中，<code>-F</code> 参数用于指出每行记录的不同字段之间用什么字符进行分割，这里是用逗号进行分割。处理逻辑代码需要用两个英文单引号引起来。  <code>$infile</code> 是输入文件的名称，我们这里会输入 <code>raw_user.csv</code>，<code>$outfile</code>  表示处理结束后输出的文件名称，我们后面会使用 <code>user_table.txt</code> 作为输出文件名称。</p>
<p>在上面的 <code>pre_deal.sh</code> 代码的处理逻辑部分，<code>srand()</code> 用于生成随机数的种子，<code>id</code> 是我们为数据集新增的一个字段，它是一个自增类型，每条记录增加 1，这样可以保证每条记录具有唯一性。我们会为数据集新增一个省份字段，用来进行后面的数据可视化分析，为了给每条记录增加一个省份字段的值，这里，我们首先用 <code>Province[]</code> 数组用来保存全国各个省份信息，然后，在遍历数据集 <code>raw_user.csv</code> 的时候，每当遍历到其中一条记录，使用 <code>value=int(rand()*34</code>) 语句随机生成一个 0-33 的整数，作为 Province 省份值，然后从 <code>Province[]</code> 数组当中获取省份名称，增加到该条记录中。</p>
<p><code>substr ($6,1,10)</code> 这个语句是为了截取时间字段 <code>time</code> 的年月日，方便后续存储为 <code>date</code> 格式。<code>awk</code> 每次遍历到一条记录时，每条记录包含了6个字段，其中，第6个字段是时间字段，<code>substr($6,1,10)</code> 语句就表示获取第 6 个字段的值，截取前 10 个字符，第 6 个字段是类似 <code>2014-12-08 18</code> 这样的字符串(也就是表示 2014年12月8日18时)，<code>substr($6,1,10)</code>截取后，就丢弃了小时，只保留了年月日。</p>
<p>另外，在 <code>print id&quot;\t&quot;$1&quot;\t&quot;$2&quot;\t&quot;$3&quot;\t&quot;$5&quot;\t&quot;substr($6,1,10)&quot;\t&quot;Province[value]</code> 这行语句中，我们丢弃了每行记录的第4个字段，所以，没有出现 <code>$4</code>。我们生成后的文件是 <code>\t</code> 进行分割，这样，后续我们去查看数据的时候，效果让人看上去更舒服，每个字段在排版的时候会对齐显示，如果用逗号分隔，显示效果就比较乱。</p>
<p>最后，保存 <code>pre_deal.sh</code> 代码文件，退出 vim 编辑器。</p>
<p>下面就可以执行 <code>pre_deal.sh</code> 脚本文件，来对 <code>small_user.csv</code> 进行数据预处理，命令如下：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cd /usr/local/bigdatacase/dataset</span><br><span class="line">bash ./pre_deal.sh small_user.csv user_table.txt  </span><br></pre></td></tr></table></figure>

<p>可以使用 head 命令查看生成的 <code>user_table.txt</code>，不要直接打开，文件过大，会出错，下面查看前 10 行数据：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">head -10 user_table.txt</span><br></pre></td></tr></table></figure>

<p>可以得到如下结果：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1       10001082        285259775       1       4076    2014-12-08      吉林</span><br><span class="line">2       10001082        4368907 1       5503    2014-12-12      贵州</span><br><span class="line">3       10001082        4368907 1       5503    2014-12-12      西藏</span><br><span class="line">4       10001082        53616768        1       9762    2014-12-02      江苏</span><br><span class="line">5       10001082        151466952       1       5232    2014-12-12      青海</span><br><span class="line">6       10001082        53616768        4       9762    2014-12-02      广西</span><br><span class="line">7       10001082        290088061       1       5503    2014-12-12      台湾</span><br><span class="line">8       10001082        298397524       1       10894   2014-12-12      辽宁</span><br><span class="line">9       10001082        32104252        1       6513    2014-12-12      内蒙古</span><br><span class="line">10      10001082        323339743       1       10894   2014-12-12      四川</span><br></pre></td></tr></table></figure>

<h2 id="2-3-导入数据库"><a href="#2-3-导入数据库" class="headerlink" title="2.3 导入数据库"></a>2.3 导入数据库</h2><p>下面要把 <code>user_table.txt</code> 中的数据最终导入到数据仓库 Hive 中。为了完成这个操作，我们会首先把 <code>user_table.txt</code> 上传到分布式文件系统 HDFS 中，然后，在 Hive 中创建一个外部表，完成数据的导入。</p>
<p>1、启动HDFS</p>
<p>请执行下面命令启动 Hadoop(如果你已经启动了 Hadoop 就不用再次启动了)：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动 Hadoop</span></span><br><span class="line">start-all.sh</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看当前运行的进程</span></span><br><span class="line">jps</span><br></pre></td></tr></table></figure>

<p>如果出现下面这些进程，说明 Hadoop 启动成功了。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">NameNode</span><br><span class="line">DataNode</span><br><span class="line">NodeManager</span><br><span class="line">SecondaryNameNode</span><br><span class="line">ResourceManager</span><br><span class="line">Jps</span><br></pre></td></tr></table></figure>

<p>2、把 user_table.txt 上传到 HDFS 中</p>
<p>现在，我们要把 Linux 本地文件系统中的 <code>user_table.txt</code> 上传到分布式文件系统 HDFS 中，存放在 HDFS 中的 <code>/bigdatacase/dataset</code> 目录下。</p>
<p>首先，请执行下面命令，在 HDFS 的根目录下面创建一个新的目录 bigdatacase，并在这个目录下创建一个子目录 dataset，如下：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cd /usr/local/hadoop-3.1.3</span><br><span class="line"></span><br><span class="line">hdfs dfs -mkdir -p /bigdatacase/dataset</span><br></pre></td></tr></table></figure>

<p>然后，把 Linux 本地文件系统中的 <code>user_table.txt</code> 上传到分布式文件系统 HDFS 的 <code>/bigdatacase/dataset</code> 目录下，命令如下：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">hdfs dfs -put /usr/local/bigdatacase/dataset/user_table.txt /bigdatacase/dataset</span><br></pre></td></tr></table></figure>

<p>下面可以查看一下 HDFS 中的 <code>user_table.txt</code> 的前 10 条记录，命令如下：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">hdfs dfs -cat /bigdatacase/dataset/user_table.txt | head -10</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1       10001082        285259775       1       4076    2014-12-08      吉林</span><br><span class="line">2       10001082        4368907 1       5503    2014-12-12      贵州</span><br><span class="line">3       10001082        4368907 1       5503    2014-12-12      西藏</span><br><span class="line">4       10001082        53616768        1       9762    2014-12-02      江苏</span><br><span class="line">5       10001082        151466952       1       5232    2014-12-12      青海</span><br><span class="line">6       10001082        53616768        4       9762    2014-12-02      广西</span><br><span class="line">7       10001082        290088061       1       5503    2014-12-12      台湾</span><br><span class="line">8       10001082        298397524       1       10894   2014-12-12      辽宁</span><br><span class="line">9       10001082        32104252        1       6513    2014-12-12      内蒙古</span><br><span class="line">10      10001082        323339743       1       10894   2014-12-12      四川</span><br></pre></td></tr></table></figure>

<p>3、在 Hive 上创建数据库</p>
<p>启动 MySQL 数据库：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看 MySQL 状态</span></span><br><span class="line">systemctl status mysqld</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动 MySQL</span></span><br><span class="line">sudo systemctl start mysqld</span><br></pre></td></tr></table></figure>

<p>由于 Hive 是基于 Hadoop 的数据仓库，使用 HiveQL 语言撰写的查询语句，最终都会被 Hive 自动解析成 MapReduce 任务由 Hadoop去具体执行，因此，需要启动 Hadoop，然后再启动 Hive。由于前面我们已经启动了 Hadoop，所以，这里不需要再次启动 Hadoop。下面，在这个新的终端中执行下面命令进入 Hive：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动Hive</span></span><br><span class="line">hive</span><br></pre></td></tr></table></figure>

<p>启动成功以后，就进入了 <code>hive&gt;</code> 命令提示符状态，可以输入类似 SQL 语句的 HiveQL 语句。</p>
<p>下面，我们要在 Hive 中创建一个数据库 dblab，命令如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">create database dblab;</span><br><span class="line"></span><br><span class="line">use dblab;</span><br></pre></td></tr></table></figure>

<p>4、创建外部表</p>
<p>在数据库 dblab 中创建一个外部表 <code>bigdata_user</code>，它包含字段 <code>id, uid, item_id, behavior_type, item_category, date, province</code> ，请在 hive 命令提示符下输入如下命令：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">CREATE EXTERNAL TABLE dblab.bigdata_user(id INT,uid STRING,item_id STRING,behavior_type INT,item_category STRING,visit_date DATE,province STRING) COMMENT &#x27;Welcome to xmu dblab!&#x27; ROW FORMAT DELIMITED FIELDS TERMINATED BY &#x27;\t&#x27; STORED AS TEXTFILE LOCATION &#x27;/bigdatacase/dataset&#x27;;</span><br></pre></td></tr></table></figure>

<p>5、查询数据</p>
<p>上面已经成功把 HDFS 中的 <code>/bigdatacase/dataset</code> 目录下的数据加载到了数据仓库 Hive 中，我们现在可以使用下面命令查询一下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">select * from bigdata_user limit 10;</span><br></pre></td></tr></table></figure>

<p>结果：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">OK</span><br><span class="line">1       10001082        285259775       1       4076    2014-12-08      吉林</span><br><span class="line">2       10001082        4368907 1       5503    2014-12-12      贵州</span><br><span class="line">3       10001082        4368907 1       5503    2014-12-12      西藏</span><br><span class="line">4       10001082        53616768        1       9762    2014-12-02      江苏</span><br><span class="line">5       10001082        151466952       1       5232    2014-12-12      青海</span><br><span class="line">6       10001082        53616768        4       9762    2014-12-02      广西</span><br><span class="line">7       10001082        290088061       1       5503    2014-12-12      台湾</span><br><span class="line">8       10001082        298397524       1       10894   2014-12-12      辽宁</span><br><span class="line">9       10001082        32104252        1       6513    2014-12-12      内蒙古</span><br><span class="line">10      10001082        323339743       1       10894   2014-12-12      四川</span><br><span class="line">Time taken: 0.959 seconds, Fetched: 10 row(s)</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">select behavior_type from bigdata_user limit 10;</span><br></pre></td></tr></table></figure>

<p>结果：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">OK</span><br><span class="line">1</span><br><span class="line">1</span><br><span class="line">1</span><br><span class="line">1</span><br><span class="line">1</span><br><span class="line">4</span><br><span class="line">1</span><br><span class="line">1</span><br><span class="line">1</span><br><span class="line">1</span><br><span class="line">Time taken: 0.113 seconds, Fetched: 10 row(s)</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>BigData</category>
      </categories>
      <tags>
        <tag>Hadoop</tag>
        <tag>Hive</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring整合</title>
    <url>/posts/44766/</url>
    <content><![CDATA[<p>Spring官网：<a href="https://spring.io/">https://spring.io/</a></p>
<p>参考视频：</p>
<ul>
<li><a href="https://www.bilibili.com/video/BV1Ft4y1g7Fb/">Spring视频零基础入门到高级，Spring全套视频教程详解</a></li>
<li><a href="https://www.bilibili.com/video/BV1Fi4y1S7ix/">黑马程序员SSM框架教程Spring部分</a></li>
</ul>
<p>源码仓库：<a href="https://github.com/muyoukule/accidence-spring">muyoukule&#x2F;accidence-spring (github.com)</a></p>
<h1 id="Spring整合JdbcTemplate"><a href="#Spring整合JdbcTemplate" class="headerlink" title="Spring整合JdbcTemplate"></a>Spring整合JdbcTemplate</h1><p>JdbcTemplate是Spring提供的一个JDBC模板类，是对JDBC的封装，简化JDBC代码。</p>
<blockquote>
<p>环境准备</p>
</blockquote>
<p>a. 创建数据表</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">CREATE TABLE `tbl_user` (</span><br><span class="line">  `id` int NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `real_name` varchar(255) DEFAULT NULL,</span><br><span class="line">  `age` int DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (`id`)</span><br><span class="line">) ENGINE=InnoDB AUTO_INCREMENT=7 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;</span><br></pre></td></tr></table></figure>

<p>b. 引入相关依赖</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-context<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.3.27<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.13.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.18.24<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--新增的依赖:mysql驱动--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.0.31<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--新增的依赖：spring jdbc，这个依赖中有JdbcTemplate--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.3.27<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>c. 准备实体类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="keyword">private</span> String realName;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>d. 编写Spring.xml配置文件</p>
<p>JdbcTemplate 是 Spring 提供好的类，这类的完整类名是：<code>org.springframework.jdbc.core.JdbcTemplate</code></p>
<p>我们怎么使用这个类呢？new对象就可以了。怎么new对象？直接将这个类配置到Spring配置文件中，纳入Bean管理即可。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;jdbcTemplate&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.jdbc.core.JdbcTemplate&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>JdbcTemplate 中有一个 <code>DataSource</code> 属性，这个属性是数据源，我们都知道连接数据库需要 <code>Connection</code> 对象，而生成 <code>Connection</code> 对象是数据源负责的。所以我们需要给 JdbcTemplate 设置数据源属性。</p>
<p>所有的数据源都是要实现 <code>javax.sql.DataSource</code> 接口的。这个数据源可以自己写一个，也可以用写好的。比如：阿里巴巴的德鲁伊连接池，c3p0，dbcp等。</p>
<p>e. 手写一个数据源</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyDataSource</span> <span class="keyword">implements</span> <span class="title class_">DataSource</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 添加4个属性</span></span><br><span class="line">    <span class="keyword">private</span> String driver;</span><br><span class="line">    <span class="keyword">private</span> String url;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 重点写怎么获取Connection对象就行。其他方法不用管。</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Connection <span class="title function_">getConnection</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Class.forName(driver);</span><br><span class="line">            <span class="type">Connection</span> <span class="variable">conn</span> <span class="operator">=</span> DriverManager.getConnection(url, username, password);</span><br><span class="line">            <span class="keyword">return</span> conn;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// --snip--</span></span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>f. 数据源传递给JdbcTemplate</p>
<p>写完数据源，我们需要把这个数据源传递给 JdbcTemplate 。因为 JdbcTemplate 中有一个 <code>DataSource</code> 属性：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;myDataSource&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.muyoukule.Datasource.MyDataSource&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;driver&quot;</span> <span class="attr">value</span>=<span class="string">&quot;com.mysql.cj.jdbc.Driver&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;url&quot;</span> <span class="attr">value</span>=<span class="string">&quot;jdbc:mysql://localhost:3306/spring_db&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">value</span>=<span class="string">&quot;root&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">value</span>=<span class="string">&quot;root&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;jdbcTemplate&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.jdbc.core.JdbcTemplate&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;dataSource&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;myDataSource&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>到这里环境就准备好了。</p>
<blockquote>
<p>新增</p>
</blockquote>
<p>编写测试程序：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testInsert</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 获取JdbcTemplate对象</span></span><br><span class="line">    <span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;spring.xml&quot;</span>);</span><br><span class="line">    <span class="type">JdbcTemplate</span> <span class="variable">jdbcTemplate</span> <span class="operator">=</span> applicationContext.getBean(<span class="string">&quot;jdbcTemplate&quot;</span>, JdbcTemplate.class);</span><br><span class="line">    <span class="comment">// 执行插入操作</span></span><br><span class="line">    <span class="comment">// 注意：insert delete update的sql语句，都是执行update方法。</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;insert into tbl_user(id,real_name,age) values(?,?,?)&quot;</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> jdbcTemplate.update(sql, <span class="literal">null</span>, <span class="string">&quot;张三&quot;</span>, <span class="number">30</span>);</span><br><span class="line">    System.out.println(<span class="string">&quot;插入的记录条数：&quot;</span> + count);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">插入的记录条数：1</span><br></pre></td></tr></table></figure>

<p><code>update</code> 方法有两个参数：</p>
<ul>
<li>第一个参数：要执行的 SQL 语句。（SQL语句中可能会有占位符 ? ）</li>
<li>第二个参数：可变长参数，参数的个数可以是0个，也可以是多个。一般是 SQL 语句中有几个问号，则对应几个参数。</li>
</ul>
<blockquote>
<p>修改</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testUpdate</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 获取JdbcTemplate对象</span></span><br><span class="line">    <span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;spring.xml&quot;</span>);</span><br><span class="line">    <span class="type">JdbcTemplate</span> <span class="variable">jdbcTemplate</span> <span class="operator">=</span> applicationContext.getBean(<span class="string">&quot;jdbcTemplate&quot;</span>, JdbcTemplate.class);</span><br><span class="line">    <span class="comment">// 执行更新操作</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;update tbl_user set real_name = ?, age = ? where id = ?&quot;</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> jdbcTemplate.update(sql, <span class="string">&quot;张三丰&quot;</span>, <span class="number">55</span>, <span class="number">1</span>);</span><br><span class="line">    System.out.println(<span class="string">&quot;更新的记录条数：&quot;</span> + count);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">更新的记录条数：1</span><br></pre></td></tr></table></figure>

<blockquote>
<p>删除</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testDelete</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 获取JdbcTemplate对象</span></span><br><span class="line">    <span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;spring.xml&quot;</span>);</span><br><span class="line">    <span class="type">JdbcTemplate</span> <span class="variable">jdbcTemplate</span> <span class="operator">=</span> applicationContext.getBean(<span class="string">&quot;jdbcTemplate&quot;</span>, JdbcTemplate.class);</span><br><span class="line">    <span class="comment">// 执行delete</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;delete from tbl_user where id = ?&quot;</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> jdbcTemplate.update(sql, <span class="number">1</span>);</span><br><span class="line">    System.out.println(<span class="string">&quot;删除了几条记录：&quot;</span> + count);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">删除了几条记录：1</span><br></pre></td></tr></table></figure>

<blockquote>
<p>查询一个对象</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSelectOne</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 获取JdbcTemplate对象</span></span><br><span class="line">    <span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;spring.xml&quot;</span>);</span><br><span class="line">    <span class="type">JdbcTemplate</span> <span class="variable">jdbcTemplate</span> <span class="operator">=</span> applicationContext.getBean(<span class="string">&quot;jdbcTemplate&quot;</span>, JdbcTemplate.class);</span><br><span class="line">    <span class="comment">// 执行select</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;select id, real_name, age from tbl_user where id = ?&quot;</span>;</span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> jdbcTemplate.queryForObject(sql, <span class="keyword">new</span> <span class="title class_">BeanPropertyRowMapper</span>&lt;&gt;(User.class), <span class="number">2</span>);</span><br><span class="line">    System.out.println(user);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>因为刚才已经将数据库数据删除了，所以需要先插入再测试查询</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">User(id=2, realName=张三, age=30)</span><br></pre></td></tr></table></figure>

<p>queryForObject方法三个参数：</p>
<ul>
<li>第一个参数：sql语句</li>
<li>第二个参数：Bean属性值和数据库记录行的映射对象。在构造方法中指定映射的对象类型。</li>
<li>第三个参数：可变长参数，给sql语句的占位符问号传值。</li>
</ul>
<blockquote>
<p>查询多个对象</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSelectAll</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 获取JdbcTemplate对象</span></span><br><span class="line">    <span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;spring.xml&quot;</span>);</span><br><span class="line">    <span class="type">JdbcTemplate</span> <span class="variable">jdbcTemplate</span> <span class="operator">=</span> applicationContext.getBean(<span class="string">&quot;jdbcTemplate&quot;</span>, JdbcTemplate.class);</span><br><span class="line">    <span class="comment">// 执行select</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;select id, real_name, age from tbl_user&quot;</span>;</span><br><span class="line">    List&lt;User&gt; users = jdbcTemplate.query(sql, <span class="keyword">new</span> <span class="title class_">BeanPropertyRowMapper</span>&lt;&gt;(User.class));</span><br><span class="line">    System.out.println(users);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>查询前先使用不同的数据多次执行插入方法</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[User(id=2, realName=张三, age=30), User(id=3, realName=李四, age=31), User(id=4, realName=王五, age=32)]</span><br></pre></td></tr></table></figure>

<blockquote>
<p>查询一个值</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSelectOneValue</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 获取JdbcTemplate对象</span></span><br><span class="line">    <span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;spring.xml&quot;</span>);</span><br><span class="line">    <span class="type">JdbcTemplate</span> <span class="variable">jdbcTemplate</span> <span class="operator">=</span> applicationContext.getBean(<span class="string">&quot;jdbcTemplate&quot;</span>, JdbcTemplate.class);</span><br><span class="line">    <span class="comment">// 执行select</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;select count(1) from tbl_user&quot;</span>;</span><br><span class="line">    <span class="type">Integer</span> <span class="variable">count</span> <span class="operator">=</span> jdbcTemplate.queryForObject(sql, <span class="type">int</span>.class); <span class="comment">// 这里用Integer.class也可以</span></span><br><span class="line">    System.out.println(<span class="string">&quot;总记录条数：&quot;</span> + count);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">总记录条数：3</span><br></pre></td></tr></table></figure>

<blockquote>
<p>批量添加</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testAddBatch</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 获取JdbcTemplate对象</span></span><br><span class="line">    <span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;spring.xml&quot;</span>);</span><br><span class="line">    <span class="type">JdbcTemplate</span> <span class="variable">jdbcTemplate</span> <span class="operator">=</span> applicationContext.getBean(<span class="string">&quot;jdbcTemplate&quot;</span>, JdbcTemplate.class);</span><br><span class="line">    <span class="comment">// 批量添加</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;insert into tbl_user(id,real_name,age) values(?,?,?)&quot;</span>;</span><br><span class="line"></span><br><span class="line">    Object[] objs1 = &#123;<span class="literal">null</span>, <span class="string">&quot;小花&quot;</span>, <span class="number">20</span>&#125;;</span><br><span class="line">    Object[] objs2 = &#123;<span class="literal">null</span>, <span class="string">&quot;小明&quot;</span>, <span class="number">21</span>&#125;;</span><br><span class="line">    Object[] objs3 = &#123;<span class="literal">null</span>, <span class="string">&quot;小刚&quot;</span>, <span class="number">22</span>&#125;;</span><br><span class="line">    List&lt;Object[]&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    list.add(objs1);</span><br><span class="line">    list.add(objs2);</span><br><span class="line">    list.add(objs3);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span>[] count = jdbcTemplate.batchUpdate(sql, list);</span><br><span class="line">    System.out.println(Arrays.toString(count));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[1, 1, 1]</span><br></pre></td></tr></table></figure>

<blockquote>
<p>批量修改</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testUpdateBatch</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 获取JdbcTemplate对象</span></span><br><span class="line">    <span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;spring.xml&quot;</span>);</span><br><span class="line">    <span class="type">JdbcTemplate</span> <span class="variable">jdbcTemplate</span> <span class="operator">=</span> applicationContext.getBean(<span class="string">&quot;jdbcTemplate&quot;</span>, JdbcTemplate.class);</span><br><span class="line">    <span class="comment">// 批量修改</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;update tbl_user set real_name = ?, age = ? where id = ?&quot;</span>;</span><br><span class="line">    Object[] objs1 = &#123;<span class="string">&quot;小花11&quot;</span>, <span class="number">10</span>, <span class="number">5</span>&#125;;</span><br><span class="line">    Object[] objs2 = &#123;<span class="string">&quot;小明22&quot;</span>, <span class="number">12</span>, <span class="number">6</span>&#125;;</span><br><span class="line">    Object[] objs3 = &#123;<span class="string">&quot;小刚33&quot;</span>, <span class="number">9</span>, <span class="number">7</span>&#125;;</span><br><span class="line">    List&lt;Object[]&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    list.add(objs1);</span><br><span class="line">    list.add(objs2);</span><br><span class="line">    list.add(objs3);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span>[] count = jdbcTemplate.batchUpdate(sql, list);</span><br><span class="line">    System.out.println(Arrays.toString(count));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[1, 1, 1]</span><br></pre></td></tr></table></figure>

<blockquote>
<p>批量删除</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testDeleteBatch</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 获取JdbcTemplate对象</span></span><br><span class="line">    <span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;spring.xml&quot;</span>);</span><br><span class="line">    <span class="type">JdbcTemplate</span> <span class="variable">jdbcTemplate</span> <span class="operator">=</span> applicationContext.getBean(<span class="string">&quot;jdbcTemplate&quot;</span>, JdbcTemplate.class);</span><br><span class="line">    <span class="comment">// 批量删除</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;delete from tbl_user where id = ?&quot;</span>;</span><br><span class="line">    Object[] objs1 = &#123;<span class="number">5</span>&#125;;</span><br><span class="line">    Object[] objs2 = &#123;<span class="number">6</span>&#125;;</span><br><span class="line">    Object[] objs3 = &#123;<span class="number">7</span>&#125;;</span><br><span class="line">    List&lt;Object[]&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    list.add(objs1);</span><br><span class="line">    list.add(objs2);</span><br><span class="line">    list.add(objs3);</span><br><span class="line">    <span class="type">int</span>[] count = jdbcTemplate.batchUpdate(sql, list);</span><br><span class="line">    System.out.println(Arrays.toString(count));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[1, 1, 1]</span><br></pre></td></tr></table></figure>

<blockquote>
<p>使用回调函数</p>
</blockquote>
<p>使用回调函数，可以参与的更加细节：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testCallback</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 获取JdbcTemplate对象</span></span><br><span class="line">    <span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;spring.xml&quot;</span>);</span><br><span class="line">    <span class="type">JdbcTemplate</span> <span class="variable">jdbcTemplate</span> <span class="operator">=</span> applicationContext.getBean(<span class="string">&quot;jdbcTemplate&quot;</span>, JdbcTemplate.class);</span><br><span class="line">    <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;select id, real_name, age from tbl_user where id = ?&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> jdbcTemplate.execute(sql, <span class="keyword">new</span> <span class="title class_">PreparedStatementCallback</span>&lt;User&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> User <span class="title function_">doInPreparedStatement</span><span class="params">(PreparedStatement ps)</span> <span class="keyword">throws</span> SQLException, DataAccessException &#123;</span><br><span class="line">            <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            ps.setInt(<span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line">            <span class="type">ResultSet</span> <span class="variable">rs</span> <span class="operator">=</span> ps.executeQuery();</span><br><span class="line">            <span class="keyword">if</span> (rs.next()) &#123;</span><br><span class="line">                user = <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">                user.setId(rs.getInt(<span class="string">&quot;id&quot;</span>));</span><br><span class="line">                user.setRealName(rs.getString(<span class="string">&quot;real_name&quot;</span>));</span><br><span class="line">                user.setAge(rs.getInt(<span class="string">&quot;age&quot;</span>));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> user;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    System.out.println(user);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">User(id=2, realName=张三, age=30)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>使用德鲁伊连接池</p>
</blockquote>
<p>之前数据源是用我们自己写的。也可以使用别人写好的。例如德鲁伊连接池。</p>
<p>a. 引入德鲁伊连接池的依赖。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.16<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>b. 将德鲁伊中的数据源配置到 spring 配置文件中。和配置我们自己写的一样。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;druidDataSource&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.alibaba.druid.pool.DruidDataSource&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;driverClassName&quot;</span> <span class="attr">value</span>=<span class="string">&quot;com.mysql.cj.jdbc.Driver&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;url&quot;</span> <span class="attr">value</span>=<span class="string">&quot;jdbc:mysql://localhost:3306/spring_db&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">value</span>=<span class="string">&quot;root&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">value</span>=<span class="string">&quot;root&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;jdbcTemplate&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.jdbc.core.JdbcTemplate&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;dataSource&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;druidDataSource&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">User(id=2, realName=张三, age=30)</span><br></pre></td></tr></table></figure>

<h1 id="Spring整合Mybatis"><a href="#Spring整合Mybatis" class="headerlink" title="Spring整合Mybatis"></a>Spring整合Mybatis</h1><h2 id="1-Spring整合Mybatis思路分析"><a href="#1-Spring整合Mybatis思路分析" class="headerlink" title="1. Spring整合Mybatis思路分析"></a>1. Spring整合Mybatis思路分析</h2><blockquote>
<p>环境准备</p>
</blockquote>
<p>在准备环境的过程中，先回顾下Mybatis开发的相关内容:</p>
<p>a. 准备数据库表</p>
<p>Mybatis是来操作数据库表，所以先创建一个数据库及表</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> database spring_db <span class="type">character</span> <span class="keyword">set</span> utf8;</span><br><span class="line">use spring_db;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> tbl_account(</span><br><span class="line">    id <span class="type">int</span> <span class="keyword">primary</span> key auto_increment,</span><br><span class="line">    name <span class="type">varchar</span>(<span class="number">35</span>),</span><br><span class="line">    money <span class="keyword">double</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>b. 引入相关依赖</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-context<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.3.27<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.18.24<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.0.31<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.5.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    	<span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.16<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>c. 根据表创建模型类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Account</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Double money;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>d. 创建 Dao 接口</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">AccountDao</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Insert(&quot;insert into tbl_account(name,money)values(#&#123;name&#125;,#&#123;money&#125;)&quot;)</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">save</span><span class="params">(Account account)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Delete(&quot;delete from tbl_account where id = #&#123;id&#125; &quot;)</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">delete</span><span class="params">(Integer id)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Update(&quot;update tbl_account set name = #&#123;name&#125; , money = #&#123;money&#125; where id = #&#123;id&#125; &quot;)</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">update</span><span class="params">(Account account)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Select(&quot;select * from tbl_account&quot;)</span></span><br><span class="line">    List&lt;Account&gt; <span class="title function_">findAll</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Select(&quot;select * from tbl_account where id = #&#123;id&#125; &quot;)</span></span><br><span class="line">    Account <span class="title function_">findById</span><span class="params">(Integer id)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>e. 创建 Service 接口和实现类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">AccountService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">save</span><span class="params">(Account account)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">delete</span><span class="params">(Integer id)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">update</span><span class="params">(Account account)</span>;</span><br><span class="line"></span><br><span class="line">    List&lt;Account&gt; <span class="title function_">findAll</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    Account <span class="title function_">findById</span><span class="params">(Integer id)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AccountServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">AccountService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AccountDao accountDao;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">save</span><span class="params">(Account account)</span> &#123;</span><br><span class="line">        accountDao.save(account);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">update</span><span class="params">(Account account)</span> &#123;</span><br><span class="line">        accountDao.update(account);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">delete</span><span class="params">(Integer id)</span> &#123;</span><br><span class="line">        accountDao.delete(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Account <span class="title function_">findById</span><span class="params">(Integer id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> accountDao.findById(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> List&lt;Account&gt; <span class="title function_">findAll</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> accountDao.findAll();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>f. 添加 <code>jdbc.properties</code> 文件</p>
<p>resources 目录下添加，用于配置数据库连接四要素</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">jdbc.driver</span>=<span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line"><span class="attr">jdbc.url</span>=<span class="string">jdbc:mysql://localhost:3306/spring_db?useSSL=false</span></span><br><span class="line"><span class="attr">jdbc.username</span>=<span class="string">root</span></span><br><span class="line"><span class="attr">jdbc.password</span>=<span class="string">root</span></span><br></pre></td></tr></table></figure>

<p>useSSL：关闭 MySQL 的 SSL 连接</p>
<p>g. 添加 Mybatis 核心配置文件（SqlMapConfig.xml）</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">configuration</span></span></span><br><span class="line"><span class="meta">        <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Config 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">        <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-config.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--读取外部properties配置文件--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span> <span class="attr">resource</span>=<span class="string">&quot;jdbc.properties&quot;</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--别名扫描的包路径--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">typeAliases</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">package</span> <span class="attr">name</span>=<span class="string">&quot;com.muyoukule.Entity&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">typeAliases</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--数据源--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">environments</span> <span class="attr">default</span>=<span class="string">&quot;mysql&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">environment</span> <span class="attr">id</span>=<span class="string">&quot;mysql&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">transactionManager</span> <span class="attr">type</span>=<span class="string">&quot;JDBC&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dataSource</span> <span class="attr">type</span>=<span class="string">&quot;POOLED&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;driver&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;jdbc.driver&#125;&quot;</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;url&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;jdbc.url&#125;&quot;</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;jdbc.username&#125;&quot;</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;jdbc.password&#125;&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dataSource</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">environment</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">environments</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--映射文件扫描包路径--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mappers</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">package</span> <span class="attr">name</span>=<span class="string">&quot;com.muyoukule.Dao&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mappers</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>h. 编写应用程序</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">App</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// 1. 创建SqlSessionFactoryBuilder对象</span></span><br><span class="line">        <span class="type">SqlSessionFactoryBuilder</span> <span class="variable">sqlSessionFactoryBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SqlSessionFactoryBuilder</span>();</span><br><span class="line">        <span class="comment">// 2. 加载SqlMapConfig.xml配置文件</span></span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> Resources.getResourceAsStream(<span class="string">&quot;SqlMapConfig.xml&quot;</span>);</span><br><span class="line">        <span class="comment">// 3. 创建SqlSessionFactory对象</span></span><br><span class="line">        <span class="type">SqlSessionFactory</span> <span class="variable">sqlSessionFactory</span> <span class="operator">=</span> sqlSessionFactoryBuilder.build(inputStream);</span><br><span class="line">        <span class="comment">// 4. 获取SqlSession</span></span><br><span class="line">        <span class="type">SqlSession</span> <span class="variable">sqlSession</span> <span class="operator">=</span> sqlSessionFactory.openSession();</span><br><span class="line">        <span class="comment">// 5. 执行SqlSession对象执行查询，获取结果User</span></span><br><span class="line">        <span class="type">AccountDao</span> <span class="variable">accountDao</span> <span class="operator">=</span> sqlSession.getMapper(AccountDao.class);</span><br><span class="line"></span><br><span class="line">        <span class="type">Account</span> <span class="variable">ac</span> <span class="operator">=</span> accountDao.findById(<span class="number">1</span>);</span><br><span class="line">        System.out.println(ac);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6. 释放资源</span></span><br><span class="line">        sqlSession.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>i. 运行程序</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">null</span><br></pre></td></tr></table></figure>

<p>结果为 null 是因为数据库还未插入数据。</p>
<blockquote>
<p>整合思路分析</p>
</blockquote>
<p>Mybatis 的基础环境我们已经准备好了，接下来就得分析下在上述的内容中，哪些对象可以交给 Spring 来管理?</p>
<ul>
<li><p>Mybatis程序核心对象分析</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/accidence-spring/Mybatis%E7%A8%8B%E5%BA%8F%E6%A0%B8%E5%BF%83%E5%AF%B9%E8%B1%A1%E5%88%86%E6%9E%90.png" style="zoom:80%;">

<p>从图中可以获取到，真正需要交给Spring管理的是 <code>SqlSessionFactory</code></p>
</li>
<li><p>整合 Mybatis，就是将 Mybatis 用到的内容交给 Spring 管理，分析下配置文件</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/accidence-spring/%E5%88%86%E6%9E%90Mybatis%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6.png" style="zoom:80%;">

<p><strong>说明:</strong></p>
<ul>
<li>第一行读取外部 <code>properties</code> 配置文件，Spring有提供具体的解决方案 <code>@PropertySource</code>，需要交给Spring</li>
<li>第二行起别名包扫描，为 <code>SqlSessionFactory</code> 服务的，需要交给 Spring</li>
<li>第三行主要用于做连接池，Spring 之前我们已经整合了 Druid 连接池，这块也需要交给 Spring</li>
<li>前面三行一起都是为了创建 <code>SqlSession</code> 对象用的，那么用 Spring 管理 <code>SqlSession</code> 对象吗？回忆下 <code>SqlSession</code> 是由<code>SqlSessionFactory</code> 创建出来的，所以只需要将 <code>SqlSessionFactory</code> 交给 Spring 管理即可。</li>
<li>第四行是 <code>Mapper</code> 接口和映射文件（如果使用注解就没有该映射文件），这个是在获取到 <code>SqlSession</code> 以后执行具体操作的时候用，所以它和 <code>SqlSessionFactory</code> 创建的时机都不在同一个时间，可能需要单独管理。</li>
</ul>
</li>
</ul>
<h2 id="2-Spring整合Mybatis"><a href="#2-Spring整合Mybatis" class="headerlink" title="2. Spring整合Mybatis"></a>2. Spring整合Mybatis</h2><p>前面我们已经分析了 Spring 与 Mybatis 的整合，大体需要做两件事：</p>
<ol>
<li><p>Spring 要管理 MyBatis 中的 <code>SqlSessionFactory</code></p>
</li>
<li><p>Spring 要管理 Mapper 接口的扫描</p>
</li>
</ol>
<blockquote>
<p>实现步骤</p>
</blockquote>
<p>a. 项目中导入整合需要的 jar 包</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--Spring操作数据库需要该jar包--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.3.27<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">    Spring与Mybatis整合的jar包</span></span><br><span class="line"><span class="comment">    这个jar包mybatis在前面，是Mybatis提供的</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>b. 创建 Spring 的主配置类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//配置类注解</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="comment">//包扫描，主要扫描的是项目中的AccountServiceImpl类</span></span><br><span class="line"><span class="meta">@ComponentScan(&quot;com.muyoukule&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringConfig</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>c. 创建数据源的配置类</p>
<p>在配置类中完成数据源的创建</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JdbcConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;jdbc.driver&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String driver;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;jdbc.url&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String url;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;jdbc.username&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String userName;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;jdbc.password&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> DataSource <span class="title function_">dataSource</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">DruidDataSource</span> <span class="variable">ds</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DruidDataSource</span>();</span><br><span class="line">        ds.setDriverClassName(driver);</span><br><span class="line">        ds.setUrl(url);</span><br><span class="line">        ds.setUsername(userName);</span><br><span class="line">        ds.setPassword(password);</span><br><span class="line">        <span class="keyword">return</span> ds;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>d. 主配置类中读 <code>properties</code> 并引入数据源配置类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan(&quot;com.muyoukule&quot;)</span></span><br><span class="line"><span class="meta">@PropertySource(&quot;classpath:jdbc.properties&quot;)</span></span><br><span class="line"><span class="meta">@Import(JdbcConfig.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringConfig</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>e. 创建 Mybatis 配置类并配置 <code>SqlSessionFactory</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MybatisConfig</span> &#123;</span><br><span class="line">    <span class="comment">//定义bean，SqlSessionFactoryBean，用于产生SqlSessionFactory对象</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> SqlSessionFactoryBean <span class="title function_">sqlSessionFactory</span><span class="params">(DataSource dataSource)</span> &#123;</span><br><span class="line">        <span class="type">SqlSessionFactoryBean</span> <span class="variable">ssfb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SqlSessionFactoryBean</span>();</span><br><span class="line">        <span class="comment">//设置模型类的别名扫描</span></span><br><span class="line">        ssfb.setTypeAliasesPackage(<span class="string">&quot;com.muyoukule.Entity&quot;</span>);</span><br><span class="line">        <span class="comment">//设置数据源</span></span><br><span class="line">        ssfb.setDataSource(dataSource);</span><br><span class="line">        <span class="keyword">return</span> ssfb;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//定义bean，返回MapperScannerConfigurer对象</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> MapperScannerConfigurer <span class="title function_">mapperScannerConfigurer</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">MapperScannerConfigurer</span> <span class="variable">msc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MapperScannerConfigurer</span>();</span><br><span class="line">        msc.setBasePackage(<span class="string">&quot;com.muyoukule.Dao&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> msc;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>说明:</strong></p>
<ul>
<li><p>使用 <code>SqlSessionFactoryBean</code> 封装 <code>SqlSessionFactory</code> 需要的环境信息</p>
<ul>
<li><code>SqlSessionFactoryBean</code> 是前面我们讲解 <code>FactoryBean</code> 的一个子类，在该类中将 <code>SqlSessionFactory</code> 的创建进行了封装，简化对象的创建，我们只需要将其需要的内容设置即可。</li>
<li>方法中有一个参数为 <code>dataSource</code>，当前Spring容器中已经创建了Druid数据源，类型刚好是 <code>DataSource</code> 类型，此时在初始化 <code>SqlSessionFactoryBean</code> 这个对象的时候，发现需要使用 <code>DataSource</code> 对象，而容器中刚好有这么一个对象，就自动加载了 <code>DruidDataSource</code> 对象。</li>
</ul>
</li>
<li><p>使用 <code>MapperScannerConfigurer</code> 加载 Dao 接口，创建代理对象保存到 IOC 容器中</p>
<ul>
<li>这个 <code>MapperScannerConfigurer</code> 对象也是 MyBatis 提供的专用于整合的 jar 包中的类，用来处理原始配置文件中的 mappers 相关配置，加载数据层的 Mapper 接口类</li>
<li><code>MapperScannerConfigurer</code> 有一个核心属性 <code>basePackage</code>，就是用来设置所扫描的包路径</li>
</ul>
</li>
</ul>
<p>f. 主配置类中引入 Mybatis 配置类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan(&quot;com.muyoukule&quot;)</span></span><br><span class="line"><span class="meta">@PropertySource(&quot;classpath:jdbc.properties&quot;)</span></span><br><span class="line"><span class="meta">@Import(&#123;JdbcConfig.class, MybatisConfig.class&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringConfig</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>g. 编写运行类</p>
<p>在运行类中，从 IOC 容器中获取 Service 对象，调用方法获取结果</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">App2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ApplicationContext</span> <span class="variable">ctx</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnnotationConfigApplicationContext</span>(SpringConfig.class);</span><br><span class="line">        <span class="type">AccountService</span> <span class="variable">accountService</span> <span class="operator">=</span> ctx.getBean(AccountService.class);</span><br><span class="line"></span><br><span class="line">        <span class="type">Account</span> <span class="variable">tom</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Account</span>(<span class="number">1</span>, <span class="string">&quot;Tom&quot;</span>, <span class="number">1000.00</span>);</span><br><span class="line">        accountService.save(tom);</span><br><span class="line">        </span><br><span class="line">        <span class="type">Account</span> <span class="variable">ac</span> <span class="operator">=</span> accountService.findById(<span class="number">1</span>);</span><br><span class="line">        System.out.println(ac);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>h. 运行程序</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Account(id=1, name=Tom, money=1000.0)</span><br></pre></td></tr></table></figure>

<h1 id="Spring整合Junit"><a href="#Spring整合Junit" class="headerlink" title="Spring整合Junit"></a>Spring整合Junit</h1><p>整合 Junit 与整合 Druid 和 MyBatis 差异比较大，为什么呢？Junit是一个搞单元测试用的工具，它不是我们程序的主体，也不会参加最终程序的运行，从作用上来说就和之前的东西不一样，它不是做功能的，看做是一个辅助工具就可以了。</p>
<blockquote>
<p>环境准备</p>
</blockquote>
<p>这块环境，大家可以直接使用 Spring 与 Mybatis 整合的环境即可。当然也可以重新创建一个。</p>
<blockquote>
<p>整合Junit</p>
</blockquote>
<p>a. 引入依赖</p>
<p>pom.xml</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.13.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.3.27<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>b. 编写测试类</p>
<p>在 test\java下创建</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//设置类运行器</span></span><br><span class="line"><span class="meta">@RunWith(SpringJUnit4ClassRunner.class)</span></span><br><span class="line"><span class="comment">//设置Spring环境对应的配置类</span></span><br><span class="line"><span class="meta">@ContextConfiguration(classes = &#123;SpringConfig.class&#125;)</span> <span class="comment">//加载配置类</span></span><br><span class="line"><span class="comment">//@ContextConfiguration(locations=&#123;&quot;classpath:applicationContext.xml&quot;&#125;)//加载配置文件</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AccountServiceTest</span> &#123;</span><br><span class="line">    <span class="comment">//支持自动装配注入bean</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AccountService accountService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testFindById</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(accountService.findById(<span class="number">1</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testFindAll</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(accountService.findAll());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[Account(id=1, name=Tom, money=1000.0)]</span><br><span class="line">Account(id=1, name=Tom, money=1000.0)</span><br></pre></td></tr></table></figure>

<p><strong>注意:</strong></p>
<ul>
<li>单元测试，如果测试的是注解配置类，则使用<code>@ContextConfiguration(classes = 配置类.class)</code></li>
<li>单元测试，如果测试的是配置文件，则使用<code>@ContextConfiguration(locations=&#123;配置文件名,...&#125;)</code></li>
<li>Junit运行后是基于 Spring 环境运行的，所以 Spring 提供了一个专用的类运行器，这个务必要设置，这个类运行器就在 Spring 的测试专用包中提供的，导入的坐标就是这个东西<code>SpringJUnit4ClassRunner</code></li>
<li>上面两个配置都是固定格式，当需要测试哪个 bean 时，使用自动装配加载对应的对象，下面的工作就和以前做 Junit 单元测试完全一样了。</li>
</ul>
]]></content>
      <categories>
        <category>Java</category>
        <category>SSM</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>Spring</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring入门（下）</title>
    <url>/posts/2728/</url>
    <content><![CDATA[<p>Spring官网：<a href="https://spring.io/">https://spring.io/</a></p>
<p>参考视频：</p>
<ul>
<li><a href="https://www.bilibili.com/video/BV1Ft4y1g7Fb/">Spring视频零基础入门到高级，Spring全套视频教程详解</a></li>
<li><a href="https://www.bilibili.com/video/BV1Fi4y1S7ix/">黑马程序员SSM框架教程Spring部分</a></li>
</ul>
<p>源码仓库：<a href="https://github.com/muyoukule/accidence-spring">muyoukule&#x2F;accidence-spring (github.com)</a></p>
<h1 id="1-Spring-IoC注解式开发"><a href="#1-Spring-IoC注解式开发" class="headerlink" title="1. Spring IoC注解式开发"></a>1. Spring IoC注解式开发</h1><h2 id="1-1-回顾注解"><a href="#1-1-回顾注解" class="headerlink" title="1.1 回顾注解"></a>1.1 回顾注解</h2><p>注解的存在主要是为了简化XML的配置。</p>
<p>我们来回顾一下：</p>
<ul>
<li>第一：注解怎么定义，注解中的属性怎么定义？</li>
<li>第二：注解怎么使用？</li>
<li>第三：通过反射机制怎么读取注解？</li>
</ul>
<blockquote>
<p>注解怎么定义，注解中的属性怎么定义？</p>
</blockquote>
<p>自定义注解</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Target(value = &#123;ElementType.TYPE&#125;)</span></span><br><span class="line"><span class="meta">@Retention(value = RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Component &#123;</span><br><span class="line">    String <span class="title function_">value</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以上是自定义了一个注解：<code>Component</code></p>
<p>该注解上面修饰的注解包括：<code>Target</code> 注解和 <code>Retention</code> 注解，这两个注解被称为元注解。</p>
<p><code>Target</code> 注解用来设置 <code>Component</code> 注解可以出现的位置，以上代表表示 <code>Component</code> 注解只能用在类和接口上。</p>
<p><code>Retention</code> 注解用来设置 <code>Component</code> 注解的保持性策略，以上代表 <code>Component</code> 注解可以被反射机制读取。</p>
<p><code>String value();</code> 是 <code>Component</code> 注解中的一个属性。该属性类型 String ，属性名是 value 。</p>
<blockquote>
<p>注解怎么使用？</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component(value = &quot;userBean&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>用法简单，语法格式：@注解类型名(属性名&#x3D;属性值, 属性名&#x3D;属性值, 属性名&#x3D;属性值……)</p>
<p><code>userBean</code> 为什么使用双引号括起来，因为 value 属性是 String 类型，字符串。</p>
<p>另外如果属性名是 value ，则在使用的时候可以省略属性名，例如：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component(&quot;userBean&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>通过反射机制怎么读取注解？</p>
</blockquote>
<p>接下来，我们来写一段程序，当 Bean 类上有 <code>Component</code> 注解时，则实例化 Bean 对象，如果没有，则不实例化对象。</p>
<p>我们准备两个 Bean ，一个上面有注解，一个上面没有注解。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component(&quot;userBean&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Vip</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>假设我们现在只知道包名：<code>com.muyoukule.bean</code> 。至于这个包下有多少个 Bean 我们不知道。哪些 Bean 上有注解，哪些 Bean 上没有注解，这些我们都不知道，如何通过程序全自动化判断。</p>
<p>a. 反射解析注解</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ComponentScan</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 存放Bean的Map集合。key存储beanId。value存储Bean。</span></span><br><span class="line">        Map&lt;String, Object&gt; beanMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">packageName</span> <span class="operator">=</span> <span class="string">&quot;com.muyoukule.Bean&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> packageName.replaceAll(<span class="string">&quot;\\.&quot;</span>, <span class="string">&quot;/&quot;</span>);</span><br><span class="line">        <span class="type">URL</span> <span class="variable">url</span> <span class="operator">=</span> ClassLoader.getSystemClassLoader().getResource(path);</span><br><span class="line">        <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(url.getPath());</span><br><span class="line">        File[] files = file.listFiles();</span><br><span class="line">        Arrays.stream(files).forEach(f -&gt; &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">className</span> <span class="operator">=</span> packageName + <span class="string">&quot;.&quot;</span> + f.getName().split(<span class="string">&quot;\\.&quot;</span>)[<span class="number">0</span>];</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Class&lt;?&gt; clazz = Class.forName(className);</span><br><span class="line">                <span class="keyword">if</span> (clazz.isAnnotationPresent(Component.class)) &#123;</span><br><span class="line">                    <span class="type">Component</span> <span class="variable">component</span> <span class="operator">=</span> clazz.getAnnotation(Component.class);</span><br><span class="line">                    <span class="type">String</span> <span class="variable">beanId</span> <span class="operator">=</span> component.value();</span><br><span class="line">                    <span class="type">Object</span> <span class="variable">bean</span> <span class="operator">=</span> clazz.newInstance();</span><br><span class="line">                    beanMap.put(beanId, bean);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        System.out.println(beanMap);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>b. 执行结果</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;userBean=com.muyoukule.Bean.User@27fa135a&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注：如果项目存放路径有中文或者空格可能会报空指针异常</strong></p>
<h2 id="1-2-声明Bean的注解"><a href="#1-2-声明Bean的注解" class="headerlink" title="1.2  声明Bean的注解"></a>1.2  声明Bean的注解</h2><p>负责声明 Bean 的注解，常见的包括四个：</p>
<ul>
<li><code>@Component</code></li>
<li><code>@Controller</code></li>
<li><code>@Service</code></li>
<li><code>@Repository</code></li>
</ul>
<p>源码如下：</p>
<p><code>@Component</code> 注解</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Target(value = &#123;ElementType.TYPE&#125;)</span></span><br><span class="line"><span class="meta">@Retention(value = RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Component &#123;</span><br><span class="line">    String <span class="title function_">value</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>@Controller</code> 注解</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Target(&#123;ElementType.TYPE&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Controller &#123;</span><br><span class="line">    <span class="meta">@AliasFor(</span></span><br><span class="line"><span class="meta">        annotation = Component.class</span></span><br><span class="line"><span class="meta">    )</span></span><br><span class="line">    String <span class="title function_">value</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>@Service</code> 注解</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Target(&#123;ElementType.TYPE&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Service &#123;</span><br><span class="line">    <span class="meta">@AliasFor(</span></span><br><span class="line"><span class="meta">        annotation = Component.class</span></span><br><span class="line"><span class="meta">    )</span></span><br><span class="line">    String <span class="title function_">value</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>@Repository</code> 注解</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Target(&#123;ElementType.TYPE&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Repository &#123;</span><br><span class="line">    <span class="meta">@AliasFor(</span></span><br><span class="line"><span class="meta">        annotation = Component.class</span></span><br><span class="line"><span class="meta">    )</span></span><br><span class="line">    String <span class="title function_">value</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过源码可以看到，<code>@Controller</code> 、<code>@Service</code> 、<code>@Repository</code> 这三个注解都是 <code>@Component</code> 注解的别名。</p>
<p>也就是说：这四个注解的功能都一样。用哪个都可以。</p>
<p>只是为了增强程序的可读性，建议：</p>
<ul>
<li>控制器类上使用：Controller</li>
<li>Service类上使用：Service</li>
<li>Dao类上使用：Repository</li>
</ul>
<p>他们都是只有一个 value 属性。value属性用来指定 bean 的 id，也就是 bean 的名字。</p>
<h2 id="1-3-Spring注解的使用"><a href="#1-3-Spring注解的使用" class="headerlink" title="1.3 Spring注解的使用"></a>1.3 Spring注解的使用</h2><p>如何使用以上的注解呢？</p>
<ol>
<li>加入aop的依赖</li>
<li>在配置文件中添加 <code>context</code> 命名空间</li>
<li>在配置文件中指定扫描的包</li>
<li>在Bean类上使用注解</li>
</ol>
<p>a. 加入aop的依赖：</p>
<p>我们可以看到当加入 <code>spring-contex</code>t 依赖之后，会关联加入 <code>aop</code> 的依赖。所以这一步不用做。</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/accidence-spring/aop%E7%9A%84%E4%BE%9D%E8%B5%96.png"></p>
<p>b. 在配置文件 <code>spring.xml</code> 中添加context命名空间</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">                           http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>c. 在配置文件 <code>spring.xml</code> 中指定要扫描的包</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">&quot;com.muyoukule.Bean&quot;</span>/&gt;</span> </span><br></pre></td></tr></table></figure>

<p>d. 在Bean类上使用注解</p>
<p>这里一定要注意是使用 <code>org.springframework.stereotype</code> 包下的 <code>@Component</code> ，不是上面自定义的<code>@Component</code> 😢</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component(value = &quot;userBean&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>e. 编写测试程序</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testBean</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;spring.xml&quot;</span>);</span><br><span class="line">    <span class="type">User</span> <span class="variable">userBean</span> <span class="operator">=</span> applicationContext.getBean(<span class="string">&quot;userBean&quot;</span>, User.class);</span><br><span class="line">    System.out.println(userBean);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>f. 执行结果</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">com.muyoukule.Bean.User@a43ce46</span><br></pre></td></tr></table></figure>

<p>如果注解的属性名是value，那么value是可以省略的。</p>
<p>如果把value属性彻底去掉，spring会被 Bean 自动取名，并且默认名字的规律是：Bean类名首字母小写即可。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BankDao</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>也就是说，这个 BankDao 的 bean 的名字为：bankDao</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">com.muyoukule.Bean.BankDao@2320fa6f</span><br></pre></td></tr></table></figure>

<p><strong>如果是多个包有两种解决方案：</strong></p>
<ol>
<li>在配置文件中指定多个包，用逗号隔开。</li>
<li>指定多个包的共同父包。</li>
</ol>
<blockquote>
<p>逗号（英文）的方式</p>
</blockquote>
<p>a. 创建一个新的包：Bean2，定义一个Bean类Order</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Order</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>b. 配置文件 <code>spring.xml</code> 中修改</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--1.在配置文件中指定多个包，用逗号隔开。--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--&lt;context:component-scan base-package=&quot;com.muyoukule.Bean,com.muyoukule.Bean2&quot;/&gt;--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--2.指定多个包的共同父包。--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">&quot;com.muyoukule&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>c. 测试</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">com.muyoukule.Bean.BankDao@37052337</span><br><span class="line">com.muyoukule.Bean2.Order@2320fa6f</span><br></pre></td></tr></table></figure>

<h2 id="1-4-选择性实例化Bean"><a href="#1-4-选择性实例化Bean" class="headerlink" title="1.4 选择性实例化Bean"></a>1.4 选择性实例化Bean</h2><p>假设在某个包下有很多 Bean，有的 Bean上 标注了 <code>@Component</code>，有的标注了 <code>@Controller</code>，有的标注了 <code>@Service</code>，有的标注了 <code>@Repository</code>，现在由于某种特殊业务的需要，只允许其中所有的 <code>@Controller</code> 参与 Bean 管理，其他的都不实例化。这应该怎么办呢？</p>
<p>a. 为了方便，将这几个类都定义到同一个java源文件中</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">A</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">A</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;A的无参数构造方法执行&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">B</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">B</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;B的无参数构造方法执行&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">C</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">C</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;C的无参数构造方法执行&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">D</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">D</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;D的无参数构造方法执行&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">E</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">E</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;E的无参数构造方法执行&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">F</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">F</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;F的无参数构造方法执行&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>b. 只想实例化 Bean3 包下的 <code>@Controller</code>。配置文件这样写：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">&quot;com.muyoukule.Bean3&quot;</span> <span class="attr">use-default-filters</span>=<span class="string">&quot;false&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:include-filter</span> <span class="attr">type</span>=<span class="string">&quot;annotation&quot;</span> <span class="attr">expression</span>=<span class="string">&quot;org.springframework.stereotype.Controller&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">context:component-scan</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>use-default-filters=&quot;true&quot;</code> 表示：使用 spring 默认的规则，只要有 <code>@Component</code> 、<code>@Controller</code> 、<code>@Service</code> 、<code>@Repository</code>  中的任意一个注解标注，则进行实例化。</p>
<p><code>use-default-filters=&quot;false&quot;</code> 表示：不再 spring 默认实例化规则，即使有 <code>@Component</code> 、<code>@Controller</code> 、<code>@Service</code> 、<code>@Repository</code>  这些注解标注，也不再实例化。</p>
<p><code>&lt;context:include-filter type=&quot;annotation&quot; expression=&quot;org.springframework.stereotype.Controller&quot;/&gt;</code> 表示只有<code>@Controller</code> 进行实例化</p>
<p>c. 测试程序</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testChoose</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;spring.xml&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>d. 执行结果</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">B的无参数构造方法执行</span><br><span class="line">E的无参数构造方法执行</span><br><span class="line">F的无参数构造方法执行</span><br></pre></td></tr></table></figure>

<p>也可以将 <code>use-default-filters</code> 设置为 true（不写就是true），并且采用 <code>exclude-filter</code> 方式排出哪些注解标注的 Bean 不参与实例化：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">&quot;com.muyoukule.Bean3&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:exclude-filter</span> <span class="attr">type</span>=<span class="string">&quot;annotation&quot;</span> <span class="attr">expression</span>=<span class="string">&quot;org.springframework.stereotype.Repository&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:exclude-filter</span> <span class="attr">type</span>=<span class="string">&quot;annotation&quot;</span> <span class="attr">expression</span>=<span class="string">&quot;org.springframework.stereotype.Service&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:exclude-filter</span> <span class="attr">type</span>=<span class="string">&quot;annotation&quot;</span> <span class="attr">expression</span>=<span class="string">&quot;org.springframework.stereotype.Controller&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">context:component-scan</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">A的无参数构造方法执行</span><br></pre></td></tr></table></figure>

<h2 id="1-5-负责注入的注解"><a href="#1-5-负责注入的注解" class="headerlink" title="1.5 负责注入的注解"></a>1.5 负责注入的注解</h2><p> <code>@Component</code> 、<code>@Controller</code> 、<code>@Service</code> 、<code>@Repository</code>  这四个注解是用来声明 Bean 的，声明后这些 Bean 将被实例化。接下来我们看一下，如何给 Bean 的属性赋值。给Bean属性赋值需要用到这些注解：</p>
<p><code>@Value</code> 、<code>@Autowired</code> 、<code>@Qualifier</code> 、<code>@Resource</code></p>
<h3 id="1-5-1-Value"><a href="#1-5-1-Value" class="headerlink" title="1.5.1 @Value"></a>1.5.1 @Value</h3><blockquote>
<p>属性的类型是简单类型，可以使用 @Value 注解进行注入</p>
</blockquote>
<p>a. 创建如下类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="meta">@Value(value = &quot;zhangsan&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="meta">@Value(&quot;20&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>b. 开启包扫描</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">&quot;com.muyoukule.Bean4&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>c. 测试</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testValue</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;spring.xml&quot;</span>);</span><br><span class="line">    <span class="type">Object</span> <span class="variable">user</span> <span class="operator">=</span> applicationContext.getBean(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">    System.out.println(user);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>d. 执行测试程序</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">User(name=zhangsan, age=20)</span><br></pre></td></tr></table></figure>

<p>通过以上代码可以发现，我们并没有给属性提供 <code>setter</code> 方法，但仍然可以完成属性赋值。</p>
<blockquote>
<p>提供 setter 方法，并且在 setter 方法上添加 @Value 注解，也可以完成注入</p>
</blockquote>
<p>a. 修改类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;李四&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;30&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAge</span><span class="params">(<span class="type">int</span> age)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>b. 执行测试程序</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">User(name=李四, age=30)</span><br></pre></td></tr></table></figure>

<p>为了简化代码，以后我们一般不提供 <code>setter</code> 方法，直接在属性上使用 <code>@Value</code> 注解完成属性赋值。</p>
<blockquote>
<p>也能够通过构造方法完成注入</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">User</span><span class="params">(<span class="meta">@Value(&quot;隔壁老王&quot;)</span> String name, <span class="meta">@Value(&quot;33&quot;)</span> <span class="type">int</span> age)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">User(name=隔壁老王, age=33)</span><br></pre></td></tr></table></figure>

<p>通过测试得知：<code>@Value</code> 注解可以出现在属性上、<code>setter</code> 方法上、构造方法的形参上。</p>
<h3 id="1-5-2-Autowired与-Qualifier"><a href="#1-5-2-Autowired与-Qualifier" class="headerlink" title="1.5.2 @Autowired与@Qualifier"></a>1.5.2 @Autowired与@Qualifier</h3><p><code>@Autowired</code> 注解可以用来注入<strong>非简单类型</strong>。被翻译为：自动连线的，或者自动装配。</p>
<p>单独使用 <code>@Autowired</code> 注解，<strong>默认根据类型装配</strong>。【默认是 byType 】</p>
<p>看一下 <code>@Autowired源码</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Target(&#123;ElementType.CONSTRUCTOR, ElementType.METHOD, ElementType.PARAMETER, ElementType.FIELD, ElementType.ANNOTATION_TYPE&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Autowired &#123;</span><br><span class="line">	<span class="type">boolean</span> <span class="title function_">required</span><span class="params">()</span> <span class="keyword">default</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>源码中有两处需要注意：</p>
<ul>
<li><p>第一处：该注解可以标注在哪里？</p>
<ul>
<li>构造方法上</li>
<li>方法上</li>
<li>形参上</li>
<li>属性上</li>
<li>注解上</li>
</ul>
</li>
<li><p>第二处：该注解有一个 <code>required</code> 属性，默认值是 true，表示在注入的时候要求被注入的 Bean 必须是存在的，如果不存在则报错。如果 <code>required</code> 属性设置为 false，表示注入的 Bean 存在或者不存在都没关系，存在的话就注入，不存在的话，也不报错。</p>
</li>
</ul>
<blockquote>
<p>在属性上使用 @Autowired 注解</p>
</blockquote>
<p>a. 创建如下类</p>
<p>UserDao接口</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserDao</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">insert</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>UserDao实现类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Repository</span> <span class="comment">//纳入bean管理</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserDaoForMySQL</span> <span class="keyword">implements</span> <span class="title class_">UserDao</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">insert</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;正在向mysql数据库插入User数据...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>UserService</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span> <span class="comment">// 纳入bean管理</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span> <span class="comment">// 在属性上注入</span></span><br><span class="line">    <span class="keyword">private</span> UserDao userDao;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 没有提供构造方法和setter方法。</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">save</span><span class="params">()</span> &#123;</span><br><span class="line">        userDao.insert();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>b. 配置包扫描</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">&quot;com.muyoukule.Dao,com.muyoukule.Service&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>c. 测试程序</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testAutowired</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;spring.xml&quot;</span>);</span><br><span class="line">    <span class="type">UserService</span> <span class="variable">userService</span> <span class="operator">=</span> applicationContext.getBean(<span class="string">&quot;userService&quot;</span>, UserService.class);</span><br><span class="line">    userService.save();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>d. 结果</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">正在向mysql数据库插入User数据...</span><br></pre></td></tr></table></figure>

<blockquote>
<p>在setter方法使用 @Autowired 注解</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> UserDao userDao;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUserDao</span><span class="params">(UserDao userDao)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.userDao = userDao;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">save</span><span class="params">()</span> &#123;</span><br><span class="line">        userDao.insert();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>在构造方法使用 @Autowired 注解</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> UserDao userDao;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">UserService</span><span class="params">(UserDao userDao)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.userDao = userDao;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">save</span><span class="params">()</span> &#123;</span><br><span class="line">        userDao.insert();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>只在构造方法的形参使用 @Autowired 注解</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> UserDao userDao;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">UserService</span><span class="params">(<span class="meta">@Autowired</span> UserDao userDao)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.userDao = userDao;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">save</span><span class="params">()</span> &#123;</span><br><span class="line">        userDao.insert();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>当有参数的构造方法只有一个时，@Autowired 注解可以省略</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> UserDao userDao;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">UserService</span><span class="params">(UserDao userDao)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.userDao = userDao;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">save</span><span class="params">()</span> &#123;</span><br><span class="line">        userDao.insert();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行结果均为：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">正在向mysql数据库插入User数据...</span><br></pre></td></tr></table></figure>

<blockquote>
<p>如果有多个构造方法，@Autowired 肯定是不能省略的</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> UserDao userDao;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">UserService</span><span class="params">(UserDao userDao)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.userDao = userDao;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">UserService</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">save</span><span class="params">()</span> &#123;</span><br><span class="line">        userDao.insert();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行结果</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/accidence-spring/%E6%9C%89%E5%A4%9A%E4%B8%AA%E6%9E%84%E9%80%A0%E6%96%B9%E6%B3%95%E7%9C%81%E7%95%A5@Autowired.png"></p>
<p>到此为止，我们已经清楚 <code>@Autowired</code> 注解可以出现在哪些位置了。</p>
<p><code>@Autowired</code> 注解默认是 <code>byType</code> 进行注入的，也就是说根据类型注入的，如果以上程序中，UserDao 接口还有另外一个实现类，会出现问题吗？</p>
<p><code>UserDaoForOracle</code> ，接口另一个实现类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Repository</span> <span class="comment">//纳入bean管理</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserDaoForOracle</span> <span class="keyword">implements</span> <span class="title class_">UserDao</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">insert</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;正在向Oracle数据库插入User数据...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行测试，程序报错</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">No qualifying bean of type &#x27;com.muyoukule.Dao.UserDao&#x27; available: expected single matching bean but found 2: userDaoForMySQL,userDaoForOracle</span><br></pre></td></tr></table></figure>

<p>可以通过 <code>byName</code> ，根据名称进行装配解决这个问题。</p>
<p><code>@Autowired</code> 注解和 <code>@Qualifier</code> 注解联合起来才可以根据名称进行装配，在 <code>@Qualifier</code> 注解中指定 Bean 名称</p>
<p>UserDaoForOracle</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Repository</span> <span class="comment">// 这里没有给bean起名，默认名字是：userDaoForOracle</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserDaoForOracle</span> <span class="keyword">implements</span> <span class="title class_">UserDao</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">insert</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;正在向Oracle数据库插入User数据...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>UserService</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> UserDao userDao;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="meta">@Qualifier(&quot;userDaoForOracle&quot;)</span> <span class="comment">// 这个是bean的名字。</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUserDao</span><span class="params">(UserDao userDao)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.userDao = userDao;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">save</span><span class="params">()</span> &#123;</span><br><span class="line">        userDao.insert();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行结果</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">正在向Oracle数据库插入User数据...</span><br></pre></td></tr></table></figure>

<p>总结：</p>
<ul>
<li><code>@Autowired</code> 注解可以出现在：属性上、构造方法上、构造方法的参数上、setter方法上。</li>
<li>当带参数的构造方法只有一个，<code>@Autowired</code> 注解可以省略。</li>
<li><code>@Autowired</code> 注解默认根据类型注入。如果要根据名称注入的话，需要配合 <code>@Qualifier</code> 注解一起使用。</li>
</ul>
<h3 id="1-5-3-Resource"><a href="#1-5-3-Resource" class="headerlink" title="1.5.3 @Resource"></a>1.5.3 @Resource</h3><p><code>@Resource</code> 注解也可以完成非简单类型注入。那它和 <code>@Autowired</code> 注解有什么区别？</p>
<ul>
<li><code>@Resource</code> 注解是 JDK 扩展包中的，也就是说属于 JDK 的一部分。所以该注解是标准注解，更加具有通用性。(JSR-250标准中制定的注解类型。JSR是Java规范提案。)</li>
<li><code>@Autowired</code> 注解是 Spring 框架自己的。</li>
<li><code>@Resource</code> 注解默认根据名称装配 <code>byName</code>，未指定 name 时，使用属性名作为 name。通过 name 找不到的话会自动启动通过类型 <code>byType</code> 装配。</li>
<li><code>@Autowired</code> 注解默认根据类型装配 <code>byType</code>，如果想根据名称装配，需要配合 <code>@Qualifier</code> 注解一起用。</li>
<li><code>@Resource</code> 注解用在属性上、<code>setter</code> 方法上。</li>
<li><code>@Autowired</code> 注解用在属性上、<code>setter</code> 方法上、构造方法上、构造方法参数上。</li>
</ul>
<p><code>@Resource</code> 注解属于 JDK 扩展包，所以不在 JDK 当中，需要额外引入以下依赖：【<strong>如果是JDK8的话不需要额外引入依赖。高于JDK11或低于JDK8需要引入以下依赖。</strong>】</p>
<blockquote>
<p>Spring6+版本</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">  &lt;groupId&gt;jakarta.annotation&lt;/groupId&gt;</span><br><span class="line">  &lt;artifactId&gt;jakarta.annotation-api&lt;/artifactId&gt;</span><br><span class="line">  &lt;version&gt;<span class="number">2.1</span><span class="number">.1</span>&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<p>一定要注意：如果你用 Spring6，要知道 Spring6 不再支持 JavaEE，它支持的是 JakartaEE9。（Oracle 把 JavaEE贡献给 Apache 了，Apache 把 JavaEE 的名字改成 JakartaEE 了，大家之前所接触的所有的  javax.*  包名统一修改为  jakarta.* 包名了。）</p>
<blockquote>
<p>Spring5-版本</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.annotation<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javax.annotation-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>添加依赖，使用 @Resource 注解</p>
</blockquote>
<p>a. 给这个 UserDaoForOracle 起名 xyz</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Repository(&quot;xyz&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserDaoForOracle</span> <span class="keyword">implements</span> <span class="title class_">UserDao</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">insert</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;正在向Oracle数据库插入User数据...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>b. 在UserService中使用 <code>@Resource</code> 注解根据 name 注入</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource(name = &quot;xyz&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> UserDao userDao;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">save</span><span class="params">()</span> &#123;</span><br><span class="line">        userDao.insert();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>c. 执行测试程序</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">正在向Oracle数据库插入User数据...</span><br></pre></td></tr></table></figure>

<blockquote>
<p>当 @Resource 注解使用时没有指定name的时候，还是根据 name 进行查找，这个 name 是属性名</p>
</blockquote>
<p>a. 把 UserDaoForOracle 的名字 xyz 修改为 userDao，让这个 Bean 的名字和 UserService 类中的 UserDao 属性名一致</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Repository(&quot;userDao&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserDaoForOracle</span> <span class="keyword">implements</span> <span class="title class_">UserDao</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">insert</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;正在向Oracle数据库插入User数据...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>b. UserService类中 <code>@Resource</code> 注解并没有指定 name</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> UserDao userDao;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">save</span><span class="params">()</span> &#123;</span><br><span class="line">        userDao.insert();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>c. 执行测试程序</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">正在向Oracle数据库插入User数据...</span><br></pre></td></tr></table></figure>

<p>把 UserService 类中的属性名修改一下</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> UserDao userDao2;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">save</span><span class="params">()</span> &#123;</span><br><span class="line">        userDao2.insert();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行结果，程序报错</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">No qualifying bean of type &#x27;com.muyoukule.Dao.UserDao&#x27; available: expected single matching bean but found 2: userDaoForMySQL,userDao</span><br></pre></td></tr></table></figure>

<p>根据异常信息得知：当通过 name 找不到的时候，自然会启动 <code>byType</code> 进行注入。以上的错误是因为 UserDao 接口下有两个实现类导致的。所以根据类型注入就会报错。</p>
<blockquote>
<p>@Resource 注解可以在 setter 方法上使用</p>
</blockquote>
<p>UserService添加 <code>setter</code> 方法并使用注解标注</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> UserDao userDao;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUserDao</span><span class="params">(UserDao userDao)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.userDao = userDao;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">save</span><span class="params">()</span> &#123;</span><br><span class="line">        userDao.insert();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意这个 <code>setter</code> 方法的方法名，setUserDao 去掉 set 之后，将首字母变小写 userDao，userDao 就是 name</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">正在向Oracle数据库插入User数据...</span><br></pre></td></tr></table></figure>

<p>也可以指定 name </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> UserDao userDao;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource(name = &quot;userDaoForMySQL&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUserDao</span><span class="params">(UserDao userDao)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.userDao = userDao;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">save</span><span class="params">()</span>&#123;</span><br><span class="line">        userDao.insert();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行结果</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">正在向mysql数据库插入User数据...</span><br></pre></td></tr></table></figure>

<p><strong>总结：</strong></p>
<p><code>@Resource</code> 注解：默认 <code>byName</code> 注入，没有指定 name 时把属性名当做 name，根据 name 找不到时，才会 <code>byType</code> 注入。<code>byType</code> 注入时，某种类型的 Bean 只能有一个。</p>
<h2 id="1-6-全注解式开发"><a href="#1-6-全注解式开发" class="headerlink" title="1.6 全注解式开发"></a>1.6 全注解式开发</h2><p>上面已经可以使用注解来配置 bean ,但是依然有用到配置文件，在配置文件中对包进行了扫描，Spring 在3.0版已经支持纯注解开发</p>
<ul>
<li>Spring3.0开启了纯注解开发模式，使用 Java 类替代配置文件，开启了 Spring 快速开发赛道，具体如何实现?</li>
</ul>
<p>所谓的全注解开发就是不再使用 spring 配置文件了。写一个配置类来代替配置文件。</p>
<blockquote>
<p>思路分析</p>
</blockquote>
<p>实现思路为: </p>
<ul>
<li>将配置文件 <code>spring.xml</code> 删除掉，使用类来替换。</li>
</ul>
<blockquote>
<p>实现步骤</p>
</blockquote>
<p>a. 创建一个配置类</p>
<p>创建一个配置类 <code>SpringConfig</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringConfig</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>b. 标识该类为配置类</p>
<p>在配置类上添加 <code>@Configuration</code> 注解，将其标识为一个配置类，替换 <code>spring.xml</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringConfig</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>c. 用注解替换包扫描配置</p>
<p>在配置类上添加包扫描注解 <code>@ComponentScan</code> 替换 <code>&lt;context:component-scan base-package=&quot;&quot;/&gt;</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan(&quot;com.muyoukule&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringConfig</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>d. 编写测试程序：不再 <code>new ClassPathXmlApplicationContext()</code> 对象了</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testNoXml</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnnotationConfigApplicationContext</span>(SpringConfig.class);</span><br><span class="line">    <span class="type">UserService</span> <span class="variable">userService</span> <span class="operator">=</span> applicationContext.getBean(<span class="string">&quot;userService&quot;</span>, UserService.class);</span><br><span class="line">    userService.save();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>e. 执行结果</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">正在向mysql数据库插入User数据...</span><br></pre></td></tr></table></figure>

<p>至此，纯注解开发的方式就已经完成了，主要内容包括：</p>
<ul>
<li><p>Java类替换 Spring 核心配置文件</p>
</li>
<li><p><code>@Configuration</code> 注解用于设定当前类为配置类</p>
</li>
<li><p><code>@ComponentScan</code> 注解用于设定扫描路径，此注解只能添加一次，多个数据请用数组格式</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">@ComponentScan(&#123;&quot;com.muyoukule.service&quot;,&quot;com.muyoukule.dao&quot;&#125;)</span><br></pre></td></tr></table></figure>
</li>
<li><p>读取 Spring 核心配置文件初始化容器对象切换为读取 Java 配置类初始化容器对象</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//加载配置文件初始化容器</span></span><br><span class="line"><span class="type">ApplicationContext</span> <span class="variable">ctx</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;spring.xml&quot;</span>);</span><br><span class="line"><span class="comment">//加载配置类初始化容器</span></span><br><span class="line"><span class="type">ApplicationContext</span> <span class="variable">ctx</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnnotationConfigApplicationContext</span>(SpringConfig.class);</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="1-7-IOC-DI注解开发管理第三方bean"><a href="#1-7-IOC-DI注解开发管理第三方bean" class="headerlink" title="1.7 IOC&#x2F;DI注解开发管理第三方bean"></a>1.7 IOC&#x2F;DI注解开发管理第三方bean</h2><blockquote>
<p>准备环境</p>
</blockquote>
<p>a. 新建spring_009模块</p>
<p>b. <code>pom.xml</code> 添加 Spring 的依赖</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-context<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.3.27<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>c. 添加一个配置类 <code>SpringConfig</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringConfig</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>d. 添加BookDao、BookDaoImpl类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">BookDao</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">save</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BookDaoImpl</span> <span class="keyword">implements</span> <span class="title class_">BookDao</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">save</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;book dao save ...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>e. 创建运行类App</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">App</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">AnnotationConfigApplicationContext</span> <span class="variable">ctx</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnnotationConfigApplicationContext</span>(SpringConfig.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="1-7-1-注解开发管理第三方bean"><a href="#1-7-1-注解开发管理第三方bean" class="headerlink" title="1.7.1 注解开发管理第三方bean"></a>1.7.1 注解开发管理第三方bean</h3><blockquote>
<p>在上述环境中完成对 Druid 数据源的管理</p>
</blockquote>
<p>a. 导入对应的 jar 包</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.15<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>b. 在配置类中添加一个方法</p>
<p>注意该方法的返回值就是要创建的 Bean 对象类型</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringConfig</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> DataSource <span class="title function_">dataSource</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">DruidDataSource</span> <span class="variable">ds</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DruidDataSource</span>();</span><br><span class="line">        ds.setDriverClassName(<span class="string">&quot;com.mysql.jdbc.Driver&quot;</span>);</span><br><span class="line">        ds.setUrl(<span class="string">&quot;jdbc:mysql://localhost:3306/spring_db&quot;</span>);</span><br><span class="line">        ds.setUsername(<span class="string">&quot;root&quot;</span>);</span><br><span class="line">        ds.setPassword(<span class="string">&quot;root&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> ds;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>c. 在方法上添加 <code>@Bean</code> 注解</p>
<p><code>@Bean</code> 注解的作用是将方法的返回值制作为 Spring 管理的一个 bean 对象</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> DataSource <span class="title function_">dataSource</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">DruidDataSource</span> <span class="variable">ds</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DruidDataSource</span>();</span><br><span class="line">        ds.setDriverClassName(<span class="string">&quot;com.mysql.jdbc.Driver&quot;</span>);</span><br><span class="line">        ds.setUrl(<span class="string">&quot;jdbc:mysql://localhost:3306/spring_db&quot;</span>);</span><br><span class="line">        ds.setUsername(<span class="string">&quot;root&quot;</span>);</span><br><span class="line">        ds.setPassword(<span class="string">&quot;root&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> ds;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>**注意：不能使用 <code>DataSource ds = new DruidDataSource()</code>  **，因为 DataSource 接口中没有对应的 <code>setter</code> 方法来设置属性。</p>
<p>d. 从IOC容器中获取对象并打印</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">App</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">AnnotationConfigApplicationContext</span> <span class="variable">ctx</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnnotationConfigApplicationContext</span>(SpringConfig.class);</span><br><span class="line">        <span class="type">DataSource</span> <span class="variable">dataSource</span> <span class="operator">=</span> ctx.getBean(DataSource.class);</span><br><span class="line">        System.out.println(dataSource);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>e. 结果</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	CreateTime:&quot;2023-03-16 15:05:54&quot;,</span><br><span class="line">	ActiveCount:0,</span><br><span class="line">	PoolingCount:0,</span><br><span class="line">	CreateCount:0,</span><br><span class="line">	DestroyCount:0,</span><br><span class="line">	CloseCount:0,</span><br><span class="line">	ConnectCount:0,</span><br><span class="line">	Connections:[</span><br><span class="line">	]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果有多个 bean 要被 Spring 管理，直接在配置类中多些几个方法，方法上添加 <code>@Bean</code> 注解即可。</p>
<h3 id="1-7-2-引入外部配置类"><a href="#1-7-2-引入外部配置类" class="headerlink" title="1.7.2 引入外部配置类"></a>1.7.2 引入外部配置类</h3><p>如果把所有的第三方 bean 都配置到 Spring 的配置类 <code>SpringConfig</code> 中，虽然可以，但是不利于代码阅读和分类管理，所有我们就想能不能按照类别将这些bean配置到不同的配置类中?</p>
<p>对于数据源的bean,我们新建一个 <code>JdbcConfig</code> 配置类，并把数据源配置到该类下。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JdbcConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> DataSource <span class="title function_">dataSource</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">DruidDataSource</span> <span class="variable">ds</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DruidDataSource</span>();</span><br><span class="line">        ds.setDriverClassName(<span class="string">&quot;com.mysql.jdbc.Driver&quot;</span>);</span><br><span class="line">        ds.setUrl(<span class="string">&quot;jdbc:mysql://localhost:3306/spring_db&quot;</span>);</span><br><span class="line">        ds.setUsername(<span class="string">&quot;root&quot;</span>);</span><br><span class="line">        ds.setPassword(<span class="string">&quot;root&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> ds;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在的问题是，这个配置类如何能被 Spring 配置类加载到，并创建 DataSource 对象在 IOC 容器中?</p>
<p>针对这个问题，有两个解决方案:</p>
<ol>
<li>使用包扫描引入</li>
<li>使用 <code>@Import</code> 引入</li>
</ol>
<blockquote>
<p>使用包扫描引入</p>
</blockquote>
<p>a. 在Spring的配置类上添加包扫描</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan(&quot;com.muyoukule.Config&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringConfig</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>b. 在 JdbcConfig 上添加配置注解</p>
<p>JdbcConfig 类要放入到 <code>com.muyoukule.Config</code> 包下，需要被 Spring 的配置类扫描到即可</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JdbcConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> DataSource <span class="title function_">dataSource</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">DruidDataSource</span> <span class="variable">ds</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DruidDataSource</span>();</span><br><span class="line">        ds.setDriverClassName(<span class="string">&quot;com.mysql.jdbc.Driver&quot;</span>);</span><br><span class="line">        ds.setUrl(<span class="string">&quot;jdbc:mysql://localhost:3306/spring_db&quot;</span>);</span><br><span class="line">        ds.setUsername(<span class="string">&quot;root&quot;</span>);</span><br><span class="line">        ds.setPassword(<span class="string">&quot;root&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> ds;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>c. 运行程序</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	CreateTime:&quot;2023-03-16 15:22:46&quot;,</span><br><span class="line">	ActiveCount:0,</span><br><span class="line">	PoolingCount:0,</span><br><span class="line">	CreateCount:0,</span><br><span class="line">	DestroyCount:0,</span><br><span class="line">	CloseCount:0,</span><br><span class="line">	ConnectCount:0,</span><br><span class="line">	Connections:[</span><br><span class="line">	]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这种方式虽然能够扫描到，但是不能很快的知晓都引入了哪些配置类，所有这种方式不推荐使用。</p>
<blockquote>
<p>使用 @Import 引入</p>
</blockquote>
<p>方案一实现起来有点小复杂，Spring 早就想到了这一点，于是又给我们提供了第二种方案。</p>
<p>这种方案可以不用加 <code>@Configuration</code> 注解，但是必须在Spring配置类上使用 <code>@Import</code> 注解手动引入需要加载的配置类</p>
<p>a. 去除JdbcConfig类上的注解</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JdbcConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> DataSource <span class="title function_">dataSource</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">DruidDataSource</span> <span class="variable">ds</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DruidDataSource</span>();</span><br><span class="line">        ds.setDriverClassName(<span class="string">&quot;com.mysql.jdbc.Driver&quot;</span>);</span><br><span class="line">        ds.setUrl(<span class="string">&quot;jdbc:mysql://localhost:3306/spring_db&quot;</span>);</span><br><span class="line">        ds.setUsername(<span class="string">&quot;root&quot;</span>);</span><br><span class="line">        ds.setPassword(<span class="string">&quot;root&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> ds;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>b. 在Spring配置类中引入</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="comment">//@ComponentScan(&quot;com.muyoukule.Config&quot;)</span></span><br><span class="line"><span class="meta">@Import(&#123;JdbcConfig.class&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringConfig</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注意:</strong></p>
<ul>
<li><p>扫描注解可以移除</p>
</li>
<li><p><code>@Import</code> 参数需要的是一个数组，可以引入多个配置类。</p>
</li>
<li><p><code>@Import</code> 注解在配置类中只能写一次，下面的方式是不允许的😥</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="comment">//@ComponentScan(&quot;com.zxq.config&quot;)</span></span><br><span class="line"><span class="meta">@Import(JdbcConfig.class)</span></span><br><span class="line"><span class="meta">@Import(Xxx.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringConfig</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<p>c. 运行程序</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	CreateTime:&quot;2024-03-16 15:27:17&quot;,</span><br><span class="line">	ActiveCount:0,</span><br><span class="line">	PoolingCount:0,</span><br><span class="line">	CreateCount:0,</span><br><span class="line">	DestroyCount:0,</span><br><span class="line">	CloseCount:0,</span><br><span class="line">	ConnectCount:0,</span><br><span class="line">	Connections:[</span><br><span class="line">	]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="1-7-3-注解开发实现为第三方bean注入资源"><a href="#1-7-3-注解开发实现为第三方bean注入资源" class="headerlink" title="1.7.3 注解开发实现为第三方bean注入资源"></a>1.7.3 注解开发实现为第三方bean注入资源</h3><p>在使用 @Bean 创建 bean 对象的时候，如果方法在创建的过程中需要其他资源该怎么办?</p>
<p>这些资源会有两大类，分别是 <code>简单数据类型</code>  和 <code>引用数据类型</code> 。</p>
<h4 id="1-7-3-1-简单数据类型"><a href="#1-7-3-1-简单数据类型" class="headerlink" title="1.7.3.1 简单数据类型"></a>1.7.3.1 简单数据类型</h4><p>对于下面代码关于数据库的四要素不应该写死在代码中，应该是从properties配置文件中读取。如何来优化下面的代码?</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JdbcConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> DataSource <span class="title function_">dataSource</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">DruidDataSource</span> <span class="variable">ds</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DruidDataSource</span>();</span><br><span class="line">        ds.setDriverClassName(<span class="string">&quot;com.mysql.jdbc.Driver&quot;</span>);</span><br><span class="line">        ds.setUrl(<span class="string">&quot;jdbc:mysql://localhost:3306/spring_db&quot;</span>);</span><br><span class="line">        ds.setUsername(<span class="string">&quot;root&quot;</span>);</span><br><span class="line">        ds.setPassword(<span class="string">&quot;root&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> ds;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注入简单数据类型</p>
</blockquote>
<p>a. 类中提供四个属性</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JdbcConfig</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String driver;</span><br><span class="line">    <span class="keyword">private</span> String url;</span><br><span class="line">    <span class="keyword">private</span> String userName;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> DataSource <span class="title function_">dataSource</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">DruidDataSource</span> <span class="variable">ds</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DruidDataSource</span>();</span><br><span class="line">        ds.setDriverClassName(<span class="string">&quot;com.mysql.jdbc.Driver&quot;</span>);</span><br><span class="line">        ds.setUrl(<span class="string">&quot;jdbc:mysql://localhost:3306/spring_db&quot;</span>);</span><br><span class="line">        ds.setUsername(<span class="string">&quot;root&quot;</span>);</span><br><span class="line">        ds.setPassword(<span class="string">&quot;root&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> ds;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>b. 使用 @Value 注解引入值</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JdbcConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Value(&quot;com.mysql.jdbc.Driver&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String driver;</span><br><span class="line">    <span class="meta">@Value(&quot;jdbc:mysql://localhost:3306/spring_db&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String url;</span><br><span class="line">    <span class="meta">@Value(&quot;root&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String userName;</span><br><span class="line">    <span class="meta">@Value(&quot;password&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> DataSource <span class="title function_">dataSource</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">DruidDataSource</span> <span class="variable">ds</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DruidDataSource</span>();</span><br><span class="line">        ds.setDriverClassName(driver);</span><br><span class="line">        ds.setUrl(url);</span><br><span class="line">        ds.setUsername(userName);</span><br><span class="line">        ds.setPassword(password);</span><br><span class="line">        <span class="keyword">return</span> ds;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>扩展</p>
</blockquote>
<p>现在的数据库连接四要素还是写在代码中，需要做的是将这些内容提取到jdbc.properties配置文件，该如何实现?</p>
<ol>
<li><p>resources目录下添加 <code>jdbc.properties</code> </p>
</li>
<li><p>配置文件中提供四个键值对分别是数据库的四要素</p>
</li>
<li><p>使用 <code>@PropertySource</code> 加载 jdbc.properties 配置文件</p>
</li>
<li><p>修改 <code>@Value</code> 注解属性的值，将其修改为<code>$&#123;key&#125;</code>，key 就是键值对中的键的值</p>
</li>
</ol>
<h4 id="1-7-3-2-引用数据类型"><a href="#1-7-3-2-引用数据类型" class="headerlink" title="1.7.3.2 引用数据类型"></a>1.7.3.2 引用数据类型</h4><p>假设在构建 DataSource 对象的时候，需要用到 BookDao 对象，该如何把 BookDao 对象注入进方法内让其使用呢?</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JdbcConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> DataSource <span class="title function_">dataSource</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">DruidDataSource</span> <span class="variable">ds</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DruidDataSource</span>();</span><br><span class="line">        ds.setDriverClassName(<span class="string">&quot;com.mysql.jdbc.Driver&quot;</span>);</span><br><span class="line">        ds.setUrl(<span class="string">&quot;jdbc:mysql://localhost:3306/spring_db&quot;</span>);</span><br><span class="line">        ds.setUsername(<span class="string">&quot;root&quot;</span>);</span><br><span class="line">        ds.setPassword(<span class="string">&quot;root&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> ds;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注入引用数据类型</p>
</blockquote>
<p>a. 在 SpringConfig 中扫描 BookDao</p>
<p>扫描的目的是让 Spring 能管理到 BookDao ,也就是说要让 IOC 容器中有一个 bookDao 对象</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan(&quot;com.muyoukule.Dao&quot;)</span></span><br><span class="line"><span class="meta">@Import(&#123;JdbcConfig.class&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringConfig</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>b. 在 JdbcConfig 类的方法上添加参数</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JdbcConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> DataSource <span class="title function_">dataSource</span><span class="params">(BookDao bookDao)</span> &#123;</span><br><span class="line">        System.out.println(bookDao);</span><br><span class="line">        <span class="type">DruidDataSource</span> <span class="variable">ds</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DruidDataSource</span>();</span><br><span class="line">        ds.setDriverClassName(<span class="string">&quot;com.mysql.jdbc.Driver&quot;</span>);</span><br><span class="line">        ds.setUrl(<span class="string">&quot;jdbc:mysql://localhost:3306/spring_db&quot;</span>);</span><br><span class="line">        ds.setUsername(<span class="string">&quot;root&quot;</span>);</span><br><span class="line">        ds.setPassword(<span class="string">&quot;root&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> ds;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>引用类型注入只需要为bean定义方法设置形参即可，容器会根据类型 <code>byType</code> 自动装配对象。</p>
<p>c. 运行程序</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">com.muyoukule.Dao.BookDaoImpl@6572421</span><br><span class="line">&#123;</span><br><span class="line">	CreateTime:&quot;2023-03-16 15:38:04&quot;,</span><br><span class="line">	ActiveCount:0,</span><br><span class="line">	PoolingCount:0,</span><br><span class="line">	CreateCount:0,</span><br><span class="line">	DestroyCount:0,</span><br><span class="line">	CloseCount:0,</span><br><span class="line">	ConnectCount:0,</span><br><span class="line">	Connections:[</span><br><span class="line">	]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="2-面向切面编程AOP"><a href="#2-面向切面编程AOP" class="headerlink" title="2. 面向切面编程AOP"></a>2. 面向切面编程AOP</h1><p>IoC使软件组件松耦合。AOP让你能够捕捉系统中经常使用的功能，把它转化成组件。</p>
<p>AOP（Aspect Oriented Programming）：面向切面编程，面向方面编程。（AOP是一种编程技术）</p>
<p>AOP 是对OOP的补充延伸。</p>
<p>AOP 底层使用的就是动态代理来实现的。</p>
<p>Spring 的 AOP 使用的动态代理是：JDK 动态代理 + CGLIB 动态代理技术。Spring 在这两种动态代理中灵活切换，如果是代理接口，会默认使用 JDK 动态代理，如果要代理某个类，这个类没有实现接口，就会切换使用 CGLIB。当然，你也可以强制通过一些配置让 Spring 只使用 CGLIB。</p>
<h2 id="2-1-AOP介绍"><a href="#2-1-AOP介绍" class="headerlink" title="2.1 AOP介绍"></a>2.1 AOP介绍</h2><p>一般一个系统当中都会有一些系统服务，例如：日志、事务管理、安全等。这些系统服务被称为：<strong>交叉业务</strong></p>
<p>这些<strong>交叉业务</strong>几乎是通用的，不管你是做银行账户转账，还是删除用户数据。日志、事务管理、安全，这些都是需要做的。</p>
<p>如果在每一个业务处理过程当中，都掺杂这些交叉业务代码进去的话，存在两方面问题：</p>
<ol>
<li>交叉业务代码在多个业务流程中反复出现，显然这个交叉业务代码没有得到复用。并且修改这些交叉业务代码的话，需要修改多处。</li>
<li>程序员无法专注核心业务代码的编写，在编写核心业务代码的同时还需要处理这些交叉业务。</li>
</ol>
<p>使用AOP可以很轻松的解决以上问题。</p>
<p>请看下图，可以帮助你快速理解AOP的思想：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/accidence-spring/%E7%90%86%E8%A7%A3AOP%E7%9A%84%E6%80%9D%E6%83%B3.png" style="zoom:67%;">

<p><strong>用一句话总结AOP：将与核心业务无关的代码独立的抽取出来，形成一个独立的组件，然后以横向交叉的方式应用到业务流程当中的过程被称为AOP。</strong></p>
<p>AOP的优点：</p>
<ul>
<li>代码复用性增强。</li>
<li>代码易维护。</li>
<li>使开发者更关注业务逻辑。</li>
</ul>
<h2 id="2-2-AOP的七大术语"><a href="#2-2-AOP的七大术语" class="headerlink" title="2.2 AOP的七大术语"></a>2.2 AOP的七大术语</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">do1</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;do 1&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">do2</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;do 2&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">do3</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;do 3&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">do4</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;do 4&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">do5</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;do 5&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 核心业务方法</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">service</span><span class="params">()</span> &#123;</span><br><span class="line">        do1();</span><br><span class="line">        do2();</span><br><span class="line">        do3();</span><br><span class="line">        do5();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>连接点 Joinpoint</p>
<ul>
<li>在程序的整个执行流程中，可以织入切面的位置。方法的执行前后，异常抛出之后等位置。</li>
</ul>
</li>
<li><p>切点 Pointcut</p>
<ul>
<li>在程序执行流程中，真正织入切面的方法。（一个切点对应多个连接点）</li>
</ul>
</li>
<li><p>通知 Advice</p>
<ul>
<li><p>通知又叫增强，就是具体你要织入的代码。</p>
</li>
<li><p>通知包括：</p>
<ul>
<li>前置通知</li>
<li>后置通知</li>
<li>环绕通知</li>
<li>异常通知</li>
<li>最终通知</li>
</ul>
</li>
</ul>
</li>
<li><p>切面 Aspect</p>
<ul>
<li>切点 + 通知就是切面。</li>
</ul>
</li>
<li><p>织入 Weaving</p>
<ul>
<li>把通知应用到目标对象上的过程。</li>
</ul>
</li>
<li><p>代理对象 Proxy</p>
<ul>
<li>一个目标对象被织入通知后产生的新对象。</li>
</ul>
</li>
<li><p>目标对象 Target</p>
<ul>
<li>被织入通知的对象。</li>
</ul>
</li>
</ul>
<p>通过下图，大家可以很好的理解AOP的相关术语：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/accidence-spring/%E7%90%86%E8%A7%A3AOP%E7%9A%84%E7%9B%B8%E5%85%B3%E6%9C%AF%E8%AF%AD.png"></p>
<h2 id="2-3-切点表达式"><a href="#2-3-切点表达式" class="headerlink" title="2.3 切点表达式"></a>2.3 切点表达式</h2><p>切点表达式用来定义通知（Advice）往哪些方法上切入。</p>
<p>切入点表达式语法格式：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">execution([访问控制权限修饰符] 返回值类型 [全限定类名]方法名(形式参数列表) [异常])</span><br></pre></td></tr></table></figure>

<p>访问控制权限修饰符：</p>
<ul>
<li>可选项。</li>
<li>没写，就是4个权限都包括。</li>
<li>写 public 就表示只包括公开的方法。</li>
</ul>
<p>返回值类型：</p>
<ul>
<li>必填项。</li>
<li>* 表示返回值类型任意。</li>
</ul>
<p>全限定类名：</p>
<ul>
<li>可选项。</li>
<li>两个点“..”代表当前包以及子包下的所有类。</li>
<li>省略时表示所有的类。</li>
</ul>
<p>方法名：</p>
<ul>
<li>必填项。</li>
<li>*表示所有方法。</li>
<li>set*表示所有的set方法。</li>
</ul>
<p>形式参数列表：</p>
<ul>
<li><p>必填项</p>
</li>
<li><p>() 表示没有参数的方法</p>
</li>
<li><p>(..) 参数类型和个数随意的方法</p>
</li>
<li><p>(*) 只有一个参数的方法</p>
</li>
<li><p>(*, String) 第一个参数类型随意，第二个参数是String的。</p>
</li>
</ul>
<p>异常：</p>
<ul>
<li>可选项。</li>
<li>省略时表示任意异常类型。</li>
</ul>
<p>理解以下的切点表达式：</p>
<p>Service包下所有的类中以 delete 开始的所有方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">execution(<span class="keyword">public</span> * com.muyoukule.Service.*.delete*(..))</span><br></pre></td></tr></table></figure>

<p>Mall包下所有的类的所有的方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">execution(* com.muyoukule.Mall..*(..))</span><br></pre></td></tr></table></figure>

<p>所有类的所有方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">execution(* *(..))</span><br></pre></td></tr></table></figure>

<h2 id="2-4-使用Spring的AOP"><a href="#2-4-使用Spring的AOP" class="headerlink" title="2.4 使用Spring的AOP"></a>2.4 使用Spring的AOP</h2><p>Spring对AOP的实现包括以下3种方式：</p>
<ul>
<li><strong>第一种方式：Spring框架结合AspectJ框架实现的AOP，基于注解方式。</strong></li>
<li><strong>第二种方式：Spring框架结合AspectJ框架实现的AOP，基于XML方式。</strong></li>
<li>第三种方式：Spring框架自己实现的AOP，基于XML配置方式。</li>
</ul>
<p>实际开发中，都是 Spring+AspectJ 来实现 AOP。所以我们重点学习第一种和第二种方式。</p>
<p>什么是AspectJ？（Eclipse组织的一个支持AOP的框架。AspectJ框架是独立于Spring框架之外的一个框架，Spring框架用了AspectJ） </p>
<blockquote>
<p>环境准备</p>
</blockquote>
<p>a. 使用Spring+AspectJ的AOP需要引入的依赖，由于在<code>spring-context</code>中已经包含了<code>spring aop</code>依赖，所以只需引入以下依赖：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/accidence-spring/aop%E7%9A%84%E4%BE%9D%E8%B5%96.png"></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--spring context依赖--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-context<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.3.27<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--spring aspects依赖--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-aspects<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.3.27<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--junit--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.13.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>b. Spring配置文件 <code>spring.xml</code> 中添加 <code>context</code> 命名空间和 <code>aop</code> 命名空间</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:aop</span>=<span class="string">&quot;http://www.springframework.org/schema/aop&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">                           http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">                           http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="2-4-1-基于AspectJ的AOP注解式开发"><a href="#2-4-1-基于AspectJ的AOP注解式开发" class="headerlink" title="2.4.1 基于AspectJ的AOP注解式开发"></a>2.4.1 基于AspectJ的AOP注解式开发</h3><blockquote>
<p>实现步骤</p>
</blockquote>
<p>a. 定义目标类以及目标方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 目标类</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderService</span> &#123;</span><br><span class="line">    <span class="comment">// 目标方法</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">generate</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;订单已生成！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>b. 定义切面类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 切面类</span></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyAspect</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>c. 目标类和切面类都纳入spring bean管理</p>
<ul>
<li><p>在目标类 OrderService 上添加 <code>@Service</code> 注解。</p>
</li>
<li><p>在切面类 MyAspect 类上添加 <code>@Component</code> 注解。</p>
</li>
</ul>
<p>d. 在spring配置文件中添加组建扫描</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--开启组件扫描--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">&quot;com.muyoukule.Service,com.muyoukule.Aspect&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>e. 在切面类中添加通知</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 切面类</span></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyAspect</span> &#123;</span><br><span class="line">    <span class="comment">// 这就是需要增强的代码（通知）</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">advice</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;我是一个通知&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>f. 在通知上添加切点表达式（通知+切点&#x3D;切面）</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 切面类</span></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyAspect</span> &#123;</span><br><span class="line">    <span class="comment">// 切点表达式</span></span><br><span class="line">    <span class="meta">@Before(&quot;execution(* com.muyoukule.Service.OrderService.*(..))&quot;)</span></span><br><span class="line">    <span class="comment">// 这就是需要增强的代码（通知）</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">advice</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;我是一个通知&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>PS：注解 <code>@Before</code> 表示前置通知。</strong></p>
<p>g. 在 spring 配置文件中启用自动代理</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--开启组件扫描--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">&quot;com.muyoukule.Service&quot;</span>/&gt;</span></span><br><span class="line"><span class="comment">&lt;!--开启自动代理--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">aop:aspectj-autoproxy</span> <span class="attr">proxy-target-class</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>&lt;aop:aspectj-autoproxy  proxy-target-class=&quot;true&quot;/&gt;</code>  开启自动代理之后，凡是带有 <code>@Aspect</code> 注解的 bean 都会生成代理对象。</p>
<p><code>proxy-target-class=&quot;true&quot;</code> 表示采用cglib动态代理。</p>
<p><code>proxy-target-class=&quot;false&quot;</code> 表示采用 jdk 动态代理。默认值是 false。即使写成 false，当没有接口的时候，也会自动选择 cglib 生成代理类。</p>
<p>h. 测试程序</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testAOP</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;spring.xml&quot;</span>);</span><br><span class="line">    <span class="type">OrderService</span> <span class="variable">orderService</span> <span class="operator">=</span> applicationContext.getBean(<span class="string">&quot;orderService&quot;</span>, OrderService.class);</span><br><span class="line">    orderService.generate();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>i. 运行结果：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">我是一个通知</span><br><span class="line">订单已生成！</span><br></pre></td></tr></table></figure>

<blockquote>
<p>通知类型</p>
</blockquote>
<p>通知类型包括：</p>
<ul>
<li>前置通知：<code>@Before</code> 目标方法执行之前的通知</li>
<li>后置通知：<code>@AfterReturning</code> 目标方法执行之后的通知</li>
<li>环绕通知：<code>@Around</code> 目标方法之前添加通知，同时目标方法执行之后添加通知。</li>
<li>异常通知：<code>@AfterThrowing</code> 发生异常之后执行的通知</li>
<li>最终通知：<code>@After</code> 放在 finally 语句块中的通知</li>
</ul>
<p>接下来，改写程序来测试这几个通知的执行顺序</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 切面类</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyAspect</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Around(&quot;execution(* com.muyoukule.Service.OrderService.*(..))&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">aroundAdvice</span><span class="params">(ProceedingJoinPoint proceedingJoinPoint)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;环绕通知开始&quot;</span>);</span><br><span class="line">        <span class="comment">// 执行目标方法。</span></span><br><span class="line">        proceedingJoinPoint.proceed();</span><br><span class="line">        System.out.println(<span class="string">&quot;环绕通知结束&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before(&quot;execution(* com.muyoukule.Service.OrderService.*(..))&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">beforeAdvice</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;前置通知&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AfterReturning(&quot;execution(* com.muyoukule.Service.OrderService.*(..))&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterReturningAdvice</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;后置通知&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AfterThrowing(&quot;execution(* com.muyoukule.Service.OrderService.*(..))&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterThrowingAdvice</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;异常通知&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@After(&quot;execution(* com.muyoukule.Service.OrderService.*(..))&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterAdvice</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;最终通知&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行测试，结果</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">环绕通知开始</span><br><span class="line">前置通知</span><br><span class="line">订单已生成！</span><br><span class="line">后置通知</span><br><span class="line">最终通知</span><br><span class="line">环绕通知结束</span><br></pre></td></tr></table></figure>

<p>结果中没有异常通知，这是因为目标程序执行过程中没有发生异常。</p>
<p>尝试让目标方法发生异常</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 目标类</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderService</span> &#123;</span><br><span class="line">    <span class="comment">// 目标方法</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">generate</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;订单已生成！&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="number">1</span> == <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;模拟异常发生&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>再次执行测试程序</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">环绕通知开始</span><br><span class="line">前置通知</span><br><span class="line">订单已生成！</span><br><span class="line">异常通知</span><br><span class="line">最终通知</span><br><span class="line"></span><br><span class="line">java.lang.RuntimeException: 模拟异常发生</span><br><span class="line"></span><br><span class="line">    // --snip--</span><br></pre></td></tr></table></figure>

<p>通过测试得知，当发生异常之后，最终通知也会执行，因为最终通知 <code>@After</code> 会出现在 finally 语句块中。出现异常之后，后置通知和环绕通知的结束部分不会执行。</p>
<blockquote>
<p>切面的先后顺序</p>
</blockquote>
<p>我们知道，业务流程当中不一定只有一个切面，可能有的切面控制事务，有的记录日志，有的进行安全控制，如果多个切面的话，顺序如何控制：可以使用 <code>@Order</code> 注解来标识切面类，为 <code>@Order</code> 注解的 value 指定一个整数型的数字，数字越小，优先级越高。</p>
<p>a. 再定义一个切面类，并设置优先级</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Order(1)</span> <span class="comment">//设置优先级</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">YourAspect</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Around(&quot;execution(* com.muyoukule.Service.OrderService.*(..))&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">aroundAdvice</span><span class="params">(ProceedingJoinPoint proceedingJoinPoint)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;YourAspect环绕通知开始&quot;</span>);</span><br><span class="line">        <span class="comment">// 执行目标方法。</span></span><br><span class="line">        proceedingJoinPoint.proceed();</span><br><span class="line">        System.out.println(<span class="string">&quot;YourAspect环绕通知结束&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before(&quot;execution(* com.muyoukule.Service.OrderService.*(..))&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">beforeAdvice</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;YourAspect前置通知&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AfterReturning(&quot;execution(* com.muyoukule.Service.OrderService.*(..))&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterReturningAdvice</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;YourAspect后置通知&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AfterThrowing(&quot;execution(* com.muyoukule.Service.OrderService.*(..))&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterThrowingAdvice</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;YourAspect异常通知&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@After(&quot;execution(* com.muyoukule.Service.OrderService.*(..))&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterAdvice</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;YourAspect最终通知&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>b. 设置切面类 MyAspect 的优先级</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 切面类</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Order(2)</span> <span class="comment">//设置优先级</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyAspect</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// --snip--</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>c. 执行测试程序</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">YourAspect环绕通知开始</span><br><span class="line">YourAspect前置通知</span><br><span class="line">环绕通知开始</span><br><span class="line">前置通知</span><br><span class="line">订单已生成！</span><br><span class="line">后置通知</span><br><span class="line">最终通知</span><br><span class="line">环绕通知结束</span><br><span class="line">YourAspect后置通知</span><br><span class="line">YourAspect最终通知</span><br><span class="line">YourAspect环绕通知结束</span><br></pre></td></tr></table></figure>

<p>通过修改 <code>@Order</code> 注解的整数值来切换顺序，执行测试程序：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">环绕通知开始</span><br><span class="line">前置通知</span><br><span class="line">YourAspect环绕通知开始</span><br><span class="line">YourAspect前置通知</span><br><span class="line">订单已生成！</span><br><span class="line">YourAspect后置通知</span><br><span class="line">YourAspect最终通知</span><br><span class="line">YourAspect环绕通知结束</span><br><span class="line">后置通知</span><br><span class="line">最终通知</span><br><span class="line">环绕通知结束</span><br></pre></td></tr></table></figure>

<blockquote>
<p>优化使用切点表达式</p>
</blockquote>
<p>观看刚才代码中的切点表达式，缺点是：</p>
<ul>
<li>切点表达式重复写了多次，没有得到复用。</li>
<li>如果要修改切点表达式，需要修改多处，难维护。</li>
</ul>
<p>可以这样做：将切点表达式单独的定义出来，在需要的位置引入即可。如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 切面类</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Order(2)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyAspect</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 定义通用的切点表达式</span></span><br><span class="line">    <span class="meta">@Pointcut(&quot;execution(* com.muyoukule.Service..*(..))&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">pointcut</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 这个方法只是一个标记，方法名随意，方法体中也不需要写任何代码。</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Around(&quot;pointcut()&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">aroundAdvice</span><span class="params">(ProceedingJoinPoint proceedingJoinPoint)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;环绕通知开始&quot;</span>);</span><br><span class="line">        <span class="comment">// 执行目标方法。</span></span><br><span class="line">        proceedingJoinPoint.proceed();</span><br><span class="line">        System.out.println(<span class="string">&quot;环绕通知结束&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before(&quot;pointcut()&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">beforeAdvice</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;前置通知&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// --snip--</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用 <code>@Pointcut</code> 注解来定义独立的切点表达式。注意这个 <code>@Pointcut</code> 注解标注的方法随意，只是起到一个能够让 <code>@Pointcut</code> 注解编写的位置。</p>
<p>运行测试</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">环绕通知开始</span><br><span class="line">前置通知</span><br><span class="line">订单已生成！</span><br><span class="line">后置通知</span><br><span class="line">最终通知</span><br><span class="line">环绕通知结束</span><br></pre></td></tr></table></figure>

<blockquote>
<p>全注解式开发AOP</p>
</blockquote>
<p>就是编写一个类，在这个类上面使用大量注解来代替 spring 的配置文件，spring 配置文件消失了，如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan(&#123;&quot;com.muyoukule.Service&quot;, &quot;com.muyoukule.Aspect&quot;&#125;)</span></span><br><span class="line"><span class="meta">@EnableAspectJAutoProxy(proxyTargetClass = true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringConfig</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>@EnableAspectJAutoProxy(proxyTargetClass = true)</code> 或者 <code>@EnableAspectJAutoProxy</code> 开启注解格式AOP功能。</li>
<li><code>proxyTargetClass = true</code> 表示采用 cglib 动态代理。</li>
</ul>
<p>测试程序也变化了</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testAOPWithAllAnnotation</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnnotationConfigApplicationContext</span>(SpringConfig.class);</span><br><span class="line">    <span class="type">OrderService</span> <span class="variable">orderService</span> <span class="operator">=</span> applicationContext.getBean(<span class="string">&quot;orderService&quot;</span>, OrderService.class);</span><br><span class="line">    orderService.generate();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-4-2-基于XML配置方式的AOP（了解）"><a href="#2-4-2-基于XML配置方式的AOP（了解）" class="headerlink" title="2.4.2 基于XML配置方式的AOP（了解）"></a>2.4.2 基于XML配置方式的AOP（了解）</h3><p>a. 编写目标类（不添加注解）</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 目标类</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VipService</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">add</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;保存vip信息...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>b. 编写切面类，并且编写通知（不添加 <code>@Component</code> 注解）</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 负责计时的切面类</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TimerAspect</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">time</span><span class="params">(ProceedingJoinPoint proceedingJoinPoint)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">begin</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="comment">//执行目标</span></span><br><span class="line">        proceedingJoinPoint.proceed();</span><br><span class="line">        <span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        System.out.println(<span class="string">&quot;耗时&quot;</span> + (end - begin) + <span class="string">&quot;毫秒&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>c. 编写 <code>spring.xml</code> 配置文件</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:aop</span>=<span class="string">&quot;http://www.springframework.org/schema/aop&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd                       </span></span></span><br><span class="line"><span class="string"><span class="tag">                           http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--纳入spring bean管理--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;vipService&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.muyoukule.Service.VipService&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;timerAspect&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.muyoukule.Aspect.TimerAspect&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--aop配置--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">aop:config</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--切点表达式--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">aop:pointcut</span> <span class="attr">id</span>=<span class="string">&quot;p&quot;</span> <span class="attr">expression</span>=<span class="string">&quot;execution(* com.muyoukule.Service.VipService.*(..))&quot;</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--切面--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">aop:aspect</span> <span class="attr">ref</span>=<span class="string">&quot;timerAspect&quot;</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--切面=通知 + 切点--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">aop:around</span> <span class="attr">method</span>=<span class="string">&quot;time&quot;</span> <span class="attr">pointcut-ref</span>=<span class="string">&quot;p&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">aop:aspect</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">aop:config</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>d. 测试程序</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testAOPXml</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;spring.xml&quot;</span>);</span><br><span class="line">    <span class="type">VipService</span> <span class="variable">vipService</span> <span class="operator">=</span> applicationContext.getBean(<span class="string">&quot;vipService&quot;</span>, VipService.class);</span><br><span class="line">    vipService.add();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>e. 结果</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">保存vip信息...</span><br><span class="line">耗时9毫秒</span><br></pre></td></tr></table></figure>

<h2 id="2-5-AOP的实际案例：事务处理"><a href="#2-5-AOP的实际案例：事务处理" class="headerlink" title="2.5 AOP的实际案例：事务处理"></a>2.5 AOP的实际案例：事务处理</h2><p>项目中的事务控制是在所难免的。在一个业务流程当中，可能需要多条 DML 语句共同完成，为了保证数据的安全，这多条 DML 语句要么同时成功，要么同时失败。这就需要添加事务控制的代码。例如以下伪代码：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">class 业务类<span class="number">1</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> 业务方法<span class="number">1</span>()&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="comment">// 开启事务</span></span><br><span class="line">            startTransaction();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 执行核心业务逻辑</span></span><br><span class="line">            step1();</span><br><span class="line">            step2();</span><br><span class="line">            step3();</span><br><span class="line">            ....</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 提交事务</span></span><br><span class="line">            commitTransaction();</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">            <span class="comment">// 回滚事务</span></span><br><span class="line">            rollbackTransaction();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> 业务方法<span class="number">2</span>()&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="comment">// 开启事务</span></span><br><span class="line">            startTransaction();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 执行核心业务逻辑</span></span><br><span class="line">            step1();</span><br><span class="line">            step2();</span><br><span class="line">            step3();</span><br><span class="line">            ....</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 提交事务</span></span><br><span class="line">            commitTransaction();</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">            <span class="comment">// 回滚事务</span></span><br><span class="line">            rollbackTransaction();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> 业务方法<span class="number">3</span>()&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="comment">// 开启事务</span></span><br><span class="line">            startTransaction();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 执行核心业务逻辑</span></span><br><span class="line">            step1();</span><br><span class="line">            step2();</span><br><span class="line">            step3();</span><br><span class="line">            ....</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 提交事务</span></span><br><span class="line">            commitTransaction();</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">            <span class="comment">// 回滚事务</span></span><br><span class="line">            rollbackTransaction();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class 业务类<span class="number">2</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> 业务方法<span class="number">1</span>()&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="comment">// 开启事务</span></span><br><span class="line">            startTransaction();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 执行核心业务逻辑</span></span><br><span class="line">            step1();</span><br><span class="line">            step2();</span><br><span class="line">            step3();</span><br><span class="line">            ....</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 提交事务</span></span><br><span class="line">            commitTransaction();</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">            <span class="comment">// 回滚事务</span></span><br><span class="line">            rollbackTransaction();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> 业务方法<span class="number">2</span>()&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="comment">// 开启事务</span></span><br><span class="line">            startTransaction();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 执行核心业务逻辑</span></span><br><span class="line">            step1();</span><br><span class="line">            step2();</span><br><span class="line">            step3();</span><br><span class="line">            ....</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 提交事务</span></span><br><span class="line">            commitTransaction();</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">            <span class="comment">// 回滚事务</span></span><br><span class="line">            rollbackTransaction();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> 业务方法<span class="number">3</span>()&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="comment">// 开启事务</span></span><br><span class="line">            startTransaction();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 执行核心业务逻辑</span></span><br><span class="line">            step1();</span><br><span class="line">            step2();</span><br><span class="line">            step3();</span><br><span class="line">            ....</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 提交事务</span></span><br><span class="line">            commitTransaction();</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">            <span class="comment">// 回滚事务</span></span><br><span class="line">            rollbackTransaction();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//......</span></span><br></pre></td></tr></table></figure>

<p>可以看到，这些业务类中的每一个业务方法都是需要控制事务的，而控制事务的代码又是固定的格式，都是：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line">    <span class="comment">// 开启事务</span></span><br><span class="line">    startTransaction();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 执行核心业务逻辑</span></span><br><span class="line">    <span class="comment">//......</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 提交事务</span></span><br><span class="line">    commitTransaction();</span><br><span class="line">&#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">    <span class="comment">// 回滚事务</span></span><br><span class="line">    rollbackTransaction();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个控制事务的代码就是和业务逻辑没有关系的 “<strong>交叉业务</strong>” 。以上伪代码当中可以看到这些交叉业务的代码没有得到复用，并且如果这些交叉业务代码需要修改，那必然需要修改多处，难维护，怎么解决？可以采用 AOP 思想解决。可以把以上控制事务的代码作为环绕通知，切入到目标类的方法当中。</p>
<p>a. 有两个业务类，如下</p>
<p>银行账户的业务类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="comment">// 业务类</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AccountService</span> &#123;</span><br><span class="line">    <span class="comment">// 转账业务方法</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transfer</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;正在进行银行账户转账...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 取款业务方法</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">withdraw</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;正在进行取款操作...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>订单业务类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="comment">// 业务类</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderService</span> &#123;</span><br><span class="line">    <span class="comment">// 生成订单</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">generate</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;正在生成订单...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 取消订单</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">cancel</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;正在取消订单...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意，以上两个业务类已经纳入spring bean的管理，因为都添加了 <code>@Service</code> 注解。</p>
<p>给以上两个业务类的4个方法添加事务控制代码，使用 AOP 来完成：</p>
<p>b. 事务切面类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="comment">// 事务切面类</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TransactionAspect</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Around(&quot;execution(* com.muyoukule.Service..*(..))&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">aroundAdvice</span><span class="params">(ProceedingJoinPoint proceedingJoinPoint)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;开启事务&quot;</span>);</span><br><span class="line">            <span class="comment">// 执行目标</span></span><br><span class="line">            proceedingJoinPoint.proceed();</span><br><span class="line">            System.out.println(<span class="string">&quot;提交事务&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;回滚事务&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>c. 编写配置类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan(&#123;&quot;com.muyoukule.Service&quot;, &quot;com.muyoukule.Aspect&quot;&#125;)</span></span><br><span class="line"><span class="meta">@EnableAspectJAutoProxy(proxyTargetClass = true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringConfig</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个事务控制代码只需要写一次就行了，并且修改起来也没有成本。</p>
<p>d. 编写测试程序：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testTransaction</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnnotationConfigApplicationContext</span>(SpringConfig.class);</span><br><span class="line">    <span class="type">OrderService</span> <span class="variable">orderService</span> <span class="operator">=</span> applicationContext.getBean(<span class="string">&quot;orderService&quot;</span>, OrderService.class);</span><br><span class="line">    <span class="type">AccountService</span> <span class="variable">accountService</span> <span class="operator">=</span> applicationContext.getBean(<span class="string">&quot;accountService&quot;</span>, AccountService.class);</span><br><span class="line">    <span class="comment">// 生成订单</span></span><br><span class="line">    orderService.generate();</span><br><span class="line">    <span class="comment">// 取消订单</span></span><br><span class="line">    orderService.cancel();</span><br><span class="line">    <span class="comment">// 转账</span></span><br><span class="line">    accountService.transfer();</span><br><span class="line">    <span class="comment">// 取款</span></span><br><span class="line">    accountService.withdraw();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>e. 运行结果</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">开启事务</span><br><span class="line">正在生成订单...</span><br><span class="line">提交事务</span><br><span class="line">开启事务</span><br><span class="line">正在取消订单...</span><br><span class="line">提交事务</span><br><span class="line">开启事务</span><br><span class="line">正在进行银行账户转账...</span><br><span class="line">提交事务</span><br><span class="line">开启事务</span><br><span class="line">正在进行取款操作...</span><br><span class="line">提交事务</span><br></pre></td></tr></table></figure>

<h2 id="2-6-AOP的实际案例：安全日志"><a href="#2-6-AOP的实际案例：安全日志" class="headerlink" title="2.6 AOP的实际案例：安全日志"></a>2.6 AOP的实际案例：安全日志</h2><p>需求是这样的：项目开发结束了，已经上线了。运行正常。客户提出了新的需求：凡事在系统中进行修改操作的，删除操作的，新增操作的，都要把这个人记录下来。因为这几个操作是属于危险行为。例如有业务类和业务方法：</p>
<p>用户业务类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="comment">//用户业务</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getUser</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;获取用户信息...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveUser</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;保存用户...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deleteUser</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;删除用户...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">modifyUser</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;修改用户...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>商品业务类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 商品业务类</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProductService</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getProduct</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;获取商品信息....&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveProduct</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;保存商品....&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deleteProduct</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;删除商品....&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">modifyProduct</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;修改商品....&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来我们使用aop来解决上面的需求：编写一个负责安全的切面类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityAspect</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Pointcut(&quot;execution(* com.muyoukule.Service..save*(..))&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">savePointcut</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Pointcut(&quot;execution(* com.muyoukule.Service..delete*(..))&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deletePointcut</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Pointcut(&quot;execution(* com.muyoukule.Service..modify*(..))&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">modifyPointcut</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before(&quot;savePointcut() || deletePointcut() || modifyPointcut()&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">beforeAdivce</span><span class="params">(JoinPoint joinpoint)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;XXX操作员正在操作&quot;</span> + joinpoint.getSignature().getName() + <span class="string">&quot;方法&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试程序</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSecurity</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnnotationConfigApplicationContext</span>(SpringConfig.class);</span><br><span class="line">    <span class="type">UserService</span> <span class="variable">userService</span> <span class="operator">=</span> applicationContext.getBean(<span class="string">&quot;userService&quot;</span>, UserService.class);</span><br><span class="line">    <span class="type">ProductService</span> <span class="variable">productService</span> <span class="operator">=</span> applicationContext.getBean(<span class="string">&quot;productService&quot;</span>, ProductService.class);</span><br><span class="line">    userService.getUser();</span><br><span class="line">    userService.saveUser();</span><br><span class="line">    userService.deleteUser();</span><br><span class="line">    userService.modifyUser();</span><br><span class="line">    productService.getProduct();</span><br><span class="line">    productService.saveProduct();</span><br><span class="line">    productService.deleteProduct();</span><br><span class="line">    productService.modifyProduct();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编写配置类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan(&#123;&quot;com.muyoukule.Service&quot;, &quot;com.muyoukule.Aspect&quot;&#125;)</span></span><br><span class="line"><span class="meta">@EnableAspectJAutoProxy(proxyTargetClass = true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringConfig</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结果</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">获取用户信息</span><br><span class="line">XXX操作员正在操作saveUser方法</span><br><span class="line">保存用户</span><br><span class="line">XXX操作员正在操作deleteUser方法</span><br><span class="line">删除用户</span><br><span class="line">XXX操作员正在操作modifyUser方法</span><br><span class="line">修改用户</span><br><span class="line">获取商品信息</span><br><span class="line">XXX操作员正在操作saveProduct方法</span><br><span class="line">保存商品</span><br><span class="line">XXX操作员正在操作deleteProduct方法</span><br><span class="line">删除商品</span><br><span class="line">XXX操作员正在操作modifyProduct方法</span><br><span class="line">修改商品</span><br></pre></td></tr></table></figure>

<h1 id="3-Spring对事务的支持"><a href="#3-Spring对事务的支持" class="headerlink" title="3. Spring对事务的支持"></a>3. Spring对事务的支持</h1><h2 id="3-1-事务概述"><a href="#3-1-事务概述" class="headerlink" title="3.1 事务概述"></a>3.1 事务概述</h2><ul>
<li><p>什么是事务</p>
<ul>
<li>在一个业务流程当中，通常需要多条DML（insert delete update）语句共同联合才能完成，这多条DML语句必须同时成功，或者同时失败，这样才能保证数据的安全。</li>
<li>多条DML要么同时成功，要么同时失败，这叫做事务。</li>
<li>事务：Transaction（tx）</li>
</ul>
</li>
<li><p>事务的四个处理过程：</p>
<ul>
<li>第一步：开启事务 (start transaction)</li>
<li>第二步：执行核心业务代码</li>
<li>第三步：提交事务（如果核心业务处理过程中没有出现异常）(commit transaction)</li>
<li>第四步：回滚事务（如果核心业务处理过程中出现异常）(rollback transaction)</li>
</ul>
</li>
<li><p>事务的四个特性：</p>
<ul>
<li>A 原子性：事务是最小的工作单元，不可再分。</li>
<li>C 一致性：事务要求要么同时成功，要么同时失败。事务前和事务后的总量不变。</li>
<li>I 隔离性：事务和事务之间因为有隔离性，才可以保证互不干扰。</li>
<li>D 持久性：持久性是事务结束的标志。</li>
</ul>
</li>
<li><p>事务作用：在数据层保障一系列的数据库操作同成功同失败。</p>
</li>
<li><p>Spring事务作用：在数据层或业务层保障一系列的数据库操作同成功同失败。</p>
</li>
</ul>
<h2 id="3-2-Spring事务案例"><a href="#3-2-Spring事务案例" class="headerlink" title="3.2 Spring事务案例"></a>3.2 Spring事务案例</h2><p>数据层有事务我们可以理解，为什么业务层也需要处理事务呢?</p>
<p>举个简单的例子：</p>
<ul>
<li>转账业务会有两次数据层的调用，一次是加钱一次是减钱。</li>
<li>把事务放在数据层，加钱和减钱就有两个事务。</li>
<li>没办法保证加钱和减钱同时成功或者同时失败。</li>
<li>这个时候就需要将事务放在业务层进行处理。</li>
</ul>
<p>Spring 为了管理事务，提供了一个平台事务管理器 <code>PlatformTransactionManager</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">PlatformTransactionManager</span> <span class="keyword">extends</span> <span class="title class_">TransactionManager</span> &#123;</span><br><span class="line">    TransactionStatus <span class="title function_">getTransaction</span><span class="params">(<span class="meta">@Nullable</span> TransactionDefinition definition)</span> <span class="keyword">throws</span> TransactionException;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">commit</span><span class="params">(TransactionStatus status)</span> <span class="keyword">throws</span> TransactionException;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">rollback</span><span class="params">(TransactionStatus status)</span> <span class="keyword">throws</span> TransactionException;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>commit</code> 是用来提交事务，<code>rollback</code> 是用来回滚事务。</p>
<p><code>PlatformTransactionManager</code> 只是一个接口，Spring还为其提供了一个具体的实现：<code>DataSourceTransactionManager</code></p>
<p>从名称上可以看出，我们只需要给它一个 DataSource 对象，它就可以帮你去在业务层管理事务。其内部采用的是 JDBC 的事务。所以说如果你持久层采用的是JDBC相关的技术，就可以采用这个事务管理器来管理你的事务。而 Mybatis 内部采用的就是 JDBC 的事务，所以后期我们 Spring 整合 Mybatis 就采用的这个 <code>DataSourceTransactionManager</code> 事务管理器。</p>
<p>小Tips😀：关于整合的知识可以在本站搜索查看 <code>accidence-spring-volumeThree</code> 学习。</p>
<h3 id="3-2-1-转账案例-需求分析"><a href="#3-2-1-转账案例-需求分析" class="headerlink" title="3.2.1 转账案例-需求分析"></a>3.2.1 转账案例-需求分析</h3><p>接下来通过一个案例来学习下Spring是如何来管理事务的。</p>
<p>先来分析下需求:</p>
<p>需求: 实现任意两个账户间转账操作</p>
<p>需求微缩: A账户减钱，B账户加钱</p>
<p>为了实现上述的业务需求，我们可以按照下面步骤来实现下：</p>
<ol>
<li>数据层提供基础操作，指定账户减钱（outMoney），指定账户加钱（inMoney）</li>
<li>业务层提供转账操作（transfer），调用减钱与加钱的操作</li>
<li>提供2个账号和操作金额执行转账操作</li>
<li>基于 Spring 整合 MyBatis 环境搭建上述操作</li>
</ol>
<h3 id="3-2-2-转账案例-环境搭建"><a href="#3-2-2-转账案例-环境搭建" class="headerlink" title="3.2.2 转账案例-环境搭建"></a>3.2.2 转账案例-环境搭建</h3><p>a. 准备数据库表</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> database spring_db <span class="type">character</span> <span class="keyword">set</span> utf8;</span><br><span class="line">use spring_db;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> tbl_account(</span><br><span class="line">    id <span class="type">int</span> <span class="keyword">primary</span> key auto_increment,</span><br><span class="line">    name <span class="type">varchar</span>(<span class="number">35</span>),</span><br><span class="line">    money <span class="keyword">double</span></span><br><span class="line">);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tbl_account <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">&#x27;Tom&#x27;</span>,<span class="number">1000</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tbl_account <span class="keyword">values</span>(<span class="number">2</span>,<span class="string">&#x27;Jerry&#x27;</span>,<span class="number">1000</span>);</span><br></pre></td></tr></table></figure>

<p>b. 创建项目导入jar包，项目的 <code>pom.xml</code> 添加相关依赖</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--spring context依赖--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-context<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.3.27<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.16<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.5.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.0.31<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.3.27<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.12<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.3.27<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.18.24<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>c. 根据表创建模型类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Account</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Double money;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>d. 创建 Dao 接口</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">AccountDao</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Update(&quot;update tbl_account set money = money + #&#123;money&#125; where name = #&#123;name&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">inMoney</span><span class="params">(<span class="meta">@Param(&quot;name&quot;)</span> String name, <span class="meta">@Param(&quot;money&quot;)</span> Double money)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Update(&quot;update tbl_account set money = money - #&#123;money&#125; where name = #&#123;name&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">outMoney</span><span class="params">(<span class="meta">@Param(&quot;name&quot;)</span> String name, <span class="meta">@Param(&quot;money&quot;)</span> Double money)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>e. 创建 Service 接口和实现类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">AccountService</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 转账操作</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> out 传出方</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> in 转入方</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> money 金额</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transfer</span><span class="params">(String out,String in ,Double money)</span> ;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AccountServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">AccountService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AccountDao accountDao;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transfer</span><span class="params">(String out,String in ,Double money)</span> &#123;</span><br><span class="line">        accountDao.outMoney(out,money);</span><br><span class="line">        accountDao.inMoney(in,money);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>f. 添加 <code>jdbc.properties</code> 文件</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">jdbc.driver</span>=<span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line"><span class="attr">jdbc.url</span>=<span class="string">jdbc:mysql://localhost:3306/spring_db?useSSL=false</span></span><br><span class="line"><span class="attr">jdbc.username</span>=<span class="string">root</span></span><br><span class="line"><span class="attr">jdbc.password</span>=<span class="string">root</span></span><br></pre></td></tr></table></figure>

<p>g. 创建 JdbcConfig 配置类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JdbcConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;jdbc.driver&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String driver;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;jdbc.url&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String url;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;jdbc.username&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String userName;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;jdbc.password&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> DataSource <span class="title function_">dataSource</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">DruidDataSource</span> <span class="variable">ds</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DruidDataSource</span>();</span><br><span class="line">        ds.setDriverClassName(driver);</span><br><span class="line">        ds.setUrl(url);</span><br><span class="line">        ds.setUsername(userName);</span><br><span class="line">        ds.setPassword(password);</span><br><span class="line">        <span class="keyword">return</span> ds;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>h. 创建 MybatisConfig 配置类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MybatisConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> SqlSessionFactoryBean <span class="title function_">sqlSessionFactory</span><span class="params">(DataSource dataSource)</span> &#123;</span><br><span class="line">        <span class="type">SqlSessionFactoryBean</span> <span class="variable">ssfb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SqlSessionFactoryBean</span>();</span><br><span class="line">        ssfb.setTypeAliasesPackage(<span class="string">&quot;com.muyoukule.Entity&quot;</span>);</span><br><span class="line">        ssfb.setDataSource(dataSource);</span><br><span class="line">        <span class="keyword">return</span> ssfb;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> MapperScannerConfigurer <span class="title function_">mapperScannerConfigurer</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">MapperScannerConfigurer</span> <span class="variable">msc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MapperScannerConfigurer</span>();</span><br><span class="line">        msc.setBasePackage(<span class="string">&quot;com.muyoukule.Dao&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> msc;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>i. 创建S pringConfig 配置类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan(&quot;com.muyoukule&quot;)</span></span><br><span class="line"><span class="meta">@PropertySource(&quot;classpath:jdbc.properties&quot;)</span></span><br><span class="line"><span class="meta">@Import(&#123;JdbcConfig.class, MybatisConfig.class&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringConfig</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>j. 编写测试类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RunWith(SpringJUnit4ClassRunner.class)</span></span><br><span class="line"><span class="meta">@ContextConfiguration(classes = SpringConfig.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AccountServiceTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AccountService accountService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testTransfer</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        accountService.transfer(<span class="string">&quot;Tom&quot;</span>,<span class="string">&quot;Jerry&quot;</span>,<span class="number">100D</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-2-3-事务管理"><a href="#3-2-3-事务管理" class="headerlink" title="3.2.3 事务管理"></a>3.2.3 事务管理</h3><p>上述环境，运行单元测试类，会执行转账操作，<code>Tom</code>的账户会减少100，<code>Jerry</code>的账户会加100。</p>
<p>这是正常情况下的运行结果，但是如果在转账的过程中出现了异常，如:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AccountServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">AccountService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AccountDao accountDao;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transfer</span><span class="params">(String out,String in ,Double money)</span> &#123;</span><br><span class="line">        accountDao.outMoney(out,money);</span><br><span class="line">        <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>/<span class="number">0</span>;</span><br><span class="line">        accountDao.inMoney(in,money);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个时候就模拟了转账过程中出现异常的情况，正确的操作应该是转账出问题了，<code>Tom</code> 应该还是900，<code>Jerry</code> 应该还是1100，但是真正运行后会发现，并没有像我们想象的那样，<code>Tom</code> 账户为800而 <code>Jerry</code> 还是1100，100块钱凭空消失了，银行乐疯了。如果把转账换个顺序，银行就该哭了。</p>
<p>不管哪种情况，都是不允许出现的，对刚才的结果我们做一个分析:</p>
<ol>
<li><p>程序正常执行时，账户金额A减B加，没有问题</p>
</li>
<li><p>程序出现异常后，转账失败，但是异常之前操作成功，异常之后操作失败，整体业务失败</p>
</li>
</ol>
<p>当程序出问题后，我们需要让事务进行回滚，而且这个事务应该是加在业务层上，而 Spring 的事务管理就是用来解决这类问题的。</p>
<blockquote>
<p>Spring 事务管理具体的实现步骤</p>
</blockquote>
<p>a. 在需要被事务管理的方法上添加注解</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">AccountService</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 转账操作</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> out 传出方</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> in 转入方</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> money 金额</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">//配置当前接口方法具有事务</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transfer</span><span class="params">(String out,String in ,Double money)</span> ;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AccountServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">AccountService</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AccountDao accountDao;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transfer</span><span class="params">(String out, String in, Double money)</span> &#123;</span><br><span class="line">        accountDao.outMoney(out, money);</span><br><span class="line">        <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span> / <span class="number">0</span>;</span><br><span class="line">        accountDao.inMoney(in, money);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意:</p>
<p><code>@Transactional</code> 可以写在接口类上、接口方法上、实现类上和实现类方法上</p>
<ul>
<li>写在接口类上，该接口的所有实现类的所有方法都会有事务</li>
<li>写在接口方法上，该接口的所有实现类的该方法都会有事务</li>
<li>写在实现类上，该类中的所有方法都会有事务</li>
<li>写在实现类方法上，该方法上有事务</li>
<li>建议写在实现类或实现类的方法上</li>
</ul>
<p>b. 在 JdbcConfig 类中配置事务管理器</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JdbcConfig</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// --snip--</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//配置事务管理器，mybatis使用的是jdbc事务</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> PlatformTransactionManager <span class="title function_">transactionManager</span><span class="params">(DataSource dataSource)</span>&#123;</span><br><span class="line">        <span class="type">DataSourceTransactionManager</span> <span class="variable">transactionManager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DataSourceTransactionManager</span>();</span><br><span class="line">        transactionManager.setDataSource(dataSource);</span><br><span class="line">        <span class="keyword">return</span> transactionManager;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注意：</strong>事务管理器要根据使用技术进行选择，Mybatis 框架使用的是 JDBC 事务，可以直接使用 <code>DataSourceTransactionManager</code> </p>
<p>c. 开启事务注解</p>
<p>在 SpringConfig 的配置类中开启</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan(&quot;com.muyoukule&quot;)</span></span><br><span class="line"><span class="meta">@PropertySource(&quot;classpath:jdbc.properties&quot;)</span></span><br><span class="line"><span class="meta">@Import(&#123;JdbcConfig.class, MybatisConfig.class&#125;)</span></span><br><span class="line"><span class="comment">//开启注解式事务驱动</span></span><br><span class="line"><span class="meta">@EnableTransactionManagement</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringConfig</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>d. 运行测试类</p>
<p>会发现在转换的业务出现错误后，事务就可以控制回顾，保证数据的正确性。</p>
<h2 id="3-3-Spring事务角色"><a href="#3-3-Spring事务角色" class="headerlink" title="3.3 Spring事务角色"></a>3.3 Spring事务角色</h2><p>这节中我们重点要理解两个概念，分别是 <code>事务管理员</code> 和 <code>事务协调员</code> 。</p>
<ol>
<li>未开启Spring事务之前:</li>
</ol>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/accidence-spring/%E6%9C%AA%E5%BC%80%E5%90%AFSpring%E4%BA%8B%E5%8A%A1%E4%B9%8B%E5%89%8D.png" style="zoom: 50%;">

<ul>
<li>AccountDao 的 outMoney 因为是修改操作，会开启一个事务T1</li>
<li>AccountDao 的 inMoney 因为是修改操作，会开启一个事务T2</li>
<li>AccountService 的 transfer 没有事务，<ul>
<li>运行过程中如果没有抛出异常，则T1和T2都正常提交，数据正确</li>
<li>如果在两个方法中间抛出异常，T1因为执行成功提交事务，T2因为抛异常不会被执行</li>
<li>就会导致数据出现错误</li>
</ul>
</li>
</ul>
<ol start="2">
<li>开启Spring的事务管理后</li>
</ol>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/accidence-spring/%E5%BC%80%E5%90%AFSpring%E7%9A%84%E4%BA%8B%E5%8A%A1%E7%AE%A1%E7%90%86%E5%90%8E.png" style="zoom: 50%;">

<ul>
<li>transfer上添加了 <code>@Transactional</code> 注解，在该方法上就会有一个事务T</li>
<li>AccountDao的 outMoney 方法的事务T1加入到 transfer 的事务T中</li>
<li>AccountDao的 inMoney 方法的事务T2加入到 transfer 的事务T中</li>
<li>这样就保证他们在同一个事务中，当业务层中出现异常，整个事务就会回滚，保证数据的准确性。</li>
</ul>
<p>通过上面例子的分析，我们就可以得到如下概念：</p>
<ul>
<li>事务管理员：发起事务方，在Spring中通常指代业务层开启事务的方法</li>
<li>事务协调员：加入事务方，在Spring中通常指代数据层方法，也可以是业务层方法</li>
</ul>
<p>注意：</p>
<p>目前的事务管理是基于 <code>DataSourceTransactionManager</code> 和 <code>SqlSessionFactoryBean</code> 使用的是同一个数据源。</p>
<h2 id="3-4-Spring事务属性"><a href="#3-4-Spring事务属性" class="headerlink" title="3.4 Spring事务属性"></a>3.4 Spring事务属性</h2><p>上一节我们介绍了两个概念，事务的管理员和事务的协同员，对于这两个概念具体做什么的，我们待会通过案例来使用下。除了这两个概念，还有就是事务的其他相关配置都有哪些，就是我们接下来要学习的内容。</p>
<p>在这一节中，我们主要学习三部分内容 <code>事务配置</code> 、 <code>转账业务追加日志</code> 、 <code>事务传播行为</code>。</p>
<h3 id="3-4-1-事务配置"><a href="#3-4-1-事务配置" class="headerlink" title="3.4.1 事务配置"></a>3.4.1 事务配置</h3><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/accidence-spring/Spring%E4%BA%8B%E5%8A%A1%E9%85%8D%E7%BD%AE.png" style="zoom: 50%;">

<p>上面这些属性都可以在 <code>@Transactional</code> 注解的参数上进行设置：</p>
<ul>
<li><p>readOnly：true 只读事务，false 读写事务，增删改要设为 false,查询设为 true。</p>
</li>
<li><p>timeout：设置超时时间单位秒，在多长时间之内事务没有提交成功就自动回滚，-1表示不设置超时时间。</p>
</li>
<li><p>rollbackFor：当出现指定异常进行事务回滚</p>
</li>
<li><p>noRollbackFor：当出现指定异常不进行事务回滚</p>
<ul>
<li><p>思考：出现异常事务会自动回滚，这个是我们之前就已经知道的</p>
</li>
<li><p>noRollbackFor 是设定对于指定的异常不回滚，这个好理解</p>
</li>
<li><p>rollbackFor 是指定回滚异常，对于异常事务不应该都回滚么，为什么还要指定?</p>
<ul>
<li><p>这块需要更正一个知识点，并不是所有的异常都会回滚事务，比如下面的代码就不会回滚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">AccountService</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 转账操作</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> out   传出方</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> in    转入方</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> money 金额</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">//配置当前接口方法具有事务</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transfer</span><span class="params">(String out, String in, Double money)</span> <span class="keyword">throws</span> IOException;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AccountServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">AccountService</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AccountDao accountDao;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transfer</span><span class="params">(String out, String in, Double money)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        accountDao.outMoney(out, money);</span><br><span class="line">        <span class="comment">//int i = 1/0; //这个异常事务会回滚</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IOException</span>(); <span class="comment">//这个异常事务就不会回滚</span></span><br><span class="line">        &#125;</span><br><span class="line">        accountDao.inMoney(in, money);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
</li>
<li><p>出现这个问题的原因是，Spring的事务只会对 <code>Error</code> 异常 和 <code>RuntimeException</code> 异常及其子类进行事务回顾，其他的异常类型是不会回滚的，对应 IOException 不符合上述条件所以不回滚</p>
<ul>
<li><p>此时就可以使用 rollbackFor 属性来设置出现 <code>IOException</code> 异常不回滚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AccountServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">AccountService</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AccountDao accountDao;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Transactional(rollbackFor = &#123;IOException.class&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transfer</span><span class="params">(String out, String in, Double money)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        accountDao.outMoney(out, money);</span><br><span class="line">        <span class="comment">//int i = 1/0; //这个异常事务会回滚</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IOException</span>(); <span class="comment">//这个异常事务就不会回滚</span></span><br><span class="line">        &#125;</span><br><span class="line">        accountDao.inMoney(in, money);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>rollbackForClassName 等同于 rollbackFor，只不过属性为异常的类全名字符串</p>
</li>
<li><p>noRollbackForClassName 等同于 noRollbackFor，只不过属性为异常的类全名字符串</p>
</li>
<li><p>isolation 设置事务的隔离级别</p>
<ul>
<li>DEFAULT：默认隔离级别, 会采用数据库的隔离级别</li>
<li>READ_UNCOMMITTED：读未提交</li>
<li>READ_COMMITTED：读已提交</li>
<li>REPEATABLE_READ：重复读取</li>
<li>SERIALIZABLE：串行化</li>
</ul>
</li>
</ul>
<p>介绍完上述属性后，还有最后一个事务的传播行为，为了讲解该属性的设置，我们需要完成下面的案例。</p>
<h3 id="3-4-2-转账业务追加日志案例"><a href="#3-4-2-转账业务追加日志案例" class="headerlink" title="3.4.2 转账业务追加日志案例"></a>3.4.2 转账业务追加日志案例</h3><h4 id="3-4-2-1-需求分析"><a href="#3-4-2-1-需求分析" class="headerlink" title="3.4.2.1 需求分析"></a>3.4.2.1 需求分析</h4><p>在前面的转案例的基础上添加新的需求，完成转账后记录日志。</p>
<ul>
<li>需求：实现任意两个账户间转账操作，并对每次转账操作在数据库进行留痕</li>
<li>需求微缩：A账户减钱，B账户加钱，数据库记录日志</li>
</ul>
<p>基于上述的业务需求，我们来分析下该如何实现:</p>
<ol>
<li><p>基于转账操作案例添加日志模块，实现数据库中记录日志</p>
</li>
<li><p>业务层转账操作（transfer），调用减钱、加钱与记录日志功能</p>
</li>
</ol>
<p>需要注意一点就是，我们这个案例的预期效果为：无论转账操作是否成功，均进行转账操作的日志留痕。</p>
<h4 id="3-4-2-2-环境准备"><a href="#3-4-2-2-环境准备" class="headerlink" title="3.4.2.2 环境准备"></a>3.4.2.2 环境准备</h4><p>该环境是基于转账环境来完成的，在其基础上，我们继续往下写：</p>
<p>a. 创建日志表</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> tbl_log(</span><br><span class="line">   id <span class="type">int</span> <span class="keyword">primary</span> key auto_increment,</span><br><span class="line">   info <span class="type">varchar</span>(<span class="number">255</span>),</span><br><span class="line">   createDate datetime</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>b. 添加 LogDao 接口</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">LogDao</span> &#123;</span><br><span class="line">    <span class="meta">@Insert(&quot;insert into tbl_log (info,createDate) values(#&#123;info&#125;,now())&quot;)</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">log</span><span class="params">(String info)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>c. 添加 LogService 接口与实现类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">LogService</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">log</span><span class="params">(String out, String in, Double money)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LogServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">LogService</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> LogDao logDao;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">log</span><span class="params">(String out, String in, Double money)</span> &#123;</span><br><span class="line">        logDao.log(<span class="string">&quot;转账操作由&quot;</span> + out + <span class="string">&quot;到&quot;</span> + in + <span class="string">&quot;,金额：&quot;</span> + money);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>d. 在转账的业务中添加记录日志</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">AccountService</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 转账操作</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> out   传出方</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> in    转入方</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> money 金额</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">//配置当前接口方法具有事务</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transfer</span><span class="params">(String out, String in, Double money)</span> <span class="keyword">throws</span> IOException;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AccountServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">AccountService</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AccountDao accountDao;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> LogService logService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transfer</span><span class="params">(String out, String in, Double money)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            accountDao.outMoney(out, money);</span><br><span class="line">            accountDao.inMoney(in, money);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            logService.log(out, in, money);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>e. 运行程序</p>
<ul>
<li><p>当程序正常运行，tbl_account 表中转账成功，tbl_log 表中日志记录成功</p>
</li>
<li><p>当转账业务之间出现异常(int i &#x3D;1&#x2F;0)，转账失败，tbl_account 成功回滚，但是 tbl_log 表未添加数据</p>
</li>
<li><p>这个结果和我们想要的不一样，什么原因？该如何解决？</p>
</li>
<li><p>失败原因：日志的记录与转账操作隶属同一个事务，同成功同失败</p>
</li>
<li><p>最终效果：无论转账操作是否成功，日志必须保留</p>
</li>
</ul>
<h3 id="3-4-3-事务传播行为"><a href="#3-4-3-事务传播行为" class="headerlink" title="3.4.3 事务传播行为"></a>3.4.3 事务传播行为</h3><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/accidence-spring/%E4%BA%8B%E5%8A%A1%E4%BC%A0%E6%92%AD%E8%A1%8C%E4%B8%BA.png" style="zoom:50%;">

<p>对于上述案例的分析：</p>
<ul>
<li>log 方法、inMoney 方法和 outMoney 方法都属于增删改，分别有事务T1，T2，T3</li>
<li>transfer 因为加了 <code>@Transactional</code> 注解，也开启了事务T</li>
<li>前面我们讲过 Spring 事务会把T1，T2，T3都加入到事务T中</li>
<li>所以当转账失败后，所有的事务都回滚，导致日志没有记录下来</li>
<li>这和我们的需求不符，这个时候我们就想能不能让 log 方法单独是一个事务呢?</li>
</ul>
<p>要想解决这个问题，就需要用到事务传播行为，所谓的事务传播行为指的是：</p>
<p>事务传播行为：事务协调员对事务管理员所携带事务的处理态度。</p>
<p>具体如何解决，就需要用到之前我们没有说的 <code>propagation属性</code>。</p>
<p>a. 修改 logService 改变事务的传播行为</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LogServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">LogService</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> LogDao logDao;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//propagation设置事务属性：传播行为设置为当前操作需要新事务</span></span><br><span class="line">    <span class="meta">@Transactional(propagation = Propagation.REQUIRES_NEW)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">log</span><span class="params">(String out, String in, Double money)</span> &#123;</span><br><span class="line">        logDao.log(<span class="string">&quot;转账操作由&quot;</span> + out + <span class="string">&quot;到&quot;</span> + in + <span class="string">&quot;,金额：&quot;</span> + money);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行后，就能实现我们想要的结果，不管转账是否成功，都会记录日志。</p>
<p>b. 事务传播行为的可选值</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/accidence-spring/%E4%BA%8B%E5%8A%A1%E4%BC%A0%E6%92%AD%E8%A1%8C%E4%B8%BA%E7%9A%84%E5%8F%AF%E9%80%89%E5%80%BC.png" style="zoom: 50%;">

<p>对于我们开发实际中使用的话，因为默认值需要事务是常态的。根据开发过程选择其他的就可以了，例如案例中需要新事务就需要手工配置。其实入账和出账操作上也有事务，采用的就是默认值。</p>
]]></content>
      <categories>
        <category>Java</category>
        <category>SSM</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>Spring</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring入门（上）</title>
    <url>/posts/63145/</url>
    <content><![CDATA[<p>Spring官网：<a href="https://spring.io/">https://spring.io/</a></p>
<p>参考视频：</p>
<ul>
<li><a href="https://www.bilibili.com/video/BV1Ft4y1g7Fb/">Spring视频零基础入门到高级，Spring全套视频教程详解</a></li>
<li><a href="https://www.bilibili.com/video/BV1Fi4y1S7ix/">黑马程序员SSM框架教程Spring部分</a></li>
</ul>
<p>源码仓库：<a href="https://github.com/muyoukule/accidence-spring">muyoukule&#x2F;accidence-spring (github.com)</a></p>
<h1 id="0-Spring简介"><a href="#0-Spring简介" class="headerlink" title="0. Spring简介"></a>0. Spring简介</h1><p>Spring是一个开源的Java EE应用程序框架，由Rod Johnson在2002年创建，旨在解决企业级编程开发中的复杂性，实现敏捷开发。Spring框架是一个轻量级的容器，用于管理业务相关的对象。它通过控制反转（IoC）和面向切面编程（AOP）等特性，降低了组件之间的耦合度，提高了代码的可重用性和可维护性。</p>
<p><strong>核心特性</strong>：</p>
<ul>
<li><strong>依赖注入（Dependency Injection）</strong>：这是Spring框架管理对象间依赖关系的主要手段。通过依赖注入，我们可以将对象的依赖关系从代码中解耦出来，交由Spring容器来管理。这样，当依赖关系发生变化时，我们只需要修改配置文件，而无需修改代码。</li>
<li><strong>面向切面编程（Aspect-Oriented Programming，AOP）</strong>：Spring AOP通过定义横切关注点（如日志、安全、事务管理等），将这些关注点从业务逻辑中分离出来，以模块化的方式进行处理。这有助于减少代码的重复，提高代码的可读性和可维护性。</li>
<li><strong>事务管理</strong>：Spring框架提供了强大的事务管理功能，可以轻松地处理事务操作，确保数据的完整性和一致性。</li>
<li><strong>数据访问</strong>：Spring框架对多种数据访问技术提供了良好的支持，如JDBC、ORM框架（如Hibernate、MyBatis）等，简化了数据访问层的开发。</li>
</ul>
<p><strong>应用场景</strong>：</p>
<p>Spring框架广泛应用于各种Java企业级应用程序开发中，包括Web应用、RESTful服务、批处理应用等。无论是构建大型的分布式系统，还是开发小型的应用程序，Spring都能提供强大的支持和灵活的解决方案。</p>
<p><strong>模块组成</strong>：</p>
<p>Spring框架由多个模块组成，每个模块都有其特定的功能和用途。核心容器（Core Container）是其他模块建立的基础，主要由Beans模块、Core模块、Context模块、Context-support模块和SpEL（Spring Expression Language）模块组成。此外，还有数据访问&#x2F;集成（Data Access&#x2F;Integration）层，包括JDBC、ORM、OXM、JMS和Transactions模块等。</p>
<p><strong>使用方式</strong>：</p>
<p>在使用 Spring 框架时，一般通过 Maven 或 Gradle 等构建工具导入所需的依赖。然后，我们可以开始编写 Spring 应用程序，利用Spring 的 IoC 和 AOP 等特性来管理对象间的依赖关系和横切关注点。同时，我们还可以利用 Spring 提供的数据访问和事务管理等功能来简化应用程序的开发。</p>
<h1 id="1-入门程序"><a href="#1-入门程序" class="headerlink" title="1. 入门程序"></a>1. 入门程序</h1><h2 id="1-1-IOC入门案例"><a href="#1-1-IOC入门案例" class="headerlink" title="1.1 IOC入门案例"></a>1.1 IOC入门案例</h2><h3 id="1-1-1-准备工作"><a href="#1-1-1-准备工作" class="headerlink" title="1.1.1 准备工作"></a>1.1.1 准备工作</h3><p>a. 打开IDEA创建Empty Project：spring</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/accidence-spring/%E8%BE%93%E5%85%A5%E9%A1%B9%E7%9B%AE%E5%90%8D%E7%A7%B0.png" style="zoom: 67%;">

<p>b. 设置JDK版本17，编译器版本17</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/accidence-spring/%E8%AE%BE%E7%BD%AEJDK%E7%89%88%E6%9C%AC.png" style="zoom:67%;">

<p>c. 设置IDEA的Maven：关联自己的Maven</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/accidence-spring/%E5%85%B3%E8%81%94Maven.png" style="zoom:67%;">

<p>d. 在空的工程中创建第一个模块：spring-001</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/accidence-spring/%E5%88%9B%E5%BB%BA%E6%A8%A1%E5%9D%97.png" style="zoom: 80%;">

<p>e. 创建好的项目结构如下：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/accidence-spring/%E7%AC%AC%E4%B8%80%E4%B8%AASpring%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84.png" style="zoom: 67%;">

<h3 id="1-1-2-创建项目"><a href="#1-1-2-创建项目" class="headerlink" title="1.1.2 创建项目"></a>1.1.2 创建项目</h3><p>a. 在 <code>pom.xml</code> 添加 Spring 的依赖jar包</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--spring context依赖--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-context<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.3.27<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--junit--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.13.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>当加入 <code>spring context</code> 的依赖之后，会关联引入其他依赖：</p>
<ul>
<li><p><code>spring aop</code> ：面向切面编程</p>
</li>
<li><p><code>spring beans</code> ：IoC核心</p>
</li>
<li><p><code>spring core</code> ：spring的核心工具包</p>
</li>
<li><p><code>spring jcl</code> ：spring的日志包</p>
</li>
<li><p><code>spring expression</code> ：spring表达式</p>
</li>
</ul>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/accidence-spring/spring%20context%E4%BE%9D%E8%B5%96.png"></p>
<p>b. 添加案例中需要的类,创建 <code>User</code> 类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">hello</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;hello userBean....&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>c. 添加spring配置文件 <code>applicationContext.xml</code></p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/accidence-spring/%E6%B7%BB%E5%8A%A0spring%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6.png">

<p>d. 在 <code>applicationContext.xml</code> 配置文件中完成 <code>bean</code> 的配置</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!--bean标签标示配置bean,id属性标示给bean起名字,class属性表示给bean定义类型--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;userBean&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.muyoukule.Bean.User&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>e. 获取IOC容器</p>
<p>使用Spring提供的接口完成IOC容器的创建，创建App类，编写main方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">App</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">//获取IOC容器</span></span><br><span class="line">        <span class="type">ApplicationContext</span> <span class="variable">ctx</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;applicationContext.xml&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>f. 从容器中获取对象进行方法调用</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">App</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">//获取IOC容器</span></span><br><span class="line">        <span class="type">ApplicationContext</span> <span class="variable">ctx</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;applicationContext.xml&quot;</span>);</span><br><span class="line">        <span class="comment">//获取出的对象为Object类型，需要进行强转</span></span><br><span class="line">        <span class="comment">//User userBean = (User) ctx.getBean(&quot;userBean&quot;);</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//或者在参数后指定返回值的类型</span></span><br><span class="line">        <span class="type">User</span> <span class="variable">userBean</span> <span class="operator">=</span> ctx.getBean(<span class="string">&quot;userBean&quot;</span>, User.class);</span><br><span class="line">        userBean.hello();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>g. 运行 <code>main()</code> 方法</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">hello userBean....</span><br></pre></td></tr></table></figure>

<p>至此，Spring的IOC入门案例已经完成。</p>
<h2 id="1-2-IOC入门案例详解"><a href="#1-2-IOC入门案例详解" class="headerlink" title="1.2 IOC入门案例详解"></a>1.2 IOC入门案例详解</h2><blockquote>
<p> Bean 标签的 id 属性可以重复吗？</p>
</blockquote>
<p>新建一个 <code>Vip</code> 类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Vip</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 <code>applicationContext.xml</code> 配置文件中配置为 <code>bean</code></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--bean标签标示配置bean,id属性标示给bean起名字,class属性表示给bean定义类型--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;userBean&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.muyoukule.Bean.User&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;userBean&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.muyoukule.Bean.Vip&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>运行 <code>main()</code> 方法测试，程序报错提示：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/accidence-spring/id%E5%B1%9E%E6%80%A7%E9%87%8D%E5%A4%8D.png"></p>
<p>通过测试得出：在 spring 的配置文件中 id 是不能重名。</p>
<blockquote>
<p>底层是怎么创建对象的，是通过反射机制调用无参数构造方法吗？</p>
</blockquote>
<p>在 <code>User</code> 类中添加无参构造方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">User</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;User的无参数构造方法执行&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">hello</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;hello userBean....&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行测试程序</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">User的无参数构造方法执行</span><br><span class="line">hello userBean....</span><br></pre></td></tr></table></figure>

<p>通过测试得知：创建对象时确实调用了无参数构造方法。</p>
<blockquote>
<p>如果提供一个有参数构造方法，不提供无参数构造方法会怎样呢？</p>
</blockquote>
<p>注释掉 User 类中的无参构造方法，在 User 类中添加有参构造方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line"><span class="comment">/*    public User() &#123;</span></span><br><span class="line"><span class="comment">        System.out.println(&quot;User的无参数构造方法执行&quot;);</span></span><br><span class="line"><span class="comment">    &#125;*/</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">User</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;User的有参数构造方法执行&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">hello</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;hello userBean....&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行测试程序</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/accidence-spring/%E6%97%A0%E5%8F%82%E6%95%B0%E6%9E%84%E9%80%A0%E4%B8%8D%E5%AD%98%E5%9C%A8.png"></p>
<p>通过测试得知：spring 是通过调用类的无参数构造方法来创建对象的，所以要想让 spring 给你创建对象，必须保证无参数构造方法是存在的。</p>
<blockquote>
<p>Spring是如何创建对象的呢？原理是什么？</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// dom4j解析beans.xml文件，从中获取class的全限定类名</span></span><br><span class="line"><span class="comment">// 通过反射机制调用无参数构造方法创建对象</span></span><br><span class="line"><span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;com.muyoukule.Bean.User&quot;</span>);</span><br><span class="line"><span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> clazz.newInstance();</span><br></pre></td></tr></table></figure>

<blockquote>
<p>把创建好的对象存储到一个什么样的数据结构当中了呢？</p>
</blockquote>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/accidence-spring/%E5%AF%B9%E8%B1%A1%E5%AD%98%E5%82%A8%E5%88%B0%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84.png" style="zoom: 80%;">

<blockquote>
<p>spring配置文件的名字可以随意命名，且可以创建多个，并且在读取的时候也可以一并读取</p>
</blockquote>
<p>在 <code>applicationContext2.xml</code> 配置文件中配置 <code>vipBean</code></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;vipBean&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.muyoukule.Bean.Vip&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">App</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">//获取IOC容器</span></span><br><span class="line">        <span class="type">ApplicationContext</span> <span class="variable">ctx</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;applicationContext.xml&quot;</span>, <span class="string">&quot;applicationContext2.xml&quot;</span>);</span><br><span class="line">        <span class="comment">//或者在参数后指定返回值的类型</span></span><br><span class="line">        <span class="type">User</span> <span class="variable">userBean</span> <span class="operator">=</span> ctx.getBean(<span class="string">&quot;userBean&quot;</span>, User.class);</span><br><span class="line">        System.out.println(userBean);</span><br><span class="line">        <span class="type">Vip</span> <span class="variable">vipBean</span> <span class="operator">=</span> ctx.getBean(<span class="string">&quot;vipBean&quot;</span>, Vip.class);</span><br><span class="line">        System.out.println(vipBean);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行测试程序</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">User的无参数构造方法执行</span><br><span class="line">com.muyoukule.Bean.User@345965f2</span><br><span class="line">com.muyoukule.Bean.Vip@429bd883</span><br></pre></td></tr></table></figure>

<blockquote>
<p>在配置文件中配置的类必须是自定义的吗，可以使用JDK中的类吗，例如：java.util.Date？</p>
</blockquote>
<p>在 <code>applicationContext.xml</code> 配置文件中添加如下 <code>bean</code></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;dateBean&quot;</span> <span class="attr">class</span>=<span class="string">&quot;java.util.Date&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">App</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">//获取IOC容器</span></span><br><span class="line">        <span class="type">ApplicationContext</span> <span class="variable">ctx</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;applicationContext.xml&quot;</span>);</span><br><span class="line">        <span class="comment">//或者在参数后指定返回值的类型</span></span><br><span class="line">        <span class="type">User</span> <span class="variable">userBean</span> <span class="operator">=</span> ctx.getBean(<span class="string">&quot;userBean&quot;</span>, User.class);</span><br><span class="line">        System.out.println(userBean);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">dateBean</span> <span class="operator">=</span> ctx.getBean(<span class="string">&quot;dateBean&quot;</span>);</span><br><span class="line">        System.out.println(dateBean);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">User的无参数构造方法执行</span><br><span class="line">com.muyoukule.Bean.User@4d339552</span><br><span class="line">Mon May 08 23:36:09 CST 2023</span><br></pre></td></tr></table></figure>

<p>通过测试得知，在 spring 配置文件中配置的bean可以任意类，只要这个类不是抽象的，并且提供了无参数构造方法。</p>
<blockquote>
<p><code>getBean()</code> 方法返回的类型是 <code>Object</code> ，如果访问子类的特有属性和方法时，还需要向下转型，有其它办法可以解决这个问题吗？</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> applicationContext.getBean(<span class="string">&quot;userBean&quot;</span>, User.class);</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>ClassPathXmlApplicationContext</code> 是从类路径中加载配置文件，如果没有在类路径当中，又应该如何加载配置文件呢？</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileSystemXmlApplicationContext</span>(<span class="string">&quot;d:/applicationContext.xml&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>没有在类路径中的话，需要使用 <code>FileSystemXmlApplicationContext</code> 类进行加载配置文件。这种方式较少用。一般都是将配置文件放到类路径当中，这样可移植性更强。</p>
<blockquote>
<p><code>ApplicationContext</code> 的超级父接口 <code>BeanFactory</code></p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">BeanFactory</span> <span class="variable">beanFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;applicationContext.xml&quot;</span>);</span><br><span class="line"><span class="type">Object</span> <span class="variable">vipBean</span> <span class="operator">=</span> beanFactory.getBean(<span class="string">&quot;vipBean&quot;</span>);</span><br><span class="line">System.out.println(vipBean);</span><br></pre></td></tr></table></figure>

<p><code>BeanFactory</code> 是 Spring 容器的超级接口。<code>ApplicationContext</code> 是 <code>BeanFactory</code> 的子接口。</p>
<h2 id="1-3-Spring启用Log4j2日志框架"><a href="#1-3-Spring启用Log4j2日志框架" class="headerlink" title="1.3 Spring启用Log4j2日志框架"></a>1.3 Spring启用Log4j2日志框架</h2><p>从Spring5之后，Spring框架支持集成的日志框架是 <code>Log4j2</code> 。如何启用日志框架：</p>
<p>a. 引入 <code>Log4j2</code> 的依赖</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--log4j2的依赖--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.logging.log4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.19.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.logging.log4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j-slf4j2-impl<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.19.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>b. 在类的根路径下提供 <code>log4j2.xml</code> 配置文件（文件名固定为：<code>log4j2.xml</code> ，文件必须放到类根路径下。）</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">loggers</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">            level指定日志级别，从低到高的优先级：</span></span><br><span class="line"><span class="comment">                ALL &lt; TRACE &lt; DEBUG &lt; INFO &lt; WARN &lt; ERROR &lt; FATAL &lt; OFF</span></span><br><span class="line"><span class="comment">        --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">root</span> <span class="attr">level</span>=<span class="string">&quot;DEBUG&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;springlog&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">loggers</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">appenders</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--输出日志信息到控制台--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">console</span> <span class="attr">name</span>=<span class="string">&quot;springlog&quot;</span> <span class="attr">target</span>=<span class="string">&quot;SYSTEM_OUT&quot;</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--控制日志输出的格式--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">PatternLayout</span> <span class="attr">pattern</span>=<span class="string">&quot;%d&#123;yyyy-MM-dd HH:mm:ss SSS&#125; [%t] %-3level %logger&#123;1024&#125; - %msg%n&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">console</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appenders</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="2-Spring对IoC的实现"><a href="#2-Spring对IoC的实现" class="headerlink" title="2. Spring对IoC的实现"></a>2. Spring对IoC的实现</h1><h2 id="2-1-IoC-控制反转"><a href="#2-1-IoC-控制反转" class="headerlink" title="2.1 IoC 控制反转"></a>2.1 IoC 控制反转</h2><ul>
<li><p>控制反转是一种思想。</p>
</li>
<li><p>控制反转是为了降低程序耦合度，提高程序扩展力，达到OCP原则，达到DIP原则。</p>
</li>
<li><p>控制反转，反转的是什么？</p>
<ul>
<li>将对象的创建权利交出去，交给第三方容器负责。</li>
<li>将对象和对象之间关系的维护权交出去，交给第三方容器负责。</li>
</ul>
</li>
<li><p>控制反转这种思想如何实现呢？</p>
<ul>
<li>DI（Dependency Injection）：依赖注入</li>
</ul>
</li>
</ul>
<h2 id="2-2-依赖注入"><a href="#2-2-依赖注入" class="headerlink" title="2.2 依赖注入"></a>2.2 依赖注入</h2><p>依赖注入实现了控制反转的思想。Spring通过依赖注入的方式来完成Bean管理的。</p>
<p>Bean管理说的是：<code>Bean</code> 对象的创建，以及Bean对象中属性的赋值（或者叫做 <code>Bean</code> 对象之间关系的维护）。</p>
<p>依赖注入：</p>
<ul>
<li>依赖指的是对象和对象之间的关联关系。</li>
<li>注入指的是一种数据传递行为，通过注入行为来让对象和对象产生关系。</li>
</ul>
<p>依赖注入常见的实现方式包括两种：</p>
<ul>
<li>第一种：set注入</li>
<li>第二种：构造注入</li>
</ul>
<p>新建模块：spring-002</p>
<h3 id="2-2-1-set注入"><a href="#2-2-1-set注入" class="headerlink" title="2.2.1 set注入"></a>2.2.1 set注入</h3><p>set 注入，基于 set 方法实现的，底层会通过反射机制调用属性对应的 set 方法然后给属性赋值。这种方式要求属性必须对外提供 set 方法。</p>
<blockquote>
<p>对外提供 set 方法</p>
</blockquote>
<p>a. 创建 <code>UserDao</code> 类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserDao</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">insert</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;正在保存用户数据...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>b. 创建 <code>UserService</code> 类，并为 <code>UserDao</code> 提供 <code>setter</code> 方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> UserDao userDao;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用set方式注入，必须提供set方法。</span></span><br><span class="line">    <span class="comment">// 反射机制要调用这个方法给属性赋值的。</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUserDao</span><span class="params">(UserDao userDao)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.userDao = userDao;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">save</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;UserService...&quot;</span>);</span><br><span class="line">        userDao.insert();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>c. 在配置文件中完成 <code>bean</code> 的配置</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;userDaoBean&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.muyoukule.Dao.UserDao&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--property标签表示配置当前bean的属性,name属性表示配置哪一个具体的属性,ref属性表示参照哪一个bean--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;userServiceBean&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.muyoukule.Service.UserService&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;userDao&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;userDaoBean&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>d. 编写测试程序</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSetDI</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;spring.xml&quot;</span>);</span><br><span class="line">    <span class="type">UserService</span> <span class="variable">userService</span> <span class="operator">=</span> applicationContext.getBean(<span class="string">&quot;userServiceBean&quot;</span>, UserService.class);</span><br><span class="line">    userService.save();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>e. 运行结果</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">UserService...</span><br><span class="line">正在保存用户数据...</span><br></pre></td></tr></table></figure>

<p>实现原理：</p>
<ul>
<li><p>通过 <code>property</code> 标签获取到属性名：<code>userDao</code> 。</p>
</li>
<li><p>通过属性名推断出set方法名：<code>setUserDao</code> 。</p>
</li>
<li><p>通过反射机制调用 <code>setUserDao()</code> 方法给属性赋值。</p>
</li>
<li><p><code>property</code> 标签的 <code>name</code> 是属性名。</p>
</li>
<li><p><code>property</code> 标签的 <code>ref</code> 是要注入的 <code>bean</code> 对象的 id。（通过 <code>ref</code> 属性来完成 <code>bean</code> 的装配，这是 <code>bean</code>最简单的一种装配方式。装配指的是：创建系统组件之间关联的动作）</p>
</li>
</ul>
<blockquote>
<p>把set方法注释掉</p>
</blockquote>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/accidence-spring/set%E6%96%B9%E6%B3%95%E8%A2%AB%E6%B3%A8%E9%87%8A.png"></p>
<p>通过测试得知，底层实际上调用了 <code>setUserDao()</code> 方法。所以需要确保这个方法的存在。</p>
<blockquote>
<p>把属性名修改一下，但方法名还是 <code>setUserDao()</code> </p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> UserDao aaa;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用set方式注入，必须提供set方法。</span></span><br><span class="line">    <span class="comment">// 反射机制要调用这个方法给属性赋值的。</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUserDao</span><span class="params">(UserDao userDao)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.aaa = userDao;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">save</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;UserService...&quot;</span>);</span><br><span class="line">        aaa.insert();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">UserService...</span><br><span class="line">正在保存用户数据...</span><br></pre></td></tr></table></figure>

<p>通过测试看到程序仍然可以正常执行，说明 <code>property</code> 标签的 <code>name</code> 是：<code>setUserDao()</code> 方法名演变得到的。演变的规律是：</p>
<ul>
<li>setUsername() 演变为 username</li>
<li>setUserDao() 演变为 userDao</li>
</ul>
<p>另外，对于 <code>property</code> 标签来说，<code>ref</code> 属性也可以采用标签的方式，但使用 <code>ref</code> 属性是多数的。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;userServiceBean&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.muyoukule.Service.UserService&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;userDao&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">&quot;userDaoBean&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>总结：<code>set</code> 注入的核心实现原理：通过反射机制调用 <code>set</code> 方法来给属性赋值，让两个对象之间产生关系。</p>
<h3 id="2-2-2-构造注入"><a href="#2-2-2-构造注入" class="headerlink" title="2.2.2 构造注入"></a>2.2.2 构造注入</h3><p>核心原理：通过调用构造方法来给属性赋值。</p>
<blockquote>
<p>提供构造方法</p>
</blockquote>
<p>a. 创建如下两个类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderDao</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deleteById</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;正在删除订单...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderService</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> OrderDao orderDao;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 通过反射机制调用构造方法给属性赋值</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">OrderService</span><span class="params">(OrderDao orderDao)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.orderDao = orderDao;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">delete</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;OrderService...&quot;</span>);</span><br><span class="line">        orderDao.deleteById();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>b. 在 <code>spring.xml</code> 下配置如下 <code>bean</code></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;orderDaoBean&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.muyoukule.Dao.OrderDao&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;orderServiceBean&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.muyoukule.Service.OrderService&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--index=&quot;0&quot;表示构造方法的第一个参数，将orderDaoBean对象传递给构造方法的第一个参数。--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">index</span>=<span class="string">&quot;0&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;orderDaoBean&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>c. 编写测试程序</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testConstructorDI</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;spring.xml&quot;</span>);</span><br><span class="line">    <span class="type">OrderService</span> <span class="variable">orderServiceBean</span> <span class="operator">=</span> applicationContext.getBean(<span class="string">&quot;orderServiceBean&quot;</span>, OrderService.class);</span><br><span class="line">    orderServiceBean.delete();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>d. 运行结果</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">OrderService...</span><br><span class="line">正在删除订单...</span><br></pre></td></tr></table></figure>

<blockquote>
<p>如果构造方法有两个参数</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderService</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> OrderDao orderDao;</span><br><span class="line">    <span class="keyword">private</span> UserDao userDao;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 通过反射机制调用构造方法给属性赋值</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">OrderService</span><span class="params">(OrderDao orderDao, UserDao userDao)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.orderDao = orderDao;</span><br><span class="line">        <span class="built_in">this</span>.userDao = userDao;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">delete</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;OrderService...&quot;</span>);</span><br><span class="line">        orderDao.deleteById();</span><br><span class="line">        userDao.insert();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>配置文件</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;orderDaoBean&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.muyoukule.Dao.OrderDao&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;userDaoBean&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.muyoukule.Dao.UserDao&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;orderServiceBean&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.muyoukule.Service.OrderService&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--第一个参数下标是0--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">index</span>=<span class="string">&quot;0&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;orderDaoBean&quot;</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--第二个参数下标是1--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">index</span>=<span class="string">&quot;1&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;userDaoBean&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>执行测试程序</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">OrderService...</span><br><span class="line">正在删除订单...</span><br><span class="line">正在保存用户数据...</span><br></pre></td></tr></table></figure>

<blockquote>
<p>不使用参数下标，使用参数的名字</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;orderDaoBean&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.muyoukule.Dao.OrderDao&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;userDaoBean&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.muyoukule.Dao.UserDao&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;orderServiceBean&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.muyoukule.Service.OrderService&quot;</span>&gt;</span></span><br><span class="line">	<span class="comment">&lt;!--这里使用了构造方法上参数的名字--&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">name</span>=<span class="string">&quot;orderDao&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;orderDaoBean&quot;</span>/&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">name</span>=<span class="string">&quot;userDao&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;userDaoBean&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>不指定参数下标，不指定参数名字</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;orderDaoBean&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.muyoukule.Dao.OrderDao&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;userDaoBean&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.muyoukule.Dao.UserDao&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;orderServiceBean&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.muyoukule.Service.OrderService&quot;</span>&gt;</span></span><br><span class="line">	<span class="comment">&lt;!--没有指定下标，也没有指定参数名字--&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">ref</span>=<span class="string">&quot;orderDaoBean&quot;</span>/&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">ref</span>=<span class="string">&quot;userDaoBean&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>配置文件中构造方法参数的类型顺序和构造方法参数的类型顺序不一致</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;orderDaoBean&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.muyoukule.Dao.OrderDao&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;userDaoBean&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.muyoukule.Dao.UserDao&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;orderServiceBean&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.muyoukule.Service.OrderService&quot;</span>&gt;</span></span><br><span class="line">	<span class="comment">&lt;!--顺序已经和构造方法的参数顺序不同了--&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">ref</span>=<span class="string">&quot;userDaoBean&quot;</span>/&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">ref</span>=<span class="string">&quot;orderDaoBean&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>以上几种情况测试结果均为：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">OrderService...</span><br><span class="line">正在删除订单...</span><br><span class="line">正在保存用户数据...</span><br></pre></td></tr></table></figure>

<p>通过测试得知，通过构造方法注入的时候：</p>
<ul>
<li>可以通过下标</li>
<li>可以通过参数名</li>
<li>也可以不指定下标和参数名，可以类型自动推断。</li>
</ul>
<h2 id="2-3-set注入专题"><a href="#2-3-set注入专题" class="headerlink" title="2.3 set注入专题"></a>2.3 set注入专题</h2><h3 id="2-3-1-注入外部-Bean"><a href="#2-3-1-注入外部-Bean" class="headerlink" title="2.3.1 注入外部 Bean"></a>2.3.1 注入外部 Bean</h3><p>之前的一个案例中使用的案例就是注入外部 <code>Bean</code> 的方式。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;userDaoBean&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.muyoukule.Dao.UserDao&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--property标签表示配置当前bean的属性,name属性表示配置哪一个具体的属性,ref属性表示参照哪一个bean--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;userServiceBean&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.muyoukule.Service.UserService&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;userDao&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;userDaoBean&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>外部Bean的特点：<code>bean</code> 定义到外面，在 <code>property</code> 标签中使用 <code>ref</code> 属性进行注入。通常这种方式是常用。</p>
<h3 id="2-3-2-注入内部-Bean"><a href="#2-3-2-注入内部-Bean" class="headerlink" title="2.3.2 注入内部 Bean"></a>2.3.2 注入内部 Bean</h3><p>内部 Bean 的方式：在 <code>bean</code> 标签中嵌套 <code>bean</code> 标签。</p>
<p>a. 新建 <code>spring-inner-bean.xml</code> 文件，配置以下 <code>bean</code> </p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;userServiceBean&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.muyoukule.Service.UserService&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;userDao&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;com.muyoukule.Dao.UserDao&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>b. 编写测试代码</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testInnerBean</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;spring-inner-bean.xml&quot;</span>);</span><br><span class="line">    <span class="type">UserService</span> <span class="variable">userService</span> <span class="operator">=</span> applicationContext.getBean(<span class="string">&quot;userServiceBean&quot;</span>, UserService.class);</span><br><span class="line">    userService.save();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>c. 执行测试程序</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">UserService...</span><br><span class="line">正在保存用户数据...</span><br></pre></td></tr></table></figure>

<h3 id="2-3-3-注入简单类型"><a href="#2-3-3-注入简单类型" class="headerlink" title="2.3.3 注入简单类型"></a>2.3.3 注入简单类型</h3><p>我们之前在进行注入的时候，对象的属性是另一个对象。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//对象的属性是另一个对象</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserService</span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> UserDao userDao;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUserDao</span><span class="params">(UserDao userDao)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.userDao = userDao;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对象的属性是 <code>int</code> 类型</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//对象的属性是int类型</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAge</span><span class="params">(<span class="type">int</span> age)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>也是通过 <code>set</code> 注入的方式给该属性赋值，因为只要能够调用 <code>set</code> 方法就可以给属性赋值。</p>
<blockquote>
<p>编写程序给一个 User 对象的 age 属性赋值20</p>
</blockquote>
<p>a. 定义User类，提供 age 属性，提供 age 属性的 <code>setter</code> 方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAge</span><span class="params">(<span class="type">int</span> age)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;User&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;age=&quot;</span> + age +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>b. 编写 spring 配置文件：<code>spring-simple-type.xml</code></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;userBean&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.muyoukule.Bean.User&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--如果像这种int类型的属性，我们称为简单类型，这种简单类型在注入的时候要使用value属性，不能使用ref--&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--&lt;property name=&quot;age&quot; value=&quot;20&quot;/&gt;--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;age&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>20<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>c. 编写测试程序</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSimpleType</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;spring-simple-type.xml&quot;</span>);</span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> applicationContext.getBean(<span class="string">&quot;userBean&quot;</span>, User.class);</span><br><span class="line">    System.out.println(user);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>d. 运行测试程序</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">User&#123;age=20&#125;</span><br></pre></td></tr></table></figure>

<p>需要特别注意：如果给简单类型赋值，使用 <code>value</code> 属性或 <code>value</code> 标签。而不是 <code>ref</code> 。</p>
<blockquote>
<p>简单类型包括哪些呢？</p>
</blockquote>
<p>可以通过 Spring 的源码来分析一下：<code>BeanUtils</code> 类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BeanUtils</span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// --snip--</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Check if the given type represents a &quot;simple&quot; property: a simple value</span></span><br><span class="line"><span class="comment">	 * type or an array of simple value types.</span></span><br><span class="line"><span class="comment">	 * &lt;p&gt;See &#123;<span class="doctag">@link</span> #isSimpleValueType(Class)&#125; for the definition of &lt;em&gt;simple</span></span><br><span class="line"><span class="comment">	 * value type&lt;/em&gt;.</span></span><br><span class="line"><span class="comment">	 * &lt;p&gt;Used to determine properties to check for a &quot;simple&quot; dependency-check.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> type the type to check</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> whether the given type represents a &quot;simple&quot; property</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@see</span> org.springframework.beans.factory.support.RootBeanDefinition#DEPENDENCY_CHECK_SIMPLE</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@see</span> org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory#checkDependencies</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@see</span> #isSimpleValueType(Class)</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isSimpleProperty</span><span class="params">(Class&lt;?&gt; type)</span> &#123;</span><br><span class="line">		Assert.notNull(type, <span class="string">&quot;&#x27;type&#x27; must not be null&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> isSimpleValueType(type) || (type.isArray() &amp;&amp; isSimpleValueType(type.getComponentType()));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Check if the given type represents a &quot;simple&quot; value type: a primitive or</span></span><br><span class="line"><span class="comment">	 * primitive wrapper, an enum, a String or other CharSequence, a Number, a</span></span><br><span class="line"><span class="comment">	 * Date, a Temporal, a URI, a URL, a Locale, or a Class.</span></span><br><span class="line"><span class="comment">	 * &lt;p&gt;&#123;<span class="doctag">@code</span> Void&#125; and &#123;<span class="doctag">@code</span> void&#125; are not considered simple value types.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> type the type to check</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> whether the given type represents a &quot;simple&quot; value type</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@see</span> #isSimpleProperty(Class)</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isSimpleValueType</span><span class="params">(Class&lt;?&gt; type)</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> (Void.class != type &amp;&amp; <span class="keyword">void</span>.class != type &amp;&amp;</span><br><span class="line">				(ClassUtils.isPrimitiveOrWrapper(type) ||</span><br><span class="line">				Enum.class.isAssignableFrom(type) ||</span><br><span class="line">				CharSequence.class.isAssignableFrom(type) ||</span><br><span class="line">				Number.class.isAssignableFrom(type) ||</span><br><span class="line">				Date.class.isAssignableFrom(type) ||</span><br><span class="line">				Temporal.class.isAssignableFrom(type) ||</span><br><span class="line">				URI.class == type ||</span><br><span class="line">				URL.class == type ||</span><br><span class="line">				Locale.class == type ||</span><br><span class="line">				Class.class == type));</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// --snip--</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>通过源码分析得知，简单类型包括:</strong></p>
<p>基本数据类型、基本数据类型对应的包装类、<code>String</code> 或其他的 <code>CharSequence</code> 子类、<code>Number</code> 子类、<code>Date</code> 子类、<code>Enum</code> 子类、<code>URI</code> 、<code>URL</code> 、<code>Temporal</code> 子类、<code>Locale</code> 、<code>Class</code> 、另外还包括以上简单值类型对应的数组类型。</p>
<blockquote>
<p>测试Data类型</p>
</blockquote>
<p>a. 编写类：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SimpleValueType</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Date birth;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>b. 编写配置文件：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;svt&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.muyoukule.Bean.SimpleValueType&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--报错了，说1970-10-11这个字符串无法转换成java.util.Date类型。--&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--&lt;property name=&quot;birth&quot; value=&quot;1970-10-11&quot;/&gt;--&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--如果你硬要把Date当做简单类型的话，使用value赋值的话，这个日期字符串格式有要求--&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--在实际开发中，我们一般不会把Date当做简单类型，虽然它是简单类型。一般会采用ref给Date类型的属性赋值。--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;birth&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Wed Oct 19 16:28:13 CST 2022&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>c. 编写测试类：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSimpleTypeSet</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;date.xml&quot;</span>);</span><br><span class="line">    <span class="type">SimpleValueType</span> <span class="variable">svt</span> <span class="operator">=</span> applicationContext.getBean(<span class="string">&quot;svt&quot;</span>, SimpleValueType.class);</span><br><span class="line">    System.out.println(svt);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>d. 运行测试程序：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SimpleValueType(birth=Thu Oct 20 06:28:13 CST 2022)</span><br></pre></td></tr></table></figure>

<p><strong>需要注意的是：</strong></p>
<ul>
<li>如果把 <code>Date</code> 当做简单类型的话，日期字符串格式不能随便写。格式必须符合 <code>Date</code> 的 <code>toString()</code> 方法格式。显然这就比较鸡肋了。如果我们提供一个这样的日期字符串：2010-10-11，在这里是无法赋值给 <code>Date</code> 类型的属性的。</li>
<li>spring6之后，当注入的是 URL，那么这个 url 字符串是会进行有效性检测的。如果是一个存在的 url ，那就没问题。如果不存在则报错。</li>
<li>对于引用数据类型使用的是 <code>&lt;property name=&quot;&quot; ref=&quot;&quot;/&gt;</code></li>
<li>对于简单数据类型使用的是 <code>&lt;property name=&quot;&quot; value=&quot;&quot;/&gt;</code></li>
</ul>
<h3 id="2-3-4-级联属性赋值（了解）"><a href="#2-3-4-级联属性赋值（了解）" class="headerlink" title="2.3.4 级联属性赋值（了解）"></a>2.3.4 级联属性赋值（了解）</h3><p>a. 创建如下类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Clazz</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Student</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Clazz clazz;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>b. 编写配置文件</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;clazzBean&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.muyoukule.Bean.Clazz&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;student&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.muyoukule.Bean.Student&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;张三&quot;</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--要点1：以下两行配置的顺序不能颠倒--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;clazz&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;clazzBean&quot;</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--要点2：clazz属性必须有getter方法--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;clazz.name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;高三一班&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>c. 编写测试类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testCascade</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;spring-cascade.xml&quot;</span>);</span><br><span class="line">    <span class="type">Student</span> <span class="variable">student</span> <span class="operator">=</span> applicationContext.getBean(<span class="string">&quot;student&quot;</span>, Student.class);</span><br><span class="line">    System.out.println(student);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>d. 运行测试程序</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Student(name=张三, clazz=Clazz(name=高三一班))</span><br></pre></td></tr></table></figure>

<p><strong>要点：</strong></p>
<ul>
<li>在 spring 配置文件中，注意顺序，配置的顺序不能颠倒。</li>
<li>在 spring 配置文件中，<code>clazz</code> 属性必须提供 <code>getter</code> 方法。</li>
</ul>
<h3 id="2-3-5-注入数组"><a href="#2-3-5-注入数组" class="headerlink" title="2.3.5 注入数组"></a>2.3.5 注入数组</h3><blockquote>
<p>数组中的元素是简单类型</p>
</blockquote>
<p>a. 编写Person类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String[] favoriteFoods;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>b. <code>spring-array-simple.xml</code></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;person&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.zxq.bean.Person&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;favoriteFoods&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">array</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>鸡排<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>汉堡<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>鹅肝<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">array</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>c. 编写测试类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testArraySimple</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;spring-array-simple.xml&quot;</span>);</span><br><span class="line">    <span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> applicationContext.getBean(<span class="string">&quot;person&quot;</span>, Person.class);</span><br><span class="line">    System.out.println(person);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>d. 运行测试程序</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Person(favoriteFoods=[鸡排, 汉堡, 鹅肝])</span><br></pre></td></tr></table></figure>

<blockquote>
<p>数组中的元素是非简单类型</p>
</blockquote>
<p>a. 创建如下类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Goods</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Order</span> &#123;</span><br><span class="line">    <span class="comment">// 一个订单中有多个商品</span></span><br><span class="line">    <span class="keyword">private</span> Goods[] goods;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>b. <code>spring-array.xml</code></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;goods1&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.muyoukule.Bean.Goods&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;西瓜&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;goods2&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.muyoukule.Bean.Goods&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;苹果&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;order&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.muyoukule.Bean.Order&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;goods&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">array</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--这里使用ref标签即可--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">&quot;goods1&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">&quot;goods2&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">array</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>c. 编写测试类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testArray</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;spring-array.xml&quot;</span>);</span><br><span class="line">    <span class="type">Order</span> <span class="variable">order</span> <span class="operator">=</span> applicationContext.getBean(<span class="string">&quot;order&quot;</span>, Order.class);</span><br><span class="line">    System.out.println(order);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>d. 运行测试程序</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Order(goods=[Goods(name=西瓜), Goods(name=苹果)])</span><br></pre></td></tr></table></figure>

<p><strong>要点：</strong></p>
<ul>
<li>如果数组中是简单类型，使用 <code>value</code> 标签。</li>
<li>如果数组中是非简单类型，使用 <code>ref</code> 标签。</li>
</ul>
<h3 id="2-3-6-注入-List-集合、Set-集合、Map-集合、Properties"><a href="#2-3-6-注入-List-集合、Set-集合、Map-集合、Properties" class="headerlink" title="2.3.6 注入 List 集合、Set 集合、Map 集合、Properties"></a>2.3.6 注入 List 集合、Set 集合、Map 集合、Properties</h3><p> List 集合：有序可重复； Set 集合：无序不可重复。</p>
<p> <code>java.util.Properties</code> 继承 <code>java.util.Hashtable</code> ，所以 <code>Properties</code> 也是一个 Map 集合。</p>
<p>a. 创建如下类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">People</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; names;</span><br><span class="line">    <span class="keyword">private</span> Set&lt;String&gt; phones;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;Integer, String&gt; addrs;</span><br><span class="line">    <span class="keyword">private</span> Properties properties;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>b. <code>spring-collection.xml</code></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;peopleBean&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.muyoukule.Bean.People&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;names&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>铁锤<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>张三<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>张三<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>张三<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>狼<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;phones&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">set</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--非简单类型可以使用ref，简单类型使用value--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>110<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>110<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>120<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>120<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>119<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>119<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">set</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;addrs&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">map</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--如果key不是简单类型，使用 key-ref 属性--&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--如果value不是简单类型，使用 value-ref 属性--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">&quot;1&quot;</span> <span class="attr">value</span>=<span class="string">&quot;北京大兴区&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">&quot;2&quot;</span> <span class="attr">value</span>=<span class="string">&quot;上海浦东区&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">&quot;3&quot;</span> <span class="attr">value</span>=<span class="string">&quot;深圳宝安区&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">map</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;properties&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">props</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">&quot;driver&quot;</span>&gt;</span>com.mysql.cj.jdbc.Driver<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">&quot;url&quot;</span>&gt;</span>jdbc:mysql://localhost:3306/spring<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">&quot;username&quot;</span>&gt;</span>root<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">&quot;password&quot;</span>&gt;</span>123456<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">props</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>c. 编写测试类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testCollection</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;spring-collection.xml&quot;</span>);</span><br><span class="line">    <span class="type">People</span> <span class="variable">peopleBean</span> <span class="operator">=</span> applicationContext.getBean(<span class="string">&quot;peopleBean&quot;</span>, People.class);</span><br><span class="line">    System.out.println(peopleBean);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>d. 运行测试程序</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">People(names=[铁锤, 张三, 张三, 张三, 狼], phones=[110, 120, 119], addrs=&#123;1=北京大兴区, 2=上海浦东区, 3=深圳宝安区&#125;, properties=&#123;password=123456, driver=com.mysql.cj.jdbc.Driver, url=jdbc:mysql://localhost:3306/spring, username=root&#125;)</span><br></pre></td></tr></table></figure>

<p>注入 List  、Set 集合：</p>
<ul>
<li>使用 <list> 、<set> 标签</set></list></li>
<li>集合中元素是简单类型的使用 <code>value</code> 标签，反之使用 <code>ref</code> 标签。</li>
</ul>
<p>注入 Map 集合：</p>
<ul>
<li>使用 <map> 标签</map></li>
<li>如果 key 是简单类型，使用 key 属性，反之使用 <code>key-ref</code> 属性。</li>
<li>如果 value 是简单类型，使用 value 属性，反之使用 <code>value-ref</code> 属性。</li>
</ul>
<p>注入 Properties：</p>
<ul>
<li>使用 <code>props</code> 标签嵌套 <code>prop</code> 标签完成。</li>
</ul>
<h3 id="2-3-7-注入null和空字符串"><a href="#2-3-7-注入null和空字符串" class="headerlink" title="2.3.7 注入null和空字符串"></a>2.3.7 注入null和空字符串</h3><blockquote>
<p>注入空字符串使用：<value> 或者 value&#x3D;””</value></p>
</blockquote>
<p>a. 创建如下类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Vip</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String email;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>b. <code>spring-null.xml</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&lt;bean id=<span class="string">&quot;vipBean&quot;</span> class=<span class="string">&quot;com.muyoukule.Bean.Vip&quot;</span>&gt;</span><br><span class="line">    &lt;!--空串的第一种方式--&gt;</span><br><span class="line">&lt;!--    &lt;property name=<span class="string">&quot;email&quot;</span> value=<span class="string">&quot;&quot;</span>/&gt;--&gt;</span><br><span class="line">    &lt;!--空串的第二种方式--&gt;</span><br><span class="line">    &lt;property name=<span class="string">&quot;email&quot;</span>&gt;</span><br><span class="line">        &lt;value/&gt;</span><br><span class="line">    &lt;/property&gt;</span><br><span class="line">&lt;/bean&gt;</span><br></pre></td></tr></table></figure>

<p>c. 编写测试类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testNull</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;spring-null.xml&quot;</span>);</span><br><span class="line">    <span class="type">Vip</span> <span class="variable">vipBean</span> <span class="operator">=</span> applicationContext.getBean(<span class="string">&quot;vipBean&quot;</span>, Vip.class);</span><br><span class="line">    System.out.println(vipBean);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>d. 运行测试程序</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Vip(email=)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注入null使用：<null> 或者 不为该属性赋值</null></p>
</blockquote>
<p>a. 修改 <code>spring-null.xml</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&lt;!--第一种方式：不给属性赋值--&gt;</span><br><span class="line">&lt;!--&lt;bean id=<span class="string">&quot;vipBean&quot;</span> class=<span class="string">&quot;com.zxq.Bean.Vip&quot;</span>/&gt;--&gt;</span><br><span class="line">&lt;!--第二种方式：使用&lt;<span class="literal">null</span>/&gt;--&gt;</span><br><span class="line">&lt;bean id=<span class="string">&quot;vipBean&quot;</span> class=<span class="string">&quot;com.muyoukule.Bean.Vip&quot;</span>&gt;</span><br><span class="line">    &lt;property name=<span class="string">&quot;email&quot;</span>&gt;</span><br><span class="line">        &lt;<span class="literal">null</span>/&gt;</span><br><span class="line">    &lt;/property&gt;</span><br><span class="line">&lt;/bean&gt;</span><br></pre></td></tr></table></figure>

<p>b. 运行测试类</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Vip(email=null)</span><br></pre></td></tr></table></figure>

<h3 id="2-3-8-注入的值中含有特殊符号"><a href="#2-3-8-注入的值中含有特殊符号" class="headerlink" title="2.3.8 注入的值中含有特殊符号"></a>2.3.8 注入的值中含有特殊符号</h3><p>XML中有5个特殊字符，分别是：&lt; 、&gt; 、’ 、” 、&amp;</p>
<p>以上5个特殊符号在 XML 中会被特殊对待，会被当做 XML 语法的一部分进行解析，如果这些特殊符号直接出现在注入的字符串当中，会报错。</p>
<p>解决方案包括两种：</p>
<ul>
<li>第一种：特殊符号使用转义字符代替。</li>
<li>第二种：将含有特殊符号的字符串放到：&lt;![CDATA[]]&gt; 当中。因为放在CDATA区中的数据不会被XML文件解析器解析。</li>
</ul>
<p>5个特殊字符对应的转义字符分别是：</p>
<table>
<thead>
<tr>
<th align="center"><strong>特殊字符</strong></th>
<th align="center"><strong>转义字符</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="center">&gt;</td>
<td align="center">&amp;gt;</td>
</tr>
<tr>
<td align="center">&lt;</td>
<td align="center">&amp;lt;</td>
</tr>
<tr>
<td align="center">‘</td>
<td align="center">&amp;apos;</td>
</tr>
<tr>
<td align="center">“</td>
<td align="center">&amp;quot;</td>
</tr>
<tr>
<td align="center">&amp;</td>
<td align="center">&amp;amp;</td>
</tr>
</tbody></table>
<p>a. 创建如下类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Math</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>b. <code>spring-special.xml</code></p>
<blockquote>
<p>使用转义字符代替方式</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;mathBean&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.muyoukule.Bean.Math&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;result&quot;</span> <span class="attr">value</span>=<span class="string">&quot;2 <span class="symbol">&amp;lt;</span> 3&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>使用CDATA方式</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;mathBean&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.muyoukule.Bean.Math&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;result&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--只能使用value标签--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>&lt;![CDATA[2 &lt; 3]]&gt;<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>c. 编写测试类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSpecial</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//这里注意导入 Math 包的时候不要导成 java.lang.Math 了</span></span><br><span class="line">    <span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;spring-special.xml&quot;</span>);</span><br><span class="line">    <span class="type">Math</span> <span class="variable">mathBean</span> <span class="operator">=</span> applicationContext.getBean(<span class="string">&quot;mathBean&quot;</span>, Math.class);</span><br><span class="line">    System.out.println(mathBean);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>d. 运行测试类</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Math(result=2 &lt; 3)</span><br></pre></td></tr></table></figure>

<p>使用 CDATA 时，不能使用 <code>value</code> 属性，只能使用 <code>value</code> 标签。</p>
<h2 id="2-4-p命名空间注入"><a href="#2-4-p命名空间注入" class="headerlink" title="2.4 p命名空间注入"></a>2.4 p命名空间注入</h2><p>目的：简化配置。</p>
<p>p命名空间实际上是对 <code>set</code> 注入的简化。</p>
<p>使用p命名空间注入的前提条件包括两个：</p>
<ul>
<li>在XML头部信息中添加p命名空间的配置信息：xmlns:p&#x3D;”<a href="http://www.springframework.org/schema/p">http://www.springframework.org/schema/p</a>“</li>
<li>p命名空间注入是基于 setter 方法的，所以需要对应的属性提供setter方法。</li>
</ul>
<p>新建spting_003模块</p>
<p>a. 创建如下类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Customer</span> &#123;</span><br><span class="line">    <span class="comment">//p命名空间注入是基于setter方法的，所以需要对应的属性提供setter方法</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>b. <code>spring-p.xml</code></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:p</span>=<span class="string">&quot;http://www.springframework.org/schema/p&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;customerBean&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.muyoukule.Bean.Customer&quot;</span> <span class="attr">p:name</span>=<span class="string">&quot;zhangsan&quot;</span> <span class="attr">p:age</span>=<span class="string">&quot;20&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>c. 编写测试类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testP</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;spring-p.xml&quot;</span>);</span><br><span class="line">    <span class="type">Customer</span> <span class="variable">customerBean</span> <span class="operator">=</span> applicationContext.getBean(<span class="string">&quot;customerBean&quot;</span>, Customer.class);</span><br><span class="line">    System.out.println(customerBean);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>d. 运行测试类</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Customer(name=zhangsan, age=20)</span><br></pre></td></tr></table></figure>

<p>把 <code>setter</code> 方法去掉（注释掉 <code>@Setter</code> ）：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/accidence-spring/%E6%8A%8Asetter%E6%96%B9%E6%B3%95%E5%8E%BB%E6%8E%89.png"></p>
<h2 id="2-5-c命名空间注入"><a href="#2-5-c命名空间注入" class="headerlink" title="2.5 c命名空间注入"></a>2.5 c命名空间注入</h2><p>目的：简化配置。</p>
<p>c命名空间是简化构造方法注入的。</p>
<p>使用c命名空间的两个前提条件：</p>
<ul>
<li><p>需要在xml配置文件头部添加信息：xmlns:c&#x3D;”<a href="http://www.springframework.org/schema/c">http://www.springframework.org/schema/c</a>“</p>
</li>
<li><p>需要提供构造方法。</p>
</li>
</ul>
<p>a. 创建如下类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyTime</span> &#123;</span><br><span class="line">    <span class="comment">//需要提供构造方法</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> year;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> month;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> day;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>b. <code>spring-c.xml</code></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:c</span>=<span class="string">&quot;http://www.springframework.org/schema/c&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--&lt;bean id=&quot;myTimeBean&quot; class=&quot;com.muyoukule.Bean.MyTime&quot; c:year=&quot;1970&quot; c:month=&quot;1&quot; c:day=&quot;5&quot;/&gt;--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;myTimeBean&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.muyoukule.Bean.MyTime&quot;</span> <span class="attr">c:_0</span>=<span class="string">&quot;2008&quot;</span> <span class="attr">c:_1</span>=<span class="string">&quot;8&quot;</span> <span class="attr">c:_2</span>=<span class="string">&quot;8&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>c. 编写测试类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testC</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;spring-c.xml&quot;</span>);</span><br><span class="line">    <span class="type">MyTime</span> <span class="variable">myTimeBean</span> <span class="operator">=</span> applicationContext.getBean(<span class="string">&quot;myTimeBean&quot;</span>, MyTime.class);</span><br><span class="line">    System.out.println(myTimeBean);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>d. 运行测试类</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">MyTime(year=2008, month=8, day=8)</span><br></pre></td></tr></table></figure>

<p>把构造方法注释掉（注释掉 <code>@AllArgsConstructor</code> ）：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/accidence-spring/%E6%B3%A8%E9%87%8A%E6%8E%89@AllArgsConstructor%20.png"></p>
<p><strong>注意：不管是p命名空间还是c命名空间，注入的时候都可以注入简单类型以及非简单类型。</strong></p>
<h2 id="2-6-util命名空间"><a href="#2-6-util命名空间" class="headerlink" title="2.6 util命名空间"></a>2.6 util命名空间</h2><p>使用 util 命名空间可以让配置复用。</p>
<p>使用 util 命名空间的前提是：在spring配置文件头部添加配置信息。如下：</p>
<ul>
<li><p>xmlns:util&#x3D;”<a href="http://www.springframework.org/schema/util">http://www.springframework.org/schema/util</a>“</p>
</li>
<li><p><a href="http://www.springframework.org/schema/util">http://www.springframework.org/schema/util</a> <a href="http://www.springframework.org/schema/util/spring-util.xsd">http://www.springframework.org/schema/util/spring-util.xsd</a></p>
</li>
</ul>
<p>a. 创建如下类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyDataSource1</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Properties properties;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyDataSource2</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Properties properties;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>b. <code>spring-util.xml</code></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:util</span>=<span class="string">&quot;http://www.springframework.org/schema/util&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">                           http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">util:properties</span> <span class="attr">id</span>=<span class="string">&quot;prop&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">&quot;driver&quot;</span>&gt;</span>com.mysql.cj.jdbc.Driver<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">&quot;url&quot;</span>&gt;</span>jdbc:mysql://localhost:3306/spring<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">&quot;username&quot;</span>&gt;</span>root<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">&quot;password&quot;</span>&gt;</span>root<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">util:properties</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;dataSource1&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.muyoukule.Bean.MyDataSource1&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;properties&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;prop&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;dataSource2&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.muyoukule.Bean.MyDataSource2&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;properties&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;prop&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    </span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>c. 编写测试类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testUtil</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;spring-util.xml&quot;</span>);</span><br><span class="line">    <span class="type">MyDataSource1</span> <span class="variable">dataSource1</span> <span class="operator">=</span> applicationContext.getBean(<span class="string">&quot;dataSource1&quot;</span>, MyDataSource1.class);</span><br><span class="line">    System.out.println(dataSource1);</span><br><span class="line">    <span class="type">MyDataSource2</span> <span class="variable">dataSource2</span> <span class="operator">=</span> applicationContext.getBean(<span class="string">&quot;dataSource2&quot;</span>, MyDataSource2.class);</span><br><span class="line">    System.out.println(dataSource2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>d. 运行测试类</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">MyDataSource1(properties=&#123;password=root, driver=com.mysql.cj.jdbc.Driver, url=jdbc:mysql://localhost:3306/spring, username=root&#125;)</span><br><span class="line">MyDataSource2(properties=&#123;password=root, driver=com.mysql.cj.jdbc.Driver, url=jdbc:mysql://localhost:3306/spring, username=root&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="2-7-基于XML的自动装配"><a href="#2-7-基于XML的自动装配" class="headerlink" title="2.7 基于XML的自动装配"></a>2.7 基于XML的自动装配</h2><p>Spring还可以完成自动化的注入，自动化注入又被称为自动装配。它可以根据名字进行自动装配，也可以根据类型进行自动装配。</p>
<h3 id="2-7-1-根据名称自动装配"><a href="#2-7-1-根据名称自动装配" class="headerlink" title="2.7.1 根据名称自动装配"></a>2.7.1 根据名称自动装配</h3><p>a. 创建如下类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserDao</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">insert</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;正在保存用户数据...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> UserDao aaa;</span><br><span class="line">    <span class="comment">// 这个set方法非常关键</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAaa</span><span class="params">(UserDao aaa)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.aaa = aaa;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">save</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;UserService...&quot;</span>);</span><br><span class="line">        aaa.insert();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>b. <code>spring-autowire.xml</code></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--byName表示根据名字自动装配--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;userService&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.muyoukule.Service.UserService&quot;</span> <span class="attr">autowire</span>=<span class="string">&quot;byName&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;aaa&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.muyoukule.Dao.UserDao&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>这个配置起到关键作用：</p>
<ul>
<li>UserService Bean中需要添加 <code>autowire=&quot;byName&quot;</code>，表示通过名称进行装配。</li>
<li>UserService 类中有一个 UserDao 属性，而UserDao属性的名字是aaa，对应的 set 方法是 <code>setAaa()</code> ，正好和 UserDao Bean 的 id 是一样的。这就是根据名称自动装配。</li>
</ul>
<p>c. 编写测试类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testAutowireByName</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;spring-autowire.xml&quot;</span>);</span><br><span class="line">    <span class="type">UserService</span> <span class="variable">userService</span> <span class="operator">=</span> applicationContext.getBean(<span class="string">&quot;userService&quot;</span>, UserService.class);</span><br><span class="line">    userService.save();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>d. 运行测试类</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">UserService...</span><br><span class="line">正在保存用户数据...</span><br></pre></td></tr></table></figure>

<p>测试一下，<code>byName</code> 装配是和属性名有关还是和set方法名有关系：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> UserDao aaa;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// set方法名变化了</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setDao</span><span class="params">(UserDao aaa)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.aaa = aaa;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// --snip--</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>再执行测试程序</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/accidence-spring/aaa%E5%B1%9E%E6%80%A7%E8%B5%8B%E5%80%BC%E5%A4%B1%E8%B4%A5.png"></p>
<p>通过测试得知，aaa 属性并没有赋值成功。也就是并没有装配成功。</p>
<p>将 spring 配置文件修改以下：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--这个id修改了--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;dao&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.muyoukule.Dao.UserDao&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>执行测试程序</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">UserService...</span><br><span class="line">正在保存用户数据...</span><br></pre></td></tr></table></figure>

<p>这说明，如果根据名称装配(<code>byName</code>)，底层会调用 set 方法进行注入。</p>
<p>例如：<code>setAge()</code> 对应的名字是 age，<code>setPassword()</code> 对应的名字是 password，<code>setEmail()</code> 对应的名字是 email。</p>
<h3 id="2-7-2-根据类型自动装配"><a href="#2-7-2-根据类型自动装配" class="headerlink" title="2.7.2 根据类型自动装配"></a>2.7.2 根据类型自动装配</h3><p>a. 创建如下类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AccountDao</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">insert</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;正在保存账户信息...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AccountService</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> AccountDao accountDao;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAccountDao</span><span class="params">(AccountDao accountDao)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.accountDao = accountDao;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">save</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;AccountService...&quot;</span>);</span><br><span class="line">        accountDao.insert();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>b. <code>spring-autowire.xml</code></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--byType表示根据类型自动装配--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;accountService&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.muyoukule.Service.AccountService&quot;</span> <span class="attr">autowire</span>=<span class="string">&quot;byType&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;com.muyoukule.Dao.AccountDao&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>c. 编写测试类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testAutowireByType</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;spring-autowire.xml&quot;</span>);</span><br><span class="line">    <span class="type">AccountService</span> <span class="variable">accountService</span> <span class="operator">=</span> applicationContext.getBean(<span class="string">&quot;accountService&quot;</span>, AccountService.class);</span><br><span class="line">    accountService.save();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>d. 运行测试类</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">AccountService...</span><br><span class="line">正在保存账户信息...</span><br></pre></td></tr></table></figure>

<p>把 <code>AccountService</code> 中的 <code>set</code> 方法注释掉，再执行：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/accidence-spring/%E6%8A%8AAccountService%E4%B8%AD%E7%9A%84set%E6%96%B9%E6%B3%95%E6%B3%A8%E9%87%8A%E6%8E%89.png"></p>
<p>可以看到无论是 <code>byName</code> 还是 <code>byType</code> ，在装配的时候都是基于 <code>set</code> 方法的。所以 <code>set</code> 方法是必须要提供的。提供构造方法是不行的。</p>
<blockquote>
<p>如果 <code>byType</code>，根据类型装配时，如果配置文件中有两个类型一样的 <code>bean</code> 会出现什么问题呢？</p>
</blockquote>
<p>修改<code>spring-autowire.xml</code></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--byType表示根据类型自动装配--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;accountService&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.muyoukule.Service.AccountService&quot;</span> <span class="attr">autowire</span>=<span class="string">&quot;byType&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;x&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.muyoukule.Dao.AccountDao&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;y&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.muyoukule.Dao.AccountDao&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>显然当我们再配置文件中有两个类型一样的 <code>bean</code> 是idea也会进行提示：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/accidence-spring/%E6%8F%90%E7%A4%BA%E6%9C%89%E4%B8%A4%E4%B8%AA%E7%B1%BB%E5%9E%8B%E4%B8%80%E6%A0%B7%E7%9A%84%20bean.png"></p>
<p>执行测试程序</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/accidence-spring/%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E4%B8%AD%E6%9F%90%E7%A7%8D%E7%B1%BB%E5%9E%8B%E7%9A%84Bean%E4%B8%8D%E5%94%AF%E4%B8%80.png"></p>
<p>测试结果说明了，当 <code>byType</code> 进行自动装配的时候，配置文件中某种类型的 Bean 必须是唯一的，不能出现多个。</p>
<h2 id="2-8-Spring引入外部属性配置文件"><a href="#2-8-Spring引入外部属性配置文件" class="headerlink" title="2.8 Spring引入外部属性配置文件"></a>2.8 Spring引入外部属性配置文件</h2><p>我们都知道编写数据源的时候是需要连接数据库的信息的，例如：driver、url、username、password等信息。这些信息可以单独写到一个属性配置文件中。</p>
<p>新建spting_004模块</p>
<p>a. 创建如下类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyDataSource</span> <span class="keyword">implements</span> <span class="title class_">DataSource</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String driver;</span><br><span class="line">    <span class="keyword">private</span> String url;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// --snip--</span></span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>b. 在类路径下新建 <code>jdbc.properties</code> 文件，并配置信息</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">driver</span>=<span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line"><span class="attr">url</span>=<span class="string">jdbc:mysql://localhost:3306/spring</span></span><br><span class="line"><span class="attr">username</span>=<span class="string">root</span></span><br><span class="line"><span class="attr">password</span>=<span class="string">root</span></span><br></pre></td></tr></table></figure>

<p>c. 在 spring 配置文件中引入 <code>context</code> 命名空间，使用 <code>jdbc.properties</code> 文件</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">                           http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:property-placeholder</span> <span class="attr">location</span>=<span class="string">&quot;jdbc.properties&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;dataSource&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.muyoukule.Bean.MyDataSource&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;driver&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;driver&#125;&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;url&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;url&#125;&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;username&#125;&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;password&#125;&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>d. 测试程序</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testProperties</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;spring-properties.xml&quot;</span>);</span><br><span class="line">    <span class="type">MyDataSource</span> <span class="variable">dataSource</span> <span class="operator">=</span> applicationContext.getBean(<span class="string">&quot;dataSource&quot;</span>, MyDataSource.class);</span><br><span class="line">    System.out.println(dataSource);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>d. 运行测试类</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">MyDataSource(driver=com.mysql.cj.jdbc.Driver, url=jdbc:mysql://localhost:3306/spring, username=权, password=root)</span><br></pre></td></tr></table></figure>

<p>至此，读取 <code>properties</code> 配置文件中的内容就已经完成，但是在使用的时候，有些注意事项：</p>
<blockquote>
<p>键值对的key为 <code>username</code> 引发的问题</p>
</blockquote>
<p>在properties中配置键值对的时候，如果key设置为<code>username</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">username=root</span><br></pre></td></tr></table></figure>

<p>在 <code>spring-properties.xml</code> 注入该属性</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">context:property-placeholder</span> <span class="attr">location</span>=<span class="string">&quot;jdbc.properties&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;dataSource&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.muyoukule.Bean.MyDataSource&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;driver&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;driver&#125;&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;url&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;url&#125;&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;username&#125;&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;password&#125;&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>运行后，在控制台打印的却不是<code>root</code>，而是自己电脑的用户名。</p>
<p>出现问题的原因是 <code>&lt;context:property-placeholder/&gt;</code> 标签会加载系统的环境变量，而且环境变量的值会被优先加载，可以通过以下代码查看系统的环境变量：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    Map&lt;String, String&gt; env = System.getenv();</span><br><span class="line">    System.out.println(env);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>大家可以自行运行，在打印出来的结果中会有一个USERNAME&#x3D;XXX[自己电脑的用户名称]</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/accidence-spring/%E7%B3%BB%E7%BB%9F%E7%9A%84%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F.png"></p>
<p>两个解决方案：</p>
<ul>
<li>为 xml 文件的 <code>&lt;context:property-placeholder/&gt;</code> 标签添加 <code>system-properties-mode:</code> 属性并且设置为 NEVER ，表示不加载系统属性。</li>
<li>避免使用 <code>username</code> 作为属性的 <code>key</code> 。</li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">context:property-placeholder</span> <span class="attr">location</span>=<span class="string">&quot;jdbc.properties&quot;</span> <span class="attr">system-properties-mode</span>=<span class="string">&quot;NEVER&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>再次运行测试类</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">MyDataSource(driver=com.mysql.cj.jdbc.Driver, url=jdbc:mysql://localhost:3306/spring, username=root, password=root)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>当有多个properties配置文件需要被加载，该如何配置?</p>
</blockquote>
<p>a. 调整下配置文件的内容，在resources下添加 <code>jdbc.properties</code> ，<code>jdbc2.properties</code> ，内容如下:</p>
<p><code>jdbc.properties</code></p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">driver</span>=<span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line"><span class="attr">url</span>=<span class="string">jdbc:mysql://localhost:3306/spring</span></span><br><span class="line"><span class="attr">username</span>=<span class="string">root</span></span><br><span class="line"><span class="attr">password</span>=<span class="string">root</span></span><br></pre></td></tr></table></figure>

<p><code>jdbc2.properties</code></p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">username</span>=<span class="string">root666</span></span><br></pre></td></tr></table></figure>

<p>b. 修改 <code>spring-properties.xml</code></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--方式一 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">context:property-placeholder</span> <span class="attr">location</span>=<span class="string">&quot;jdbc.properties,jdbc2.properties&quot;</span> <span class="attr">system-properties-mode</span>=<span class="string">&quot;NEVER&quot;</span>/&gt;</span></span><br><span class="line"><span class="comment">&lt;!--方式二--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">context:property-placeholder</span> <span class="attr">location</span>=<span class="string">&quot;*.properties&quot;</span> <span class="attr">system-properties-mode</span>=<span class="string">&quot;NEVER&quot;</span>/&gt;</span></span><br><span class="line"><span class="comment">&lt;!--方式三 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">context:property-placeholder</span> <span class="attr">location</span>=<span class="string">&quot;classpath:*.properties&quot;</span> <span class="attr">system-properties-mode</span>=<span class="string">&quot;NEVER&quot;</span>/&gt;</span></span><br><span class="line"><span class="comment">&lt;!--方式四--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">context:property-placeholder</span> <span class="attr">location</span>=<span class="string">&quot;classpath*:*.properties&quot;</span> <span class="attr">system-properties-mode</span>=<span class="string">&quot;NEVER&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>说明:</strong></p>
<ul>
<li>方式一：可以实现，如果配置文件多的话，每个都需要配置</li>
<li>方式二：<code>*.properties</code> 代表所有以 properties 结尾的文件都会被加载，可以解决方式一的问题，但是不标准</li>
<li>方式三：标准的写法，<code>classpath: </code>代表的是从根路径下开始查找，但是只能查询当前项目的根路径</li>
<li>方式四：不仅可以加载当前项目还可以加载当前项目所依赖的所有项目的根路径下的 properties 配置文件</li>
</ul>
<h1 id="3-Bean的作用域"><a href="#3-Bean的作用域" class="headerlink" title="3. Bean的作用域"></a>3. Bean的作用域</h1><h2 id="3-1-singleton"><a href="#3-1-singleton" class="headerlink" title="3.1 singleton"></a>3.1 singleton</h2><blockquote>
<p>默认情况下，Spring 的 IoC 容器创建的 Bean 对象是单例的。</p>
</blockquote>
<p>a. 创建如下类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringBean</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>b. <code>spring-scope.xml</code></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;sb&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.muyoukule.Bean.SpringBean&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>c. 测试</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testScope</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;spring-scope.xml&quot;</span>);</span><br><span class="line">    <span class="type">SpringBean</span> <span class="variable">sb1</span> <span class="operator">=</span> applicationContext.getBean(<span class="string">&quot;sb&quot;</span>, SpringBean.class);</span><br><span class="line">    System.out.println(sb1);</span><br><span class="line">    <span class="type">SpringBean</span> <span class="variable">sb2</span> <span class="operator">=</span> applicationContext.getBean(<span class="string">&quot;sb&quot;</span>, SpringBean.class);</span><br><span class="line">    System.out.println(sb2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>d. 运行结果</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">com.muyoukule.Bean.SpringBean@5d066c7d</span><br><span class="line">com.muyoukule.Bean.SpringBean@5d066c7d</span><br></pre></td></tr></table></figure>

<p>通过测试得知：Spring的IoC容器中，默认情况下，Bean对象是单例的。</p>
<blockquote>
<p>这个对象在什么时候创建的呢？</p>
</blockquote>
<p>a. 为 <code>SpringBean</code> 提供一个无参数构造方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringBean</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SpringBean</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;SpringBean的无参数构造方法执行...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>b. 将测试程序中 <code>getBean()</code> 所在行代码注释掉，测试程序</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testScope</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;spring-scope.xml&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*        SpringBean sb1 = applicationContext.getBean(&quot;sb&quot;, SpringBean.class);</span></span><br><span class="line"><span class="comment">    System.out.println(sb1);</span></span><br><span class="line"><span class="comment">    SpringBean sb2 = applicationContext.getBean(&quot;sb&quot;, SpringBean.class);</span></span><br><span class="line"><span class="comment">    System.out.println(sb2);*/</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>c. 结果</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SpringBean的无参数构造方法执行...</span><br></pre></td></tr></table></figure>

<p>通过测试得知，默认情况下，Bean对象的创建是在初始化Spring上下文的时候就完成的。</p>
<h2 id="3-2-prototype"><a href="#3-2-prototype" class="headerlink" title="3.2 prototype"></a>3.2 prototype</h2><p>如果想让Spring的Bean对象以多例的形式存在，可以在 <code>bean</code> 标签中指定 <code>scope</code> 属性的值为：<strong>prototype</strong>，这样 Spring 会在每一次执行 <code>getBean()</code> 方法的时候创建Bean对象，调用几次则创建几次。</p>
<p>a. 修改 <code>spring-scope.xml</code></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;sb&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.muyoukule.Bean.SpringBean&quot;</span> <span class="attr">scope</span>=<span class="string">&quot;prototype&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>b. 测试程序</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">@Test</span><br><span class="line">public void testScope()&#123;</span><br><span class="line">    ApplicationContext applicationContext = new ClassPathXmlApplicationContext(&quot;spring-scope.xml&quot;);</span><br><span class="line"></span><br><span class="line">    SpringBean sb1 = applicationContext.getBean(&quot;sb&quot;, SpringBean.class);</span><br><span class="line">    System.out.println(sb1);</span><br><span class="line">    SpringBean sb2 = applicationContext.getBean(&quot;sb&quot;, SpringBean.class);</span><br><span class="line">    System.out.println(sb2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>c. 结果</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SpringBean的无参数构造方法执行...</span><br><span class="line">com.muyoukule.Bean.SpringBean@3adcc812</span><br><span class="line">SpringBean的无参数构造方法执行...</span><br><span class="line">com.muyoukule.Bean.SpringBean@35432107</span><br></pre></td></tr></table></figure>

<p>把测试代码中的 <code>getBean()</code> 方法所在行代码注释掉，执行测试，结果控制台无任何信息。</p>
<p><strong>默认情况下，Spring创建的 bean 对象都是单例的</strong></p>
<p>介绍完 <code>scope</code> 属性以后，我们来思考几个问题:</p>
<ul>
<li>为什么 bean 默认为单例?<ul>
<li>bean 为单例的意思是在 Spring 的 IOC 容器中只会有该类的一个对象</li>
<li>bean 对象只有一个就避免了对象的频繁创建与销毁，达到了 bean 对象的复用，性能高</li>
</ul>
</li>
<li>bean 在容器中是单例的，会不会产生线程安全问题?<ul>
<li>如果对象是有状态对象，即该对象有成员变量可以用来存储数据的，</li>
<li>因为所有请求线程共用一个 bean 对象，所以会存在线程安全问题。</li>
<li>如果对象是无状态对象，即该对象没有成员变量没有进行数据存储的，</li>
<li>因方法中的局部变量在方法调用完成后会被销毁，所以不会存在线程安全问题。</li>
</ul>
</li>
<li>哪些 bean 对象适合交给容器进行管理?<ul>
<li>表现层对象</li>
<li>业务层对象</li>
<li>数据层对象</li>
<li>工具对象</li>
</ul>
</li>
<li>哪些 bean 对象不适合交给容器进行管理?<ul>
<li>封装实例的域对象，因为会引发线程安全问题，所以不适合。</li>
</ul>
</li>
</ul>
<h2 id="3-3-其它scope"><a href="#3-3-其它scope" class="headerlink" title="3.3 其它scope"></a>3.3 其它scope</h2><p><strong>scope属性的值不止两个，它一共包括8个选项：</strong></p>
<ul>
<li>singleton：默认的，单例。</li>
<li>prototype：原型。每调用一次 <code>getBean()</code> 方法则获取一个新的Bean对象。或每次注入的时候都是新对象。</li>
<li>request：一个请求对应一个 Bean 。<strong>仅限于在WEB应用中使用</strong>。</li>
<li>session：一个会话对应一个 Bean 。<strong>仅限于在WEB应用中使用</strong>。</li>
<li>global session：<strong>portlet应用中专用的</strong>。如果在 Servlet 的 WEB 应用中使用 <code>global session</code> 的话，和 <code>session </code>一个效果。（portlet和servlet都是规范。servlet运行在servlet容器中，例如Tomcat。portlet运行在portlet容器中。）</li>
<li>application：一个应用对应一个 Bean 。<strong>仅限于在WEB应用中使用。</strong></li>
<li>websocket：一个 websocket 生命周期对应一个 Bean 。<strong>仅限于在WEB应用中使用。</strong></li>
<li>自定义scope：很少使用。</li>
</ul>
<h1 id="4-GoF之工厂模式"><a href="#4-GoF之工厂模式" class="headerlink" title="4. GoF之工厂模式"></a>4. GoF之工厂模式</h1><ul>
<li><p>设计模式：一种可以被重复利用的解决方案。</p>
</li>
<li><p>GoF（Gang of Four），中文名——四人组。</p>
</li>
<li><p>《Design Patterns: Elements of Reusable Object-Oriented Software》（即《设计模式》一书），1995年由 Erich Gamma、Richard Helm、Ralph Johnson 和 John Vlissides 合著。这几位作者常被称为”四人组（Gang of Four）”。</p>
</li>
<li><p>该书中描述了23种设计模式。我们平常所说的设计模式就是指这23种设计模式。</p>
</li>
<li><p>不过除了GoF23种设计模式之外，还有其它的设计模式，比如：JavaEE的设计模式（DAO模式、MVC模式等）。</p>
</li>
<li><p>GoF23种设计模式可分为三大类：</p>
<ul>
<li><strong>创建型</strong>（5个）：解决对象创建问题。<ul>
<li>单例模式</li>
<li>工厂方法模式</li>
<li>抽象工厂模式</li>
<li>建造者模式</li>
<li>原型模式</li>
</ul>
</li>
<li><strong>结构型</strong>（7个）：一些类或对象组合在一起的经典结构。<ul>
<li>代理模式</li>
<li>装饰模式</li>
<li>适配器模式</li>
<li>组合模式</li>
<li>享元模式</li>
<li>外观模式</li>
<li>桥接模式</li>
</ul>
</li>
<li><strong>行为型</strong>（11个）：解决类或对象之间的交互问题。<ul>
<li>策略模式</li>
<li>模板方法模式</li>
<li>责任链模式</li>
<li>观察者模式</li>
<li>迭代子模式</li>
<li>命令模式</li>
<li>备忘录模式</li>
<li>状态模式</li>
<li>访问者模式</li>
<li>中介者模式</li>
<li>解释器模式</li>
</ul>
</li>
</ul>
</li>
<li><p>工厂模式是解决对象创建问题的，所以工厂模式属于创建型设计模式。这里为什么学习工厂模式呢？这是因为 Spring 框架底层使用了大量的工厂模式。</p>
</li>
</ul>
<h2 id="4-1-工厂模式的三种形态"><a href="#4-1-工厂模式的三种形态" class="headerlink" title="4.1 工厂模式的三种形态"></a>4.1 工厂模式的三种形态</h2><p>工厂模式通常有三种形态：</p>
<ul>
<li>第一种：<strong>简单工厂模式（Simple Factory）：不属于23种设计模式之一。简单工厂模式又叫做：静态 工厂方法模式。简单工厂模式是工厂方法模式的一种特殊实现。</strong></li>
<li>第二种：工厂方法模式（Factory Method）：是23种设计模式之一。</li>
<li>第三种：抽象工厂模式（Abstract Factory）：是23种设计模式之一。</li>
</ul>
<h2 id="4-2-简单工厂模式"><a href="#4-2-简单工厂模式" class="headerlink" title="4.2 简单工厂模式"></a>4.2 简单工厂模式</h2><p>简单工厂模式的角色包括三个：</p>
<ul>
<li>抽象产品 角色</li>
<li>具体产品 角色</li>
<li>工厂类 角色</li>
</ul>
<p>简单工厂模式的代码如下：</p>
<p>抽象产品角色：Weapon</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">Weapon</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 所有的武器都有攻击行为</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">attack</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>具体产品角色：</p>
<p>Tank</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Tank</span> <span class="keyword">extends</span> <span class="title class_">Weapon</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">attack</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;坦克开炮！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Fighter</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Fighter</span> <span class="keyword">extends</span> <span class="title class_">Weapon</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">attack</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;战斗机投下原子弹！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Dagger</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Dagger</span> <span class="keyword">extends</span> <span class="title class_">Weapon</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">attack</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;砍他丫的！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>工厂类角色：</p>
<p>WeaponFactory</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WeaponFactory</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Weapon <span class="title function_">get</span><span class="params">(String weaponType)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (weaponType == <span class="literal">null</span> || weaponType.trim().length() == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">Weapon</span> <span class="variable">weapon</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;TANK&quot;</span>.equals(weaponType)) &#123;</span><br><span class="line">            weapon = <span class="keyword">new</span> <span class="title class_">Tank</span>();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;FIGHTER&quot;</span>.equals(weaponType)) &#123;</span><br><span class="line">            weapon = <span class="keyword">new</span> <span class="title class_">Fighter</span>();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;DAGGER&quot;</span>.equals(weaponType)) &#123;</span><br><span class="line">            weapon = <span class="keyword">new</span> <span class="title class_">Dagger</span>();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;不支持该武器！&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> weapon;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试程序（客户端程序）：</p>
<p>Client</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Client</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Weapon</span> <span class="variable">weapon1</span> <span class="operator">=</span> WeaponFactory.get(<span class="string">&quot;TANK&quot;</span>);</span><br><span class="line">        weapon1.attack();</span><br><span class="line"></span><br><span class="line">        <span class="type">Weapon</span> <span class="variable">weapon2</span> <span class="operator">=</span> WeaponFactory.get(<span class="string">&quot;FIGHTER&quot;</span>);</span><br><span class="line">        weapon2.attack();</span><br><span class="line"></span><br><span class="line">        <span class="type">Weapon</span> <span class="variable">weapon3</span> <span class="operator">=</span> WeaponFactory.get(<span class="string">&quot;DAGGER&quot;</span>);</span><br><span class="line">        weapon3.attack();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行结果</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">坦克开炮！</span><br><span class="line">战斗机投下原子弹！</span><br><span class="line">砍他丫的！</span><br></pre></td></tr></table></figure>

<p>简单工厂模式的优点：</p>
<ul>
<li>客户端程序不需要关心对象的创建细节，需要哪个对象时，只需要向工厂索要即可，初步实现了责任的分离。客户端只负责“消费”，工厂负责“生产”。生产和消费分离。</li>
</ul>
<p>简单工厂模式的缺点：</p>
<ul>
<li>缺点1：工厂类集中了所有产品的创造逻辑，形成一个无所不知的全能类，有人把它叫做上帝类。显然工厂类非常关键，不能出问题，一旦出问题，整个系统瘫痪。</li>
<li>缺点2：不符合OCP开闭原则，在进行系统扩展时，需要修改工厂类。</li>
</ul>
<p><strong>Spring中的BeanFactory就使用了简单工厂模式。</strong></p>
<h2 id="4-3-工厂方法模式"><a href="#4-3-工厂方法模式" class="headerlink" title="4.3 工厂方法模式"></a>4.3 工厂方法模式</h2><p>工厂方法模式既保留了简单工厂模式的优点，同时又解决了简单工厂模式的缺点。</p>
<p>工厂方法模式的角色包括：</p>
<ul>
<li><strong>抽象工厂角色</strong></li>
<li><strong>具体工厂角色</strong></li>
<li>抽象产品角色</li>
<li>具体产品角色</li>
</ul>
<p>代码如下：</p>
<p>抽象产品角色</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">Weapon</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 所有武器都有攻击行为</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">attack</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>具体产品角色</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Gun</span> <span class="keyword">extends</span> <span class="title class_">Weapon</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">attack</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;开枪射击！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">public class Fighter extends Weapon &#123;</span><br><span class="line">    @Override</span><br><span class="line">    public void attack() &#123;</span><br><span class="line">        System.out.println(&quot;战斗机发射核弹！&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>抽象工厂角色</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">WeaponFactory</span> &#123;</span><br><span class="line">    Weapon <span class="title function_">get</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>具体工厂角色</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GunFactory</span> <span class="keyword">implements</span> <span class="title class_">WeaponFactory</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Weapon <span class="title function_">get</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Gun</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FighterFactory</span> <span class="keyword">implements</span> <span class="title class_">WeaponFactory</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Weapon <span class="title function_">get</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Fighter</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>客户端程序</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Client</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">WeaponFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GunFactory</span>();</span><br><span class="line">        <span class="type">Weapon</span> <span class="variable">weapon</span> <span class="operator">=</span> factory.get();</span><br><span class="line">        weapon.attack();</span><br><span class="line"></span><br><span class="line">        <span class="type">WeaponFactory</span> <span class="variable">factory1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FighterFactory</span>();</span><br><span class="line">        <span class="type">Weapon</span> <span class="variable">weapon1</span> <span class="operator">=</span> factory1.get();</span><br><span class="line">        weapon1.attack();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行客户端程序</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">开枪射击！</span><br><span class="line">战斗机发射核弹</span><br></pre></td></tr></table></figure>

<p>如果想扩展一个新的产品，只要新增一个产品类，再新增一个该产品对应的工厂即可，例如新增：匕首。</p>
<p>增加：具体产品角色</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Dagger</span> <span class="keyword">extends</span> <span class="title class_">Weapon</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">attack</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;砍丫的！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>增加：具体工厂角色</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DaggerFactory</span> <span class="keyword">implements</span> <span class="title class_">WeaponFactory</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Weapon <span class="title function_">get</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Dagger</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>客户端程序</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Client</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">WeaponFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GunFactory</span>();</span><br><span class="line">        <span class="type">Weapon</span> <span class="variable">weapon</span> <span class="operator">=</span> factory.get();</span><br><span class="line">        weapon.attack();</span><br><span class="line"></span><br><span class="line">        <span class="type">WeaponFactory</span> <span class="variable">factory1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FighterFactory</span>();</span><br><span class="line">        <span class="type">Weapon</span> <span class="variable">weapon1</span> <span class="operator">=</span> factory1.get();</span><br><span class="line">        weapon1.attack();</span><br><span class="line"></span><br><span class="line">        <span class="type">WeaponFactory</span> <span class="variable">factory2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DaggerFactory</span>();</span><br><span class="line">        <span class="type">Weapon</span> <span class="variable">weapon2</span> <span class="operator">=</span> factory2.get();</span><br><span class="line">        weapon2.attack();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行结果如下</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">开枪射击！</span><br><span class="line">战斗机发射核弹！</span><br><span class="line">砍丫的！</span><br></pre></td></tr></table></figure>

<p>我们可以看到在进行功能扩展的时候，不需要修改之前的源代码，显然工厂方法模式符合OCP原则。</p>
<p>工厂方法模式的优点：</p>
<ul>
<li>一个调用者想创建一个对象，只要知道其名称就可以了。 </li>
<li>扩展性高，如果想增加一个产品，只要扩展一个工厂类就可以。</li>
<li>屏蔽产品的具体实现，调用者只关心产品的接口。</li>
</ul>
<p>工厂方法模式的缺点：</p>
<ul>
<li>每次增加一个产品时，都需要增加一个具体类和对象实现工厂，使得系统中类的个数成倍增加，在一定程度上增加了系统的复杂度，同时也增加了系统具体类的依赖。这并不是什么好事。</li>
</ul>
<h1 id="5-Bean的实例化方式"><a href="#5-Bean的实例化方式" class="headerlink" title="5. Bean的实例化方式"></a>5. Bean的实例化方式</h1><p>Spring为Bean提供了多种实例化方式，通常包括4种方式。（也就是说在 Spring 中为 Bean 对象的创建准备了多种方案，目的是：更加灵活）</p>
<ul>
<li>第一种：通过构造方法实例化</li>
<li>第二种：通过简单工厂模式实例化</li>
<li>第三种：通过 <code>factory-bean</code> 实例化</li>
<li>第四种：通过 <code>FactoryBean</code> 接口实例化</li>
</ul>
<h2 id="5-1-通过构造方法实例化"><a href="#5-1-通过构造方法实例化" class="headerlink" title="5.1 通过构造方法实例化"></a>5.1 通过构造方法实例化</h2><p>我们之前一直使用的就是这种方式。默认情况下，会调用 Bean 的无参数构造方法。</p>
<p>a. 创建如下类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">User</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;User类的无参数构造方法执行...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>b. <code>spring.xml</code></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;userBean&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.muyoukule.Bean.User&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>c. 测试</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testConstructor</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;spring.xml&quot;</span>);</span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> applicationContext.getBean(<span class="string">&quot;userBean&quot;</span>, User.class);</span><br><span class="line">    System.out.println(user);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>d. 结果</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">User类的无参数构造方法执行...</span><br><span class="line">com.muyoukule.Bean.User@5d066c7d</span><br></pre></td></tr></table></figure>

<h2 id="5-2-通过简单工厂模式实例化"><a href="#5-2-通过简单工厂模式实例化" class="headerlink" title="5.2 通过简单工厂模式实例化"></a>5.2 通过简单工厂模式实例化</h2><p>a. 创建如下类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Vip</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>b. 编写简单工厂模式当中的工厂类</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">public class VipFactory &#123;</span><br><span class="line">    public static Vip get() &#123;</span><br><span class="line">        return new Vip();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>c. 在 Spring 配置文件中指定创建该 Bean 的方法（使用 <code>factory-method</code> 属性指定）</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;vipBean&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.muyoukule.Bean.VipFactory&quot;</span> <span class="attr">factory-method</span>=<span class="string">&quot;get&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>d. 编写测试程序</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSimpleFactory</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;spring.xml&quot;</span>);</span><br><span class="line">    <span class="type">Vip</span> <span class="variable">vip</span> <span class="operator">=</span> applicationContext.getBean(<span class="string">&quot;vipBean&quot;</span>, Vip.class);</span><br><span class="line">    System.out.println(vip);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>e. 执行结果</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">com.muyoukule.Bean.Vip@54e7df6a</span><br></pre></td></tr></table></figure>

<h2 id="5-3-通过factory-bean实例化"><a href="#5-3-通过factory-bean实例化" class="headerlink" title="5.3 通过factory-bean实例化"></a>5.3 通过factory-bean实例化</h2><p>这种方式本质上是：通过工厂方法模式进行实例化。</p>
<p>a. 创建如下类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Order</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>b. 定义具体工厂类，工厂类中定义实例方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderFactory</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> Order <span class="title function_">get</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Order</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>c. 在 Spring 配置文件中指定 <code>factory-bean</code> 以及 <code>factory-method</code></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;orderFactory&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.muyoukule.Bean.OrderFactory&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;orderBean&quot;</span> <span class="attr">factory-bean</span>=<span class="string">&quot;orderFactory&quot;</span> <span class="attr">factory-method</span>=<span class="string">&quot;get&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>d. 编写测试程序</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSelfFactoryBean</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;spring.xml&quot;</span>);</span><br><span class="line">    <span class="type">Order</span> <span class="variable">orderBean</span> <span class="operator">=</span> applicationContext.getBean(<span class="string">&quot;orderBean&quot;</span>, Order.class);</span><br><span class="line">    System.out.println(orderBean);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>e. 执行结果</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">com.muyoukule.Bean.Order@32c4e8b2</span><br></pre></td></tr></table></figure>

<h2 id="5-4-通过FactoryBean接口实例化"><a href="#5-4-通过FactoryBean接口实例化" class="headerlink" title="5.4 通过FactoryBean接口实例化"></a>5.4 通过FactoryBean接口实例化</h2><p>以上的第三种方式中，<code>factory-bean</code> 是我们自定义的，<code>factory-method</code> 也是我们自己定义的。</p>
<p>在Spring中，当你编写的类直接实现 <code>FactoryBean</code> 接口之后，<code>factory-bean</code> 不需要指定了，f<code>actory-method</code> 也不需要指定了。</p>
<p><code>factory-bean</code> 会自动指向实现 <code>FactoryBean</code> 接口的类，<code>factory-method</code> 会自动指向 <code>getObject()</code> 方法。</p>
<p>a. 创建如下类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>b. 编写一个类实现 <code>FactoryBean</code> 接口</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PersonFactoryBean</span> <span class="keyword">implements</span> <span class="title class_">FactoryBean</span>&lt;Person&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Person <span class="title function_">getObject</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Person</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Class&lt;?&gt; getObjectType() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isSingleton</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// true表示单例</span></span><br><span class="line">        <span class="comment">// false表示原型</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>c. 在 Spring 配置文件中配置 <code>FactoryBean</code></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;personBean&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.muyoukule.Bean.PersonFactoryBean&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>d. 测试程序</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testFactoryBean</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;spring.xml&quot;</span>);</span><br><span class="line">    <span class="type">Person</span> <span class="variable">personBean</span> <span class="operator">=</span> applicationContext.getBean(<span class="string">&quot;personBean&quot;</span>, Person.class);</span><br><span class="line">    System.out.println(personBean);</span><br><span class="line">    <span class="type">Person</span> <span class="variable">personBean2</span> <span class="operator">=</span> applicationContext.getBean(<span class="string">&quot;personBean&quot;</span>, Person.class);</span><br><span class="line">    System.out.println(personBean2);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>e. 执行结果</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">com.muyoukule.Bean.Person@4f0100a7</span><br><span class="line">com.muyoukule.Bean.Person@4f0100a7</span><br></pre></td></tr></table></figure>

<h2 id="5-5-BeanFactory和FactoryBean的区别"><a href="#5-5-BeanFactory和FactoryBean的区别" class="headerlink" title="5.5 BeanFactory和FactoryBean的区别"></a>5.5 BeanFactory和FactoryBean的区别</h2><blockquote>
<p>BeanFactory</p>
</blockquote>
<p>Spring IoC 容器的顶级对象，<code>BeanFactory</code> 被翻译为 “Bean工厂” ，在 Spring 的 IoC 容器中，“Bean工厂” 负责创建 Bean 对象。</p>
<p>BeanFactory 是工厂。</p>
<blockquote>
<p>FactoryBean</p>
</blockquote>
<p>FactoryBean：它是一个 Bean，是一个能够<strong>辅助Spring</strong>实例化其它 Bean 对象的一个 Bean 。</p>
<p>在Spring中，Bean可以分为两类：</p>
<ul>
<li>第一类：普通Bean</li>
<li>第二类：工厂 Bean（记住：工厂 Bean 也是一种 Bean，只不过这种 Bean 比较特殊，它可以辅助 Spring 实例化其它 Bean 对象。）</li>
</ul>
<h2 id="5-6-注入自定义Date"><a href="#5-6-注入自定义Date" class="headerlink" title="5.6 注入自定义Date"></a>5.6 注入自定义Date</h2><p>我们前面说过，<code>java.util.Date</code> 在 Spring 中被当做简单类型，简单类型在注入的时候可以直接使用 value 属性或 value 标签来完成。但我们之前已经测试过了，对于Date类型来说，采用 value 属性或 value 标签赋值的时候，对日期字符串的格式要求非常严格，必须是这种格式的：Mon Oct 10 14:30:26 CST 2022。其他格式是不会被识别的。</p>
<p>a. 创建如下类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Student</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Date birth;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>b. <code>spring-data.xml</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&lt;bean id=<span class="string">&quot;studentBean&quot;</span> class=<span class="string">&quot;com.muyoukule.Bean.Student&quot;</span>&gt;</span><br><span class="line">    &lt;property name=<span class="string">&quot;birth&quot;</span> value=<span class="string">&quot;Mon Oct 10 14:30:26 CST 2002&quot;</span>/&gt;</span><br><span class="line">&lt;/bean&gt;</span><br></pre></td></tr></table></figure>

<p>c. 测试程序</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testDate</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;spring-data.xml&quot;</span>);</span><br><span class="line">    <span class="type">Student</span> <span class="variable">studentBean</span> <span class="operator">=</span> applicationContext.getBean(<span class="string">&quot;studentBean&quot;</span>, Student.class);</span><br><span class="line">    System.out.println(studentBean);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>d. 执行结果</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Student(birth=Fri Oct 11 04:30:26 CST 2002)</span><br></pre></td></tr></table></figure>

<p>如果把日期格式修改一下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&lt;bean id=<span class="string">&quot;studentBean&quot;</span> class=<span class="string">&quot;com.muyoukule.Bean.Student&quot;</span>&gt;</span><br><span class="line">    &lt;property name=<span class="string">&quot;birth&quot;</span> value=<span class="string">&quot;2002-10-10&quot;</span>/&gt;</span><br><span class="line">&lt;/bean&gt;</span><br></pre></td></tr></table></figure>

<p>执行结果</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/accidence-spring/%E6%97%A5%E6%9C%9F%E6%A0%BC%E5%BC%8F%E9%94%99%E8%AF%AF.png"></p>
<p>这种情况下，我们就可以使用 <code>FactoryBean</code> 来完成这个操作。</p>
<p>a. 编写 <code>DateFactoryBean</code> 实现 <code>FactoryBean</code> 接口</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DateFactoryBean</span> <span class="keyword">implements</span> <span class="title class_">FactoryBean</span>&lt;Date&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 定义属性接收日期字符串</span></span><br><span class="line">    <span class="keyword">private</span> String date;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 通过构造方法给日期字符串属性赋值</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">DateFactoryBean</span><span class="params">(String date)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.date = date;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Date <span class="title function_">getObject</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">SimpleDateFormat</span> <span class="variable">sdf</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;yyyy-MM-dd&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> sdf.parse(<span class="built_in">this</span>.date);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Class&lt;?&gt; getObjectType() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>b. 编写spring配置文件</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;dateBean&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.muyoukule.Bean.DateFactoryBean&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">name</span>=<span class="string">&quot;date&quot;</span> <span class="attr">value</span>=<span class="string">&quot;1999-10-11&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;studentBean&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.muyoukule.Bean.Student&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;birth&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;dateBean&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>c. 执行测试程序</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Student(birth=Mon Oct 11 00:00:00 CST 1999)</span><br></pre></td></tr></table></figure>

<h1 id="6-Bean的生命周期"><a href="#6-Bean的生命周期" class="headerlink" title="6. Bean的生命周期"></a>6. Bean的生命周期</h1><h2 id="6-1-什么是Bean的生命周期"><a href="#6-1-什么是Bean的生命周期" class="headerlink" title="6.1 什么是Bean的生命周期"></a>6.1 什么是Bean的生命周期</h2><p>Spring其实就是一个管理Bean对象的工厂。它负责对象的创建，对象的销毁等。</p>
<p>所谓的生命周期就是：对象从创建开始到最终销毁的整个过程。</p>
<p>什么时候创建Bean对象？</p>
<p>创建Bean对象的前后会调用什么方法？</p>
<p>Bean对象什么时候销毁？</p>
<p>Bean对象的销毁前后调用什么方法？</p>
<h2 id="6-2-为什么要知道Bean的生命周期"><a href="#6-2-为什么要知道Bean的生命周期" class="headerlink" title="6.2 为什么要知道Bean的生命周期"></a>6.2 为什么要知道Bean的生命周期</h2><p>其实生命周期的本质是：在哪个时间节点上调用了哪个类的哪个方法。</p>
<p>我们需要充分的了解在这个生命线上，都有哪些特殊的时间节点。</p>
<p>只有我们知道了特殊的时间节点都在哪，到时我们才可以确定代码写到哪。</p>
<p>我们可能需要在某个特殊的时间点上执行一段特定的代码，这段代码就可以放到这个节点上。当生命线走到这里的时候，自然会被调用。</p>
<h2 id="6-3-Bean的生命周期之5步"><a href="#6-3-Bean的生命周期之5步" class="headerlink" title="6.3 Bean的生命周期之5步"></a>6.3 Bean的生命周期之5步</h2><p>Bean 生命周期的管理，可以参考Spring的源码：<code>AbstractAutowireCapableBeanFactory</code> 类的 <code>doCreateBean()</code> 方法</p>
<p>Bean 生命周期可以粗略的划分为五大步：</p>
<ul>
<li>第一步：实例化Bean</li>
<li>第二步：Bean属性赋值</li>
<li>第三步：初始化Bean</li>
<li>第四步：使用Bean</li>
<li>第五步：销毁Bean</li>
</ul>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/accidence-spring/Bean%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E4%B9%8B5%E6%AD%A5.png"></p>
<p>编写测试程序：</p>
<p>a. 创建如下类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">User</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;1.实例化Bean&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">        System.out.println(<span class="string">&quot;2.Bean属性赋值&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initBean</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;3.初始化Bean&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroyBean</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;5.销毁Bean&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>b. <code>spring.xml</code></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--init-method属性指定初始化方法。destroy-method属性指定销毁方法。--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;userBean&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.muyoukule.Bean.User&quot;</span> <span class="attr">init-method</span>=<span class="string">&quot;initBean&quot;</span> <span class="attr">destroy-method</span>=<span class="string">&quot;destroyBean&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;zhangsan&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>c. 测试程序</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testLifecycle</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;spring.xml&quot;</span>);</span><br><span class="line">    <span class="type">User</span> <span class="variable">userBean</span> <span class="operator">=</span> applicationContext.getBean(<span class="string">&quot;userBean&quot;</span>, User.class);</span><br><span class="line">    System.out.println(<span class="string">&quot;4.使用Bean&quot;</span>);</span><br><span class="line">    <span class="comment">// 只有正常关闭spring容器才会执行销毁方法</span></span><br><span class="line">    <span class="type">ClassPathXmlApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> (ClassPathXmlApplicationContext) applicationContext;</span><br><span class="line">    context.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>d. 执行结果</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1.实例化Bean</span><br><span class="line">2.Bean属性赋值</span><br><span class="line">3.初始化Bean</span><br><span class="line">4.使用Bean</span><br><span class="line">5.销毁Bean</span><br></pre></td></tr></table></figure>

<p>需要注意的：</p>
<ul>
<li>第一：只有正常关闭 spring 容器，bean 的销毁方法才会被调用。</li>
<li>第二：<code>ClassPathXmlApplicationContext</code> 类才有 close() 方法。</li>
<li>第三：配置文件中的 <code>init-method</code> 指定初始化方法。 <code>destroy-method</code> 指定销毁方法。</li>
</ul>
<h2 id="6-4-Bean生命周期之7步"><a href="#6-4-Bean生命周期之7步" class="headerlink" title="6.4 Bean生命周期之7步"></a>6.4 Bean生命周期之7步</h2><p>在以上的5步中，第3步是初始化 Bean ，如果你还想在初始化前和初始化后添加代码，可以加入“ Bean 后处理器”。</p>
<p>a. 编写一个类实现 <code>BeanPostProcessor</code> 类，并且重写 <code>before</code> 和 <code>after</code> 方法：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LogBeanPostProcessor</span> <span class="keyword">implements</span> <span class="title class_">BeanPostProcessor</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">postProcessBeforeInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Bean后处理器的before方法执行，即将开始初始化&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">postProcessAfterInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Bean后处理器的after方法执行，已完成初始化&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>b. 在 <code>spring.xml</code> 文件中配置“ Bean 后处理器”：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--init-method属性指定初始化方法。destroy-method属性指定销毁方法。--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;userBean&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.muyoukule.Bean.User&quot;</span> <span class="attr">init-method</span>=<span class="string">&quot;initBean&quot;</span> <span class="attr">destroy-method</span>=<span class="string">&quot;destroyBean&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;zhangsan&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--配置Bean后处理器。这个后处理器将作用于当前配置文件中所有的bean。--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;com.muyoukule.Bean.LogBeanPostProcessor&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>一定要注意：在 <code>spring.xml</code> 文件中配置的 Bean 后处理器将作用于当前配置文件中所有的 Bean 。</p>
<p>c. 执行测试程序</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1.实例化Bean</span><br><span class="line">2.Bean属性赋值</span><br><span class="line">Bean后处理器的before方法执行，即将开始初始化</span><br><span class="line">3.初始化Bean</span><br><span class="line">Bean后处理器的after方法执行，已完成初始化</span><br><span class="line">4.使用Bean</span><br><span class="line">5.销毁Bean</span><br></pre></td></tr></table></figure>

<h2 id="6-5-Bean生命周期之10步"><a href="#6-5-Bean生命周期之10步" class="headerlink" title="6.5 Bean生命周期之10步"></a>6.5 Bean生命周期之10步</h2><p>如果根据源码跟踪，可以划分更细粒度的步骤，10步：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/accidence-spring/Bean%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E4%B9%8B10%E6%AD%A5.png"></p>
<p>上图中检查 Bean 是否实现了 <code>Aware</code> 的相关接口是什么意思？</p>
<p>Aware 相关的接口包括：<code>BeanNameAware</code> 、<code>BeanClassLoaderAware</code> 、<code>BeanFactoryAware</code></p>
<ul>
<li>当Bean实现了 <code>BeanNameAware</code> ，Spring 会将 Bean 的名字传递给 Bean。</li>
<li>当Bean实现了 <code>BeanClassLoaderAware</code> ，Spring 会将加载该 Bean 的类加载器传递给 Bean。</li>
<li>当Bean实现了 <code>BeanFactoryAware</code> ，Spring会将 Bean 工厂对象传递给 Bean。</li>
</ul>
<p>测试以上10步，可以让 User类实现5个接口，并实现所有方法：</p>
<ul>
<li>BeanNameAware</li>
<li>BeanClassLoaderAware</li>
<li>BeanFactoryAware</li>
<li>InitializingBean</li>
<li>DisposableBean</li>
</ul>
<p>a. 代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> <span class="keyword">implements</span> <span class="title class_">BeanNameAware</span>, BeanClassLoaderAware, BeanFactoryAware, InitializingBean, DisposableBean &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">User</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;1.实例化Bean&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">        System.out.println(<span class="string">&quot;2.Bean属性赋值&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initBean</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;6.初始化Bean&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroyBean</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;10.销毁Bean&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setBeanClassLoader</span><span class="params">(ClassLoader classLoader)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;3.类加载器：&quot;</span> + classLoader);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setBeanFactory</span><span class="params">(BeanFactory beanFactory)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;3.Bean工厂：&quot;</span> + beanFactory);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setBeanName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;3.bean名字：&quot;</span> + name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;9.DisposableBean destroy&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;5.afterPropertiesSet执行&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>b. <code>LogBeanPostProcessor</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LogBeanPostProcessor</span> <span class="keyword">implements</span> <span class="title class_">BeanPostProcessor</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">postProcessBeforeInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;4.Bean后处理器的before方法执行，即将开始初始化&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">postProcessAfterInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;7.Bean后处理器的after方法执行，已完成初始化&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>c. 测试</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testLifecycle</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;spring.xml&quot;</span>);</span><br><span class="line">    <span class="type">User</span> <span class="variable">userBean</span> <span class="operator">=</span> applicationContext.getBean(<span class="string">&quot;userBean&quot;</span>, User.class);</span><br><span class="line">    System.out.println(<span class="string">&quot;8.使用Bean&quot;</span>);</span><br><span class="line">    <span class="comment">// 只有正常关闭spring容器才会执行销毁方法</span></span><br><span class="line">    <span class="type">ClassPathXmlApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> (ClassPathXmlApplicationContext) applicationContext;</span><br><span class="line">    context.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>d. 执行结果</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1.实例化Bean</span><br><span class="line">2.Bean属性赋值</span><br><span class="line">3.bean名字：userBean</span><br><span class="line">3.类加载器：jdk.internal.loader.ClassLoaders$AppClassLoader@63947c6b</span><br><span class="line">3.Bean工厂：org.springframework.beans.factory.support.DefaultListableBeanFactory@1bae316d: defining beans [userBean,com.muyoukule.Bean.LogBeanPostProcessor#0]; root of factory hierarchy</span><br><span class="line">4.Bean后处理器的before方法执行，即将开始初始化</span><br><span class="line">5.afterPropertiesSet执行</span><br><span class="line">6.初始化Bean</span><br><span class="line">7.Bean后处理器的after方法执行，已完成初始化</span><br><span class="line">8.使用Bean</span><br><span class="line">9.DisposableBean destroy</span><br><span class="line">10.销毁Bean</span><br></pre></td></tr></table></figure>

<p>通过测试可以看出来：</p>
<ul>
<li><code>InitializingBean</code> 的方法早于 <code>init-method</code> 的执行。</li>
<li><code>DisposableBean</code> 的方法早于 <code>destroy-method</code> 的执行。</li>
</ul>
<h2 id="6-6-Bean的作用域不同，管理方式不同"><a href="#6-6-Bean的作用域不同，管理方式不同" class="headerlink" title="6.6 Bean的作用域不同，管理方式不同"></a>6.6 Bean的作用域不同，管理方式不同</h2><p>Spring 根据 Bean 的作用域来选择管理方式。</p>
<ul>
<li>对于 <code>singleton</code> 作用域的 Bean，Spring 能够精确地知道该 Bean 何时被创建，何时初始化完成，以及何时被销毁；</li>
<li>而对于 <code>prototype</code> 作用域的 Bean，Spring 只负责创建，当容器创建了 Bean 的实例后，Bean 的实例就交给客户端代码管理，Spring 容器将不再跟踪其生命周期。</li>
</ul>
<p>a. 把之前User类的spring.xml文件中的配置 scope 设置为 <code>prototype</code></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--init-method属性指定初始化方法。destroy-method属性指定销毁方法。--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;userBean&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.muyoukule.Bean.User&quot;</span> <span class="attr">init-method</span>=<span class="string">&quot;initBean&quot;</span> <span class="attr">destroy-method</span>=<span class="string">&quot;destroyBean&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">scope</span>=<span class="string">&quot;prototype&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;zhangsan&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>b. 执行测试程序</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1.实例化Bean</span><br><span class="line">2.Bean属性赋值</span><br><span class="line">3.bean名字：userBean</span><br><span class="line">3.类加载器：jdk.internal.loader.ClassLoaders$AppClassLoader@63947c6b</span><br><span class="line">3.Bean工厂：org.springframework.beans.factory.support.DefaultListableBeanFactory@1bae316d: defining beans [userBean,com.muyoukule.Bean.LogBeanPostProcessor#0]; root of factory hierarchy</span><br><span class="line">4.Bean后处理器的before方法执行，即将开始初始化</span><br><span class="line">5.afterPropertiesSet执行</span><br><span class="line">6.初始化Bean</span><br><span class="line">7.Bean后处理器的after方法执行，已完成初始化</span><br><span class="line">8.使用Bean</span><br></pre></td></tr></table></figure>

<p>通过测试一目了然。只执行了前8步，第9和10都没有执行。</p>
<h2 id="6-7-自己new的对象如何让Spring管理"><a href="#6-7-自己new的对象如何让Spring管理" class="headerlink" title="6.7 自己new的对象如何让Spring管理"></a>6.7 自己new的对象如何让Spring管理</h2><p>有些时候可能会遇到这样的需求，某个java对象是我们自己new的，然后我们希望这个对象被Spring容器管理，怎么实现？</p>
<p>a. 创建如下类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Student</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>b. 测试</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testBeanRegister</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 自己new的对象</span></span><br><span class="line">    <span class="type">Student</span> <span class="variable">student</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Student</span>();</span><br><span class="line">    System.out.println(student);</span><br><span class="line">    <span class="comment">// 创建 默认可列表BeanFactory 对象</span></span><br><span class="line">    <span class="type">DefaultListableBeanFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultListableBeanFactory</span>();</span><br><span class="line">    <span class="comment">// 注册Bean</span></span><br><span class="line">    factory.registerSingleton(<span class="string">&quot;studentBean&quot;</span>, student);</span><br><span class="line">    <span class="comment">// 从spring容器中获取bean</span></span><br><span class="line">    <span class="type">Student</span> <span class="variable">studentBean</span> <span class="operator">=</span> factory.getBean(<span class="string">&quot;studentBean&quot;</span>, Student.class);</span><br><span class="line">    System.out.println(studentBean);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>c. 结果</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">com.muyoukule.Bean.Student@6bdf28bb</span><br><span class="line">com.muyoukule.Bean.Student@6bdf28bb</span><br></pre></td></tr></table></figure>

<h1 id="7-Bean的循环依赖问题"><a href="#7-Bean的循环依赖问题" class="headerlink" title="7. Bean的循环依赖问题"></a>7. Bean的循环依赖问题</h1><h2 id="7-1-什么是Bean的循环依赖"><a href="#7-1-什么是Bean的循环依赖" class="headerlink" title="7.1 什么是Bean的循环依赖"></a>7.1 什么是Bean的循环依赖</h2><p>A对象中有B属性。B对象中有A属性。这就是循环依赖。我依赖你，你也依赖我。</p>
<p>比如：丈夫类Husband，妻子类Wife。Husband中有Wife的引用。Wife中有Husband的引用。</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/accidence-spring/Bean%E7%9A%84%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%96.png"></p>
<p>Husband</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Husband</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Wife wife;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Wife</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Wife</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Husband husband;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="7-2-singleton下的set注入产生的循环依赖"><a href="#7-2-singleton下的set注入产生的循环依赖" class="headerlink" title="7.2 singleton下的set注入产生的循环依赖"></a>7.2 singleton下的set注入产生的循环依赖</h2><p>我们来编写程序，测试一下在 singleton+setter 的模式下产生的循环依赖，Spring是否能够解决？</p>
<p>a. 给上面的类添加方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Husband</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Wife wife;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// toString()方法重写时需要注意：不能直接输出wife，输出wife.getName()。要不然会出现递归导致的栈内存溢出错误。</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Husband&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;name=&#x27;&quot;</span> + name + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, wife=&quot;</span> + wife.getName() +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Wife</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Husband husband;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// toString()方法重写时需要注意：不能直接输出husband，输出husband.getName()。要不然会出现递归导致的栈内存溢出错误。</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Wife&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;name=&#x27;&quot;</span> + name + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, husband=&quot;</span> + husband.getName() +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>b. <code>spring.xml</code></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;husbandBean&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.muyoukule.Bean.Husband&quot;</span> <span class="attr">scope</span>=<span class="string">&quot;singleton&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;张三&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;wife&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;wifeBean&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;wifeBean&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.muyoukule.Bean.Wife&quot;</span> <span class="attr">scope</span>=<span class="string">&quot;singleton&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;小花&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;husband&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;husbandBean&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>c. 测试</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSingletonAndSet</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;spring.xml&quot;</span>);</span><br><span class="line">    <span class="type">Husband</span> <span class="variable">husbandBean</span> <span class="operator">=</span> applicationContext.getBean(<span class="string">&quot;husbandBean&quot;</span>, Husband.class);</span><br><span class="line">    <span class="type">Wife</span> <span class="variable">wifeBean</span> <span class="operator">=</span> applicationContext.getBean(<span class="string">&quot;wifeBean&quot;</span>, Wife.class);</span><br><span class="line">    System.out.println(husbandBean);</span><br><span class="line">    System.out.println(wifeBean);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>d. 结果</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Husband&#123;name=&#x27;张三&#x27;, wife=小花&#125;</span><br><span class="line">Wife&#123;name=&#x27;小花&#x27;, husband=张三&#125;</span><br></pre></td></tr></table></figure>

<p>通过测试得知：在 <code>singleton</code>  +  <code>set</code> 注入的情况下，循环依赖是没有问题的。Spring 可以解决这个问题。</p>
<h2 id="7-3-prototype下的set注入产生的循环依赖"><a href="#7-3-prototype下的set注入产生的循环依赖" class="headerlink" title="7.3 prototype下的set注入产生的循环依赖"></a>7.3 prototype下的set注入产生的循环依赖</h2><p>我们再来测试一下：<code>prototype</code> + <code>set</code> 注入的方式下，循环依赖会不会出现问题？</p>
<p>a. 修改<code>spring.xml</code></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;husbandBean&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.muyoukule.Bean.Husband&quot;</span> <span class="attr">scope</span>=<span class="string">&quot;prototype&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;张三&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;wife&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;wifeBean&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;wifeBean&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.muyoukule.Bean.Wife&quot;</span> <span class="attr">scope</span>=<span class="string">&quot;prototype&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;小花&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;husband&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;husbandBean&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>b. 测试</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/accidence-spring/%E5%88%9B%E5%BB%BA%E5%90%8D%E4%B8%BAhusbandBean%E7%9A%84bean%E6%97%B6%E5%87%BA%E9%94%99.png"></p>
<p>翻译为：创建名为“ <code>husbandBean</code> ”的 bean 时出错：请求的 bean 当前正在创建中：是否存在无法解析的循环引用？</p>
<p>通过测试得知，当循环依赖的所有 Bean 的 <code>scope=&quot;prototype&quot;</code> 的时候，产生的循环依赖，Spring 是无法解决的，会出现 <code>BeanCurrentlyInCreationException</code> 异常。</p>
<p>大家可以测试一下，以上两个 Bean，如果其中一个是 <code>singleton</code> ，另一个是 <code>prototype</code> ，是没有问题的。</p>
<p>为什么两个Bean都是 <code>prototype</code> 时会出错呢？</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/accidence-spring/%E4%B8%A4%E4%B8%AABean%E9%83%BD%E6%98%AFprototype%E6%97%B6%E5%87%BA%E9%94%99%E7%9A%84%E5%8E%9F%E5%9B%A0.png"></p>
<h2 id="7-4-singleton下的构造注入产生的循环依赖"><a href="#7-4-singleton下的构造注入产生的循环依赖" class="headerlink" title="7.4 singleton下的构造注入产生的循环依赖"></a>7.4 singleton下的构造注入产生的循环依赖</h2><p>我们再来测试一下singleton + 构造注入的方式下，spring是否能够解决这种循环依赖。</p>
<p>a. 创建如下类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Husband</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Wife wife;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Wife</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Husband husband;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>b.  修改 <code>spring.xml</code></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;hBean&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.muyoukule.Bean.Husband&quot;</span> <span class="attr">scope</span>=<span class="string">&quot;singleton&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;张三&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">name</span>=<span class="string">&quot;wife&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;wBean&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;wBean&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.muyoukule.Bean.Wife&quot;</span> <span class="attr">scope</span>=<span class="string">&quot;singleton&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;小花&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">name</span>=<span class="string">&quot;husband&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;hBean&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>c. 测试</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSingletonAndConstructor</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;spring.xml&quot;</span>);</span><br><span class="line">    <span class="type">Husband</span> <span class="variable">hBean</span> <span class="operator">=</span> applicationContext.getBean(<span class="string">&quot;hBean&quot;</span>, Husband.class);</span><br><span class="line">    <span class="type">Wife</span> <span class="variable">wBean</span> <span class="operator">=</span> applicationContext.getBean(<span class="string">&quot;wBean&quot;</span>, Wife.class);</span><br><span class="line">    System.out.println(hBean);</span><br><span class="line">    System.out.println(wBean);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>d. 结果</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/accidence-spring/%E6%8F%90%E7%A4%BA%E4%BA%A7%E7%94%9F%E4%BA%86%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%96.png"></p>
<p>和上一个测试结果相同，都是提示产生了循环依赖，并且Spring是无法解决这种循环依赖的。这是通过构造方法注入导致的：因为构造方法注入会导致实例化对象的过程和对象属性赋值的过程没有分离开，必须在一起完成。</p>
<h2 id="7-5-Spring解决循环依赖的机理"><a href="#7-5-Spring解决循环依赖的机理" class="headerlink" title="7.5 Spring解决循环依赖的机理"></a>7.5 Spring解决循环依赖的机理</h2><p>Spring 为什么可以解决 <code>set + singleton</code> 模式下循环依赖？</p>
<p>根本的原因在于：这种方式可以做到将“实例化 Bean ”和“给 Bean 属性赋值”这两个动作分开去完成。</p>
<ul>
<li><p>实例化 Bean 的时候：调用无参数构造方法来完成。此时可以先不给属性赋值，可以提前将该 Bean 对象“曝光”给外界。</p>
</li>
<li><p>给 Bean 属性赋值的时候：调用 <code>setter</code> 方法来完成。</p>
</li>
</ul>
<p>两个步骤是完全可以分离开去完成的，并且这两步不要求在同一个时间点上完成。</p>
<p>也就是说，Bean 都是单例的，我们可以先把所有的单例 Bean 实例化出来，放到一个集合当中（我们可以称之为缓存），所有的单例Bean 全部实例化完成之后，以后我们再慢慢的调用 <code>setter</code> 方法给属性赋值。这样就解决了循环依赖的问题。</p>
<p>那么在Spring框架底层源码级别上是如何实现的呢？请看：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/accidence-spring/DeafaultSingletonBeanRegistry%E6%BA%90%E7%A0%81.png"></p>
<p>在以上类中包含三个重要的属性：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//Cache of singleton objects: bean name to bean instance</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Object&gt; singletonObjects = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>(<span class="number">256</span>);</span><br></pre></td></tr></table></figure>

<p><strong><code>Cache of singleton objects: bean name to bean instance.</code> 单例对象的缓存：key存储 bean 名称，value 存储 Bean 对象【一级缓存】</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//Cache of early singleton objects: bean name to bean instance</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Object&gt; earlySingletonObjects = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>(<span class="number">16</span>);</span><br></pre></td></tr></table></figure>

<p><strong><code>Cache of early singleton objects: bean name to bean instance.</code> 早期单例对象的缓存：key 存储 bean 名称，value 存储早期的 Bean 对象【二级缓存】</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//Cache of singleton factories: bean name to ObjectFactory</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, ObjectFactory&lt;?&gt;&gt; singletonFactories = <span class="keyword">new</span> <span class="title class_">HashMap</span>(<span class="number">16</span>);</span><br></pre></td></tr></table></figure>

<p><strong><code>Cache of singleton factories: bean name to ObjectFactory.</code> 单例工厂缓存：key 存储 bean 名称，value 存储该 Bean 对应的 ObjectFactory 对象【三级缓存】</strong></p>
<p>这三个缓存其实本质上是三个Map集合。</p>
<p>我们再来看，在该类中有这样一个方法 <code>addSingletonFactory()</code> ，这个方法的作用是：将创建 Bean 对象的 ObjectFactory 对象提前曝光。</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/accidence-spring/addSingletonFactory()%E6%96%B9%E6%B3%95.png" style="zoom:67%;">

<p>再分析下面的源码：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMIMG/accidence-spring/getSingleton%E6%BA%90%E7%A0%81.png" style="zoom:67%;">

<p>从源码中可以看到，spring 会先从一级缓存中获取 Bean，如果获取不到，则从二级缓存中获取 Bean，如果二级缓存还是获取不到，则从三级缓存中获取之前曝光的 ObjectFactory 对象，通过 ObjectFactory 对象获取 Bean 实例，这样就解决了循环依赖的问题。</p>
<p><strong>总结</strong></p>
<p>Spring 只能解决 <code>setter</code> 方法注入的单例 bean 之间的循环依赖。ClassA 依赖 ClassB ，ClassB 又依赖ClassA ，形成依赖闭环。Spring 在创建 ClassA 对象后，不需要等给属性赋值，直接将其曝光到 bean 缓存当中。在解析 ClassA 的属性时，又发现依赖于 ClassB ，再次去获取 ClassB，当解析 ClassB 的属性时，又发现需要 ClassA 的属性，但此时的 ClassA 已经被提前曝光加入了正在创建的 bean 的缓存中，则无需创建新的的 ClassA 的实例，直接从缓存中获取即可。从而解决循环依赖问题。</p>
]]></content>
      <categories>
        <category>Java</category>
        <category>SSM</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>Spring</tag>
      </tags>
  </entry>
  <entry>
    <title>Git教程</title>
    <url>/posts/41310/</url>
    <content><![CDATA[<p>Git官网：<a href="https://git-scm.com/">https://git-scm.com/</a></p>
<p>参考视频：<a href="https://www.bilibili.com/video/BV1MU4y1Y7h5/">黑马程序员Git全套教程，完整的Git项目管理工具教程，一套精通Git</a></p>
<h1 id="1-版本控制"><a href="#1-版本控制" class="headerlink" title="1. 版本控制"></a>1. 版本控制</h1><blockquote>
<p>版本管理概念</p>
</blockquote>
<p>版本控制是指对软件开发过程中各种程序代码、<a href="https://baike.baidu.com/item/%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/286550?fromModule=lemma_inlink">配置文件</a>及说明文档等文件变更的管理，是<a href="https://baike.baidu.com/item/%E8%BD%AF%E4%BB%B6%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86/3765602?fromModule=lemma_inlink">软件配置管理</a>的核心思想之一。</p>
<blockquote>
<p>版本管理工具概念</p>
</blockquote>
<p>版本管理工具，也被称为版本控制工具，是一个用于记录文件内容变化，以便将来查阅特定版本修订情况的系统。它主要用于管理软件开发中的源代码、配置文件和文档等文件的变更。</p>
<p>具体来说，版本管理工具具备以下核心功能：</p>
<ul>
<li><strong>备份文件</strong>：每一次的文件变更都会被保存下来，形成一个新的版本，这样即使出现错误或需要回溯，也可以轻松地恢复到之前的版本。</li>
<li><strong>记录历史</strong>：工具会详细记录每次变更的内容、时间以及执行变更的人员等信息，为团队提供完整的版本历史记录。</li>
<li><strong>回到过去</strong>：通过版本管理工具，用户可以轻松地恢复到过去的任何一个版本，这对于错误排查、功能回滚等场景非常有用。</li>
<li><strong>多端共享</strong>：版本管理工具支持在多个设备或平台上访问和更新代码库，使得团队成员可以在不同的工作环境中无缝协作。</li>
<li><strong>团队协作</strong>：它支持多人同时处理同一份文件，通过合并和冲突解决机制，确保团队成员之间的协作更加高效和准确。</li>
</ul>
<blockquote>
<p>版本管理工具</p>
</blockquote>
<p>主流的版本控制软件有：</p>
<ul>
<li><p>Git</p>
</li>
<li><p>SVN(Subversion)</p>
</li>
<li><p>CVS(Concurrent Versions System)</p>
</li>
<li><p>VSS(Micorosoft Visual SourceSafe)</p>
</li>
<li><p>TFS(Team Foundation Server)</p>
</li>
<li><p>Visual Studio Online</p>
</li>
</ul>
<p>使用最广泛的是 Git 与 SVN。</p>
<blockquote>
<p>版本管理发展简史(维基百科)</p>
</blockquote>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/Git/%E7%89%88%E6%9C%AC%E6%8E%A7%E5%88%B6%E8%BD%AF%E4%BB%B6.png"></p>
<p><strong>1、SVN(SubVersion)</strong></p>
<p>SVN 是集中式版本控制系统，版本库是集中放在中央服务器的。</p>
<p>工作流程如下:</p>
<ol>
<li>从中央服务器远程仓库下载代码</li>
<li>修改后将代码提交到中央服务器远程仓库</li>
</ol>
<p> 优点：简单，易操作。</p>
<p> 缺点：所有代码必须放在中央服务器。</p>
<ul>
<li>服务器一旦宕机无法提交代码,即容错性较差。</li>
<li>离线无法提交代码,无法及时记录我们的提交行为。</li>
</ul>
<p>SVN 流程图</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/Git/SVN.jpg"></p>
<p><strong>2、Git</strong></p>
<p>Git 是分布式版本控制系统(Distributed Version Control System，简称 DVCS)，分为两种类型的仓库：<code>本地仓库</code> 和 <code>远程仓库</code></p>
<p>工作流程如下：</p>
<ol>
<li>从远程仓库中克隆或拉取代码到本地仓库 (clone&#x2F;pull) 。</li>
<li>从本地进行代码修改。</li>
<li>在提交前先将代码提交到暂存区。</li>
<li>提交到本地仓库。本地仓库中保存修改的各个历史版本。</li>
<li>修改完成后，需要和团队成员共享代码时，将代码 push 到远程仓库。</li>
</ol>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/Git/Git.png"></p>
<p><strong>总结：Git 和 SVN 的区别</strong></p>
<ol>
<li>SVN 是集中式版本控制工具，Git 是分布式版本控制工具</li>
<li>SVN 不支持离线提交，Git 支持离线提交代码</li>
</ol>
<h1 id="2-Git-发展简史"><a href="#2-Git-发展简史" class="headerlink" title="2. Git 发展简史"></a>2. Git 发展简史</h1><p>Git 起源于2005年，由 Linux 内核的缔造者 <a href="https://baike.baidu.com/item/%E6%9E%97%E7%BA%B3%E6%96%AF%C2%B7%E6%9C%AC%E7%BA%B3%E7%AC%AC%E5%85%8B%E7%89%B9%C2%B7%E6%89%98%E7%93%A6%E5%85%B9/1034429?fr=ge_ala">Linus Benedict Torvalds</a> 创建。在之前，Linux 内核的维护主要依赖于补丁和存档文件，但随着参与者的增多，这种方式变得低效。尽管当时存在其他版本控制工具，但它们要么是收费的，要么是采用集中式管理方式，无法满足 Linux 内核社区的需求。</p>
<p>2002年，Linux 内核项目开始使用 BitKeeper 这一专有分布式版本控制系统，但2005年，由于商业合作关系的破裂，Linux 内核社区失去了免费使用 BitKeeper 的权力。</p>
<p>这一事件促使 Linus Benedict Torvalds和Linux 开源社区开始开发自己的版本控制系统。他们基于使用 BitKeeper 时的经验，设定了新系统的目标：高速、简单设计、支持非线性开发(允许成千上万个并行分支)、完全分布式，并能有效管理大型项目。</p>
<p>经过两周的开发，Linus Torvalds 用 C 语言写出了 Git 这一分布式版本控制系统。Git自诞生以来，不断发展和完善，成为高度易用且功能强大的版本控制工具，广泛应用于各类软件开发项目中。</p>
<p>Git 的成功不仅在于其技术上的优越性，更在于它符合开源文化和协作精神，为全球开发者提供了一个共同学习和进步的平台，推动了整个软件开发行业的进步。</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/Git/%E6%9D%8E%E7%BA%B3%E6%96%AF%E3%83%BB%E6%89%98%E6%B2%83%E5%85%B9.jpg"></p>
<center>Linux 和 Git 之父 林纳斯·本纳第克特·托瓦兹(Linus Benedict Torvalds)</center>

<h1 id="3-Git-快速入门"><a href="#3-Git-快速入门" class="headerlink" title="3. Git 快速入门"></a>3. Git 快速入门</h1><h2 id="3-1-Git概述"><a href="#3-1-Git概述" class="headerlink" title="3.1 Git概述"></a>3.1 Git概述</h2><p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/Git/Git%E6%A6%82%E8%BF%B0.png"></p>
<p>Git 是一个免费的，开源的分布式版本控制系统，可以快速高效地处理从小型或大型的各种项目。Git 易于学习，占用空间小，性能快得惊人。</p>
<h2 id="3-2-Git下载与安装"><a href="#3-2-Git下载与安装" class="headerlink" title="3.2 Git下载与安装"></a>3.2 Git下载与安装</h2><blockquote>
<p>Git 下载</p>
</blockquote>
<p>一、<a href="https://git-scm.com/downloads">Git 下载官网</a></p>
<p>进入官网后根据自己操作系统的情况下载并进行安装：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/Git/Git%E5%AE%98%E7%BD%91%E4%B8%8B%E8%BD%BD.png"></p>
<p>二、 如果官网下载太慢，可以使用淘宝镜像下载：<a href="https://registry.npmmirror.com/binary.html?path=git-for-windows/">Git 镜像下载</a></p>
<p>进入镜像后，拖至最下方，进入稳定版的下载，然后根据自己操作系统的情况下载并进行安装。</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/Git/Git%E9%95%9C%E5%83%8F%E4%B8%8B%E8%BD%BD.png"></p>
<center>上方不带 rc 的才是稳定版</center>

<p>最早 Git 是在 Linux 上开发的，很长一段时间内，Git 也只能在 Linux 和 Unix 系统上跑。不过，慢慢地有人把它移植到了 Windows 上。现在，Git 可以在 Linux、Unix、Mac 和 Windows 这几大平台上正常运行了。由于开发机大多数情况都是 Windows，所以本教程选择相对简单的 Windows 系统软件版本进行下载，此处我们下载 Windows 系统的 2.44.0 版本软件。</p>
<blockquote>
<p>Git 安装</p>
</blockquote>
<p>安装时使用 <font color="red">“傻瓜式”</font> 安装，无脑下一步即可。<font color="red">PS：注意按自己需求修改安装路径！</font>😏</p>
<p>安装时还可以修改默认编辑器，默认是 Vim 编辑器。比如将默认编辑器修改为 NotePad3，找到 NotePad3 的 exe 文件并选择即可。</p>
<p>如果在安装完成后想要修改默认编辑器，可以使用命令：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">将默认编辑器修改为 vim</span></span><br><span class="line">git config --global core.editor vim</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改为 NotePad3(安装路径自行修改)</span></span><br><span class="line">git config --global core.editor &quot;D:\\Notepad3\\Notepad3.exe&quot;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Git 启动测试</p>
</blockquote>
<p>安装成功后在开始菜单中会有如下信息：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/Git/%E5%BC%80%E5%A7%8B%E8%8F%9C%E5%8D%95Git.png"></p>
<ul>
<li><p>Git Bash： Unix 与 Linux 风格的命令行(使用最多，推荐使用)</p>
</li>
<li><p>Git CMD： Windows 风格的命令行</p>
</li>
<li><p>Git GUI： 图形界面的 Git，不建议初学者使用，尽量先熟悉常用命令</p>
</li>
</ul>
<p>可以在某一目录中点击右键，点击 “Git Bash Here” 就可以再当前目录下打开 Git Bash。</p>
<p>在Windows桌面空白处，点击鼠标右键，弹出右键菜单：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/Git/%E5%8F%B3%E9%94%AE%E8%8F%9C%E5%8D%95Git.png"></p>
<p>Git软件安装后，会在右键菜单中增加两个菜单</p>
<ul>
<li>Open Git GUI Here</li>
<li>Open Git Bash Here</li>
</ul>
<p>此处仅仅是为了验证 Git 软件安装的效果，所以选择 <code>Git Bash Here</code> 菜单, 选择后，Windows 系统弹出 Git 软件的命令行黑窗口：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/Git/Git%E7%9A%84%E5%91%BD%E4%BB%A4%E8%A1%8C%E9%BB%91%E7%AA%97%E5%8F%A3.png"></p>
<p>窗口弹出后，可以输入 Git 软件的操作指令。此时我们使用键盘输入操作指令：<code>git -v</code> 或 <code>git --version</code>，查看当前 Git 软件的安装版本。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">git -v</span><br><span class="line">git --version</span><br></pre></td></tr></table></figure>

<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/Git/Git%E7%9A%84%E5%AE%89%E8%A3%85%E7%89%88%E6%9C%AC.png"></p>
<p>输入指令回车后，如果黑窗口中打印出咱们安装的软件版本 2.44.0，Git 软件安装成功了。</p>
<h2 id="3-3-Git基础指令"><a href="#3-3-Git基础指令" class="headerlink" title="3.3 Git基础指令"></a>3.3 Git基础指令</h2><p>Git 软件是免费、开源的。最初 Git 软件是为辅助 Linux 内核开发的一套软件，所以在使用时，简单常用的 Linux 系统操作指令是可以直接使用的：</p>
<table>
<thead>
<tr>
<th align="center"><strong>指令</strong></th>
<th align="center"><strong>含义</strong></th>
<th align="center"><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="center">cd 目录</td>
<td align="center">change directory</td>
<td align="center">改变操作目录</td>
</tr>
<tr>
<td align="center">cd ..</td>
<td align="center"></td>
<td align="center">退回到上一级目录</td>
</tr>
<tr>
<td align="center">pwd</td>
<td align="center">Print work  directory</td>
<td align="center">打印工作目录</td>
</tr>
<tr>
<td align="center">ls</td>
<td align="center">list directory  contents</td>
<td align="center">显示当前目录的文件及子文件目录</td>
</tr>
<tr>
<td align="center">ll</td>
<td align="center">ls -l 简化版本</td>
<td align="center">更详细地显示当前目录的文件及子文件目录</td>
</tr>
<tr>
<td align="center">mkdir 文件夹名称</td>
<td align="center">make directory</td>
<td align="center">新建一个文件夹</td>
</tr>
<tr>
<td align="center">rm 文件</td>
<td align="center">remove</td>
<td align="center">删除文件</td>
</tr>
<tr>
<td align="center">rm -r 文件夹</td>
<td align="center">Remove</td>
<td align="center">删除文件目录</td>
</tr>
<tr>
<td align="center">touch 文件</td>
<td align="center"></td>
<td align="center">如果创建的文件不存在，那么创建一个空文件</td>
</tr>
<tr>
<td align="center">reset</td>
<td align="center"></td>
<td align="center">清屏</td>
</tr>
<tr>
<td align="center">clear</td>
<td align="center"></td>
<td align="center">清屏</td>
</tr>
<tr>
<td align="center">exit</td>
<td align="center"></td>
<td align="center">退出终端窗口</td>
</tr>
</tbody></table>
<h2 id="3-4-Git配置"><a href="#3-4-Git配置" class="headerlink" title="3.4 Git配置"></a>3.4 Git配置</h2><blockquote>
<p>配置信息</p>
</blockquote>
<p>Git 安装目录下的 <code>gitconfig --system</code> 系统级配置文件：<code>Git 安装目录 \etc\gitconfig</code></p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/Git/Git%E7%B3%BB%E7%BB%9F%E7%BA%A7%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6.png" style="zoom:67%;">

<p>只适用于当前登录用户的配置 <code>--global</code> 全局配置文件：<code>C:\Users\ 你的用户名 \ .gitconfig</code></p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/Git/Git%E5%BD%93%E5%89%8D%E7%99%BB%E5%BD%95%E7%94%A8%E6%88%B7%E7%9A%84%E5%85%A8%E5%B1%80%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6.png" style="zoom:67%;">

<p>默认情况下，我们可以通过使用以下命令，查看不同级别的配置信息：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看系统 config</span></span><br><span class="line">git config --system --list</span><br><span class="line"><span class="meta prompt_">　　</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看当前用户(global)配置</span></span><br><span class="line">git config --global  --list</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>设置名称和邮箱</strong>   <font color="red"><strong>这很重要！！！</strong></font></p>
</blockquote>
<p>安装完 Git 后首先要做的事情是设置用户名和 email 地址。这非常重要，因为每次 Git 提交都会使用该信息，它被永远的嵌入到了提交中。<font color="red"><strong>所以！！！是一定要配置的！！！</strong></font></p>
<p>否则就会出现如下提示：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/Git/Git%E6%9C%AA%E8%AE%BE%E7%BD%AE%E5%90%8D%E7%A7%B0%E5%92%8C%E9%82%AE%E7%AE%B1.png"></p>
<p>此时需要按照下面两个命令来设置用户名🏃和邮箱📧( muyoukule 是我的用户名，<a href="mailto:&#121;&#111;&#x75;&#x72;&#x5f;&#x65;&#x6d;&#97;&#x69;&#108;&#64;&#101;&#x78;&#x61;&#109;&#112;&#108;&#101;&#46;&#x63;&#111;&#x6d;">&#121;&#111;&#x75;&#x72;&#x5f;&#x65;&#x6d;&#97;&#x69;&#108;&#64;&#101;&#x78;&#x61;&#109;&#112;&#108;&#101;&#46;&#x63;&#111;&#x6d;</a> 是邮箱，你需要设置属于你自己的用户名和邮箱)。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">git config --global user.name muyoukule</span><br><span class="line">git config --global user.email your_email@example.com</span><br></pre></td></tr></table></figure>

<p>如果使用了 <code>--global</code> 选项，表示设置了全局的用户名和邮箱。如果希望在一个特定的项目中使用不同的用户名和邮箱，可以在该项目中运行该命令而不添加 –global 选项。总之 <code>--global</code> 为全局配置，不加为某个项目的特定配置。</p>
<p>设置好用户名和邮箱后，此时在操作系统的用户目录 <code>C:\Users\你的用户名</code> 下会产生新的配置文件 <code>.gitconfig</code>，可以运行 <code>git config --global --list</code>，就会显示设置的用户名和邮箱，也可以在 <code>C:\Users\你的用户名\.gitconfig</code> 文件中看到设置的信息。</p>
<p>也可以使用命令查看：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">git config --global user.name</span><br><span class="line">git config --global user.email</span><br></pre></td></tr></table></figure>

<blockquote>
<p>为常用指令配置别名(可选)</p>
</blockquote>
<p>有些常用的指令参数非常多，每次都要输入好多参数，我们可以使用别名。</p>
<p>1、打开用户目录，创建 .bashrc 文件</p>
<p>部分windows系统不允许用户创建点号开头的文件，可以打开 GitBash，执行 touch ~&#x2F;.bashrc</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">新建 .bashrc 文件</span></span><br><span class="line">touch ~/.bashrc</span><br></pre></td></tr></table></figure>

<p>执行完成后会在 <code>C:\Users\你的用户名</code> 路径下多出 .bashrc 文件</p>
<p>2、在 <code>.bashrc</code> 文件中输入如下内容：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">用于输出git提交日志</span></span><br><span class="line">alias git-log=&#x27;git log --pretty=oneline --all --graph --abbrev-commit&#x27;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">用于输出当前目录所有文件及基本信息</span></span><br><span class="line">alias ll=&#x27;ls -al&#x27;</span><br></pre></td></tr></table></figure>

<p>3、打开 GitBash，执行 source ~&#x2F;.bashrc</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">重启变量配置</span></span><br><span class="line">source ~/.bashrc</span><br></pre></td></tr></table></figure>

<h1 id="4-Git-基本理论"><a href="#4-Git-基本理论" class="headerlink" title="4. Git 基本理论"></a>4. Git 基本理论</h1><blockquote>
<p>三大区域</p>
</blockquote>
<p>Git 本地有三个工作区域：工作目录(Working Directory)、暂存区(Stage 或 Index)、资源库(历史记录区、版本库、本地仓库、History、Repository 或 Git Directory)。如果在加上远程的 Git 仓库(Remote Directory)也可以分为四个工作区域。</p>
<p>文件在这四个区域之间的转换关系如下：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/Git/Git%E4%B8%89%E5%A4%A7%E5%8C%BA%E5%9F%9F.png"></p>
<ul>
<li>Working Directory：工作区，平时存放项目代码的地方。</li>
<li>Stage(Index)：暂存区，用于临时存放改动，事实上它只是一个文件，保存即将提交到文件列表信息。</li>
<li>History：历史记录区，安全存放数据的位置，里面有项目所有版本的数据。</li>
<li>Remote Directory：远程仓库，托管代码的服务器，可以简单的认为是项目组中用于远程数据交换的一台电脑。</li>
</ul>
<blockquote>
<p>三大区域的另一种图示</p>
</blockquote>
<p>本地的三个区域确切的说应该是 Git 仓库中 HEAD 指向的版本：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/Git/%E5%9B%BE%E8%A7%A3%E4%B8%89%E5%A4%A7%E5%8C%BA%E5%9F%9F.png" style="zoom:67%;">

<ul>
<li><p>Directory：使用 Git 管理的一个目录，也就是一个仓库，包含我们的工作空间和 Git 的管理空间。</p>
</li>
<li><p>WorkSpace：需要通过 Git 进行版本控制的目录和文件，这些目录和文件组成了工作空间。</p>
</li>
<li><p>.git：存放 Git 管理信息的目录，初始化仓库的时候自动创建。(<strong>一个隐藏文件夹</strong>)</p>
</li>
<li><p>Index&#x2F;Stage：暂存区，或者叫待提交更新区，在提交进入 repo 之前，可以把所有的更新放在暂存区。</p>
</li>
<li><p>Local Repo：本地仓库，一个存放在本地的版本库；HEAD 会只是当前的开发分支(branch)。</p>
</li>
<li><p>Stash：隐藏，是一个工作状态保存栈，用于保存 &#x2F; 恢复 WorkSpace 中的临时状态。</p>
</li>
</ul>
<blockquote>
<p>工作流程</p>
</blockquote>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/Git/Git%E6%B5%81%E7%A8%8B.png" style="zoom:67%;">

<p><strong>本地仓库</strong>：是在开发人员自己电脑上的 Git 仓库,存放我们的代码(<strong>.git 隐藏文件夹就是我们的本地仓库</strong>)。</p>
<p><strong>远程仓库</strong>：是在远程服务器上的 Git 仓库,存放代码(可以是 github.com 或者 gitee.com 上的仓库,或者自己该公司的服务器)。</p>
<p><strong>工作区</strong>：我们自己写代码(文档)的地方。</p>
<p><strong>暂存区</strong>：在本地仓库中的一个特殊的文件 (index) 叫做暂存区,临时存储我们即将要提交的文件。</p>
<p><strong>Clone</strong>：克隆，就是将远程仓库复制到本地仓库。</p>
<p><strong>Push</strong>：推送，就是将本地仓库代码上传到远程仓库。</p>
<p><strong>Pull</strong>：拉取，就是将远程仓库代码下载到本地仓库，并将代码克隆到本地工作区。</p>
<h1 id="5-Git-本地仓库"><a href="#5-Git-本地仓库" class="headerlink" title="5. Git 本地仓库"></a>5. Git 本地仓库</h1><p>要使用 Git 对我们的代码进行版本控制，首先需要获得本地仓库。</p>
<blockquote>
<p>获得本地仓库</p>
</blockquote>
<p>创建本地仓库的方法有两种：一种是创建全新的仓库，另一种是克隆远程仓库。</p>
<p><strong>创建全新的仓库</strong></p>
<ol>
<li><p>在电脑任意位置创建一个空目录(例如在桌面新建 repository 文件夹)作为本地 Git 仓库。</p>
</li>
<li><p>进入这个目录，点击右键点击 <code>Git Bash here</code> 打开窗口</p>
</li>
<li><p>在目录执行以下命令创建全新的仓库：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在当前目录新建一个 Git 代码库</span></span><br><span class="line">git init</span><br></pre></td></tr></table></figure>
</li>
<li><p>执行后在当前目录下新增了一个 <code>.git</code> <strong>隐藏</strong>目录，当前项目的版本信息和配置信息都会存放在这个目录里。</p>
</li>
</ol>
<p><strong>克隆远程仓库</strong></p>
<p>可以使用以下命令将某个项目克隆(下载)到本地：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">克隆一个项目和它的整个代码历史(版本信息)</span></span><br><span class="line">git clone [url]</span><br></pre></td></tr></table></figure>

<p>在 GitHub 上选定一个项目进行测试：</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/Git/GitHub%E9%80%89%E5%AE%9A%E9%A1%B9%E7%9B%AE.png" style="zoom:67%;">

<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/Git/Git%E6%8B%89%E5%8F%96%E9%A1%B9%E7%9B%AE%E5%88%B0%E6%9C%AC%E5%9C%B0.png" style="zoom:67%;">

<h1 id="6-Git-文件操作"><a href="#6-Git-文件操作" class="headerlink" title="6. Git 文件操作"></a>6. Git 文件操作</h1><p>Git 工作目录下对于文件的修改(增加、删除、更新)会存在几个状态，这些修改的状态会随着我们执行 Git 的命令而发生变化。</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/Git/Git%E6%96%87%E4%BB%B6%E7%8A%B6%E6%80%81.png"></p>
<blockquote>
<p>查看修改的状态(status)</p>
</blockquote>
<p>作用：查看的修改的状态(暂存区、工作区) </p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看指定文件状态</span></span><br><span class="line">git status [filename]</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看所有文件状态</span></span><br><span class="line">git status</span><br></pre></td></tr></table></figure>

<blockquote>
<p>添加工作区到暂存区(add)</p>
</blockquote>
<p>作用：添加工作区一个或多个文件的修改到暂存区</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">添加所有文件到暂存区</span></span><br><span class="line">git add .</span><br></pre></td></tr></table></figure>

<p>PS：add错了可以使用 <code>git rm --cached 文件名</code> 删除对应的文件</p>
<blockquote>
<p>提交暂存区到本地仓库(commit)</p>
</blockquote>
<p>作用：提交暂存区内容到本地仓库的当前分支</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">提交暂存区中的内容到本地仓库 -m 提交信息</span></span><br><span class="line">git commit -m &quot;消息内容&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果你修改了某个已跟踪的文件，将跟踪的文件直接添加到本地仓库</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果有新增文件，还是得先执行 git add .</span></span><br><span class="line">git commit -am &quot;消息内容&quot;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>查看提交日志(log)</p>
</blockquote>
<p>作用：查看提交记录</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">git log [option]</span><br></pre></td></tr></table></figure>

<p>options：</p>
<ul>
<li><p><code>空</code>：查看当前分支版本信息</p>
</li>
<li><p><code>--all</code>：显示所有分支</p>
</li>
<li><p><code>--pretty=oneline</code>：将提交信息显示为一行</p>
</li>
<li><p><code>--abbrev-commit</code>：使得输出的commited更简短</p>
</li>
<li><p><code>--graph</code>：以图的形式显示</p>
</li>
</ul>
<blockquote>
<p>版本回退</p>
</blockquote>
<p>作用：版本切换</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">git reset --hard commitID	# commitID 可以使 git log 指令查看</span><br></pre></td></tr></table></figure>

<blockquote>
<p>查看已经删除的记录</p>
</blockquote>
<p><code>git reflog</code> 可以查看所有分支的所有操作记录(包括已经被删除的 commit 记录和 reset 的操作)。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">git reflog</span><br></pre></td></tr></table></figure>

<p>提交记录过多时，按下 <code>q</code> 可结束浏览。</p>
<blockquote>
<p>添加文件至忽略列表</p>
</blockquote>
<p>有时不想把某些文件纳入版本控制中，比如数据库文件，临时文件，设计文件等，要求忽略这些文件的修改。</p>
<p>在根目录下建立 <code>.gitignore</code> 文件，将需要被忽略的文件名添加到此文件中。</p>
<p><code>.gitignore</code> 文件内容解析：</p>
<ul>
<li><p>以井号 <code>#</code> 开始的行表示注释；</p>
</li>
<li><p>可以使用 Linux 通配符。例如：星号 <code>*</code> 代表任意多个字符，问号 <code>?</code> 代表一个字符，方括号 <code>[]</code> 代表可选字符范围，大括号 <code>&#123;&#125;</code> 代表可选的字符串等；</p>
</li>
<li><p>如果名称的最前面有一个感叹号 <code>!</code>，表示例外规则，满足条件的文件不会被忽略；</p>
</li>
<li><p>如果名称的最前面是一个路径分隔符 <code>/</code>，表示要忽略的文件在根目录下；</p>
</li>
<li><p>如果名称的最后面是一个路径分隔符 <code>/</code>，表示要忽略的是此目录下的文件。</p>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">*.txt        # 忽略所有 .txt 结尾的文件</span><br><span class="line">!lib.txt     # lib.txt 除外</span><br><span class="line">/temp        # 忽略项目根目录下的 temp 文件</span><br><span class="line">build/       # 忽略 build 目录下的所有文件</span><br><span class="line">doc/*.txt    # 忽略 doc 目录下的所有 txt 文件，不包括子目录下</span><br></pre></td></tr></table></figure>


<p>IDEA 中常用的 <code>.gitignore</code> 文件内容：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Compiled class file</span></span><br><span class="line">*.class</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Log file</span></span><br><span class="line">*.log</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">BlueJ files</span></span><br><span class="line">*.ctxt</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Mobile Tools <span class="keyword">for</span> Java (J2ME)</span></span><br><span class="line">.mtj.tmp/</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Package Files <span class="comment">#</span></span></span><br><span class="line">*.jar</span><br><span class="line">*.war</span><br><span class="line">*.nar</span><br><span class="line">*.ear</span><br><span class="line">*.zip</span><br><span class="line">*.tar.gz</span><br><span class="line">*.rar</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">virtual machine crash logs</span></span><br><span class="line">hs_err_pid*</span><br><span class="line">.classpath</span><br><span class="line">.project</span><br><span class="line">.settings</span><br><span class="line">target</span><br><span class="line">.idea</span><br><span class="line">*.iml</span><br></pre></td></tr></table></figure>

<h1 id="7-分支"><a href="#7-分支" class="headerlink" title="7. 分支"></a>7. 分支</h1><p>几乎所有的版本控制系统都以某种形式支持分支。使用分支意味着你可以把你的工作从开发主线上分离开来进行重大的 Bug 修改、开发新的功能，以免影响开发主线。</p>
<blockquote>
<p>Git 中与分支相关的常用指令</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">列出所有本地分支。-a 表示列出所有分支，包括远程分支</span></span><br><span class="line">git branch [-a]</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">列出所有远程分支</span></span><br><span class="line">git branch -r</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">新建一个分支，但依然停留在当前分支</span></span><br><span class="line">git branch [branch-name]</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">切换到某个分支</span></span><br><span class="line">git checkout [branch-name]</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">新建一个分支，并切换到该分支</span></span><br><span class="line">git checkout -b [branch]</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">合并指定分支到当前分支</span></span><br><span class="line">git merge [branch]</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除本地分支</span></span><br><span class="line">git branch -d [branch-name]</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除未合并的本地分支</span></span><br><span class="line">git branch -D [branch-name]</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除远程分支</span></span><br><span class="line">git push origin --delete [branch-name]</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除远程分支(相当于使用一个空分支来覆盖原来的分支)</span></span><br><span class="line">git push origin :branch-name</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看本地分支和追踪情况</span></span><br><span class="line">git remote show origin</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除对分支的远程跟踪，但这个分支仍然在远程</span></span><br><span class="line">git branch -dr [remote/branch]</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">更新本地 git 分支与远程分支同步(保留本地存在的分支)</span></span><br><span class="line">git remote update origin --prune</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除本地多余分支(即远程已经不存在的分支)</span></span><br><span class="line">git remote prune origin</span><br></pre></td></tr></table></figure>

<blockquote>
<p>开发中分支使用原则与流程</p>
</blockquote>
<p>几乎所有的版本控制系统都以某种形式支持分支。 使用分支意味着你可以把你的工作从开发主线上分离开来进行重大的 Bug 修改、开发新的功能，以免影响开发主线。</p>
<p>在开发中，一般有如下分支使用原则与流程：</p>
<ul>
<li>master (生产)分支：线上分支，主分支，中小规模项目作为线上运行的应用对应的分支；</li>
<li>develop (开发)分支：是从 master 创建的分支，一般作为开发部门的主要开发分支，如果没有其他并行开发不同期上线要求，都可以在此版本进行开发，阶段开发完成后，需要是合并到 master 分支，准备上线。 </li>
<li>feature&#x2F;xxxx 分支：从develop创建的分支，一般是同期并行开发，但不同期上线时创建的分支，分支上的研发任务完 成后合并到develop分支。 </li>
<li>hotfix&#x2F;xxxx 分支：从 master 派生的分支，一般作为线上 bug 修复使用，修复完成后需要合并到 master、test、 develop 分支。</li>
</ul>
<p>还有一些其他分支，在此不再详述，例如 test 分支(用于代码测试)、pre 分支(预上线分支)等等。</p>
<h1 id="8-Git远程仓库"><a href="#8-Git远程仓库" class="headerlink" title="8. Git远程仓库"></a>8. Git远程仓库</h1><blockquote>
<p> 常用的托管服务(远程仓库)</p>
</blockquote>
<p>前面我们已经知道了 Git 中存在两种类型的仓库，即本地仓库和远程仓库。那么我们如何搭建Git远程仓库呢？我们可以借助互联网上提供的一些代码托管服务来实现，其中比较常用的有 GitHub、码云(Gitee)、GitLab 等。</p>
<ul>
<li><p><a href="https://github.com/">GitHub</a> 是一个面向开源及私有软件项目的托管平台，因为只支持 Git 作为唯一的版本库格式进行托管，故名GitHub。</p>
</li>
<li><p><a href="https://gitee.com/">码云(Gitee)</a> 是国内的一个代码托管平台，由于服务器在国内，所以相比于 GitHub，码云速度会更快。</p>
</li>
<li><p><a href="https://about.gitlab.com/">GitLab</a> 是一个用于仓库管理系统的开源项目，使用 Git 作为代码管理工具，并在此基础上搭建起来的 Web 服务，一般用于在企业、学校等内部网络搭建 Git 私服。</p>
</li>
</ul>
<blockquote>
<p>GitHub 的使用</p>
</blockquote>
<p>可以使用 GitHub 作为代码托管平台，尽管 GitHub 的访问速度不佳，但也不选择 Gitee，而在公司中，还可能使用搭建的的 GitLab 服务器。</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/Git/GitHub%E5%AE%98%E7%BD%91.png"></p>
<ul>
<li><p>首先需要注册 GitHub；</p>
</li>
<li><p>为了方便使用，<strong>强烈建议</strong> 设置本机绑定 SSH 公钥，实现免密码登录；</p>
</li>
</ul>
<h2 id="8-1-配置-SSH-公钥"><a href="#8-1-配置-SSH-公钥" class="headerlink" title="8.1 配置 SSH 公钥"></a>8.1 配置 SSH 公钥</h2><ol>
<li><p>进入 <code>C:\Users(用户)\你的用户名</code> 目录</p>
</li>
<li><p>如果你是第一次设置，在这个目录下看不到.ssh目录</p>
</li>
<li><p>在上述目录下右键打开 <code>“Git Bash Here”</code> ，运行以下命令并生成公钥</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ssh-keygen -t rsa -C &quot;邮箱或其他描述性文字&quot;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">rsa是加密方式</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>运行后无脑下一步即可</p>
</li>
</ol>
<blockquote>
<p>对输入的命令以及执行命令后需要输出的情况进行解析</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ssh-keygen -t rsa -C &quot;your_email@example.com&quot;</span><br></pre></td></tr></table></figure>

<p>以上代码省略了 -f 参数，因此运行上面那条命令后会要求输入一个文件名，用于保存刚才生成的 SSH key 代码，如：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Generating public/private rsa key pair.</span><br><span class="line"># Enter file in which to save the key (/c/Users/you/.ssh/id_rsa): [Press enter]</span><br></pre></td></tr></table></figure>

<p>也可以不输入文件名，使用默认文件名(<strong>推荐</strong>)，那么就会生成 id_rsa 和 id_rsa.pub 两个秘钥文件。</p>
<p>接着又会提示输入两次密码(该密码是 push 文件的时候要输入的密码，而不是 GitHub 管理者的密码)，也可以不输入密码，直接按回车。那么 push 的时候就不需要输入密码，直接提交到 GitHub 上了，如：(我在此直接回车，不输入密码)</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Enter passphrase (empty for no passphrase): </span><br><span class="line"># Enter same passphrase again:</span><br></pre></td></tr></table></figure>

<p>接下来将会显示：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Your identification has been saved in /c/Users/you/.ssh/id_rsa.</span><br><span class="line"># Your public key has been saved in /c/Users/you/.ssh/id_rsa.pub.</span><br><span class="line"># The key fingerprint is:</span><br><span class="line"># 01:0f:f4:3b:ca:85:d6:17:a1:7d:f0:68:9d:f0:a2:db your_email@example.com</span><br></pre></td></tr></table></figure>

<p>当看到上面这些信息时就说明 SSH key 已经创建成功，接下来将其添加到 GitHub 的 SSH key 上就可以了。</p>
<ul>
<li><p>打开 GitHub 并进行登录，点击右上角头像，选择 Settings，进入设置页面后，点击 Access 下的 SSH and GPG keys，之后点击 New SSH key；</p>
</li>
<li><p>打开目录 <code>C:\Users(用户)\你的用户名\.ssh</code>，将 id_rsa.pub 文件内的内容复制到公钥填写处，点击 “确定”，输入 GitHub 的密码即可添加成功！</p>
</li>
</ul>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/Git/%E5%85%AC%E9%92%A5%E5%A4%8D%E5%88%B6.png" style="zoom: 50%;">

<p>PS：id_rsa 存放的是私钥，id_rsa.pub 存放的是公钥，需要复制的是公钥 id_rsa.pub 的内容。</p>
<ul>
<li><p>运行 Git Bash，输入命令 <code>ssh -T git@github.com</code>(如果使用 Gitee，输入 <code>ssh -T git@gitee.com</code>)，然后输入 yes。出现以下内容则连接成功：</p>
<p><img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/Git/%E8%BF%9E%E6%8E%A5GitHub%E6%88%90%E5%8A%9F.png"></p>
</li>
<li><p>到此，完成 SSH 免密登录的配置。</p>
</li>
<li><p>如果需要新建仓库，点击主界面右上方头像旁的 “+” 然后选择 “New repository” 即可：</p>
</li>
</ul>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/Git/GitHub%E6%96%B0%E5%BB%BA%E4%BB%93%E5%BA%93.png">


<h2 id="8-2-操作远程仓库"><a href="#8-2-操作远程仓库" class="headerlink" title="8.2 操作远程仓库"></a>8.2 操作远程仓库</h2><p>执行操作之前要确保此文件夹为 Git 本地仓库。</p>
<blockquote>
<p>添加远程仓库</p>
</blockquote>
<p>此操作是先初始化本地库，然后与已创建的远程库进行对接。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">git remote add &lt;远端名称&gt; &lt;仓库路径&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>远端名称，默认填写origin，取决于远端服务器设置 </li>
<li>仓库路径，从远端服务器获取此URL</li>
</ul>
<blockquote>
<p>查看远程仓库</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">列出本地仓库中已配置的远程仓库的名称</span></span><br><span class="line">git remote [-v]</span><br></pre></td></tr></table></figure>

<ul>
<li><code>-v</code>：查看当前仓库关联的远程服务器地址。</li>
</ul>
<blockquote>
<p>移除本地远程仓库地址</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">git remote remove &lt;远程仓库别名&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>推送到远程仓库</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">git push [-f] [--set-upstream] [远端名称 [本地分支名][:远端分支名] ]</span><br></pre></td></tr></table></figure>

<ul>
<li><p>如果远程分支名和本地分支名称相同，则可以只写本地分支 </p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">git push origin master</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>-f</code> 表示强制覆盖。</p>
</li>
<li><p><code>--set-upstream</code> 推送到远端的同时并且建立起和远端分支的关联关系。 </p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">git push --set-upstream origin master</span><br></pre></td></tr></table></figure>
</li>
<li><p>如果当前分支已经和远端分支关联，则可以省略分支名和远端名。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">将 master 分支推送到已关联的远端分支</span></span><br><span class="line">git push</span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="9-在-IDEA-中使用-Git"><a href="#9-在-IDEA-中使用-Git" class="headerlink" title="9. 在 IDEA 中使用 Git"></a>9. 在 IDEA 中使用 Git</h1><p><strong>以下内容适用于 IDEA 2022.2 版本，其他版本仅供参考。</strong></p>
<h2 id="9-1-IDEA-配置-Git"><a href="#9-1-IDEA-配置-Git" class="headerlink" title="9.1 IDEA 配置 Git"></a>9.1 IDEA 配置 Git</h2><p>安装好 IntelliJ IDEA 后，如果 Git 安装在默认路径下，那么 IDEA 会自动找到 Git 的位置，如果更改了 Git 的安装位置则需要手动配置下 Git 的路径。按照下面步骤：File — Settings — Version Control — Git — Path to Git executable，在此处配置 Git 安装目录下的 exe 文件。例如：D:\Git\cmd\git.exe，其中 D:\Git 是安装目录。然后可以点击 “Tset”，出现 5 则说明 IDEA 成功识别到 Git 。</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/Git/IDEA%E9%85%8D%E7%BD%AEGit.png" style="zoom:67%;">

<p>还可以选择 Settings — Version Control — GitHub，添加 GitHub 账号到 IDEA 中。</p>
<h2 id="9-2-在-IDEA-中操作-Git"><a href="#9-2-在-IDEA-中操作-Git" class="headerlink" title="9.2 在 IDEA 中操作 Git"></a>9.2 在 IDEA 中操作 Git</h2><p>可以使用右上角 IDEA 集成的 Git 按钮进行操作，也可以在 IDEA 中的 Terminal 执行 Git 命令完成操作。</p>
<blockquote>
<p>本地仓库与远程仓库绑定</p>
</blockquote>
<p>1、初始化本地仓库</p>
<p>右上角工具栏 VCS — Create Git Repository — 选择 Git 仓库目录，默认是当前项目目录 — OK</p>
<p>2、设置远程仓库</p>
<p>初始化本地仓库成功后右上角工具栏会出现 Git 选项，Git — Manage Remotes — 输入远程地址 URL — OK</p>
<p><strong>PS：设置远程仓库时远程仓库需要为空。</strong></p>
<p>3、提交到本地仓库</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/Git/IDEA%E4%B8%AD%E6%8F%90%E4%BA%A4%E5%88%B0%E6%9C%AC%E5%9C%B0%E4%BB%93%E5%BA%93.png" style="zoom: 67%;">

<p>4、推送到远程仓库</p>
<p>右上角工具栏 Git — Push — Push (Push 的时候需要使用 GitHub 的 token)</p>
<p>6、创建分支</p>
<p>克隆远程仓库到本地成功后在 IDEA 右下角会出现 master 按钮，依次点击 master — New Branch — 输入新分支名 — Create，可以看到右下角的 master 分支名变成了输入的新分支名，即当前在新分支下。</p>
<p>7、切换分支及其他分支相关操作</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/Git/IEDEA%E4%B8%AD%E5%88%86%E6%94%AF%E5%85%B6%E4%BB%96%E6%93%8D%E4%BD%9C.png" style="zoom: 80%;">

<blockquote>
<p>克隆远程仓库到本地</p>
</blockquote>
<p>右上角工具栏 VCS — Get from Version Control — 根据需求自己选择(可以是 URL 地址或者直接将自己的远程仓库拉取下来)</p>
<img src="https://muyoukule-blog-pics.oss-cn-chengdu.aliyuncs.com/ToolsIMG/Git/IDEA%E5%85%8B%E9%9A%86%E8%BF%9C%E7%A8%8B%E4%BB%93%E5%BA%93%E5%88%B0%E6%9C%AC%E5%9C%B0.png" style="zoom:67%;">

<blockquote>
<p>IDEA 项目绑定 Git</p>
</blockquote>
<p>IDEA 绑定 Git 后可以在 IDEA 观察到 <strong>文件颜色的变化</strong>：</p>
<p><font color="#D06356">红色(或红褐色)</font></p>
<ul>
<li>表示文件尚未被添加到 Git 版本控制中，即文件还未被 <code>git add</code> 命令添加到暂存区。</li>
<li>通常这些文件是新创建的，或者虽然存在但尚未被 Git 跟踪。</li>
</ul>
<p><font color="#4E8854">绿色</font></p>
<ul>
<li>表示文件已经被 <code>git add</code> 命令添加到暂存区，但尚未被 <code>git commit</code> 命令提交。</li>
<li>换句话说，这些文件已经处于待提交状态。</li>
</ul>
<p><font color="#5F96A6">蓝色</font></p>
<ul>
<li>表示文件已经被 Git 跟踪，并且已经发生了修改，但这些修改尚未被提交(即未被 <code>git commit</code>)。</li>
<li>一旦这些修改被提交，文件颜色可能会变为白色(表示文件已提交且没有进一步修改)。</li>
</ul>
<p><font color="#B8AFAB">白色</font></p>
<ul>
<li>表示文件已经被 Git 跟踪，并且最近的修改已经被提交。</li>
<li>这些文件目前没有未提交的修改。</li>
</ul>
<p><font color="#87939A">灰色</font></p>
<ul>
<li>表示文件虽然存在于项目中，但已经被 <code>.gitignore</code> 文件忽略，因此不会被 Git 跟踪。</li>
</ul>
<blockquote>
<p>忽略文件创建</p>
</blockquote>
<p>不希望将 IDEA 的配置文件(.idea)push 到远程仓库，在 .gitignore 文件中添加 <code>.idea/</code> 即可。如果当前项目中没有 .gitignore 文件，就需要创建 .gitignore 文件。</p>
<p>两种方式：</p>
<ul>
<li><p>复制 .gitignore 文件到项目。</p>
<p>因为 .gitignore 比较固定，几乎很多项目都大差不差，所以可以直接去网上复制</p>
</li>
<li><p>安装使用 .ignore 插件。</p>
<p>点击 IDEA 中左上角 File– Settings，安装 .ignore 插件，安装好在项目右键添加 .gitignore ，使用默认模板即可。</p>
</li>
</ul>
<h1 id="10-一些操作流程"><a href="#10-一些操作流程" class="headerlink" title="10. 一些操作流程"></a>10. 一些操作流程</h1><h2 id="10-1-推送到远程仓库"><a href="#10-1-推送到远程仓库" class="headerlink" title="10.1 推送到远程仓库"></a>10.1 推送到远程仓库</h2><p>将本地未被 Git 管理的代码交由 Git 管理并推送到远程仓库：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">1.初始化 Git 仓库</span></span><br><span class="line">git init</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">2.添加所有文件 到 Git 仓库</span></span><br><span class="line">git add .</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">3.提交更改</span></span><br><span class="line">git commit -m &quot;描述性的消息&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">4.将本地仓库与远程仓库关联</span></span><br><span class="line">git remote add origin 远程仓库地址</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># 若远程仓库不是新创建的空仓库，推送前需要先进行同步</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">5.同步远程仓库（与远程仓库的某个分支进行同步）</span></span><br><span class="line">git pull origin master --allow-unrelated-histories </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">6.推送代码到远程仓库</span></span><br><span class="line">git push -u origin master</span><br></pre></td></tr></table></figure>

<h1 id="11-一些问题"><a href="#11-一些问题" class="headerlink" title="11. 一些问题"></a>11. 一些问题</h1><p>在 <code>git push</code> 的时候出现以下错误信息：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">error: File: ab6526079f60d1876fb933533dc3e6782a8eXXXX 183.89 MB, exceeds 100.00 MB.</span><br></pre></td></tr></table></figure>

<p>出现了这个错误，其实就是其中有一个文件太大，超过了100M导致的。</p>
<blockquote>
<p>解决方案</p>
</blockquote>
<p>1、查看哪个文件超过了100M</p>
<p>有可能错误直接爆出是哪个文件，也有可能只是爆出了该文件的代号。如果是代号需要先使用该语句查询具体是哪个文件：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">git rev-list --objects --all | grep ab6526079f60d1876fb933533dc3e6782a8eXXXX</span><br></pre></td></tr></table></figure>

<p>2、从缓存中删除</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">git filter-branch --tree-filter &#x27;rm -f path/to/large/files&#x27; --tag-name-filter cat -- --all</span><br></pre></td></tr></table></figure>

<p><strong>PS：上方命令中的 <code>path/to/large/files</code> 是大文件所在的路径，千万不要弄错！</strong></p>
<p>3、再次进行push操作</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">git push origin master</span><br></pre></td></tr></table></figure>

<p>详见：<a href="https://gitee.com/help/articles/4232#article-header0">仓库体积过大，如何减小？ - Gitee.com</a></p>
]]></content>
      <categories>
        <category>Tools</category>
      </categories>
      <tags>
        <tag>Git</tag>
      </tags>
  </entry>
</search>
